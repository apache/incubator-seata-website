<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="api" />
	<meta name="description" content="api" />
	<!-- 网页标签标题 -->
	<title>api</title>
  <link rel="shortcut icon" href="https://img.alicdn.com/tfs/TB1O1p6JzTpK1RjSZKPXXa3UpXa-64-64.png"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/en-us/index.html"><img class="logo" src="https://img.alicdn.com/tfs/TB1t3pWJCzqK1RjSZFjXXblCFXa-246-64.png"/></a><span class="language-switch language-switch-normal">中</span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/en-us/index.html" target="_self">HOME</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/en-us/docs/overview/what_is_seata.html" target="_self">DOCS</a></li><li class="menu-item menu-item-normal"><a href="/en-us/blog/index.html" target="_self">BLOG</a></li><li class="menu-item menu-item-normal"><a href="/en-us/community/index.html" target="_self">COMMUNITY</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="https://img.alicdn.com/tfs/TB1cm8nJwDqK1RjSZSyXXaxEVXa-160-160.png" class="front-img"/><span>Documentation</span><img src="https://img.alicdn.com/tfs/TB1cm8nJwDqK1RjSZSyXXaxEVXa-160-160.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>Seata</span><ul><li style="height:108px;overflow:hidden" class="menu-item menu-item-level-2"><span>Overview<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/overview/what_is_seata.html" target="_self">What is Seata?</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/overview/terminology.html" target="_self">Terminology</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/quickstart.html" target="_self">Quick Start</a></li><li style="height:180px;overflow:hidden" class="menu-item menu-item-level-2"><span>User Guide<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/userguide/install_server.html" target="_self">Installing Server</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/userguide/install_client.html" target="_self">Installing Client</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/userguide/download_files.html" target="_self">Downloading Files</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/userguide/supernode_configuration.html" target="_self">Supernode Configuration</a></li></ul></li><li style="height:108px;overflow:hidden" class="menu-item menu-item-level-2"><span>CLI Reference<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/cli_ref/dfdaemon.html" target="_self">dfdaemon</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/cli_ref/dfget.html" target="_self">dfget</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/api.html" target="_self">API Reference</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/faq.html" target="_self">FAQ</a></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>APIs Provided by SuperNode</h1>
<p>This topic explains how to use the APIs provided by the <a href="overview/terminology.md">SuperNode</a> (the cluster manager).</p>
<h2>Registration</h2>
<pre><code>POST /peer/registry
</code></pre>
<h3>Parameters</h3>
<p>Parameters are encodeds as <code>application/x-www-form-urlencoded</code>.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>cid</td>
<td>String</td>
<td>The client ID.</td>
</tr>
<tr>
<td>ip</td>
<td>String (IPv4)</td>
<td>The client IP address.</td>
</tr>
<tr>
<td>hostName</td>
<td>String</td>
<td>The hostname of the client.</td>
</tr>
<tr>
<td>superNodeIp</td>
<td>String (IPv4)</td>
<td>The IP address of the registered SuperNode.</td>
</tr>
<tr>
<td>port</td>
<td>Integer</td>
<td>The port which the client opens for P2P downloading.</td>
</tr>
<tr>
<td>callSystem</td>
<td>String</td>
<td>The caller identifier.</td>
</tr>
<tr>
<td>version</td>
<td>String</td>
<td>The client version.</td>
</tr>
<tr>
<td>dfdaemon</td>
<td>Boolean</td>
<td>Tells whether it is a call from dfdaemon.</td>
</tr>
<tr>
<td>path</td>
<td>String</td>
<td>The service path which the client offers.</td>
</tr>
<tr>
<td>rawUrl</td>
<td>String</td>
<td>The resource URL provided by command line parameter.</td>
</tr>
<tr>
<td>taskUrl</td>
<td>String</td>
<td>The resource URL.</td>
</tr>
<tr>
<td>md5</td>
<td>String</td>
<td>The MD5 checksum for the resource. Optional.</td>
</tr>
<tr>
<td>identifier</td>
<td>String</td>
<td>The resource identifer.</td>
</tr>
<tr>
<td>headers</td>
<td>Map</td>
<td>Extra HTTP headers to be sent to the raw URL.</td>
</tr>
</tbody>
</table>
<p>Upon receiving a request of registration from the client, the SuperNode constructs a new instance of based on the information provided by parameters. Specifically, it generates a task with <code>taskId</code> based on <code>rawUrl</code>, <code>md5</code>, and <code>identifier</code>.</p>
<p>Then the task is stored in the memory cache. Meanwhile, the SuperNode retrieves extra information such as the <code>content-length</code> which normally would be set. The <code>pieceSize</code> is calculated as per the following strategy:</p>
<ol>
<li>If the total size is less than 200MB, then the piece size is 4MB by default.</li>
<li>Otherwise, it equals to the smaller value between <code>(${totalSize} / 100MB) + 2</code> MB and 15MB.</li>
</ol>
<p>Next, the peer information along with the task will be recorded:</p>
<ol>
<li>The peer&lt;ip, cid, hostname&gt; will be saved.</li>
<li>The task&lt;taskId, cid, pieceSize, port, path&gt; will be saved.</li>
</ol>
<p>The last step is to trigger a progress.</p>
<h3>Response</h3>
<p>An example response:</p>
<pre><code class="language-json">{
  <span class="hljs-attr">"code"</span>: <span class="hljs-number">200</span>,
  <span class="hljs-attr">"data"</span>: {
    <span class="hljs-attr">"fileLength"</span>: <span class="hljs-number">687481</span>,
    <span class="hljs-attr">"pieceSize"</span>: <span class="hljs-number">4194304</span>,
    <span class="hljs-attr">"taskId"</span>: <span class="hljs-string">"ba270626349198840d0255de8358b6c93fe6d57d922d036fbf40bcf3499f44a8"</span>
  }
}
</code></pre>
<p>Other possible values of <code>code</code> in the response include:</p>
<ul>
<li><code>606</code>: The task ID already exists.</li>
<li><code>607</code>: The URL is invalid.</li>
<li><code>608</code> or <code>609</code>: Authentication required.</li>
</ul>
<h2>Get Task</h2>
<pre><code>GET /peer/task
</code></pre>
<h3>Parameters</h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>superNode</td>
<td>String (IPv4)</td>
<td>The IP address of the super node.</td>
</tr>
<tr>
<td>dstCID</td>
<td>String</td>
<td>The destination client ID.</td>
</tr>
<tr>
<td>range</td>
<td>String</td>
<td>Byte range.</td>
</tr>
<tr>
<td>status</td>
<td>Integer</td>
<td></td>
</tr>
<tr>
<td>result</td>
<td>Integer</td>
<td></td>
</tr>
<tr>
<td>taskId</td>
<td>String</td>
<td>The task ID.</td>
</tr>
<tr>
<td>srcCID</td>
<td>String</td>
<td>The source client ID.</td>
</tr>
</tbody>
</table>
<p>First, the SuperNode will analyze the <code>status</code> and <code>result</code>.</p>
<ul>
<li><code>Running</code>: if <code>status == 701</code>.</li>
<li><code>Success</code>: if <code>status == 702</code> and <code>result == 501</code>.</li>
<li><code>Fail</code>: if <code>status == 702</code> and <code>result == 500</code>.</li>
<li><code>Wait</code>: if <code>status == 700</code>.</li>
</ul>
<p>In <code>Wait</code> status, the SuperNode will save the status to be <code>Running</code>.</p>
<p>In <code>Running</code> status, the SuperNode will extract the piece status:</p>
<ul>
<li><code>Success</code>: if <code>result == 501</code>.</li>
<li><code>Fail</code>: if <code>result == 500</code>.</li>
<li><code>SemiSuc</code>: if <code>result == 503</code>.</li>
</ul>
<p><strong>Tip:</strong> <code>result == 502</code> suggests invalid code.</p>
<p>Then the SuperNode updates the progress for this specific task, and checks the status of  the task and the peers. After this, the SuperNode tells the client which peer has enough details to download another piece. Otherwise, it fails.</p>
<h3>Response</h3>
<p>An example resonse:</p>
<pre><code class="language-json">{
  <span class="hljs-attr">"code"</span>: <span class="hljs-number">602</span>,
  <span class="hljs-attr">"msg"</span>: <span class="hljs-string">"client sucCount:0,cdn status:Running,cdn sucCount: 0"</span>
}
</code></pre>
<p>This example response means that the client has to wait, since no peer can serve this piece now. If there is a peer which can serve this request, the response will be something like:</p>
<pre><code class="language-json">{
  <span class="hljs-attr">"code"</span>: <span class="hljs-number">601</span>,
  <span class="hljs-attr">"data"</span>: [
    {
      <span class="hljs-attr">"cid"</span>: <span class="hljs-string">"cdnnode:10.148.177.242~ba270626349198840d0255de8358b6c93fe6d57d922d036fbf40bcf3499f44a8"</span>,
      <span class="hljs-attr">"downLink"</span>: <span class="hljs-string">"20480"</span>,
      <span class="hljs-attr">"path"</span>: <span class="hljs-string">"/qtdown/ba2/ba270626349198840d0255de8358b6c93fe6d57d922d036fbf40bcf3499f44a8"</span>,
      <span class="hljs-attr">"peerIp"</span>: <span class="hljs-string">"10.148.177.242"</span>,
      <span class="hljs-attr">"peerPort"</span>: <span class="hljs-number">8001</span>,
      <span class="hljs-attr">"pieceMd5"</span>: <span class="hljs-string">"d78ef0af9e95e880fa583b41cf5ad791:687486"</span>,
      <span class="hljs-attr">"pieceNum"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">"pieceSize"</span>: <span class="hljs-number">4194304</span>,
      <span class="hljs-attr">"range"</span>: <span class="hljs-string">"0-4194303"</span>
    }
  ]
}
</code></pre>
<h2>Peer Progress</h2>
<pre><code>GET /peer/piece/suc
</code></pre>
<h3>Parameters</h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dstCID</td>
<td>String</td>
<td>The destination client ID.</td>
</tr>
<tr>
<td>pieceRange</td>
<td>String</td>
<td>Byte range.</td>
</tr>
<tr>
<td>taskId</td>
<td>String</td>
<td>The task ID.</td>
</tr>
<tr>
<td>cID</td>
<td>String</td>
<td>The client ID.</td>
</tr>
</tbody>
</table>
<h3>Response</h3>
<p>An example response:</p>
<pre><code class="language-json">{
  <span class="hljs-attr">"code"</span>: <span class="hljs-number">200</span>,
  <span class="hljs-attr">"msg"</span>: <span class="hljs-string">"success"</span>
}
</code></pre>
</div></section><footer class="footer-container"><div class="footer-body"><img src="https://img.alicdn.com/tfs/TB1VohYJwHqK1RjSZFgXXa7JXXa-278-72.png"/><p class="docsite-power">website powered by docsite</p><div class="cols-container"><div class="col col-12"><h3>Vision</h3><p>Seata is dedicated to improving the efficiency of large-scale file distribution, building the go-to solution and standards of container image distribution, and providing you with file and image distribution service which is efficient, easy-to-use, and of high availability.</p></div><div class="col col-6"><dl><dt>Documentation</dt><dd><a href="/en-us/docs/overview/what_is_seata.html" target="_self">What is Seata?</a></dd><dd><a href="/en-us/docs/quickstart.html" target="_self">Quick Start</a></dd></dl></div><div class="col col-6"><dl><dt>Resources</dt><dd><a href="/en-us/blog/index.html" target="_self">Blog</a></dd><dd><a href="/en-us/community/index.html" target="_self">Community</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2019 Seata</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>
