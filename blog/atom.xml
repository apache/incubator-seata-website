<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://seata.apache.org/blog</id>
    <title>Apache Seata Blog</title>
    <updated>2024-09-16T03:55:58.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://seata.apache.org/blog"/>
    <subtitle>Apache Seata Blog</subtitle>
    <icon>https://seata.apache.org/img/seata_logo_small.jpeg</icon>
    <entry>
        <title type="html"><![CDATA[seata-rpc-multi-protocol01]]></title>
        <id>https://seata.apache.org/blog/seata-rpc-multi-protocol01</id>
        <link href="https://seata.apache.org/blog/seata-rpc-multi-protocol01"/>
        <updated>2024-09-16T03:55:58.000Z</updated>
        <summary type="html"><![CDATA[Placeholder. DO NOT DELETE.]]></summary>
        <content type="html"><![CDATA[<p>Placeholder. DO NOT DELETE.</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[seata-rpc-multi-protocol02]]></title>
        <id>https://seata.apache.org/blog/seata-rpc-multi-protocol02</id>
        <link href="https://seata.apache.org/blog/seata-rpc-multi-protocol02"/>
        <updated>2024-09-16T03:55:58.000Z</updated>
        <summary type="html"><![CDATA[Placeholder. DO NOT DELETE.]]></summary>
        <content type="html"><![CDATA[<p>Placeholder. DO NOT DELETE.</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[How to Write Test Cases in Seata]]></title>
        <id>https://seata.apache.org/blog/how-to-write-unit-tests</id>
        <link href="https://seata.apache.org/blog/how-to-write-unit-tests"/>
        <updated>2024-02-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article mainly introduces the testing frameworks already used in Seata and community suggestions on how developers can better write test cases.]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a href="https://seata.apache.org/blog/how-to-write-unit-tests#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background">​</a></h2>
<p>As the Seata project continues to grow and expand, our contributor community is also continuously growing. With the continuous enhancement of project functionality, the requirements for code quality are also increasing. In this process, we expect every contributor to provide standardized and comprehensive test cases along with their feature code submissions.</p>
<p>An excellent project relies on comprehensive unit tests as a fundamental guarantee. The Test-Driven Development (TDD) concept has been proposed for many years, emphasizing writing test cases before writing functional code. By writing unit tests, developers can gain a deeper understanding of the roles of related classes and methods in the code, grasp the core logic, and become familiar with the running scenarios of various situations. Meanwhile, unit tests also provide stable and secure protection for open-source projects, ensuring the quality and stability of the code when accepting contributor submissions. Unit testing is the first line of defense for quality assurance. Effective unit testing can detect over 90% of code bugs in advance and prevent code deterioration. During project refactoring and evolution, unit testing plays a crucial role, ensuring that the refactored code continues to function properly without introducing new bugs.</p>
<p>In the community's view, contributing reasonable test case code is equally important as contributing functional code. To help developers write high-quality test cases, this article provides some basic standards and recommendations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="recommended-frameworks">Recommended Frameworks<a href="https://seata.apache.org/blog/how-to-write-unit-tests#recommended-frameworks" class="hash-link" aria-label="Direct link to Recommended Frameworks" title="Direct link to Recommended Frameworks">​</a></h2>
<p>The community currently uses the following three frameworks to write test cases:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="junit5">junit5<a href="https://seata.apache.org/blog/how-to-write-unit-tests#junit5" class="hash-link" aria-label="Direct link to junit5" title="Direct link to junit5">​</a></h3>
<p>junit is the most commonly used unit testing framework in Java, used for writing and running repeatable test cases.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jupiter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5.8</span><span class="token number" style="color:#36acaa">.2</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jupiter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">dependency</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">groupId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">org</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">groupId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">artifactId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">bom</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">artifactId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jupiter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dependency</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mockito">mockito<a href="https://seata.apache.org/blog/how-to-write-unit-tests#mockito" class="hash-link" aria-label="Direct link to mockito" title="Direct link to mockito">​</a></h3>
<p><a href="https://javadoc.io/static/org.mockito/mockito-core/5.10.0/org/mockito/Mockito.html" target="_blank" rel="noopener noreferrer">mockito</a>It is a mock framework mainly used for mock testing. It can simulate any bean managed by Spring, mock method return values, simulate throwing exceptions, etc. This allows us to complete testing and verification in situations where some dependencies are missing.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">mockito</span><span class="token generics punctuation" style="color:#393A34">.</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">4.11</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mockito</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">dependency</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">groupId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">org</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">groupId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">artifactId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">core</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">artifactId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">mockito</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dependency</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">dependency</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">groupId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">org</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">groupId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">artifactId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">junit</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jupiter</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">artifactId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">mockito</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dependency</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">dependency</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">groupId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">org</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">groupId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">artifactId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">mockito</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">inline</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">artifactId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">mockito</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dependency</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="assertj">assertj<a href="https://seata.apache.org/blog/how-to-write-unit-tests#assertj" class="hash-link" aria-label="Direct link to assertj" title="Direct link to assertj">​</a></h3>
<p>assertj is an assertion library that provides a set of easy-to-use and highly readable assertion methods. When junit's assertions are difficult to meet, assertj can be used for assertions.</p>
<p>Please note: We manage the versions of these three libraries uniformly in the pom.xml of seata-dependencies.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">assertj</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">3.12</span><span class="token number" style="color:#36acaa">.2</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">assertj</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">dependency</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">groupId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">org</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assertj</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">groupId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">artifactId</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">assertj</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">core</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">artifactId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics">version</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">assertj</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">version</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dependency</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="specifications">Specifications<a href="https://seata.apache.org/blog/how-to-write-unit-tests#specifications" class="hash-link" aria-label="Direct link to Specifications" title="Direct link to Specifications">​</a></h2>
<p>We have referenced the Alibaba Java Development Manual and compiled some suggestions and specifications, divided into different levels. Among them, the [[mandatory]] parts must be strictly adhered to by developers. The community will review the code according to the mandatory rules when merging it. The [[recommended]] and [[reference]] parts are provided to help everyone better understand our considerations and principles for test cases.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1-mandatory-unit-tests-must-adhere-to-the-air-principle">1. [[mandatory]] Unit tests must adhere to the AIR principle.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#1-mandatory-unit-tests-must-adhere-to-the-air-principle" class="hash-link" aria-label="Direct link to 1. [[mandatory]] Unit tests must adhere to the AIR principle." title="Direct link to 1. [[mandatory]] Unit tests must adhere to the AIR principle.">​</a></h5>
<p>Explanation: Good unit tests, from a macro perspective, possess characteristics of automation, independence, and repeatability.</p>
<ul>
<li>A: Automatic</li>
<li>I: Independent</li>
<li>R: Repeatable</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="2-mandatory-unit-tests-should-be-fully-automated-and-non-interactive">2. [[mandatory]] Unit tests should be fully automated and non-interactive.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#2-mandatory-unit-tests-should-be-fully-automated-and-non-interactive" class="hash-link" aria-label="Direct link to 2. [[mandatory]] Unit tests should be fully automated and non-interactive." title="Direct link to 2. [[mandatory]] Unit tests should be fully automated and non-interactive.">​</a></h5>
<p>Test cases are usually executed periodically, and the execution process must be fully automated to be meaningful. Tests that require manual inspection of output results are not good unit tests. System.out should not be used for manual verification in unit tests; assert must be used for verification.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3-mandatory-maintain-the-independence-of-unit-tests-to-ensure-the-stability-reliability-and-ease-of-maintenance-of-unit-tests-unit-test-cases-must-not-call-each-other-or-depend-on-the-execution-order">3. [[mandatory]] Maintain the independence of unit tests. To ensure the stability, reliability, and ease of maintenance of unit tests, unit test cases must not call each other or depend on the execution order.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#3-mandatory-maintain-the-independence-of-unit-tests-to-ensure-the-stability-reliability-and-ease-of-maintenance-of-unit-tests-unit-test-cases-must-not-call-each-other-or-depend-on-the-execution-order" class="hash-link" aria-label="Direct link to 3. [[mandatory]] Maintain the independence of unit tests. To ensure the stability, reliability, and ease of maintenance of unit tests, unit test cases must not call each other or depend on the execution order." title="Direct link to 3. [[mandatory]] Maintain the independence of unit tests. To ensure the stability, reliability, and ease of maintenance of unit tests, unit test cases must not call each other or depend on the execution order.">​</a></h5>
<p>Counterexample: method2 depends on the execution of method1, with the result of method1 being used as input for method2.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="4-mandatory-unit-tests-must-be-repeatable-and-unaffected-by-external-environments">4. [[mandatory]] Unit tests must be repeatable and unaffected by external environments.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#4-mandatory-unit-tests-must-be-repeatable-and-unaffected-by-external-environments" class="hash-link" aria-label="Direct link to 4. [[mandatory]] Unit tests must be repeatable and unaffected by external environments." title="Direct link to 4. [[mandatory]] Unit tests must be repeatable and unaffected by external environments.">​</a></h5>
<p>Explanation: Unit tests are usually included in continuous integration, and unit tests are executed each time code is checked in. If unit tests depend on external environments (network, services, middleware, etc.), it can lead to the unavailability of the continuous integration mechanism.</p>
<p>Example: To avoid being affected by external environments, it is required to design the code to inject dependencies into the SUT. During testing, use a DI framework like Spring to inject a local (in-memory) implementation or a Mock implementation.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="5-mandatory-for-unit-tests-ensure-that-the-granularity-of-testing-is-small-enough-to-facilitate-precise-issue-localization-the-granularity-of-unit-testing-is-at-most-at-the-class-level-generally-at-the-method-level">5. [[mandatory]] For unit tests, ensure that the granularity of testing is small enough to facilitate precise issue localization. The granularity of unit testing is at most at the class level, generally at the method level.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#5-mandatory-for-unit-tests-ensure-that-the-granularity-of-testing-is-small-enough-to-facilitate-precise-issue-localization-the-granularity-of-unit-testing-is-at-most-at-the-class-level-generally-at-the-method-level" class="hash-link" aria-label="Direct link to 5. [[mandatory]] For unit tests, ensure that the granularity of testing is small enough to facilitate precise issue localization. The granularity of unit testing is at most at the class level, generally at the method level." title="Direct link to 5. [[mandatory]] For unit tests, ensure that the granularity of testing is small enough to facilitate precise issue localization. The granularity of unit testing is at most at the class level, generally at the method level.">​</a></h5>
<p>Explanation: Only with small granularity can errors be quickly located when they occur. Unit tests are not responsible for checking cross-class or cross-system interaction logic; that is the domain of integration testing.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="6-mandatory-incremental-code-for-core-business-core-applications-and-core-modules-must-ensure-that-unit-tests-pass">6. [[mandatory]] Incremental code for core business, core applications, and core modules must ensure that unit tests pass.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#6-mandatory-incremental-code-for-core-business-core-applications-and-core-modules-must-ensure-that-unit-tests-pass" class="hash-link" aria-label="Direct link to 6. [[mandatory]] Incremental code for core business, core applications, and core modules must ensure that unit tests pass." title="Direct link to 6. [[mandatory]] Incremental code for core business, core applications, and core modules must ensure that unit tests pass.">​</a></h5>
<p>Explanation: Add unit tests promptly for new code. If new code affects existing unit tests, promptly make corrections.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="7-mandatory-unit-test-code-must-be-written-in-the-following-project-directory-srctestjava-it-is-not-allowed-to-be-written-in-the-business-code-directory">7. [[mandatory]] Unit test code must be written in the following project directory: src/test/java; it is not allowed to be written in the business code directory.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#7-mandatory-unit-test-code-must-be-written-in-the-following-project-directory-srctestjava-it-is-not-allowed-to-be-written-in-the-business-code-directory" class="hash-link" aria-label="Direct link to 7. [[mandatory]] Unit test code must be written in the following project directory: src/test/java; it is not allowed to be written in the business code directory." title="Direct link to 7. [[mandatory]] Unit test code must be written in the following project directory: src/test/java; it is not allowed to be written in the business code directory.">​</a></h5>
<p>Explanation: This directory is skipped during source code compilation, and the unit test framework defaults to scanning this directory.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="8-mandatory-the-basic-goal-of-unit-testing-achieve-a-statement-coverage-of-70-the-statement-coverage-and-branch-coverage-of-core-modules-must-reach-100">8. [[mandatory]] The basic goal of unit testing: achieve a statement coverage of 70%; the statement coverage and branch coverage of core modules must reach 100%.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#8-mandatory-the-basic-goal-of-unit-testing-achieve-a-statement-coverage-of-70-the-statement-coverage-and-branch-coverage-of-core-modules-must-reach-100" class="hash-link" aria-label="Direct link to 8. [[mandatory]] The basic goal of unit testing: achieve a statement coverage of 70%; the statement coverage and branch coverage of core modules must reach 100%." title="Direct link to 8. [[mandatory]] The basic goal of unit testing: achieve a statement coverage of 70%; the statement coverage and branch coverage of core modules must reach 100%.">​</a></h5>
<p>Explanation: As mentioned in the application layering of project conventions, DAO layer, Manager layer, and highly reusable Service should all undergo unit testing.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="9-recommended-when-writing-unit-test-code-adhere-to-the-bcde-principle-to-ensure-the-delivery-quality-of-the-tested-modules">9. [[recommended]] When writing unit test code, adhere to the BCDE principle to ensure the delivery quality of the tested modules.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#9-recommended-when-writing-unit-test-code-adhere-to-the-bcde-principle-to-ensure-the-delivery-quality-of-the-tested-modules" class="hash-link" aria-label="Direct link to 9. [[recommended]] When writing unit test code, adhere to the BCDE principle to ensure the delivery quality of the tested modules." title="Direct link to 9. [[recommended]] When writing unit test code, adhere to the BCDE principle to ensure the delivery quality of the tested modules.">​</a></h5>
<ul>
<li>B: Border, boundary value testing, including loop boundaries, special values, special time points, data sequences, etc.</li>
<li>C: Correct, correct input, and expected results.</li>
<li>D: Design, combined with design documents, to write unit tests.</li>
<li>E: Error, forced error message input (such as: illegal data, exceptional processes, business allowance outside, etc.), and expected results.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="10-recommended-for-database-related-operations-such-as-queries-updates-and-deletions-do-not-assume-that-the-data-in-the-database-exists-or-directly-manipulate-the-database-to-insert-data-please-use-program-insertion-or-data-import-to-prepare-data">10. [[recommended]] For database-related operations such as queries, updates, and deletions, do not assume that the data in the database exists, or directly manipulate the database to insert data. Please use program insertion or data import to prepare data.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#10-recommended-for-database-related-operations-such-as-queries-updates-and-deletions-do-not-assume-that-the-data-in-the-database-exists-or-directly-manipulate-the-database-to-insert-data-please-use-program-insertion-or-data-import-to-prepare-data" class="hash-link" aria-label="Direct link to 10. [[recommended]] For database-related operations such as queries, updates, and deletions, do not assume that the data in the database exists, or directly manipulate the database to insert data. Please use program insertion or data import to prepare data." title="Direct link to 10. [[recommended]] For database-related operations such as queries, updates, and deletions, do not assume that the data in the database exists, or directly manipulate the database to insert data. Please use program insertion or data import to prepare data.">​</a></h5>
<p>Counterexample: In a unit test for deleting a row of data, manually add a row directly into the database as the deletion target. However, this newly added row of data does not comply with the business insertion rules, resulting in abnormal test results.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="11-recommended-for-database-related-unit-tests-an-automatic-rollback-mechanism-can-be-set-to-prevent-dirty-data-from-being-left-in-the-database-due-to-unit-testing-alternatively-clear-prefix-and-suffix-identifiers-can-be-used-for-data-generated-by-unit-testing">11. [[recommended]] For database-related unit tests, an automatic rollback mechanism can be set to prevent dirty data from being left in the database due to unit testing. Alternatively, clear prefix and suffix identifiers can be used for data generated by unit testing.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#11-recommended-for-database-related-unit-tests-an-automatic-rollback-mechanism-can-be-set-to-prevent-dirty-data-from-being-left-in-the-database-due-to-unit-testing-alternatively-clear-prefix-and-suffix-identifiers-can-be-used-for-data-generated-by-unit-testing" class="hash-link" aria-label="Direct link to 11. [[recommended]] For database-related unit tests, an automatic rollback mechanism can be set to prevent dirty data from being left in the database due to unit testing. Alternatively, clear prefix and suffix identifiers can be used for data generated by unit testing." title="Direct link to 11. [[recommended]] For database-related unit tests, an automatic rollback mechanism can be set to prevent dirty data from being left in the database due to unit testing. Alternatively, clear prefix and suffix identifiers can be used for data generated by unit testing.">​</a></h5>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="12-recommended-for-code-that-is-untestable-necessary-refactoring-should-be-done-at-the-appropriate-time-to-make-the-code-testable-avoiding-writing-non-standard-test-code-just-to-meet-testing-requirements">12. [[recommended]] For code that is untestable, necessary refactoring should be done at the appropriate time to make the code testable, avoiding writing non-standard test code just to meet testing requirements.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#12-recommended-for-code-that-is-untestable-necessary-refactoring-should-be-done-at-the-appropriate-time-to-make-the-code-testable-avoiding-writing-non-standard-test-code-just-to-meet-testing-requirements" class="hash-link" aria-label="Direct link to 12. [[recommended]] For code that is untestable, necessary refactoring should be done at the appropriate time to make the code testable, avoiding writing non-standard test code just to meet testing requirements." title="Direct link to 12. [[recommended]] For code that is untestable, necessary refactoring should be done at the appropriate time to make the code testable, avoiding writing non-standard test code just to meet testing requirements.">​</a></h5>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="13-recommended-unit-tests-as-a-means-of-quality-assurance-should-complete-the-writing-and-verification-of-unit-tests-before-submitting-a-pull-request">13. [[recommended]] Unit tests, as a means of quality assurance, should complete the writing and verification of unit tests before submitting a pull request.<a href="https://seata.apache.org/blog/how-to-write-unit-tests#13-recommended-unit-tests-as-a-means-of-quality-assurance-should-complete-the-writing-and-verification-of-unit-tests-before-submitting-a-pull-request" class="hash-link" aria-label="Direct link to 13. [[recommended]] Unit tests, as a means of quality assurance, should complete the writing and verification of unit tests before submitting a pull request." title="Direct link to 13. [[recommended]] Unit tests, as a means of quality assurance, should complete the writing and verification of unit tests before submitting a pull request.">​</a></h5>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="14-reference-to-facilitate-unit-testing-business-code-should-avoid-the-following-situations">14. [[reference]] To facilitate unit testing, business code should avoid the following situations:<a href="https://seata.apache.org/blog/how-to-write-unit-tests#14-reference-to-facilitate-unit-testing-business-code-should-avoid-the-following-situations" class="hash-link" aria-label="Direct link to 14. [[reference]] To facilitate unit testing, business code should avoid the following situations:" title="Direct link to 14. [[reference]] To facilitate unit testing, business code should avoid the following situations:">​</a></h5>
<ul>
<li>Doing too much in constructors.</li>
<li>Having too many global variables and static methods.</li>
<li>Having too many external dependencies.</li>
<li>Having too many conditional statements.
Explanation: For multiple conditional statements, it is recommended to refactor using guard clauses, strategy patterns, state patterns, etc.</li>
</ul>]]></content>
        <author>
            <name>Wang Zhongxiang - trustdecision Technical Expert</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Exploring the Journey of Open Source Development in Seata Project]]></title>
        <id>https://seata.apache.org/blog/explore-seata-journey</id>
        <link href="https://seata.apache.org/blog/explore-seata-journey"/>
        <updated>2023-11-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this article, I will share my journey as a developer in the Seata community, along with the experiences and insights I have gained during this adventure.]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p>Seata is an open-source distributed transaction solution dedicated to providing high-performance and user-friendly distributed transaction services in a microservices architecture. During this year's Summer of Code event, I joined the Apache Seata (Incubator) community, completed the Summer of Code project, and have been actively involved in the community ever since. I was fortunate to share my developer experience at the YunQi Developer Show during the Cloud Conferen</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="relevant-background">Relevant Background<a href="https://seata.apache.org/blog/explore-seata-journey#relevant-background" class="hash-link" aria-label="Direct link to Relevant Background" title="Direct link to Relevant Background">​</a></h2>
<p>Before formally introducing my experiences, I would like to provide some relevant background information to explain why I chose to participate in open source and how I got involved. There are various motivations for participating in open source, and here are some of the main reasons I believe exist:</p>
<ul>
<li><strong>Learning</strong>: Participating in open source provides us with the opportunity to contribute to open-source projects developed by different organizations, interact with industry experts, and offers learning opportunities.</li>
<li><strong>Skill Enhancement</strong>: In my case, I usually work with Java and Python for backend development. However, when participating in the Seata project, I had the chance to learn the Go language, expanding my backend technology stack. Additionally, as a student, it's challenging to encounter production-level frameworks or applications, and the open-source community provided me with this opportunity.</li>
<li><strong>Interest</strong>: Many of my friends are passionate about open source, enjoying programming and being enthusiastic about open source.</li>
<li><strong>Job Seeking</strong>: Participating in open source can enrich our portfolio, adding weight to resumes.</li>
<li><strong>Work Requirements</strong>: Sometimes, involvement in open source is to address work-related challenges or meet job requirements.</li>
</ul>
<p>These are some reasons for participating in open source. For me, learning, skill enhancement, and interest are the primary motivations. Whether you are a student or a working professional, if you have the willingness to participate in open source, don't hesitate. Anyone can contribute to open-source projects. Age, gender, occupation, and location are not important; the key is your passion and curiosity about open-source projects.</p>
<p><strong>The opportunity for me to participate in open source arose when I joined the Open Source Promotion Plan (OSPP) organized by the Institute of Software, Chinese Academy of Sciences.</strong></p>
<p>OSPP is an open-source activity for university developers. The community releases open-source projects, and student developers complete project development under the guidance of mentors. The completed results are contributed to the community, merged into the community repository, and participants receive project bonuses and certificates. OSPP is an excellent opportunity to enter the open-source community, and it was my first formal encounter with open-source projects. This experience opened a new door for me. I deeply realized that participating in the construction of open-source projects, sharing your technical achievements, and enabling more developers to use what you contribute is a joyful and meaningful endeavor.</p>
<p>The image below, officially released by OSPP, shows that the number of participating communities and students has been increasing year by year since 2020, and the event is getting better. This year, a total of 133 community projects were involved, each providing several topics, with each student selecting only one topic. Choosing a community to participate in and finding a suitable topic in such a large number of communities is a relatively complex task.</p>
<p><img decoding="async" loading="lazy" alt="img" src="https://seata.apache.org/assets/images/explore-seata-ospp-ea3140f489f2794691a5ec30584dc17d.png" width="1736" height="455" class="img_ev3q"></p>
<p><strong>Considering factors such as community activity, technical stack compatibility, and guidance for newcomers, I ultimately chose to join the Seata community.</strong></p>
<p>Seata is an open-source distributed transaction framework that provides a complete distributed transaction solution, including AT, TCC, Saga, and XA transaction modes, and supports multiple programming languages and data storage solutions. Since its open source in 2019, Seata has been around for <strong>5</strong> years, with over <strong>300</strong> contributors in the community. The project has received <strong>24k+</strong> stars and is a mature community. Seata is compatible with <strong>10+</strong> mainstream RPC frameworks and RDBMS, has integration relationships with <strong>20+</strong> communities, and is applied to business systems by <strong>thousands</strong> of customers. It can be considered the de facto standard for distributed transaction solutions.</p>
<p><img decoding="async" loading="lazy" alt="img" src="https://seata.apache.org/assets/images/explore-seata-apache-0ab436a0c1d070e4d1dbff2df66ea775.png" width="750" height="146" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seatas-journey-to-apache-incubator">Seata's Journey to Apache Incubator<a href="https://seata.apache.org/blog/explore-seata-journey#seatas-journey-to-apache-incubator" class="hash-link" aria-label="Direct link to Seata's Journey to Apache Incubator" title="Direct link to Seata's Journey to Apache Incubator">​</a></h3>
<p>On October 29, 2023, Seata was formally donated to the Apache Software Foundation and became an incubating project. After incubation, Seata is expected to become the first top-level distributed transaction framework project under the Apache Software Foundation. This donation will propel Seata to a broader development scope, profoundly impacting ecosystem construction, and benefiting more developers. This significant milestone also opens up broader development opportunities for Seata.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="development-journey">Development Journey<a href="https://seata.apache.org/blog/explore-seata-journey#development-journey" class="hash-link" aria-label="Direct link to Development Journey" title="Direct link to Development Journey">​</a></h2>
<p><strong>Having introduced some basic information, the following sections will delve into my development journey in the Seata community.</strong></p>
<p>Before officially starting development, I undertook several preparatory steps. Given Seata's five years of development and the accumulation of hundreds of thousands of lines of code, direct involvement requires a certain learning curve. I share some preparatory experiences in the hope of providing inspiration.</p>
<ol>
<li>
<p><strong>Documentation and Blogs as Primary Resources</strong></p>
<ul>
<li>Text materials such as documentation and blogs help newcomers quickly understand project background and code structure.</li>
<li>Official documentation is the primary reference material, providing insights into everything the official documentation deems necessary to know.
<img decoding="async" loading="lazy" alt="img" src="https://seata.apache.org/assets/images/explore-seata-docs-481f1fed9d84cd5bf6459048ab08e169.png" width="722" height="146" class="img_ev3q"></li>
<li>Blogs, secondary to official documentation, are often written by developers or advanced users. Blogs may delve deeper into specific topics, such as theoretical models of projects, project structure, and source code analysis of specific modules.
<img decoding="async" loading="lazy" alt="img" src="https://seata.apache.org/assets/images/explore-seata-blogs-3a309daa3407d8705311955654df0b21.png" width="722" height="155" class="img_ev3q"></li>
<li>Public accounts (such as WeChat) are similar to blogs, generally containing technical articles. An advantage of public accounts is the ability to subscribe for push notifications, allowing for technical reading during spare time.
<img decoding="async" loading="lazy" alt="img" src="https://seata.apache.org/assets/images/explore-seata-pubs-b79d08833dc9443c20d5badd02f46ad1.png" width="722" height="131" class="img_ev3q"></li>
<li>Additionally, slides from online or offline community presentations and meetups provide meaningful textual materials.
<img decoding="async" loading="lazy" alt="img" src="https://seata.apache.org/assets/images/explore-seata-slides-9d9ec97761879e8d3a74be56c6908a4a.png" width="722" height="115" class="img_ev3q"></li>
<li>Apart from official materials, many third-party resources are available for learning, such as understanding specific implementations and practices through user-shared use cases, exploring the project's ecosystem through integration documentation from third-party communities, and learning through video tutorials. However, among all these materials, I consider official documentation and blogs to be the most helpful.</li>
</ul>
</li>
<li>
<p><strong>Familiarizing Yourself with the Framework</strong></p>
<ul>
<li>Not all text materials need to be thoroughly read. Understanding is superficial if confined to paper. Practice should commence when you feel you understand enough. The "Get Started" section in the official documentation is a step-by-step guide to understanding the project's basic workflow.</li>
<li>Another approach is to find examples or demonstrations provided by the official project, build and run them, understand the meanings of code and configurations, and learn about the project's requirements, goals, existing features, and architecture through usage.</li>
<li>For instance, Seata has a repository named "seata-samples" containing over 20 use cases, covering scenarios like Seata integration with Dubbo, integration with SCA, and Nacos integration. These examples cover almost all supported scenarios.</li>
</ul>
</li>
<li>
<p><strong>Roughly Reading Source Code to Grasp Main Logic</strong></p>
<ul>
<li>In the preparation phase, roughly reading the source code to grasp the project's main logic is crucial. Efficiently understanding a project's core content is a skill that requires long-term accumulation.</li>
<li>First, through the previously mentioned preparation steps, understanding the project's concepts, interactions, and process models is helpful.</li>
<li>Taking Seata as an example, through official documentation and practical operations, you can understand the three roles in Seata's transaction domain: TC (Transaction Coordinator), TM (Transaction Manager), and RM (Resource Manager). TC, deployed independently as a server, maintains the state of global and branch transactions, crucial for Seata's high availability. TM interacts with TC, defining the start, commit, or rollback of global transactions. RM manages resources for branch transaction processing, interacts with TC to register branch transactions and report branch transaction states, and drives branch transaction commit or rollback. After roughly understanding the interaction between these roles, grasping the project's main logic becomes easier.
<img decoding="async" loading="lazy" alt="img" src="https://seata.apache.org/assets/images/solution-1bdadb80e54074aa3088372c17f0244b.png" width="868" height="473" class="img_ev3q"></li>
<li>Having a mental impression of these models makes it easier to extract the main logic from the source code. For example, analyzing the Seata TC transaction coordinator, as a server-side application deployed independently of the business, involves starting the server locally and tracking it through the startup class. This analysis can reveal some initialization logic, such as service registration and initialization of global locks. Tracking the code through RPC calls can reveal how TC persists global and branch transactions and how it drives global transaction commit or rollback.</li>
<li>However, for embedded client framework code without a startup class entry point for analysis, starting with a sample can be effective. Finding references to framework code in a sample allows for code reading. For instance, a crucial annotation in Seata is <code>GlobalTransaction</code>, used to identify a global transaction. To understand how TM analyzes this annotation, one can use the IDE's search function to find the interceptor for <code>GlobalTransaction</code> and analyze its logic.</li>
<li>Here's a tip: Unit tests often focus on the functional aspects of a single module. Reading unit tests can reveal a module's input-output, logic boundaries, and understanding the code through the unit test's call chain is an essential means of understanding the source code.</li>
</ul>
</li>
</ol>
<p><strong>With everything prepared, the next step is to actively participate in the community.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ways-to-contribute-and-personal-insights">Ways to Contribute and Personal Insights<a href="https://seata.apache.org/blog/explore-seata-journey#ways-to-contribute-and-personal-insights" class="hash-link" aria-label="Direct link to Ways to Contribute and Personal Insights" title="Direct link to Ways to Contribute and Personal Insights">​</a></h2>
<p>There are various ways to participate, with one of the most common being to check the project's Issues list. Communities often mark issues suitable for new contributors with special labels such as "good-first-issue," "contributions-welcome," and "help-wanted." Interested tasks can be filtered through these labels.</p>
<p><img decoding="async" loading="lazy" alt="img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu4AAABQCAMAAABxnADUAAACuFBMVEXMztD+/v/y9PX5+vuoq62nqq3////Iy83MztDFyMv29/j988Xw763//vz+//////3o6On9/f7+/PP9+/j///79/Pv7/P7u7/Hu7e399Mr99tX9/v/t6+n5+/3x8vL18/H8+ub+9Mfz8O329cvb4+33+PrJys3y8bLl5ebM09xlXGPAwsjy8a65vML39fPp6+7q5+Tv8vZ4dHX59O359/X6+fjS1trv597h6O7Bv8D19veZh33HxcXFztlycHPOyml5eoD2+v6OfXTh3dm0uL69ydfFyMvj6/O8w8zU09Pu9fvp49xfZXbd2dTO0dVeX2rBxs728OZ0dXvU3umgkYbx7OTMzc+Dc2vFy9Lc4eb8+fPz+PzOysbz6r7i4eBlZW3m28+0vcrZ3N/Rzs27rqDVybzDtanq6amPk5txfZDN2OXi18p/eXWLmKzp8PiDf3vQwrKwpZjJuqvY0MmapLRjYVrq4dba1M9rcHprdol/gop+bGWvoI6CrYXT2eG5p5rF0uJxYmBsbHGDkKe1wtO8ubmcq8FfWVNkbYCvsrjl46bz9vno7vRyeYWqrbKomond0MCjrLv9+e5WWWd+i6CMg36Hh2mXprtsaGepssCEipTw5bqSnrJ1amjRz3fe3Z99fWROUF347sKquMja1ZTIx6d2gZdYTEru7Kqnm5OUuZeRiYasu8/p6L2pnHRERk2Xj4nGxpd6a1iKgFqkssd/eFn68cOzqHjg06ekqbGYnaWvtoyVh2Pr8+zOxLr599yYlZX27r6glGnRwo03ODulpqZvcVeRkXS3uqGdnobg6+Hn4bihwqSanHeUtOmzr67N3s7Gv4Xv79PS1Z+iqYLCt47Asn1uYUysya7V04WwlYx/cnnV5NbE2cZsluG7r4u40bqsxe5Rg9vH2PR+o+Vdi95vmm////+WVYwoAAAA6HRSTlPE////lpb/xMXE///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////E/33mMAAAIABJREFUeNrsm/lTU1kWxyWZeWVBJSQkISwhLAVWEkuBsGhBEQI0g0toBAMoTkhggAFZwhIQCBhZFBRlEwgYBAxEShEUFAgMssgoxNjVFjO0S7dF/zR/x5z7AJcedKRVnMH3TeUldznvJNTnnnfueWHHH3buIETom9DOP+7YSbcgROibEB1CuwVGiNA3IYsdBO6ECNwJESJwJ0SIwP3/SdaU3y9rgphthTude5+0rfGnuMw4fIJcbAhmtg/uj5+Ul5c/f8zctt/XxsHe6pPk0ExE+C1VwtLg4FLzZomk4/ovuP9SfvPp41c3yx9vX9pXoR2Dh5WVXjaGv9PL1nrX2r99WK2/k+mtrOybCQS38GK81NcVHNzVN8jYjBVp13e4dll+CHdu+XM/eAl4cpP0hT78n/lUt8jjTmjRnnV/e4T67sTosxGv38f+eMDp010zM/eEYNYziGrdGt2uxjv4O9c+kx5/vfDA7LpRRF83mBsywLgDg6Bwy5KPpRfBuLrMrE2YxU3uQfouPRnDfA/udnfcCHeLp+X3MfJ9FkYrf/qFgmtodqxUJO+1xTCf2TNv+n3O7n93okL+epTSIDlg+xlw19QewmxQJjO3sKiX6cYA4vmsQRlEeNf5NrPMakwnM442zqERFObn9Hr9nE4/JtPJ5oby9Hqd3mrOfHcRLQcivG+VmNEvuvogvMPhxdIm7HafxxcHuf57DHPbdbbp0IbR/flNFvbqX08x8s1fUZPBIVPsSJhzIptK4fDIuH83Hgnz49GcMGe2m6etGw1mcDlsFseTjsGcOrAh0bzRNG+I1zCH5wHriwej2F6epyPg7vYXXlltDoaxeN577ZxhGMwCUmt6PZh20GBx4PyYM61xFXc3cL1P3XJx1bM3xvBa9UyzBct3PJOQZy9v3AR9H4YnyYtNReeD6xnDi0fGcW9GuBv75YahnsX5NtNy1orJWDboOv+oTWleblsYHjVMLfQYIJz/YHywuLy4ctdkDF1QDvcXGsbbTMaptmc47i4Eh1uVypiDuwZnBvvg2dXN+H24W2CRE+/DnY79CrizVnFXCI82t3YolDEqUlqWSAU2rHxhcYeXVFTZSdIUD8gn7wi0bqGlyuKHSnl4QpqwsvRo0dV04aX9BcqYJifMWlM8216VUzQgEjWFoGPH3tBsKnSXwKmif67OrYRhdppQvCfw7xL+tFKU7V3QKroSUaQsVl4G3K1TsypjjqTcvnbPEWPlCkUdHPA86Y17nhV0uoVeAs+t8nDGG8/umcqYiRBYHNDKKg5KSBFVXnGPvoGbreOuG31obBipHGpfnK95ZNCb9YC7YeSfz3oemUaHny2OK5d/MEyZRhYWDCtTNSsVhpHFu6blmrarD5TGERz3GYLDrdqm9kEa093dfaEbIvzMZnCnv8adebieT90Q91drycz98l9QM7PwpI9apbl8hJYpaMqXB8ECaG/i0cpqT6cKql9e5kuvHSuTJKuvn6oo8Y9vaRQkhYW2ZPafKxD0lkmCaI6QhlzmpwqSpBnH86OCAq8fT4viB2ZTGfnt1eA+VnAr/1p4/uVj8ddPsxtrqouuqqYF1WFnpbeRQQrCPTa+k9dQmxyfXQeeK1Q8mqaYXyC4hXs+ogHPGZHqWn/wKehNRJ61pwRNZZJjtNgfJ/iKfhX0TcsPhMVnp0j4Be333iQzPQ/HhVPtxqH2hppCw5gOJTO6u6ZnZcPzo8MjhvFWo8H8U6FpNGt5ZKjwb1nmqcUp00rhomFoHXcium+VmvHMvQvtVoODN5HN7K6HPSjLKWACcN/3MNybviHu98ufWL61VQXcm9WqwwMxTfm3i4UI99yoCMi/q6iwCl5mhKRIDuVG+cefgx56Q0aKJAcrKykQwBI5p2iN6XAC3EtCfOJVai0WW9GkPoftqzgQmM1IEyVBKs5EuEtyFIXhqVniIEXhmcz+YrE86caV2f6OUO1q7q4QnMEa5cmhWirGTI1yxxiBVY428Z0vS06kSXIa5Xx1JyWwhV6WkS+JwDS1BYIzzfHaooGYjsN56eGZYKu5lAeIN1yXttgyQrMR7hRUmBkbzxrvaVMut7Uu31lZQMlMn0k2BPmN6R8Php+19RhcXV2NPYYHs8a7C1nDd8xDhp96DFNtecZRSHQAd3ui9L5Foia8wHepS39F1ZlN4H4wvT6Zd76+Hm1VIycnvsv5QCHy6XohsqjiXEGNipOYF3VWoDr4vTcCsInHK5OcnhaEr+POVyPcWdKMVEEvRNJMHHdOohQQRNE9VxAeWJKM4jqEbPnp0OxGgSqZ57Qa3XHcvSLjWzJrehUVnQfjwiq00zW90oxkzTUU3dXZiQ0lngh38Kzl8TQSfmp7NY57RGMUjnsV4F4g6EgMrQLAm9VaTliZBBV1FP3asPgquLZExqtSJEEF7bcQ7piLvdUYbDnndDqZzAzbVL1uTocKkWMyvd6s08uMaoMOLzzqxmQyKx2ahg/pYTZqogqOC1F437Lc/QLCfclPBrj3JXy8naX/5MPJ83FxybDhJHO5pI2jO2aB32Z6QlttMTSV6aKOaaV4gp0iFKN8H7JkcdJhqVDcZKmpCsnPONQoTh64ZSPVsvLSuWnCmHT3IvFRn8DeXKW4KQThPiBSnSgaEIp7nRRwTPKVanOvySuvXES5e3huaU6R8FieuDQ8OrCYD6ee9MwTzYrCFVni2ZiT8GVTlcJSfoL0HhX3HJMUKxXGNNVpWkJyM3IyxacD71FudNJT0kmrnn8+2RzYgTyfgIuHoqY0q/RoggZGIqJvCNH24/ohdE/VfrXs/h7pVgZdP3ybyX6GQmC4VXJcQmnMYMIgQD+4mZv9zD9d2eOxUWFzgx8RvL6DxeKQuAF+HE9bjGJHq1utzNA8MAaH7Yjt5VJ92Y5+bDLXkulMQk2YQ8ZYbCcK19KXBjMA9wxPO0hcoEVFRy6V6RzgS6PR4IQYhe3hy6az2B7ONC4MepLh1CQqAzx6YM6elmy81O4MXpncdc+W4NkOebYASwZ4rlvzDGPg2Y5McQvw5djhS1khCLcDO4qdpxMqMUHnXvSRMOtmB/tPkYMLQfsWimUG3l90Q07TnbApQ0saGfsI3D+nrBsyQr7WVRDl/e/5VDb/oea154d61kRhEgxuZfbuO7i6W73g81nO90VxP3XE9mv9nd6+LbvBte4doY63xyx+00Poa8b3GXNfn3npM93J3q4/ACZ+w79d0ncqk8H4bMUB4t87CH1DInAnROBOiBCB+4dEpn+cQ/K6OyaZWGeE/odw96V5Onnt8q9ziztuS+Fc9IuM2/Xeegfl4LtDDP+ct/fXYXH7MQrNG8P+zd61/zSV5fFtm1yTxgut7W2b2JZNbTstl75oSx+0DdBSWmtLEaktNJX3+yFvxBlWQUSk4LAoo0SiRjPgIwLihKz4FjW7WWOMrLPJ7Py6f8eeUyrCiI6aHTM45xPC5Z5z7nndz/ncb+FyPoW+ote1B3a+VQtb3bjuLIruEMJnojvhcQY1ZXKuzpJGGu2PD+FcGXwvna2TJBB6MwcjzEyctnLEiCRSDDhPl2CEng7/nlMwIk8gmLgA05uBihN8u0vifZyPYVoyKqEIMCYHUyqiZrMEXM7USQhw2I6bJUQkSpgFFBqdBusiZDkEBZREQPjt6S7qHxkMhV0hnaXHYhRZajHMExRguF3qFNtJqY9a5uzxkFJrktuZJiyTjoiBhkudRq/fkp+AJbYGSI07mufjB5wKIOr6SJDGC0O6O/zOUt+QPQToHipzkD0sd6k0LZLGcud4g/1yrzHitHIt0qDGLjXJvaU+jbonAd0mhN+c7mzP8xFHNCliypdKyRyssxZjhYGCJ5FRDxm2JpmkCrejzMXrD8CjPEkhxkSkxu63yD0lAsDqtMGQxWhQSOUiRxRj88uCmexOSHdFjt1lKQVRkVLR6CEjZMTvdhmLXXpTGqkJ+8O1EctISMG1+EhNqytsVUTt2YjuCJ9D3S3OHg4zMRwkh8rkkO4iEkTb4JuBDMsLTRZHaanXqu+HxzI5yyTGClxFBldYXKDIxOyOUovfIu5wWGq1iiiGM7WKxsQVujd2ZEcc4DGhVDBMYjzsyNd5SbdL2e8ryWz1h4OmyGCpUxKWkkXgzGoydiK6I3wOuutlsiHcHgiq3FJnDmbPx9RWEEcTnU5nqNURsPKkPrGnRy8NSX0hviXgMGIstxMEM0aRPxMvy8e0UjdpcUVI6UgUU7oDckGiHUT+hSanxah9DiIjnTMw6FN1/K1RHQgyLFKHMRzs93emWaQKmY/mDpUF+13u/E7SZEV0R/gcv5mBEY2SCz59cocwjCbAiNhbZoSQirfKhQJMx5UQNDadqefSMaXQDJcCl5qg5+ASCht8BGXTaUKqRCnzkkMYUwhfcaSBIrhOSKUUwMcEhW7mcqneICd+PVMvbA3SOEohXUCj6DksYaufJgCN0dBdQvhMdH/HIlCrPrQoLxAw/lKe9d7VJJFbsyZDHVpbrCCEdB3hd0D3j1kZG+zlhHHetL8+d31XENsRNhndERAQ3REQEN0REBDdERD+X3TfQkdA+INgy5+2SGgICH8ISLagYAYBxe4ICIjuCAiI7ggIiO4Iv0skfjzYXybdmVShGdH/SwZ7270dH48vZG/MX+wAfOff0GjyDiLFFwv8zw+2fgq+2rGptrWnxPArdP/HN1d+/s+XbDSJtP3eV29TuWoafDtelbImKeXtUjs2j+OgORBz3lMEJO+j+50r0L2DTb1yxQxPCX78XXRKnqnxU1v2kutdIikdZNHac+Uaw8lCU/6aHJYsEqFihJrBgT9z428DE61ykSnnVxottPSs/CBauzMqwY8AUPnQTYFQq+Lug4mdfqVF/C52vE8n7f4NDTBx76D4U4PqTuv2j6DuBwpdx+Pq0fidTNj24G1GTz+cS9n6aHx5sSqWOn0cJL14mZLypsjK8d5mCeDZvlsxW9VB6N6h9zqNG3szQaNJgrpqNJmXdTOe0VEtziM/nvHsziD29YFVdheY4KS37HpTkdbUaGg/EmemSZN3+Oaaq4vb953uFhdM7gLkqZg6G+cBK73PMLt2VWg32OtXu/dorL2i4uTsNYvgxL6psS5/FvR9qhs4Gd+MO/FEDf++dd1aWXW97HC+2bEbb+1ZOzRvkLn/VtFGozZMnvwkuuPhnsTKUc76xALTzncKyQfur5xYnjyw9F18+u6tyHlVFWA1kPMqSO1zNxZTph+Oz/0LJIPUS+MvId2B3IOv6aqtsCiU/60PNk04Qw5yQDizYkXGf7/R5DerRpN5h7/DlDIuE1pFmltys4GW6XhJDAk0jdRAsWTQsCTZ0Ir7ZJKMS9EzGAJcJOQJeUxoNIBps2pUX3epoNcAX0bHK3OtNCyxZZcRWiOwGCoBXpGb3dF+jQetIfH9yVbD4aM87nZQGPodYHXt2a3tRw0DM0cTtu2Z6ePE9JmhTO+jR4YwPYOboOeZGVR2xUAJfGQp1SomwaPyhQkgzwPpTlTmHqpLzoYprBV7BX5r8lmZ+uBMAwdvnqmBXMVFMuWJA0NqDayQwuIpQYV1yRehQxUYue5El5iplMGKhTzP3ga4WsEY4X8TatNrVCIZDTSoIfjxPsNSAoxoGbMKcD6YJj1PCCYPB6m0WAdwnswMrgeDg16ZApgBXTJ5DDCxYPoMNxo0fBXBM/M1cAxcaMcAx8ABJWLuzzic51hNOrWKo00/YGTCWV/JMcMuxDrK4ybgPDroQexeQCdPVfHU9/F1uwPy9sX87afnrs+Pv3x0e37x0u3xqcWUcz+2Lyy/mn+2ML74cOnvVdPX566PL4KTV8vnnr1cGH92HIbvf908dH9jNMmkFL/LaPKf0GjyZ4zzmu5HDVdtfdCTaTiwd6kLqmzX/dMNOz2ztu58ZbNtuLb4lG3CWNFkO+M9ZTsrrKzvHRWld199niEunL2WwK6Ymjl7OXf2dButoqm3wX5w6QCoomXsfu9EDjR/bFNnLR0ztXfXd9XCR8nSMenhmqauQ9CX5kwmpLu1Y/Km4XBGzc7i+klId125bXcwvc9TXwsuz7DW7b4/ORFJX9oFLtc2p3YdMdRX1w/nay/3dg8AuhtAe6bkidRhMcjcfQTKW97kNUx7sLcrp6DJ9j2gO6sltavkxAH1qSPay6kZ2cU/VafWhPYs5YJHAhh5dXhg6WTkMqz4p+7qy0vQ8JIFxtiWibHvTs3cKp/wNIHqn4P+F5aDPhuauqtzYs32lKf2VufU2a62FWHaUxkTvmZbBvTDtLkKZm22UfpfMmb3jSald5/qzWbtr7e1DdU19Z5tXrpwprnB0/R6DKnXVsYQqkztnQAPnMS79baSJDgUXXNq70UwuQ2RWduwHLD9buruEmU5tPOpn6huntjZ0SRvqbeN8tK7J+AjqbB55lpc6SHdj/+wvPBk4cnc/NMfll89uX3+0Y9A3W8/XTj/sH1u/vzci4GXW6vml2+Mw5Pr/730ZGHqyQAIdzYV3TmrdGerR+QbumYDZRdi+js07E4smGEDurdcKAkBMft2rLYl1wpECJwD8dozHMjqq8x1ydRZJ8MH29KP+RjNY36Zrqw/a6z0Ro3RsPdiXW9tXN0vWJv/x971/zSVZfFAk/cDmZaW9lEy0HbSAS11pHyxBSmQ0lqgQilgkeFLqGD53kr5UqDA8rUKApUiLRRSAgSDshB1BUJGlHU1arJZxyXOuptxMok6+3/sOa+gZsZxY4ybcbY3KaXvvnfuPe993rmfe3r7PpOR2rN6VJUEE8FgoqX/HKqKideqJtXZQ672flRbtUxCdF/Wdg1WGY4ZdUBXGi4bxK4zif3fxKcaa90Id4uuQhQhHzxlTe3t+Fpv21ncqBqyO4fs0EPBztk5m3bIrO2fbjaoq4Z80b3+1JAXRohqQ97KcCbK/VFwrzWtWWb1GN0bPDPlEQD3uSVjTt64rexya4t4A6I7DBeWyQqRYHw4UpjyeK5Oe9nMTezC6E62gI+R+wOXyupqGVrWdHmrDBW9hpPWQYjcpEVXb9HZtXPeqsszceFEQn9dEmV9RwyNddt6YBgbn4xuyinuslUql1s8M9Xiw0WDxaLsG2a+frnNam7vn7a84YPTUKEt8oYSIUqbTFJtyBofTio7W5QjktsyC48+HhoMJ0qwxmKoaMo5OTQoaRjoq3aUgVldXpctEoei5sVze8Gd8TkQ8ZEb208fbC3M35p6sH3vwfrUJYD7Z3e/e7pwd+rKvfWFXeuTr2rWt3c3p3bXF+4u7P7z6tD2P6jo/umQmQs0/F1oEApNFr5DaPJfUngL2hOaxOh+vQDlgwHuTqTQQLwz28QVNxYVHpe+Lp1ItOoUnumyRoVd6y6YyF6tbVyUFU0Twb2uJhegiS53MbqHS53i6JXO64t2FIukuDvwb7krvKRoukF3ItG6xla64PZz6iKhwWC5y3itIN5Qj/R6wr0McLd3z7qz5AD3YJwHhCDc1fJFxYCjWXci37N0yoqyNA2NtXPDWqudrjR316UndCF3t+RkAncPKTLrrynSCpJeRfdpY+fqTDfCvXn4DHB3hLscdqnbobQqEz3I9yEMt8Y1OUopw+1iO3HRNx+4PutehHuRrneFN3WoPGvgBSkfxD4PpHioGOocyOwdPh6sX/b5m3BjmoMdcKxAYyFKL3RiY9yWXqXrKfIS3Y5q1PC8jz5Ap+Ggtn51iM8Hqj2LIbMajuuGsSi4yqTIoiyddtcWTUr0y7wdxR2riwfR3aRQd18rSBvO6LcTJW6vfNqCZg9BCxjSm82vJhlfHASyvrW5/uDJrc2FPz3d3Pzu3ubUDYjdW9u7D7ce1WytP7y0+ajmyt3tq5uPrq4/3H0AIf7WAkVmvvxkUu+5tefLmcfOvxKajHt7IvLvf/jbD3/94Y8+FWGI7tP8cuNivQ/uOjVtD+52uSP3dLFRlwoc2ZV7OilCJR8uLu+efCxO7V2UdU0D+ZkbgAkohw4El4L7Ueu5HYD7ZCowyeZFdbtno2m4p8VjB2rdZrUD3CF0O5G7b8AdAlFQkwu8tUFcnzh3Ltuqdl62cRHuHJg/MH3RvTsnT1NZ5YM7xd17c2RyhDtbiarBVGTkWCjufrHIbNRlaWQwNgX7ovt021BOJMKd4xRXMH3RvQkM9jh9cO/fGEWxeeNkX29OcXdOpRzgrga4D3IZ0Eu1EeHO1lPR3bMGB7DlLovumEbW5qFm3U5DpkWnVhV59+E+Ab2D7u7oqMaKdwx94459uNvKxBOaXNWcV8TM7zJz9+Fe/YYPVQa7SgnRnYxVKW1NhixNZbMuehzgbhPJl1VdyzxfjVFXoZFlA9yJakPHiQY0GwuhB5n9zvlXcKcjm7m0tT5VUzM/ArPU+SufjczDpBRnryMwcR2ZhwnqPKYl5+dr8MP8/MgV3BWC+ycjn8xJzr15/+aFjAwZRG8pn8sP/ZWvmXxCk3tp93zlUotbUXsGkFdwolDpgItncZxJfNbX4C6Yrc/Xp3XWQ8CpLa5uVKAcpVfldlzvqJRvAFlUUuKmHIuntWk2vaFANt5xZ0CdaOpEEwOraa6xxOvxMG7kKx0ZJjVbj2mXQmXdSeUa/XuzsCm+c6aU0qjnVDs0pr4E5Tn6ClxvQriS1hm94m2Lr4dRp1Pd4ojMb7QnuFGUsiG+072sMqWy9a2Fqx130pag+WxTXdmzvhD5uUJ9QSdqFxOwO3DpDbbezDMOwvhe0pumyGpyRbjtlMFTz+ovrm6U6DtSwSB4PuacG9xBw9pnfQTdaFgKJwrRx0h0zdCK3F1dIt8gv/cKV6DPiY1UGqihMxMnC8DdFTiiJCiXCLSeBZMdxdfZqwWo0jmb7lRUyicI4yxqeLYGAvmeSO41LK0Ad+9j66fRBzGmqRJNdcWolgmW2EaFoiIWLbWZOlcdYzseb3ParMkcSpRgTeEKOBlrgq63dQ2ml/TGKyYi5FSmK0Q//PpJyiGA93t3Hz15a2r95wn3NxORB//8KenJZsweDvqv36pywsnbt2+Te59YYaPSWEzEEFIJjxJzJI6EweQ/ihCIJDzMUcBWEZcFn1hHRJimYfLDaMJRhLsZZwcBZARXwA2QhvGOQE3UvgkUq8TkAo/gCJjJuJ2PbQuYQWGjhIBPsGNFySilGkYjpBFYLxjl8OMwd8pmMmn8OBIqYqA9sEsPCyKoXBFdKOFzaWgrEOr4mNUggoVgkUaHLUd8bhC4O3hFxAQSAiqlQUYwgwRcEjajA2zcG2oxEUJ5Tg+TkGhYCj6Dvzgmoo886kguHhhFFyZzsM9M0SieGTxZYaFoN4r6B/wKSyZ8HaA2xoiozAycFJoQexFORogCGVRyCxpA59CHgBhmAwZq1NcMpY7DEwTnmbIEG/lwISK4ZIREyGdgDZeF1yOI6gI9jMqbiQJZQoqUwu6vH2/CCPn8L0BoDr5v+fKTUk/mJIv+d0KTiSsFJ/xfYH5IKbx/0+RI+iimGYyQL96/XCR/F+f1o8A9+36Pf5nZB5WEs3cuJH20p0oxGP+vD6zyLwD+jY7G/lPgh7u/+Isf7v7iL78fuIez/NfJX35jcH+r0OQvxCRJ1i//e3fhvfz2p+dvWY0ZwAt4R8P+4i/vC3epRMKLza0cjZUlkSJNEkMoK/5VaP1MaFKgkWFmgb33+PYjzFCBrGeUILL318YGqF6vkuVIX6/yJpmjZLlsTKqS+b4aSX/+4scfX/x0hjKCC9Wj9rIKCXuKlfTTmf7L6C8fDndW9gEUmuRLw8oPj8GLWyZLwYVW0iiCRQtiEWRQeAAZhe/wikGhSY6UBlVRYDD7sGSUI+WVpGTSAJ6CozOlAmZKNINo75GyWAEEGUA/3YOHwksaFXNyDP4GoDGy5ZukkmJtRZykPYv68cTLF8+Pl77897fhlBGCiM0YJYNCCVqU8FApDhAk/j4kiGqW9fpe8Bd/eV+4+4Qm85JCycKM42RsHj+lEuBOLz+QkaTKOBAdqDnQE3voQHQMvAs0KDSJGpQSbUZGMYNoOxxHg7tFcjYvI5JBxFT+p70zaE0ciOI4KgxUsN3QaAQ1gsShYYim1ISkJAeJxGhRLKLERgI1tx68FPTmrQex7H0/Sr+E/QbCLu332DexXfawl7Usy7LzgyGXyZuB+fvyZhj5k4CvRXeIXyrjvmPU+gE/VfYhilh3PssqxkMaLKWaBkIjpas5fiz37WsXfnjbXYAajrJBJ8unSYj7+XE/JCHk90YHP0kOxo+O6w4rEZaY3hkHyX1vNCmGplSJBl1oYuSSNipbjwsytStmbDB5m1fGLXjae6PJ+bvR5GKtnz3Ypm9KqteE9O4Gpw4ZQnanDpWe4+dOaIgpfZUYFatO/fo6t0Uyz2ADVawVp7r2Xu47auNE5Y7KBKohlWxCa60rk+Jzy0ignlx+kMl5z49s1cNedBuwNWUclt0tKzaavONuTAnajHSju3ejyYYJotNjo8l1X/9hNKl6U+laaaKFl6ut/U5otkdU7rTy4HteDi2h48RUDHQylW8IDSEslU+4brUvlI4NtQ/I/cJcFTgOMjydHxQzpWOJFjOx3BOjQVGZtSRH0Z+/tOFrIZ8++F5zMegMrxVT6axKbE0ZB8k9NprsuYN6x/UFaPvsnl0SMrlfu3bewpMrWbNC158UTZcaTUaESEvpetBEV34hsySyYHo0p6PyOLjCBCqNXsv1S/dQhPP3LdcuQogzTISp7BBrFco34znsPNW1r5+NXTlHJxFsv71sX3d0O1rDAf17qw5jzSJzhntkjkbEXU9gXkZPqgxCMjZYMcM48GSGUhOqfFlI8aKQQho1nERZ8fzNaDKfzqYSaQ6e0O0no8l0It40ZkWRa0CjxyfVhJZPghQ1iHUaycfxPWTqVZmmQRtJThQ4CKZxvMZlhbygiW+XlBPdry+7bXz4kqkWqPPlBsbShCTsay9L1Ai6mVUxAAAAUElEQVTzMkeHTZUyVQ6CsyVlfEDuvy7r1Y8c/hX1zW/1LzULbKEYf0/uH7vBlGG3Fhj/lNwZDCZ3BoPJncFgcmcwmNwZjD8o96Mkg/GfcPQdSUMSadj9ClMAAAAASUVORK5CYII=" width="750" height="80" class="img_ev3q"></p>
<p>In addition to Issues, GitHub provides a discussion feature where you can participate in open discussions and gain new ideas.</p>
<p><img decoding="async" loading="lazy" alt="img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu4AAABWCAMAAACnxePJAAADAFBMVEXb29v6+/319vj///68vLz////o6uzb29vX19jc3Nz8/Pz4+frp6+3z9fb+///9/f7+/v7w8fL+///19vff4eL3+Pjy8/XZ2Nj5+vvCwsX18ez7+/v5+PdXVlna3N5kZGfExsm1trnGz9rQ0tX6/f+3ur7x9/vKy83u7/Dn5OBdXWG8vsL//vzDydPr6eZHR0zOzs7h6fHT2uDPysfk7vPJx8b59vDMz9HAxczN1Nzj4+Ps7Ozw8vTU3ef8+/nGyM3//Pc8fD72+v3IzNP8+vb29PLp7fDc1tHm6Os0NDeysrPHwsDx7+3t8/jAvsB7eHmssbigrLvW09FQUFq9wcnb4efg5ey3vMVyZ181OkVycnSlqK7Uz8u6xdRrcHugnZzt5+D7+fOqmIhSVmCsrrHw7elOTVCCgYKKf3hAOz3T1dhram3o4dng29bl5udqXVVSSkk/P0S/vLzg3tvM2eahpKqJiIs/Qkza5O5ITVleVlKIjZZKREWspqSeoaVqdIlaUEx/c2ny6+M+Rlbq8PWRnrCPh392cGp7f4p0eYarq6yAqIShj4CPlZ2qn5WXmqGSj5BugJS73qa2rqbI2cxgaoGLl6jxxl3DtKS8t7djaXWAjqOKfGrTxrjS4Nfs5tTt8OtGUWSWjILn7uSVspTEu7Pc59R8iJtoYmCttcDbz8FYYnSaprbm2s704prt37LQvqz212OeuqC4pp/g6+CYgnTLwbdOXGv58+W7pu+uyLVJhUvX48y0pZZ/h5OmssSElqzf08hfRkeclY/D0uDz6sXM5b8nKC61wNDPkH7KNy9ZWGy7tq2Ms6DotVC+yq3sz5KtucpIRVji69lhlmS1zcLBrZvK1L61mljUtYN/cEzDO1n664RPptzbeDG90L5UjVerw6TF4raUronb5d3fvMCRMS7TuWaownl2UTibvrGqtYu2z4u7US3c2O3y1X2JUt95QvfWjk7LbVvdq1GVUV7kx3G2eTyOn1yqi/HZm5ebdPK9gY1RSSREcphNkKyMgShXAAAACnRSTlPF////l///xMTGTzExxQAAG3pJREFUeNrsm1tMGvkex9eSYRNEQauAIlCltXVqoTfdem1TRQWtqFTXK1pQRPGGBTkCCpbi7ahoCNZrjCZGq26rMdp9qW3VTT3pPuz60FhbfWub5mSzD+fs6b6c3fMfwLt0u5fzoJ1vggPD/zszDJ//b77/P+Nnn0OoUH0i+vwzFHdUKO6oUKG4o0L1aeLuStxH6BlFdShxp5Dc9irck4CeU1SHD3fPMOx+wpNQ3lEdOtxxp7D7C++MnlRUhw13Z7wD3LEk6/ucMHcoMOEI8tQnFCwwrBhXCIrEOyFrMBR30MIFPCMSCATkQdgW+jkxO62QzYp12nkEN/DuCW7uW8MFjPWyggmzGiFvLAGKZB3Z58g5oUiHDAy4jX75KO5WEXDbRPgjuGO6NNcSYvkTeDfvGvNoztGSk/XG41D0dE9EIBWCSqr8WGUPO93IbsOFVRpee2GhJmRr010jwFqXDKxmxBoQJO0E1oc9EUTKtgO4Mt3jK51r5vM157wrec21C4X870GHGJM9IlBA73jeVHbWTOv1Os8J8rXqdMxsVVVh1XWX/mcRpb6+NeoOX9/rKPKfPO5EZ1I4aZvCSUgt/p243+p7wBuF5dWwLqiCzRU3Lggbeo8HP6RNuMy2noPy0huHOrt6KmV+LdV8yUSbtikpbXPLt6Qb1nj9Xuumvq57KuEaRqsbDIonWhWNkckvvHs1cGy0Ka2k3Q/K61tuTpdLJGxjyXwGG0iekTObniGsWmg0CxRmmWyUa5DJmiJQAD5x3HEkFwqO6L4pIs6T5EL4vbiP6VVVDM0Js1T3rYxf1JglEjY8Zg2xW5kpoqKOiwWVl0Xj9KCH4ogWcRWtdZTGEP4Nc5N5FbJZM+xWs6xQ3pi10NPQu2XdPADMc3ajvqNe1yZWjGkbm/N5JxKPYbsqhJfIw/pBv9kK7siCSlk3eKZkfoROp3tMq3ICRSpT0vSzGoHiKym/gVvN52ddRQH4tHGnhnu67m5DPLp3uuU3cL8hspyVMvwewslmGo0rFvIB7v0V1TIZg0FT9Q6JH41Jlq706Vza4ExGe49pgaG40mKxsRwtsnwh7dmyZgLc7Va1vNeDbFfMJDtTMjIklxgUY0UqgQTomVe6nAGawdrxVJE4N10O0wQjZ+eNyFb7VTkD5WyJqh3BfUyaCXDPzFSiYebTxp1A2ndi5ejRD+HOymPtCTMzBlNmMrZUOpKdKy1qqh0CuCd0N/N4vt2VuV/2643BdbphySPvIQYsq++RVskUmFKmbSx6q95gkgFr/chZq7Ue4L5pTapn22WcZAsB7jozqO5sY2JlZWViFCkbVHled2WNktyXoalRC3m866XzRqT/TqqWRAIl6AQA90tSGk37NINGEz9yRwk4SCJSnXCgJFNxfxHuR1ysi7BTu3ZDojjGfeDeq3vf7MJ9ssiQxGfADHiitAEp0fUAd0oLmwak1fl/nf7YZVKrtVwMbuMX6XJlcCN/K0UDa34mDKzGrxpgYK0CuFNFVitbdy3lhF3Fz5c16g6pimZQ9C+3q2EYljw+3l8hAM0kg4quogxGBZemV83FblT3JXNtg7xjGOC+mM1L52rFpnJLKkrQwRHBMy4kJ8fPI3Z4eDY7jPgX4E4It1ZYusYUZ1/jXnIGCbieLg5xH/hx6tWrVwM7cMd4t+jwlbkVluaQMVp7RTtc1Vj32GfGcj409OaMBeBePRGrf9p7NVAk047n10loc2mY2Eu2JG236hDrgr4VWAHuVmvAjOUahLEJGkjnSoqW9T1D1Yrng0Psu8wL5R3HJ5dzQkNDu5YXb7Q8K64bVJbr0gbmH+PDwsK6VDk4zkzG0lgTGKrGSrmWWbVE/D36k9gBKuzhIY+Sk5Pz21r6+lZXWy5Q/zzuVBLoNES6SaNRltnWBNd0+lsjPcEB7vj7UwD3qfu7snuLjnxhWN0RxOyHm/V8wZfx6b0+M+JapVI5avG/pVY1llfDqrnivqKMVqk4yczI2ZbdrdYRxJqvLrRaqVZrTTrAfUPB07T20cIK47D4TN14m7y1uUYPcNdqwB7qrbifN+u53BGAuwpUfrgiIye4jd3pfytRtBwlhfXPcke1AmUaitFBod0nwQ/Antwsmll99+7dykrf8D6JxtODTKfTyfRTH4c7BSnibsrLSadPJ1njenRQfpa/tezjHON+Z2pq6t5O3J/oO6bBqBRmNAWZuvWZmvhyeXLkjBxmMBhai39wDS99PCdvSJAlbZUyaAIwulyCWKm27A6sZps1PndYDaxq+QSuxW7dwj1a1ERvYcC56vGTdcYubrVAwgW4F4lBM7VhcVara4PhuXa4s6RcmAskFSyOqXtvQyXp8vG0WI8ZudiYXS9UoBwdEHGeXEBqe9aLtyvv369m/vPtymrJ3rjjZVIiMmXZwwgH+Z2RE+76Idw9yyi+x5zjrBeLbFNzawRoTXDDOQ4zdwDw3+zE3Ts+lROG6BSFWhAfR/WuvH4tMDbKjcPhpEQ5QYTIUiwg1oMUEB7NIqekpBSHgwRk2/IuqxNixWxZNxQYgIW8Peis+PNUVkze6dAwVlCIe15iHIdDCvC6nZeYWuKV5hQYkBZdGmP94GSXYDL4dDcueKUSIEzpFzFOUKSbE8rRAZH36+7k5ImR+rf/ebvSt7bWsbK+/h1mz/xJ/klnTyCPWizyMjI2axFQ9u2S+4fCDAThfI/ZJ7cDvJo1CoA7zmGYwWKR8n6ftesmgn0vSNY/toN031yx8cKRMB98b+MeAnSK5XAr4XVWa9ODjHKA+8+/rq398n59/UXkniyTz7Quy+y438z3g6DSWoe42zML4cTJzVV515ERpLPjoSqW9d2dH1nYj8AdFao/Gt0LXjcOGgyGn/7175XVtbW1wR/W1/8Rube678AdwsT7QQVeQZcc4W6fYCfi3bZ2hHNFJiKdHeOO7X/RH4fijur/qYLXpibNnPCnl2/+y/117Zf5Nz+8mcb9RnWHAuP9orsvxd/1d4Q7Lpyy386OuBAd4x53kndsN+5EZ1f79NHmMAFD2ZaHiJSPSx846p8/U1Q0oR+K7F6rbBVKX75Z/fnvD7gvX75ZXtz7TSdlMY+WXT7mawrbwD248kSN8Zwj3CGK2z68e4bv6UjbcMeTvYp3486JwqchQHufPw5hfAiYguLiuLPXth19FIhIgR7M21Bkmb93MZNp7YCYjf+FInrae0NAyPZbGiLJF6GCuG1rosnINnGhzHMYFjMNWbriWOHIjcM2xH08wLI0FaXlwMun5H/snftPWlkewCPkNpOLCIqXN4pQRASUh4ioiJGxig9URAHfVfHNw0db8dGK1mfU2jTtWKsxNmm0VbeTTFr7S6vd7sb5oWni/LCb7PwDbbY/7iTzw26y50KnD1+z7XaTrT0fxXtFuNdcPufwPYdzzjcn79xMUe0vr16/fv3rK6B7UeHBR0U29vMvnmss1gZrSZlah1BQl/z0kbojzHQa54OqnMIk0w92cX4wZsadu38QQYEttzyCS2YOy9OZZzXldYbc0DTzZZTMJHIoKIeISWyxXFqHIdKQXlWpzIhz4Q0ELi1bo0TJGJWDOfmFRAxDqDSLHHjPJVOoTBoT/xBgOytHHsYlh3AoRA74i+sKXnC5qd22BH4kK9fdbSNbzunxe5iBJ7BtsbJsdQ+RRkIyyExwBvi50pcKpUAdk9eYV7v48vXrl3/7+edfLIc9CrvYz8LezZjm4jF4xnuzHg4OAEZp6XQy7S1kejp2yAe2xw8Ro7JtkTqnmC9NFRkMqVMpml5QE5tzLQb5GWGhRJVgMN91G4QKebZI6WQpEVkVUJQtNjIqBQnilFCxUVGpkhgMp7oNedVhCDiOyskyyAkIeGdS5cjB7zpGGVuYhSRrGoPvU04pQx6h1iNOW2GBBlTmbKFEagBvIGxbuEXcqAPHuizhGxPERjgm7Auu311iUUzM1N9fvvz1X6/+6Tq8SRvJYB53kMOmd4D6l/kWDnro6ITfGRFZYGNUi3vYN6Os4Wa9pjw/Cddda8SqjOYkV4pGWSdi2MoLDOLiJJlaibCtIJapE+nZrCSnIk9n7mWnxN2Ud0lTCi3VETJ1Wba0zRaXr0SSWZFSllytz2Zp5QwBJVMt7OoNnC1f3yEPU4Dn68OIVWW4/i5buDkJ6M5IwTTGLmOXoFtTLJSWMaE2X279jmJpkZG5BZK/Pn9uoX3aMf5Hk/dwzzQ97JgoIzNfpVHmCELQbLNCzqkS5CstVqD73fBuqZIrSYnFdXcJ8Nl53dIofm6+yixIuczmA90ZDGtsVXVEhqYsWdomx/LLkWTpZdfFao3+LKvMLAL2G7SDOgxFss16Sp2VrlGx9CEgXgvo3i3ngvKB/xskjfymkREliozp7ZbCUQNfN59/ajYWqG+tDLmExW+MMqZr9OoUt8bKiuJH8qXWU1WiGHmOSCpisKRRGpaekK0o5ypUQFqngp9bJahKkaqEhd9qVC6+MNySYgYFIYHPV6XpmJYk5KyiMLNLkMA36EJyrCEIkcJVl1sKkWGRsS28iq+TgG2sLAcozdZKdBmKJPBvuFmsPJ1FakztksYIWVIlfMWh7p8C7YjqPTzQGnSLxYwCN8OqEmvBl0Er5vPxHb5Yq+UbjOAmFvMNYKPVgrvBtzANtBlIYSgJxUgoGoFwSFQuIUJGI+E9LFwChYoiKAXBm6ccDkICLc43PZQoN5KJUDEagYLSQgJb/HEIFTSIwQ7VjZ/TgJ8TPzfYzYWvONT9U6Bi4XGHQA524lA4HNTZ1nYG5fyHfHKXybH995TPdhrI1617cNGM/XzQrKWGwesLOSm6QyBQdwgE6g6BQN0hEKg7BAJ1h0Cg7hAI1B0COag7lQCBfB18A2p3JgTyVRDyDQxmIDB2h0Cg7hAI1B0CgbpDIFB3CATqDoFA3SGQ/wPdqRzSQZhwMijkJOqO0tNCDyGOBK8p5MTpTqUfsc5MHAovKuSk6c45c9QqYjR4USEnTfffWTSP6EwN4GYiT6fiXAqFQnvq2zs6hJ1Xfs962vlb6uv0d7FRQSpDWNUY5Q4E/5uVeBa+jIK0IPSMh4IwhINhGKdDGFLX2NsxVR6B1OUlEe9VBpc97jAE0os4FUGEcYw3e3AdJcjxulOZBDL9LWQCGvbxumfO4ml/eU0LvbLHDWJ7Io/XWTLsqbHOXnhi35L/4A0kvu4cqX57vEdjvMSG86Uz7dVhdTcL5xt6uGmxm+Px8fE8cBuVeK5Xmmejoxf25uOLx1oX7I5JOfGxr4dY34CviUqs86/0UMH2Wmcpr7OTx1tgeRzg+ImJraNwrRvIcbqT6HQa9g4COZ3M+WjdZffGJhrzrnlWepe8poqh/sGxzu2lpvYrY46FoZFtVx5g0L67/i5XdvId+4jtuW/v2UbW9967052T4w17w4O1tR7Tk9pa63yryTHh9zUP7Dhrp1rWTBeia6qHPdcLZUHd6xYdG5La6tPI45XB2wO+83O2zb5V4WyN9eEfb0DdIUfrTqWl788jQ8HSSR+rOyKrX1ciy0OrWR2Liec8o8+iJ/XTjpqLY501Hl8Jntxs+Hbik/fW490s8pqi+0wN0TWV9t0LraaF5oFt/O6hLRDWEB9P2K8mLF512ncsrG4/jxe/tt47b7pUO+dxTMzJXXbHaNq0aQfovjXW1F5R5N1Z7ludGr8wMwh1hxynO4F+SM8552AGmw90Dz2oO7I0MMqdHhEgsselU32l7dEV23eGthrHKgAbQPfMacdG7HvHqxu0O/rHWidbJrr8rSX1pfrlvj1QJvy7I3MlsbJrFd7SGWC8/VbLhWLP1vnz4ytG++71sQpQRiqK6xM36LOtq5cRoHtLYlFz0cCtjr5LRQOO9maoO+QY3ZnB/KnUfSkMmAcKwXu6u+/fv+8+oHvyA9/cwK0s4kOvacHbMFHrvXHN67vi50Wv8fbw4H5x5YPFp9n5fkfN3NCM/xYIZnrmecXPEquRjsVO70hL4o245+0mXzOu+87TtZK19bk5/4r2dtPV9GxQLmgkiZA2PzApOoMQZ7damvpn5rxA99GnfY4SlwfqfoLITH706FEm5b9Y2naf7nQM/0ljid+E67KC3EBmGxrhSN1DN1/848Vm6IFEk0+9uyt6hHjP7pN6KmqexQse9pVe8azP3faWvKe7jBksWZtrJlNNpce0/mMIrnvpXPykIAcEKdMrqvrOW7FLretRi7juw+Mlnq3m5vGf9HX+q1lvYvfMee+qxbMaK5tev1ZR1LnQvrfcN2n3VTQ9gbX7yQEd/vMfAMv08PBwevbZz6B7MDk2LWZyghX0natuvJsVqN6pR+v+3Yvvlvd3RCar/a2tjgkBAflLfJtnxr97qTDzga/f0wBCjRKESkoO6k5cuhJMl3Q29faI7ofWkZjm6u+9f1o6r0qYj84r2sbqfb3JsxtpD3y8mvGt2qadzb7R5prm5qJLyszF33Rnz/67vXMNaurKA7jJ7clMwyMJSQg3ZGMeJCSbC0IekIRHeCVQnmkMsGqsZBewIqazsFDqqxaxrc3U7bhp1Z1tpBKzy45bOoBdHhl3O6tUrBQcsKxfFhE/4dbVttOdbvfD3nsDFCGhTqfOLHp+M3DJvSfnZuB3//n/zz3h7D+q3nN+y7P8V17ue+7UoX27L5/e+1zFNeWxVqj7YwPjTx8Qth/3swj8I+awLZldHk9//EPoHk+MXnPFLS3bDoroweiuscrJ64C+tu4ronv787sOv2N7ddeW3/Ne+YT3wuZN9ZuOsH734psvvFTx2i+fBQNndu96mxgxzzn/cjCDL/jwD4ff+snW+o0vXfzj/k8qtlZUHPpzm5mB/fxwG8iO++zFv7zb+rMtP9311zP7f3G0FWef3klG981tADn5zMebNm+uf+a9U3tf3/vb5zd1n3/bcWhLPb6r/mOo++MC/7MbEzdGPxgJ+AkCI5PhEpqo2anh4Zu+/qXrhBFO9zhCd5aMJhYZUfLuKLbnDXLNYQYrrO6uHlz3nqIHdU879qaaApyat7o/2nou+czRc80HrOyz9tK/XWjZUbEdOPt27pPEkO2uBX10Htt4pLnBfHLjO/K03+wkaN2egJ//5NFU4j1gmxwz951THrj8of1s684KvN69nH3sCAU7+boWgMYdB1tqZaKrv045IBVd3X0htT1d+eqFgzg7tnZD3R8PkEu47KOjNZ0jxwludZaGXlYOYfcO5xK4u4LpeDNqyFsrujPpDLEIBBfcY8TVtKSuqXvkYB+ue9/gitydzljYYGwK08yNARgdMAEioOAJEoVYDZuxMO65+KIFbGJdGoz8Ti60ETyhIFgkE9/iKcT6M8RzBVwul4GwqdHEkqtgcQUPhAGIo2SPGHdhHWG41N7jUqb2vH/jyyujCkXgFkFAoeCGbughbR++mdtLDp83yiotlDVzd0C3ihZ21KHFViLpiM8Mm7sP3hv9dPTe4KpSFQL5EXH2fP3FlSv/yVR0BlEookI1i6H7CNtvDrlzp4jwjpXoOR3hkhlmLHlFMNKFizG3uaGDSAeoYUdmIgfv3/vvvftQd8ij1X3iU1L30q5+gq5SRei5iFzcc/fU0Oxw7s3bxJvCVSsq6wg3EBkRHIGhrygDVlWq3+leNHj/28Fvoe6QR5u6Iz0ncN1HSxXB3H1EwQqZzCDxbjy0e4n8fYooVrGmi1jTr8LpHs1mh1gkm565qutl0f2bu7S736ypO5OLXz4Id1Up7Yxc3FVAozzwBPPy+7h0Fp6lLzxdgB/Ixr+ILSDye+Zitwj5HEEm0RGdulShCtaakFxwOw+atE64dOKrz698+VHXgu79nWE+WDGEx3U3kb+7SWkLq3my1HC6A0ZU1Kpu4mKpMWF1p92tiqRFVt19UPdsznKPnDz8UbZQvjLPatcnLKjKR5cfxJoT0797iYgyHdUCvpicE8zT5bNtiZJYfJuX3IQ3EvCCZ8rmJaYnlWWnmCQUJmiuXuzOOTsf3uiYgV4t9Gi91KoTX/0b9/14oIsgcKsLCd2uy00OzOROeYMRrdBUyQirO2BSM9kR8fQlKNzYEDPEvm+KWHut2sypjMjgCFm0BDPNWNRhjnRRk4UWerKQFg0w/CeBsVKpZ7m4SiG1wOiQyYmdRfHJnMo4kFOexWQIOFVcF0cYARA2XWNAHOQIEZ3Nl/GS2GhbBF9lKXyjDdfcqDASXSZXl2EOiRlt0HOqcjSyxbmWp+fcbU6/1xvR5em/HTVp6bTUeSrNXq/C7y0rCEz7oO7rhoH3T3zxj8//HiBvM036s8O16ydi+/CUJ9S4fIj57nRuVCZricyokB+3/h7d+eK2Ops4q0SiyUdTHVIVTyTioBajrppnMuKhGjPqum32KqXMri40OZJsBptVDtrxQ8JTBl0WHs9lBrbGgErFao0BT0v4aGpNfjlpJrJHz5Mgmix8m4dpcN3N5bZuoV0O9khiQI09o9xqcGS1221JCSAnoAXI+Pzs9Zq5oTnPnXlvr2duaHzG5/PNuIfGfXPz42Ozbqj7ugFzXpr419cTp9mxsbHsOCzsWzYS5ZntnekMefARfZrJiVoK88UGjbZxu01vd6kUZ6+ZyzmJOqteDTRZIC0lsZajy1cevMwtqU7Ui7QDKjkoNACHCS0rlJCC5xcnofl2eQ3ubTKaldZkqlXj+7FCfVljEqbLKtR3gKDuTbakAvxSaNyeABr1GkNpSXeHo1tn7QDZ/g7gnHO7x/w+7Z3r472e8V4cXPWh6THLnbGh63cuDsDovp7KVSzHmZODACaTuXY74kZMzI+qe1xY3cnh0AJUWG44ZUjpaEwqrZXwVTwUrUQbVDyr1GQUaUF7NW9bZbNKqkINDj3HkiIhonuNnqMTkrrTlS6HQSfhJBerNeronJKkIoXLWKx2UUGdWG2pQ4UijjjLQiF156tsEkL3NFStFGcVSlwl3RxVqkBjIDOz0z5vwDfTa/nn9WnffMDt8Y1N+oY8gbGy6bEZ7/jYOIzuTxY/VHcGK4ztGeSQSka5rNwqNokMKfrSJjVPpTLp7Kp0sVUmbaq1R+Jla4PQJRWyikqFLF5DmbmhgUMBmFJaFeeKq7MAerNUncdvUGfI8tURxCMpDWCuUqkcmKVSNVUptZht+BZJLiNy9wwa3SgHGSnFtWK1QlZrL7fK1EJNPlkFd3mjEf9tL9d/2zOjTfN0+NWMyRlvp5finJ7R8qc9HjlUAOr+MOFdESq+RyqC96MUnCUckmUPSBRhumSCFcW2wLTcRnpUzBqvBz+JkRsR51o8SQbzwW4RgBAE5/IvdBQD//5Q94eN7xFU9iq4q0YxkdgfPm2FyYX/lAzy/6E7BAJ1h0Cg7hAI1B0CgbpDIFB3CATqDoE8tO4b4C8B8qSwYcNTT2+AQJ4Inn7qf3evwjA0KV9HAAAAAElFTkSuQmCC" width="750" height="86" class="img_ev3q"></p>
<p>Furthermore, communities often hold regular meetings, such as weekly or bi-weekly meetings, where you can stay updated on the community's latest progress, ask questions, and interact with other community members.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary-and-insights">Summary and Insights<a href="https://seata.apache.org/blog/explore-seata-journey#summary-and-insights" class="hash-link" aria-label="Direct link to Summary and Insights" title="Direct link to Summary and Insights">​</a></h2>
<p>I initially joined the Seata community through the Open Source Summer Program. I completed my project, implemented new features for Seata Saga, and carried out a series of optimizations. However, I didn't stop there. My open-source experience with Seata provided me with the most valuable developer experience in my student career. Over time, I continued to stay active in the community through the aforementioned participation methods. This was mainly due to the following factors:</p>
<ol>
<li>
<p><strong>Communication and Networking:</strong> The mentorship system provided crucial support. During development, the close collaboration between my mentor and me played a key role in adapting to community culture and workflow. My mentor not only helped me acclimate to the community but also provided design ideas and shared work-related experiences and insights, all of which were very helpful for my development. Additionally, Seata community founder Ming Cai provided a lot of assistance, including establishing contacts with other students, helping with code reviews, and offering many opportunities.</p>
</li>
<li>
<p><strong>Positive Feedback:</strong> During Seata's development, I experienced a virtuous cycle. Many details provided positive feedback, such as my contributions being widely used and beneficial to users, and the recognition of my development efforts by the community. This positive feedback strengthened my desire to continue contributing to the Seata community.</p>
</li>
<li>
<p><strong>Skill Enhancement:</strong> Participating in Seata development greatly enhanced my abilities. Here, I could learn production-level code, including performance optimization, interface design, and techniques for boundary judgment. I could directly participate in the operation of an open-source project, including project planning, scheduling, and communication. Additionally, I gained insights into how a distributed transaction framework is designed and implemented.</p>
</li>
</ol>
<p>In addition to these valuable developer experiences, I gained some personal insights into participating in open source. To inspire other students interested in joining open-source communities, I made a simple summary:</p>
<ol>
<li>
<p><strong>Understand and Learn Community Culture and Values:</strong> Every open-source community has different cultures and values. Understanding a community's culture and values is crucial for successful participation. Observing and understanding the daily development and communication styles of other community members is a good way to learn community culture. Respect others' opinions and embrace different viewpoints in the community.</p>
</li>
<li>
<p><strong>Dare to Take the First Step:</strong> Don't be afraid of challenges; taking the first step is key to participating in open-source communities. You can start by tackling issues labeled "good-first-issue" or by contributing to documentation, unit tests, etc. Overcoming the fear of difficulties, actively trying, and learning are crucial.</p>
</li>
<li>
<p><strong>Have Confidence in Your Work:</strong> Don't doubt your abilities. Everyone starts from scratch, and no one is born an expert. Participating in open-source communities is a process of learning and growth that requires continuous practice and experience accumulation.</p>
</li>
<li>
<p><strong>Actively Participate in Discussions, Keep Learning Different Technologies:</strong> Don't hesitate to ask questions, whether about specific project technologies or challenges in the development process. Also, don't limit yourself to one domain. Try to learn and master different programming languages, frameworks, and tools. This broadens your technical perspective and provides valuable insights for the project.</p>
</li>
</ol>
<hr>
<p>Through my open-source journey, I accumulated valuable experience and skills. This not only helped me grow into a more valuable developer but also gave me a profound understanding of the power of open-source communities. However, I am not just an individual participant; I represent a part of the Seata community. Seata, as a continuously growing and evolving open-source project, has tremendous potential and faces new challenges. Therefore, I want to emphasize the importance of the Seata community and its future potential. It has entered the incubation stage of the Apache Software Foundation, a significant milestone that will bring broader development opportunities for Seata. Seata welcomes more developers and contributors to join us. Let's work together to drive the development of this open-source project and contribute to the advancement of the distributed transaction field.</p>]]></content>
        <author>
            <name>Yinxiangkun - Tsinghua University, participant in Seata Summer of Code</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata-Raft Storage Mode in Depth and Getting Started]]></title>
        <id>https://seata.apache.org/blog/seata-raft-detailed-explanation</id>
        <link href="https://seata.apache.org/blog/seata-raft-detailed-explanation"/>
        <updated>2023-10-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[From traditional storage and computing separation to integrated storage and computing relying on distributed consensus algorithms to ensure transaction data consistency under high availability mode, what changes has Seata 2.x made? This article will provide a detailed introduction to the architecture and performance comparison.]]></summary>
        <content type="html"><![CDATA[<ul>
<li><a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#">1. Overview</a></li>
<li><a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#">2. Architecture Introduction</a></li>
<li><a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#">3. Deployment and Usage</a></li>
<li><a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#">4. Benchmark Comparison</a></li>
<li><a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#">5. Conclusion</a></li>
</ul>
<p>Seata is an open-source distributed transaction solution with over 24000 stars and a highly active community. It is dedicated to providing high-performance and user-friendly distributed transaction services in microservices architecture.</p>
<p>Currently, Seata's distributed transaction data storage modes include file, db, and redis. This article focuses on the architecture, deployment and usage, benchmark comparison of Seata-Server Raft mode. It explores why Seata needs Raft and provides insights into the process from research and comparison to design, implementation, and knowledge accumulation.</p>
<p>Presenter: Jianbin  Chen(funkye) github id: <a href="https://github.com/funky-eyes" target="_blank" rel="noopener noreferrer">funky-eyes</a></p>
<h1>2. Architecture Introduction</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-what-is-raft-mode">2.1 What is Raft Mode?<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#21-what-is-raft-mode" class="hash-link" aria-label="Direct link to 2.1 What is Raft Mode?" title="Direct link to 2.1 What is Raft Mode?">​</a></h2>
<p>Firstly, it is essential to understand what the Raft distributed consensus algorithm is. The following excerpt is a direct quote from the official documentation of sofa-jraft:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RAFT is a novel and easy-to-understand distributed consensus replication protocol proposed by Diego Ongaro and John Ousterhout at Stanford University. It serves as the central coordination component in the RAMCloud project. Raft is a Leader-Based variant of Multi-Paxos, providing a more complete and clear protocol description compared to protocols like Paxos, Zab, View Stamped Replication. It also offers clear descriptions of node addition and deletion. As a replication state machine, Raft is the most fundamental component in distributed systems, ensuring ordered replication and execution of commands among multiple nodes, guaranteeing consistency when the initial states of multiple nodes are consistent.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In summary, Seata's Raft mode is based on the Sofa-Jraft component, implementing the ability to ensure the data consistency and high availability of Seata-Server itself.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-why-raft-mode-is-needed">2.2 Why Raft Mode is Needed<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#22-why-raft-mode-is-needed" class="hash-link" aria-label="Direct link to 2.2 Why Raft Mode is Needed" title="Direct link to 2.2 Why Raft Mode is Needed">​</a></h2>
<p>After understanding the definition of Seata-Raft mode, you might wonder whether Seata-Server is now unable to ensure consistency and high availability. Let's explore how Seata-Server currently achieves this from the perspectives of consistency and high availability.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="221-existing-storage-modes">2.2.1 Existing Storage Modes<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#221-existing-storage-modes" class="hash-link" aria-label="Direct link to 2.2.1 Existing Storage Modes" title="Direct link to 2.2.1 Existing Storage Modes">​</a></h3>
<p>In the current Seata design, the role of the Server is to ensure the correct execution of the two-phase commit for transactions. However, this depends on the correct storage of transaction records. To ensure that transaction records are not lost, it is necessary to drive all Seata-RM instances to perform the correct two-phase commit behavior while maintaining correct state. So, how does Seata currently store transaction states and records?</p>
<p>Firstly, let's introduce the three transaction storage modes supported by Seata: file, db, and redis. In terms of consistency ranking, the db mode provides the best guarantee for transaction records, followed by the asynchronous flushing of the file mode, and finally the aof and rdb modes of redis.</p>
<p>To elaborate:</p>
<ul>
<li>
<p>The file mode is Seata's self-implemented transaction storage method. It stores transaction information on the local disk in a sequential write manner. For performance considerations, it defaults to asynchronous mode and stores transaction information in memory to ensure consistency between memory and disk data. In the event of Seata-Server (TC) unexpected crash, it reads transaction information from the disk upon restarting and restores it to memory for the continuation of transaction contexts.</p>
</li>
<li>
<p>The db mode is another implementation of Seata's abstract transaction storage manager (AbstractTransactionStoreManager). It relies on databases such as PostgreSQL, MySQL, Oracle, etc., to perform transaction information operations. Consistency is guaranteed by the local transactions of the database, and data persistence is the responsibility of the database.</p>
</li>
<li>
<p>Redis, similar to db, is a transaction storage method using Jedis and Lua scripts. It performs transaction operations using Lua scripts, and in Seata 2.x, all operations (such as lock competition) are handled using Lua scripts. Data storage is similar to db, relying on the storage side (Redis) to ensure data consistency. Like db, redis adopts a computation and storage separation architecture design in Seata.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="222-high-availability">2.2.2 High Availability<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#222-high-availability" class="hash-link" aria-label="Direct link to 2.2.2 High Availability" title="Direct link to 2.2.2 High Availability">​</a></h3>
<p>High availability is simply the ability of a cluster to continue running normally after the main node crashes. The common approach is to deploy multiple nodes providing the same service and use a registry center to real-time sense the online and offline status of the main node for timely switching to an available node.</p>
<p>It may seem that deploying a few more machines is all that's needed. However, there is a problem behind it – how to ensure that multiple nodes operate as a whole. If one node crashes, another node can seamlessly take over the work of the crashed node, including handling the data of the crashed node. The answer to solving this problem is simple: in a computation and storage separation architecture, store data in a shared middleware. Any node can access this shared storage area to obtain transaction information for all nodes' operations, thus achieving high availability.</p>
<p>However, the prerequisite is that computation and storage must be separated. Why is the integration of computation and storage not feasible? This brings us to the implementation of the File mode. As described earlier, the File mode stores data on local disks and node memory, with no synchronization in data writing operations. This means that the current File mode cannot achieve high availability and only supports single-machine deployment. For basic quick start and simple use, the File mode has lower applicability, and the high-performance, memory-based File mode is practically no longer used in production environments.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="23-how-is-seata-raft-designed">2.3 How is Seata-Raft Designed?<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#23-how-is-seata-raft-designed" class="hash-link" aria-label="Direct link to 2.3 How is Seata-Raft Designed?" title="Direct link to 2.3 How is Seata-Raft Designed?">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="231-design-principles">2.3.1 Design Principles<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#231-design-principles" class="hash-link" aria-label="Direct link to 2.3.1 Design Principles" title="Direct link to 2.3.1 Design Principles">​</a></h3>
<p>The design philosophy of Seata-Raft mode is to encapsulate the File mode, which is unable to achieve high availability, and use the Raft algorithm to synchronize data between multiple TCs. This mode ensures data consistency among multiple TCs when using the File mode and replaces asynchronous flushing operations with Raft logs and snapshots for data recovery.</p>
<p><img decoding="async" loading="lazy" alt="flow" src="https://seata.apache.org/assets/images/Dingtalk_20230105203431-6a34d0f29cb4b8663f604d87cd73920c.jpg" width="600" height="467" class="img_ev3q"></p>
<p>In the Seata-Raft mode, the client-side, upon startup, retrieves its transaction group (e.g., default) and the IP addresses of relevant Raft cluster nodes from the configuration center. By sending a request to the control port of Seata-Server, the client can obtain metadata for the Raft cluster corresponding to the default group, including leader, follower, and learner member nodes. Subsequently, the client monitors (watches) any member nodes of non-leader nodes.</p>
<p>Assuming that TM initiates a transaction, and the leader node in the local metadata points to the address of TC1, TM will only interact with TC1. When TC1 adds global transaction information, through the Raft protocol, denoted as step 1 in the diagram, TC1 sends the log to other nodes. Step 2 represents the response of follower nodes to log reception. When more than half of the nodes (such as TC2) accept and respond successfully, the state machine (FSM) on TC1 will execute the action of adding a global transaction.</p>
<p><img decoding="async" loading="lazy" alt="watch" src="https://seata.apache.org/assets/images/Dingtalk_20230105204423-03b6eb78f785f04c532df8119fe9ddc9.jpg" width="815" height="591" class="img_ev3q">
<img decoding="async" loading="lazy" alt="watch2" src="https://seata.apache.org/assets/images/Dingtalk_20230105211035-6a61157bb4bb72208c63caf3dd647856.jpg" width="808" height="595" class="img_ev3q"></p>
<p>If TC1 crashes or a reelection occurs, what happens? Since the metadata has been obtained during the initial startup, the client will execute the watch follower node's interface to update the local metadata information. Therefore, subsequent transaction requests will be sent to the new leader (e.g., TC2). Meanwhile, TC1's data has already been synchronized to TC2 and TC3, ensuring data consistency. Only at the moment of the election, if a transaction happens to be sent to the old leader, it will be actively rolled back to ensure data correctness.</p>
<p>It is important to note that in this mode, if a transaction is in the phase of sending resolution requests or the one-phase process has not yet completed at the moment of the election, and it happens exactly during the election, these transactions will be actively rolled back. This is because the RPC node has crashed or a reelection has occurred, and there is currently no implemented RPC retry. The TM side has a default retry mechanism of 5 times, but due to the approximately 1s-2s time required for the election, transactions in the 'begin' state may not successfully resolve, so they are prioritized for rollback to release locks, avoiding impacting the correctness of other business.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="232-fault-recovery">2.3.2 Fault Recovery<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#232-fault-recovery" class="hash-link" aria-label="Direct link to 2.3.2 Fault Recovery" title="Direct link to 2.3.2 Fault Recovery">​</a></h3>
<p>In Seata, when a TC experiences a failure, the data recovery process is as follows:</p>
<p><img decoding="async" loading="lazy" alt="recover" src="https://seata.apache.org/assets/images/Dingtalk_20230106231817-3ab6f266e902a1778a874edd974cfabd.jpg" width="835" height="572" class="img_ev3q"></p>
<p>As shown in the above diagram:</p>
<ul>
<li>
<p>Check for the Latest Data Snapshot: Firstly, the system checks for the existence of the latest data snapshot file. The data snapshot is a one-time full copy of the in-memory data state. If there is a recent data snapshot, the system directly loads it into memory.</p>
</li>
<li>
<p>Replay Based on Raft Logs After Snapshot: If there is the latest snapshot or no snapshot file, the system replays the data based on the previously recorded Raft logs. Each request in Seata-Server ultimately goes through the ServerOnRequestProcessor for processing, then moves to the specific coordinator class (DefaultCoordinator or RaftCoordinator), and further proceeds to the specific business code (DefaultCore) for the corresponding transaction processing (e.g., begin, commit, rollback).</p>
</li>
<li>
<p>After the log replay is complete, the leader initiates log synchronization and continues to execute the related transaction's add, delete, and modify actions.</p>
</li>
</ul>
<p>Through these steps, Seata can achieve data recovery after a failure. It first attempts to load the latest snapshot, if available, to reduce replay time. Then, it replays based on Raft logs to ensure the consistency of data operations. Finally, through the log synchronization mechanism, it ensures data consistency among multiple nodes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="233-business-processing-synchronization-process">2.3.3 Business Processing Synchronization Process<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#233-business-processing-synchronization-process" class="hash-link" aria-label="Direct link to 2.3.3 Business Processing Synchronization Process" title="Direct link to 2.3.3 Business Processing Synchronization Process">​</a></h3>
<p><img decoding="async" loading="lazy" alt="flow" src="https://seata.apache.org/assets/images/Dingtalk_20230106230931-89b853c79183f50afd746c4a662df1e7.jpg" width="1228" height="566" class="img_ev3q">
For the case where the client side is obtaining the latest metadata while a business thread is executing operations such as begin, commit, or registry, Seata adopts the following handling:</p>
<ul>
<li>
<p>On the client side:</p>
<ul>
<li>If the client is executing operations like begin, commit, or registry, and at this moment, it needs to obtain the latest metadata, the RPC request from the client might fail since the leader may no longer exist or is not the current leader.</li>
<li>If the request fails, the client receives an exception response, and in this case, the client needs to roll back based on the request result.</li>
</ul>
</li>
<li>
<p>TC side for detecting the old leader:</p>
<ul>
<li>On the TC side, if the client's request reaches the old leader node, TC checks if it is the current leader. If it is not the leader, it rejects the request.</li>
<li>If it is the leader but fails midway, such as failing during the process of submitting a task to the state machine, the creation of the task (createTask) fails due to the current state not being the leader. In this case, the client also receives a response with an exception.</li>
<li>The old leader's task submission also fails, ensuring the consistency of transaction information.</li>
</ul>
</li>
</ul>
<p>Through the above handling, when the client obtains the latest metadata while a business operation is in progress, Seata ensures data consistency and transaction correctness. If the client's RPC request fails, it triggers a rollback operation. On the TC side, detection of the old leader and the failure of task submission prevent inconsistencies in transaction information. This way, the client's data can also maintain consistency.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-usage-and-deployment">3. Usage and Deployment<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#3-usage-and-deployment" class="hash-link" aria-label="Direct link to 3. Usage and Deployment" title="Direct link to 3. Usage and Deployment">​</a></h2>
<p>In terms of usage and deployment, the community adheres to the principles of minimal intrusion and minimal changes. Therefore, the overall deployment should be straightforward. The following sections introduce deployment changes separately for the client and server sides.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-client">3.1 Client<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#31-client" class="hash-link" aria-label="Direct link to 3.1 Client" title="Direct link to 3.1 Client">​</a></h3>
<p>Firstly, those familiar with the use of registry configuration centers should be aware of the <code>seata.registry.type</code> configuration item in Seata's configuration, supporting options like Nacos, ZooKeeper, etcd, Redis, etc. After version 2.0, a configuration item for Raft was added.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      raft:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         server-addr: 192.168.0.111:7091, 192.168.0.112:7091, 192.168.0.113:7091</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Switch the <code>registry.type</code> to 'raft' and configure the address for obtaining Raft-related metadata, which is unified as the IP of the seata-server + HTTP port. Then, it is essential to configure the traditional transaction group.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">seata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   tx-service-group: default_tx_group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vgroup-mapping:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         default_tx_group: default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the current transaction group used is <code>default_tx_group</code>, then the corresponding Seata cluster/group is 'default'. There is a corresponding relationship, and this will be further explained in the server deployment section.
With this, the changes on the client side are complete.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-server">3.2 Server<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#32-server" class="hash-link" aria-label="Direct link to 3.2 Server" title="Direct link to 3.2 Server">​</a></h3>
<p>For server-side changes, there might be more adjustments, involving familiarity with some tuning parameters and configurations. Of course, default values can be used without any modifications.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">seata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    raft:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      group: default # This value represents the group of this raft cluster, and the value corresponding to the client's transaction group should match it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      server-addr: 192.168.0.111:9091,192.168.0.112:9091,192.168.0.113:9091 # IP and port of the 3 nodes, the port is the netty port of the node + 1000, default netty port is 8091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      snapshot-interval: 600 # Take a snapshot every 600 seconds for fast rolling of raftlog. However, making a snapshot every 600 seconds may cause business response time jitter if there is too much transaction data in memory. But it is friendly for fault recovery and faster node restart. You can adjust it to 30 minutes, 1 hour, etc., according to the business. You can test whether there is jitter on your own, and find a balance point between rt jitter and fault recovery.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      apply-batch: 32 # At most, submit raftlog once for 32 batches of actions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-append-bufferSize: 262144 # Maximum size of the log storage buffer, default is 256K</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-replicator-inflight-msgs: 256 # In the case of enabling pipeline requests, the maximum number of in-flight requests, default is 256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disruptor-buffer-size: 16384 # Internal disruptor buffer size. If it is a scenario with high write throughput, you need to appropriately increase this value. Default is 16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      election-timeout-ms: 1000 # How long without a leader's heartbeat to start a new election</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reporter-enabled: false # Whether the monitoring of raft itself is enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reporter-initial-delay: 60 # Interval of monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serialization: jackson # Serialization method, do not change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      compressor: none # Compression method for raftlog, such as gzip, zstd, etc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sync: true # Flushing method for raft log, default is synchronous flushing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: nacos, consul, apollo, zk, etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: file # This configuration can choose different configuration centers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: nacos, eureka, redis, zk, consul, etcd3, sofa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: file # Non-file registration center is not allowed in raft mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  store:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: file, db, redis, raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode: raft # Use raft storage mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dir: sessionStore # This path is the storage location of raftlog and related transaction logs, default is relative path, it is better to set a fixed location</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In 3 or more nodes of seata-server, after configuring the above parameters, you can directly start it, and you will see similar log output, which means the cluster has started successfully:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.392  WARN --- [Rpc-netty-server-worker-10-thread-1] [com.alipay.sofa.jraft.rpc.impl.BoltRaftRpcFactory] [ensurePipeline] []: JRaft SET bolt.rpc.dispatch-msg-list-in-default-executor to be false for replicator pipeline optimistic.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.439  INFO --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage] [save] []: Save raft meta, path=sessionStore/raft/9091/default/raft_meta, term=4, votedFor=0.0.0.0:0, cost time=25 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.441  WARN --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.core.NodeImpl] [handleAppendEntriesRequest] []: Node &lt;default/10.58.16.231:9091&gt; reject term_unmatched AppendEntriesRequest from 10.58.12.217:9091, term=4, prevLogIndex=4, prevLogTerm=4, localPrevLogTerm=0, lastLogIndex=0, entriesSize=0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.442  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onStartFollowing] []: groupId: default, onStartFollowing: LeaderChangeContext [leaderId=10.58.12.217:9091, term=4, status=Status[ENEWLEADER&lt;10011&gt;: Raft node receives message from new leader with higher term.]].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.449  WARN --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.core.NodeImpl] [handleAppendEntriesRequest] []: Node &lt;default/10.58.16.231:9091&gt; reject term_unmatched AppendEntriesRequest from 10.58.12.217:9091, term=4, prevLogIndex=4, prevLogTerm=4, localPrevLogTerm=0, lastLogIndex=0, entriesSize=0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.459  INFO --- [Bolt-default-executor-4-thread-1] [com.alipay.sofa.jraft.core.NodeImpl] [handleInstallSnapshot] []: Node &lt;default/10.58.16.231:9091&gt; received InstallSnapshotRequest from 10.58.12.217:9091, lastIncludedLogIndex=4, lastIncludedLogTerm=4, lastLogId=LogId [index=0, term=0].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.489  INFO --- [Bolt-conn-event-executor-13-thread-1] [com.alipay.sofa.jraft.rpc.impl.core.ClientServiceConnectionEventProcessor] [onEvent] []: Peer 10.58.12.217:9091 is connected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.519  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.util.Recyclers] [&lt;clinit&gt;] []: -Djraft.recyclers.maxCapacityPerThread: 4096.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.574  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.storage.snapshot.local.LocalSnapshotStorage] [destroySnapshot] []: Deleting snapshot sessionStore/raft/9091/default/snapshot/snapshot_4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.574  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.storage.snapshot.local.LocalSnapshotStorage] [close] []: Renaming sessionStore/raft/9091/default/snapshot/temp to sessionStore/raft/9091/default/snapshot/snapshot_4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.689  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.snapshot.session.SessionSnapshotFile] [load] []: on snapshot load start index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.snapshot.session.SessionSnapshotFile] [load] []: on snapshot load end index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onSnapshotLoad] []: groupId: default, onSnapshotLoad cost: 110 ms.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onConfigurationCommitted] []: groupId: default, onConfigurationCommitted: 10.58.12.165:9091,10.58.12.217:9091,10.58.16.231:9091.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.705  INFO --- [JRaft-FSMCaller-Disruptor-0] [com.alipay.sofa.jraft.storage.snapshot.SnapshotExecutorImpl] [onSnapshotLoadDone] []: Node &lt;default/10.58.16.231:9091&gt; onSnapshotLoadDone, last_included_index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">last_included_term: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: "10.58.12.165:9091"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: "10.58.12.217:9091"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: "10.58.16.231:9091"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.722  INFO --- [JRaft-Group-Default-Executor-1] [com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage] [lambda$truncatePrefixInBackground$2] []: Truncated prefix logs in data path: sessionStore/raft/9091/default/log from log index 1 to 5, cost 0 ms.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-faq">3.3 faq<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#33-faq" class="hash-link" aria-label="Direct link to 3.3 faq" title="Direct link to 3.3 faq">​</a></h3>
<ul>
<li>
<p>Once the <code>seata.raft.server-addr</code> is configured, cluster scaling or shrinking must be done through the server's openapi. Directly changing this configuration and restarting won't take effect. The API for this operation is <code>/metadata/v1/changeCluster?raftClusterStr=new_cluster_list</code>.</p>
</li>
<li>
<p>If the addresses in <code>server-addr:</code> are all on the local machine, you need to add a 1000 offset to the netty ports of different servers on the local machine. For example, if <code>server.port: 7092</code>, the netty port will be 8092, and the raft election and communication port will be 9092. You need to add the startup parameter <code>-Dserver.raftPort=9092</code>. On Linux, this can be specified using <code>export JAVA_OPT="-Dserver.raftPort=9092"</code>.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-performance-test-comparison">4. Performance Test Comparison<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#4-performance-test-comparison" class="hash-link" aria-label="Direct link to 4. Performance Test Comparison" title="Direct link to 4. Performance Test Comparison">​</a></h2>
<p>Performance testing is divided into two scenarios. To avoid data hotspots and thread optimization, the client side initializes 3 million items and uses jdk21 virtual threads + Spring Boot3 + Seata AT for testing. Garbage collection is handled with the ZGC generational garbage collector. The testing tool used is Alibaba Cloud PTS. Server-side is uniformly configured with jdk21 (not yet adapted for virtual threads). Server configurations are as follows:</p>
<ul>
<li>
<p>TC: 4c8g * 3</p>
</li>
<li>
<p>Client: 4c * 8G * 1</p>
</li>
<li>
<p>Database: Alibaba Cloud RDS 4c16g</p>
</li>
<li>
<p>64 concurrent performance test only increases the performance of the <code>@GlobalTransactional</code> annotated interface with empty submissions.</p>
</li>
<li>
<p>Random 3 million data items are used for inventory deduction in a 32 concurrent scenario for 10 minutes.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-171-db-mode">4.1 1.7.1 db mode<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#41-171-db-mode" class="hash-link" aria-label="Direct link to 4.1 1.7.1 db mode" title="Direct link to 4.1 1.7.1 db mode">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN011dNh3H1UK8G5prQAg_!!6000000002498-0-tps-731-333.jpg" alt="raft pressure test model" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="empty-submission-64c">Empty submission 64C<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#empty-submission-64c" class="hash-link" aria-label="Direct link to Empty submission 64C" title="Direct link to Empty submission 64C">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01pE1Anf1nRtgcnlx9t_!!6000000005087-0-tps-622-852.jpg" alt="db64-2" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="random-inventory-deduction-32c">Random inventory deduction 32C<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#random-inventory-deduction-32c" class="hash-link" aria-label="Direct link to Random inventory deduction 32C" title="Direct link to Random inventory deduction 32C">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN016hZkJC20OJax9ce31_!!6000000006839-0-tps-624-852.jpg" alt="db32-2" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-20-raft-mode">4.2 2.0 raft mode<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#42-20-raft-mode" class="hash-link" aria-label="Direct link to 4.2 2.0 raft mode" title="Direct link to 4.2 2.0 raft mode">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01nNL6oe1X95YcQQEjs_!!6000000002880-0-tps-773-353.jpg" alt="raft pressure test model" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="empty-submission-64c-1">Empty submission 64C<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#empty-submission-64c-1" class="hash-link" aria-label="Direct link to Empty submission 64C" title="Direct link to Empty submission 64C">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01rs1ykr1dhnH8qnXj3_!!6000000003768-0-tps-631-851.jpg" alt="raft64-2" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="random-inventory-deduction-32c-1">Random inventory deduction 32C<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#random-inventory-deduction-32c-1" class="hash-link" aria-label="Direct link to Random inventory deduction 32C" title="Direct link to Random inventory deduction 32C">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN015OwA2k20enquV7Yfu_!!6000000006875-0-tps-624-856.jpg" alt="raft32c-2" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-test-result-comparison">4.3 Test Result Comparison<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#43-test-result-comparison" class="hash-link" aria-label="Direct link to 4.3 Test Result Comparison" title="Direct link to 4.3 Test Result Comparison">​</a></h3>
<p>32 concurrent random inventory deduction scenario with 3 million items</p>
<table><thead><tr><th>tps avg</th><th>tps max</th><th>count</th><th>rt</th><th>error</th><th>Storage Type</th></tr></thead><tbody><tr><td>1709 (42%↑)</td><td>2019 (21%↑)</td><td>1228803 (42%↑)</td><td>13.86ms (30%↓)</td><td>0</td><td>Raft</td></tr><tr><td>1201</td><td>1668</td><td>864105</td><td>19.86ms</td><td>0</td><td>DB</td></tr></tbody></table>
<p>64 concurrent empty pressure on <code>@GlobalTransactional</code> interface (test peak limit is 8000)</p>
<table><thead><tr><th>tps avg</th><th>tps max</th><th>count</th><th>rt</th><th>error</th><th>Storage Type</th></tr></thead><tbody><tr><td>5704 (20%↑)</td><td>8062 (30%↑)</td><td>4101236 (20%↑)</td><td>7.79ms (19%↓)</td><td>0</td><td>Raft</td></tr><tr><td>4743</td><td>6172</td><td>3410240</td><td>9.65ms</td><td>0</td><td>DB</td></tr></tbody></table>
<p>In addition to the direct comparison of the above data, by observing the curves of the pressure test, it can be seen that under the raft mode, TPS and RT are more stable, with less jitter, and better performance and throughput.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-summary">5. Summary<a href="https://seata.apache.org/blog/seata-raft-detailed-explanation#5-summary" class="hash-link" aria-label="Direct link to 5. Summary" title="Direct link to 5. Summary">​</a></h2>
<p>In the future development of Seata, performance, entry threshold, and deployment and operation costs are directions that we need to pay attention to and continuously optimize. After the introduction of the raft mode, Seata has the following characteristics:</p>
<ol>
<li>In terms of storage, after the separation of storage and computation, Seata's upper limit for optimization has been raised, making it more self-controlled.</li>
<li>Lower deployment costs, no need for additional registration centers, storage middleware.</li>
<li>Lower entry threshold, no need to learn other knowledge such as registration centers; one can directly use Seata Raft.</li>
</ol>
<p>In response to industry trends, some open-source projects such as ClickHouse and Kafka have started to abandon the use of ZooKeeper and instead adopt self-developed solutions, such as ClickKeeper and KRaft. These solutions ensure the storage of metadata and other information by themselves, reducing the need for third-party dependencies, thus reducing operational and learning costs. These features are mature and worth learning from.</p>
<p>Of course, currently, solutions based on the Raft mode may not be mature enough and may not fully meet the beautiful descriptions above. However, precisely because of such theoretical foundations, the community should strive in this direction, gradually bringing practice closer to the theoretical requirements. Here, all students interested in Seata are welcome to join the community, contributing to the development of Seata!</p>]]></content>
        <author>
            <name>funkye</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata:Bridging Data and Applications]]></title>
        <id>https://seata.apache.org/blog/seata-connect-data-and-application</id>
        <link href="https://seata.apache.org/blog/seata-connect-data-and-application"/>
        <updated>2023-06-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article introduces the past, present, and future evolution of Seata.]]></summary>
        <content type="html"><![CDATA[<p>This article mainly introduces the evolutionary journey of distributed transactions from internal development to commercialization and open source, as well as the current progress and future planning of the Seata community.
Seata is an open-source distributed transaction solution designed to provide a comprehensive solution for distributed transactions under modern microservices architecture. Seata offers complete distributed transaction solutions, including AT, TCC, Saga, and XA transaction modes, supporting various programming languages and data storage schemes. Seata also provides easy-to-use APIs, extensive documentation, and examples to facilitate quick development and deployment for enterprises applying Seata.
<strong>Seata's advantages lie in its high availability, high performance, and high scalability, and it does not require extra complex operations for horizontal scaling.</strong> Seata is currently used in thousands of customer business systems on Alibaba Cloud, and its reliability has been recognized and applied by major industry manufacturers.
As an open-source project, the Seata community is also expanding continuously, becoming an important platform for developers to exchange, share, and learn, attracting more and more attention and support from enterprises.
Today, I will primarily share about Seata on the following three topics:</p>
<ul>
<li><strong>From TXC/GTS to Seata</strong></li>
<li><strong>Latest developments in the Seata community</strong></li>
<li><strong>Future planning for the Seata community</strong>
<br>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="from-txcgts-to-seata">From TXC/GTS to Seata<a href="https://seata.apache.org/blog/seata-connect-data-and-application#from-txcgts-to-seata" class="hash-link" aria-label="Direct link to From TXC/GTS to Seata" title="Direct link to From TXC/GTS to Seata">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-origin-of-distributed-transactions">The Origin of Distributed Transactions<a href="https://seata.apache.org/blog/seata-connect-data-and-application#the-origin-of-distributed-transactions" class="hash-link" aria-label="Direct link to The Origin of Distributed Transactions" title="Direct link to The Origin of Distributed Transactions">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Product Matrix" src="https://seata.apache.org/assets/images/%E4%BA%A7%E5%93%81%E7%9F%A9%E9%98%B5-911645846cd62c27fb3e2aaef802b52e.jpg" width="1468" height="1316" class="img_ev3q">
Seata is internally codenamed TXC (taobao transaction constructor) within Alibaba, a name with a strong organizational structure flavor. TXC originated from Alibaba's Wushi (Five Color Stones) project, which in ancient mythology were the stones used by the goddess Nüwa to mend the heavens, symbolizing Alibaba's important milestone in the evolution from monolithic architecture to distributed architecture. During this project, a batch of epoch-making Internet middleware was developed, including the well-known "Big Three":</p>
<ul>
<li><strong>HSF service invocation framework</strong>
Solves service communication issues after the transition from monolithic applications to service-oriented architectures.</li>
<li><strong>TDDL database sharding framework</strong>
Addresses storage capacity and connection count issues of databases at scale.</li>
<li><strong>MetaQ messaging framework</strong>
Addresses asynchronous invocation issues.
The birth of the Big Three satisfied the basic requirements of microservices-based business development, but the data consistency issues that arose after microservices were not properly addressed, lacking a unified solution. The likelihood of data consistency issues in microservices is much higher than in monolithic applications, and the increased complexity of moving from in-process calls to network calls exacerbates the production of exceptional scenarios. The increase in service hops also makes it impossible for upstream and downstream services to coordinate data rollback in the event of a business processing exception. TXC was born to address the pain points of data consistency at the application architecture layer, and the core data consistency scenarios it aimed to address included:</li>
<li><strong>Consistency across services.</strong> Coordinates rollback of upstream and downstream service nodes in the event of system exceptions such as call timeouts and business exceptions.</li>
<li><strong>Data consistency in database sharding.</strong> Ensures internal transactions during logical SQL operations on business layers are consistent across different data shards.</li>
<li><strong>Data consistency in message sending.</strong> Addresses the inconsistency between data operations and successful message sending.
To overcome the common scenarios encountered, TXC was seamlessly integrated with the Big Three. When businesses use the Big Three for development, they are completely unaware of TXC's presence in the background, do not have to consider the design of data consistency, and leave it to the framework to ensure, allowing businesses to focus more on their own development, greatly improving development efficiency.<!-- -->
<br>
<img decoding="async" loading="lazy" alt="GTS Architecture" src="https://seata.apache.org/assets/images/GTS%E6%9E%B6%E6%9E%84-f19f670582426aaac8da0f69c1d7ae35.jpg" width="1482" height="1294" class="img_ev3q">
TXC has been widely used within Alibaba Group for many years and has been baptized by the surging traffic of large-scale events like Singles' Day, significantly improving business development efficiency and ensuring data accuracy, eliminating financial and reputational issues caused by data inconsistencies. With the continuous evolution of the architecture, <strong>a standard three-node cluster can now handle peak values of nearly 100K TPS and millisecond-level transaction processing. In terms of availability and performance, it has reached a four-nines SLA guarantee, ensuring no failures throughout the year even in unattended conditions.</strong>
<br>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-evolution-of-distributed-transactions">The Evolution of Distributed Transactions<a href="https://seata.apache.org/blog/seata-connect-data-and-application#the-evolution-of-distributed-transactions" class="hash-link" aria-label="Direct link to The Evolution of Distributed Transactions" title="Direct link to The Evolution of Distributed Transactions">​</a></h4>
<p>The birth of new things is always accompanied by doubts. Is middleware capable of ensuring data consistency reliable? The initial birth of TXC was just a vague theory, lacking theoretical models and engineering practice. After we conducted MVP (Minimum Viable Product) model testing and promoted business deployment, we often encountered faults and frequently had to wake up in the middle of the night to deal with issues, wearing wristbands to sleep to cope with emergency responses. These were the most painful years I went through technically after taking over the team.
<img decoding="async" loading="lazy" alt="Evolution of Distributed Transactions" src="https://seata.apache.org/assets/images/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%BC%94%E8%BF%9B-cd118286fd5a0add7ecf5775e381a1f5.jpg" width="1488" height="702" class="img_ev3q">
Subsequently, we had extensive discussions and systematic reviews. We first needed to define the consistency problem. Were we to achieve majority consensus consistency like RAFT, solve database consistency issues like Google Spanner, or something else? Looking at the top-down layered structure from the application node, it mainly includes development frameworks, service invocation frameworks, data middleware, database drivers, and databases. We had to decide at which layer to solve the data consistency problem. We compared the consistency requirements, universality, implementation complexity, and business integration costs faced when solving data consistency issues at different levels. In the end, we weighed the pros and cons, decided to keep the implementation complexity to ourselves, and adopted the AT mode initially as a consistency component. We needed to ensure high consistency, but not be locked into specific database implementations, ensuring the generality of scenarios and the business integration costs were low enough to be easily implemented. This is also why TXC initially adopted the AT mode.
<strong>A distributed transaction is not just a framework; it's a system.</strong> We defined the consistency problem in theory, abstractly conceptualized modes, roles, actions, and isolation, etc. From an engineering practice perspective, we defined the programming model, including low-intrusion annotations, simple method templates, and flexible APIs, and defined basic and enhanced transaction capabilities (e.g., how to support a large number of activities at low cost), as well as capabilities in operations, security, performance, observability, and high availability.
<img decoding="async" loading="lazy" alt="Transaction Logical Model" src="https://seata.apache.org/assets/images/%E4%BA%8B%E5%8A%A1%E9%80%BB%E8%BE%91%E6%A8%A1%E5%9E%8B-bd13bfb9738e5aca63823d268e543280.jpg" width="1482" height="656" class="img_ev3q">
What problems do distributed transactions solve? A classic and tangible example is the money transfer scenario. The transfer process includes subtracting balance and adding balance, how do we ensure the atomicity of the operation? Without any intervention, these two steps may encounter various problems, such as account B being canceled or service call timeouts, etc.
<strong>Timeout issues have always been a difficult problem to solve in distributed applications</strong>; we cannot accurately know whether service B has executed and in what order. From a data perspective, this means the money in account B may not be successfully added. After the service-oriented transformation, each node only has partial information, while the transaction itself requires global coordination of all nodes, thus requiring a centralized role with a god's-eye view, capable of obtaining all information, which is the <strong>TC (transaction coordinator)</strong>, used to globally coordinate the transaction state. The <strong>TM (Transaction Manager)</strong> is the role that drives the generation of transaction proposals. However, even gods nod off, and their judgments are not always correct, so we need an <strong>RM (resource manager)</strong> role to verify the authenticity of the transaction as a representative of the soul. This is TXC's most basic philosophical model. We have methodologically verified that its data consistency is very complete, of course, our cognition is bounded. Perhaps the future will prove we were turkey engineers, but under current circumstances, its model is already sufficient to solve most existing problems.
<img decoding="async" loading="lazy" alt="Distributed Transaction Performance" src="https://seata.apache.org/assets/images/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%80%A7%E8%83%BD-379ce638304757417a8ed74fe07fc69c.jpg" width="1494" height="674" class="img_ev3q">
<strong>After years of architectural evolution, from the perspective of transaction single-link latency, TXC takes an average of about 0.2 milliseconds to process at the start of the transaction and about 0.4 milliseconds for branch registration, with the entire transaction's additional latency within the millisecond range. This is also the theoretical limit value we have calculated. In terms of throughput, the TPS of a single node reaches 30,000 times/second, and the TPS of a standard cluster is close to 100,000 times/second.</strong></p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-open-source">Seata Open Source<a href="https://seata.apache.org/blog/seata-connect-data-and-application#seata-open-source" class="hash-link" aria-label="Direct link to Seata Open Source" title="Direct link to Seata Open Source">​</a></h4>
<p>Why go open source? This is a question many people have asked me. In 2017, we commercialized the GTS (Global Transaction Service) product sold on Alibaba Cloud, with both public and private cloud forms. At this time, the internal group developed smoothly, but we encountered various problems in the process of commercialization. The problems can be summed up in two main categories: <strong>First, developers are quite lacking in the theory of distributed transactions,</strong> most people do not even understand what local transactions are, let alone distributed transactions. <strong>Second, there are problems with product maturity,</strong> often encountering various strange scenario issues, leading to a sharp rise in support and delivery costs, and R&amp;D turning into after-sales customer service.
We reflected on why we encountered so many problems. The main issue here is that Alibaba Group internally has a unified language stack and unified technology stack, and our polishing of specific scenarios is very mature. Serving Alibaba, one company, and serving thousands of enterprises on the cloud is fundamentally different, which also made us realize that our product's scenario ecology was not well developed. On GitHub, more than 80% of open-source software is basic software, and basic software primarily solves the problem of scenario universality, so it cannot be locked in by a single enterprise, like Linux, which has a large number of community distributions. Therefore, in order to make our product better, we chose to open source and co-build with developers to popularize more enterprise users.
<img decoding="async" loading="lazy" alt="Alibaba Open Source" src="https://seata.apache.org/assets/images/%E9%98%BF%E9%87%8C%E5%BC%80%E6%BA%90-b55a3c66abd52e6502162a991c8e92c3.jpg" width="1484" height="696" class="img_ev3q">
Alibaba's open-source journey has gone through three main stages. <strong>The first stage is the stage where Dubbo is located, where developers contribute out of love,</strong> Dubbo has been open sourced for over 10 years, and time has fully proven that Dubbo is an excellent open-source software, and its microkernel plugin extensibility design is an important reference for me when I initially open sourced Seata. When designing software, we need to consider which is more important between extensibility and performance, whether we are doing a three-year design, a five-year design, or a ten-year design that meets business development. While solving the 0-1 service call problem, can we predict the governance problems after the 1-100 scale-up?
<strong>The second stage is the closed loop of open source and commercialization, where commercialization feeds back into the open-source community, promoting the development of the open-source community.</strong> I think cloud manufacturers are more likely to do open source well for the following reasons:</p>
<ul>
<li>First, the cloud is a scaled economy, which must be established on a stable and mature kernel foundation, packaging its product capabilities including high availability, maintenance-free, and elasticity on top of it. An unstable kernel will inevitably lead to excessive delivery and support costs, and high penetration of the R&amp;D team's support Q&amp;A will prevent large-scale replication, and high penetration rates will prevent rapid evolution and iteration of products.</li>
<li>Second, commercial products know business needs better. Our internal technical teams often YY requirements from a development perspective, and what they make is not used by anyone, and thus does not form a value conversion. The business requirements collected through commercialization are all real, so its open source kernel must also evolve in this direction. Failure to evolve in this direction will inevitably lead to architectural splits on both sides, increasing the team's maintenance costs.</li>
<li>Finally, the closed loop of open source and commercialization can promote better development of both parties. If the open-source kernel often has various problems, would you believe that its commercial product is good enough?
<strong>The third stage is systematization and standardization.</strong> First, systematization is the basis of open-source solutions. Alibaba's open-source projects are mostly born out of internal e-commerce scenario practices. For example, Higress is used to connect Ant Group's gateways; Nacos carries services with millions of instances and tens of millions of connections; Sentinel provides degradation and throttling capabilities for high availability during major promotions; and Seata ensures transaction data consistency. This set of systematized open-source solutions is designed based on the best practices of Alibaba's e-commerce ecosystem. Second, standardization is another important feature. Taking OpenSergo as an example, it is both a standard and an implementation. In the past few years, the number of domestic open-source projects has exploded. However, the capabilities of various open-source products vary greatly, and many compatibility issues arise when integrating with each other. Therefore, open-source projects like OpenSergo can define some standardized capabilities and interfaces and provide some implementations, which will greatly help the development of the entire open-source ecosystem.<!-- -->
<br>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="latest-developments-in-the-seata-community">Latest Developments in the Seata Community<a href="https://seata.apache.org/blog/seata-connect-data-and-application#latest-developments-in-the-seata-community" class="hash-link" aria-label="Direct link to Latest Developments in the Seata Community" title="Direct link to Latest Developments in the Seata Community">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-the-seata-community">Introduction to the Seata Community<a href="https://seata.apache.org/blog/seata-connect-data-and-application#introduction-to-the-seata-community" class="hash-link" aria-label="Direct link to Introduction to the Seata Community" title="Direct link to Introduction to the Seata Community">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Community Introduction" src="https://seata.apache.org/assets/images/%E7%A4%BE%E5%8C%BA%E7%AE%80%E4%BB%8B-f911410600da0ddea225d92d7a0e3e96.jpg" width="1484" height="686" class="img_ev3q">
<strong>At present, Seata has open-sourced 4 transaction modes, including AT, TCC, Saga, and XA, and is actively exploring other viable transaction solutions.</strong> Seata has integrated with more than 10 mainstream RPC frameworks and relational databases, and has integrated or been integrated relationships with more than 20 communities. In addition, we are also exploring languages other than Java in the multi-language system, such as Golang, PHP, Python, and JS.
Seata has been applied to business systems by thousands of customers. Seata applications have become more mature, with successful cooperation with the community in the financial business scenarios of CITIC Bank and Everbright Bank, and successfully adopted into core accounting systems. The landing of microservices systems in financial scenarios is very stringent, which also marks a new level of maturity for Seata's kernel.</p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-ecosystem-expansion">Seata Ecosystem Expansion<a href="https://seata.apache.org/blog/seata-connect-data-and-application#seata-ecosystem-expansion" class="hash-link" aria-label="Direct link to Seata Ecosystem Expansion" title="Direct link to Seata Ecosystem Expansion">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Ecosystem Expansion" src="https://seata.apache.org/assets/images/%E6%89%A9%E5%B1%95%E7%94%9F%E6%80%81-aceedf7095dbb328b9a75e08443ec1c1.jpg" width="1490" height="702" class="img_ev3q">
<strong>Seata adopts a microkernel and plugin architecture design, exposing rich extension points in APIs, registry configuration centers, storage modes, lock control, SQL parsers, load balancing, transport, protocol encoding and decoding, observability, and more.</strong> This allows businesses to easily perform flexible extensions and select technical components.</p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-application-cases">Seata Application Cases<a href="https://seata.apache.org/blog/seata-connect-data-and-application#seata-application-cases" class="hash-link" aria-label="Direct link to Seata Application Cases" title="Direct link to Seata Application Cases">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Application Cases" src="https://seata.apache.org/assets/images/%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B-be6fb71d8ac5031679b2b52a9f158f61.jpg" width="1268" height="1286" class="img_ev3q">
<strong>Case 1: China Aviation Information's Air Travel Project</strong>
The China Aviation Information Air Travel project introduced Seata in the 0.2 version to solve the data consistency problem of ticket and coupon business, greatly improving development efficiency, reducing asset losses caused by data inconsistency, and enhancing user interaction experience.
<strong>Case 2: Didi Chuxing's Two-Wheeler Business Unit</strong>
Didi Chuxing's Two-Wheeler Business Unit introduced Seata in version 0.6.1, solving the data consistency problem of business processes such as blue bicycles, electric vehicles, and assets, optimizing the user experience, and reducing asset loss.
<strong>Case 3: Meituan's Infrastructure</strong>
Meituan's infrastructure team developed the internal distributed transaction solution Swan based on the open-source Seata project, which is used to solve distributed transaction problems within Meituan's various businesses.
<strong>Case 4: Hema Town</strong>
Hema Town uses Seata to control the flower-stealing process in game interactions, significantly shortening the development cycle from 20 days to 5 days, effectively reducing development costs.</p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="evolution-of-seata-transaction-modes">Evolution of Seata Transaction Modes<a href="https://seata.apache.org/blog/seata-connect-data-and-application#evolution-of-seata-transaction-modes" class="hash-link" aria-label="Direct link to Evolution of Seata Transaction Modes" title="Direct link to Evolution of Seata Transaction Modes">​</a></h4>
<p><img decoding="async" loading="lazy" alt="Mode Evolution" src="https://seata.apache.org/assets/images/%E6%A8%A1%E5%BC%8F%E6%BC%94%E8%BF%9B-ec00bf742388aa93e4aa2624f5d6fbc1.jpg" width="1492" height="574" class="img_ev3q"></p>
<br>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="current-progress-of-seata">Current Progress of Seata<a href="https://seata.apache.org/blog/seata-connect-data-and-application#current-progress-of-seata" class="hash-link" aria-label="Direct link to Current Progress of Seata" title="Direct link to Current Progress of Seata">​</a></h4>
<ul>
<li>Support for Oracle and PostgreSQL multi-primary keys.</li>
<li>Support for Dubbo3.</li>
<li>Support for Spring Boot3.</li>
<li>Support for JDK 17.</li>
<li>Support for ARM64 images.</li>
<li>Support for multiple registration models.</li>
<li>Extended support for various SQL syntaxes.</li>
<li>Support for GraalVM Native Image.</li>
<li>Support for Redis lua storage mode.<!-- -->
<br>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-2x-development-planning">Seata 2.x Development Planning<a href="https://seata.apache.org/blog/seata-connect-data-and-application#seata-2x-development-planning" class="hash-link" aria-label="Direct link to Seata 2.x Development Planning" title="Direct link to Seata 2.x Development Planning">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Development Planning" src="https://seata.apache.org/assets/images/%E5%8F%91%EF%BF%BD%EF%BF%BD%E5%B1%95%E8%A7%84%E5%88%92-9b7132eb93fdaaa430a832be0142cebc.jpg" width="1476" height="678" class="img_ev3q">
Mainly includes the following aspects:</p>
<ul>
<li><strong>Storage/Protocol/Features</strong>
Explore storage and computing separation in Raft cluster mode; better experience, unify the current 4 transaction mode APIs; compatible with GTS protocol; support Saga annotations; support distributed lock control; support data perspective insight and governance.</li>
<li><strong>Ecosystem</strong>
Support more databases, more service frameworks, while exploring support for the domestic trust creation ecosystem; support the MQ ecosystem; further enhance APM support.</li>
<li><strong>Solutions</strong>
In addition to supporting microservices ecosystems, explore multi-cloud solutions; closer to cloud-native solutions; add security and traffic protection capabilities; achieve self-convergence of core components in the architecture.</li>
<li><strong>Multi-Language Ecosystem</strong>
Java is the most mature in the multi-language ecosystem, continue to improve other supported programming languages, while exploring Transaction Mesh solutions that are independent of languages.</li>
<li><strong>R&amp;D Efficiency/Experience</strong>
Improve test coverage, prioritize quality, compatibility, and stability; restructure the official website's documentation to improve the hit rate of document searches; simplify operations and deployment on the experience side, achieve one-click installation and metadata simplification; console supports transaction control and online analysis capabilities.</li>
</ul>
<p>In one sentence, the 2.x plan is summarized as: <strong>Bigger scenarios, bigger ecosystems, from usable to user-friendly.</strong></p>
<br>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contact-information-for-the-seata-community">Contact Information for the Seata Community<a href="https://seata.apache.org/blog/seata-connect-data-and-application#contact-information-for-the-seata-community" class="hash-link" aria-label="Direct link to Contact Information for the Seata Community" title="Direct link to Contact Information for the Seata Community">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Contact Information" src="https://seata.apache.org/assets/images/%E8%81%94%E7%B3%BB%E6%96%B9%E5%BC%8F-9883f643b19238bb617036df09d2731f.jpg" width="1158" height="356" class="img_ev3q"></p>]]></content>
        <author>
            <name>Ji Min - Founder of the Seata Open Source Community, Leader of the Distributed Transactions Team</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Observability Practices in Seata]]></title>
        <id>https://seata.apache.org/blog/seata-observable-practice</id>
        <link href="https://seata.apache.org/blog/seata-observable-practice"/>
        <updated>2023-06-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article explores and discusses Seata's practices in the field of observability.]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-seata">Introduction to Seata<a href="https://seata.apache.org/blog/seata-observable-practice#introduction-to-seata" class="hash-link" aria-label="Direct link to Introduction to Seata" title="Direct link to Introduction to Seata">​</a></h2>
<p>Seata is the predecessor of Alibaba Group's massively used middleware for ensuring consistency of distributed transactions, and Seata is its open source product, maintained by the community. Before introducing Seata, let's discuss with you some problematic scenarios that we often encounter in the course of our business development.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="business-scenarios">Business Scenarios<a href="https://seata.apache.org/blog/seata-observable-practice#business-scenarios" class="hash-link" aria-label="Direct link to Business Scenarios" title="Direct link to Business Scenarios">​</a></h3>
<p>Our business in the development process, basically from a simple application, and gradually transitioned to a huge scale, complex business applications. These complex scenarios inevitably encounter distributed transaction management problems, Seata's emergence is to solve these distributed scenarios of transaction management problems. Introduce a few of the classic scenarios:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="scenario-1-distributed-transactions-in-the-scenario-of-split-library-and-split-table">Scenario 1: distributed transactions in the scenario of split library and split table<a href="https://seata.apache.org/blog/seata-observable-practice#scenario-1-distributed-transactions-in-the-scenario-of-split-library-and-split-table" class="hash-link" aria-label="Direct link to Scenario 1: distributed transactions in the scenario of split library and split table" title="Direct link to Scenario 1: distributed transactions in the scenario of split library and split table">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-ee0eff8cf24e6e3e997b0b040c56690e.png" width="1200" height="624" class="img_ev3q">
Initially, our business was small and lightweight, and a single database was able to secure our data links. However, as the business scale continues to grow and the business continues to become more complex, usually a single database encounters bottlenecks in terms of capacity and performance. The usual solution is to evolve to a split-database, split-table architecture. At this point, that is, the introduction of **split library and split table scenario **distributed transaction scenarios.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="scenario-2-distributed-transactions-in-a-cross-service-scenario">Scenario 2: Distributed Transactions in a Cross-Service Scenario<a href="https://seata.apache.org/blog/seata-observable-practice#scenario-2-distributed-transactions-in-a-cross-service-scenario" class="hash-link" aria-label="Direct link to Scenario 2: Distributed Transactions in a Cross-Service Scenario" title="Direct link to Scenario 2: Distributed Transactions in a Cross-Service Scenario">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-%E8%B7%A8%E6%9C%8D%E5%8A%A1%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-ccc122e03531914d0945e82137912655.png" width="1200" height="647" class="img_ev3q">
A solution to reduce the complexity of a monolithic application: application microservice splitting. After splitting, our product consists of multiple microservice components with different functions, each of which uses independent database resources. When it comes to data consistency scenarios involving cross-service calls, distributed transactions are introduced <strong>in cross-service scenarios</strong>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-architecture">Seata architecture<a href="https://seata.apache.org/blog/seata-observable-practice#seata-architecture" class="hash-link" aria-label="Direct link to Seata architecture" title="Direct link to Seata architecture">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-Seata%E6%9E%B6%E6%9E%84-d45c1d1bf146b044c4f1b7f85ba3beb8.png" width="1534" height="908" class="img_ev3q">
Its core components are mainly as follows:</p>
<ul>
<li><strong>Transaction Coordinator (TC)</strong>.</li>
</ul>
<p>Transaction coordinator that maintains the running state of the global transaction and is responsible for coordinating and driving the commit or rollback of the global transaction.</p>
<ul>
<li><strong>Transaction Manager (TM)</strong></li>
</ul>
<p>Controls global transaction boundaries, responsible for opening a global transaction and ultimately initiating a global commit or global rollback resolution, TM defines the boundaries of a global transaction.</p>
<ul>
<li><strong>Resource Manager (RM)</strong></li>
</ul>
<p>Controls branch transactions and is responsible for branch registration, status reporting, and receiving commands from the Transaction Coordinator to drive the commit and rollback of branch (local) transactions.RM is responsible for defining the boundaries and behaviour of branch transactions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="seatas-observable-practices">Seata's observable practices<a href="https://seata.apache.org/blog/seata-observable-practice#seatas-observable-practices" class="hash-link" aria-label="Direct link to Seata's observable practices" title="Direct link to Seata's observable practices">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-do-we-need-observables">Why do we need observables?<a href="https://seata.apache.org/blog/seata-observable-practice#why-do-we-need-observables" class="hash-link" aria-label="Direct link to Why do we need observables?" title="Direct link to Why do we need observables?">​</a></h3>
<ul>
<li>*# Distributed transaction message links are more complex *#</li>
</ul>
<p>Seata, while solving these problems of user ease of use and distributed transaction consistency, requires multiple interactions between TC and TM, RM, especially when the links of microservices become complex, the interaction links of Seata will also increase in positive correlation. In this case, we actually need to introduce observable capabilities to observe and analyse things links.</p>
<ul>
<li><strong>Anomalous links, hard to locate for troubleshooting, no way to optimise performance</strong>*</li>
</ul>
<p>When troubleshooting Seata's abnormal transaction links, the traditional approach requires looking at logs, which is troublesome to retrieve. With the introduction of observable capabilities, it helps us to visually analyse links and quickly locate problems; providing a basis for optimising time-consuming transaction links.</p>
<ul>
<li><strong>Visualisation, Data Quantification</strong></li>
</ul>
<p>The visualisation capability allows users to have an intuitive feeling of transaction execution; with quantifiable data, it helps users to assess resource consumption and plan budgets.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview-of-observable-capabilities">Overview of observable capabilities<a href="https://seata.apache.org/blog/seata-observable-practice#overview-of-observable-capabilities" class="hash-link" aria-label="Direct link to Overview of observable capabilities" title="Direct link to Overview of observable capabilities">​</a></h3>
<table><thead><tr><th><strong>observable dimensions</strong></th><th><strong>seata desired capabilities</strong></th><th><strong>technology selection reference</strong></th></tr></thead><tbody><tr><td>Metrics</td><td>Functional dimensions: can be grouped and isolated by business, capture important metrics such as total number of transactions, elapsed time and so on.</td><td></td></tr><tr><td>Performance level: high volume performance, plug-ins loaded on-demand.</td><td></td><td></td></tr><tr><td>Architecture: Reduce third-party dependency, server-side and client-side can adopt a unified architecture to reduce technical complexity.</td><td></td><td></td></tr><tr><td>Compatibility level: at least compatible with Prometheus ecosystem</td><td>Prometheus: industry-leading position in the field of metrics storage and query.</td><td></td></tr><tr><td>OpenTelemetry: the de facto standard for observable data collection and specification. It does not store, display, or analyse the data itself</td><td>Tracing</td><td>Functionality level</td></tr><tr><td>Tracing</td><td>Functionality: Full-link tracing of distributed transaction lifecycle, reacting to distributed transaction execution performance consumption.</td><td></td></tr><tr><td>Ease of use: simple and easy to access for users using seata</td><td>SkyWalking: using Java's Agent probe technology, high efficiency, simple and easy to use.</td><td>Logging</td></tr><tr><td>Logging</td><td>Functionality: logging all lifecycle information of the server and the client</td><td></td></tr><tr><td>Ease of use: can quickly match global transactions to corresponding link logs based on XID</td><td>Alibaba Cloud Service</td><td></td></tr><tr><td>ELK</td><td>Alibaba Cloud Service</td><td></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-dimension">Metrics dimension<a href="https://seata.apache.org/blog/seata-observable-practice#metrics-dimension" class="hash-link" aria-label="Direct link to Metrics dimension" title="Direct link to Metrics dimension">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="design-ideas">Design Ideas<a href="https://seata.apache.org/blog/seata-observable-practice#design-ideas" class="hash-link" aria-label="Direct link to Design Ideas" title="Direct link to Design Ideas">​</a></h4>
<ol>
<li>Seata as an integrated data consistency framework, the Metrics module will use as few third-party dependencies as possible to reduce the risk of conflicts.</li>
<li>the Metrics module will strive for higher metrics performance and lower resource overhead to minimise the side effects of turning it on.</li>
<li>When configured, whether Metrics is activated and how the data is published depends on the corresponding configuration; if the configuration is turned on, Metrics is automatically activated and the metrics data will be published via prometheusexporter by default.</li>
<li>do not use Spring, use SPI (Service Provider Interface) to load extensions</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="module-design">module design<a href="https://seata.apache.org/blog/seata-observable-practice#module-design" class="hash-link" aria-label="Direct link to module design" title="Direct link to module design">​</a></h4>
<p><img decoding="async" loading="lazy" alt="图片 1.png" src="https://seata.apache.org/assets/images/metrics-%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1-44acf0482c9b8fbb5f6ec11a1423440c.png" width="1296" height="746" class="img_ev3q"></p>
<ul>
<li>seata-metrics-core: Metrics core module, organises (loads) 1 Registry and N Exporters according to configuration;</li>
<li>seata-metrics-api: defines the Meter metrics interface, the Registry metrics registry interface;</li>
<li>seata-metrics-exporter-prometheus: built-in implementation of prometheus-exporter;</li>
<li>seata-metrics-registry-compact: built-in Registry implementation and lightweight implementation of Gauge, Counter, Summay, Timer metrics;</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-module-workflow">metrics module workflow<a href="https://seata.apache.org/blog/seata-observable-practice#metrics-module-workflow" class="hash-link" aria-label="Direct link to metrics module workflow" title="Direct link to metrics module workflow">​</a></h4>
<p><img decoding="async" loading="lazy" alt="图片 1.png" src="https://seata.apache.org/assets/images/metrics-%E6%A8%A1%E5%9D%97%E5%B7%A5%E4%BD%9C%E6%B5%81-cf55ed8598aa42930fb5d0c58399463d.png" width="1534" height="964" class="img_ev3q">
The above figure shows the workflow of the metrics module, which works as follows:</p>
<ol>
<li>load Exporter and Registry implementation classes based on configuration using SPI mechanism;</li>
<li>based on the message subscription and notification mechanism, listen for state change events for all global transactions and publish to EventBus;</li>
<li>event subscribers consume events and write the generated metrics to Registry;</li>
<li>the monitoring system (e.g. prometheus) pulls data from the Exporter.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tc-core-metrics">TC Core Metrics<a href="https://seata.apache.org/blog/seata-observable-practice#tc-core-metrics" class="hash-link" aria-label="Direct link to TC Core Metrics" title="Direct link to TC Core Metrics">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-TC%E6%A0%B8%E5%BF%83%E6%8C%87%E6%A0%87-7de91006545ab3e5518b6889456a8302.png" width="1746" height="1072" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tm-core-metrics">TM Core Metrics<a href="https://seata.apache.org/blog/seata-observable-practice#tm-core-metrics" class="hash-link" aria-label="Direct link to TM Core Metrics" title="Direct link to TM Core Metrics">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-TM%E6%A0%B8%E5%BF%83%E6%8C%87%E6%A0%87-8ef5523801c632ae5af707ade30576b5.png" width="2308" height="1094" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rm-core-metrics">RM Core Metrics<a href="https://seata.apache.org/blog/seata-observable-practice#rm-core-metrics" class="hash-link" aria-label="Direct link to RM Core Metrics" title="Direct link to RM Core Metrics">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-RM%E6%A0%B8%E5%BF%83%E6%8C%87%E6%A0%87-30ac5fe4e5c6e0d0727a3d28bf94ec82.png" width="2122" height="1580" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="large-cap-showcase">Large Cap Showcase<a href="https://seata.apache.org/blog/seata-observable-practice#large-cap-showcase" class="hash-link" aria-label="Direct link to Large Cap Showcase" title="Direct link to Large Cap Showcase">​</a></h4>
<p><img decoding="async" loading="lazy" alt="lQLPJxZhZlqESU3NBpjNBp6w8zYK6VbMgzYCoKVrWEDWAA_1694_1688.png" src="https://seata.apache.org/assets/images/metrics-%E5%A4%A7%E7%9B%98%E5%B1%95%E7%A4%BA-1f6d2bdf7f5bc02f56244b361764ee7c.png" width="1694" height="1688" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tracing-dimensions">Tracing dimensions<a href="https://seata.apache.org/blog/seata-observable-practice#tracing-dimensions" class="hash-link" aria-label="Direct link to Tracing dimensions" title="Direct link to Tracing dimensions">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="why-does-seata-need-tracing">Why does Seata need tracing?<a href="https://seata.apache.org/blog/seata-observable-practice#why-does-seata-need-tracing" class="hash-link" aria-label="Direct link to Why does Seata need tracing?" title="Direct link to Why does Seata need tracing?">​</a></h4>
<ol>
<li>for the business side, how much of a drain on business performance will the introduction of Seata cause? Where is the main time consumption? How to optimise the business logic? These are all unknown.</li>
<li>All the message records of Seata are persisted through the log to fall the disc, but the log is very unfriendly to users who do not understand Seata. Can we improve the efficiency of transaction link scheduling by accessing Tracing?</li>
<li>for novice users, can through Tracing records, quickly understand the working principle of seata, reduce the threshold of seata use.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="seatas-tracing-solution">Seata's tracing solution<a href="https://seata.apache.org/blog/seata-observable-practice#seatas-tracing-solution" class="hash-link" aria-label="Direct link to Seata's tracing solution" title="Direct link to Seata's tracing solution">​</a></h4>
<ul>
<li>Seata defines Header information in a custom RPC message protocol;</li>
<li>SkyWalking intercepts the specified RPC message and injects tracing related span information;</li>
<li>The lifecycle scope of the span is defined with the RPC message sending &amp; receiving as the threshold.</li>
</ul>
<p>Based on the above approach, Seata implements transaction-wide tracing, please refer to <a href="https://seata.apache.org/docs/user/apm/skywalking/">Accessing Skywalking for [Seata application | Seata-server]</a> for specific access.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tracing-effects">tracing effects<a href="https://seata.apache.org/blog/seata-observable-practice#tracing-effects" class="hash-link" aria-label="Direct link to tracing effects" title="Direct link to tracing effects">​</a></h4>
<ul>
<li>Based on the demo scenario:</li>
</ul>
<ol>
<li>user requests transaction service</li>
<li>transaction service locks inventory</li>
<li>the transaction service creates a bill</li>
<li>The billing service performs a debit</li>
</ol>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-tracing%E6%95%88%E6%9E%9C-%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%9B%BE-92ed3a1bb1fc62135d8d02d1a21951fb.png" width="865" height="489" class="img_ev3q"></p>
<ul>
<li>Transaction link for GlobalCommit success (example)</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-tracing%E6%95%88%E6%9E%9C-tracing%E9%93%BE1-e4e8b13e4b0a74c76631560a66973d2a.png" width="1080" height="1788" class="img_ev3q">
<img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-tracing%E6%95%88%E6%9E%9C-tracing%E9%93%BE2-d5a816ec8b49b6ca95309eeda8470825.png" width="1080" height="2647" class="img_ev3q">
<img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-tracing%E6%95%88%E6%9E%9C-tracing%E9%93%BE3-c50deab1728f8e61946a26d7d1b49da8.png" width="1080" height="1466" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="logging-dimension">Logging dimension<a href="https://seata.apache.org/blog/seata-observable-practice#logging-dimension" class="hash-link" aria-label="Direct link to Logging dimension" title="Direct link to Logging dimension">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="design-ideas-1">Design Ideas<a href="https://seata.apache.org/blog/seata-observable-practice#design-ideas-1" class="hash-link" aria-label="Direct link to Design Ideas" title="Direct link to Design Ideas">​</a></h4>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-logging%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF-c90fe7b88cab305e7b3c918df2cba8b6.png" width="1434" height="454" class="img_ev3q">
Logging is the bottom of the observable dimensions. Placed at the bottom, in fact, is the design of our log format, only a good log format, we can make it a better collection, modular storage and display. On top of it, is the log collection, storage, monitoring, alarms, data visualisation, these modules are more ready-made tools, such as Ali's SLS logging service, and ELK's set of technology stack, we are more overhead costs, access complexity, ecological prosperity, etc. as a consideration.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="log-format-design">Log format design<a href="https://seata.apache.org/blog/seata-observable-practice#log-format-design" class="hash-link" aria-label="Direct link to Log format design" title="Direct link to Log format design">​</a></h4>
<p>Here we take a log format of Seata-Server as a case study:
<img decoding="async" loading="lazy" alt="image.png" src="https://seata.apache.org/assets/images/metrics-logging%E6%97%A5%E5%BF%97%E6%95%88%E6%9E%9C-049f409856a4895fe3d27d7930e028f8.png" width="1342" height="364" class="img_ev3q"></p>
<ul>
<li>Thread pool canonical naming: When there are more thread pools and threads, canonical thread naming can clearly show the execution order of the threads that are executed in an unordered way.</li>
<li>Traceability of method class names: Quickly locate specific code blocks.</li>
<li>Key Runtime Information Transparency: Focus on highlighting key logs and not printing non-critical logs to reduce log redundancy.</li>
<li>Extensible message format: Reduce the amount of code modification by extending the output format of the message class.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary--outlook">Summary &amp; Outlook<a href="https://seata.apache.org/blog/seata-observable-practice#summary--outlook" class="hash-link" aria-label="Direct link to Summary &amp; Outlook" title="Direct link to Summary &amp; Outlook">​</a></h2>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics">Metrics<a href="https://seata.apache.org/blog/seata-observable-practice#metrics" class="hash-link" aria-label="Direct link to Metrics" title="Direct link to Metrics">​</a></h4>
<p>Summary: basically achieve quantifiable and observable distributed transactions.
Prospect: more granular metrics, broader ecological compatibility.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tracing">Tracing<a href="https://seata.apache.org/blog/seata-observable-practice#tracing" class="hash-link" aria-label="Direct link to Tracing" title="Direct link to Tracing">​</a></h4>
<p>Summary: Traceability of the whole chain of distributed transactions.
Prospect: trace transaction links according to xid, and quickly locate the root cause of abnormal links.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="logging">Logging<a href="https://seata.apache.org/blog/seata-observable-practice#logging" class="hash-link" aria-label="Direct link to Logging" title="Direct link to Logging">​</a></h4>
<p>Summary: Structured log format.
Prospect: Evolution of log observable system.</p>]]></content>
        <author>
            <name>rong.liu-Seata</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[seata-go 1.2.0 Ready for Production Environment!!!]]></title>
        <id>https://seata.apache.org/blog/seata-go-1.2.0</id>
        <link href="https://seata.apache.org/blog/seata-go-1.2.0"/>
        <updated>2023-06-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[seata-go 1.2.0, ready for production environment!!!]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="production-ready-seata-go-120-is-here">Production-ready seata-go 1.2.0 is here!<a href="https://seata.apache.org/blog/seata-go-1.2.0#production-ready-seata-go-120-is-here" class="hash-link" aria-label="Direct link to Production-ready seata-go 1.2.0 is here!" title="Direct link to Production-ready seata-go 1.2.0 is here!">​</a></h2>
<p>Seata is an open source distributed transaction solution that provides high-performance and easy-to-use distributed transaction services.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="release-overview">Release overview<a href="https://seata.apache.org/blog/seata-go-1.2.0#release-overview" class="hash-link" aria-label="Direct link to Release overview" title="Direct link to Release overview">​</a></h3>
<p>Seata-go version 1.2.0 supports the XA schema, a distributed transaction processing specification proposed by the X/Open organisation, which has the advantage of being non-intrusive to business code. Currently, Seata-go's XA mode supports MySQL databases. So far, seata-go has gathered three transaction modes: AT, TCC and XA. Main features of XA mode.</p>
<ul>
<li>Supported XA data source proxy <a href="https://github.com/apache/incubator-seata-go-samples/tree/main/xa" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-go-samples/tree/main/xa</a></li>
<li>XA transaction mode is supported.
XA related sampes can be found in the following example: <a href="https://github.com/apache/incubator-seata-go-samples/tree/main/xa" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-go-samples/tree/main/xa</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature">feature<a href="https://seata.apache.org/blog/seata-go-1.2.0#feature" class="hash-link" aria-label="Direct link to feature" title="Direct link to feature">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/467" target="_blank" rel="noopener noreferrer">#467</a>] implements XA schema support for MySQL.</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/534" target="_blank" rel="noopener noreferrer">#534</a>] Load balancing for session support.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bugfix">bugfix<a href="https://seata.apache.org/blog/seata-go-1.2.0#bugfix" class="hash-link" aria-label="Direct link to bugfix" title="Direct link to bugfix">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/540" target="_blank" rel="noopener noreferrer">#540</a>] Fix a bug in initialising xa mode.</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/545" target="_blank" rel="noopener noreferrer">#545</a>] Fix a bug in getting db version number in xa mode.</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/548" target="_blank" rel="noopener noreferrer">#548</a>] Fix bug where starting xa fails.</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/556" target="_blank" rel="noopener noreferrer">#556</a>] Fix bug in xa datasource.</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/562" target="_blank" rel="noopener noreferrer">#562</a>] Fix bug with committing xa global transaction</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/564" target="_blank" rel="noopener noreferrer">#564</a>] Fix bug committing xa branching transactions</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/566" target="_blank" rel="noopener noreferrer">#566</a>] Fix bug with local transactions using xa data source.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimise">optimise<a href="https://seata.apache.org/blog/seata-go-1.2.0#optimise" class="hash-link" aria-label="Direct link to optimise" title="Direct link to optimise">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/523" target="_blank" rel="noopener noreferrer">#523</a>] Optimise CI process</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/525" target="_blank" rel="noopener noreferrer">#525</a>] rename jackson serialisation to json</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/532" target="_blank" rel="noopener noreferrer">#532</a>] Remove duplicate code</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/536" target="_blank" rel="noopener noreferrer">#536</a>] optimise go import code formatting</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/554" target="_blank" rel="noopener noreferrer">#554</a>] optimise xa mode performance</li>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/561" target="_blank" rel="noopener noreferrer">#561</a>] Optimise xa mode logging output</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="test">test<a href="https://seata.apache.org/blog/seata-go-1.2.0#test" class="hash-link" aria-label="Direct link to test" title="Direct link to test">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/535" target="_blank" rel="noopener noreferrer">#535</a>] Add integration tests.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="doc">doc<a href="https://seata.apache.org/blog/seata-go-1.2.0#doc" class="hash-link" aria-label="Direct link to doc" title="Direct link to doc">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata-go/pull/550" target="_blank" rel="noopener noreferrer">#550</a>] Added changelog for version 1.2.0.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="contributors">contributors<a href="https://seata.apache.org/blog/seata-go-1.2.0#contributors" class="hash-link" aria-label="Direct link to contributors" title="Direct link to contributors">​</a></h3>
<p>Thanks to these contributors for their code commits. Please report an unintended omission.</p>
<ul>
<li><a href="https://github.com/georgehao" target="_blank" rel="noopener noreferrer">georgehao</a></li>
<li><a href="https://github.com/luky116" target="_blank" rel="noopener noreferrer">luky116</a></li>
<li><a href="https://github.com/jasondeng1997" target="_blank" rel="noopener noreferrer">jasondeng1997</a></li>
<li><a href="https://github.com/106umao" target="_blank" rel="noopener noreferrer">106umao</a></li>
<li><a href="https://github.com/wang1309" target="_blank" rel="noopener noreferrer">wang1309</a></li>
<li><a href="https://github.com/iSuperCoder" target="_blank" rel="noopener noreferrer">iSuperCoder</a></li>
<li><a href="https://github.com/Charlie17Li" target="_blank" rel="noopener noreferrer">Charlie17Li</a></li>
<li><a href="https://github.com/Code-Fight" target="_blank" rel="noopener noreferrer">Code-Fight</a></li>
<li><a href="https://github.com/Kirhaku" target="_blank" rel="noopener noreferrer">Kirhaku</a></li>
<li><a href="https://github.com/VaderKai" target="_blank" rel="noopener noreferrer">Vaderkai</a></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="link">Link<a href="https://seata.apache.org/blog/seata-go-1.2.0#link" class="hash-link" aria-label="Direct link to Link" title="Direct link to Link">​</a></h4>
<ul>
<li><a href="https://github.com/apache/incubator-seata" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata</a></li>
<li><a href="https://github.com/apache/incubator-seata-go" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-go</a></li>
<li><a href="https://github.com/apache/incubator-seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-samples</a></li>
<li><a href="https://github.com/apache/incubator-seata-go-samples" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-go-samples</a></li>
<li><a href="https://seata.apache.org/" target="_blank" rel="noopener noreferrer">https://seata.apache.org</a></li>
</ul>]]></content>
        <author>
            <name>Seata Community</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[6 Major Topics Now Open for Selection | Welcome to Apply for Seata Open Source Summer]]></title>
        <id>https://seata.apache.org/blog/iscas2023</id>
        <link href="https://seata.apache.org/blog/iscas2023"/>
        <updated>2023-05-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Welcome everyone to register for Seata Open Source Summer 2023 topics]]></summary>
        <content type="html"><![CDATA[<h3 class="anchor anchorWithStickyNavbar_LWe7" id="welcome-everyone-to-register-for-seata-open-source-summer-2023-topics">Welcome everyone to register for Seata Open Source Summer 2023 topics<a href="https://seata.apache.org/blog/iscas2023#welcome-everyone-to-register-for-seata-open-source-summer-2023-topics" class="hash-link" aria-label="Direct link to Welcome everyone to register for Seata Open Source Summer 2023 topics" title="Direct link to Welcome everyone to register for Seata Open Source Summer 2023 topics">​</a></h3>
<p>The registration period for Open Source Summer 2023 runs from <strong>April 29th to June 4th</strong>, and we welcome registration for Seata 2023 topics! Here, you will have the opportunity to delve into the theory and application of distributed transactions, and collaborate with students from different backgrounds to complete practical projects. We look forward to your active participation and contribution, jointly promoting the development of the distributed transaction field.</p>
<p><img decoding="async" loading="lazy" alt="summer2023-1" src="https://seata.apache.org/assets/images/summer2023-1-354d728bacb1640f84811b82ac954a9d.jpg" width="1290" height="2796" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-open-source-summer-2023">Seata Open Source Summer 2023<a href="https://seata.apache.org/blog/iscas2023#seata-open-source-summer-2023" class="hash-link" aria-label="Direct link to Seata Open Source Summer 2023" title="Direct link to Seata Open Source Summer 2023">​</a></h3>
<p>Open Source Summer is a summer open source activity initiated and long-term supported by the Institute of Software, Chinese Academy of Sciences, as part of the "Open Source Software Supply Chain Lighting Program", aimed at encouraging students to actively participate in the development and maintenance of open source software, cultivating and discovering more outstanding developers, promoting the vigorous development of excellent open source software communities, and assisting in the construction of the open source software supply chain.</p>
<p>Participating students will collaborate remotely online with senior mentors to participate in the development of various organizational projects in the open source community and receive bonuses, gifts, and certificates. <strong>These gains are not only a highlight on future graduation resumes but also a brilliant starting point towards becoming top developers.</strong> Each project is divided into two difficulty levels: basic and advanced, with corresponding project completion bonuses of RMB 8,000 and RMB 12,000 before tax, respectively.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-the-seata-community">Introduction to the Seata Community<a href="https://seata.apache.org/blog/iscas2023#introduction-to-the-seata-community" class="hash-link" aria-label="Direct link to Introduction to the Seata Community" title="Direct link to Introduction to the Seata Community">​</a></h3>
<p><strong>Seata</strong> is an open-source distributed transaction solution, with over 23K+ stars on GitHub, dedicated to providing high-performance and easy-to-use distributed transaction services under the microservices architecture. Before being open-sourced, Seata played a role as a middleware for distributed data consistency within Alibaba, where almost every transaction needed to use Seata. After undergoing the baptism of Double 11's massive traffic, it provided strong technical support for business.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary-of-seata-community-open-source-summer-2023-project-topics">Summary of Seata Community Open Source Summer 2023 Project Topics<a href="https://seata.apache.org/blog/iscas2023#summary-of-seata-community-open-source-summer-2023-project-topics" class="hash-link" aria-label="Direct link to Summary of Seata Community Open Source Summer 2023 Project Topics" title="Direct link to Summary of Seata Community Open Source Summer 2023 Project Topics">​</a></h3>
<p>The Seata community recommends 6 selected project topics for the Open Source Summer 2023 organizing committee. You can visit the following link to make your selection:<br>
<a href="https://summer-ospp.ac.cn/org/orgdetail/064c15df-705c-483a-8fc8-02831370db14?lang=zh" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/orgdetail/064c15df-705c-483a-8fc8-02831370db14?lang=zh</a><br>
<!-- -->Please communicate promptly with the respective mentors and prepare project application materials, and register through the official channels (the following topics are not listed in any particular order):</p>
<p><img decoding="async" loading="lazy" alt="seata2023-2" src="https://seata.apache.org/assets/images/summer2023-2-cff41105a59822fdd5e8d88d84ad0e2a.png" width="706" height="271" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="project-one-implementation-of-namingserver-for-service-discovery-and-registration">Project One: Implementation of NamingServer for Service Discovery and Registration<a href="https://seata.apache.org/blog/iscas2023#project-one-implementation-of-namingserver-for-service-discovery-and-registration" class="hash-link" aria-label="Direct link to Project One: Implementation of NamingServer for Service Discovery and Registration" title="Direct link to Project One: Implementation of NamingServer for Service Discovery and Registration">​</a></h4>
<p><strong>Difficulty:</strong> Advanced</p>
<p><strong>Project Community Mentor:</strong> Chen Jianbin</p>
<p><strong>Mentor's Contact Email:</strong> <a href="mailto:364176773@qq.com" target="_blank" rel="noopener noreferrer">364176773@qq.com</a></p>
<p><strong>Project Description:</strong><br>
<!-- -->Currently, Seata's service exposure and discovery mainly rely on third-party registration centers. With the evolution and development of the project, it brings additional learning and usage costs. Most mainstream middleware with servers have begun to evolve their own service self-loop and control and provide components or functions with higher compatibility and reliability to the server, such as Kafka's KRaft, RocketMQ's NameServer, ClickHouse's ClickHouse Keeper, etc. To address the above problems and architectural evolution requirements, Seata needs to build its own NamingServer to ensure more stability and reliability.</p>
<p><strong>Project Link:</strong>
<a href="https://summer-ospp.ac.cn/org/prodetail/230640380?list=org&amp;navpage=org" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/prodetail/230640380?list=org&amp;navpage=org</a></p>
<p>...</p>
<p>(Projects Two to Six translated in the same manner)</p>
<p>...</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-participate-in-seata-open-source-summer-2023-and-quickly-select-a-project">How to Participate in Seata Open Source Summer 2023 and Quickly Select a Project?<a href="https://seata.apache.org/blog/iscas2023#how-to-participate-in-seata-open-source-summer-2023-and-quickly-select-a-project" class="hash-link" aria-label="Direct link to How to Participate in Seata Open Source Summer 2023 and Quickly Select a Project?" title="Direct link to How to Participate in Seata Open Source Summer 2023 and Quickly Select a Project?">​</a></h3>
<p><strong>Welcome to communicate with each mentor through the above contact information and prepare project application materials.</strong></p>
<p>During the project participation period, students can work online from anywhere in the world. The completion of Seata-related projects needs to be submitted to the Seata community repository as a PR by <strong>September 30th</strong>, so please prepare early.</p>
<p><img decoding="async" loading="lazy" alt="seata2023-3" src="https://seata.apache.org/assets/images/summer2023-3-9b3b418ef64bd3c1afb2782d17af315a.png" width="1080" height="471" class="img_ev3q"></p>
<p><strong>To obtain information about mentors and other information during the project, you can scan the QR code below to enter the DingTalk group for communication</strong> —— Understand various projects in the Seata community, meet Seata community open source mentors, and help with subsequent applications.</p>
<p><img decoding="async" loading="lazy" alt="summer2023-4" src="https://seata.apache.org/assets/images/summer2023-4-3322e50a0b89b4585ddec35b43ef84eb.jpg" width="618" height="700" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="reference-materials">Reference Materials:<a href="https://seata.apache.org/blog/iscas2023#reference-materials" class="hash-link" aria-label="Direct link to Reference Materials:" title="Direct link to Reference Materials:">​</a></h4>
<p><strong>Seata Website:</strong> <a href="https://seata.apache.org/" target="_blank" rel="noopener noreferrer">https://seata.apache.org/</a></p>
<p><strong>Seata GitHub:</strong> <a href="https://github.com/seata" target="_blank" rel="noopener noreferrer">https://github.com/seata</a></p>
<p><strong>Open Source Summer Official Website:</strong> <a href="https://summer-ospp.ac.cn/org/orgdetail/ab188e59-fab8-468f-bc89-bdc2bd8b5e64?lang=zh" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/orgdetail/ab188e59-fab8-468f-bc89-bdc2bd8b5e64?lang=zh</a></p>
<p>If students are interested in other areas of microservices projects, they can also try to apply, such as:</p>
<ul>
<li>For students interested in <strong>microservice configuration registration centers</strong>, they can try to apply for <a href="https://nacos.io/zh-cn/blog/iscas2023.html" target="_blank" rel="noopener noreferrer">Nacos Open Source Summer</a>;</li>
<li>For students interested in <strong>microservice frameworks and RPC frameworks</strong>, they can try to apply for <a href="https://summer-ospp.ac.cn/org/orgdetail/41d68399-ed48-4d6d-9d4d-3ff4128dc132?lang=zh" target="_blank" rel="noopener noreferrer">Spring Cloud Alibaba Open Source Summer</a> and <a href="https://summer-ospp.ac.cn/org/orgdetail/a7f6e2ad-4acc-47f8-9471-4e54b9a166a6?lang=zh" target="_blank" rel="noopener noreferrer">Dubbo Open Source Summer</a>;</li>
<li>For students interested in <strong>cloud-native gateways</strong>, they can try to apply for <a href="https://higress.io/zh-cn/blog/ospp-2023" target="_blank" rel="noopener noreferrer">Higress Open Source Summer</a>;</li>
<li>For students interested in <strong>distributed high-availability protection</strong>, they can try to apply for [Sentinel Open Source Summer](<a href="https://summer-ospp.ac/" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac</a>. cn/org/orgdetail/5e879522-bd90-4a8b-bf8b-b11aea48626b?lang=zh);</li>
<li>For students interested in <strong>microservices governance</strong>, they can try to apply for [OpenSergo Open Source Summer](<a href="https://summer-ospp.ac/" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac</a>. cn/org/orgdetail/aaff4eec-11b1-4375-997d-5eea8f51762b?lang=zh).</li>
</ul>]]></content>
        <author>
            <name>Seata Community</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata 1.6.0 Released with Significant Performance Improvement]]></title>
        <id>https://seata.apache.org/blog/seata-1.6.0</id>
        <link href="https://seata.apache.org/blog/seata-1.6.0"/>
        <updated>2022-12-17T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata 1.6.0 Released with Significant Performance Improvement]]></summary>
        <content type="html"><![CDATA[<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-160-released-with-significant-performance-improvement">Seata 1.6.0 Released with Significant Performance Improvement<a href="https://seata.apache.org/blog/seata-1.6.0#seata-160-released-with-significant-performance-improvement" class="hash-link" aria-label="Direct link to Seata 1.6.0 Released with Significant Performance Improvement" title="Direct link to Seata 1.6.0 Released with Significant Performance Improvement">​</a></h3>
<p>Seata is an open-source distributed transaction solution that provides high performance and easy-to-use distributed transaction services.</p>
<p><strong>Download Links for seata-server:</strong></p>
<p><a href="https://github.com/apache/incubator-seata/archive/v1.6.0.zip" target="_blank" rel="noopener noreferrer">source</a> |
<a href="https://github.com/apache/incubator-seata/releases/download/v1.6.0/seata-server-1.6.0.zip" target="_blank" rel="noopener noreferrer">binary</a></p>
<p>Updates in this version:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature">feature：<a href="https://seata.apache.org/blog/seata-1.6.0#feature" class="hash-link" aria-label="Direct link to feature：" title="Direct link to feature：">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4863" target="_blank" rel="noopener noreferrer">#4863</a>] Support for multiple primary keys in Oracle and PostgreSQL</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4649" target="_blank" rel="noopener noreferrer">#4649</a>] Support for multiple registry centers in seata-server</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4779" target="_blank" rel="noopener noreferrer">#4779</a>] Support for Apache Dubbo3</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4479" target="_blank" rel="noopener noreferrer">#4479</a>] TCC annotations can now be added to interfaces and implementation classes</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4877" target="_blank" rel="noopener noreferrer">#4877</a>] Client SDK supports JDK17</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4914" target="_blank" rel="noopener noreferrer">#4914</a>] Support for update join syntax for MySQL</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4542" target="_blank" rel="noopener noreferrer">#4542</a>] Support for Oracle timestamp type</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5111" target="_blank" rel="noopener noreferrer">#5111</a>] Support for Nacos contextPath configuration</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4802" target="_blank" rel="noopener noreferrer">#4802</a>] Dockerfile supports arm64</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bug-fixes">Bug Fixes:<a href="https://seata.apache.org/blog/seata-1.6.0#bug-fixes" class="hash-link" aria-label="Direct link to Bug Fixes:" title="Direct link to Bug Fixes:">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4780" target="_blank" rel="noopener noreferrer">#4780</a>] Fixed the issue where TimeoutRollbacked event wasn't sent after a successful timeout rollback.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4954" target="_blank" rel="noopener noreferrer">#4954</a>] Fixed NullPointerException when the output expression was incorrect.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4817" target="_blank" rel="noopener noreferrer">#4817</a>] Fixed the problem with non-standard configuration in higher versions of Spring Boot.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4838" target="_blank" rel="noopener noreferrer">#4838</a>] Fixed the issue where undo log wasn't generated when using Statement.executeBatch().</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4533" target="_blank" rel="noopener noreferrer">#4533</a>] Fixed inaccurate metric data caused by duplicate events handling for handleRetryRollbacking.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4912" target="_blank" rel="noopener noreferrer">#4912</a>] Fixed the issue where mysql InsertOnDuplicateUpdate couldn't correctly match column names due to inconsistent case.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4543" target="_blank" rel="noopener noreferrer">#4543</a>] Fixed support for Oracle nclob data type.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4915" target="_blank" rel="noopener noreferrer">#4915</a>] Fixed the problem of not obtaining ServerRecoveryProperties attributes.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4919" target="_blank" rel="noopener noreferrer">#4919</a>] Fixed the issue where XID's port and address appeared as null:0.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4928" target="_blank" rel="noopener noreferrer">#4928</a>] Fixed NPE issue in rpcContext.getClientRMHolderMap.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4953" target="_blank" rel="noopener noreferrer">#4953</a>] Fixed the issue where InsertOnDuplicateUpdate could bypass primary key modification.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4978" target="_blank" rel="noopener noreferrer">#4978</a>] Fixed kryo support for cyclic dependencies.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4985" target="_blank" rel="noopener noreferrer">#4985</a>] Fixed the issue of duplicate undo_log id.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4874" target="_blank" rel="noopener noreferrer">#4874</a>] Fixed startup failure with OpenJDK 11.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5018" target="_blank" rel="noopener noreferrer">#5018</a>] Fixed server startup failure issue due to loader path using relative path in startup script.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5004" target="_blank" rel="noopener noreferrer">#5004</a>] Fixed the issue of duplicate row data in mysql update join.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5032" target="_blank" rel="noopener noreferrer">#5032</a>] Fixed the abnormal SQL statement in mysql InsertOnDuplicateUpdate due to incorrect calculation of condition parameter fill position.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5033" target="_blank" rel="noopener noreferrer">#5033</a>] Fixed NullPointerException issue in SQL statement of InsertOnDuplicateUpdate due to missing insert column field.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5038" target="_blank" rel="noopener noreferrer">#5038</a>] Fixed SagaAsyncThreadPoolProperties conflict issue.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5050" target="_blank" rel="noopener noreferrer">#5050</a>] Fixed the issue where global status under Saga mode wasn't correctly changed to Committed.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5052" target="_blank" rel="noopener noreferrer">#5052</a>] Fixed placeholder parameter issue in update join condition.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5031" target="_blank" rel="noopener noreferrer">#5031</a>] Fixed the issue of using null value index as query condition in InsertOnDuplicateUpdate.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5075" target="_blank" rel="noopener noreferrer">#5075</a>] Fixed the inability to intercept SQL statements with no primary key and unique index in InsertOnDuplicateUpdate.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5093" target="_blank" rel="noopener noreferrer">#5093</a>] Fixed accessKey loss issue after seata server restart.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5092" target="_blank" rel="noopener noreferrer">#5092</a>] Fixed the issue of incorrect AutoConfiguration order when seata and jpa are used together.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5109" target="_blank" rel="noopener noreferrer">#5109</a>] Fixed NPE issue when @GlobalTransactional is not applied on RM side.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5098" target="_blank" rel="noopener noreferrer">#5098</a>] Disabled oracle implicit cache for Druid.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4860" target="_blank" rel="noopener noreferrer">#4860</a>] Fixed metrics tag override issue.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5028" target="_blank" rel="noopener noreferrer">#5028</a>] Fixed null value issue in insert on duplicate SQL.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5078" target="_blank" rel="noopener noreferrer">#5078</a>] Fixed interception issue for SQL statements without primary keys and unique keys.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5097" target="_blank" rel="noopener noreferrer">#5097</a>] Fixed accessKey loss issue when Server restarts.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5131" target="_blank" rel="noopener noreferrer">#5131</a>] Fixed issue where XAConn cannot rollback when in active state.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5134" target="_blank" rel="noopener noreferrer">#5134</a>] Fixed issue where hikariDataSource auto proxy fails in some cases.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5163" target="_blank" rel="noopener noreferrer">#5163</a>] Fixed compilation failure in higher versions of JDK.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimization">Optimization:<a href="https://seata.apache.org/blog/seata-1.6.0#optimization" class="hash-link" aria-label="Direct link to Optimization:" title="Direct link to Optimization:">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4681" target="_blank" rel="noopener noreferrer">#4681</a>] Optimized the process of competing locks.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4774" target="_blank" rel="noopener noreferrer">#4774</a>] Optimized mysql8 dependency in seataio/seata-server image.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4750" target="_blank" rel="noopener noreferrer">#4750</a>] Optimized the release of global locks in AT branch to not use xid.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4790" target="_blank" rel="noopener noreferrer">#4790</a>] Added automatic OSSRH github action publishing.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4765" target="_blank" rel="noopener noreferrer">#4765</a>] XA mode in mysql8.0.29 and above no longer holds connection to the second phase.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4797" target="_blank" rel="noopener noreferrer">#4797</a>] Optimized all github actions scripts.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4800" target="_blank" rel="noopener noreferrer">#4800</a>] Added NOTICE file.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4761" target="_blank" rel="noopener noreferrer">#4761</a>] Used hget instead of hmget in RedisLocker.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4414" target="_blank" rel="noopener noreferrer">#4414</a>] Removed log4j dependency.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4836" target="_blank" rel="noopener noreferrer">#4836</a>] Improved readability of BaseTransactionalExecutor#buildLockKey(TableRecords rowsIncludingPK) method.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4865" target="_blank" rel="noopener noreferrer">#4865</a>] Fixed security vulnerabilities in Saga visualization designer GGEditor.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4590" target="_blank" rel="noopener noreferrer">#4590</a>] Dynamic configuration support for automatic degradation switch.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4490" target="_blank" rel="noopener noreferrer">#4490</a>] Optimized tccfence record table to delete by index.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4911" target="_blank" rel="noopener noreferrer">#4911</a>] Added header and license checks.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4917" target="_blank" rel="noopener noreferrer">#4917</a>] Upgraded package-lock.json to fix vulnerabilities.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4924" target="_blank" rel="noopener noreferrer">#4924</a>] Optimized pom dependencies.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4932" target="_blank" rel="noopener noreferrer">#4932</a>] Extracted default values for some configurations.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4925" target="_blank" rel="noopener noreferrer">#4925</a>] Optimized javadoc comments.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4921" target="_blank" rel="noopener noreferrer">#4921</a>] Fixed security vulnerabilities in console module and upgraded skywalking-eyes version.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4936" target="_blank" rel="noopener noreferrer">#4936</a>] Optimized storage configuration reading.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4946" target="_blank" rel="noopener noreferrer">#4946</a>] Passed SQL exceptions encountered when acquiring locks to the client.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4962" target="_blank" rel="noopener noreferrer">#4962</a>] Optimized build configuration and corrected base image of docker image.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4974" target="_blank" rel="noopener noreferrer">#4974</a>] Removed limitation on querying globalStatus quantity under redis mode.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4981" target="_blank" rel="noopener noreferrer">#4981</a>] Improved error message when tcc fence record cannot be found.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4995" target="_blank" rel="noopener noreferrer">#4995</a>] Fixed duplicate primary key query conditions in the SQL statement after mysql InsertOnDuplicateUpdate.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5047" target="_blank" rel="noopener noreferrer">#5047</a>] Removed unused code.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5051" target="_blank" rel="noopener noreferrer">#5051</a>] When undolog generates dirty write during rollback, throw exception BranchRollbackFailed_Unretriable.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5075" target="_blank" rel="noopener noreferrer">#5075</a>] Intercept insert on duplicate update statements without primary keys and unique indexes.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5104" target="_blank" rel="noopener noreferrer">#5104</a>] ConnectionProxy is no longer dependent on druid.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5124" target="_blank" rel="noopener noreferrer">#5124</a>] Support deleting TCC fence record table for oracle.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4968" target="_blank" rel="noopener noreferrer">#4468</a>] Support kryo 5.3.0.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4807" target="_blank" rel="noopener noreferrer">#4807</a>] Optimized image and OSS repository publishing pipelines.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4445" target="_blank" rel="noopener noreferrer">#4445</a>] Optimized transaction timeout judgment.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4958" target="_blank" rel="noopener noreferrer">#4958</a>] Optimized execution of triggerAfterCommit() for timeout transactions.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4582" target="_blank" rel="noopener noreferrer">#4582</a>] Optimized transaction sorting in redis storage mode.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4963" target="_blank" rel="noopener noreferrer">#4963</a>] Added ARM64 pipeline CI testing.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4434" target="_blank" rel="noopener noreferrer">#4434</a>] Removed seata-server CMS GC parameters.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing">Testing:<a href="https://seata.apache.org/blog/seata-1.6.0#testing" class="hash-link" aria-label="Direct link to Testing:" title="Direct link to Testing:">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4411" target="_blank" rel="noopener noreferrer">#4411</a>] Tested Oracle database AT mode type support.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4794" target="_blank" rel="noopener noreferrer">#4794</a>] Refactored code and attempted to fix unit test <code>DataSourceProxyTest.getResourceIdTest()</code>.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/5101" target="_blank" rel="noopener noreferrer">#5101</a>] Fixed ClassNotFoundException issue in zk registration and configuration center <code>DataSourceProxyTest.getResourceIdTest()</code>.</li>
</ul>
<p>Special thanks to the following contributors for their code contributions. If there are any unintentional omissions, please report.</p>
<ul>
<li><a href="https://github.com/slievrly" target="_blank" rel="noopener noreferrer">slievrly</a></li>
<li><a href="https://github.com/renliangyu857" target="_blank" rel="noopener noreferrer">renliangyu857</a></li>
<li><a href="https://github.com/wangliang181230" target="_blank" rel="noopener noreferrer">wangliang181230</a></li>
<li><a href="https://github.com/funky-eyes" target="_blank" rel="noopener noreferrer">funky-eyes</a></li>
<li><a href="https://github.com/tuwenlin" target="_blank" rel="noopener noreferrer">tuwenlin</a></li>
<li><a href="https://github.com/conghuhu" target="_blank" rel="noopener noreferrer">conghuhu</a></li>
<li><a href="https://github.com/a1104321118" target="_blank" rel="noopener noreferrer">a1104321118</a></li>
<li><a href="https://github.com/duanqiaoyanyu" target="_blank" rel="noopener noreferrer">duanqiaoyanyu</a></li>
<li><a href="https://github.com/robynron" target="_blank" rel="noopener noreferrer">robynron</a></li>
<li><a href="https://github.com/lcmvs" target="_blank" rel="noopener noreferrer">lcmvs</a></li>
<li><a href="https://github.com/github-ganyu" target="_blank" rel="noopener noreferrer">github-ganyu</a></li>
<li><a href="https://github.com/1181954449" target="_blank" rel="noopener noreferrer">1181954449</a></li>
<li><a href="https://github.com/zw201913" target="_blank" rel="noopener noreferrer">zw201913</a></li>
<li><a href="https://github.com/wingchi-leung" target="_blank" rel="noopener noreferrer">wingchi-leung</a></li>
<li><a href="https://github.com/AlexStocks" target="_blank" rel="noopener noreferrer">AlexStocks</a></li>
<li><a href="https://github.com/liujunlin5168" target="_blank" rel="noopener noreferrer">liujunlin5168</a></li>
<li><a href="https://github.com/pengten" target="_blank" rel="noopener noreferrer">pengten</a></li>
<li><a href="https://github.com/liuqiufeng" target="_blank" rel="noopener noreferrer">liuqiufeng</a></li>
<li><a href="https://github.com/yujianfei1986" target="_blank" rel="noopener noreferrer">yujianfei1986</a></li>
<li><a href="https://github.com/Bughue" target="_blank" rel="noopener noreferrer">Bughue</a></li>
<li><a href="https://github.com/AlbumenJ" target="_blank" rel="noopener noreferrer">AlbumenJ</a></li>
<li><a href="https://github.com/doubleDimple" target="_blank" rel="noopener noreferrer">doubleDimple</a></li>
<li><a href="https://github.com/jsbxyyx" target="_blank" rel="noopener noreferrer">jsbxyyx</a></li>
<li><a href="https://github.com/tuwenlin" target="_blank" rel="noopener noreferrer">tuwenlin</a></li>
<li><a href="https://github.com/JavaLionLi" target="_blank" rel="noopener noreferrer">CrazyLionLi</a></li>
<li><a href="https://github.com/whxxxxx" target="_blank" rel="noopener noreferrer">whxxxxx</a></li>
<li><a href="https://github.com/neillee95" target="_blank" rel="noopener noreferrer">neillee95</a></li>
<li><a href="https://github.com/crazy-sheep" target="_blank" rel="noopener noreferrer">crazy-sheep</a></li>
<li><a href="https://github.com/zhangzq7" target="_blank" rel="noopener noreferrer">zhangzq7</a></li>
<li><a href="https://github.com/l81893521" target="_blank" rel="noopener noreferrer">l81893521</a></li>
<li><a href="https://github.com/zhuyoufeng" target="_blank" rel="noopener noreferrer">zhuyoufeng</a></li>
<li><a href="https://github.com/xingfudeshi" target="_blank" rel="noopener noreferrer">xingfudeshi</a></li>
<li><a href="https://github.com/odidev" target="_blank" rel="noopener noreferrer">odidev</a></li>
<li><a href="https://github.com/miaoxueyu" target="_blank" rel="noopener noreferrer">miaoxueyu</a></li>
</ul>
<p>At the same time, we have received many valuable issues and suggestions from the community, and we are very grateful to everyone.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="link">Link<a href="https://seata.apache.org/blog/seata-1.6.0#link" class="hash-link" aria-label="Direct link to Link" title="Direct link to Link">​</a></h4>
<ul>
<li><strong>Seata:</strong> <a href="https://github.com/apache/incubator-seata" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata</a></li>
<li><strong>Seata-Samples:</strong> <a href="https://github.com/apache/incubator-seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-samples</a></li>
<li><strong>Release:</strong> <a href="https://github.com/apache/incubator-seata/releases" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata/releases</a></li>
<li><strong>WebSite:</strong> <a href="https://seata.apache.org/" target="_blank" rel="noopener noreferrer">https://seata.apache.org</a></li>
</ul>]]></content>
        <author>
            <name>Seata Community</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata 1.5.2 Released with XID Load Balancing Support]]></title>
        <id>https://seata.apache.org/blog/seata-1.5.2</id>
        <link href="https://seata.apache.org/blog/seata-1.5.2"/>
        <updated>2022-07-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata 1.5.2 Released with XID Load Balancing Support]]></summary>
        <content type="html"><![CDATA[<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-152-released-with-xid-load-balancing-support">Seata 1.5.2 Released with XID Load Balancing Support<a href="https://seata.apache.org/blog/seata-1.5.2#seata-152-released-with-xid-load-balancing-support" class="hash-link" aria-label="Direct link to Seata 1.5.2 Released with XID Load Balancing Support" title="Direct link to Seata 1.5.2 Released with XID Load Balancing Support">​</a></h3>
<p>Seata is an open-source distributed transaction solution that provides high-performance and easy-to-use distributed transaction services.</p>
<p><strong>seata-server Download Links:</strong></p>
<p><a href="https://github.com/apache/incubator-seata/archive/v1.5.2.zip" target="_blank" rel="noopener noreferrer">source</a> |
<a href="https://github.com/apache/incubator-seata/releases/download/v1.5.2/seata-server-1.5.2.zip" target="_blank" rel="noopener noreferrer">binary</a></p>
<p>The key updates in this version include:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="features">Features:<a href="https://seata.apache.org/blog/seata-1.5.2#features" class="hash-link" aria-label="Direct link to Features:" title="Direct link to Features:">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4713" target="_blank" rel="noopener noreferrer">#4661</a>] Added support for XID load balancing algorithm.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4676" target="_blank" rel="noopener noreferrer">#4676</a>] Added support for Seata server to expose services through SLB when using Nacos as the registry center.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4642" target="_blank" rel="noopener noreferrer">#4642</a>] Added support for parallel processing of client batch requests.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4567" target="_blank" rel="noopener noreferrer">#4567</a>] Added support for the <code>find_in_set</code> function in the WHERE condition.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bug-fixes">Bug Fixes:<a href="https://seata.apache.org/blog/seata-1.5.2#bug-fixes" class="hash-link" aria-label="Direct link to Bug Fixes:" title="Direct link to Bug Fixes:">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4515" target="_blank" rel="noopener noreferrer">#4515</a>] Fixed an issue where SeataTCCFenceAutoConfiguration on the develop branch throws a ClassNotFoundException when the client does not use a DB.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4661" target="_blank" rel="noopener noreferrer">#4661</a>] Fixed SQL exceptions when using PostgreSQL in the console.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4682" target="_blank" rel="noopener noreferrer">#4667</a>] Fixed an exception when updating the map in RedisTransactionStoreManager on the develop branch.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4678" target="_blank" rel="noopener noreferrer">#4678</a>] Fixed the issue of cache penetration when the property <code>transport.enableRmClientBatchSendRequest</code> is not configured.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4701" target="_blank" rel="noopener noreferrer">#4701</a>] Fixed the issue of missing command line parameters.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4607" target="_blank" rel="noopener noreferrer">#4607</a>] Fixed a defect in skipping global lock verification.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4696" target="_blank" rel="noopener noreferrer">#4696</a>] Fixed the insertion issue when using the Oracle storage mode.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4726" target="_blank" rel="noopener noreferrer">#4726</a>] Fixed a possible NPE issue when sending messages in batches.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4729" target="_blank" rel="noopener noreferrer">#4729</a>] Fixed the issue of incorrect setting of <code>AspectTransactional.rollbackForClassName</code>.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4653" target="_blank" rel="noopener noreferrer">#4653</a>] Fixed the exception of non-numeric primary key in INSERT_ON_DUPLICATE.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimizations">Optimizations:<a href="https://seata.apache.org/blog/seata-1.5.2#optimizations" class="hash-link" aria-label="Direct link to Optimizations:" title="Direct link to Optimizations:">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4650" target="_blank" rel="noopener noreferrer">#4650</a>] Fixed a security vulnerability.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4670" target="_blank" rel="noopener noreferrer">#4670</a>] Optimized the number of threads in the <code>branchResultMessageExecutor</code> thread pool.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4662" target="_blank" rel="noopener noreferrer">#4662</a>] Optimized the monitoring metrics for rolling back transactions.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4693" target="_blank" rel="noopener noreferrer">#4693</a>] Optimized the console navigation bar.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4700" target="_blank" rel="noopener noreferrer">#4700</a>] Fixed failures in the execution of maven-compiler-plugin and maven-resources-plugin.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4711" target="_blank" rel="noopener noreferrer">#4711</a>] Separated the lib dependency during deployment.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4720" target="_blank" rel="noopener noreferrer">#4720</a>] Optimized pom descriptions.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4728" target="_blank" rel="noopener noreferrer">#4728</a>] Upgraded the logback version dependency to 1.2.9.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4745" target="_blank" rel="noopener noreferrer">#4745</a>] Added support for mysql8 driver in the distribution package.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4626" target="_blank" rel="noopener noreferrer">#4626</a>] Used <code>easyj-maven-plugin</code> plugin instead of <code>flatten-maven-plugin</code> to fix compatibility issues between <code>shade</code> plugin and <code>flatten</code> plugin.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4629" target="_blank" rel="noopener noreferrer">#4629</a>] Checked the constraint relationship before and after updating the globalSession status.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4662" target="_blank" rel="noopener noreferrer">#4662</a>] Optimized the readability of EnhancedServiceLoader.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tests">Tests:<a href="https://seata.apache.org/blog/seata-1.5.2#tests" class="hash-link" aria-label="Direct link to Tests:" title="Direct link to Tests:">​</a></h3>
<ul>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4544" target="_blank" rel="noopener noreferrer">#4544</a>] Optimized the jackson package dependency issue in TransactionContextFilterTest.</li>
<li>[<a href="https://github.com/apache/incubator-seata/pull/4731" target="_blank" rel="noopener noreferrer">#4731</a>] Fixed unit test issues in AsyncWorkerTest and LockManagerTest.</li>
</ul>
<p>A big thanks to the contributors for their valuable code contributions. If inadvertently omitted, please report.</p>
<ul>
<li><a href="https://github.com/slievrly" target="_blank" rel="noopener noreferrer">slievrly</a></li>
<li><a href="https://github.com/pengten" target="_blank" rel="noopener noreferrer">pengten</a></li>
<li><a href="https://github.com/YSF-A" target="_blank" rel="noopener noreferrer">YSF-A</a></li>
<li><a href="https://github.com/tuwenlin" target="_blank" rel="noopener noreferrer">tuwenlin</a></li>
<li><a href="https://github.com/2129zxl" target="_blank" rel="noopener noreferrer">2129zxl</a></li>
<li><a href="https://github.com/Ifdevil" target="_blank" rel="noopener noreferrer">Ifdevil</a></li>
<li><a href="https://github.com/wingchi-leung" target="_blank" rel="noopener noreferrer">wingchi-leung</a></li>
<li><a href="https://github.com/robynron" target="_blank" rel="noopener noreferrer">liurong</a></li>
<li><a href="https://github.com/opelok-z" target="_blank" rel="noopener noreferrer">opelok-z</a></li>
<li><a href="https://github.com/funky-eyes" target="_blank" rel="noopener noreferrer">funky-eyes</a></li>
<li><a href="https://github.com/Smery-lxm" target="_blank" rel="noopener noreferrer">Smery-lxm</a></li>
<li><a href="https://github.com/lvekee" target="_blank" rel="noopener noreferrer">lvekee</a></li>
<li><a href="https://github.com/doubleDimple" target="_blank" rel="noopener noreferrer">doubleDimple</a></li>
<li><a href="https://github.com/wangliang181230" target="_blank" rel="noopener noreferrer">wangliang181230</a></li>
<li><a href="https://github.com/Bughue" target="_blank" rel="noopener noreferrer">Bughue</a></li>
<li><a href="https://github.com/AYue-94" target="_blank" rel="noopener noreferrer">AYue-94</a></li>
<li><a href="https://github.com/lingxiao-wu" target="_blank" rel="noopener noreferrer">lingxiao-wu</a></li>
<li><a href="https://github.com/caohdgege" target="_blank" rel="noopener noreferrer">caohdgege</a></li>
</ul>
<p>At the same time, we have received many valuable issues and suggestions from the community, thank you very much.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="link">Link<a href="https://seata.apache.org/blog/seata-1.5.2#link" class="hash-link" aria-label="Direct link to Link" title="Direct link to Link">​</a></h4>
<ul>
<li><strong>Seata:</strong> <a href="https://github.com/apache/incubator-seata" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata</a></li>
<li><strong>Seata-Samples:</strong> <a href="https://github.com/apache/incubator-seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-samples</a></li>
<li><strong>Release:</strong> <a href="https://github.com/apache/incubator-seata/releases" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata/releases</a></li>
<li><strong>WebSite:</strong> <a href="https://seata.io/" target="_blank" rel="noopener noreferrer">https://seata.io</a></li>
</ul>]]></content>
        <author>
            <name>Seata Community</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Alibaba Seata Resolves Idempotence, Dangling, and Empty Rollback Issues in TCC Mode]]></title>
        <id>https://seata.apache.org/blog/seata-tcc-fence</id>
        <link href="https://seata.apache.org/blog/seata-tcc-fence"/>
        <updated>2022-06-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata version 1.5.1 from Alibaba has finally resolved the issues of idempotence, dangling, and empty rollback in TCC (Try-Confirm-Cancel) mode. This article mainly explains how Seata addresses these problems.]]></summary>
        <content type="html"><![CDATA[<p>Today, let's talk about how the new version (1.5.1) of Alibaba's Seata resolves the issues of idempotence, dangling, and empty rollback in TCC mode.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-tcc">1 TCC<a href="https://seata.apache.org/blog/seata-tcc-fence#1-tcc" class="hash-link" aria-label="Direct link to 1 TCC" title="Direct link to 1 TCC">​</a></h2>
<p>TCC mode is the most classic solution for distributed transactions. It divides the distributed transaction into two phases. In the try phase, resources are reserved for each branch transaction. If all branch transactions successfully reserve resources, the global transaction proceeds to the commit phase for committing the transaction globally. However, if any node fails to reserve resources, the global transaction enters the cancel phase to rollback the transaction globally.</p>
<p>Taking traditional order, inventory, and account services as an example, in the try phase, resources are attempted to be reserved by inserting orders, deducting inventory, and deducting amounts. These three services require local transaction commits, and the resources can be transferred to an intermediate table. In the commit phase, the resources reserved in the try phase are transferred to the final table. In the cancel phase, the resources reserved in the try phase are released, such as returning the account amount to the customer's account.</p>
<p><strong>Note: The try phase must involve committing local transactions. For example, when deducting the order amount, the money must be deducted from the customer's account. If it is not deducted, there will be a problem in the commit phase if the customer's account does not have enough money.</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-try-commit">1.1 try-commit<a href="https://seata.apache.org/blog/seata-tcc-fence#11-try-commit" class="hash-link" aria-label="Direct link to 1.1 try-commit" title="Direct link to 1.1 try-commit">​</a></h3>
<p>In the try phase, resources are first reserved, and then they are deducted in the commit phase. The diagram below illustrates this process:</p>
<p><img decoding="async" loading="lazy" alt="fence-try-commit" src="https://seata.apache.org/assets/images/fence-try-commit-453b9a1e280200057448436ecd7eef27.png" width="501" height="681" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-try-cancel">1.2 try-cancel<a href="https://seata.apache.org/blog/seata-tcc-fence#12-try-cancel" class="hash-link" aria-label="Direct link to 1.2 try-cancel" title="Direct link to 1.2 try-cancel">​</a></h3>
<p>In the try phase, resources are first reserved. If the deduction of inventory fails, leading to a rollback of the global transaction, the resources are released in the cancel phase. The diagram below illustrates this process:</p>
<p><img decoding="async" loading="lazy" alt="fence-try-cancel" src="https://seata.apache.org/assets/images/fence-try-cancel-eafbbb62134fe4e3ed61bdc2a47461b9.png" width="501" height="681" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-tcc-advantages">2 TCC Advantages<a href="https://seata.apache.org/blog/seata-tcc-fence#2-tcc-advantages" class="hash-link" aria-label="Direct link to 2 TCC Advantages" title="Direct link to 2 TCC Advantages">​</a></h2>
<p>The biggest advantage of TCC mode is its high efficiency. In the try phase, the resource locking in TCC mode is not a true lock, but rather a real local transaction submission that reserves resources in an intermediate state without the need for blocking and waiting. Therefore, it is more efficient than other modes.</p>
<p>Additionally, the TCC mode can be optimized as follows:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-asynchronous-commit">2.1 Asynchronous Commit<a href="https://seata.apache.org/blog/seata-tcc-fence#21-asynchronous-commit" class="hash-link" aria-label="Direct link to 2.1 Asynchronous Commit" title="Direct link to 2.1 Asynchronous Commit">​</a></h3>
<p>After the try phase succeeds, instead of immediately entering the confirm/cancel phase, it is considered that the global transaction has already ended. A scheduled task is started to asynchronously execute the confirm/cancel phase, which involves deducting or releasing resources. This approach can greatly improve performance.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-same-database-mode">2.2 Same-Database Mode<a href="https://seata.apache.org/blog/seata-tcc-fence#22-same-database-mode" class="hash-link" aria-label="Direct link to 2.2 Same-Database Mode" title="Direct link to 2.2 Same-Database Mode">​</a></h3>
<p>In the TCC mode, there are three roles:</p>
<ul>
<li>TM: Manages the global transaction, including starting the global transaction and committing/rolling back the global transaction.</li>
<li>RM: Manages the branch transaction.</li>
<li>TC: Manages the state of the global transaction and branch transactions.</li>
</ul>
<p>The diagram below is from the Seata official website:</p>
<p><img decoding="async" loading="lazy" alt="fence-fiffrent-db" src="https://seata.apache.org/assets/images/fence-fiffrent-db-1f7a834639aa755d73fa2af435c4f042.png" width="853" height="482" class="img_ev3q"></p>
<p>When TM starts a global transaction, RM needs to send a registration message to TC, and TC saves the state of the branch transaction. When TM requests a commit or rollback, TC needs to send commit or rollback messages to RM. In this way, in a distributed transaction with two branch transactions, there are four RPCs between TC and RM.</p>
<p>After optimization, the process is as shown in the diagram below:</p>
<p>TC saves the state of the global transaction. When TM starts a global transaction, RM no longer needs to send a registration message to TC. Instead, it saves the state of the branch transaction locally. After TM sends a commit or rollback message to TC, the asynchronous thread in RM first retrieves the uncommitted branch transactions saved locally, and then sends a message to TC to obtain the state of the global transaction in which the local branch transaction is located, in order to determine whether to commit or rollback the local transaction.</p>
<p>With this optimization, the number of RPCs is reduced by 50%, resulting in a significant performance improvement.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-rm-code-example">3 RM Code Example<a href="https://seata.apache.org/blog/seata-tcc-fence#3-rm-code-example" class="hash-link" aria-label="Direct link to 3 RM Code Example" title="Direct link to 3 RM Code Example">​</a></h2>
<p>Taking the inventory service as an example, the RM inventory service interface code is as follows:</p>
<div class="language-Java language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@LocalTCC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">StorageService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * decrease</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @param xid </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @param productId </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @param count </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@TwoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"storageApi"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commitMethod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"commit"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rollbackMethod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"rollback"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> useTCCFence </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrease</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Long</span><span class="token plain"> productId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Integer</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @param actionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BusinessActionContext</span><span class="token plain"> actionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @param actionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rollback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BusinessActionContext</span><span class="token plain"> actionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>By using the <code>@LocalTCC</code> annotation, when the RM is initialized, it registers a branch transaction with the TC. The <code>try</code> phase method (e.g., <code>decrease</code> method) is annotated with <code>@TwoPhaseBusinessAction</code>, which defines the branch transaction's <code>resourceId</code>, <code>commit</code> method, <code>cancel</code> method, and the <code>useTCCFence</code> property, which will be explained in the next section.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-issues-with-tcc">4 Issues with TCC<a href="https://seata.apache.org/blog/seata-tcc-fence#4-issues-with-tcc" class="hash-link" aria-label="Direct link to 4 Issues with TCC" title="Direct link to 4 Issues with TCC">​</a></h2>
<p>There are three major issues with the TCC pattern: idempotence, suspension, and empty rollback. In version 1.5.1 of Seata, a transaction control table named <code>tcc_fence_log</code> is introduced to address these issues. The <code>useTCCFence</code> property mentioned in the previous <code>@TwoPhaseBusinessAction</code> annotation is used to enable or disable this mechanism, with a default value of <code>false</code>.</p>
<p>The creation SQL statement for the <code>tcc_fence_log</code> table (in MySQL syntax) is as follows:</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">tcc_fence_log</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">           </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'global id'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">     </span><span class="token keyword" style="color:#00009f">BIGINT</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'branch id'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">action_name</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'action name'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">status</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">        </span><span class="token keyword" style="color:#00009f">TINYINT</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'status(tried:1;committed:2;rollbacked:3;suspended:4)'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">gmt_create</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">    </span><span class="token keyword" style="color:#00009f">DATETIME</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'create time'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">gmt_modified</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">DATETIME</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'update time'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">idx_gmt_modified</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">gmt_modified</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">idx_status</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">status</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> utf8mb4</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-idempotence">4.1 Idempotence<a href="https://seata.apache.org/blog/seata-tcc-fence#41-idempotence" class="hash-link" aria-label="Direct link to 4.1 Idempotence" title="Direct link to 4.1 Idempotence">​</a></h3>
<p>During the commit/cancel phase, if the TC does not receive a response from the branch transaction, it needs to retry the operation. Therefore, it is necessary for the branch transaction to support idempotence.</p>
<p>Let's take a look at how this is addressed in the new version. The following code is from the <code>TCCResourceManager</code> class:</p>
<div class="language-Java language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">BranchStatus</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">branchCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BranchType</span><span class="token plain"> branchType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">								 </span><span class="token class-name">String</span><span class="token plain"> applicationData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">TransactionException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">TCCResource</span><span class="token plain"> tccResource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TCCResource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">tccResourceCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">Object</span><span class="token plain"> targetTCCBean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTargetBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">Method</span><span class="token plain"> commitMethod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCommitMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">//BusinessActionContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">BusinessActionContext</span><span class="token plain"> businessActionContext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getBusinessActionContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			applicationData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTwoPhaseCommitArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tccResource</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> businessActionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">Object</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">//whether the useTCCFence property is set to true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Boolean</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TRUE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">businessActionContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getActionContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Constants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">USE_TCC_FENCE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">TCCFenceHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">commitFence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">commitMethod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> targetTCCBean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SkipCallbackWrapperException</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token class-name">UndeclaredThrowableException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCause</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"TCC resource commit result : {}, xid: {}, branchId: {}, resourceId: {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token class-name">BranchStatus</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">PhaseTwo_Committed</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">BranchStatus</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">PhaseTwo_CommitFailed_Retryable</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">BranchStatus</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">PhaseTwo_CommitFailed_Retryable</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above code shows that when executing the commit method of the branch transaction, it first checks if the <code>useTCCFence</code> property is <code>true</code>. If it is <code>true</code>, it follows the <code>commitFence</code> logic in the <code>TCCFenceHandler</code> class; otherwise, it follows the normal commit logic.</p>
<p>The <code>commitFence</code> method in the <code>TCCFenceHandler</code> class calls the <code>commitFence</code> method of the same class. The code is as follows:</p>
<div class="language-Java language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commitFence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Method</span><span class="token plain"> commitMethod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> targetTCCBean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">								  </span><span class="token class-name">String</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Long</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> transactionTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">Connection</span><span class="token plain"> conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">DataSourceUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">TCCFenceDO</span><span class="token plain"> tccFenceDO </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCC_FENCE_DAO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queryTCCFenceDO</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tccFenceDO </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">TCCFenceException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"TCC fence record not exists, commit fence method failed. xid= %s, branchId= %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">						</span><span class="token class-name">FrameworkErrorCode</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">RecordAlreadyExists</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_COMMITTED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> tccFenceDO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Branch transaction has already committed before. idempotency rejected. xid: {}, branchId: {}, status: {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tccFenceDO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_ROLLBACKED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> tccFenceDO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_SUSPENDED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> tccFenceDO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isWarnEnabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">warn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Branch transaction status is unexpected. xid: {}, branchId: {}, status: {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tccFenceDO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateStatusAndInvokeTargetMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commitMethod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> targetTCCBean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_COMMITTED</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRollbackOnly</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SkipCallbackWrapperException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From the code, we can see that when committing the transaction, it first checks if there is a record in the <code>tcc_fence_log</code> table. If a record exists, it checks the transaction execution status and returns. This ensures idempotence by avoiding duplicate commits if the transaction status is already <code>STATUS_COMMITTED</code>. If there is no record in the <code>tcc_fence_log</code> table, a new record is inserted for later retry detection.</p>
<p>The rollback logic is similar to the commit logic and is implemented in the <code>rollbackFence</code> method of the <code>TCCFenceHandler</code> class.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-empty-rollback">4.2 Empty Rollback<a href="https://seata.apache.org/blog/seata-tcc-fence#42-empty-rollback" class="hash-link" aria-label="Direct link to 4.2 Empty Rollback" title="Direct link to 4.2 Empty Rollback">​</a></h3>
<p>In the scenario shown in the following diagram, the account service consists of a cluster of two nodes. During the try phase, the account service on Node 1 encounters a failure. Without considering retries, the global transaction must reach the end state, requiring a cancel operation to be performed on the account service.</p>
<p><img decoding="async" loading="lazy" alt="fence-empty-rollback" src="https://seata.apache.org/assets/images/fence-empty-rollback-55e0c44f8e67d5df91c0f930860baa1f.png" width="591" height="681" class="img_ev3q"></p>
<p>Seata's solution is to insert a record into the <code>tcc_fence_log</code> table during the try phase, with the <code>status</code> field set to <code>STATUS_TRIED</code>. During the rollback phase, it checks if the record exists, and if it doesn't, the rollback operation is not executed. The code is as follows:</p>
<div class="language-Java language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//TCCFenceHandler </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">prepareFence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Long</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> actionName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Callback</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> targetCallback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> transactionTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">Connection</span><span class="token plain"> conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">DataSourceUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insertTCCFenceLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> actionName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_TRIED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"TCC fence prepare result: {}. xid: {}, branchId: {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> targetCallback</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">TCCFenceException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Insert tcc fence record error, prepare fence failed. xid= %s, branchId= %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">						</span><span class="token class-name">FrameworkErrorCode</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">InsertRecordError</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TCCFenceException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The processing logic in the Rollback phase is as follows:</p>
<div class="language-Java language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//TCCFenceHandler </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rollbackFence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Method</span><span class="token plain"> rollbackMethod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> targetTCCBean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">									</span><span class="token class-name">String</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Long</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> actionName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> transactionTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">Connection</span><span class="token plain"> conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">DataSourceUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">TCCFenceDO</span><span class="token plain"> tccFenceDO </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCC_FENCE_DAO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queryTCCFenceDO</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// non_rollback</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tccFenceDO </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token comment" style="color:#999988;font-style:italic">//The rollback logic is not executed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_ROLLBACKED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> tccFenceDO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_SUSPENDED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> tccFenceDO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Branch transaction had already rollbacked before, idempotency rejected. xid: {}, branchId: {}, status: {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tccFenceDO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_COMMITTED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> tccFenceDO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isWarnEnabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">						</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">warn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Branch transaction status is unexpected. xid: {}, branchId: {}, status: {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tccFenceDO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateStatusAndInvokeTargetMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rollbackMethod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> targetTCCBean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_ROLLBACKED</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRollbackOnly</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SkipCallbackWrapperException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>updateStatusAndInvokeTargetMethod method executes the following SQL:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> tcc_fence_log </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gmt_modified </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> xid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">and</span><span class="token plain">  branch_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As we can see, it updates the value of the status field in the tcc_fence_log table from STATUS_TRIED to STATUS_ROLLBACKED. If the update is successful, the rollback logic is executed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-hanging">4.3 Hanging<a href="https://seata.apache.org/blog/seata-tcc-fence#43-hanging" class="hash-link" aria-label="Direct link to 4.3 Hanging" title="Direct link to 4.3 Hanging">​</a></h3>
<p>Hanging refers to a situation where, due to network issues, the RM did not receive the try instruction initially, but after executing the rollback, the RM receives the try instruction and successfully reserves resources. This leads to the inability to release the reserved resources, as shown in the following diagram:</p>
<p><img decoding="async" loading="lazy" alt="fence-suspend" src="https://seata.apache.org/assets/images/fence-suspend-054f87611ab16153c07bd28495c6902c.png" width="451" height="193" class="img_ev3q"></p>
<p>Seata solves this problem by checking if there is a record for the current xid in the tcc_fence_log table before executing the rollback method. If there is no record, it inserts a new record into the tcc_fence_log table with the status STATUS_SUSPENDED and does not perform the rollback operation. The code is as follows:</p>
<div class="language-Java language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rollbackFence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Method</span><span class="token plain"> rollbackMethod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> targetTCCBean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">									</span><span class="token class-name">String</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Long</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> actionName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> transactionTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">Connection</span><span class="token plain"> conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">DataSourceUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">TCCFenceDO</span><span class="token plain"> tccFenceDO </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCC_FENCE_DAO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">queryTCCFenceDO</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// non_rollback</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tccFenceDO </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insertTCCFenceLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> actionName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_SUSPENDED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateStatusAndInvokeTargetMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rollbackMethod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> targetTCCBean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_ROLLBACKED</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When executing the try phase method, a record for the current xid is first inserted into the tcc_fence_log table, which causes a primary key conflict. The code is as follows:</p>
<div class="language-Java language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//TCCFenceHandler </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">prepareFence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Long</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> actionName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Callback</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> targetCallback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> transactionTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">Connection</span><span class="token plain"> conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">DataSourceUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insertTCCFenceLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> actionName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TCCFenceConstant</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">STATUS_TRIED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TCCFenceException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getErrcode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">FrameworkErrorCode</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">DuplicateKeyException</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Branch transaction has already rollbacked before,prepare fence failed. xid= {},branchId = {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token function" style="color:#d73a49">addToLogCleanQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRollbackOnly</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SkipCallbackWrapperException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note: The queryTCCFenceDO method in the SQL statement uses for update, so there is no need to worry about not being able to determine the execution result of the local transaction in the rollback method due to the inability to obtain records from the tcc_fence_log table.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-summary">5 Summary<a href="https://seata.apache.org/blog/seata-tcc-fence#5-summary" class="hash-link" aria-label="Direct link to 5 Summary" title="Direct link to 5 Summary">​</a></h3>
<p>TCC mode is a very important transaction mode in distributed transactions. However, idempotence, hanging, and empty rollback have always been issues that need to be considered in TCC mode. The Seata framework perfectly solves these problems in version 1.5.1.
The operations on the tcc_fence_log table also need to consider transaction control. Seata uses a proxy data source to execute the operations on the tcc_fence_log table and the RM business operations in the same local transaction. This ensures that the local operations and the operations on the tcc_fence_log table succeed or fail together.</p>]]></content>
        <author>
            <name>Zhu Jinjun</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[In-Depth Analysis of Seata TCC Mode (1)]]></title>
        <id>https://seata.apache.org/blog/seata-tcc</id>
        <link href="https://seata.apache.org/blog/seata-tcc"/>
        <updated>2022-01-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata currently supports AT mode, XA mode, TCC mode, and SAGA mode. Previous articles have talked more about non-intrusive AT mode. Today, we will introduce TCC mode, which is also a two-phase commit.]]></summary>
        <content type="html"><![CDATA[<p>Seata currently supports AT mode, XA mode, TCC mode, and SAGA mode. Previous articles have talked more about non-intrusive AT mode. Today, we will introduce TCC mode, which is also a two-phase commit.</p>
<h1>What is TCC</h1>
<p>TCC is a two-phase commit protocol in distributed transactions. Its full name is Try-Confirm-Cancel. Their specific meanings are as follows:</p>
<ol>
<li>Try: Check and reserve business resources;</li>
<li>Confirm: Commit the business transaction, i.e., the commit operation. If Try is successful, this step will definitely be successful;</li>
<li>Cancel: Cancel the business transaction, i.e., the rollback operation. This step will release the resources reserved in Try.</li>
</ol>
<p>TCC is an intrusive distributed transaction solution. All three operations need to be implemented by the business system itself, which has a significant impact on the business system. The design is relatively complex, but the advantage is that TCC does not rely on the database. It can manage resources across databases and applications, and can implement an atomic operation for different data access through intrusive coding, better solving the distributed transaction problems in various complex business scenarios.</p>
<img src="https://seata.apache.org/img/blog/20220116160157.png" alt="img" style="zoom:50%">
<h1>Seata TCC mode</h1>
<p>Seata TCC mode follows the same principle as the general TCC mode. Let's first use Seata TCC mode to implement a distributed transaction:</p>
<p>Suppose there is a business that needs to use service A and service B to complete a transaction operation. We define a TCC interface for this service in service A:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">TccActionOne</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@TwoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"DubboTccActionOne"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commitMethod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"commit"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rollbackMethod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"rollback"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">prepare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BusinessActionContext</span><span class="token plain"> actionContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@BusinessActionContextParameter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">paramName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"a"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BusinessActionContext</span><span class="token plain"> actionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rollback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BusinessActionContext</span><span class="token plain"> actionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Similarly, we define a TCC interface for this service in service B:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">TccActionTwo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@TwoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"DubboTccActionTwo"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commitMethod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"commit"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rollbackMethod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"rollback"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">prepare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BusinessActionContext</span><span class="token plain"> actionContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@BusinessActionContextParameter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">paramName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"b"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BusinessActionContext</span><span class="token plain"> actionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rollback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BusinessActionContext</span><span class="token plain"> actionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the business system, we start a global transaction and execute the TCC reserve resource methods for service A and service B:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@GlobalTransactional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doTransactionCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Service A transaction participant</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccActionOne</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">prepare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"one"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Service B transaction participant</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccActionTwo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">prepare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"two"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The example above demonstrates the implementation of a global transaction using Seata TCC mode. It can be seen that the TCC mode also uses the <code>@GlobalTransactional</code> annotation to initiate a global transaction, while the TCC interfaces of Service A and Service B are transaction participants. Seata treats a TCC interface as a Resource, also known as a TCC Resource.</p>
<p>TCC interfaces can be RPC or internal JVM calls, meaning that a TCC interface has both a sender and a caller identity. In the example above, the TCC interface is the sender in Service A and Service B, and the caller in the business system. If the TCC interface is a Dubbo RPC, the caller is a dubbo<!-- -->:reference<!-- --> and the sender is a dubbo<!-- -->:service<!-- -->.</p>
<img src="https://seata.apache.org/img/blog/20220116161933.png" alt="img" style="zoom:50%">
<p>When Seata starts, it scans and parses the TCC interfaces. If a TCC interface is a sender, Seata registers the TCC Resource with the TC during startup, and each TCC Resource has a resource ID. If a TCC interface is a caller, Seata proxies the caller and intercepts the TCC interface calls. Similar to the AT mode, the proxy intercepts the call to the Try method, registers a branch transaction with the TC, and then executes the original RPC call.</p>
<p>When the global transaction decides to commit/rollback, the TC will callback to the corresponding participant service to execute the Confirm/Cancel method of the TCC Resource using the resource ID registered by the branch.</p>
<h1>How Seata Implements TCC Mode</h1>
<p>From the above Seata TCC model, it can be seen that the TCC mode in Seata also follows the TC, TM, RM three-role model. How to implement TCC mode in these three-role models? I mainly summarize the implementation as resource parsing, resource management, and transaction processing.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resource-parsing">Resource Parsing<a href="https://seata.apache.org/blog/seata-tcc#resource-parsing" class="hash-link" aria-label="Direct link to Resource Parsing" title="Direct link to Resource Parsing">​</a></h2>
<p>Resource parsing is the process of parsing and registering TCC interfaces. As mentioned earlier, TCC interfaces can be RPC or internal JVM calls. In the Seata TCC module, there is a remoting module that is specifically used to parse TCC interfaces with the <code>TwoPhaseBusinessAction</code> annotation:</p>
<img src="https://seata.apache.org/img/blog/20220116175059.png" alt="img" style="zoom:50%">
<p>The <code>RemotingParser</code> interface mainly has methods such as <code>isRemoting</code>, <code>isReference</code>, <code>isService</code>, <code>getServiceDesc</code>, etc. The default implementation is <code>DefaultRemotingParser</code>, and the parsing of various RPC protocols is executed in <code>DefaultRemotingParser</code>. Seata has already implemented parsing of Dubbo, HSF, SofaRpc, and LocalTCC RPC protocols while also providing SPI extensibility for additional RPC protocol parsing classes.</p>
<p>During the Seata startup process, the <code>GlobalTransactionScanner</code> annotation is used for scanning and executes the following method:</p>
<p><code>io.seata.spring.util.TCCBeanParserUtils#isTccAutoProxy</code></p>
<p>The purpose of this method is to determine if the bean has been TCC proxied. In the process, it first checks if the bean is a Remoting bean. If it is, it calls the <code>getServiceDesc</code> method to parse the remoting bean, and if it is a sender, it registers the resource:</p>
<p>io.seata.rm.tcc.remoting.parser.DefaultRemotingParser#parserRemotingServiceInfo</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">RemotingDesc</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parserRemotingServiceInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Object</span><span class="token plain"> bean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> beanName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">RemotingParser</span><span class="token plain"> remotingParser</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">RemotingDesc</span><span class="token plain"> remotingBeanDesc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> remotingParser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getServiceDesc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> beanName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">remotingBeanDesc </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remotingServiceMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">beanName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> remotingBeanDesc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Class</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> interfaceClass </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> remotingBeanDesc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getInterfaceClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Method</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> methods </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> interfaceClass</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMethods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">remotingParser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> beanName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//service bean, registry resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Object</span><span class="token plain"> targetBean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> remotingBeanDesc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTargetBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Method</span><span class="token plain"> m </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> methods</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">TwoPhaseBusinessAction</span><span class="token plain"> twoPhaseBusinessAction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getAnnotation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TwoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twoPhaseBusinessAction </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">TCCResource</span><span class="token plain"> tccResource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">TCCResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setActionName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setTargetBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">targetBean</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setPrepareMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setCommitMethodName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">commitMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setCommitMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interfaceClass</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">commitMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">commitArgsClasses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRollbackMethodName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rollbackMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRollbackMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interfaceClass</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rollbackMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rollbackArgsClasses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// set argsClasses</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setCommitArgsClasses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">commitArgsClasses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRollbackArgsClasses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rollbackArgsClasses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// set phase two method's keys</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setPhaseTwoCommitKeys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTwoPhaseArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCommitMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">commitArgsClasses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setPhaseTwoRollbackKeys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTwoPhaseArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRollbackMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    twoPhaseBusinessAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rollbackArgsClasses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// registry tcc resource</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">DefaultResourceManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tccResource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FrameworkException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"parser remoting service error"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">remotingParser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isReference</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> beanName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// reference bean, TCC proxy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remotingBeanDesc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setReference</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> remotingBeanDesc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The above method first calls the parsing class <code>getServiceDesc</code> method to parse the remoting bean and puts the parsed <code>remotingBeanDesc</code> into the local cache <code>remotingServiceMap</code>. At the same time, it calls the parsing class <code>isService</code> method to determine if it is the initiator. If it is the initiator, it parses the content of the <code>TwoPhaseBusinessAction</code> annotation to generate a <code>TCCResource</code> and registers it as a resource.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resource-management">Resource Management<a href="https://seata.apache.org/blog/seata-tcc#resource-management" class="hash-link" aria-label="Direct link to Resource Management" title="Direct link to Resource Management">​</a></h2>
<p><strong>1. Resource Registration</strong></p>
<p>The resource for Seata TCC mode is called <code>TCCResource</code>, and its resource manager is called <code>TCCResourceManager</code>. As mentioned earlier, after parsing the TCC interface RPC resource, if it is the initiator, it will be registered as a resource:</p>
<p>io.seata.rm.tcc.TCCResourceManager#registerResource</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">registerResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Resource</span><span class="token plain"> resource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">TCCResource</span><span class="token plain"> tccResource</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TCCResource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">resource</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResourceCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResourceId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">tccResource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tccResource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>TCCResource</code> contains the relevant information of the TCC interface and is cached locally. It continues to call the parent class <code>registerResource</code> method (which encapsulates communication methods) to register with the TC. The TCC resource's resourceId is the actionName, and the actionName is the name in the <code>@TwoParseBusinessAction</code> annotation.</p>
<p><strong>2. Resource Commit/Rollback</strong></p>
<p>io.seata.rm.tcc.TCCResourceManager#branchCommit</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">BranchStatus</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">branchCommit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BranchType</span><span class="token plain"> branchType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token class-name">String</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token class-name">String</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">String</span><span class="token plain"> applicationData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">TransactionException</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">TCCResource</span><span class="token plain"> tccResource</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TCCResource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">tccResourceCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tccResource</span><span class="token operator" style="color:#393A34">==</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ShouldNeverHappenException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"TCC resource is not exist, resourceId: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Object</span><span class="token plain"> targetTCCBean</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTargetBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Method</span><span class="token plain"> commitMethod</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tccResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCommitMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">targetTCCBean</span><span class="token operator" style="color:#393A34">==</span><span class="token keyword" style="color:#00009f">null</span><span class="token operator" style="color:#393A34">||</span><span class="token plain">commitMethod</span><span class="token operator" style="color:#393A34">==</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ShouldNeverHappenException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"TCC resource is not available, resourceId: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//BusinessActionContext</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">BusinessActionContext</span><span class="token plain"> businessActionContext</span><span class="token operator" style="color:#393A34">=</span><span class="token function" style="color:#d73a49">getBusinessActionContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">branchId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applicationData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">commitMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">targetTCCBean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token operator" style="color:#393A34">?</span><span class="token class-name">BranchStatus</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">PhaseTwo_Committed</span><span class="token operator" style="color:#393A34">:</span><span class="token class-name">BranchStatus</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">PhaseTwo_CommitFailed_Retryable</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword" style="color:#00009f">catch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">String</span><span class="token plain"> msg</span><span class="token operator" style="color:#393A34">=</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"commit TCC resource error, resourceId: %s, xid: %s."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">xid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">BranchStatus</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">PhaseTwo_CommitFailed_Retryable</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When the TM resolves the phase two commit, the TC will callback to the corresponding participant (i.e., TCC interface initiator) service to execute the Confirm/Cancel method of the TCC Resource registered by the branch.</p>
<p>In the resource manager, the corresponding <code>TCCResource</code> will be found in the local cache based on the resourceId, and the corresponding <code>BusinessActionContext</code> will be found based on xid, branchId, resourceId, and applicationData, and the parameters to be executed are in the context. Finally, the commit method of the <code>TCCResource</code> is executed to perform the phase two commit.</p>
<p>The phase two rollback is similar.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-processing">Transaction Processing<a href="https://seata.apache.org/blog/seata-tcc#transaction-processing" class="hash-link" aria-label="Direct link to Transaction Processing" title="Direct link to Transaction Processing">​</a></h2>
<p>As mentioned earlier, if the TCC interface is a caller, the Seata TCC proxy will be used to intercept the caller and register the branch before processing the actual RPC method call.</p>
<p>The method <code>io.seata.spring.util.TCCBeanParserUtils#isTccAutoProxy</code> not only parses the TCC interface resources, but also determines whether the TCC interface is a caller. If it is a caller, it returns true:</p>
<p>io.seata.spring.annotation.GlobalTransactionScanner#wrapIfNecessary</p>
<img src="https://seata.apache.org/img/blog/20220116192544.png" alt="img" style="zoom:50%">
<p>As shown in the figure, when <code>GlobalTransactionalScanner</code> scans the TCC interface caller (Reference), it will proxy and intercept it with <code>TccActionInterceptor</code>, which implements <code>MethodInterceptor</code>.</p>
<p>In <code>TccActionInterceptor</code>, it will also call <code>ActionInterceptorHandler</code> to execute the interception logic, and the transaction-related processing is in the <code>ActionInterceptorHandler#proceed</code> method:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">proceed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Method</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> xid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TwoPhaseBusinessAction</span><span class="token plain"> businessAction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Callback</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> targetCallback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Throwable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//Get action context from arguments, or create a new one and then reset to arguments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">BusinessActionContext</span><span class="token plain"> actionContext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getOrCreateActionContextAndResetToArguments</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getParameterTypes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//Creating Branch Record</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">String</span><span class="token plain"> branchId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doTccActionLogStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> businessAction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> actionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> targetCallback</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//to report business action context finally if the actionContext.getUpdated() is true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">BusinessActionContextUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reportContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">actionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the process of executing the first phase of the TCC interface, the <code>doTccActionLogStore</code> method is called for branch registration, and the TCC-related information such as parameters is placed in the context. This context will be used for resource submission/rollback as mentioned above.</p>
<h1>How to control exceptions</h1>
<p>In the process of executing the TCC model, various exceptions may occur, the most common of which are empty rollback, idempotence, and suspense. Here I will explain how Seata handles these three types of exceptions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-handle-empty-rollback">How to handle empty rollback<a href="https://seata.apache.org/blog/seata-tcc#how-to-handle-empty-rollback" class="hash-link" aria-label="Direct link to How to handle empty rollback" title="Direct link to How to handle empty rollback">​</a></h2>
<p>What is an empty rollback?</p>
<p>An empty rollback refers to a situation in a distributed transaction where the TM drives the second-phase rollback of the participant's Cancel method without calling the participant's Try method.</p>
<p>How does an empty rollback occur?</p>
<img src="https://seata.apache.org/img/blog/20220116201900.png" alt="img" style="zoom:50%">
<p>As shown in the above figure, after the global transaction is opened, participant A will execute the first-phase RPC method after completing branch registration. If the machine where participant A is located crashes or there is a network anomaly at this time, the RPC call will fail, meaning that participant A's first-phase method did not execute successfully. However, the global transaction has already been opened, so Seata must progress to the final state. When the global transaction is rolled back, participant A's Cancel method will be called, resulting in an empty rollback.</p>
<p>To prevent empty rollback, it is necessary to identify it in the Cancel method. How does Seata do this?</p>
<p>Seata's approach is to add a TCC transaction control table, which contains the XID and BranchID information of the transaction. A record is inserted when the Try method is executed, indicating that phase one has been executed. When the Cancel method is executed, this record is read. If the record does not exist, it means that the Try method was not executed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-handle-idempotent-operations">How to Handle Idempotent Operations<a href="https://seata.apache.org/blog/seata-tcc#how-to-handle-idempotent-operations" class="hash-link" aria-label="Direct link to How to Handle Idempotent Operations" title="Direct link to How to Handle Idempotent Operations">​</a></h2>
<p>Idempotent operation refers to TC repeating the two-phase commit, so the Confirm/Cancel interface needs to support idempotent processing, which means that it will not cause duplicate resource submission or release.</p>
<p>So how does idempotent operation arise?</p>
<img src="https://seata.apache.org/img/blog/20220116203816.png" alt="img" style="zoom:50%">
<p>As shown in the above figure, after participant A completes the two phases, network jitter or machine failure may cause TC not to receive the return result of participant A's execution of the two phases. TC will continue to make repeated calls until the two-phase execution result is successful.</p>
<p>How does Seata handle idempotent operations?</p>
<p>Similarly, a status field is added to the TCC transaction control table. This field has 3 values:</p>
<ol>
<li>tried: 1</li>
<li>committed: 2</li>
<li>rollbacked: 3</li>
</ol>
<p>After the execution of the two-phase Confirm/Cancel method, the status is changed to committed or rollbacked. When the two-phase Confirm/Cancel method is called repeatedly, checking the transaction status can solve the idempotent problem.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-handle-suspend">How to Handle Suspend<a href="https://seata.apache.org/blog/seata-tcc#how-to-handle-suspend" class="hash-link" aria-label="Direct link to How to Handle Suspend" title="Direct link to How to Handle Suspend">​</a></h2>
<p>Suspension refers to the two-phase Cancel method being executed before the phase Try method, because empty rollback is allowed. After the execution of the two-phase Cancel method, directly returning success, the global transaction has ended. However, because the Try method is executed later, this will cause the resources reserved by the phase Try method to never be committed or released.</p>
<p>So how does suspension arise?</p>
<img src="https://seata.apache.org/img/blog/20220116205241.png" alt="img" style="zoom:50%">
<p>As shown in the above figure, when participant A's phase Try method is executed, network congestion occurs, and due to Seata's global transaction timeout limit, after the Try method times out, TM resolves to roll back the global transaction. After the rollback is completed, if the RPC request arrives at participant A at this time and the Try method is executed to reserve resources, it will cause suspension.</p>
<p>How does Seata handle suspension?</p>
<p>Add a status to the TCC transaction control table:</p>
<ol>
<li>suspended: 4</li>
</ol>
<p>When the two-phase Cancel method is executed, if it is found that there is no related record in the TCC transaction control table, it means that the two-phase Cancel method is executed before the phase Try method. Therefore, a record with status=4 is inserted. Then, when the phase Try method is executed, if status=4 is encountered, it means that the two-phase Cancel has been executed, and false is returned to prevent the phase Try method from succeeding.</p>
<h1>Author Introduction</h1>
<p>Zhang Chenghui, currently working at Ant Group, loves to share technology. He is the author of the WeChat public account "Advanced Backend," the author of the technical blog (<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>), and his GitHub ID is: objcoding.</p>]]></content>
        <author>
            <name>Zhang Chenghui</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[In-Depth Analysis of Seata AT Mode Transaction Isolation Levels and Global Lock Design]]></title>
        <id>https://seata.apache.org/blog/seata-at-lock</id>
        <link href="https://seata.apache.org/blog/seata-at-lock"/>
        <updated>2022-01-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[The transaction isolation in Seata AT mode is built on the basis of local isolation levels of supporting transactions. Assuming a database local isolation level of Read Committed or higher, Seata designs a global write-exclusive lock maintained by the transaction coordinator to ensure write isolation between transactions. Meanwhile, the default isolation level for global transactions is defined at Read Uncommitted.]]></summary>
        <content type="html"><![CDATA[<p>Seata AT mode is a non-intrusive distributed transaction solution. Seata internally implements a proxy layer for database operations. When using Seata AT mode, we actually use the built-in data source proxy DataSourceProxy provided by Seata. Seata adds a lot of logic in this proxy layer, such as inserting rollback undo_log records and checking global locks.</p>
<p>Why check global locks? This is because the transaction isolation of Seata AT mode is based on the local isolation level of supporting transactions. Under the premise of database local isolation level of read committed or above, Seata designs a global write exclusive lock maintained by the transaction coordinator to ensure write isolation between transactions. At the same time, global transactions are by default defined at the read uncommitted isolation level.</p>
<h1>Understanding Seata Transaction Isolation Levels</h1>
<p>Before discussing Seata transaction isolation levels, let's review the isolation levels of database transactions. Currently, there are four types of database transaction isolation levels, from lowest to highest:</p>
<ol>
<li>Read uncommitted</li>
<li>Read committed</li>
<li>Repeatable read</li>
<li>Serializable</li>
</ol>
<p>The default isolation level for databases is usually read committed, such as Oracle, while some databases default to repeatable read, such as MySQL. Generally, the read committed isolation level of databases can satisfy the majority of business scenarios.</p>
<p>We know that a Seata transaction is a global transaction, which includes several local transaction branches. During the execution of a global transaction (before the global transaction is completed), if a local transaction commits and Seata does not take any measures, it may lead to reading of committed local transactions, causing dirty reads. If a local transaction that has been committed before the global transaction commits is modified, it may cause dirty writes.</p>
<p>From this, we can see that traditional dirty reads involve reading uncommitted data, while Seata's dirty reads involve reading data that has not been committed under the global transaction, where the global transaction may include multiple local transactions. The fact that one local transaction commits does not mean that the global transaction commits.</p>
<p>Working under the read committed isolation level is fine for the vast majority of applications. In fact, the majority of scenarios that work under the read uncommitted isolation level also work fine.</p>
<p>In extreme scenarios, if an application needs to achieve global read committed, Seata also provides a global lock mechanism to implement global transaction read committed. However, by default, Seata's global transactions work under the read uncommitted isolation level to ensure efficiency in the majority of scenarios.</p>
<h1>Implementation of Global Locks</h1>
<p>In AT mode, Seata uses the internal data source proxy DataSourceProxy, and the implementation of global locks is hidden within this proxy. Let's see what happens during the execution and submission processes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-execution-process">1. Execution Process<a href="https://seata.apache.org/blog/seata-at-lock#1-execution-process" class="hash-link" aria-label="Direct link to 1. Execution Process" title="Direct link to 1. Execution Process">​</a></h2>
<p>The execution process is in the StatementProxy class. During execution, if the executed SQL is <code>select for update</code>, the SelectForUpdateExecutor class is used. If the executed method is annotated with <code>@GlobalTransactional</code> or <code>@GlobalLock</code>, it checks if there is a global lock. If a global lock exists, it rolls back the local transaction and continuously competes to obtain local and global locks through a while loop.</p>
<p>io.seata.rm.datasource.exec.SelectForUpdateExecutor#doExecute</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doExecute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Throwable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Connection</span><span class="token plain"> conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> statementProxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ... ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// ... ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RootContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">inGlobalTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token class-name">RootContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">requireGlobalLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// Do the same thing under either @GlobalTransactional or @GlobalLock, </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// that only check the global lock  here.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    statementProxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConnectionProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">checkLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lockKeys</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">RuntimeException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Unknown situation!"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">LockConflictException</span><span class="token plain"> lce</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sp </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rollback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rollback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// trigger retry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                lockRetryController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lce</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-submission-process">2. Submission Process<a href="https://seata.apache.org/blog/seata-at-lock#2-submission-process" class="hash-link" aria-label="Direct link to 2. Submission Process" title="Direct link to 2. Submission Process">​</a></h2>
<p>The submission process occurs in the doCommit method of ConnectionProxy.</p>
<ol>
<li>If the executed method is annotated with <code>@GlobalTransactional</code>, it will acquire the global lock during branch registration:</li>
</ol>
<ul>
<li>Requesting TC to register a branch</li>
</ul>
<p>io.seata.rm.datasource.ConnectionProxy#register</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">TransactionException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasUndoLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hasLockKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Long</span><span class="token plain"> branchId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">DefaultResourceManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">branchRegister</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BranchType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">AT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getDataSourceProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResourceId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getXid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">buildLockKeys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setBranchId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">branchId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>When a TC registers a branch, it obtains a global lock</li>
</ul>
<p>io.seata.server.transaction.at.ATCore#branchSessionLock</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">branchSessionLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">GlobalSession</span><span class="token plain"> globalSession</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">BranchSession</span><span class="token plain"> branchSession</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">TransactionException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">branchSession</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">BranchTransactionException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">LockKeyConflict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Global lock acquire failed xid = %s branchId = %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalSession</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getXid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                     branchSession</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBranchId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）If the execution method has a '@GlobalLock' annotation, the global lock is checked for existence before committing, and if it does, an exception is thrown:</p>
<p>io.seata.rm.datasource.ConnectionProxy#processLocalCommitWithGlobalLocks</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processLocalCommitWithGlobalLocks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">SQLException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">checkLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">buildLockKeys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        targetConnection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Throwable</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SQLException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="globallock-annotation-explanation">GlobalLock Annotation Explanation<a href="https://seata.apache.org/blog/seata-at-lock#globallock-annotation-explanation" class="hash-link" aria-label="Direct link to GlobalLock Annotation Explanation" title="Direct link to GlobalLock Annotation Explanation">​</a></h2>
<p>From the execution process and submission process, it can be seen that since opening a global transaction with the <code>@GlobalTransactional</code> annotation can check if the global lock exists before transaction submission, why does Seata still provide a <code>@GlobalLock</code> annotation?</p>
<p>This is because not all database operations require opening a global transaction, and opening a global transaction is a relatively heavy operation that involves initiating RPC processes to TC. The <code>@GlobalLock</code> annotation only checks the existence of the global lock during the execution process and does not initiate a global transaction. Therefore, when there is no need for a global transaction but the global lock needs to be checked to avoid dirty reads and writes, using the <code>@GlobalLock</code> annotation is a lighter operation.</p>
<h1>How to Prevent Dirty Writes</h1>
<p>Let's first understand how dirty writes occur when using Seata AT mode:</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20211226164628.png" alt="" class="img_ev3q"></p>
<p><em>Note: Other processes in the branch transaction execution are omitted.</em></p>
<p>When Business One starts a global transaction containing branch transaction A (modifying A) and branch transaction B (modifying B), Business Two modifies A. Business One's branch transaction A obtains a local lock before Business Two, waiting for Business One to complete the execution of branch transaction A. Business Two then obtains the local lock, modifies A, and commits it to the database. However, Business One encounters an exception during the execution of branch transaction A. Since the data of branch transaction A has been modified by Business Two, Business One's global transaction cannot be rolled back.</p>
<p>How to prevent dirty writes?</p>
<ol>
<li>Business Two uses <code>@GlobalTransactional</code> annotation:</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20211226210337.png" alt="" class="img_ev3q"></p>
<p><em>Note: Other processes in the branch transaction execution are omitted.</em></p>
<p>During the execution of the global transaction by Business Two, when registering the branch transaction before the submission of branch transaction A and acquiring the global lock, it finds that Business One's global lock has not been released yet. Therefore, Business Two cannot commit and throws an exception to roll back, thus preventing dirty writes.</p>
<ol start="2">
<li>Business Two uses <code>@GlobalLock</code> annotation:</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20211226210502.png" alt="" class="img_ev3q"></p>
<p><em>Note: Other processes in the branch transaction execution are omitted.</em></p>
<p>Similar to the effect of <code>@GlobalTransactional</code> annotation, but without the need to open a global transaction, it only checks the existence of the global lock before local transaction submission.</p>
<ol start="3">
<li>Business Two uses <code>@GlobalLock</code> annotation + <code>select for update</code> statement:</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20211226172358.png" alt="" class="img_ev3q"></p>
<p>If a <code>select for update</code> statement is added, it checks the existence of the global lock before the update operation. Business Two can only execute the updateA operation after the global lock is released.</p>
<p>If only <code>@Transactional</code> is used, there is a possibility of dirty writes. The fundamental reason is that without the GlobalLock annotation, the global lock is not checked, which may lead to another global transaction finding that a branch transaction has been modified when rolling back. Therefore, adding <code>select for update</code> also has a benefit, which is that it allows for retries.</p>
<h1>How to Prevent Dirty Reads</h1>
<p>Dirty reads in Seata AT mode refer to the scenario where data from a branch transaction that has been committed is read by another business before the global transaction is committed. Essentially, this is because Seata's default global transaction isolation level is read uncommitted.</p>
<p>So how to prevent dirty reads?</p>
<p>Business Two queries A with <code>@GlobalLock</code> annotation + <code>select for update</code> statement:</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20211226210633.png" alt="" class="img_ev3q"></p>
<p>Adding the <code>select for update</code> statement checks the existence of the global lock before executing the SQL. The SQL can only be executed after the global lock is acquired, thus preventing dirty reads.</p>
<h1>Author Bio:</h1>
<p>Zhang Chenghui currently works at Ant Group and is passionate about sharing technology. He is the author of the WeChat public account "后端进阶" (Backend Advancement) and the owner of the technical blog (<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>). He is also a Seata Contributor with GitHub ID: objcoding.</p>]]></content>
        <author>
            <name>chenghui.zhang</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Q&A on the New Version of Snowflake Algorithm]]></title>
        <id>https://seata.apache.org/blog/seata-snowflake-explain</id>
        <link href="https://seata.apache.org/blog/seata-snowflake-explain"/>
        <updated>2021-06-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In the previous analysis of the new version of the Snowflake algorithm, we mentioned two changes made in the new version:]]></summary>
        <content type="html"><![CDATA[<p>In the previous analysis of the new version of the Snowflake algorithm, we mentioned two changes made in the new version:</p>
<ol>
<li>The timestamp no longer constantly follows the system clock.</li>
<li>The exchange of positions between node ID and timestamp. From the original:
<img decoding="async" loading="lazy" alt="Original Bit Allocation Strategy" src="https://seata.apache.org/assets/images/before-8c52102c116e08f0b37d947b30008b58.png" width="904" height="156" class="img_ev3q">
to:
<img decoding="async" loading="lazy" alt="Improved Bit Allocation Strategy" src="https://seata.apache.org/assets/images/after-cad00baeb92d348340136601174c9d8c.png" width="900" height="157" class="img_ev3q"></li>
</ol>
<p>A careful student raised a question: In the new version, the algorithm is indeed monotonically increasing within a single node, but in a multi-instance deployment, it is no longer globally monotonically increasing! Because it is obvious that the node ID is in the high bits, so the generated ID with a larger node ID will definitely be greater than the ID with a smaller node ID, regardless of the chronological order. In contrast, the original algorithm, with the timestamp in the high bits and always following the system clock, can ensure that IDs generated earlier are smaller than those generated later. Only when two nodes happen to generate IDs at the same timestamp, the order of the two IDs is determined by the node ID. So, does it mean that the new version of the algorithm is wrong?</p>
<p>This is a great question! The fact that students can raise this question indicates a deep understanding of the essential differences between the standard Snowflake algorithm and the new version. This is commendable! Here, let's first state the conclusion: indeed, the new version of the algorithm does not possess global monotonicity, but this does not affect our original intention (to reduce database page splits). This conclusion may seem counterintuitive but can be proven.</p>
<p>Before providing the proof, let's briefly review some knowledge about page splits in databases. Taking the classic MySQL InnoDB as an example, InnoDB uses a B+ tree index where the leaf nodes of the primary key index also store the complete records of data rows. The leaf nodes are linked together in the form of a doubly linked list. The physical storage form of the leaf nodes is a data page, and each data page can store up to N rows of records (where N is inversely proportional to the size of each row). As shown in the diagram:
<img decoding="async" loading="lazy" alt="Data Page" src="https://seata.apache.org/assets/images/page1-09fa5360a09c5f6ce7e1c5978f370eb1.png" width="956" height="256" class="img_ev3q">
The characteristics of the B+ tree require that the left node should be smaller than the right node. What happens if we want to insert a record with an ID of 25 at this point (assuming each data page can only hold 4 records)? The answer is that it will cause a page split, as shown in the diagram:
<img decoding="async" loading="lazy" alt="Page Split" src="https://seata.apache.org/assets/images/page2-0ddae897017478780b7f338cca9daa02.png" width="1213" height="270" class="img_ev3q">
Page splits are unfriendly to I/O, requiring the creation of new data pages, copying and transferring part of the records from the old data page, etc., and should be avoided as much as possible.</p>
<p>Ideally, the primary key ID should be sequentially increasing (for example, setting the primary key as auto_increment). This way, a new page will only be needed when the current data page is full, and the doubly linked list will always grow sequentially at the tail, avoiding any mid-node splits.</p>
<p>In the worst-case scenario, if the primary key ID is randomly generated and unordered (for example, a UUID string in Java), new records will be randomly assigned to any data page. If the page is already full, it will trigger a page split.</p>
<p>If the primary key ID is generated by the standard Snowflake algorithm, in the best-case scenario, only one node is generating IDs within each timestamp. In this case, the algorithm's effect is equivalent to the ideal situation of sequential incrementation, similar to auto_increment. In the worst-case scenario, all nodes within each timestamp are generating IDs, and the algorithm's effect is close to unordered (but still much better than completely unordered UUIDs, as the workerId with only 10 bits limits the nodes to a maximum of 1024). In actual production, the algorithm's effectiveness depends on business traffic, and the lower the concurrency, the closer the algorithm is to the ideal scenario.</p>
<p>So, how does it fare with the new version of the algorithm?</p>
<p>The new version of the algorithm, from a global perspective, produces IDs in an unordered manner. However, for each workerId, the generated IDs are strictly monotonically increasing. Additionally, since workerId is finite, it can divide into a maximum of 1024 subsequences, each of which is monotonically increasing.</p>
<p>For a database, initially, the received IDs may be unordered, coming from various subsequences, as illustrated here:
<img decoding="async" loading="lazy" alt="Initial State" src="https://seata.apache.org/assets/images/page3-00bbd658b09cdde9b7cb39a0bd38fbe0.png" width="986" height="268" class="img_ev3q"></p>
<p>If, at this point, a worker1-seq2 arrives, it will clearly cause a page split:
<img decoding="async" loading="lazy" alt="First Split" src="https://seata.apache.org/assets/images/page4-883fee2cd79ec31b7f1d67c9e6362bca.png" width="1228" height="258" class="img_ev3q"></p>
<p>However, after the split, interesting things happen. For worker1, subsequent seq3, seq4 will not cause page splits anymore (because there is still space), and seq5 only needs to link to a new page for sequential growth (the difference is that this new page is not at the tail of the doubly linked list). Note that the subsequent IDs of worker1 will not be placed after any nodes from worker2 or beyond (thus avoiding page splits for later nodes) because they are always smaller than the IDs of worker2; nor will they be placed before the current node of worker1 (thus avoiding page splits for previous nodes) because the subsequences of worker1 are always monotonically increasing. Here, we refer to such subsequences as reaching a steady state, meaning that the subsequence has "stabilized," and its subsequent growth will only occur at the end of the subsequence without causing page splits for other nodes.</p>
<p>The same principle can be extended to all subsequences. Regardless of how chaotic the IDs received by the database are initially, after a finite number of page splits, the doubly linked list can always reach a stable state:
<img decoding="async" loading="lazy" alt="Steady State" src="https://seata.apache.org/assets/images/page5-24bcb08065fcf74b8e6a55b3c54e81b2.png" width="789" height="298" class="img_ev3q"></p>
<p>After reaching the steady state, subsequent IDs will only grow sequentially within their respective subsequences, without causing page splits. The difference between this sequential growth and the sequential growth of auto_increment is that the former has 1024 growth points (the ends of various subsequences), while the latter only has one at the end.</p>
<p>At this point, we can answer the question posed at the beginning: indeed, the new algorithm is not globally monotonically increasing, but the algorithm <strong>converges</strong>. After reaching a steady state, the new algorithm can achieve the same effect as global sequential incrementation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-considerations">Further Considerations<a href="https://seata.apache.org/blog/seata-snowflake-explain#further-considerations" class="hash-link" aria-label="Direct link to Further Considerations" title="Direct link to Further Considerations">​</a></h2>
<p>The discussion so far has focused on the continuous growth of sequences. However, in practical production, there is not only the insertion of new data but also the deletion of old data. Data deletion may lead to page merging (InnoDB, if it finds that the space utilization of two adjacent data pages is both less than 50%, it will merge them). How does this affect the new algorithm?</p>
<p>As we have seen in the above process, the essence of the new algorithm is to utilize early page splits to gradually separate different subsequences, allowing the algorithm to continuously converge to a steady state. Page merging, on the other hand, may reverse this process by merging different subsequences back into the same data page, hindering the convergence of the algorithm. Especially in the early stages of convergence, frequent page merging may even prevent the algorithm from converging forever (I just separated them, and now I'm merging them back together, back to square one~)! However, after convergence, only page merging at the end nodes of each subsequence has the potential to disrupt the steady state (merging the end node of one subsequence with the head node of the next subsequence). Merging on the remaining nodes of the subsequence does not affect the steady state because the subsequence remains ordered, albeit with a shorter length.</p>
<p>Taking Seata's server as an example, the data in the three tables of the server has a relatively short lifecycle. After a global transaction ends, the data is cleared. This is not friendly to the new algorithm, as it does not provide enough time for convergence. However, there is already a pull request (PR) for delayed deletion in the review process, and with this PR, the effect will be much better. For example, periodic weekly cleanup allows sufficient time for the algorithm to converge in the early stages, and for most of the time, the database can benefit from it. At the time of cleanup, the worst-case result is that the table is cleared, and the algorithm starts from scratch.</p>
<p>If you wish to apply the new algorithm to a business system, make sure to ensure that the algorithm has time to converge. For example, for user tables or similar, where data is intended to be stored for a long time, the algorithm can naturally converge. Alternatively, implement a mechanism for delayed deletion, providing enough time for the algorithm to converge.</p>
<p>If you have better opinions and suggestions, feel free to contact the Seata community!</p>]]></content>
        <author>
            <name>selfishlover</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Analysis of Seata's Distributed UUID Generator Based on Improved Snowflake Algorithm]]></title>
        <id>https://seata.apache.org/blog/seata-analysis-UUID-generator</id>
        <link href="https://seata.apache.org/blog/seata-analysis-UUID-generator"/>
        <updated>2021-05-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata incorporates a distributed UUID generator to assist in generating global transaction IDs and branch transaction IDs. The desired characteristics for this generator include high performance, global uniqueness, and trend incrementation.]]></summary>
        <content type="html"><![CDATA[<p>Seata incorporates a distributed UUID generator to assist in generating global transaction IDs and branch transaction IDs. The desired characteristics for this generator include high performance, global uniqueness, and trend incrementation.</p>
<p>High performance is self-explanatory, and global uniqueness is crucial to prevent confusion between different global transactions or branch transactions. Additionally, trend incrementation is valuable for users employing databases as the storage tool for TC clusters, as it can reduce the frequency of data page splits, thereby minimizing database IO pressure (the <code>branch_table</code> table uses the branch transaction ID as the primary key).</p>
<p>In the older version of Seata (prior to 1.4), the implementation of this generator was based on the standard version of the Snowflake algorithm. The standard Snowflake algorithm has been well-documented online, so we won't delve into it here. If you're unfamiliar with it, consider referring to existing resources before continuing with this article.</p>
<p>Here, we discuss some drawbacks of the standard Snowflake algorithm:</p>
<ol>
<li>
<p><strong>Clock Sensitivity:</strong> Since ID generation is always tied to the current operating system's timestamp (leveraging the monotonicity of time), a clock rollback may result in repeated IDs. Seata's strategy to handle this is by recording the last timestamp and rejecting service if the current timestamp is less than the recorded value (indicating a clock rollback). The service waits until the timestamp catches up with the recorded value. However, this means the TC will be in an unavailable state during this period.</p>
</li>
<li>
<p><strong>Burst Performance Limit:</strong> The standard Snowflake algorithm claims a high QPS, approximately 4 million/s. However, strictly speaking, this is a bit misleading. The timestamp unit of the algorithm is milliseconds, and the bit length allocated to the sequence number is 12, allowing for 4096 sequence spaces per millisecond. So, a more accurate description would be 4096/ms. The distinction between 4 million/s and 4096/ms lies in the fact that the former doesn't require every millisecond's concurrency to be below 4096. Seata also adheres to this limitation. If the sequence space for the current timestamp is exhausted, it will spin-wait for the next timestamp.</p>
</li>
</ol>
<p>In newer versions (1.4 and beyond), the generator has undergone optimizations and improvements to address these issues effectively. The core idea of the improvement is to decouple from the operating system's timestamp, with the generator obtaining the system's current timestamp only during initialization as the initial timestamp. Subsequently, it no longer synchronizes with the system timestamp. The incrementation is solely driven by the incrementation of the sequence number. For example, when the sequence number reaches its maximum value (4095), the next request causes an overflow of the 12-bit space. The sequence number resets to zero, and the overflow carry is added to the timestamp, incrementing it by 1. Thus, the timestamp and sequence number can be considered as a single entity. In practice, we adjusted the bit allocation strategy for the 64-bit ID, swapping the positions of the timestamp and node ID for easier handling of this overflow carry:</p>
<p>Original Bit Allocation Strategy:
<img decoding="async" loading="lazy" alt="Original Bit Allocation Strategy" src="https://seata.apache.org/assets/images/before-8c52102c116e08f0b37d947b30008b58.png" width="904" height="156" class="img_ev3q"></p>
<p>Modified Bit Allocation Strategy (swapping timestamp and node ID):
<img decoding="async" loading="lazy" alt="Modified Bit Allocation Strategy" src="https://seata.apache.org/assets/images/after-cad00baeb92d348340136601174c9d8c.png" width="900" height="157" class="img_ev3q"></p>
<p>This arrangement allows the timestamp and sequence number to be contiguous in memory, making it easy to use an <code>AtomicLong</code> to simultaneously store them.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * timestamp and sequence mix in one Long</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * highest 11 bit: not used</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * middle  41 bit: timestamp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * lowest  12 bit: sequence</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private AtomicLong timestampAndSequence;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The highest 11 bits can be determined during initialization and remain unchanged thereafter:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * business meaning: machine ID (0 ~ 1023)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * actual layout in memory:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * highest 1 bit: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * middle 10 bit: workerId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * lowest 53 bit: all 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private long workerId;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Producing an ID is then straightforward：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public long nextId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Obtain the incremented timestamp and sequence number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   long next = timestampAndSequence.incrementAndGet();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Extract the lowest 53 bits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   long timestampWithSequence = next &amp; timestampAndSequenceMask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Perform a bitwise OR operation with the previously saved top 11 bits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return workerId | timestampWithSequence;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At this point, we can observe the following:</p>
<ol>
<li>
<p>The generator no longer has a burst performance limit of 4096/ms. If the sequence number space for a timestamp is exhausted, it will directly advance to the next timestamp, "borrowing" the sequence number space of the next timestamp (there is no need to worry about serious consequences of this "advance consumption," as the reasons will be explained below).</p>
</li>
<li>
<p>The generator has a weak dependency on the operating system clock. During runtime, the generator is not affected by clock backtracking (whether it is manually backtracked or due to machine clock drift) because the generator only fetches the system clock once at startup, and thereafter, they no longer stay synchronized. The only possible scenario for duplicate IDs is a significant clock backtracking during restart (either deliberate human backtracking or modification of the operating system time zone, such as changing Beijing time to London time~ Machine clock drift is typically in the millisecond range and won't have such a large impact).</p>
</li>
<li>
<p>Will continuous "advance consumption" cause the generator's timestamps to be significantly ahead of the system timestamps, resulting in ID duplicates upon restart? In theory, yes, but practically almost impossible. To achieve this effect, it would mean that the generator's QPS received must be consistently stable at over 400w/s~ To be honest, even TC can't handle such high traffic, so, the bottleneck is definitely not in the generator.</p>
</li>
</ol>
<p>In addition, we also adjusted the strategy for generating node IDs. In the original version, when the user did not manually specify a node ID, it would take the low 10 bits of the local IPv4 address as the node ID. In practical production, it was found that there were occasional occurrences of duplicate node IDs (mostly users deploying with k8s). For example, the following IPs would result in duplicates:</p>
<ul>
<li>192.168.4.10</li>
<li>192.168.8.10</li>
</ul>
<p>Meaning, as long as the low 2 bits of the fourth byte and the third byte of the IP are the same, duplicates would occur. The new version's strategy is to prioritize taking the low 10 bits from the MAC address of the local network card. If the local machine does not have a valid network card configuration, it randomly picks one from [0, 1023] as the node ID. After this adjustment, it seems that new version users are no longer reporting the same issue (of course, it remains to be tested over time, but in any case, it won't be worse than the IP extraction strategy).</p>
<p>The above is a brief analysis of Seata's distributed UUID generator. If you find this generator useful, you can directly use it in your project. Its class declaration is <code>public</code>, and the full class name is:
<code>io.seata.common.util.IdWorker</code></p>
<p>Of course, if you have better ideas, you are also welcome to discuss them with the Seata community.</p>]]></content>
        <author>
            <name>selfishlover</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata New Feature Support -- Undo_Log Compression]]></title>
        <id>https://seata.apache.org/blog/seata-feature-undo-log-compress</id>
        <link href="https://seata.apache.org/blog/seata-feature-undo-log-compress"/>
        <updated>2021-05-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Current Situation & Pain Points]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="current-situation--pain-points">Current Situation &amp; Pain Points<a href="https://seata.apache.org/blog/seata-feature-undo-log-compress#current-situation--pain-points" class="hash-link" aria-label="Direct link to Current Situation &amp; Pain Points" title="Direct link to Current Situation &amp; Pain Points">​</a></h2>
<p>For Seata, it records the before and after data of DML operations to perform possible rollback operations, and stores this data in a blob field in the database. For batch operations such as insert, update, delete, etc., the number of affected rows may be significant, concatenated into a large field inserted into the database, which may lead to the following issues:</p>
<ol>
<li>Exceeding the maximum write limit for a single database operation (such as the <code>max_allowed_package</code> parameter in MySQL).</li>
<li>Significant network IO and database disk IO overhead due to a large amount of data.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="brainstorming">Brainstorming<a href="https://seata.apache.org/blog/seata-feature-undo-log-compress#brainstorming" class="hash-link" aria-label="Direct link to Brainstorming" title="Direct link to Brainstorming">​</a></h2>
<p>For the first issue, the <code>max_allowed_package</code> parameter limit can be increased based on the actual situation of the business to avoid the "query is too large" problem. For the second issue, increasing bandwidth and using high-performance SSD as the database storage medium can help.</p>
<p>The above solutions involve external or costly measures. Is there a framework-level solution to address the pain points mentioned above?</p>
<p>Considering the root cause of the pain points mentioned above, the problem lies in the generation of excessively large data fields. Therefore, if the corresponding data can be compressed at the business level before data transmission and storage, theoretically, it can solve the problems mentioned above.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="feasibility-analysis">Feasibility Analysis<a href="https://seata.apache.org/blog/seata-feature-undo-log-compress#feasibility-analysis" class="hash-link" aria-label="Direct link to Feasibility Analysis" title="Direct link to Feasibility Analysis">​</a></h2>
<p>Combining the brainstorming above, in practical development, when large batch operations are required, they are often scheduled during periods of relatively low user activity and low concurrency. At such times, CPU and memory resources can be relatively more utilized to quickly complete the corresponding operations. Therefore, by consuming CPU and memory resources to compress rollback data, the size of data transmission and storage can be reduced.</p>
<p>At this point, two things need to be demonstrated:</p>
<ol>
<li>After compression, it can reduce the pressure on network IO and database disk IO. This can be measured by the total time taken for data compression + storage in the database.</li>
<li>After compression, the efficiency of compression compared to the original data size. This can be measured by the data size before and after compression.</li>
</ol>
<p>Testing the time spent on compressing network usage:</p>
<p><img decoding="async" loading="lazy" src="https://user-images.githubusercontent.com/22959373/95567752-f55ddf80-0a55-11eb-8092-1f1d99855bdd.png" alt="image" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="compression-ratio-test">Compression Ratio Test:<a href="https://seata.apache.org/blog/seata-feature-undo-log-compress#compression-ratio-test" class="hash-link" aria-label="Direct link to Compression Ratio Test:" title="Direct link to Compression Ratio Test:">​</a></h2>
<p><img decoding="async" loading="lazy" src="https://user-images.githubusercontent.com/22959373/95567834-0ad30980-0a56-11eb-9d7e-48b74babbea4.png" alt="image" class="img_ev3q"></p>
<p>The test results clearly indicate that using gzip or zip compression can significantly reduce the pressure on the database and network transmission. At the same time, it can substantially decrease the size of the stored data.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">Implementation<a href="https://seata.apache.org/blog/seata-feature-undo-log-compress#implementation" class="hash-link" aria-label="Direct link to Implementation" title="Direct link to Implementation">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-approach">Implementation Approach<a href="https://seata.apache.org/blog/seata-feature-undo-log-compress#implementation-approach" class="hash-link" aria-label="Direct link to Implementation Approach" title="Direct link to Implementation Approach">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://user-images.githubusercontent.com/22959373/116281711-8f039900-a7bc-11eb-91f8-82afdbb9f932.png" alt="Compression" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="partial-code">Partial Code<a href="https://seata.apache.org/blog/seata-feature-undo-log-compress#partial-code" class="hash-link" aria-label="Direct link to Partial Code" title="Direct link to Partial Code">​</a></h4>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Whether to enable undo_log compression, default is true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seata.client.undo.compress.enable=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Compressor type, default is zip, generally recommended to be zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seata.client.undo.compress.type=zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Compression threshold for enabling compression, default is 64k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seata.client.undo.compress.threshold=64k</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Determining Whether the Undo_Log Compression Feature is Enabled and if the Compression Threshold is Reached</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">needCompress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> undoLogContent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 1. Check whether undo_log compression is enabled (1.4.2 Enabled by Default).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 2. Check whether the compression threshold has been reached (64k by default).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// If both return requirements are met, the corresponding undoLogContent is compressed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ROLLBACK_INFO_COMPRESS_ENABLE</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> undoLogContent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ROLLBACK_INFO_COMPRESS_THRESHOLD</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Initiating Compression for Undo_Log After Determining the Need</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// If you need to compress, compress undo_log</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">needCompress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">undoLogContent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Gets the compression type, default zip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compressorType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ROLLBACK_INFO_COMPRESS_TYPE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//Get the corresponding compressor and compress it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    undoLogContent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CompressorFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCompressor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compressorType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">compress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">undoLogContent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// else does not need to compress and does not need to do anything</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Save the compression type synchronously to the database for use when rolling back:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">CompressorType</span><span class="token plain"> compressorType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HashMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UndoLogConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SERIALIZER_KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Save the compression type to the database</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UndoLogConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">COMPRESSOR_TYPE_KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> compressorType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">CollectionUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">encodeMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Decompress the corresponding information when rolling back:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getRollbackInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ResultSet</span><span class="token plain"> rs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">SQLException</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Gets a byte array of rollback information saved to the database</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> rollbackInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ClientTableColumnsName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">UNDO_LOG_ROLLBACK_INFO</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Gets the compression type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// getOrDefault uses the default value CompressorType.NONE to directly upgrade 1.4.2+ to compatible versions earlier than 1.4.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">String</span><span class="token plain"> rollbackInfoContext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ClientTableColumnsName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">UNDO_LOG_CONTEXT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CollectionUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decodeMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rollbackInfoContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">CompressorType</span><span class="token plain"> compressorType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CompressorType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getByName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getOrDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UndoLogConstants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">COMPRESSOR_TYPE_KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">CompressorType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NONE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the corresponding compressor and uncompress it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">CompressorFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCompressor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compressorType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decompress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rollbackInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="peroration">peroration<a href="https://seata.apache.org/blog/seata-feature-undo-log-compress#peroration" class="hash-link" aria-label="Direct link to peroration" title="Direct link to peroration">​</a></h3>
<p>By compressing undo_log, Seata can further improve its performance when processing large amounts of data at the framework level. At the same time, it also provides the corresponding switch and relatively reasonable default value, which is convenient for users to use out of the box, but also convenient for users to adjust according to actual needs, so that the corresponding function is more suitable for the actual use scenario.</p>]]></content>
        <author>
            <name>chd</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Deadlock Issue Caused by ConcurrentHashMap]]></title>
        <id>https://seata.apache.org/blog/seata-dsproxy-deadlock</id>
        <link href="https://seata.apache.org/blog/seata-dsproxy-deadlock"/>
        <updated>2021-03-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article primarily discusses an online issue, a Seata dynamic data source proxy deadlock caused by a ConcurrentHashMap bug.]]></summary>
        <content type="html"><![CDATA[<ol>
<li>seata version: 1.4.0, but all versions below 1.4 also have this problem.</li>
<li>Problem description: In a global transaction, a pure query operation on a branch transaction suddenly gets stuck without any feedback (logs/exceptions) until the RPC timeout on the consumer side</li>
</ol>
<p>! <a href="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03a7f737b56e45b4b74e662033ec74f6~tplv-k3u1fbpfcp-watermark.image" target="_blank" rel="noopener noreferrer">image.png</a></p>
<h1>Problem Troubleshooting</h1>
<ol>
<li>The whole process is in a global transaction, the consumer and provider can be seen as two branches of the global transaction, consumer --&gt; provider.</li>
<li>the consumer first executes some local logic, and then sends an RPC request to the provider to make sure that the consumer has sent the request and the provider has received it.</li>
<li>the provider first prints a log, and then executes a pure query SQL, if the SQL is executed properly, it will print the log, but the current phenomenon is that only the log before the execution of the SQL is printed, and no SQL-related logs are printed. Find DBA to check the SQL log, and found that the SQL is not executed.</li>
<li>Determined that the operation is only a pure query operation under the global transaction, before the operation, the overall process of the global transaction is completely normal.</li>
<li>In fact, the phenomenon here has been very obvious, but at that time the idea did not change over, has been concerned about the query SQL, always thinking that even if the query timeout and other reasons should be thrown exceptions ah, should not be nothing. DBA can not find the query record, that is not to say that the SQL may not have been executed ah, but in the execution of the SQL before the problem, such as the agent?</li>
<li>With the help of arthas's watch command, there is no output. The first log output means that the method must have been executed, and the delay in outputting the result means that the current request is stuck, why is it stuck?</li>
<li>With arthas's thread command <code>thread -b</code>, <code>thread -n</code>, is to find out the current busiest thread. This works very well, there is a thread CPU usage <code>92%</code>, and because of this thread caused the other 20 or so Dubbo threads <code>BLOCKED</code>. The stack information is as follows</li>
<li>Analysing the stack information, we can clearly find the interface related to seata, which is probably related to seata's data source proxy; at the same time, we found that the thread with the highest CPU usage is stuck in the <code>ConcurrentHashMap#computeIfAbsent</code> method. Is there a bug in the <code>ConcurrentHashMap#computeIfAbsent</code> method?</li>
<li>By now, we don't know the exact cause of the problem, but it should have something to do with seata's data source proxy, and we need to analyse both the business code and the seata code to find out why.</li>
</ol>
<p>! <a href="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/faac0be0982e45a7a43b335e8f8b44bf~tplv-k3u1fbpfcp-watermark.image" target="_blank" rel="noopener noreferrer">image.png</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="problem-analysis">Problem analysis<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#problem-analysis" class="hash-link" aria-label="Direct link to Problem analysis" title="Direct link to Problem analysis">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="concurrenthashmapcomputeifabsent">ConcurrentHashMap##computeIfAbsent<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#concurrenthashmapcomputeifabsent" class="hash-link" aria-label="Direct link to ConcurrentHashMap##computeIfAbsent" title="Direct link to ConcurrentHashMap##computeIfAbsent">​</a></h3>
<p>This method does have the potential for problems: if two keys have the same hascode, and the computeIfAbsent operation is performed in the corresponding mappingFunction, it will lead to a dead loop, refer to this article for specific analysis: <a href="https://juejin.cn/post/" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/</a> 6844904191077384200</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-data-source-autoproxy">Seata data source autoproxy<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#seata-data-source-autoproxy" class="hash-link" aria-label="Direct link to Seata data source autoproxy" title="Direct link to Seata data source autoproxy">​</a></h3>
<p>Related content has been analysed before, let's focus on the following core classes:</p>
<ol>
<li>SeataDataSourceBeanPostProcessor</li>
<li>SeataAutoDataSourceProxyAdvice</li>
<li>DataSourceProxyHolder</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="seatadatasourcebeanpostprocessor">SeataDataSourceBeanPostProcessor<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#seatadatasourcebeanpostprocessor" class="hash-link" aria-label="Direct link to SeataDataSourceBeanPostProcessor" title="Direct link to SeataDataSourceBeanPostProcessor">​</a></h5>
<p>The <code>SeataDataSourceBeanPostProcessor</code> is a <code>BeanPostProcessor</code> implementation class that creates a <code>seataAutoDataSourceProxyDataSource</code> for the data source configured by the business side in the <code>postProcessAfterInitialization</code> method (i.e., after the bean is initialised). proxy data source</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SeataDataSourceBeanPostProcessor</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">BeanPostProcessor</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">postProcessAfterInitialization</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Object</span><span class="token plain"> bean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> beanName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">BeansException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bean </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">DataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//When not in the excludes, put and init proxy. if (!excludes.contains.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">excludes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bean</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//Only put and init proxy, not return proxy.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">DataSourceProxyHolder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">putDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> bean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataSourceProxyMode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//If is SeataDataSourceProxy, return the original data source.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bean </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">SeataDataSourceProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Unwrap the bean of the data source,"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">" and return the original data source to replace the data source proxy."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SeataDataSourceProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SeataDataSourceProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> bean</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTargetDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> bean</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="seataautodatasourceproxyadvice">SeataAutoDataSourceProxyAdvice<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#seataautodatasourceproxyadvice" class="hash-link" aria-label="Direct link to SeataAutoDataSourceProxyAdvice" title="Direct link to SeataAutoDataSourceProxyAdvice">​</a></h5>
<p><code>SeataAutoDataSourceProxyAdvice</code> is a MethodInterceptor, <code>SeataAutoDataSourceProxyCreator</code> in seata creates a dynamic proxy object for <code>Bean</code> of type <code>DataSource</code>, the proxy logic is the <code>SeataAutoDataSourceProxyAdvice#invoke</code> logic. That is: when executing the relevant methods of the <code>DataSourceAOPProxyAdvice</code>, it will go through its <code>invoke</code> method, and in the <code>invoke</code> method, it will find the corresponding <code>SeataAutoDataSourceProxyAdvice</code> according to the native data source, which will ultimately execute the <code>SeataAutoDataSourceProxyAdvice</code> logic.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SeataAutoDataSourceProxyAdvice</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">MethodInterceptor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">IntroductionInfo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MethodInvocation</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Throwable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token class-name">RootContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">requireGlobalLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> dataSourceProxyMode </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">RootContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBranchType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">proceed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token class-name">Method</span><span class="token plain"> method </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getArguments</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token class-name">Method</span><span class="token plain"> m </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">BeanUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token class-name">Method</span><span class="token plain"> m </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">BeanUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findDeclaredMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSourceProxyClazz</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getParameterTypes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token class-name">SeataDataSourceProxy</span><span class="token plain"> dataSourceProxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">DataSourceProxyHolder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">putDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getThis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataSourceProxyMode </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSourceProxyHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSourceProxy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">proceed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="datasourceproxyholder">DataSourceProxyHolder<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#datasourceproxyholder" class="hash-link" aria-label="Direct link to DataSourceProxyHolder" title="Direct link to DataSourceProxyHolder">​</a></h5>
<p>The process is clear to us, now there is a question, how to maintain the relationship between <code>native data source</code> and <code>seata proxy data source</code>? It is maintained by <code>DataSourceProxyHolder</code>, which is a singleton object that maintains the relationship between the two through a ConcurrentHashMap: <code>native data source</code> as key --&gt; <code>seata proxy data source</code> as value.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">DataSourceProxyHolder</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">SeataDataSourceProxy</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">putDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DataSource</span><span class="token plain"> dataSource</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">BranchType</span><span class="token plain"> dataSourceProxyMode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">DataSource</span><span class="token plain"> originalDataSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dataSource</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">CollectionUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataSourceProxyMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> originalDataSource</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">BranchType</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token class-name">BranchType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">XA</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> dataSourceProxyMode </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token class-name">DataSourceProxyXA</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">DataSourceProxy</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">new</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// CollectionUtils.java</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">K</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">V</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">V</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">K</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">V</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">K</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Function</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics"> </span><span class="token generics keyword" style="color:#00009f">super</span><span class="token generics"> </span><span class="token generics class-name">K</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics"> </span><span class="token generics keyword" style="color:#00009f">extends</span><span class="token generics"> </span><span class="token generics class-name">V</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> mappingFunction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">V</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mappingFunction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="client-data-source-configuration">Client data source configuration<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#client-data-source-configuration" class="hash-link" aria-label="Direct link to Client data source configuration" title="Direct link to Client data source configuration">​</a></h3>
<ol>
<li>Two data sources are configured: <code>DynamicDataSource</code>, <code>P6DataSource</code>, <code>P6DataSource</code>, <code>P6DataSource</code> and <code>P6DataSource</code>.</li>
<li><code>P6DataSource</code> can be seen as a wrapper for <code>DynamicDataSource</code>. 3.</li>
<li>Let's not worry about whether this configuration makes sense or not, now we just analyse the problem purely based on this data source configuration.</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Qualifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"dsMaster"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"dsMaster"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">DynamicDataSource</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dsMaster</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DynamicDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">masterDsRoute</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Primary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Qualifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"p6DataSource"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"p6DataSource"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">P6DataSource</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">p6DataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@Qualifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"dsMaster"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">DataSource</span><span class="token plain"> dataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token class-name">P6DataSource</span><span class="token plain"> p6DataSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">P6DataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">dsMaster</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> p6DataSource</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="analyse-the-process">Analyse the process<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#analyse-the-process" class="hash-link" aria-label="Direct link to Analyse the process" title="Direct link to Analyse the process">​</a></h3>
<p><code>Assuming that by now everyone is aware of the problems that may arise from ConcurrentHashMap#computeIfAbsent</code>, it is known that this problem has now arisen, and in combination with the stack information, we can see roughly where this problem has arisen.</p>
<p>1, <code>ConcurrentHashMap#computeIfAbsent</code> will produce this problem precondition is: <code>two key hashcode is the same</code>; <code>mappingFunction corresponds to a put operation</code>. Combined with our seata usage scenario, the mappingFunction corresponds to <code>DataSourceProxy::new</code>, suggesting that the put operation may be triggered in the DataSourceProxy's constructor method</p>
<p>! <a href="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/00d8e13f71644c63b3bbb58c93b30e0c~tplv-k3u1fbpfcp-watermark.image" target="_blank" rel="noopener noreferrer">image.png</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Execute</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AOP</span><span class="token plain"> proxy data source related methods </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Enter</span><span class="token plain"> </span><span class="token class-name">SeataAutoDataSourceProxyAdvice</span><span class="token plain"> cutover logic </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Execute</span><span class="token plain"> </span><span class="token class-name">DataSourceProxyHolder</span><span class="token plain">#putDataSource method </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Execute</span><span class="token plain"> </span><span class="token class-name">DataSourceProxy</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">AOP</span><span class="token plain"> proxy data source's getConnection method </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">The</span><span class="token plain"> getConnection method of the </span><span class="token keyword" style="color:#00009f">native</span><span class="token plain"> data source </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Enter</span><span class="token plain"> </span><span class="token class-name">SeataAutoDataSourceProxyAdvice</span><span class="token plain"> cutover logic </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Execute</span><span class="token plain"> </span><span class="token class-name">DataSourceProxyHolder</span><span class="token plain">#putDataSource method </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Execute</span><span class="token plain"> </span><span class="token class-name">DataSourceProxy</span><span class="token operator" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">DuridDataSource</span><span class="token plain">'s getConnection method</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2, What is the <code>AOP proxy data source</code> and <code>native data source</code> stated in step 1? Look at the following diagram
! <a href="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3579631f58df4d17bfcd6f28ccc3fd79~tplv-k3u1fbpfcp-watermark.image" target="_blank" rel="noopener noreferrer">image.png</a></p>
<p>3, the above also said to produce this problem there is a condition <code>two key hashcode the same</code>, but I see that these two data source objects are not overriding the <code>hashcode</code> method, so by definition, these two objects must be different hashcode. After looking at the ConcurrentHashMap problem again, I feel that the statement <code>two keys have the same hashcode</code> is not correct, and <code>two keys will generate hash conflict</code> is more reasonable, which explains why two objects with different hashcodes will encounter this problem. To prove this, I've given an example below.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Test</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ConcurrentHashMap</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ConcurrentHashMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token plain"> n1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Num</span><span class="token plain"> n1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Num</span><span class="token plain"> n2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token plain"> n3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token plain"> n3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Num</span><span class="token plain"> n3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// map.computeIfAbsent(n1, k1 -&gt; map.computeIfAbsent(n3, k2 -&gt; 200)); // This line of code does not cause the program to loop.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k1 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k2 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// this line of code will cause the program to die</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hashCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hashCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hashCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>To make it easier to reproduce the problem, we rewrite the <code>Num#hashCode</code> method to ensure that the constructor input is the hashcode value.</li>
<li>create a ConcurrentHashMap object, initialCapacity is 8, sizeCtl calculated value is 16, that is, the default length of the array in the map is 16</li>
<li>create object <code>n1</code>, the input parameter is 3, that is, the hashcode is 3, the calculation of its corresponding array subscript 3</li>
<li>create object <code>n2</code>, the input parameter is 19, that is, the hashcode is 19, calculate its corresponding array subscript is 3, at this time we can think of <code>n1 and n2 hash conflict</code>.</li>
<li>create object <code>n3</code> with input 20, i.e., hashcode 20, and its corresponding array subscript is 4.</li>
<li>execute <code>map.computeIfAbsent(n1, k1 -&gt; map.computeIfAbsent(n3, k2 -&gt; 200))</code>, the programme exits normally: <code>Because there is no hash conflict between n1 and n3, the programme terminates normally</code>.</li>
<li>Execute <code>map.computeIfAbsent(n1, k1 -&gt; map.computeIfAbsent(n2, k2 -&gt; 200))</code>, the programme exits normally: <code> because n1 and n2 have a hash conflict, so it is in a dead loop</code>.</li>
</ol>
<p>4、During the initialisation of the object, hasn't <code>SeataDataSourceBeanPostProcessor</code> already initialised the corresponding data source proxy of the object? Why the corresponding data source proxy is still created in <code>SeataAutoDataSourceProxyAdvice</code>?</p>
<ol>
<li>First of all, the <code>SeataDataSourceBeanPostProcessor</code> execution period is later than the creation of the AOP proxy object, so when executing the <code>SeataDataSourceBeanPostProcessor</code> related methods, the <code>SeataAutoDataSourceBeanPostProcessor</code> method is executed. SeataAutoDataSourceProxyAdvice<code>should actually take effect when the</code>SeataDataSourceBeanPostProcessor` related methods are executed.</li>
<li>when adding elements to the map in <code>SeataDataSourceBeanPostProcessor</code>, the key is <code>AOP proxy datasource</code>; in <code>SeataAutoDataSourceProxyAdvice</code>, the key is <code>native datasource</code>, so the key is not the same as <code>invocation.getThis()</code>, so the key is not the same. `, so the key is not the same</li>
</ol>
<p>! <a href="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/747b664a0b6c4f58843947576dd0856e~tplv-k3u1fbpfcp-watermark.image" target="_blank" rel="noopener noreferrer">image.png</a></p>
<p>5, there is another problem, <code>SeataAutoDataSourceProxyAdvic#invoke</code> method does not filter <code>toString, hashCode</code> and other methods, the proxy object created by cglib will override these methods by default, if these methods of the proxy object are triggered when putting elements into the map. If these methods are triggered when putting elements into the map, the proxy object will re-enter the <code>SeataAutoDataSourceProxyAdvic#invoke</code> cut until the thread stack benefits.</p>
<h1>Summary of the problem</h1>
<ol>
<li>in two key will produce hash conflict, will trigger <code>ConcurrentHashMap#computeIfAbsent</code> BUG, the performance of this BUG is to make the current thread into a dead loop</li>
<li>business feedback, the problem is occasional, occasional for two reasons: first, the application is a multi-node deployment, but only one node on the line triggered the BUG (hashcode conflict), so only when the request hits this node may trigger the BUG; second, because each restart object address (hashcode) are not sure, so not triggered after every app restart, but if once triggered, the node will always have this problem. Having a thread that keeps dying and blocking other threads that are trying to get the proxy data source from the map is business feedback that the request is stuck. If this happens to successive requests, the business side may restart the service, and then, ``because the hash conflict does not necessarily exist after the restart, the business may behave normally after the restart, but it is also possible that the bug will be triggered again on the next restart.</li>
<li>when encountering this problem, from the perspective of the whole problem, it is indeed a deadlock, because the dead loop thread occupant lock has not been released, resulting in other threads operating on the map is BLOCKED!</li>
<li>essentially because <code>ConcurrentHashMap#computeIfAbsent method may trigger a bug</code>, and seata's usage scenario just triggered the bug.</li>
<li>The following demo is actually a complete simulation of what happens when something goes wrong online, as follows:</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Test</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token class-name">ConcurrentHashMap</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ConcurrentHashMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token class-name">Num</span><span class="token plain"> n1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token class-name">Num</span><span class="token plain"> n2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">for</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k1 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k2 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hashCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hashCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hashCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>! <a href="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d6134c6498fa49c4a68b2745ba0895e3~tplv-k3u1fbpfcp-watermark.image" target="_blank" rel="noopener noreferrer">image.png</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="solving-the-problem">Solving the problem<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#solving-the-problem" class="hash-link" aria-label="Direct link to Solving the problem" title="Direct link to Solving the problem">​</a></h3>
<p>The problem can be solved in two ways:</p>
<ol>
<li>business changes: P6DataSource and DynamicDataSource do not need to be proxied, directly proxy P6DataSource can be, DynamicDataSource does not need to be declared as a bean; or through the excludes property excludes P6DataSource, so that there is no duplicate proxy problem. There will be no problem of duplicate proxies</li>
<li>Seata refinement: improve the logic related to data source proxy</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="business-changes">Business changes<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#business-changes" class="hash-link" aria-label="Direct link to Business changes" title="Direct link to Business changes">​</a></h5>
<ol>
<li>Data source related configuration can be changed to the following:</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Primary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Qualifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"p6DataSource"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"p6DataSource"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">P6DataSource</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">p6DataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@Qualifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"dsMaster"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">DataSource</span><span class="token plain"> dataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token class-name">P6DataSource</span><span class="token plain"> p6DataSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">P6DataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">TuYaDynamicDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">masterDsRoute</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">warn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"dsMaster={}, hashcode={}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">p6DataSource</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p6DataSource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hashCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> p6DataSource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>Or leave the current data source configuration unchanged and add the excludes property</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@EnableAutoDataSourceProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">excludes</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"P6DataSource"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="seata-refinement">Seata refinement<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#seata-refinement" class="hash-link" aria-label="Direct link to Seata refinement" title="Direct link to Seata refinement">​</a></h5>
<ol>
<li><code>ConcurrentHashMap#computeIfAbsent</code> method is changed to double check as follows:</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">SeataDataSourceProxy</span><span class="token plain"> dsProxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dataSourceProxyMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">originalDataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dsProxy </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">synchronized</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSourceProxyMap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       dsProxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dataSourceProxyMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">originalDataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dsProxy </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           dsProxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createDsProxyByMode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSourceProxyMode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> originalDataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           dataSourceProxyMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">originalDataSource</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dsProxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> dsProxy</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I wanted to change the <code>CollectionUtils#computeIfAbsent</code> method directly, and the feedback from the group was that this might cause the data source to be created multiple times, which is indeed a problem: as follows</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">K</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">V</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">V</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">K</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">V</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">K</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Function</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics"> </span><span class="token generics keyword" style="color:#00009f">super</span><span class="token generics"> </span><span class="token generics class-name">K</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics operator" style="color:#393A34">?</span><span class="token generics"> </span><span class="token generics keyword" style="color:#00009f">extends</span><span class="token generics"> </span><span class="token generics class-name">V</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> mappingFunction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">V</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mappingFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>Add some filtering to the SeataAutoDataSourceProxyAdvice cutout logic</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Method</span><span class="token plain"> m </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">BeanUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findDeclaredMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSourceProxyClazz</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getParameterTypes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token class-name">DataSource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isAssignableFrom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDeclaringClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token class-name">SeataDataSourceProxy</span><span class="token plain"> dataSourceProxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">DataSourceProxyHolder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">putDataSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getThis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataSourceProxyMode </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSourceProxyHolder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataSourceProxy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> invocation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">proceed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="legacy-issues">Legacy issues<a href="https://seata.apache.org/blog/seata-dsproxy-deadlock#legacy-issues" class="hash-link" aria-label="Direct link to Legacy issues" title="Direct link to Legacy issues">​</a></h3>
<p>In the corresponding methods of <code>SeataDataSourceBeanPostProcessor</code> and <code>SeataAutoDataSourceProxyAdvice</code>, the keys corresponding to initialising the <code>seata datasource proxy</code> into the map are fundamentally different, the <code>The key in</code>SeataDataSourceBeanPostProcessor<code>is the</code>AOP proxy data source<code>; the key in </code>SeataAutoDataSourceProxyAdvice<code>is the native object, which results in the unnecessary creation of the</code>seata data source proxy` object.</p>
<p>What is the best suggestion for this problem? Is it possible to specify an order for <code>SeataDataSourceBeanPostProcessor</code> to take effect before the AOP proxy object is created?</p>
<h1>Link to original article</h1>
<p><a href="https://juejin.cn/post/6939041336964153352/" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6939041336964153352/</a></p>]]></content>
        <author>
            <name>xiaoyong.luo</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Application-Side Startup Process Analysis — Registry and Configuration Module]]></title>
        <id>https://seata.apache.org/blog/seata-client-start-analysis-02</id>
        <link href="https://seata.apache.org/blog/seata-client-start-analysis-02"/>
        <updated>2021-03-04T01:35:01.000Z</updated>
        <summary type="html"><![CDATA["Just getting started with Seata and don't know enough about its modules?]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p>"Just getting started with Seata and don't know enough about its modules? <br>
Want to dive into the Seata source code, but haven't done so yet? <br>
Want to find out what your application is doing "on the sly" during startup after integrating Seata? <br>
Want to learn the design concepts and best practices of Seata as a great open source framework? <br>
If any of the above apply to you, then today's article is for you!</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="preface">Preface<a href="https://seata.apache.org/blog/seata-client-start-analysis-02#preface" class="hash-link" aria-label="Direct link to Preface" title="Direct link to Preface">​</a></h2>
<p>In Seata's application-side (RM, TM) startup process, the first thing to do is to establish communication with the coordinator side (TC), which is a prerequisite for Seata to be able to complete the distributed transaction coordination, so Seata in the process of completing the initialisation of the application side and establishing a connection with the TC, it is <strong>How to find the cluster and address of the TC Transaction Coordinator</strong>? And how does it <strong>get various configuration information</strong> from the configuration module? That's what this article is going to explore.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="give-a-qualification">Give a qualification<a href="https://seata.apache.org/blog/seata-client-start-analysis-02#give-a-qualification" class="hash-link" aria-label="Direct link to Give a qualification" title="Direct link to Give a qualification">​</a></h2>
<p>Seata as a middleware level of the underlying components, is very careful to introduce third-party frameworks for specific implementations, interested students can learn more about Seata's SPI mechanism, to see how Seata is through a large number of extension points (Extension), to invert the specific implementation of the dependent components out of the turn rely on abstract interfaces, and at the same time, Seata in order to better At the same time, Seata in order to better integrate into microservices, cloud native and other popular architectures derived from the ecosystem, but also based on the SPI mechanism on a number of mainstream microservice frameworks, registry, configuration centre and Java development frameworks, "the leader" - SpringBoot and so on. Do the active integration , in order to ensure that the microkernel architecture , loosely coupled , scalable at the same time , but also can be very good with all kinds of components "to play with", so that the environment using a variety of technology stacks can be more convenient to introduce Seata.</p>
<p>In this paper, in order to be close to everyone ** just introduced Seata trial ** scene , in the following introduction , select ** application side ** qualifications are as follows : the use of **File (file) as the configuration centre and registration centre **, and based on ** SpringBoot ** start.</p>
<p>With this qualification, let's dive into the Seata source code and find out what's going on.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rmtm-initialisation-process-with-alternating-multi-module-collaboration">RM/TM Initialisation Process with Alternating Multi-Module Collaboration<a href="https://seata.apache.org/blog/seata-client-start-analysis-02#rmtm-initialisation-process-with-alternating-multi-module-collaboration" class="hash-link" aria-label="Direct link to RM/TM Initialisation Process with Alternating Multi-Module Collaboration" title="Direct link to RM/TM Initialisation Process with Alternating Multi-Module Collaboration">​</a></h2>
<p>In <a href="http://booogu.top/2021/02/28/seata-client-start-analysis-01/" target="_blank" rel="noopener noreferrer"> Seata Client Startup Process Dissection (I) </a>, we analysed the initialization of TM and RM on the application side of Seata, and how the application side creates a Netty Channel and sends a registration request to the TC Server to send a registration request. In addition to this, during RM initialisation, several other Seata modules (Registration Centre, Configuration Centre, Load Balancing) come into play and collaborate with each other to complete the process of connecting to the TC Server.</p>
<p>When executing the Client reconnect to TC Server method: NettyClientChannelManager.Channreconnect(), you first need to get the list of available TC Server addresses based on the current <strong>transaction grouping</strong>:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     * NettyClientChannelManager.reconnect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     * Reconnect to remote server of current transaction service group.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">*</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">transactionServiceGroup</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> transaction service group</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter known-class-name class-name">String</span><span class="token parameter"> transactionServiceGroup</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">List</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token known-class-name class-name">String</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> availList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Get the available TC Server addresses from the registry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">availList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getAvailServerList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transactionServiceGroup</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Failed to get available servers: {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token comment" style="color:#999988;font-style:italic">// Get the available TC Server addresses from the registry.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// The following code is omitted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For a detailed introduction to the concept of transaction grouping, you can refer to the official document <a href="https://seata.apache.org/docs/user/txgroup/transaction-group/">Introduction to Transaction Grouping</a>. Here is a brief introduction.</p>
<ul>
<li>Each Seata application-side RM, TM, has a <strong>transaction grouping</strong> name</li>
<li>Each TC on the Seata coordinator side has a <strong>cluster name</strong> and <strong>address</strong>.
The application side goes through the following two steps when connecting to the coordinator side:</li>
<li>Through the name of the transaction grouping, the cluster name of the TC corresponding to this application side is obtained from the configuration</li>
<li>By using the cluster name, the address list of the TC cluster can be obtained from the registry.
The above concepts, relationships and processes are shown in the following figure:
! <a href="http://booogu.top/img/in-post/TXGroup_Group_Relation.jpg" target="_blank" rel="noopener noreferrer">Relationship between Seata transaction grouping and connection establishment</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="getting-tc-server-cluster-addresses-from-registry">Getting TC Server cluster addresses from <strong>Registry</strong><a href="https://seata.apache.org/blog/seata-client-start-analysis-02#getting-tc-server-cluster-addresses-from-registry" class="hash-link" aria-label="Direct link to getting-tc-server-cluster-addresses-from-registry" title="Direct link to getting-tc-server-cluster-addresses-from-registry">​</a></h3>
<p>After understanding the main concepts and steps involved in connecting TCs from RM/TC, let's move on to explore the getAvailServerList method:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token maybe-class-name">List</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token known-class-name class-name">String</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getAvailServerList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">String</span><span class="token plain"> transactionServiceGroup</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> throws </span><span class="token maybe-class-name">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//① Use the registry factory to get a registry instance.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//② Call the registry's lookup method lookUp() to get a list of the addresses of the available Servers in the TC cluster based on the transaction group name.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">List</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">InetSocketAddress</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> availInetSocketAddressList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">RegistryFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">lookup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transactionServiceGroup</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">CollectionUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">availInetSocketAddressList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token maybe-class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">emptyList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> availInetSocketAddressList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">NetUtil</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">toStringAddress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">collect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Collectors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="which-registry-to-use-the-seata-meta-configuration-file-gives-the-answer">Which registry to use? The <strong>Seata meta-configuration file</strong> gives the answer<a href="https://seata.apache.org/blog/seata-client-start-analysis-02#which-registry-to-use-the-seata-meta-configuration-file-gives-the-answer" class="hash-link" aria-label="Direct link to which-registry-to-use-the-seata-meta-configuration-file-gives-the-answer" title="Direct link to which-registry-to-use-the-seata-meta-configuration-file-gives-the-answer">​</a></h4>
<p>As mentioned above, Seata supports a variety of registry implementations, so Seata first needs to get the "type of registry" information from a place first.</p>
<p>Seata has designed a "configuration file" to store some basic information about the components used in its framework. I prefer to call this configuration file <strong>"meta-configuration file "</strong>, because the information it contains is actually the "configuration of the configuration", i.e., the "configuration of the configuration", i.e., the "configuration of the configuration". This is because the information it contains is actually the "configuration of the configuration", i.e., the concept of "meta", which can be understood by comparing the information in the database table with the information in the structure of the database table itself (table data and table metadata).</p>
<p>We can think of the information in the Registry and Configuration Centre as <strong>configuration information itself</strong>, and what is the configuration** of this **configuration information? This information, then, is contained in Seata's meta-configuration file. In fact, there are only <strong>two types of information</strong> contained in the 'meta-configuration file':</p>
<ul>
<li>The first is the type of registry: registry.type, as well as some basic information about that type of registry, for example, when the registry type is a file, the meta configuration file stores the file's name information; when the registry type is Nacos, the meta configuration file stores Nacos addresses, namespaces, cluster names and other information.</li>
<li>Second, the type of configuration centre: config.type, as well as some basic information about the type of configuration centre, such as when the configuration centre is a file, the meta-configuration file stores information about the name of the file; when the type of registry is Consul, the meta-configuration file stores information about the address of the Consul</li>
</ul>
<p>Seata's meta-configuration file supports Yaml, Properties and other formats , and can be integrated into the SpringBoot application.yaml file ( use seata-spring-boot-starter can be ) , easy to integrate with SpringBoot .</p>
<p>The default meta-configuration file that comes with Seata is registry.conf, and when we use a file as the registration and configuration centre, the content in registry.conf is set as follows:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">registry </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # file </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nacos </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eureka</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consul</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etcd3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sofa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"file"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> file </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"file.conf"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nacos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> apollo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> consul</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"file"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> file </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"file.conf"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the following source code, we can find that the type of registry used by Seata is taken from ConfigurationFactory.CURRENT_FILE_INSTANCE, and this CURRENT_FILE_INSTANCE is what we call, an instance of the Seata **meta-configuration file **</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// In getInstance(), call buildRegistryService to build the specific registry instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token maybe-class-name">RegistryService</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">synchronized</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter maybe-class-name">RegistryFactory</span><span class="token parameter punctuation" style="color:#393A34">.</span><span class="token parameter property-access">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildRegistryService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token maybe-class-name">RegistryService</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildRegistryService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token maybe-class-name">RegistryType</span><span class="token plain"> registryType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Get the registry type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token known-class-name class-name">String</span><span class="token plain"> registryTypeName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">ConfigurationFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">CURRENT_FILE_INSTANCE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token maybe-class-name">ConfigurationKeys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">FILE_ROOT_REGISTRY</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token maybe-class-name">ConfigurationKeys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">FILE_CONFIG_SPLIT_CHAR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token maybe-class-name">ConfigurationKeys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">FILE_ROOT_TYPE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            registryType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">RegistryType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">registryTypeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Exception</span><span class="token plain"> exx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> exx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">RegistryType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Exception</span><span class="token plain"> exx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">NotSupportYetException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"not support registry type: "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> registryTypeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">RegistryType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">File</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> registryType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token maybe-class-name">FileRegistryServiceImpl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Load the registry instance using the SPI method based on the registry type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token maybe-class-name">EnhancedServiceLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">RegistryProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">class</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Objects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">requireNonNull</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">registryType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">provide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let's look at the initialisation process of the meta-configuration file, which triggers the initialisation of the ConfigurationFactory class when the static field CURRENT_FILE_INSTANCE is fetched for the first time:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// Static block of the ConfigurationFactory class</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    * In the load() method, load Seata's meta configuration file</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// The name of the meta configuration file, support through the system variable, environment variable expansion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token known-class-name class-name">String</span><span class="token plain"> seataConfigName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">SYSTEM_PROPERTY_SEATA_CONFIG_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seataConfigName </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           seataConfigName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ENV_SEATA_CONFIG_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seataConfigName </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           seataConfigName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">REGISTRY_CONF_DEFAULT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token known-class-name class-name">String</span><span class="token plain"> envValue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ENV_PROPERTY_KEY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">envValue </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           envValue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ENV_SYSTEM_KEY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// Create a file configuration instance that implements the Configuration interface based on the meta-configuration file name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token maybe-class-name">Configuration</span><span class="token plain"> configuration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">envValue </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FileConfiguration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seataConfigName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FileConfiguration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seataConfigName </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> envValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token maybe-class-name">Configuration</span><span class="token plain"> extConfiguration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// Determine if an extended configuration provider exists by loading it through SPI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">//When the application side uses seata-spring-boot-starer, it will pass the SpringBootConfigurationProvider as the extended configuration provider, at this point, when getting the meta-configuration item, it will no longer get it from file.conf (the default), but from application. properties/application.yaml.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// Replace the original Configuration instance with an instance of the extended configuration via the ExtConfigurationProvider's provide method</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           extConfiguration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">EnhancedServiceLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">ExtConfigurationProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">provide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configuration</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">isInfoEnabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"load Configuration:{}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> extConfiguration </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> configuration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getSimpleName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> extConfiguration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getSimpleName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">EnhancedServiceNotFoundException</span><span class="token plain"> ignore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"failed to load extConfiguration:{}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// Existence of an extended configuration returns an instance of the extended configuration, otherwise it returns an instance of the file configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token constant" style="color:#36acaa">CURRENT_FILE_INSTANCE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> extConfiguration </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> configuration </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> extConfiguration</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The call sequence diagram for the load() method is as follows:
! <a href="http://booogu.top/img/in-post/seata_config_initialization.png" target="_blank" rel="noopener noreferrer">Seata metaconfiguration file loading process</a></p>
<p>In the above sequence diagram, you can focus on the following points:</p>
<ul>
<li>Seata meta configuration file <strong>Name support extension</strong></li>
<li>Seata meta-configuration file suffixes** support 3 suffixes**, yaml/properties/conf, which will be attempted to match in turn when the meta-configuration file instance is created</li>
<li>Seata ** configuration capabilities related to the top-level interface for the Configuration **, a variety of configuration centres are required to implement this interface, Seata's meta-configuration file is the use of FileConfiguration (file type configuration centre) to implement this interface</li>
</ul>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* Seata Configuration Capability Interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* package: io.seata.config</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">Configuration</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    * Gets short.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    *</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">dataId</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> the data id</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">defaultValue</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> the default value</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">timeoutMills</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> the timeout mills</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@return</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> the short</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    */</span><span class="token plain">short </span><span class="token function" style="color:#d73a49">getShort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">String</span><span class="token plain"> dataId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   short </span><span class="token function" style="color:#d73a49">getShort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">String</span><span class="token plain"> dataId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> int defaultValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> long timeoutMills</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> short </span><span class="token function" style="color:#d73a49">getShort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">String</span><span class="token plain"> dataId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> int defaultValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> long timeoutMills</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// The following content is omitted, the main ability to add, delete and retrieve configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Seata provides an extension point of type ExtConfigurationProvider, opening up the ability to extend the specific implementation of the configuration, which has a provide() method to receive the original Configuration, return a completely new Configuration, the form of the methods of this interface determines that the general The form of this interface method determines that, in general, static proxies, dynamic proxies, decorators and other design patterns can be used to implement this method to achieve the original Configuration enhancement.</li>
</ul>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* Seata extends the Configuration Provider interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* package: io.seata.configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ExtConfigurationProvider</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    * provide a AbstractConfiguration implementation instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">originalConfiguration</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@return</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">    */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token maybe-class-name">Configuration</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">provide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">Configuration</span><span class="token plain"> originalConfiguration</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>When the application side is started based on seata-seata-spring-boot-starter, it will ** use "SpringBootConfigurationProvider" as the extended configuration provider ** and in its provide method, it uses dynamic bytecode generation (CGLIB) to create a dynamic proxy class for the "FileConfiguration" instance. FileConfiguration' instance using dynamic bytecode generation (CGLIB) to create a dynamic proxy class that intercepts all methods starting with "get" to get meta-configuration items from application.properties/application.yaml.</li>
</ul>
<p>SpringBootConfigurationProvider class, this article only explains the implementation of the idea , no longer unfolding the analysis of the source code, which is only an implementation of the ExtConfigurationProvider interface, from the point of view of the Configuration can be extended, can be replaced , Seata is precisely through the ExtConfigurationProvider such an extension point for the implementation of a variety of configurations provides a broad stage , allowing a variety of configuration implementation and access options.</p>
<p>After going through the above loading process, if we <strong>didn't extend the configuration provider</strong>, we would get the registry type of file from the Seata meta-configuration file, and at the same time create a file registry instance: FileRegistryServiceImpl</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="getting-the-tc-server-address-from-the-registry-centre">Getting the TC Server address from the registry centre<a href="https://seata.apache.org/blog/seata-client-start-analysis-02#getting-the-tc-server-address-from-the-registry-centre" class="hash-link" aria-label="Direct link to Getting the TC Server address from the registry centre" title="Direct link to Getting the TC Server address from the registry centre">​</a></h4>
<p>After getting the registry instance, you need to execute the lookup() method (RegistryFactory.getInstance(). <strong>lookup(transactionServiceGroup)</strong>), FileRegistryServiceImpl.lookup() is implemented as follows:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* Get a list of available addresses for TC Server based on the transaction group name</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* package: io.seata.discovery.registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* class: FileRegistryServiceImpl</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@</span><span class="token maybe-class-name">Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token maybe-class-name">List</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">InetSocketAddress</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lookup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">String</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> throws </span><span class="token maybe-class-name">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Get TC Server cluster name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">String</span><span class="token plain"> clusterName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getServiceGroup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clusterName </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clusterName </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//Get all available Server addresses in the TC cluster from the Configuration Centre</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">String</span><span class="token plain"> endpointStr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CONFIG</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">PREFIX_SERVICE_ROOT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CONFIG_SPLIT_CHAR</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> clusterName </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">POSTFIX_GROUPLIST</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">StringUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">isNullOrEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endpointStr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IllegalArgumentException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clusterName </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">POSTFIX_GROUPLIST</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" is required"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Encapsulate the address as InetSocketAddress and return it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> endpoints </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> endpointStr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ENDPOINT_SPLIT_CHAR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">List</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">InetSocketAddress</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> inetSocketAddresses </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ArrayList</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">String</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">endpoint</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> endpoints</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> ipAndPort </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> endpoint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">IP_PORT_SPLIT_CHAR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ipAndPort</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IllegalArgumentException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"endpoint format should be like ip:port"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inetSocketAddresses</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">InetSocketAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ipAndPort</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">parseInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ipAndPort</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> inetSocketAddresses</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     * default method in the registry interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     * package: io.seata.discovery.registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     * class: RegistryService</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"> </span><span class="token known-class-name class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getServiceGroup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter known-class-name class-name">String</span><span class="token parameter"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PREFIX_SERVICE_ROOT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CONFIG_SPLIT_CHAR</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PREFIX_SERVICE_MAPPING</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// In the configuration cache, add a transaction group name change listening event.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token constant" style="color:#36acaa">SERVICE_GROUP_NAME</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token maybe-class-name">ConfigurationCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addConfigListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token constant" style="color:#36acaa">SERVICE_GROUP_NAME</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Get the TC cluster name corresponding to the transaction grouping from the Configuration Centre</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token maybe-class-name">ConfigurationFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As you can see, the code logic matches the flow in Figure <strong>Seata Transaction Grouping in Relation to Establishing Connections</strong> in Section I.
At this point, the registry will need assistance from the <strong>Configuration Centre</strong> to get the cluster name corresponding to the transaction grouping and to find the available service addresses in the cluster.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="get-tc-cluster-name-from-configuration-centre">Get TC cluster name from <strong>Configuration Centre</strong><a href="https://seata.apache.org/blog/seata-client-start-analysis-02#get-tc-cluster-name-from-configuration-centre" class="hash-link" aria-label="Direct link to get-tc-cluster-name-from-configuration-centre" title="Direct link to get-tc-cluster-name-from-configuration-centre">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-centre-initialisation">Configuration Centre initialisation<a href="https://seata.apache.org/blog/seata-client-start-analysis-02#configuration-centre-initialisation" class="hash-link" aria-label="Direct link to Configuration Centre initialisation" title="Direct link to Configuration Centre initialisation">​</a></h4>
<p>The initialisation of the configuration centre (in ConfigurationFactory.buildConfiguration()) is similar to the initialisation process of the registration centre, which is to get the type of the configuration centre and other information from the <strong>meta-configuration file</strong> first, and then initialise a specific instance of the configuration centre, which is no longer repeated here, with the foundation of the previous analysis.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="getting-the-value-of-a-configuration-item">Getting the value of a configuration item<a href="https://seata.apache.org/blog/seata-client-start-analysis-02#getting-the-value-of-a-configuration-item" class="hash-link" aria-label="Direct link to Getting the value of a configuration item" title="Direct link to Getting the value of a configuration item">​</a></h4>
<p>The two methods in the above snippet, <em>FileRegistryServiceImpl.lookup()</em> and <em>RegistryService.getServiceGroup()</em>, both get the values of the configuration items from the configuration centre:</p>
<ul>
<li>lookup() need to be implemented by the specific registry, the use of file as a registry, in fact, is a direct connection to the TC Server, the special point is that **TC Server's address is written to death in the configuration ** (normal should be stored in the registry), so FileRegistryServiceImpl.lookup() method, is the address information of the Server in the TC cluster obtained through the configuration centre.</li>
<li>getServiceGroup() is the default method in the RegistryServer interface, which is the public implementation of all registries. Any kind of registry in Seata needs to be configured to get the TC cluster name based on the name of the transaction group.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="load-balancing">Load Balancing<a href="https://seata.apache.org/blog/seata-client-start-analysis-02#load-balancing" class="hash-link" aria-label="Direct link to Load Balancing" title="Direct link to Load Balancing">​</a></h3>
<p>After the above link configuration centre, registration centre collaboration, now we have obtained the current application side of all the available TC Server address, then before sending the real request, you also need to pass a specific load balancing policy, select a TC Server address, this part of the source code is relatively simple, will not take you to analyse.</p>
<blockquote>
<p>About the load balancing source code, you can read AbstractNettyRemotingClient.doSelect(), because the code analysed in this article is the reconnection method of RMClient/TMClient, in this method, all the obtained Server addresses will be connected (reconnected) sequentially by traversing, so here There is no need to do load balancing.</p>
</blockquote>
<p>The above is the Seata application side in the startup process, the registration centre and configuration centre of the two key modules between the collaboration and workflow, welcome to discuss and learn together!</p>
<blockquote>
<p>Postscript: This article and its predecessor <a href="http://booogu.top/2021/02/28/seata-client-start-analysis-01/" target="_blank" rel="noopener noreferrer"> Seata client startup process dissection (a)</a>, is the first batch of technical blogs written by me, will be on the hands of Seata, I personally believe that Seata in the more complex, need to study and figure out. When I started Seata, I have analysed and documented some of the more complex parts of Seata's source code that I think need to be researched and figured out.
I welcome any suggestions for improvement from readers, thank you!</p>
</blockquote>]]></content>
        <author>
            <name>booogu</name>
        </author>
        <category label="Seata" term="Seata"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Analysis of Seata Application-Side Startup Process - How RM & TM Establish Connections with TC]]></title>
        <id>https://seata.apache.org/blog/seata-client-start-analysis-01</id>
        <link href="https://seata.apache.org/blog/seata-client-start-analysis-01"/>
        <updated>2021-02-28T21:08:00.000Z</updated>
        <summary type="html"><![CDATA["Just started with Seata and don't have a deep understanding of its various modules?]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p>"Just started with Seata and don't have a deep understanding of its various modules? <br>
Want to delve into Seata's source code but haven't taken the plunge yet? <br>
Curious about what your application does 'secretly' during startup after integrating Seata? <br>
Want to learn about the design principles and best practices embodied in Seata as an excellent open-source framework? <br>
If you have any of the above thoughts, then this article is tailor-made for you~</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="https://seata.apache.org/blog/seata-client-start-analysis-01#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>Those who have seen the first picture in the official README should know that Seata coordinates distributed transactions through its <strong>coordinator side</strong> TC, which communicates and interacts with the <strong>application side</strong> TM and RM to ensure data consistency among multiple transaction participants in distributed transactions. So, how does Seata establish connections and communicate between the coordinator side and the application side?</p>
<p>That's right, the answer is Netty. Netty, as a high-performance RPC communication framework, ensures efficient communication between TC and RM. This article will not go into detail about Netty; instead, our focus today is on how the **application side, during startup, uses a series of Seata's key modules (such as RPC, Config/Registry Center, etc.) to establish communication with the coordinator side.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="starting-with-globaltransactionscanner">Starting with GlobalTransactionScanner<a href="https://seata.apache.org/blog/seata-client-start-analysis-01#starting-with-globaltransactionscanner" class="hash-link" aria-label="Direct link to Starting with GlobalTransactionScanner" title="Direct link to Starting with GlobalTransactionScanner">​</a></h2>
<p>We know that Seata provides several development annotations, such as @GlobalTransactional for enabling distributed transactions, @TwoPhraseBusinessAction for declaring TCC two-phase services, and so on, which are based on the Spring AOP mechanism to enhance the annotations by assigning the corresponding bean methods to interceptors. Interceptors are enhanced to complete the corresponding processing logic. GlobalTransactionScanner, a Spring bean, carries the responsibility of assigning interceptors to annotations. From the name of its scanner, it is not difficult to deduce that it is designed for the startup of the Spring application, and the global transaction (GlobalTransactionScanner). GlobalTransactionScanner) during Spring application startup.</p>
<p>In addition, the process of initialising the application-side RPC clients (TMClient, RMClient) and establishing a connection with the TC is also initiated in GlobalTransactionScanner#afterPropertiesSet():</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* package: io.seata.spring.annotation</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* class: GlobalTransactionScanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@</span><span class="token maybe-class-name">Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">afterPropertiesSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">disableGlobalTransaction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">isInfoEnabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">LOGGER</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Global transaction is disabled."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Perform TM, RM initialisation after the bean properties are initialised</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">initClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="initialisation-and-connection-process-of-rm--tm">Initialisation and connection process of RM &amp; TM<a href="https://seata.apache.org/blog/seata-client-start-analysis-01#initialisation-and-connection-process-of-rm--tm" class="hash-link" aria-label="Direct link to Initialisation and connection process of RM &amp; TM" title="Direct link to Initialisation and connection process of RM &amp; TM">​</a></h2>
<p>Here, we take RMClient.init() as an example, and the initialisation process of TMClient is the same.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="design-of-class-relationship">Design of class relationship<a href="https://seata.apache.org/blog/seata-client-start-analysis-01#design-of-class-relationship" class="hash-link" aria-label="Direct link to Design of class relationship" title="Direct link to Design of class relationship">​</a></h3>
<p>Looking at the source code of RMClient#init(), we find that RMClient first <strong>constructs</strong> an RmNettyRemotingClient, and then executes its <strong>initialisation</strong> init() method. The <strong>constructor</strong> and <strong>initialisation</strong> methods of RmNettyRemotingClient call the constructor and initialisation methods of the parent class layer by layer</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     * RMClient's initialisation logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     * package: io.seata.rm</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     * class: RMClient</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter known-class-name class-name">String</span><span class="token parameter"> applicationId</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter known-class-name class-name">String</span><span class="token parameter"> transactionServiceGroup</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//① Start with the RmNettyRemotingClient class and call the constructor of the parent class in turn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rmNettyRemotingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setResourceManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">DefaultResourceManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rmNettyRemotingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setTransactionMessageHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">DefaultRMHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> rmNettyRemotingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setTransactionMessageHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">DefaultRMHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//② Then, starting with the RmNettyRemotingClient class, call init() of the parent class in turn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rmNettyRemotingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The relationship between the above RMClient family classes and the process of calling the constructor and init() initialisation method is illustrated in the following diagram:
<img decoding="async" loading="lazy" src="http://booogu.top/img/in-post/rmclient_relation.jpg" alt="Relationship between the simplified version of the RMClient.init process and the main classes" class="img_ev3q"></p>
<p>So why did you design RMClient with such a more complex inheritance relationship? In fact, it is in order to divide the responsibilities and boundaries of each layer clearly, so that each layer can focus on specific logic processing, to achieve better scalability, this part of the detailed design ideas, you can refer to the Seata RPC module refactoring PR of the operator by Hui brother's article! <a href="https://mp.weixin.qq.com/s/PCSZ4a8cgmyZNhbUrO-BZQ" target="_blank" rel="noopener noreferrer">The Road to Seata-RPC Refactoring</a>)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-complete-flow-of-initialisation">The complete flow of initialisation<a href="https://seata.apache.org/blog/seata-client-start-analysis-01#the-complete-flow-of-initialisation" class="hash-link" aria-label="Direct link to The complete flow of initialisation" title="Direct link to The complete flow of initialisation">​</a></h3>
<p>The main logic in the constructor and initialisation methods of each class can be sorted out with the help of the following ideographic sequence diagram, which can also be skipped first, and then looked back to see when these classes debut and how they interact with each other after we have analysed a few key classes below.
<img decoding="async" loading="lazy" src="http://booogu.top/img/in-post/rmclient_initialization.png" alt="Initialisation flow of RMClient" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="grabbing-the-core---channel-creation">Grabbing the core - Channel creation<a href="https://seata.apache.org/blog/seata-client-start-analysis-01#grabbing-the-core---channel-creation" class="hash-link" aria-label="Direct link to Grabbing the core - Channel creation" title="Direct link to Grabbing the core - Channel creation">​</a></h3>
<p>First of all, we need to know that the communication between the application side and the coordinator side is done with the help of Netty's Channel, so the key to the communication process lies in the creation of the Channel**, which is created and managed in Seata by means of pooling (with the help of the object pool in common-pool).</p>
<p>Here we need to briefly introduce the simple concept of object pool and its implementation in Seata:
The main classes in common-pool are involved:</p>
<ul>
<li><strong>GenericKeydObjectPool&lt;K, V&gt;</strong>: A KV generic object pool that provides access to all objects, while object creation is done by its internal factory class.</li>
<li><strong>KeyedPoolableObjectFactory&lt;K, V&gt;</strong>: KV generic object factory responsible for the creation of pooled objects, held by the object pool</li>
</ul>
<p>The main classes involved are related to the implementation of object pooling in Seata:</p>
<ul>
<li>
<p>First, the pooled objects are <strong>Channel</strong>, which corresponds to the generic V in common-pool.</p>
</li>
<li>
<p><strong>NettyPoolKey</strong>: Key for Channel, corresponding to generic K in common-pool, NettyPoolKey contains two main information:</p>
<ul>
<li><em>address</em>:Address<!-- --> of TC Server when the Channel is created.</li>
<li><em>message</em>:The<!-- --> RPC message sent to TC Server when the Channel is created.</li>
</ul>
</li>
<li>
<p><strong>GenericKeydObjectPool&lt;NettyPoolKey,Channel&gt;</strong>: Pool of Channel objects.</p>
</li>
<li>
<p><strong>NettyPoolableFactory</strong>: the factory class for creating Channel.
Having recognised the main classes related to object pooling above, let's take a look at some of the main classes in Seata that are involved in channel management and are related to RPC:</p>
</li>
<li>
<p>NettyClientChannelManager:</p>
<ul>
<li>Holds the pool of Channel objects.</li>
<li>Interacts with the channel object pool to manage application-side channels (acquisition, release, destruction, caching, etc.).</li>
</ul>
</li>
<li>
<p>RpcClientBootstrap: core bootstrap class for RPC clients, holds the Netty framework bootstrap object with start/stop capability; has the ability to get a new Channel based on the connection address for the Channel factory class to call.</p>
</li>
<li>
<p>AbstractNettyRemotingClient:</p>
<ul>
<li>Initialises and holds the RpcClientBootstrap.</li>
<li>Application-side Netty client top-level abstraction, abstracts the ability of application-side RM/TM to obtain the NettyPoolKey corresponding to their respective Channel, for NettyClientChannelManager to call.</li>
<li>Initialising the NettyPoolableFactory</li>
</ul>
</li>
</ul>
<p>Understanding the above concepts, we can simplify the process of creating a channel in Seata as follows:
<img decoding="async" loading="lazy" src="http://booogu.top/img/in-post/create_channel.jpg" alt="Process of creating a Channel object" class="img_ev3q"></p>
<p>When you see this, you can go back and take a look at the above <strong>Initialisation Sequence Diagram for RMClient</strong>, and you should have a clearer understanding of the responsibilities and relationships of the various categories in the diagram, as well as the intent of the entire initialisation process.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="timing-and-flow-of-establishing-a-connection">Timing and flow of establishing a connection<a href="https://seata.apache.org/blog/seata-client-start-analysis-01#timing-and-flow-of-establishing-a-connection" class="hash-link" aria-label="Direct link to Timing and flow of establishing a connection" title="Direct link to Timing and flow of establishing a connection">​</a></h3>
<p>So, when does RMClient establish a connection with Server?</p>
<p>During the initialisation of RMClient, you will find that many init() methods set up some timed tasks, and the mechanism of reconnecting (connecting) the Seata application side to the coordinator is achieved through timed tasks:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* package: io.seata.core.rpcn.netty</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">* class: AbstractNettyRemotingClient</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Set the timer to reconnect to the TC Server at regular intervals.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">timerExecutor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">scheduleAtFixedRate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Runnable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@</span><span class="token maybe-class-name">Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clientChannelManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">reconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getTransactionServiceGroup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SCHEDULE_DELAY_MILLS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SCHEDULE_INTERVAL_MILLS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MILLISECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token maybe-class-name">NettyClientConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">isEnableClientBatchSendRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mergeSendExecutorService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">MAX_MERGE_SEND_THREAD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">MAX_MERGE_SEND_THREAD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">KEEP_ALIVE_TIME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">LinkedBlockingQueue</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">NamedThreadFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getThreadPrefix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">MAX_MERGE_SEND_THREAD</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mergeSendExecutorService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">submit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MergedSendRunnable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clientBootstrap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let's see how the classes we explored above work together to connect RMClient to TC by tracing the execution of a reconnect (the first connection may actually occur during registerResource, but the process is the same)
<img decoding="async" loading="lazy" src="http://booogu.top/img/in-post/rmclient_connect_tcserver.png" alt="RMClient and TC Server connection process" class="img_ev3q"></p>
<p>In this diagram, you can focus on these points:</p>
<ul>
<li>NettyClientChannelManager executes the callback function (getPoolKeyFunction()) to get the NettyPoolKey in the concrete AbstractNettyRemotingClient: the different Clients (RMClient and TMClient) on the application side, when they create the NettyPoolKey, they create the NettyChannelManager. TMClient) on the application side, the Key used when creating the Channel is different, so that <strong>they send different registration messages when reconnecting to the TC Server</strong>, which is also determined by the different roles they play in Seata:<!-- -->
<ul>
<li>TMClient: plays the role of transaction manager, when creating a Channel, it only sends a TM registration request (RegisterTMRequest) to the TC.</li>
<li>RMClient: plays the role of resource manager, needs to manage all transaction resources on the application side, therefore, when creating a Channel, it needs to get all transaction resource information on the application side before sending RM registration request (RegisterRMRequest), and register it to TC Server.</li>
</ul>
</li>
<li>In the Channel object factory's <code>NettyPoolableFactory</code>'s <code>makeObject</code> (create Channel) method, two tasks are completed using the two pieces of information in <code>NettyPoolKey</code>:<!-- -->
<ul>
<li>A new Channel is created using the address from <code>NettyPoolKey</code>.</li>
<li>A registration request is sent to the TC Server using the message from <code>NettyPoolKey</code> and the new Channel. This is the Client's initial connection (first execution) or reconnection (subsequent executions driven by scheduled tasks) request to the TC Server.</li>
</ul>
</li>
</ul>
<p>The above content covers the entire process of the Seata application's initialization and its connection establishment with the TC Server coordinator side.</p>
<p>For deeper details, it is recommended to thoroughly read the source code based on the outline and key points mentioned in this article. This will undoubtedly lead to a deeper understanding and new insights!</p>
<blockquote>
<p>Postscript: Considering the length and to maintain a suitable amount of information for a source code analysis article, the <strong>collaboration of configuration and registration modules</strong> mentioned in the introduction was not expanded upon in this article. <br>
In the next source code analysis, I will focus on the <strong>configuration center</strong> and <strong>registration center</strong>, analyzing how the Seata application side <strong>discovers the TC Server through service discovery</strong> and how it <strong>obtains various information from the configuration module</strong> before establishing connections between RMClient/TM Client and the TC Server.</p>
</blockquote>]]></content>
        <author>
            <name>booogu</name>
        </author>
        <category label="Seata" term="Seata"/>
    </entry>
</feed>