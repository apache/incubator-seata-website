{
  "filename": "operation.md",
  "__html": "<h1>运维指南</h1>\n<h2>Metrics配置指南</h2>\n<p>Seata支持在TC、TM和RM三个角色开启Metrics数据采集并输出到Prometheus监控系统中。</p>\n<h3>在TC中配置开启Metrics</h3>\n<h4>步骤一：在Seata Server中增加Metrics的依赖并重新编译Server</h4>\n<p>打开Seata Server源代码的<a href=\"https://github.com/seata/seata/blob/develop/server/pom.xml\">pom</a>，添加Metrics依赖：</p>\n<pre><code class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>${project.groupId}<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>seata-metrics-prometheus<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n</code></pre>\n<p>重新编译Server，启动，输入<code>http://tc-server-ip:9898/metrics</code>，即可获得最新的Metrics数据，例如：</p>\n<pre><code># HELP seata seata\n# TYPE seata untyped\nseata_transaction{meter=&quot;counter&quot;,role=&quot;tc&quot;,status=&quot;committed&quot;,} 1358.0 1551946035372\nseata_transaction{meter=&quot;counter&quot;,role=&quot;tc&quot;,status=&quot;active&quot;,} 0.0 1551946035372\nseata_transaction{meter=&quot;summary&quot;,role=&quot;tc&quot;,statistic=&quot;count&quot;,status=&quot;committed&quot;,} 6.0 1551946035372\nseata_transaction{meter=&quot;summary&quot;,role=&quot;tc&quot;,statistic=&quot;total&quot;,status=&quot;committed&quot;,} 6.0 1551946035372\nseata_transaction{meter=&quot;summary&quot;,role=&quot;tc&quot;,statistic=&quot;tps&quot;,status=&quot;committed&quot;,} 1.6163793103448276 1551946035372\nseata_transaction{meter=&quot;timer&quot;,role=&quot;tc&quot;,statistic=&quot;count&quot;,status=&quot;committed&quot;,} 6.0 1551946035372\nseata_transaction{meter=&quot;timer&quot;,role=&quot;tc&quot;,statistic=&quot;total&quot;,status=&quot;committed&quot;,} 910.0 1551946035372\nseata_transaction{meter=&quot;timer&quot;,role=&quot;tc&quot;,statistic=&quot;max&quot;,status=&quot;committed&quot;,} 164.0 1551946035372\nseata_transaction{meter=&quot;timer&quot;,role=&quot;tc&quot;,statistic=&quot;average&quot;,status=&quot;committed&quot;,} 151.66666666666666 1551946035372\n</code></pre>\n<blockquote>\n<p>提示：</p>\n<ol>\n<li>目前我们使用的Prometheus数据发布端口固定为9898，未来会将其修改为可配置项，请确保此端口不会被占用；</li>\n<li>如果某些Transaction状态没有发生，例如rollback，那么对应的Metrics指标也不会存在（输出）。</li>\n</ol>\n</blockquote>\n<h4>步骤二：修改Prometheus配置文件并启动Prometheus</h4>\n<p>打开Prometheus的配置文件<code>prometheus.yml</code>，在<code>scrape_configs</code>中增加一项抓取Seata TC的Metrics数据：</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">scrape_configs:</span>\n  <span class=\"hljs-comment\"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>\n<span class=\"hljs-attr\">  - job_name:</span> <span class=\"hljs-string\">'prometheus'</span>\n\n    <span class=\"hljs-comment\"># metrics_path defaults to '/metrics'</span>\n    <span class=\"hljs-comment\"># scheme defaults to 'http'.</span>\n\n<span class=\"hljs-attr\">    static_configs:</span>\n<span class=\"hljs-attr\">    - targets:</span> <span class=\"hljs-string\">['localhost:9090']</span>\n\n<span class=\"hljs-attr\">  - job_name:</span> <span class=\"hljs-string\">'seata'</span>\n\n    <span class=\"hljs-comment\"># metrics_path defaults to '/metrics'</span>\n    <span class=\"hljs-comment\"># scheme defaults to 'http'.</span>\n\n<span class=\"hljs-attr\">    static_configs:</span>\n<span class=\"hljs-attr\">    - targets:</span> <span class=\"hljs-string\">['tc-server-ip:9898']</span>\n</code></pre>\n<h4>步骤三：在Prometheus UI或Grafana中查看Seata TC的Metrics</h4>\n<p>在浏览器中打开Prometheus UI<code>http://localhost:9090/graph</code>，选择<code>seata_transaction</code>，点击查询，即可获取到最新数据：</p>\n<p><img src=\"/img/tc-prometheus.png\" alt=\"tc-prometheus\"></p>\n<p>推荐在Prometheus中结合配置<a href=\"https://prometheus.io/docs/visualization/grafana/\">Grafana</a>获得更好的查询效果：</p>\n<p><img src=\"/img/tc-grafana.png\" alt=\"tc-grafana\"></p>\n<blockquote>\n<p>提示：此配置是将Prometheus作为Grafana的数据源，因此数据完全相同，只是使用Grafana显示效果更佳。</p>\n</blockquote>\n",
  "link": "/zh-cn/docs/ops/operation.html",
  "meta": {
    "title": "运维指南",
    "keywords": "Seata",
    "description": "Seata支持在TC、TM和RM三个角色开启Metrics数据采集并输出到Prometheus监控系统中。"
  }
}