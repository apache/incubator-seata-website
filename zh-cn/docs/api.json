{
  "filename": "api.md",
  "__html": "<h1>APIs Provided by SuperNode</h1>\n<p>This topic explains how to use the APIs provided by the <a href=\"overview/terminology.md\">SuperNode</a> (the cluster manager).</p>\n<h2>Registration</h2>\n<pre><code>POST /peer/registry\n</code></pre>\n<h3>Parameters</h3>\n<p>Parameters are encodeds as <code>application/x-www-form-urlencoded</code>.</p>\n<table>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>cid</td>\n<td>String</td>\n<td>The client ID.</td>\n</tr>\n<tr>\n<td>ip</td>\n<td>String (IPv4)</td>\n<td>The client IP address.</td>\n</tr>\n<tr>\n<td>hostName</td>\n<td>String</td>\n<td>The hostname of the client.</td>\n</tr>\n<tr>\n<td>superNodeIp</td>\n<td>String (IPv4)</td>\n<td>The IP address of the registered SuperNode.</td>\n</tr>\n<tr>\n<td>port</td>\n<td>Integer</td>\n<td>The port which the client opens for P2P downloading.</td>\n</tr>\n<tr>\n<td>callSystem</td>\n<td>String</td>\n<td>The caller identifier.</td>\n</tr>\n<tr>\n<td>version</td>\n<td>String</td>\n<td>The client version.</td>\n</tr>\n<tr>\n<td>dfdaemon</td>\n<td>Boolean</td>\n<td>Tells whether it is a call from dfdaemon.</td>\n</tr>\n<tr>\n<td>path</td>\n<td>String</td>\n<td>The service path which the client offers.</td>\n</tr>\n<tr>\n<td>rawUrl</td>\n<td>String</td>\n<td>The resource URL provided by command line parameter.</td>\n</tr>\n<tr>\n<td>taskUrl</td>\n<td>String</td>\n<td>The resource URL.</td>\n</tr>\n<tr>\n<td>md5</td>\n<td>String</td>\n<td>The MD5 checksum for the resource. Optional.</td>\n</tr>\n<tr>\n<td>identifier</td>\n<td>String</td>\n<td>The resource identifer.</td>\n</tr>\n<tr>\n<td>headers</td>\n<td>Map</td>\n<td>Extra HTTP headers to be sent to the raw URL.</td>\n</tr>\n</tbody>\n</table>\n<p>Upon receiving a request of registration from the client, the SuperNode constructs a new instance of based on the information provided by parameters. Specifically, it generates a task with <code>taskId</code> based on <code>rawUrl</code>, <code>md5</code>, and <code>identifier</code>.</p>\n<p>Then the task is stored in the memory cache. Meanwhile, the SuperNode retrieves extra information such as the <code>content-length</code> which normally would be set. The <code>pieceSize</code> is calculated as per the following strategy:</p>\n<ol>\n<li>If the total size is less than 200MB, then the piece size is 4MB by default.</li>\n<li>Otherwise, it equals to the smaller value between <code>(${totalSize} / 100MB) + 2</code> MB and 15MB.</li>\n</ol>\n<p>Next, the peer information along with the task will be recorded:</p>\n<ol>\n<li>The peer&lt;ip, cid, hostname&gt; will be saved.</li>\n<li>The task&lt;taskId, cid, pieceSize, port, path&gt; will be saved.</li>\n</ol>\n<p>The last step is to trigger a progress.</p>\n<h3>Response</h3>\n<p>An example response:</p>\n<pre><code class=\"language-json\">{\n  <span class=\"hljs-attr\">\"code\"</span>: <span class=\"hljs-number\">200</span>,\n  <span class=\"hljs-attr\">\"data\"</span>: {\n    <span class=\"hljs-attr\">\"fileLength\"</span>: <span class=\"hljs-number\">687481</span>,\n    <span class=\"hljs-attr\">\"pieceSize\"</span>: <span class=\"hljs-number\">4194304</span>,\n    <span class=\"hljs-attr\">\"taskId\"</span>: <span class=\"hljs-string\">\"ba270626349198840d0255de8358b6c93fe6d57d922d036fbf40bcf3499f44a8\"</span>\n  }\n}\n</code></pre>\n<p>Other possible values of <code>code</code> in the response include:</p>\n<ul>\n<li><code>606</code>: The task ID already exists.</li>\n<li><code>607</code>: The URL is invalid.</li>\n<li><code>608</code> or <code>609</code>: Authentication required.</li>\n</ul>\n<h2>Get Task</h2>\n<pre><code>GET /peer/task\n</code></pre>\n<h3>Parameters</h3>\n<table>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>superNode</td>\n<td>String (IPv4)</td>\n<td>The IP address of the super node.</td>\n</tr>\n<tr>\n<td>dstCID</td>\n<td>String</td>\n<td>The destination client ID.</td>\n</tr>\n<tr>\n<td>range</td>\n<td>String</td>\n<td>Byte range.</td>\n</tr>\n<tr>\n<td>status</td>\n<td>Integer</td>\n<td></td>\n</tr>\n<tr>\n<td>result</td>\n<td>Integer</td>\n<td></td>\n</tr>\n<tr>\n<td>taskId</td>\n<td>String</td>\n<td>The task ID.</td>\n</tr>\n<tr>\n<td>srcCID</td>\n<td>String</td>\n<td>The source client ID.</td>\n</tr>\n</tbody>\n</table>\n<p>First, the SuperNode will analyze the <code>status</code> and <code>result</code>.</p>\n<ul>\n<li><code>Running</code>: if <code>status == 701</code>.</li>\n<li><code>Success</code>: if <code>status == 702</code> and <code>result == 501</code>.</li>\n<li><code>Fail</code>: if <code>status == 702</code> and <code>result == 500</code>.</li>\n<li><code>Wait</code>: if <code>status == 700</code>.</li>\n</ul>\n<p>In <code>Wait</code> status, the SuperNode will save the status to be <code>Running</code>.</p>\n<p>In <code>Running</code> status, the SuperNode will extract the piece status:</p>\n<ul>\n<li><code>Success</code>: if <code>result == 501</code>.</li>\n<li><code>Fail</code>: if <code>result == 500</code>.</li>\n<li><code>SemiSuc</code>: if <code>result == 503</code>.</li>\n</ul>\n<p><strong>Tip:</strong> <code>result == 502</code> suggests invalid code.</p>\n<p>Then the SuperNode updates the progress for this specific task, and checks the status of  the task and the peers. After this, the SuperNode tells the client which peer has enough details to download another piece. Otherwise, it fails.</p>\n<h3>Response</h3>\n<p>An example resonse:</p>\n<pre><code class=\"language-json\">{\n  <span class=\"hljs-attr\">\"code\"</span>: <span class=\"hljs-number\">602</span>,\n  <span class=\"hljs-attr\">\"msg\"</span>: <span class=\"hljs-string\">\"client sucCount:0,cdn status:Running,cdn sucCount: 0\"</span>\n}\n</code></pre>\n<p>This example response means that the client has to wait, since no peer can serve this piece now. If there is a peer which can serve this request, the response will be something like:</p>\n<pre><code class=\"language-json\">{\n  <span class=\"hljs-attr\">\"code\"</span>: <span class=\"hljs-number\">601</span>,\n  <span class=\"hljs-attr\">\"data\"</span>: [\n    {\n      <span class=\"hljs-attr\">\"cid\"</span>: <span class=\"hljs-string\">\"cdnnode:10.148.177.242~ba270626349198840d0255de8358b6c93fe6d57d922d036fbf40bcf3499f44a8\"</span>,\n      <span class=\"hljs-attr\">\"downLink\"</span>: <span class=\"hljs-string\">\"20480\"</span>,\n      <span class=\"hljs-attr\">\"path\"</span>: <span class=\"hljs-string\">\"/qtdown/ba2/ba270626349198840d0255de8358b6c93fe6d57d922d036fbf40bcf3499f44a8\"</span>,\n      <span class=\"hljs-attr\">\"peerIp\"</span>: <span class=\"hljs-string\">\"10.148.177.242\"</span>,\n      <span class=\"hljs-attr\">\"peerPort\"</span>: <span class=\"hljs-number\">8001</span>,\n      <span class=\"hljs-attr\">\"pieceMd5\"</span>: <span class=\"hljs-string\">\"d78ef0af9e95e880fa583b41cf5ad791:687486\"</span>,\n      <span class=\"hljs-attr\">\"pieceNum\"</span>: <span class=\"hljs-number\">0</span>,\n      <span class=\"hljs-attr\">\"pieceSize\"</span>: <span class=\"hljs-number\">4194304</span>,\n      <span class=\"hljs-attr\">\"range\"</span>: <span class=\"hljs-string\">\"0-4194303\"</span>\n    }\n  ]\n}\n</code></pre>\n<h2>Peer Progress</h2>\n<pre><code>GET /peer/piece/suc\n</code></pre>\n<h3>Parameters</h3>\n<table>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>dstCID</td>\n<td>String</td>\n<td>The destination client ID.</td>\n</tr>\n<tr>\n<td>pieceRange</td>\n<td>String</td>\n<td>Byte range.</td>\n</tr>\n<tr>\n<td>taskId</td>\n<td>String</td>\n<td>The task ID.</td>\n</tr>\n<tr>\n<td>cID</td>\n<td>String</td>\n<td>The client ID.</td>\n</tr>\n</tbody>\n</table>\n<h3>Response</h3>\n<p>An example response:</p>\n<pre><code class=\"language-json\">{\n  <span class=\"hljs-attr\">\"code\"</span>: <span class=\"hljs-number\">200</span>,\n  <span class=\"hljs-attr\">\"msg\"</span>: <span class=\"hljs-string\">\"success\"</span>\n}\n</code></pre>\n",
  "link": "/zh-cn/docs/api.html",
  "meta": {}
}