"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[85083],{80176:(n,t,e)=>{e.r(t),e.d(t,{assets:()=>d,contentTitle:()=>a,default:()=>b,frontMatter:()=>r,metadata:()=>c,toc:()=>s});var o=e(74848),i=e(28453);const r={title:"\u6e90\u7801\u5206\u6790Seata-XID\u4f20\u9012 Dubbo\u7bc7",keywords:["Seata","Dubbo","\u5206\u5e03\u5f0f\u4e8b\u52a1","spring"],description:"\u672c\u6587\u8bb2\u8ff0\u901a\u8fc7\u6e90\u7801\u89e3\u6790Seata-Dubbo\u4f20\u9012XID",author:"FUNKYE",date:"2020/01/01"},a="\u6e90\u7801\u5206\u6790 Seata-XID \u4f20\u9012 Dubbo \u7bc7",c={permalink:"/zh-cn/blog/seata-analysis-dubbo-transmit-xid",editUrl:"https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/zh-cn/docusaurus-plugin-content-blog/seata-analysis-dubbo-transmit-xid.md",source:"@site/i18n/zh-cn/docusaurus-plugin-content-blog/seata-analysis-dubbo-transmit-xid.md",title:"\u6e90\u7801\u5206\u6790Seata-XID\u4f20\u9012 Dubbo\u7bc7",description:"\u672c\u6587\u8bb2\u8ff0\u901a\u8fc7\u6e90\u7801\u89e3\u6790Seata-Dubbo\u4f20\u9012XID",date:"2020-01-01T00:00:00.000Z",formattedDate:"2020\u5e741\u67081\u65e5",tags:[],readingTime:3.39,hasTruncateMarker:!1,authors:[{name:"FUNKYE"}],frontMatter:{title:"\u6e90\u7801\u5206\u6790Seata-XID\u4f20\u9012 Dubbo\u7bc7",keywords:["Seata","Dubbo","\u5206\u5e03\u5f0f\u4e8b\u52a1","spring"],description:"\u672c\u6587\u8bb2\u8ff0\u901a\u8fc7\u6e90\u7801\u89e3\u6790Seata-Dubbo\u4f20\u9012XID",author:"FUNKYE",date:"2020/01/01"},unlisted:!1,prevItem:{title:"Seata config \u6a21\u5757\u6e90\u7801\u5206\u6790",permalink:"/zh-cn/blog/seata-analysis-config-modular"},nextItem:{title:"Seata tcc \u6a21\u5757\u6e90\u7801\u5206\u6790",permalink:"/zh-cn/blog/seata-analysis-tcc-modular"}},d={authorsImageUrls:[void 0]},s=[{value:"\u5206\u6790\u6e90\u7801",id:"\u5206\u6790\u6e90\u7801",level:2},{value:"\u8981\u70b9\u77e5\u8bc6",id:"\u8981\u70b9\u77e5\u8bc6",level:2}];function p(n){const t={a:"a",code:"code",h1:"h1",h2:"h2",img:"img",p:"p",pre:"pre",...(0,i.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"\u672c\u6587\u4f5c\u8005\uff1aFUNKYE(\u9648\u5065\u658c),\u676d\u5dde\u67d0\u4e92\u8054\u7f51\u516c\u53f8\u4e3b\u7a0b\u3002"}),"\n",(0,o.jsx)(t.h1,{id:"\u524d\u8a00",children:"\u524d\u8a00"}),"\n",(0,o.jsx)(t.p,{children:"\u200b 1.\u9996\u5148\u6765\u770b\u4e0b\u5305\u7ed3\u6784,\u5728 seata-dubbo \u548c seata-dubbo-alibaba \u4e0b\u6709\u7edf\u4e00\u7531 TransactionPropagationFilter \u8fd9\u4e2a\u7c7b,\u5206\u522b\u5bf9\u5e94 apache-dubbo \u8ddf alibaba-dubbo."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"20200101203229",src:e(5364).A+"",width:"422",height:"410"})}),"\n",(0,o.jsx)(t.h2,{id:"\u5206\u6790\u6e90\u7801",children:"\u5206\u6790\u6e90\u7801"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-java",children:'package io.seata.integration.dubbo;\n\nimport io.seata.core.context.RootContext;\nimport org.apache.dubbo.common.Constants;\nimport org.apache.dubbo.common.extension.Activate;\nimport org.apache.dubbo.rpc.Filter;\nimport org.apache.dubbo.rpc.Invocation;\nimport org.apache.dubbo.rpc.Invoker;\nimport org.apache.dubbo.rpc.Result;\nimport org.apache.dubbo.rpc.RpcContext;\nimport org.apache.dubbo.rpc.RpcException;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n@Activate(group = {Constants.PROVIDER, Constants.CONSUMER}, order = 100)\npublic class TransactionPropagationFilter implements Filter {\n\n    private static final Logger LOGGER = LoggerFactory.getLogger(TransactionPropagationFilter.class);\n\n    @Override\n    public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {\n        //\u83b7\u53d6\u672c\u5730XID\n        String xid = RootContext.getXID();\n        String xidInterceptorType = RootContext.getXIDInterceptorType();\n        //\u83b7\u53d6Dubbo\u9690\u5f0f\u4f20\u53c2\u4e2d\u7684XID\n        String rpcXid = getRpcXid();\n        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n        if (LOGGER.isDebugEnabled()) {\n            LOGGER.debug("xid in RootContext[{}] xid in RpcContext[{}]", xid, rpcXid);\n        }\n        boolean bind = false;\n        if (xid != null) {\n            //\u4f20\u9012XID\n            RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n        } else {\n            if (rpcXid != null) {\n                //\u7ed1\u5b9aXID\n                RootContext.bind(rpcXid);\n                RootContext.bindInterceptorType(rpcXidInterceptorType);\n                bind = true;\n                if (LOGGER.isDebugEnabled()) {\n                    LOGGER.debug("bind[{}] interceptorType[{}] to RootContext", rpcXid, rpcXidInterceptorType);\n                }\n            }\n        }\n        try {\n            return invoker.invoke(invocation);\n        } finally {\n            if (bind) {\n                //\u8fdb\u884c\u5254\u9664\u5df2\u5b8c\u6210\u4e8b\u52a1\u7684XID\n                String unbindInterceptorType = RootContext.unbindInterceptorType();\n                String unbindXid = RootContext.unbind();\n                if (LOGGER.isDebugEnabled()) {\n                    LOGGER.debug("unbind[{}] interceptorType[{}] from RootContext", unbindXid, unbindInterceptorType);\n                }\n                //\u5982\u679c\u53d1\u73b0\u89e3\u7ed1\u7684XID\u5e76\u4e0d\u662f\u5f53\u524d\u63a5\u6536\u5230\u7684XID\n                if (!rpcXid.equalsIgnoreCase(unbindXid)) {\n                    LOGGER.warn("xid in change during RPC from {} to {}, xidInterceptorType from {} to {} ", rpcXid, unbindXid, rpcXidInterceptorType, unbindInterceptorType);\n                    if (unbindXid != null) {\n                        //\u91cd\u65b0\u7ed1\u5b9aXID\n                        RootContext.bind(unbindXid);\n                        RootContext.bindInterceptorType(unbindInterceptorType);\n                        LOGGER.warn("bind [{}] interceptorType[{}] back to RootContext", unbindXid, unbindInterceptorType);\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * get rpc xid\n     * @return\n     */\n    private String getRpcXid() {\n        String rpcXid = RpcContext.getContext().getAttachment(RootContext.KEY_XID);\n        if (rpcXid == null) {\n            rpcXid = RpcContext.getContext().getAttachment(RootContext.KEY_XID.toLowerCase());\n        }\n        return rpcXid;\n    }\n\n}\n'})}),"\n",(0,o.jsx)(t.p,{children:"\u200b 1.\u6839\u636e\u6e90\u7801,\u6211\u4eec\u53ef\u4ee5\u63a8\u51fa\u76f8\u5e94\u7684\u903b\u8f91\u5904\u7406"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"20200101213336",src:e(83740).A+"",width:"775",height:"743"})}),"\n",(0,o.jsx)(t.h2,{id:"\u8981\u70b9\u77e5\u8bc6",children:"\u8981\u70b9\u77e5\u8bc6"}),"\n",(0,o.jsx)(t.p,{children:"\u200b 1.Dubbo @Activate \u6ce8\u89e3:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-java",children:'@Documented\n@Retention(RetentionPolicy.RUNTIME)\n@Target({ElementType.TYPE, ElementType.METHOD})\npublic @interface Activate {\n    /**\n     * Group\u8fc7\u6ee4\u6761\u4ef6\u3002\n     * <br />\n     * \u5305\u542b{@link ExtensionLoader#getActivateExtension}\u7684group\u53c2\u6570\u7ed9\u7684\u503c\uff0c\u5219\u8fd4\u56de\u6269\u5c55\u3002\n     * <br />\n     * \u5982\u6ca1\u6709Group\u8bbe\u7f6e\uff0c\u5219\u4e0d\u8fc7\u6ee4\u3002\n     */\n    String[] group() default {};\n\n    /**\n     * Key\u8fc7\u6ee4\u6761\u4ef6\u3002\u5305\u542b{@link ExtensionLoader#getActivateExtension}\u7684URL\u7684\u53c2\u6570Key\u4e2d\u6709\uff0c\u5219\u8fd4\u56de\u6269\u5c55\u3002\n     * <p/>\n     * \u793a\u4f8b\uff1a<br/>\n     * \u6ce8\u89e3\u7684\u503c <code>@Activate("cache,validatioin")</code>\uff0c\n     * \u5219{@link ExtensionLoader#getActivateExtension}\u7684URL\u7684\u53c2\u6570\u6709<code>cache</code>Key\uff0c\u6216\u662f<code>validatioin</code>\u5219\u8fd4\u56de\u6269\u5c55\u3002\n     * <br/>\n     * \u5982\u6ca1\u6709\u8bbe\u7f6e\uff0c\u5219\u4e0d\u8fc7\u6ee4\u3002\n     */\n    String[] value() default {};\n\n    /**\n     * \u6392\u5e8f\u4fe1\u606f\uff0c\u53ef\u4ee5\u4e0d\u63d0\u4f9b\u3002\n     */\n    String[] before() default {};\n\n    /**\n     * \u6392\u5e8f\u4fe1\u606f\uff0c\u53ef\u4ee5\u4e0d\u63d0\u4f9b\u3002\n     */\n    String[] after() default {};\n\n    /**\n     * \u6392\u5e8f\u4fe1\u606f\uff0c\u53ef\u4ee5\u4e0d\u63d0\u4f9b\u3002\n     */\n    int order() default 0;\n}\n'})}),"\n",(0,o.jsx)(t.p,{children:"\u53ef\u4ee5\u5206\u6790\u5f97\u77e5,Seata \u7684 dubbo \u8fc7\u6ee4\u5668\u4e0a\u7684\u6ce8\u89e3@Activate(group = {Constants.PROVIDER, Constants.CONSUMER}, order = 100),\u8868\u793a dubbo \u7684\u670d\u52a1\u63d0\u4f9b\u65b9\u8ddf\u6d88\u8d39\u65b9\u90fd\u4f1a\u89e6\u53d1\u5230\u8fd9\u4e2a\u8fc7\u6ee4\u5668,\u6240\u4ee5\u6211\u4eec\u7684 Seata \u53d1\u8d77\u8005\u4f1a\u4ea7\u751f\u4e00\u4e2a XID \u7684\u4f20\u9012,\u4e0a\u8ff0\u6d41\u7a0b\u56fe\u8ddf\u4ee3\u7801\u5df2\u7ecf\u5f88\u6e05\u6670\u7684\u8868\u793a\u4e86."}),"\n",(0,o.jsxs)(t.p,{children:["\u200b 2.Dubbo \u9690\u5f0f\u4f20\u53c2\u53ef\u4ee5\u901a\u8fc7 ",(0,o.jsx)(t.code,{children:"RpcContext"})," \u4e0a\u7684 ",(0,o.jsx)(t.code,{children:"setAttachment"})," \u548c ",(0,o.jsx)(t.code,{children:"getAttachment"})," \u5728\u670d\u52a1\u6d88\u8d39\u65b9\u548c\u63d0\u4f9b\u65b9\u4e4b\u95f4\u8fdb\u884c\u53c2\u6570\u7684\u9690\u5f0f\u4f20\u9012\u3002"]}),"\n",(0,o.jsxs)(t.p,{children:["\u83b7\u53d6",":RpcContext",".getContext().getAttachment(RootContext.KEY_XID);"]}),"\n",(0,o.jsxs)(t.p,{children:["\u4f20\u9012",":RpcContext",".getContext().setAttachment(RootContext.KEY_XID, xid);"]}),"\n",(0,o.jsx)(t.h1,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,o.jsxs)(t.p,{children:["\u66f4\u591a\u6e90\u7801\u9605\u8bfb\u8bf7\u8bbf\u95ee",(0,o.jsx)(t.a,{href:"https://seata.apache.org/",children:"Seata \u5b98\u7f51"})]})]})}function b(n={}){const{wrapper:t}={...(0,i.R)(),...n.components};return t?(0,o.jsx)(t,{...n,children:(0,o.jsx)(p,{...n})}):p(n)}},5364:(n,t,e)=>{e.d(t,{A:()=>o});const o=e.p+"assets/images/20200101203229-b1377d653c52962ea621a450291bcf87.png"},83740:(n,t,e)=>{e.d(t,{A:()=>o});const o=e.p+"assets/images/20200101213336-dec117cebba3464f980a52714f43ff7d.png"},28453:(n,t,e)=>{e.d(t,{R:()=>a,x:()=>c});var o=e(96540);const i={},r=o.createContext(i);function a(n){const t=o.useContext(r);return o.useMemo((function(){return"function"==typeof n?n(t):{...t,...n}}),[t,n])}function c(n){let t;return t=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:a(n.components),o.createElement(r.Provider,{value:t},n.children)}}}]);