<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | Apache Seata™</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.io/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://seata.io/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://seata.io/zh-cn/blog/page/4"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="keywords" content="Seata,Seata官网,Seata official site,分布式事务,distributed transactions"><meta data-rh="true" property="og:title" content="Blog | Apache Seata™"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/zh-cn/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.io/zh-cn/blog/page/4"><link data-rh="true" rel="alternate" href="https://seata.io/blog/page/4" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.io/zh-cn/blog/page/4" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.io/blog/page/4" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ICHFIJRDZF-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Apache Seata™ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Apache Seata™ Atom Feed">


<link rel="search" type="application/opensearchdescription+xml" title="Apache Seata™" href="/zh-cn/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=seata">
<script src="https://www.googletagmanager.com/gtag/js?id=G-X4LJGF90X2" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.d0073205.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.6a3ed17d.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.466e24d1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="https://hm.baidu.com/hm.js?104e73ef0c18b416b27abb23757ed8ee"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/overview/what-is-seata" href="/zh-cn/docs/overview/what-is-seata">v2.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-cn/docs/next/overview/what-is-seata">预览版</a></li><li><a class="dropdown__link" href="/zh-cn/docs/overview/what-is-seata">v2.0</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.8/overview/what-is-seata">v1.8</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.7/overview/what-is-seata">v1.7</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.6/overview/what-is-seata">v1.6</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.5/overview/what-is-seata">v1.5</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.4/overview/what-is-seata">v1.4</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.3/overview/what-is-seata">v1.3</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.2/overview/what-is-seata">v1.2</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.1/overview/what-is-seata">v1.1</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.0/overview/what-is-seata">v1.0</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/contributor-guide/new-contributor-guide_dev">开发者</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/users">用户</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a class="navbar__item navbar__link" href="/zh-cn/unversioned/download/seata-server">下载</a><a href="http://demo.seata.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/blog/page/4" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/page/4" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/explore-seata-journey">探索 Seata 项目开源开发之旅</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-raft-detailed-explanation">Seata-Raft 存储模式详解及入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-observable-practice">Seata的可观测实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-lock">详解 Seata AT 模式事务隔离级别与全局锁设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-snowflake-explain">关于新版雪花算法的答疑</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-UUID-generator">Seata基于改良版雪花算法的分布式UUID生成器分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-feature-undo-log-compress">Seata新特性支持 -- undo_log压缩</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dsproxy-deadlock">ConcurrentHashMap导致的Seata死锁问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-02">Seata应用侧启动过程剖析——注册中心与配置中心模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-01">Seata应用侧启动过程剖析——RM &amp; TM如何与TC建立连接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-tcc-mode-with-spring-cloud">Spring Cloud集成Seata分布式事务-TCC模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-manager">Seata配置管理原理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-golang-communication-mode">seata-golang 通信模型详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-datasource-proxy">Seata数据源代理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-demo-in-mac">Mac下的Seata Demo环境搭建（AT模式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-quick-start">Seata 极简入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-ha-practice">Seata 高可用部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-center">Seata 配置中心实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/quick-start-use-seata-and-dubbo-services">如何使用Seata保证Dubbo微服务间的一致性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/manual-transaction-mode">MT 模式</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-12-25T00:00:00.000Z" itemprop="datePublished">2019年12月25日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">赵润泽</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一--导读">一  .导读<a href="#一--导读" class="hash-link" aria-label="一  .导读的直接链接" title="一  .导读的直接链接">​</a></h2><p>spring 模块分析中讲到，Seata 的 spring 模块会对涉及到分布式业务的 bean 进行处理。项目启动时，当 GlobalTransactionalScanner 扫描到 TCC 服务的 reference 时（即tcc事务参与方），会对其进行动态代理，即给 bean 织入 TCC 模式下的 MethodInterceptor 的实现类。tcc 事务发起方依然使用 @GlobalTransactional 注解开启，织入的是通用的 MethodInterceptor 的实现类。</p><p>TCC 模式下的 MethodInterceptor 实现类即 TccActionInterceptor(spring模块) ，这个类中调用了 ActionInterceptorHandler(tcc模块) 进行 TCC 模式下事务流程的处理。	</p><p>TCC 动态代理的主要功能是：生成TCC运行时上下文、透传业务参数、注册分支事务记录。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二--tcc模式介绍">二  .TCC模式介绍<a href="#二--tcc模式介绍" class="hash-link" aria-label="二  .TCC模式介绍的直接链接" title="二  .TCC模式介绍的直接链接">​</a></h2><p>在2PC（两阶段提交）协议中，事务管理器分两阶段协调资源管理，资源管理器对外提供三个操作，分别是一阶段的准备操作，和二阶段的提交操作和回滚操作。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface TccAction {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TwoPhaseBusinessAction(name = &quot;tccActionForTest&quot; , commitMethod = &quot;commit&quot;, rollbackMethod = &quot;rollback&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean prepare(BusinessActionContext actionContext,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           @BusinessActionContextParameter(paramName = &quot;a&quot;) int a,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           @BusinessActionContextParameter(paramName = &quot;b&quot;, index = 0) List b,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           @BusinessActionContextParameter(isParamInProperty = true) TccParam tccParam);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean rollback(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这是 TCC 参与者实例，参与者需要实现三个方法，第一个参数必须是 BusinessActionContext ，方法返回类型固定，对外发布成微服务，供事务管理器调用。</p><p>prepare：资源的检查和预留。例：扣减账户的余额，并增加相同的冻结余额。</p><p>commit：使用预留的资源，完成真正的业务操作。例：减少冻结余额，扣减资金业务完成。</p><p>cancel：释放预留资源。例：冻结余额加回账户的余额。</p><p>其中 BusinessActionContext 封装了本次事务的上下文环境：xid、branchId、actionName 和被 @BusinessActionContextParam 注解的参数等。</p><p>参与方业务有几个需要注意的地方：
1.控制业务幂等性，需要支持同一笔事务的重复提交和重复回滚。
2.防悬挂，即二阶段的回滚，比一阶段的 try 先执行。
3.放宽一致性协议，最终一致，所以是读已修改</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三---remoting-包解析">三  . remoting 包解析<a href="#三---remoting-包解析" class="hash-link" aria-label="三  . remoting 包解析的直接链接" title="三  . remoting 包解析的直接链接">​</a></h2><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20191124211806237.png?" alt="在这里插入图片描述" class="img_ev3q"></p><p>包中所有的类都是为包中的 DefaultRemotingParser 服务，Dubbo、LocalTCC、SofaRpc 分别负责解析各自RPC协议下的类。</p><p>DefaultRemotingParser 的主要方法：
1.判断 bean 是否是 remoting bean，代码：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isRemoting(Object bean, String beanName) throws FrameworkException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //判断是否是服务调用方或者是否是服务提供方</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return isReference(bean, beanName) || isService(bean, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2.远程 bean 解析，把 rpc类 解析成 RemotingDesc，，代码：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isRemoting(Object bean, String beanName) throws FrameworkException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //判断是否是服务调用方或者是否是服务提供方</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return isReference(bean, beanName) || isService(bean, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>利用 allRemotingParsers 来解析远程 bean 。allRemotingParsers是在：initRemotingParser()  中调用EnhancedServiceLoader.loadAll(RemotingParser.class) 动态进行 RemotingParser 子类的加载，即 SPI 加载机制。</p><p>如果想扩展，比如实现一个feign远程调用的解析类，只要把RemotingParser相关实现类写在 SPI 的配置中就可以了，扩展性很强。</p><p>RemotingDesc 事务流程需要的远程 bean 的一些具体信息，比如 targetBean、interfaceClass、interfaceClassName、protocol、isReference等等。</p><p>3.TCC资源注册</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public RemotingDesc parserRemotingServiceInfo(Object bean, String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RemotingDesc remotingBeanDesc = getServiceDesc(bean, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (remotingBeanDesc == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remotingServiceMap.put(beanName, remotingBeanDesc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; interfaceClass = remotingBeanDesc.getInterfaceClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method[] methods = interfaceClass.getMethods();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isService(bean, beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //service bean, registry resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object targetBean = remotingBeanDesc.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (Method m : methods) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TwoPhaseBusinessAction twoPhaseBusinessAction = m.getAnnotation(TwoPhaseBusinessAction.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (twoPhaseBusinessAction != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TCCResource tccResource = new TCCResource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setActionName(twoPhaseBusinessAction.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setTargetBean(targetBean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setPrepareMethod(m);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setCommitMethodName(twoPhaseBusinessAction.commitMethod());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setCommitMethod(ReflectionUtil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getMethod(interfaceClass, twoPhaseBusinessAction.commitMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                new Class[] {BusinessActionContext.class}));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setRollbackMethodName(twoPhaseBusinessAction.rollbackMethod());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setRollbackMethod(ReflectionUtil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getMethod(interfaceClass, twoPhaseBusinessAction.rollbackMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                new Class[] {BusinessActionContext.class}));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        //registry tcc resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        DefaultResourceManager.get().registerResource(tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new FrameworkException(t, &quot;parser remoting service error&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isReference(bean, beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //reference bean, TCC proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            remotingBeanDesc.setReference(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return remotingBeanDesc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>首先判断是否是事务参与方，如果是，拿到 RemotingDesc 中的 interfaceClass，遍历接口中的方法，判断方法上是否有@TwoParserBusinessAction 注解，如果有，把参数封装成 TCCRecource，通过 DefaultResourceManager 进行 TCC 资源的注册。</p><p>这里 DefaultResourceManager 会根据 Resource 的 BranchType 来寻找对应的资源管理器，TCC 模式下资源管理类，在 tcc 模块中。</p><p>这个 rpc 解析类主要提供给 spring 模块进行使用。parserRemotingServiceInfo() 被封装到了 spring 模块的 TCCBeanParserUtils 工具类中。spring 模块的 GlobalTransactionScanner 在项目启动的时候，通过工具类解析 TCC bean，工具类 TCCBeanParserUtils 会调用 TCCResourceManager 进行资源的注册，并且如果是全局事务的服务提供者，会织入 TccActionInterceptor 代理。这些个流程是 spring 模块的功能，tcc 模块是提供功能类给 spring 模块使用。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三--tcc-资源管理器">三  .tcc 资源管理器<a href="#三--tcc-资源管理器" class="hash-link" aria-label="三  .tcc 资源管理器的直接链接" title="三  .tcc 资源管理器的直接链接">​</a></h2><p>TCCResourceManager 负责管理 TCC 模式下资源的注册、分支的注册、提交、和回滚。</p><p>1.在项目启动时， spring 模块的 GlobalTransactionScanner 扫描到 bean 是 tcc bean 时，会本地缓存资源，并向 server 注册：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void registerResource(Resource resource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TCCResource tccResource = (TCCResource)resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tccResourceCache.put(tccResource.getResourceId(), tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.registerResource(tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>与server通信的逻辑被封装在了父类 AbstractResourceManage 中，这里根据 resourceId 对 TCCResource 进行缓存。父类 AbstractResourceManage  注册资源的时候，使用 resourceGroupId + actionName，actionName 就是 @TwoParseBusinessAction 注解中的 name，resourceGroupId 默认是 DEFAULT。</p><p>2.事务分支的注册在 rm-datasource 包下的 AbstractResourceManager 中，注册时参数 lockKeys 为 null，和 AT 模式下事务分支的注册还是有些不一样的。</p><p>3.分支的提交或者回滚：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     String applicationData) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TCCResource tccResource = (TCCResource)tccResourceCache.get(resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (tccResource == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShouldNeverHappenException(&quot;TCC resource is not exist, resourceId:&quot; + resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object targetTCCBean = tccResource.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method commitMethod = tccResource.getCommitMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (targetTCCBean == null || commitMethod == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShouldNeverHappenException(&quot;TCC resource is not available, resourceId:&quot; + resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean result = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //BusinessActionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BusinessActionContext businessActionContext = getBusinessActionContext(xid, branchId, resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object ret = commitMethod.invoke(targetTCCBean, businessActionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret instanceof TwoPhaseResult) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = ((TwoPhaseResult)ret).isSuccess();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = (boolean)ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result ? BranchStatus.PhaseTwo_Committed : BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(msg, t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new FrameworkException(t, msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过参数 xid、branchId、resourceId、applicationData 恢复业务的上下文 businessActionContext。</p><p>根据获取到的上下文通过反射执行 commit 方法，并返回执行结果。回滚方法类似。</p><p>这里 branchCommit() 和 branchRollback() 提供给 rm 模块资源处理的抽象类 AbstractRMHandler 调用，这个 handler 是 core 模块定义的模板方法的进一步实现类。和 registerResource() 不一样，后者是 spring 扫描时主动注册资源。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四---tcc-模式事务处理">四  . tcc 模式事务处理<a href="#四---tcc-模式事务处理" class="hash-link" aria-label="四  . tcc 模式事务处理的直接链接" title="四  . tcc 模式事务处理的直接链接">​</a></h2><p>spring 模块中的 TccActionInterceptor 的 invoke() 方法在被代理的 rpc bean 被调用时执行。该方法先获取 rpc 拦截器透传过来的全局事务 xid ，然后 TCC 模式下全局事务参与者的事务流程还是交给 tcc 模块 ActionInterceptorHandler  处理。</p><p>也就是说，事务参与者，在项目启动的时候，被代理。真实的业务方法，在 ActionInterceptorHandler 中，通过回调执行。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public Map&lt;String, Object&gt; proceed(Method method, Object[] arguments, String xid, TwoPhaseBusinessAction businessAction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       Callback&lt;Object&gt; targetCallback) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, Object&gt; ret = new HashMap&lt;String, Object&gt;(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //TCC name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String actionName = businessAction.name();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BusinessActionContext actionContext = new BusinessActionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actionContext.setXid(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //set action anme</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actionContext.setActionName(actionName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Creating Branch Record</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String branchId = doTccActionLogStore(method, arguments, businessAction, actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actionContext.setBranchId(branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //set the parameter whose type is BusinessActionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt;[] types = method.getParameterTypes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int argIndex = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Class&lt;?&gt; cls : types) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (cls.getName().equals(BusinessActionContext.class.getName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                arguments[argIndex] = actionContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            argIndex++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //the final parameters of the try method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret.put(Constants.TCC_METHOD_ARGUMENTS, arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //the final result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret.put(Constants.TCC_METHOD_RESULT, targetCallback.execute());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里有两个重要操作：</p><p>1.doTccActionLogStore() 这个方法中，调用了两个比较重要的方法：
fetchActionRequestContext(method, arguments)，这个方法把被 @BusinessActionContextParam 注解的参数取出来，在下面的 init 方法中塞入 BusinessActionComtext ，同时塞入的还有事务相关参数。
DefaultResourceManager.get().branchRegister(BranchType.TCC, actionName, null, xid,applicationContextStr, null)，这个方法执行 TCC 模式下事务参与者事务分支的注册。</p><p>2.回调执行 targetCallback.execute() ，被代理的 bean 具体的业务，即 prepare() 方法。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五--总结">五  .总结<a href="#五--总结" class="hash-link" aria-label="五  .总结的直接链接" title="五  .总结的直接链接">​</a></h2><p>tcc模块，主要提供以下功能 ：</p><ol><li>定义两阶段协议注解，提供 tcc 模式下事务流程需要的属性。</li><li>提供解析不同 rpc 框架 remoting bean 的 ParserRemoting 实现，供 spring 模块调用。</li><li>提供 TCC 模式下资源管理器，进行资源注册、事务分支注册提交回滚等。</li><li>提供 TCC 模式下事务流程的处理类，让 MethodInterceptor 代理类不执行具体模式的事务流程，而是下放到 tcc 模块。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五--相关">五  .相关<a href="#五--相关" class="hash-link" aria-label="五  .相关的直接链接" title="五  .相关的直接链接">​</a></h2><p>作者：赵润泽，<a href="https://blog.csdn.net/qq_37804737/category_9530078.html" target="_blank" rel="noopener noreferrer">系列地址</a>。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-12-25T00:00:00.000Z" itemprop="datePublished">2019年12月25日</time> · <!-- -->阅读需 1 分钟</div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="活动介绍">活动介绍<a href="#活动介绍" class="hash-link" aria-label="活动介绍的直接链接" title="活动介绍的直接链接">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="亮点解读">亮点解读<a href="#亮点解读" class="hash-link" aria-label="亮点解读的直接链接" title="亮点解读的直接链接">​</a></h3><ul><li>Seata 开源项目发起人带来《Seata 过去、现在和未来》以及 Seata 1.0 的新特性。</li><li>Seata 核心贡献者详解 Seata AT, TCC, Saga 模式。</li><li>Seata 落地互联网医疗，滴滴出行实践剖析。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如您不能前来参会">如您不能前来参会<a href="#如您不能前来参会" class="hash-link" aria-label="如您不能前来参会的直接链接" title="如您不能前来参会的直接链接">​</a></h3><ul><li><a href="https://developer.aliyun.com/live/1760" target="_blank" rel="noopener noreferrer">预约直播（开发者社区）</a></li><li><a href="http://w2wz.com/h2nb" target="_blank" rel="noopener noreferrer">加入 Seata 千人钉钉群</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="现场福利">现场福利<a href="#现场福利" class="hash-link" aria-label="现场福利的直接链接" title="现场福利的直接链接">​</a></h3><ul><li>讲师 PPT 打包下载</li><li>精美茶歇,阿里公仔,天猫精灵等好礼等你来拿</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="议程">议程<a href="#议程" class="hash-link" aria-label="议程的直接链接" title="议程的直接链接">​</a></h3><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1K5nYwVP7gK0jSZFjXXc5aXXa-3175-14507.png" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-12-23T00:00:00.000Z" itemprop="datePublished">2019年12月23日</time> · <!-- -->阅读需 9 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">赵润泽</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一---导读">一  . 导读<a href="#一---导读" class="hash-link" aria-label="一  . 导读的直接链接" title="一  . 导读的直接链接">​</a></h2><p>core 模块定义了事务的类型、状态，通用的行为，client 和 server 通信时的协议和消息模型，还有异常处理方式，编译、压缩类型方式，配置信息名称，环境context等，还基于 netty 封装了 rpc ，供客户端和服务端使用。</p><p>按包顺序来分析一下 core 模块主要功能类：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20191223162313317.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>codec：定义了一个 codec 的工厂类，提供了一个方法，根据序列化类型来找对应的处理类。还提供了一个接口类 Codec ，有两个抽象方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;T&gt; byte[] encode(T t);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;T&gt; T decode(byte[] bytes);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>目前1.0版本在 codec 模块，有三种序列化的实现：SEATA、PROTOBUF、KRYO。</p><p>compressor：和codec包下面类一样，都是三个类，一个压缩类型类，一个工厂类，一个压缩和解压缩操作的抽象类。1.0版本就只有一种压缩方式：Gzip</p><p>constants：两个ClientTableColumnsName、ServerTableColumnsName类，分别是 client 端存储事务的表和 server 端存储事务表对应的model类。还有定义支持的数据库类型类和一些定义配置信息属性的前缀的类。</p><p>context：环境类 RootContext 持有一个 ThreadLocalContextCore 用来存储事务的标识信息。比如 TX_XID 用来唯一的表示一个事务。TX_LOCK  如果存在，则表示本地事务对于 update/delete/insert/selectForUpdate SQL 需要用全局锁控制。</p><p>event：这里用到了 guava 中 EventBus 事件总线来进行注册和通知，监听器模式。在 server 模块的 metrics 包中，MetricsManager 在初始化的时候，对 GlobalStatus 即 server 模块处理事务的几个状态变化时，注册了监挺事件，当 server 处理事务时，会回调监听的方法，主要是为了进行统计各种状态事务的数量。</p><p>lock：	server 在收到 registerBranch 消息进行分支注册的时候，会加锁。1.0版本有两种锁的实现，DataBaseLocker 和 MemoryLocker，分别是数据库锁和内存锁，数据库锁根据 rowKey = resourceId + tableName + pk 进行加锁，内存锁直接就是根据 primary key。</p><p>model：BranchStatus、GlobalStatus、BranchType 用来定义事务的类型和全局、分支状态。还有TransactionManager和ResourceManager，是 rm 和 tm 的抽象类。具体的 rm 和 tm 的实现，因为各种事务类型都不同，所以这里没有具体的实现类。</p><p>protocol：定义了 rpc 模块传输用的实体类，即每个事务状态场景下 request 和 response 的model。</p><p>store：定了与数据库打交道的数据模型，和与数据库交互的语句。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二---exception-包中-handler-类分析">二  . exception 包中 handler 类分析<a href="#二---exception-包中-handler-类分析" class="hash-link" aria-label="二  . exception 包中 handler 类分析的直接链接" title="二  . exception 包中 handler 类分析的直接链接">​</a></h2><p>这是 AbstractExceptionHandler 的 UML 图，Callback 、AbstractCallback 是 AbstractExceptionHandler 的内部接口和内部类，AbstractCallback 抽象类实现了接口 Callback 的三个方法，还有一个 execute() 未实现。AbstractExceptionHandler 使用了 AbstractCallback 作为模板方法的参数，并使用了其实现的三个方法，但是 execute() 方法仍留给子类实现。
<img loading="lazy" src="https://img-blog.csdnimg.cn/20191211165628768.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODA0NzM3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" class="img_ev3q">
从对外暴露的角度看 AbstractExceptionHandler 定义了一个带有异常处理的模板方法，模板中有四个行为，在不同的情况下执行，其中三种行为已经实现，执行的行为交由子类自行实现，详解：</p><p>1.使用模板方法模式，在 exceptionHandlerTemplate() 中，定义好了执行的模板</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public void exceptionHandleTemplate(Callback callback, AbstractTransactionRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AbstractTransactionResponse response) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback.execute(request, response); //执行事务业务的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback.onSuccess(request, response); //设置response返回码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionException tex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;Catch TransactionException while do RPC, request: {}&quot;, request, tex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback.onTransactionException(request, response, tex); //设置response返回码并设置msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RuntimeException rex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;Catch RuntimeException while do RPC, request: {}&quot;, request, rex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback.onException(request, response, rex);  //设置response返回码并设置msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>onSuccess、onTransactionException、onException 在 AbstarctCallback 中已经被实现，execute 则由AbstractExceptionHandler 子类即负责不同事务模式的 handler 类进行实现。
AbstractExceptionHandler 目前有两个子类：AbstractTCInboundHandler 负责处理全局事务的业务，AbstractRMHandler 负责处理分支事务的业务。</p><p>2.使用回调机制，优点是：允许 AbstractExceptionHandler 把需要调用的类 Callback 作为参数传递进来，handler 不需要知道 callback 的具体执行逻辑，只要知道 callback 的特性原型和限制条件(参数、返回值)，就可以使用了。</p><p>先使用模板方法，把事务业务流程定下来，再通过回调，把具体执行事务业务的方法，留给子类实现。设计的非常巧妙。</p><p>这个 exceptionHandlerTemplate() 应该翻译成带有异常处理的模板方法。异常处理已经被抽象类实现，具体的不同模式下 commit 、rollback 的业务处理则交给子类实现。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三---rpc-包分析">三  . rpc 包分析<a href="#三---rpc-包分析" class="hash-link" aria-label="三  . rpc 包分析的直接链接" title="三  . rpc 包分析的直接链接">​</a></h2><p>seata 对于 rpc 的封装，细节不需要纠结，可以研究一下一下对于事务业务的处理。</p><p>client 端的 rpc 类是 AbstractRpcRemotingClient：
<img loading="lazy" src="https://img-blog.csdnimg.cn/20191211180129741.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>重要的属性和方法都在类图中，消息发送和初始化方法没画在类图中，详细分析一下类图：</p><p>clientBootstrap：是 netty 启动类 Bootstrap 的封装类，持有了 Bootstrap 的实例，并自定义自己想要的属性。</p><p>clientChannelManager：使用 ConcurrentHashMap&lt;serverAddress,channel&gt; 容器维护地址和 channel 的对应关系。</p><p>clientMessageListener： 消息的处理类，根据消息的类型的不同有三种具体的处理方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void onMessage(RpcMessage request, String serverAddress, ClientMessageSender sender) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object msg = request.getBody();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isInfoEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;onMessage:&quot; + msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (msg instanceof BranchCommitRequest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleBranchCommit(request, serverAddress, (BranchCommitRequest)msg, sender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (msg instanceof BranchRollbackRequest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleBranchRollback(request, serverAddress, (BranchRollbackRequest)msg, sender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (msg instanceof UndoLogDeleteRequest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleUndoLogDelete((UndoLogDeleteRequest)msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>消息类中，持有 TransactionMessageHandler 对不同类型消息进行处理，最终会根据事务类型的不同（AT、TCC、SAGE）调用具体的处理类，即第二部分说的 exceptionHandleTemplate() 的实现类。</p><p>mergeSendExecutorService：是一个线程池，只有一个线程，负责对不同地址下的消息进行和并发送。在 sendAsyncRequest() 中，会给线程池的队列LinkedBlockingQueue<!-- -->&lt;<!-- -->&gt;<!-- -->  offer 消息，然后这个线程负责 poll 和处理消息。</p><p>channelRead()：处理服务端的 HeartbeatMessage.PONG 心跳消息。还有消息类型是 MergeResultMessage 即异步消息的响应消息，根据 msgId 找到对应 MessageFuture ，并设置异步消息的 result 结果。</p><p>dispatch()：调用 clientMessageListener 处理 server 发送过来的消息，不同类型 request 有不同的处理类。</p><p>简单点看 netty，只需要关注序列化方式和消息处理handler类。seata 的 rpc 序列化方式通过工厂类找 Codec 实现类进行处理，handler 即上文说的 TransactionMessageHandler 。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四---总结">四  . 总结<a href="#四---总结" class="hash-link" aria-label="四  . 总结的直接链接" title="四  . 总结的直接链接">​</a></h2><p>core 模块涉及的功能很多，其中的类大多都是其他模块的抽象类。抽象出业务模型，具体的实现分布在不同的模块。core 模块的代码非常的优秀，很多设计都是经典，比如上文分析的基于模板模式改造的，非常实用也非常美，值得仔细研究。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五---seata源码分析系列地址">五  . seata源码分析系列地址<a href="#五---seata源码分析系列地址" class="hash-link" aria-label="五  . seata源码分析系列地址的直接链接" title="五  . seata源码分析系列地址的直接链接">​</a></h2><p><a href="https://blog.csdn.net/qq_37804737/category_9530078.html" target="_blank" rel="noopener noreferrer">系列地址</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-12-23T00:00:00.000Z" itemprop="datePublished">2019年12月23日</time> · <!-- -->阅读需 5 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">FUNKYE</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>本文作者：FUNKYE(陈健斌),杭州某互联网公司主程。</p><h1>前言</h1><p>通过GA大会上滴滴出行的高级研发工程陈鹏志的在滴滴两轮车业务中的实践,发现动态降级的必要性是非常的高,所以这边简单利用spring boot aop来简单的处理降级相关的处理,这边非常感谢陈鹏志的分享!</p><p>可利用此demo<a href="https://gitee.com/itCjb/springboot-dubbo-mybatisplus-seata" target="_blank" rel="noopener noreferrer">项目地址</a></p><p>通过以下代码改造实践.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="准备工作">准备工作<a href="#准备工作" class="hash-link" aria-label="准备工作的直接链接" title="准备工作的直接链接">​</a></h2><p>​	1.创建测试用的TestAspect:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.reflect.Method; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.commons.lang3.StringUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.aspectj.lang.JoinPoint;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.aspectj.lang.annotation.AfterReturning;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.aspectj.lang.annotation.AfterThrowing;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.aspectj.lang.annotation.Aspect;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.aspectj.lang.annotation.Before;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.aspectj.lang.reflect.MethodSignature;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.core.context.RootContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.core.exception.TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.tm.api.GlobalTransaction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.tm.api.GlobalTransactionContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Aspect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TestAspect {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(TestAspect.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Before(&quot;execution(* org.test.service.*.*(..))&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void before(JoinPoint joinPoint) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MethodSignature signature = (MethodSignature)joinPoint.getSignature();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method method = signature.getMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;拦截到需要分布式事务的方法,&quot; + method.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 此处可用redis或者定时任务来获取一个key判断是否需要关闭分布式事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 模拟动态关闭分布式事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ((int)(Math.random() * 100) % 2 == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.begin(300000, &quot;test-client&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(&quot;关闭分布式事务&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AfterThrowing(throwing = &quot;e&quot;, pointcut = &quot;execution(* org.test.service.*.*(..))&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doRecoveryActions(Throwable e) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;方法执行异常:{}&quot;, e.getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.isBlank(RootContext.getXID()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            GlobalTransactionContext.reload(RootContext.getXID()).rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AfterReturning(value = &quot;execution(* org.test.service.*.*(..))&quot;, returning = &quot;result&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void afterReturning(JoinPoint point, Object result) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;方法执行结束:{}&quot;, result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ((Boolean)result) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!StringUtils.isBlank(RootContext.getXID())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger.info(&quot;分布式事务Id:{}&quot;, RootContext.getXID());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalTransactionContext.reload(RootContext.getXID()).commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请注意上面的包名可改为你自己的service包名:</p><p>​	2.改动service代码:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public Object seataCommit() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        testService.Commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因为异常跟返回结果我们都会拦截,所以这边可以trycatch或者直接让他抛异常来拦截也行,或者直接判断返回结果,比如你的业务代码code=200为成功,那么就commit,反之在拦截返回值那段代码加上rollback;</p><h1>进行调试</h1><p>​	1.更改代码主动抛出异常</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public Object seataCommit() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            testService.Commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int i = 1 / 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // TODO: handle exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	查看日志:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 11:57:55.386  INFO 23952 --- [.0-28888-exec-7] org.test.controller.TestController       : 拦截到需要分布式事务的方法,seataCommit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 11:57:55.489  INFO 23952 --- [.0-28888-exec-7] i.seata.tm.api.DefaultGlobalTransaction  : Begin new global transaction [192.168.14.67:8092:2030765910]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 11:57:55.489  INFO 23952 --- [.0-28888-exec-7] org.test.controller.TestController       : 创建分布式事务完毕192.168.14.67:8092:2030765910</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 11:57:55.709  INFO 23952 --- [.0-28888-exec-7] org.test.controller.TestController       : 方法执行异常:null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 11:57:55.885  INFO 23952 --- [.0-28888-exec-7] i.seata.tm.api.DefaultGlobalTransaction  : [192.168.14.67:8092:2030765910] rollback status: Rollbacked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 11:57:55.888 ERROR 23952 --- [.0-28888-exec-7] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.RuntimeException] with root cause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	可以看到已被拦截也触发了rollback了.</p><p>​	2.恢复代码调试正常情况:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public Object seataCommit() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        testService.Commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	查看日志:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 12:00:20.876  INFO 23952 --- [.0-28888-exec-2] org.test.controller.TestController       : 拦截到需要分布式事务的方法,seataCommit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 12:00:20.919  INFO 23952 --- [.0-28888-exec-2] i.seata.tm.api.DefaultGlobalTransaction  : Begin new global transaction [192.168.14.67:8092:2030765926]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 12:00:20.920  INFO 23952 --- [.0-28888-exec-2] org.test.controller.TestController       : 创建分布式事务完毕192.168.14.67:8092:2030765926</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 12:00:21.078  INFO 23952 --- [.0-28888-exec-2] org.test.controller.TestController       : 方法执行结束:true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 12:00:21.078  INFO 23952 --- [.0-28888-exec-2] org.test.controller.TestController       : 分布式事务Id:192.168.14.67:8092:2030765926</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-12-23 12:00:21.213  INFO 23952 --- [.0-28888-exec-2] i.seata.tm.api.DefaultGlobalTransaction  : [192.168.14.67:8092:2030765926] commit status: Committed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	可以看到事务已经被提交了.</p><h1>总结</h1><p>更详细的内容希望希望大家访问以下地址阅读详细文档</p><p><a href="https://nacos.io/zh-cn/index.html" target="_blank" rel="noopener noreferrer">nacos官网</a></p><p><a href="http://dubbo.apache.org/en-us/" target="_blank" rel="noopener noreferrer">dubbo官网</a></p><p><a href="http://seata.io/zh-cn/" target="_blank" rel="noopener noreferrer">seata官网</a></p><p><a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">docker官网</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-12-17T00:00:00.000Z" itemprop="datePublished">2019年12月17日</time> · <!-- -->阅读需 8 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Seata 的动态降级需要结合配置中心的动态配置订阅功能。动态配置订阅，即通过配置中心监听订阅，根据需要读取已更新的缓存值，ZK、Apollo、Nacos 等第三方配置中心都有现成的监听器可实现动态刷新配置；动态降级，即通过动态更新指定配置参数值，使得 Seata 能够在运行过程中动态控制全局事务失效（目前只有 AT 模式有这个功能）。</p><p>那么 Seata 支持的多个配置中心是如何适配不同的动态配置订阅以及如何实现降级的呢？下面从源码的层面详细给大家讲解一番。</p><h1>动态配置订阅</h1><p>Seata 配置中心有一个监听器基准接口，它主要有一个抽象方法和 default 方法，如下：</p><p>io.seata.config.ConfigurationChangeListener</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191216212442.png" class="img_ev3q"></p><p>该监听器基准接口主要有两个实现类型：</p><ol><li>实现注册配置订阅事件监听器：用于实现各种功能的动态配置订阅，比如 GlobalTransactionalInterceptor 实现了 ConfigurationChangeListener，根据动态配置订阅实现的动态降级功能；</li><li>实现配置中心动态订阅功能与适配：对于目前还没有动态订阅功能的 file 类型默认配置中心，可以实现该基准接口来实现动态配置订阅功能；对于阻塞订阅需要另起一个线程去执行，这时候可以实现该基准接口进行适配，还可以复用该基准接口的线程池；以及还有异步订阅，有订阅单个 key，有订阅多个 key 等等，我们都可以实现该基准接口以适配各个配置中心。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nacos-动态订阅实现">Nacos 动态订阅实现<a href="#nacos-动态订阅实现" class="hash-link" aria-label="Nacos 动态订阅实现的直接链接" title="Nacos 动态订阅实现的直接链接">​</a></h2><p>Nacos 有自己内部实现的监听器，因此直接直接继承它内部抽象监听器 AbstractSharedListener，实现如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191223212237.png" class="img_ev3q"></p><p>如上，</p><ul><li>dataId：为订阅的配置属性；</li><li>listener：配置订阅事件监听器，用于将外部传入的 listener 作为一个 wrapper，执行真正的变更逻辑。</li></ul><p>值得一提的是，nacos 并没有使用 ConfigurationChangeListener 实现自己的监听配置，一方面是因为 Nacos 本身已有监听订阅功能，不需要自己再去实现；另一方面因为 nacos 属于非阻塞式订阅，不需要复用 ConfigurationChangeListener 的线程池，即无需进行适配。</p><p>添加订阅：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191223213347.png" class="img_ev3q"></p><p>Nacos 配置中心为某个 dataId 添加订阅的逻辑很简单，用 dataId 和 listener 创建一个 NacosListener 调用 configService#addListener 方法，把 NacosListener 作为 dataId 的监听器，dataId 就实现了动态配置订阅功能。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="file-动态订阅实现">file 动态订阅实现<a href="#file-动态订阅实现" class="hash-link" aria-label="file 动态订阅实现的直接链接" title="file 动态订阅实现的直接链接">​</a></h2><p>以它的实现类 FileListener 举例子，它的实现逻辑如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191215151642.png" class="img_ev3q"></p><p>如上，</p><ul><li><p>dataId：为订阅的配置属性；</p></li><li><p>listener：配置订阅事件监听器，用于将外部传入的 listener 作为一个 wrapper，执行真正的变更逻辑，这里特别需要注意的是，<strong>该监听器与 FileListener 同样实现了 ConfigurationChangeListener 接口，只不过 FileListener 是用于给 file 提供动态配置订阅功能，而 listener 用于执行配置订阅事件</strong>；</p></li><li><p>executor：用于处理配置变更逻辑的线程池，在 ConfigurationChangeListener#onProcessEvent 方法中用到。</p></li></ul><p><strong>FileListener#onChangeEvent 方法的实现让 file 具备了动态配置订阅的功能</strong>，它的逻辑如下：</p><p>无限循环获取订阅的配置属性当前的值，从缓存中获取旧的值，判断是否有变更，如果有变更就执行外部传入 listener 的逻辑。</p><p>ConfigurationChangeEvent 用于保存配置变更的事件类，它的成员属性如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191215175232.png" class="img_ev3q"></p><p>这里的 getConfig 方法是如何感知 file 配置的变更呢？我们点进去，发现它最终的逻辑如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191215162713.png" class="img_ev3q"></p><p>发现它是创建一个 future 类，然后包装成一个 Runnable 放入线程池中异步执行，最后调用 get 方法阻塞获取值，那么我们继续往下看：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191215170908.png" class="img_ev3q"></p><p>allowDynamicRefresh：动态刷新配置开关；</p><p>targetFileLastModified：file 最后更改的时间缓存。</p><p>以上逻辑：</p><p>获取 file 最后更新的时间值 tempLastModified，然后对比对比缓存值 targetFileLastModified，如果 tempLastModified &gt; targetFileLastModified，说明期间配置有更改过，这时就重新加载 file 实例，替换掉旧的 fileConfig，使得后面的操作能够获取到最新的配置值。</p><p>添加一个配置属性监听器的逻辑如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191215161103.png" class="img_ev3q"></p><p>configListenersMap 为 FileConfiguration 的配置监听器缓存，它的数据结构如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ConcurrentMap&lt;String/*dataId*/, Set&lt;ConfigurationChangeListener&gt;&gt; configListenersMap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从数据结构上可看出，每个配置属性可关联多个事件监听器。</p><p>最终执行 onProcessEvent 方法，这个是监听器基准接口里面的 default 方法，它会调用 onChangeEvent 方法，即最终会调用 FileListener 中的实现。</p><h1>动态降级</h1><p>有了以上的动态配置订阅功能，我们只需要实现 ConfigurationChangeListener 监听器，就可以做各种各种的功能，目前 Seata 只有动态降级有用到动态配置订阅的功能。</p><p>在「<a href="https://mp.weixin.qq.com/s/n9MHk47zSsFQmV-gBq_P1A" target="_blank" rel="noopener noreferrer">Seata AT 模式启动源码分析</a>」这篇文章中讲到，Spring 集成 Seata 的项目中，在 AT 模式启动时，会用 用GlobalTransactionalInterceptor 代替了被 GlobalTransactional 和 GlobalLock 注解的方法，GlobalTransactionalInterceptor 实现了 MethodInterceptor，最终会执行 invoker 方法，那么想要实现动态降级，就可以在这里做手脚。</p><ul><li>在 GlobalTransactionalInterceptor 中加入一个成员变量：</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private volatile boolean disable; </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在构造函数中进行初始化赋值：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191215173221.png" class="img_ev3q"></p><p>ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION（service.disableGlobalTransaction）这个参数目前有两个功能：</p><ol><li>在启动时决定是否开启全局事务；</li><li>在开启全局事务后，决定是否降级。</li></ol><ul><li>实现 ConfigurationChangeListener：</li></ul><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191215173358.png" class="img_ev3q"></p><p>这里的逻辑简单，就是判断监听事件是否属于 ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION 配置属性，如果是，直接更新 disable 值。</p><ul><li>接下来在 GlobalTransactionalInterceptor#invoke 中做点手脚</li></ul><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191215174155.png" class="img_ev3q"></p><p>如上，disable = true 时，不执行全局事务与全局锁。</p><ul><li>配置中心订阅降级监听器</li></ul><p>io.seata.spring.annotation.GlobalTransactionScanner#wrapIfNecessary</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191215174409.png" class="img_ev3q"></p><p>在 Spring AOP 进行 wrap 逻辑过程中，当前配置中心将订阅降级事件监听器。</p><h1>作者简介</h1><p>张乘辉，目前就职于中通科技信息中心技术平台部，担任 Java 工程师，主要负责中通消息平台与全链路压测项目的研发，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Contributor，GitHub ID：objcoding。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-config-center">Seata 配置中心实现原理</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-12-12T00:00:00.000Z" itemprop="datePublished">2019年12月12日</time> · <!-- -->阅读需 8 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Seata 可以支持多个第三方配置中心，那么 Seata 是如何同时兼容那么多个配置中心的呢？下面我给大家详细介绍下 Seata 配置中心的实现原理。</p><h1>配置中心属性加载</h1><p>在 Seata 配置中心，有两个默认的配置文件：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211193041.png" class="img_ev3q"></p><p>file.conf 是默认的配置属性，registry.conf 主要存储第三方注册中心与配置中心的信息，主要有两大块：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">registry </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # file、nacos 、apollo、zk、consul、etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = </span><span class="token string" style="color:#e3116c">&quot;file&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = </span><span class="token string" style="color:#e3116c">&quot;file.conf&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 registry 为注册中心的配置属性，这里先不讲，config 为配置中心的属性值，默认为 file 类型，即会加载本地的 file.conf 里面的属性，如果 type 为其它类型，那么会从第三方配置中心加载配置属性值。</p><p>在 config 模块的 core 目录中，有个配置工厂类 ConfigurationFactory，它的结构如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191210211022.png" class="img_ev3q"></p><p>可以看到都是一些配置的静态常量：</p><p>REGISTRY_CONF_PREFIX、REGISTRY_CONF_SUFFIX：配置文件名、默认配置文件类型；</p><p>SYSTEM_PROPERTY_SEATA_CONFIG_NAME、ENV_SEATA_CONFIG_NAME、ENV_SYSTEM_KEY、ENV_PROPERTY_KEY：自定义文件名配置变量，也说明我们可以自定义配置中心的属性文件。</p><p>ConfigurationFactory 里面有一处静态代码块，如下：</p><p>io.seata.config.ConfigurationFactory</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211102702.png" class="img_ev3q"></p><p>根据自定义文件名配置变量找出配置文件名称与类型，如果没有配置，默认使用 registry.conf，FileConfiguration 是 Seata 默认的配置实现类，如果为默认值，则会更具  registry.conf 配置文件生成 FileConfiguration 默认配置对象，这里也可以利用 SPI 机制支持第三方扩展配置实现，具体实现是继承 ExtConfigurationProvider 接口，在<code>META-INF/services/</code>创建一个文件并填写实现类的全路径名，如下所示：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211194643.png" class="img_ev3q"></p><h1>第三方配置中心实现类加载</h1><p>在静态代码块逻辑加载完配置中心属性之后，Seata 是如何选择配置中心并获取配置中心的属性值的呢？</p><p>我们刚刚也说了 FileConfiguration 是 Seata 的默认配置实现类，它继承了 AbstractConfiguration，它的基类为 Configuration，提供了获取参数值的方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">short getShort(String dataId, int defaultValue, long timeoutMills);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int getInt(String dataId, int defaultValue, long timeoutMills);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">long getLong(String dataId, long defaultValue, long timeoutMills);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ....</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>那么意味着只需要第三方配置中心实现该接口，就可以整合到 Seata 配置中心了，下面我拿 zk 来做例子：</p><p>首先，第三方配置中心需要实现一个 Provider 类：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211200155.png" class="img_ev3q"></p><p>实现的 provider 方法如其名，主要是输出具体的 Configuration 实现类。</p><p>那么我们是如何获取根据配置去获取对应的第三方配置中心实现类呢？</p><p>在 Seata 项目中，获取一个第三方配置中心实现类通常是这么做的：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Configuration CONFIG = ConfigurationFactory.getInstance();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 getInstance() 方法中主要是使用了单例模式构造配置实现类，它的构造具体实现如下：</p><p>io.seata.config.ConfigurationFactory#buildConfiguration：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211102905.png" class="img_ev3q"></p><p>首先从 ConfigurationFactory 中的静态代码块根据 registry.conf 创建的 CURRENT_FILE_INSTANCE 中获取当前环境使用的配置中心，默认为为 File 类型，我们也可以在 registry.conf 配置其它第三方配置中心，这里也是利用了 SPI 机制去加载第三方配置中心的实现类，具体实现如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211205127.png" class="img_ev3q"></p><p>如上，即是刚刚我所说的 ZookeeperConfigurationProvider 配置实现输出类，我们再来看看这行代码：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EnhancedServiceLoader.load(ConfigurationProvider.class,Objects.requireNonNull(configType).name()).provide();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>EnhancedServiceLoader 是 Seata SPI 实现核心类，这行代码会加载 <code>META-INF/services/</code>和 <code>META-INF/seata/</code>目录中文件填写的类名，那么如果其中有多个配置中心实现类都被加载了怎么办呢？</p><p>我们注意到 ZookeeperConfigurationProvider 类的上面有一个注解：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@LoadLevel(name = &quot;ZK&quot;, order = 1)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在加载多个配置中心实现类时，会根据 order 进行排序：</p><p>io.seata.common.loader.EnhancedServiceLoader#findAllExtensionClass：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211210438.png" class="img_ev3q"></p><p>io.seata.common.loader.EnhancedServiceLoader#loadFile：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211210347.png" class="img_ev3q"></p><p>这样，就不会产生冲突了。</p><p>但是我们发现 Seata 还可以用这个方法进行选择，Seata 在调用 load 方法时，还传了一个参数：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Objects.requireNonNull(configType).name()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ConfigType 为配置中心类型，是个枚举类：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public enum ConfigType {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  File, ZK, Nacos, Apollo, Consul, Etcd3, SpringCloudConfig, Custom;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们注意到，LoadLevel 注解上还有一个 name 属性，在进行筛选实现类时，Seata 还做了这个操作：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211211210.png" class="img_ev3q"></p><p>根据当前 configType 来判断是否等于 LoadLevel 的 name 属性，如果相等，那么就是当前配置的第三方配置中心实现类。</p><h1>第三方配置中心实现类</h1><p>ZookeeperConfiguration 继承了 AbstractConfiguration，它的构造方法如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211202510.png" class="img_ev3q"></p><p>构造方法创建了一个 zkClient 对象，这里的 FILE_CONFIG 是什么呢？</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static final Configuration FILE_CONFIG = ConfigurationFactory.CURRENT_FILE_INSTANCE;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>原来就是刚刚静态代码块中创建的 registry.conf 配置实现类，从该配置实现类拿到第三方配置中心的相关属性，构造第三方配置中心客户端，然后实现 Configuration 接口时：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211203735.png" class="img_ev3q"></p><p>就可以利用客户端相关方法去第三方配置获取对应的参数值了。</p><h1>第三方配置中心配置同步脚本</h1><p>上周末才写好，已经提交 PR 上去了，还处于 review 中，预估会在 Seata 1.0 版本提供给大家使用，敬请期待。</p><p>具体位置在 Seata 项目的 script 目录中：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191211212141.png" class="img_ev3q"></p><p>config.txt 为本地配置好的值，搭建好第三方配置中心之后，运行脚本会将 config.txt 的配置同步到第三方配置中心。</p><h1>作者简介</h1><p>张乘辉，目前就职于中通科技信息中心技术平台部，担任 Java 工程师，主要负责中通消息平台与全链路压测项目的研发，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Contributor，GitHub ID：objcoding。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-12-03T00:00:00.000Z" itemprop="datePublished">2019年12月3日</time> · <!-- -->阅读需 12 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">FUNKYE</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>运行所使用的demo<a href="https://gitee.com/itCjb/springboot-dubbo-mybatisplus-seata" target="_blank" rel="noopener noreferrer">项目地址</a></p><p>本文作者：FUNKYE(陈健斌),杭州某互联网公司主程。</p><h1>前言</h1><p>直连方式的Seata配置<a href="http://seata.io/zh-cn/blog/springboot-dubbo-mybatisplus-seata.html" target="_blank" rel="noopener noreferrer">博客</a></p><p>Seata整合Nacos配置<a href="http://seata.io/zh-cn/blog/seata-nacos-analysis.html" target="_blank" rel="noopener noreferrer">博客</a></p><p>我们接着前几篇篇的基础上去配置nacos做配置中心跟dubbo注册中心.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="准备工作">准备工作<a href="#准备工作" class="hash-link" aria-label="准备工作的直接链接" title="准备工作的直接链接">​</a></h2><p>​	1.安装docker</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yum -y </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	2.创建nacos与seata的数据库</p><div class="language-mysql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mysql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   数据库全名 = nacos   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   表名称 = config_info   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `config_info` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `group_id` varchar(255) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_create` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27; COMMENT &#x27;创建时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27; COMMENT &#x27;修改时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `src_ip` varchar(20) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `app_name` varchar(128) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `c_desc` varchar(256) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `c_use` varchar(64) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `effect` varchar(64) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `type` varchar(64) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `c_schema` text,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   数据库全名 = nacos_config   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   表名称 = config_info_aggr   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `config_info_aggr` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `group_id` varchar(255) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `datum_id` varchar(255) NOT NULL COMMENT &#x27;datum_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `content` longtext NOT NULL COMMENT &#x27;内容&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` datetime NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `app_name` varchar(128) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;增加租户字段&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   数据库全名 = nacos_config   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   表名称 = config_info_beta   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `config_info_beta` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `beta_ips` varchar(1024) DEFAULT NULL COMMENT &#x27;betaIps&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_create` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27; COMMENT &#x27;创建时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27; COMMENT &#x27;修改时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `src_ip` varchar(20) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_beta&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   数据库全名 = nacos_config   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   表名称 = config_info_tag   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `config_info_tag` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tag_id` varchar(128) NOT NULL COMMENT &#x27;tag_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_create` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27; COMMENT &#x27;创建时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27; COMMENT &#x27;修改时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `src_ip` varchar(20) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_tag&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   数据库全名 = nacos_config   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   表名称 = config_tags_relation   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `config_tags_relation` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(20) NOT NULL COMMENT &#x27;id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tag_name` varchar(128) NOT NULL COMMENT &#x27;tag_name&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tag_type` varchar(64) DEFAULT NULL COMMENT &#x27;tag_type&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `nid` bigint(20) NOT NULL AUTO_INCREMENT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`nid`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KEY `idx_tenant_id` (`tenant_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_tag_relation&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   数据库全名 = nacos_config   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   表名称 = group_capacity   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `group_capacity` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `group_id` varchar(128) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Group ID，空字符表示整个集群&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `quota` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;配额，0表示使用默认值&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `usage` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;使用量&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `max_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;聚合子配置最大个数，，0表示使用默认值&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;最大变更历史数量&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_create` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27; COMMENT &#x27;创建时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27; COMMENT &#x27;修改时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIQUE KEY `uk_group_id` (`group_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;集群、各Group容量信息表&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   数据库全名 = nacos_config   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   表名称 = his_config_info   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `his_config_info` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(64) unsigned NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `data_id` varchar(255) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `group_id` varchar(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `content` longtext NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `md5` varchar(32) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_create` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `src_user` text,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `src_ip` varchar(20) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `op_type` char(10) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`nid`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KEY `idx_gmt_create` (`gmt_create`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KEY `idx_did` (`data_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;多租户改造&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   数据库全名 = nacos_config   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*   表名称 = tenant_capacity   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/******************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `tenant_capacity` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tenant_id` varchar(128) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Tenant ID&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `quota` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;配额，0表示使用默认值&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `usage` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;使用量&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `max_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;聚合子配置最大个数&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;最大变更历史数量&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_create` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27; COMMENT &#x27;创建时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` datetime NOT NULL DEFAULT &#x27;2010-05-05 00:00:00&#x27; COMMENT &#x27;修改时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIQUE KEY `uk_tenant_id` (`tenant_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;租户容量信息表&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `tenant_info` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `kp` varchar(128) NOT NULL COMMENT &#x27;kp&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tenant_id` varchar(128) default &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tenant_name` varchar(128) default &#x27;&#x27; COMMENT &#x27;tenant_name&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `tenant_desc` varchar(256) DEFAULT NULL COMMENT &#x27;tenant_desc&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `create_source` varchar(32) DEFAULT NULL COMMENT &#x27;create_source&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_create` bigint(20) NOT NULL COMMENT &#x27;创建时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` bigint(20) NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KEY `idx_tenant_id` (`tenant_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;tenant_info&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE users (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username varchar(50) NOT NULL PRIMARY KEY,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password varchar(500) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled boolean NOT NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE roles (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username varchar(50) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    role varchar(50) NOT NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO users (username, password, enabled) VALUES (&#x27;nacos&#x27;, &#x27;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#x27;, TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO roles (username, role) VALUES (&#x27;nacos&#x27;, &#x27;ROLE_ADMIN&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-mysql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mysql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- the table to store GlobalSession data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE IF NOT EXISTS `global_table`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `xid`                       VARCHAR(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `transaction_id`            BIGINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `status`                    TINYINT      NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `application_id`            VARCHAR(32),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `transaction_service_group` VARCHAR(32),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `transaction_name`          VARCHAR(128),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `timeout`                   INT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `begin_time`                BIGINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `application_data`          VARCHAR(2000),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_create`                DATETIME,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_modified`              DATETIME,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY (`xid`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_transaction_id` (`transaction_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = InnoDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DEFAULT CHARSET = utf8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- the table to store BranchSession data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE IF NOT EXISTS `branch_table`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `branch_id`         BIGINT       NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `xid`               VARCHAR(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `transaction_id`    BIGINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `resource_group_id` VARCHAR(32),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `resource_id`       VARCHAR(256),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `branch_type`       VARCHAR(8),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `status`            TINYINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `client_id`         VARCHAR(64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `application_data`  VARCHAR(2000),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_create`        DATETIME(6),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_modified`      DATETIME(6),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY (`branch_id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_xid` (`xid`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = InnoDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DEFAULT CHARSET = utf8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- the table to store lock data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE IF NOT EXISTS `lock_table`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `row_key`        VARCHAR(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `xid`            VARCHAR(128),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `transaction_id` BIGINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `branch_id`      BIGINT       NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `resource_id`    VARCHAR(256),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `table_name`     VARCHAR(32),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `pk`             VARCHAR(36),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_create`     DATETIME,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_modified`   DATETIME,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY (`row_key`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_branch_id` (`branch_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = InnoDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DEFAULT CHARSET = utf8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	3.拉取nacos以及seata镜像并运行</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run -d --name nacos -p </span><span class="token number" style="color:#36acaa">8848</span><span class="token plain">:8848 -e </span><span class="token assign-left variable" style="color:#36acaa">MODE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">standalone -e </span><span class="token assign-left variable" style="color:#36acaa">MYSQL_MASTER_SERVICE_HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">你的mysql所在ip -e </span><span class="token assign-left variable" style="color:#36acaa">MYSQL_MASTER_SERVICE_DB_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nacos -e </span><span class="token assign-left variable" style="color:#36acaa">MYSQL_MASTER_SERVICE_USER</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">root -e </span><span class="token assign-left variable" style="color:#36acaa">MYSQL_MASTER_SERVICE_PASSWORD</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mysql密码 -e </span><span class="token assign-left variable" style="color:#36acaa">MYSQL_SLAVE_SERVICE_HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">你的mysql所在ip -e </span><span class="token assign-left variable" style="color:#36acaa">SPRING_DATASOURCE_PLATFORM</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mysql -e </span><span class="token assign-left variable" style="color:#36acaa">MYSQL_DATABASE_NUM</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> nacos/nacos-server:latest</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run -d --name seata -p </span><span class="token number" style="color:#36acaa">8091</span><span class="token plain">:8091 -e </span><span class="token assign-left variable" style="color:#36acaa">SEATA_IP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">你想指定的ip -e </span><span class="token assign-left variable" style="color:#36acaa">SEATA_PORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8091</span><span class="token plain"> seataio/seata-server:1.4.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata配置">Seata配置<a href="#seata配置" class="hash-link" aria-label="Seata配置的直接链接" title="Seata配置的直接链接">​</a></h2><p>​	1.由于seata容器内没有内置vim,我们可以直接将要文件夹cp到宿主机外来编辑好了,再cp回去</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker cp 容器id:seata-server/resources 你想放置的目录</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	2.使用如下代码获取两个容器的ip地址</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker inspect --format=&#x27;{{.NetworkSettings.IPAddress}}&#x27; ID/NAMES</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	3.nacos-config.txt编辑为如下内容</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">transport.type=TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.server=NIO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.heartbeat=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.enableClientBatchSendRequest=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.threadFactory.bossThreadPrefix=NettyBoss</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.threadFactory.shareBossWorker=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.threadFactory.clientSelectorThreadSize=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.threadFactory.bossThreadSize=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.threadFactory.workerThreadSize=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.shutdown.wait=3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service.vgroupMapping.你的事务组名=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service.default.grouplist=127.0.0.1:8091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service.enableDegrade=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service.disableGlobalTransaction=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.rm.asyncCommitBufferLimit=10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.rm.lock.retryInterval=10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.rm.lock.retryTimes=30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.rm.lock.retryPolicyBranchRollbackOnConflict=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.rm.reportRetryCount=5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.rm.tableMetaCheckEnable=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.rm.tableMetaCheckerInterval=60000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.rm.sqlParserType=druid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.rm.reportSuccessEnable=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.rm.sagaBranchRegisterEnable=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.tm.commitRetryCount=5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.tm.rollbackRetryCount=5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.tm.defaultGlobalTransactionTimeout=60000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.tm.degradeCheck=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.tm.degradeCheckAllowTimes=10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.tm.degradeCheckPeriod=2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.mode=file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.publicKey=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.file.dir=file_store/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.file.maxBranchSessionSize=16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.file.maxGlobalSessionSize=512</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.file.fileWriteBufferCacheSize=16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.file.flushDiskMode=async</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.file.sessionReloadReadSize=100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.datasource=druid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.dbType=mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.driverClassName=com.mysql.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.url=jdbc:mysql://你的mysql所在ip:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.user=mysql账号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.password=mysql密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.minConn=5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.maxConn=30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.globalTable=global_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.branchTable=branch_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.queryLimit=100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.lockTable=lock_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.maxWait=5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.recovery.committingRetryPeriod=1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.recovery.asynCommittingRetryPeriod=1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.recovery.rollbackingRetryPeriod=1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.recovery.timeoutRetryPeriod=1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.maxCommitRetryTimeout=-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.maxRollbackRetryTimeout=-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.rollbackRetryTimeoutUnlockEnable=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.undo.dataValidation=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.undo.logSerialization=jackson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.undo.onlyCareUpdateColumns=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.undo.logSaveDays=7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.undo.logDeletePeriod=86400000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.undo.logTable=undo_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.undo.compress.enable=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.undo.compress.type=zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.undo.compress.threshold=64k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log.exceptionRate=100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.serialization=seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport.compressor=none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metrics.enabled=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metrics.registryType=compact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metrics.exporterList=prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metrics.exporterPrometheusPort=9898</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>详细参数配置请点<a href="http://seata.io/zh-cn/docs/user/configurations.html" target="_blank" rel="noopener noreferrer">此处</a></p><p>​	4.registry.conf编辑为如下内容</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">registry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;nacos容器ip:8848&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # file、nacos 、apollo、zk、consul、etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;nacos容器ip:8848&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	5.配置完成后使用如下命令,把修改完成的registry.conf复制到容器中,并重启查看日志运行</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> /home/seata/resources/registry.conf seata:seata-server/resources/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> restart seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> logs -f seata</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	6.运行nacos-config.sh导入Nacos配置</p><p>eg: sh ${SEATAPATH}/script/config-center/nacos/nacos-config.sh -h localhost -p 8848 -g SEATA_GROUP -t 5a3c7d6c-f497-4d68-a71a-2e5e3340b3ca -u username -w password</p><p>具体参数释义参考：<a href="https://github.com/apache/incubator-seata/blob/1.4.2/script/config-center/README.md" target="_blank" rel="noopener noreferrer">配置导入说明</a></p><p>​	7.登录nacos控制中心查看</p><p><img loading="lazy" alt="20191202205912" src="/zh-cn/assets/images/20191202205912-4d939ad3e578e3d7997d786bc108775e.png" width="1826" height="643" class="img_ev3q"></p><p>​	如图所示便是成功了.</p><h1>进行调试</h1><p>​	1.拉取博文中所示的项目,修改test-service的application.yml与registry.conf</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">registry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;宿主机ip:8848&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;宿主机ip:8848&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  port: 38888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: test-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  datasource:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: com.alibaba.druid.pool.DruidDataSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    url: jdbc:mysql://mysqlip:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password: 123456</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dubbo:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  protocol:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadpool: cached</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scan:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    base-packages: com.example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    qos-enable: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: testserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id: my-registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address:  nacos://宿主机ip:8848</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mybatis-plus:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mapper-locations: classpath:/mapper/*Mapper.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  typeAliasesPackage: org.test.entity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  global-config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db-config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      field-strategy: not-empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id-type: auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      db-type: mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  configuration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map-underscore-to-camel-case: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache-enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto-mapping-unknown-column-behavior: none</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	2.把修改完成的registry.conf复制到test-client-resources中,并修改application</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     name: test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  datasource:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     driver-class-name: com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     url: jdbc:mysql://mysqlIp:3306/test?userSSL=true&amp;useUnicode=true&amp;characterEncoding=UTF8&amp;serverTimezone=Asia/Shanghai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     username: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     password: 123456</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mvc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    servlet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      load-on-startup: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoding:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            force: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            charset: utf-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    multipart:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-file-size: 10MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-request-size: 10MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dubbo:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id: my-registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address:  nacos://宿主机ip:8848</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: dubbo-demo-client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    qos-enable: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  port: 28888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  max-http-header-size: 8192</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address: 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tomcat:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max-http-post-size: 104857600</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	4. 在每个所涉及的 db 执行 undo_log 脚本.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">undo_log</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">     </span><span class="token keyword" style="color:#00009f">BIGINT</span><span class="token plain">       </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;branch transaction id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">           </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;global transaction id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">context</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">       </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;undo_log context,such as serialization&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">rollback_info</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LONGBLOB</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;rollback info&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_status</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">    </span><span class="token keyword" style="color:#00009f">INT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0:normal status,1:defense status&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_created</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">DATETIME</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;create datetime&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_modified</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">DATETIME</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;modify datetime&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">UNIQUE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">ux_undo_log</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> utf8 </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;AT transaction mode undo table&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	5.依次运行test-service,test-client.</p><p>​	6.查看nacos中服务列表是否如下图所示</p><p><img loading="lazy" alt="20191203132351" src="/zh-cn/assets/images/20191203132351-f0e45403eb1bae9896318a2af0eac585.png" width="1906" height="198" class="img_ev3q"></p><h1>总结</h1><p>关于nacos与seata的docker部署已经完成了,更详细的内容希望希望大家访问以下地址阅读详细文档</p><p><a href="https://nacos.io/zh-cn/index.html" target="_blank" rel="noopener noreferrer">nacos官网</a></p><p><a href="http://dubbo.apache.org/en-us/" target="_blank" rel="noopener noreferrer">dubbo官网</a></p><p><a href="http://seata.io/zh-cn/" target="_blank" rel="noopener noreferrer">seata官网</a></p><p><a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">docker官网</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-12-02T00:00:00.000Z" itemprop="datePublished">2019年12月2日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">FUNKYE</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://gitee.com/itCjb/springboot-dubbo-mybatisplus-seata" target="_blank" rel="noopener noreferrer">项目地址</a></p><p>本文作者：FUNKYE(陈健斌),杭州某互联网公司主程。</p><h1>前言</h1><p>上次发布了直连方式的seata配置,详细可以看这篇<a href="http://seata.io/zh-cn/blog/springboot-dubbo-mybatisplus-seata.html" target="_blank" rel="noopener noreferrer">博客</a></p><p>我们接着上一篇的基础上去配置nacos做配置中心跟dubbo注册中心.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="准备工作">准备工作<a href="#准备工作" class="hash-link" aria-label="准备工作的直接链接" title="准备工作的直接链接">​</a></h2><p>​	1.首先去nacos的github上下载<a href="https://github.com/alibaba/nacos/releases/tag/1.1.4" target="_blank" rel="noopener noreferrer">最新版本</a></p><p>​	<img loading="lazy" src="/zh-cn/assets/images/20191202203649-11d447c6013cbe1fb71acb701475508e.png" width="810" height="139" class="img_ev3q"></p><p>​	2.下载好了后,很简单,解压后到bin目录下去启动就好了,看到如图所示就成了：</p><p><img loading="lazy" src="/zh-cn/assets/images/20191202203943-d4ce12cc0da3c7fa848f2dcf5a84977b.png" width="933" height="800" class="img_ev3q"></p><p>​	3.启动完毕后访问:<a href="http://127.0.0.1:8848/nacos/#/login" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8848/nacos/#/login</a></p><p><img loading="lazy" src="/zh-cn/assets/images/20191202204101-6eb6475ce187b523c8c2d411ae73d32a.png" width="1872" height="631" class="img_ev3q"></p><p>是不是看到这样的界面了?输入nacos(账号密码相同),先进去看看吧.</p><p>这时候可以发现没有任何服务注册</p><p><img loading="lazy" alt="20191202204147" src="/zh-cn/assets/images/20191202204147-8f3f242ffa570395ef5fa444241b6f00.png" width="1079" height="508" class="img_ev3q"></p><p>别急我们马上让seata服务连接进来.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata配置">Seata配置<a href="#seata配置" class="hash-link" aria-label="Seata配置的直接链接" title="Seata配置的直接链接">​</a></h2><p>​	1.进入seata的conf文件夹看到这个木有?</p><p><img loading="lazy" src="/zh-cn/assets/images/20191202204259-13ebda796065fb073e7e7e2574b187c1.png" width="378" height="269" class="img_ev3q"></p><p>就是它,编辑它:</p><p><img loading="lazy" alt="20191202204353" src="/zh-cn/assets/images/20191202204353-6fa148ad6b20007dc762102f807f8b66.png" width="898" height="282" class="img_ev3q"></p><p><img loading="lazy" alt="20191202204437" src="/zh-cn/assets/images/20191202204437-0b67dc1d7d76a3ee5d8bd1262c1527eb.png" width="1103" height="437" class="img_ev3q"></p><p>​	2.然后记得保存哦!接着我们把registry.conf文件打开编辑：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">registry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eureka {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serviceUrl = &quot;http://localhost:8761/eureka&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weight = &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost:6379&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db = &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.timeout = 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect.timeout = 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  consul {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:8500&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  etcd3 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;http://localhost:2379&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sofa {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:9603&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    region = &quot;DEFAULT_ZONE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    datacenter = &quot;DefaultDataCenter&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group = &quot;SEATA_GROUP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addressWaitTime = &quot;3000&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;file.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # file、nacos 、apollo、zk、consul、etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  consul {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:8500&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apollo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.id = &quot;seata-server&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apollo.meta = &quot;http://192.168.1.204:8801&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.timeout = 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect.timeout = 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  etcd3 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;http://localhost:2379&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;file.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>都编辑好了后，我们运行nacos-config.sh,这时候我们配置的nacos-config.txt的内容已经被发送到nacos中了详细如图：</p><p><img loading="lazy" alt="20191202205743" src="/zh-cn/assets/images/20191202205743-d8f7d228a9332386965ab38997c396ee.png" width="572" height="337" class="img_ev3q"></p><p>出现以上类似的代码就是说明成功了，接着我们登录nacos配置中心，查看配置列表，出现如图列表说明配置成功了：</p><p><img loading="lazy" alt="20191202205912" src="/zh-cn/assets/images/20191202205912-4d939ad3e578e3d7997d786bc108775e.png" width="1826" height="643" class="img_ev3q"></p><p>看到了吧,你的配置已经全部都提交上去了,如果再git工具内运行sh不行的话,试着把编辑sh文件,试试改成如下操作 </p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">line</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">cat</span><span class="token variable" style="color:#36acaa"> nacos-config.txt</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${line</span><span class="token variable operator" style="color:#393A34">%%</span><span class="token variable" style="color:#36acaa">=*}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${line</span><span class="token variable operator" style="color:#393A34">#</span><span class="token variable" style="color:#36acaa">*=}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\r</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c"> set &quot;</span><span class="token variable" style="color:#36acaa">${key}</span><span class="token string" style="color:#e3116c">&quot; = &quot;</span><span class="token variable" style="color:#36acaa">${value}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">result</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable function" style="color:#d73a49">curl</span><span class="token variable" style="color:#36acaa"> -X POST </span><span class="token variable string" style="color:#e3116c">&quot;http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=</span><span class="token variable string variable" style="color:#36acaa">$key</span><span class="token variable string" style="color:#e3116c">&amp;group=SEATA_GROUP&amp;content=</span><span class="token variable string variable" style="color:#36acaa">$value</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$result</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain">x </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[42;37m </span><span class="token string variable" style="color:#36acaa">$result</span><span class="token string" style="color:#e3116c"> </span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[0m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[41;37 </span><span class="token string variable" style="color:#36acaa">$result</span><span class="token string" style="color:#e3116c"> </span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[0m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">let</span><span class="token plain"> error++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$error</span><span class="token plain"> -eq </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\r</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[42;37m init nacos config finished, please start seata-server. </span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[0m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\r</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[41;33m init nacos config fail. </span><span class="token string entity" style="color:#36acaa">\033</span><span class="token string" style="color:#e3116c">[0m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	3.目前我们的准备工作全部完成,我们去seata-service/bin去运行seata服务吧,如图所示就成功啦!</p><p><img loading="lazy" alt="20191202210112" src="/zh-cn/assets/images/20191202210112-29971287d77f148d4e26b4a6d80e4218.png" width="948" height="805" class="img_ev3q"></p><h1>进行调试</h1><p>​	1.首先把springboot-dubbo-mybatsiplus-seata项目的pom的依赖更改,去除掉zk这些配置,因为我们使用nacos做注册中心了.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;properties&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;webVersion&gt;3.1&lt;/webVersion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;HikariCP.version&gt;3.2.0&lt;/HikariCP.version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;mybatis-plus-boot-starter.version&gt;3.2.0&lt;/mybatis-plus-boot-starter.version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/properties&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;parent&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;version&gt;2.1.8.RELEASE&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/parent&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;dependencies&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.alibaba.nacos&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;nacos-client&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;1.1.4&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;dubbo-registry-nacos&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.7.4.1&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.7.4.1&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;1.2.60&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- &lt;dependency&gt; &lt;groupId&gt;javax&lt;/groupId&gt; &lt;artifactId&gt;javaee-api&lt;/artifactId&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;7.0&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.9.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.9.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- mybatis-plus begin --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;${mybatis-plus-boot-starter.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- mybatis-plus end --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;scope&gt;provided&lt;/scope&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;seata-all&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;0.9.0.1&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;dynamic-datasource-spring-boot-starter&lt;/artifactId&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.5.4&lt;/version&gt; &lt;/dependency&gt; --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-generator&lt;/artifactId&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;3.1.0&lt;/version&gt; &lt;/dependency&gt; --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- https://mvnrepository.com/artifact/org.freemarker/freemarker --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.freemarker&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;freemarker&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- https://mvnrepository.com/artifact/com.alibaba/druid-spring-boot-starter --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;1.1.20&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- 加上这个才能辨认到log4j2.yml文件 --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.fasterxml.jackson.dataformat&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;jackson-dataformat-yaml&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt; &lt;!-- 引入log4j2依赖 --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-starter-log4j2&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;scope&gt;test&lt;/scope&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- &lt;dependency&gt; &lt;groupId&gt;org.scala-lang&lt;/groupId&gt; &lt;artifactId&gt;scala-library&lt;/artifactId&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.11.0&lt;/version&gt; &lt;/dependency&gt; --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;optional&gt;true&lt;/optional&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/dependencies&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	2.然后更改test-service的目录结构,删除zk的配置并更改application.yml文件,目录结构与代码:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">38888</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datasource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> com.alibaba.druid.pool.DruidDataSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jdbc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">mysql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">3306/test</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">useUnicode=true</span><span class="token important">&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">driver-class-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">loadbalance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> leastactive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">threadpool</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cached</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scan</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">base-packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> org。test.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">qos-enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> testserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  nacos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">mybatis-plus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">mapper-locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> classpath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/mapper/</span><span class="token important">*Mapper.xml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">typeAliasesPackage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> org.test.entity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">global-config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">db-config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">field-strategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> not</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">id-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">db-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">configuration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">map-underscore-to-camel-case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cache-enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">auto-mapping-unknown-column-behavior</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> none</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><img loading="lazy" src="/img/blog/20191202211833.png" alt="20191202211833" style="zoom:100%" class="img_ev3q"><p>​	3.再更改registry.conf文件,如果你的nacos是其它服务器,请改成对应都ip跟端口</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">registry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;file.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   zk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.timeout = 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect.timeout = 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;file.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.timeout = 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect.timeout = 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	4.接着我们运行provideApplication</p><p><img loading="lazy" alt="20191202212000" src="/zh-cn/assets/images/20191202212000-5680e0e779d6a31cf37b5478f57e33d0.png" width="938" height="743" class="img_ev3q"></p><p>启动成功啦,我们再去看seata的日志:</p><p><img loading="lazy" alt="20191202212028" src="/zh-cn/assets/images/20191202212028-a985d4f7546feb43d77cc087b672cc67.png" width="755" height="143" class="img_ev3q"></p><p>成功了,这下我们一样,去修改test-client的内容,首先一样application.yml,把zk换成nacos,这里就不详细描述了,把test-service内的registry.conf,复制到client项目的resources中覆盖原来的registry.conf.</p><p>然后我们可以运行clientApplication:</p><p><img loading="lazy" alt="20191202212114" src="/zh-cn/assets/images/20191202212114-2c7c0131021c98c3567cf56f7b505b03.png" width="1183" height="474" class="img_ev3q"></p><p>​	5.确认服务已经被发布并测试事务运行是否正常</p><p><img loading="lazy" alt="20191202212203" src="/zh-cn/assets/images/20191202212203-0d9443f6ccda1e642c1f54fbd842fa9c.png" width="1650" height="165" class="img_ev3q"></p><p>服务成功发布出来,也被成功消费了.这下我们再去swagger中去测试回滚是否一切正常,访问<a href="http://127.0.0.1:28888/swagger-ui.html" target="_blank" rel="noopener noreferrer">http://127.0.0.1:28888/swagger-ui.html</a></p><p><img loading="lazy" alt="20191202212240" src="/zh-cn/assets/images/20191202212240-6d41e2697a84196f90210896b55064a6.png" width="1143" height="244" class="img_ev3q"></p><p>恭喜你,看到这一定跟我一样成功了! </p><h1>总结</h1><p>关于nacos的使用跟seata的简单搭建已经完成了,更详细的内容希望希望大家访问以下地址阅读详细文档</p><p><a href="https://nacos.io/zh-cn/index.html" target="_blank" rel="noopener noreferrer">nacos官网</a></p><p><a href="http://dubbo.apache.org/en-us/" target="_blank" rel="noopener noreferrer">dubbo官网</a></p><p><a href="http://seata.io/zh-cn/" target="_blank" rel="noopener noreferrer">seata官网</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-12-01T00:00:00.000Z" itemprop="datePublished">2019年12月1日</time> · <!-- -->阅读需 2 分钟</div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1qH2YwVP7gK0jSZFjXXc5aXXa-2002-901.jpg" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="活动介绍">活动介绍<a href="#活动介绍" class="hash-link" aria-label="活动介绍的直接链接" title="活动介绍的直接链接">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="亮点解读">亮点解读<a href="#亮点解读" class="hash-link" aria-label="亮点解读的直接链接" title="亮点解读的直接链接">​</a></h3><ul><li><p>Seata 开源项目发起人带来《Seata 过去、现在和未来》以及 Seata 1.0 的新特性。</p></li><li><p>Seata 核心贡献者详解 Seata AT, TCC, Saga 模式。</p></li><li><p>Seata 落地互联网医疗，滴滴出行实践剖析。</p></li><li><p><a href="https://developer.aliyun.com/live/1760" target="_blank" rel="noopener noreferrer">回放福利（开发者社区）</a></p></li><li><p><a href="http://w2wz.com/h2nb" target="_blank" rel="noopener noreferrer">加入 Seata 千人钉钉群</a></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分享嘉宾">分享嘉宾<a href="#分享嘉宾" class="hash-link" aria-label="分享嘉宾的直接链接" title="分享嘉宾的直接链接">​</a></h3><ul><li><p>季敏(清铭) 《Seata 的过去、现在和未来》 <a href="https://github.com/funky-eyes/awesome-seata/blob/master/slides/meetup/201912%40hangzhou/%E5%AD%A3%E6%95%8F%EF%BC%88%E6%B8%85%E9%93%AD%EF%BC%89%E3%80%8ASeata%20%E7%9A%84%E8%BF%87%E5%8E%BB%E3%80%81%E7%8E%B0%E5%9C%A8%E5%92%8C%E6%9C%AA%E6%9D%A5%E3%80%8B.pdf" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1BALWw4z1gK0jSZSgXXavwpXa-6720-4480.jpg" class="img_ev3q"></p></li><li><p>吴江坷《我与SEATA的开源之路以及SEATA在互联网医疗系统中的应用》 <a href="https://github.com/seata/awesome-seata/blob/master/slides/meetup/201912%40hangzhou/%E5%AD%A3%E6%95%8F%EF%BC%88%E6%B8%85%E9%93%AD%EF%BC%89%E3%80%8ASeata%20%E7%9A%84%E8%BF%87%E5%8E%BB%E3%80%81%E7%8E%B0%E5%9C%A8%E5%92%8C%E6%9C%AA%E6%9D%A5%E3%80%8B.pdf" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1Xzz1w4v1gK0jSZFFXXb0sXXa-6720-4480.jpg" alt="1577282651" class="img_ev3q"></p></li><li><p>申海强（煊檍)《带你读透 Seata AT 模式的精髓》 <a href="https://github.com/seata/awesome-seata/tree/master/slides/meetup/201912%40hangzhou" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1UK22w7T2gK0jSZPcXXcKkpXa-6720-4480.jpg" alt="1577282652" class="img_ev3q"></p></li><li><p>张森 《分布式事务Seata之TCC模式详解》</p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1fCPZw.T1gK0jSZFhXXaAtVXa-6720-4480.jpg" alt="1577282653" class="img_ev3q"></p></li><li><p>陈龙（屹远）《Seata 长事务解决方案 Saga 模式》</p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1zLv3wYj1gK0jSZFuXXcrHpXa-6720-4480.jpg" alt="1577282654" class="img_ev3q"></p></li><li><p>陈鹏志《Seata%20在滴滴两轮车业务的实践》 <a href="https://github.com/seata/awesome-seata/blob/master/slides/meetup/201912%40hangzhou/%E9%99%88%E9%B9%8F%E5%BF%97%E3%80%8ASeata%20%E5%9C%A8%E6%BB%B4%E6%BB%B4%E4%B8%A4%E8%BD%AE%E8%BD%A6%E4%B8%9A%E5%8A%A1%E7%9A%84%E5%AE%9E%E8%B7%B5%E3%80%8B.pdf" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1phvYw4n1gK0jSZKPXXXvUXXa-6720-4480.jpg" alt="1577282655" class="img_ev3q"></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="特别嘉奖">特别嘉奖<a href="#特别嘉奖" class="hash-link" aria-label="特别嘉奖的直接链接" title="特别嘉奖的直接链接">​</a></h3><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1khDVw.z1gK0jSZLeXXb9kVXa-6720-4480.jpg" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-11-30T00:00:00.000Z" itemprop="datePublished">2019年11月30日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">FUNKYE</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>项目地址：<a href="https://gitee.com/itCjb/springboot-dubbo-mybatisplus-seata" target="_blank" rel="noopener noreferrer">https://gitee.com/itCjb/springboot-dubbo-mybatisplus-seata</a> </p><p>本文作者：FUNKYE(陈健斌),杭州某互联网公司主程。</p><h1>介绍</h1><p>Mybatis-Plus：<a href="https://github.com/baomidou/mybatis-plus" target="_blank" rel="noopener noreferrer">MyBatis-Plus</a>（简称 MP）是一个 <a href="http://www.mybatis.org/mybatis-3/" target="_blank" rel="noopener noreferrer">MyBatis</a> 的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。</p><p>MP配置：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">bean</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">sqlSessionFactory</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dataSource</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">ref</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dataSource</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">bean</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Seata：Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p><p>AT模式机制：</p><ul><li>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。</li><li>二阶段：<ul><li>提交异步化，非常快速地完成。</li><li>回滚通过一阶段的回滚日志进行反向补偿。</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析原因">分析原因<a href="#分析原因" class="hash-link" aria-label="分析原因的直接链接" title="分析原因的直接链接">​</a></h2><p>​	1.首先我们通过介绍，可以看到，mp是需要注册sqlSessionFactory，注入数据源，而Seata是通过代理数据源来保证事务的正常回滚跟提交。</p><p>​	2.我们来看基于seata的官方demo提供的SeataAutoConfig的代码</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.sql.DataSource; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.ibatis.session.SqlSessionFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Primary;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.druid.pool.DruidDataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.rm.datasource.DataSourceProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.spring.annotation.GlobalTransactionScanner;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SeataAutoConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired(required = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DataSourceProperties dataSourceProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(SeataAutoConfig.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(name = &quot;dataSource&quot;) // 声明其为Bean实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Primary // 在同样的DataSource中，首先使用被标注的DataSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSource druidDataSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DruidDataSource druidDataSource = new DruidDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;dataSourceProperties.getUrl():{}&quot;,dataSourceProperties.getUrl());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setUrl(dataSourceProperties.getUrl());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setUsername(dataSourceProperties.getUsername());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setPassword(dataSourceProperties.getPassword());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setDriverClassName(dataSourceProperties.getDriverClassName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setInitialSize(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMaxActive(180);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMaxWait(60000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMinIdle(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setValidationQuery(&quot;Select 1 from DUAL&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTestOnBorrow(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTestOnReturn(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTestWhileIdle(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTimeBetweenEvictionRunsMillis(60000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMinEvictableIdleTimeMillis(25200000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setRemoveAbandoned(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setRemoveAbandonedTimeout(1800);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setLogAbandoned(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;装载dataSource........&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return druidDataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * init datasource proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @Param: druidDataSource datasource bean instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @Return: DataSourceProxy datasource proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSourceProxy dataSourceProxy(DataSource dataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;代理dataSource........&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DataSourceProxy(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SqlSessionFactory sqlSessionFactory(DataSourceProxy dataSourceProxy) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setDataSource(dataSourceProxy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setMapperLocations(new PathMatchingResourcePatternResolver()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .getResources(&quot;classpath*:/mapper/*.xml&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return factory.getObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * init global transaction scanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @Return: GlobalTransactionScanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GlobalTransactionScanner globalTransactionScanner() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;配置seata........&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new GlobalTransactionScanner(&quot;test-service&quot;, &quot;test-group&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>首先看到我们的seata配置数据源的类里,我们配置了一个数据源,然后又配置了一个seata代理datasource的bean,这时候.</p><p>然后我们如果直接启动mp整合seata的项目会发现,分页之类的插件会直接失效,连扫描mapper都得从代码上写,这是为什么呢?</p><p>通过阅读以上代码,是因为我们另外的配置了一个sqlSessionFactory,导致mp的sqlSessionFactory失效了,这时候我们发现了问题的所在了，即使我们不配置sqlSessionFactoryl，也会因为mp所使用的数据源不是被seata代理过后的数据源，导致分布式事务失效.但是如何解决这个问题呢?</p><p>这时候我们需要去阅读mp的源码,找到他的启动类,一看便知</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Copyright (c) 2011-2020, baomidou (jobob@qq.com).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * use this file except in compliance with the License. You may obtain a copy of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * the License at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * https://www.apache.org/licenses/LICENSE-2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Unless required by applicable law or agreed to in writing, software</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * License for the specific language governing permissions and limitations under</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * the License.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package com.baomidou.mybatisplus.autoconfigure;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.core.MybatisConfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.core.config.GlobalConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.core.incrementer.IKeyGenerator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.core.injector.ISqlInjector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.ibatis.annotations.Mapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.ibatis.mapping.DatabaseIdProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.ibatis.plugin.Interceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.ibatis.scripting.LanguageDriver;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.ibatis.session.ExecutorType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.ibatis.session.SqlSessionFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.ibatis.type.TypeHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.mybatis.spring.SqlSessionFactoryBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.mybatis.spring.SqlSessionTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.mybatis.spring.mapper.MapperFactoryBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.mybatis.spring.mapper.MapperScannerConfigurer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.BeanWrapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.BeanWrapperImpl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.BeanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.BeanFactoryAware;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.InitializingBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.ObjectProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.support.BeanDefinitionBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.support.BeanDefinitionRegistry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.AutoConfigurationPackages;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.condition.ConditionalOnSingleCandidate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.ApplicationContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Import;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.ImportBeanDefinitionRegistrar;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.core.io.Resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.core.io.ResourceLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.core.type.AnnotationMetadata;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.util.Assert;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.util.CollectionUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.util.ObjectUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.util.StringUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.sql.DataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Optional;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.stream.Stream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link EnableAutoConfiguration Auto-Configuration} for Mybatis. Contributes a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link SqlSessionFactory} and a {@link SqlSessionTemplate}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * If {@link org.mybatis.spring.annotation.MapperScan} is used, or a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * configuration file is specified as a property, those will be considered,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * otherwise this auto-configuration will attempt to register mappers based on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * the interface definitions in or under the root auto-configuration package.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt; copy from {@link org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration}&lt;/p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author Eddú Meléndez</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author Josh Long</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author Kazuki Shimizu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author Eduardo Macarrón</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnSingleCandidate(DataSource.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties(MybatisPlusProperties.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AutoConfigureAfter(DataSourceAutoConfiguration.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MybatisPlusAutoConfiguration implements InitializingBean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger logger = LoggerFactory.getLogger(MybatisPlusAutoConfiguration.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final MybatisPlusProperties properties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Interceptor[] interceptors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final TypeHandler[] typeHandlers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final LanguageDriver[] languageDrivers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ResourceLoader resourceLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final DatabaseIdProvider databaseIdProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;ConfigurationCustomizer&gt; configurationCustomizers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;MybatisPlusPropertiesCustomizer&gt; mybatisPlusPropertiesCustomizers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationContext applicationContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public MybatisPlusAutoConfiguration(MybatisPlusProperties properties,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        ObjectProvider&lt;Interceptor[]&gt; interceptorsProvider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        ObjectProvider&lt;TypeHandler[]&gt; typeHandlersProvider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        ObjectProvider&lt;LanguageDriver[]&gt; languageDriversProvider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        ResourceLoader resourceLoader,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        ObjectProvider&lt;DatabaseIdProvider&gt; databaseIdProvider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        ObjectProvider&lt;List&lt;ConfigurationCustomizer&gt;&gt; configurationCustomizersProvider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        ObjectProvider&lt;List&lt;MybatisPlusPropertiesCustomizer&gt;&gt; mybatisPlusPropertiesCustomizerProvider,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        ApplicationContext applicationContext) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.properties = properties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.interceptors = interceptorsProvider.getIfAvailable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.typeHandlers = typeHandlersProvider.getIfAvailable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.languageDrivers = languageDriversProvider.getIfAvailable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.resourceLoader = resourceLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.databaseIdProvider = databaseIdProvider.getIfAvailable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.configurationCustomizers = configurationCustomizersProvider.getIfAvailable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.mybatisPlusPropertiesCustomizers = mybatisPlusPropertiesCustomizerProvider.getIfAvailable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.applicationContext = applicationContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void afterPropertiesSet() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!CollectionUtils.isEmpty(mybatisPlusPropertiesCustomizers)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mybatisPlusPropertiesCustomizers.forEach(i -&gt; i.customize(properties));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        checkConfigFileExists();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void checkConfigFileExists() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.properties.isCheckConfigLocation() &amp;&amp; StringUtils.hasText(this.properties.getConfigLocation())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Resource resource = this.resourceLoader.getResource(this.properties.getConfigLocation());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Assert.state(resource.exists(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Cannot find config location: &quot; + resource + &quot; (please add config file or check your Mybatis configuration)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;SpringJavaInjectionPointsAutowiringInspection&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 使用 MybatisSqlSessionFactoryBean 而不是 SqlSessionFactoryBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setDataSource(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setVfs(SpringBootVFS.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.hasText(this.properties.getConfigLocation())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        applyConfiguration(factory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.properties.getConfigurationProperties() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setConfigurationProperties(this.properties.getConfigurationProperties());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ObjectUtils.isEmpty(this.interceptors)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setPlugins(this.interceptors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.databaseIdProvider != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setDatabaseIdProvider(this.databaseIdProvider);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.hasLength(this.properties.getTypeAliasesPackage())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setTypeAliasesPackage(this.properties.getTypeAliasesPackage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.properties.getTypeAliasesSuperType() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setTypeAliasesSuperType(this.properties.getTypeAliasesSuperType());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.hasLength(this.properties.getTypeHandlersPackage())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setTypeHandlersPackage(this.properties.getTypeHandlersPackage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ObjectUtils.isEmpty(this.typeHandlers)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setTypeHandlers(this.typeHandlers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ObjectUtils.isEmpty(this.properties.resolveMapperLocations())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setMapperLocations(this.properties.resolveMapperLocations());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 对源码做了一定的修改(因为源码适配了老旧的mybatis版本,但我们不需要适配)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;? extends LanguageDriver&gt; defaultLanguageDriver = this.properties.getDefaultScriptingLanguageDriver();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ObjectUtils.isEmpty(this.languageDrivers)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setScriptingLanguageDrivers(this.languageDrivers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(defaultLanguageDriver).ifPresent(factory::setDefaultScriptingLanguageDriver);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 自定义枚举包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.hasLength(this.properties.getTypeEnumsPackage())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factory.setTypeEnumsPackage(this.properties.getTypeEnumsPackage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 此处必为非 NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GlobalConfig globalConfig = this.properties.getGlobalConfig();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 注入填充器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.applicationContext.getBeanNamesForType(MetaObjectHandler.class,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            false, false).length &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetaObjectHandler metaObjectHandler = this.applicationContext.getBean(MetaObjectHandler.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            globalConfig.setMetaObjectHandler(metaObjectHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 注入主键生成器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.applicationContext.getBeanNamesForType(IKeyGenerator.class, false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            false).length &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IKeyGenerator keyGenerator = this.applicationContext.getBean(IKeyGenerator.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            globalConfig.getDbConfig().setKeyGenerator(keyGenerator);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 注入sql注入器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.applicationContext.getBeanNamesForType(ISqlInjector.class, false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            false).length &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ISqlInjector iSqlInjector = this.applicationContext.getBean(ISqlInjector.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            globalConfig.setSqlInjector(iSqlInjector);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 设置 GlobalConfig 到 MybatisSqlSessionFactoryBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setGlobalConfig(globalConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return factory.getObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // TODO 入参使用 MybatisSqlSessionFactoryBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void applyConfiguration(MybatisSqlSessionFactoryBean factory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO 使用 MybatisConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MybatisConfiguration configuration = this.properties.getConfiguration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (configuration == null &amp;&amp; !StringUtils.hasText(this.properties.getConfigLocation())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            configuration = new MybatisConfiguration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (configuration != null &amp;&amp; !CollectionUtils.isEmpty(this.configurationCustomizers)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (ConfigurationCustomizer customizer : this.configurationCustomizers) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                customizer.customize(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setConfiguration(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExecutorType executorType = this.properties.getExecutorType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (executorType != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new SqlSessionTemplate(sqlSessionFactory, executorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new SqlSessionTemplate(sqlSessionFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This will just scan the same base package as Spring Boot does. If you want more power, you can explicitly use</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * {@link org.mybatis.spring.annotation.MapperScan} but this will get typed mappers working correctly, out-of-the-box,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * similar to using Spring Data JPA repositories.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class AutoConfiguredMapperScannerRegistrar implements BeanFactoryAware, ImportBeanDefinitionRegistrar {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private BeanFactory beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!AutoConfigurationPackages.has(this.beanFactory)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger.debug(&quot;Could not determine auto-configuration package, automatic mapper scanning disabled.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.debug(&quot;Searching for mappers annotated with @Mapper&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;String&gt; packages = AutoConfigurationPackages.get(this.beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (logger.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                packages.forEach(pkg -&gt; logger.debug(&quot;Using auto-configuration base package &#x27;{}&#x27;&quot;, pkg));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder.addPropertyValue(&quot;processPropertyPlaceHolders&quot;, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder.addPropertyValue(&quot;annotationClass&quot;, Mapper.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder.addPropertyValue(&quot;basePackage&quot;, StringUtils.collectionToCommaDelimitedString(packages));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BeanWrapper beanWrapper = new BeanWrapperImpl(MapperScannerConfigurer.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Stream.of(beanWrapper.getPropertyDescriptors())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Need to mybatis-spring 2.0.2+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(x -&gt; x.getName().equals(&quot;lazyInitialization&quot;)).findAny()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ifPresent(x -&gt; builder.addPropertyValue(&quot;lazyInitialization&quot;, &quot;${mybatis.lazy-initialization:false}&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            registry.registerBeanDefinition(MapperScannerConfigurer.class.getName(), builder.getBeanDefinition());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setBeanFactory(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.beanFactory = beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * If mapper registering configuration or mapper scanning configuration not present, this configuration allow to scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * mappers based on the same component-scanning path as Spring Boot itself.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Import(AutoConfiguredMapperScannerRegistrar.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean({MapperFactoryBean.class, MapperScannerConfigurer.class})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class MapperScannerRegistrarNotFoundConfiguration implements InitializingBean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void afterPropertiesSet() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.debug(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Not found configuration for registering mapper bean using @MapperScan, MapperFactoryBean and MapperScannerConfigurer.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>看到mp启动类里的sqlSessionFactory方法了吗,他也是一样的注入一个数据源,这时候大家应该都知道解决方法了吧?</p><p>没错,就是把被代理过的数据源给放到mp的sqlSessionFactory中.</p><p>很简单,我们需要稍微改动一下我们的seata配置类就行了</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.sql.DataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.mybatis.spring.annotation.MapperScan;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Primary;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.druid.pool.DruidDataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.rm.datasource.DataSourceProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.spring.annotation.GlobalTransactionScanner;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@MapperScan(&quot;com.baomidou.springboot.mapper*&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SeataAutoConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired(required = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DataSourceProperties dataSourceProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(SeataAutoConfig.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DataSourceProxy dataSourceProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(name = &quot;dataSource&quot;) // 声明其为Bean实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Primary // 在同样的DataSource中，首先使用被标注的DataSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSource druidDataSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DruidDataSource druidDataSource = new DruidDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;dataSourceProperties.getUrl():{}&quot;, dataSourceProperties.getUrl());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setUrl(dataSourceProperties.getUrl());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setUsername(dataSourceProperties.getUsername());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setPassword(dataSourceProperties.getPassword());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setDriverClassName(dataSourceProperties.getDriverClassName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setInitialSize(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMaxActive(180);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMaxWait(60000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMinIdle(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setValidationQuery(&quot;Select 1 from DUAL&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTestOnBorrow(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTestOnReturn(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTestWhileIdle(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTimeBetweenEvictionRunsMillis(60000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMinEvictableIdleTimeMillis(25200000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setRemoveAbandoned(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setRemoveAbandonedTimeout(1800);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setLogAbandoned(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;装载dataSource........&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dataSourceProxy = new DataSourceProxy(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return dataSourceProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * init datasource proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @Param: druidDataSource datasource bean instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @Return: DataSourceProxy datasource proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSourceProxy dataSourceProxy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;代理dataSource........&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return dataSourceProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * init global transaction scanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @Return: GlobalTransactionScanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GlobalTransactionScanner globalTransactionScanner() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;配置seata........&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new GlobalTransactionScanner(&quot;test-service&quot;, &quot;test-group&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>看代码,我们去掉了自己配置的sqlSessionFactory,直接让DataSource bean返回的是一个被代理过的bean,并且我们加入了@Primary,导致mp优先使用我们配置的数据源,这样就解决了mp因为seata代理了数据源跟创建了新的sqlSessionFactory,导致mp的插件,组件失效的bug了!</p><h1>总结</h1><p>踩到坑不可怕，主要又耐心的顺着每个组件实现的原理，再去思考，查找对应冲突的代码块，你一定能找到个兼容二者的方法。</p></div><footer class="row docusaurus-mt-lg"></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/page/3"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/page/5"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">
                  <div class="fs-12">
                    <div class="center-div">
                      <span>Apache Seata (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</span>
                    </div>
                    <br>
                    <div class="center-div">
                      <span>Copyright © 2023-2024, The Apache Software Foundation Apache Seata, Seata, Apache, Apache Incubator, the Apache feather, the Apache Incubator logo and the Apache Seata project logo are either registered trademarks or trademarks of the Apache Software Foundation.</span>
                      <br>
                    </div>
                    <br>
                  </div>
                  </div></div></div></footer></div>
<script src="/zh-cn/assets/js/runtime~main.6a3ed17d.js"></script>
<script src="/zh-cn/assets/js/main.466e24d1.js"></script>
</body>
</html>