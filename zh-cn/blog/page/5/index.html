<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.io/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://seata.io/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://seata.io/zh-cn/blog/page/5"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="keywords" content="Seata,Seata官网,Seata official site,分布式事务,distributed transactions"><meta data-rh="true" property="og:title" content="Blog | Seata"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/zh-cn/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.io/zh-cn/blog/page/5"><link data-rh="true" rel="alternate" href="https://seata.io/blog/page/5" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.io/zh-cn/blog/page/5" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.io/blog/page/5" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ICHFIJRDZF-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Seata Atom Feed">


<link rel="search" type="application/opensearchdescription+xml" title="Seata" href="/zh-cn/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=seata">
<script src="https://www.googletagmanager.com/gtag/js?id=G-X4LJGF90X2" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.f8c4a2a1.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.97cc0e32.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.fb767bfe.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="https://hm.baidu.com/hm.js?104e73ef0c18b416b27abb23757ed8ee"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/overview/what-is-seata" href="/zh-cn/docs/overview/what-is-seata">v2.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-cn/docs/next/overview/what-is-seata">预览版</a></li><li><a class="dropdown__link" href="/zh-cn/docs/overview/what-is-seata">v2.0</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.8/overview/what-is-seata">v1.8</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.7/overview/what-is-seata">v1.7</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.6/overview/what-is-seata">v1.6</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.5/overview/what-is-seata">v1.5</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.4/overview/what-is-seata">v1.4</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.3/overview/what-is-seata">v1.3</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.2/overview/what-is-seata">v1.2</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.1/overview/what-is-seata">v1.1</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.0/overview/what-is-seata">v1.0</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/contributor-guide/new-contributor-guide_dev">开发者</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a class="navbar__item navbar__link" href="/zh-cn/unversioned/download/seata-server">下载</a><a href="http://demo.seata.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/blog/page/5" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/page/5" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/explore-seata-journey">探索 Seata 项目开源开发之旅</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-raft-detailed-explanation">Seata-Raft 存储模式详解及入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-observable-practice">Seata的可观测实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-lock">详解 Seata AT 模式事务隔离级别与全局锁设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-snowflake-explain">关于新版雪花算法的答疑</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-UUID-generator">Seata基于改良版雪花算法的分布式UUID生成器分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-feature-undo-log-compress">Seata新特性支持 -- undo_log压缩</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dsproxy-deadlock">ConcurrentHashMap导致的Seata死锁问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-02">Seata应用侧启动过程剖析——注册中心与配置中心模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-01">Seata应用侧启动过程剖析——RM &amp; TM如何与TC建立连接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-tcc-mode-with-spring-cloud">Spring Cloud集成Seata分布式事务-TCC模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-manager">Seata配置管理原理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-golang-communication-mode">seata-golang 通信模型详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-datasource-proxy">Seata数据源代理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-demo-in-mac">Mac下的Seata Demo环境搭建（AT模式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-quick-start">Seata 极简入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-ha-practice">Seata 高可用部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-center">Seata 配置中心实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/quick-start-use-seata-and-dubbo-services">如何使用Seata保证Dubbo微服务间的一致性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/manual-transaction-mode">MT 模式</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-11-29T00:00:00.000Z" itemprop="datePublished">2019年11月29日</time> · <!-- -->阅读需 23 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">FUNKYE</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://gitee.com/itCjb/springboot-dubbo-mybatisplus-seata" target="_blank" rel="noopener noreferrer">项目地址</a></p><p>本文作者：FUNKYE(陈健斌),杭州某互联网公司主程。</p><h1>前言</h1><p>​    <strong>事务</strong>：事务是由一组操作构成的可靠的独立的工作单元，事务具备ACID的特性，即原子性、一致性、隔离性和持久性。
​    <strong>分布式事务</strong>:当一个操作牵涉到多个服务,多台数据库协力完成时(比如分表分库后,业务拆分),多个服务中，本地的Transaction已经无法应对这个情况了,为了保证数据一致性，就需要用到分布式事务。
​    <strong>Seata</strong> ：是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。
​    <strong>本文目的</strong>：现如今微服务越来越流行，而市面上的分布式事务的方案可谓不少，参差不齐，比较流行的以MQ代表的保证的是消息最终一致性的解决方案（消费确认，消息回查，消息补偿机制等），以及TX-LCN的LCN模式协调本地事务来保证事务统一提交或回滚（已经停止更新，对Dubbo2.7不兼容）。而MQ的分布式事务太过复杂，TX-LCN断更，这时候需要一个高效可靠及易上手的分布式事务解决方案，Seata脱颖而出，本文要介绍的就是如何快速搭建一个整合Seata的Demo项目，一起来吧！</p><h1>准备工作</h1><p>1.首先安装mysql,eclipse之类常用的工具,这不展开了. </p><p>2.访问seata下载中心<a href="http://seata.io/zh-cn/blog/download.html" target="_blank" rel="noopener noreferrer">地址</a>我们使用的0.9.0版本</p><p>3.下载并解压seata-server</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="建库建表">建库建表<a href="#建库建表" class="hash-link" aria-label="建库建表的直接链接" title="建库建表的直接链接">​</a></h2><p>1.首先我们链接mysql创建一个名为seata的数据库,然后运行一下建表sql,这个在seata-server的conf文件夹内的db_store.sql就是我的所需要使用的sql了.</p><div class="language-mysql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mysql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Navicat MySQL Data Transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source Server         : mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source Server Version : 50721</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source Host           : localhost:3306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source Database       : seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Target Server Type    : MYSQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Target Server Version : 50721</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File Encoding         : 65001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Date: 2019-11-23 22:03:18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET FOREIGN_KEY_CHECKS=0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Table structure for branch_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DROP TABLE IF EXISTS `branch_table`;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `branch_table` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `branch_id` bigint(20) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `xid` varchar(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `transaction_id` bigint(20) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `resource_group_id` varchar(32) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `resource_id` varchar(256) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `lock_key` varchar(128) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `branch_type` varchar(8) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `status` tinyint(4) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `client_id` varchar(64) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `application_data` varchar(2000) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_create` datetime DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` datetime DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`branch_id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KEY `idx_xid` (`xid`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Records of branch_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Table structure for global_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DROP TABLE IF EXISTS `global_table`;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `global_table` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `xid` varchar(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `transaction_id` bigint(20) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `status` tinyint(4) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `application_id` varchar(32) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `transaction_service_group` varchar(32) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `transaction_name` varchar(128) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `timeout` int(11) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `begin_time` bigint(20) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `application_data` varchar(2000) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_create` datetime DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` datetime DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`xid`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KEY `idx_gmt_modified_status` (`gmt_modified`,`status`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KEY `idx_transaction_id` (`transaction_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Records of global_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Table structure for lock_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DROP TABLE IF EXISTS `lock_table`;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `lock_table` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `row_key` varchar(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `xid` varchar(96) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `transaction_id` mediumtext,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `branch_id` mediumtext,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `resource_id` varchar(256) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `table_name` varchar(32) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `pk` varchar(36) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_create` datetime DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `gmt_modified` datetime DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`row_key`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Records of lock_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Table structure for undo_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DROP TABLE IF EXISTS `undo_log`;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `undo_log` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `branch_id` bigint(20) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `xid` varchar(100) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `context` varchar(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `rollback_info` longblob NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `log_status` int(11) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `log_created` datetime NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `log_modified` datetime NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `ext` varchar(100) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Records of undo_log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2.运行完上面的seata所需要的数据库后,我们进行搭建我们所需要写的demo的库,创建一个名为test的数据库,然后执行以下sql代码:</p><div class="language-mysql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mysql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Navicat MySQL Data Transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source Server         : mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source Server Version : 50721</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source Host           : localhost:3306</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source Database       : test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Target Server Type    : MYSQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Target Server Version : 50721</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File Encoding         : 65001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Date: 2019-11-23 22:03:24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET FOREIGN_KEY_CHECKS=0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Table structure for test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DROP TABLE IF EXISTS `test`;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `test` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `one` varchar(255) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `two` varchar(255) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `createTime` datetime DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Records of test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO `test` VALUES (&#x27;1&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;2019-11-23 16:07:34&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Table structure for undo_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DROP TABLE IF EXISTS `undo_log`;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `undo_log` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `branch_id` bigint(20) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `xid` varchar(100) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `context` varchar(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `rollback_info` longblob NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `log_status` int(11) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `log_created` datetime NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `log_modified` datetime NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `ext` varchar(100) DEFAULT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- ----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Records of undo_log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 3.我们找到seata-server/conf 文件夹内的file编辑它:<img loading="lazy" alt="20191129132933" src="/zh-cn/assets/images/20191129132933-e2cced49e010d6f7c493644ca7f1aba8.png" width="860" height="302" class="img_ev3q"></p><p> 4.再次找到其中的db配置方法块,更改方法如下图:<img loading="lazy" src="/zh-cn/assets/images/20191129133111-f1055c7f1e760b48cd7a5a0acc77a648.png" width="794" height="397" class="img_ev3q"></p><p>好了,可以到bin目录去./seata-server.bat 运行看看了 </p><h1>创建项目</h1><p>​	首先我们使用的是eclipse,当然你也可以用idea之类的工具,详细请按下面步骤来运行</p><p>​	1.创建一个新的maven项目,并删除多余文件夹:<img loading="lazy" alt="20191129133354" src="/zh-cn/assets/images/20191129133354-fa95fd2cfe751b4cbdd6cb20b3e7ec37.png" width="645" height="553" class="img_ev3q"><img loading="lazy" src="/img/blog/20191129133441.png" alt="20191129133441" style="zoom:150%" class="img_ev3q"></p><p>​	2.打开项目的pom.xml,加入以下依赖:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;properties&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;webVersion&gt;3.1&lt;/webVersion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;HikariCP.version&gt;3.2.0&lt;/HikariCP.version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;mybatis-plus-boot-starter.version&gt;3.2.0&lt;/mybatis-plus-boot-starter.version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/properties&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;parent&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;version&gt;2.1.8.RELEASE&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/parent&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;dependencies&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;curator-framework&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;4.2.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;4.2.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.7.4.1&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;1.2.60&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- &lt;dependency&gt; &lt;groupId&gt;javax&lt;/groupId&gt; &lt;artifactId&gt;javaee-api&lt;/artifactId&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;7.0&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.9.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.9.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- mybatis-plus begin --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;${mybatis-plus-boot-starter.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- mybatis-plus end --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;scope&gt;provided&lt;/scope&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;seata-all&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;0.9.0.1&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- Zookeeper --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;3.4.9&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;dynamic-datasource-spring-boot-starter&lt;/artifactId&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.5.4&lt;/version&gt; &lt;/dependency&gt; --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-generator&lt;/artifactId&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;3.1.0&lt;/version&gt; &lt;/dependency&gt; --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- https://mvnrepository.com/artifact/org.freemarker/freemarker --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.freemarker&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;freemarker&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- https://mvnrepository.com/artifact/com.alibaba/druid-spring-boot-starter --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;1.1.20&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- 加上这个才能辨认到log4j2.yml文件 --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;com.fasterxml.jackson.dataformat&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;jackson-dataformat-yaml&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt; &lt;!-- 引入log4j2依赖 --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-starter-log4j2&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/exclusion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/exclusions&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;scope&gt;test&lt;/scope&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- &lt;dependency&gt; &lt;groupId&gt;org.scala-lang&lt;/groupId&gt; &lt;artifactId&gt;scala-library&lt;/artifactId&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;2.11.0&lt;/version&gt; &lt;/dependency&gt; --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;optional&gt;true&lt;/optional&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/dependencies&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	3.再切换父项目为pom模式,还是pom文件,切换为 overview ,做如图操作:<img loading="lazy" alt="20191129134127" src="/zh-cn/assets/images/20191129134127-06a15c80fc75daa7c3b466dd8ee84659.png" width="678" height="511" class="img_ev3q"></p><p>4.创建我们的demo子项目,test-service:<img loading="lazy" alt="20191129135935" src="/zh-cn/assets/images/20191129135935-50a3608af215bcef2c69fb5aa5d03144.png" width="638" height="550" class="img_ev3q"></p><p>​	目录如下:</p><img loading="lazy" src="/img/blog/20191129140048.png" alt="20191129140048" style="zoom:200%" class="img_ev3q"><p> 	创建EmbeddedZooKeeper.java文件,跟 ProviderApplication.java,代码如下:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.File;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.reflect.Method;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Properties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.UUID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.zookeeper.server.ServerConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.zookeeper.server.ZooKeeperServerMain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.zookeeper.server.quorum.QuorumPeerConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.SmartLifecycle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.util.ErrorHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.util.SocketUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * from:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * https://github.com/spring-projects/spring-xd/blob/v1.3.1.RELEASE/spring-xd-dirt/src/main/java/org/springframework/xd/dirt/zookeeper/ZooKeeperUtils.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Helper class to start an embedded instance of standalone (non clustered) ZooKeeper.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * NOTE: at least an external standalone server (if not an ensemble) are recommended, even for</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link org.springframework.xd.dirt.server.singlenode.SingleNodeApplication}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author Patrick Peralta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author Mark Fisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author David Turanski</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EmbeddedZooKeeper implements SmartLifecycle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Logger.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger logger = LoggerFactory.getLogger(EmbeddedZooKeeper.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ZooKeeper client port. This will be determined dynamically upon startup.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int clientPort;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Whether to auto-start. Default is true.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean autoStartup = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Lifecycle phase. Default is 0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int phase = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Thread for running the ZooKeeper server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private volatile Thread zkServerThread;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ZooKeeper server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private volatile ZooKeeperServerMain zkServer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * {@link ErrorHandler} to be invoked if an Exception is thrown from the ZooKeeper server thread.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ErrorHandler errorHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean daemon = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Construct an EmbeddedZooKeeper with a random port.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EmbeddedZooKeeper() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clientPort = SocketUtils.findAvailableTcpPort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Construct an EmbeddedZooKeeper with the provided port.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param clientPort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *            port for ZooKeeper server to bind to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EmbeddedZooKeeper(int clientPort, boolean daemon) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.clientPort = clientPort;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.daemon = daemon;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Returns the port that clients should use to connect to this embedded server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return dynamically determined client port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getClientPort() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.clientPort;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Specify whether to start automatically. Default is true.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param autoStartup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *            whether to start automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAutoStartup(boolean autoStartup) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.autoStartup = autoStartup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * {@inheritDoc}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isAutoStartup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.autoStartup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Specify the lifecycle phase for the embedded server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param phase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *            the lifecycle phase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setPhase(int phase) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.phase = phase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * {@inheritDoc}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getPhase() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.phase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * {@inheritDoc}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isRunning() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (zkServerThread != null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Start the ZooKeeper server in a background thread.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Register an error handler via {@link #setErrorHandler} in order to handle any exceptions thrown during startup or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * execution.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void start() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (zkServerThread == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkServerThread = new Thread(new ServerRunnable(), &quot;ZooKeeper Server Starter&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkServerThread.setDaemon(daemon);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            zkServerThread.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Shutdown the ZooKeeper server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void stop() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (zkServerThread != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // The shutdown method is protected...thus this hack to invoke it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // This will log an exception on shutdown; see</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // https://issues.apache.org/jira/browse/ZOOKEEPER-1873 for details.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Method shutdown = ZooKeeperServerMain.class.getDeclaredMethod(&quot;shutdown&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shutdown.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shutdown.invoke(zkServer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new RuntimeException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // It is expected that the thread will exit after</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // the server is shutdown; this will block until</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // the shutdown is complete.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                zkServerThread.join(5000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                zkServerThread = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Thread.currentThread().interrupt();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger.warn(&quot;Interrupted while waiting for embedded ZooKeeper to exit&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // abandoning zk thread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                zkServerThread = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Stop the server if running and invoke the callback when complete.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void stop(Runnable callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        callback.run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Provide an {@link ErrorHandler} to be invoked if an Exception is thrown from the ZooKeeper server thread. If none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * is provided, only error-level logging will occur.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param errorHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *            the {@link ErrorHandler} to be invoked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setErrorHandler(ErrorHandler errorHandler) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.errorHandler = errorHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Runnable implementation that starts the ZooKeeper server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private class ServerRunnable implements Runnable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Properties properties = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                File file = new File(System.getProperty(&quot;java.io.tmpdir&quot;) + File.separator + UUID.randomUUID());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                file.deleteOnExit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.setProperty(&quot;dataDir&quot;, file.getAbsolutePath());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.setProperty(&quot;clientPort&quot;, String.valueOf(clientPort));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                QuorumPeerConfig quorumPeerConfig = new QuorumPeerConfig();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                quorumPeerConfig.parseProperties(properties);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                zkServer = new ZooKeeperServerMain();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ServerConfig configuration = new ServerConfig();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                configuration.readFrom(quorumPeerConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                zkServer.runFromConfig(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (errorHandler != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    errorHandler.handleError(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    logger.error(&quot;Exception running embedded ZooKeeper&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.config.spring.context.annotation.DubboComponentScan;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.SpringApplication;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.ComponentScan;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.transaction.annotation.EnableTransactionManagement;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author cjb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date 2019/10/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableTransactionManagement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ComponentScan(basePackages = {&quot;org.test.config&quot;, &quot;org.test.service.impl&quot;})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@DubboComponentScan(basePackages = &quot;org.test.service.impl&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootApplication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ProviderApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new EmbeddedZooKeeper(2181, false).start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SpringApplication app = new SpringApplication(ProviderApplication.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app.run(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 	创建实体包 org.test.entity以及创建实体类Test 用到了lombok,详细百度一下,eclipse装lombok插件</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.entity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.Serializable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.LocalDateTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.annotation.IdType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.annotation.TableField;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.annotation.TableId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.swagger.annotations.ApiModel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.swagger.annotations.ApiModelProperty;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.EqualsAndHashCode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.experimental.Accessors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 功能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author Funkye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @since 2019-04-23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EqualsAndHashCode(callSuper = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Accessors(chain = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ApiModel(value = &quot;test对象&quot;, description = &quot;功能&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Test implements Serializable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final long serialVersionUID = 1L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ApiModelProperty(value = &quot;主键&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TableId(value = &quot;id&quot;, type = IdType.AUTO)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Integer id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ApiModelProperty(value = &quot;one&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TableField(&quot;one&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String one;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ApiModelProperty(value = &quot;two&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TableField(&quot;two&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String two;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ApiModelProperty(value = &quot;createTime&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TableField(&quot;createTime&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private LocalDateTime createTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	创建service,service.impl,mapper等包,依次创建ITestservice,以及实现类,mapper</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.test.entity.Test;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.extension.service.IService; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 功能 服务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author Funkye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @since 2019-04-10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface ITestService extends IService&lt;Test&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.service.impl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.config.annotation.Service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.test.entity.Test;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.test.mapper.TestMapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.test.service.ITestService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service(version = &quot;1.0.0&quot;,interfaceClass =ITestService.class )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TestServiceImpl extends ServiceImpl&lt;TestMapper, Test&gt; implements ITestService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.mapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.test.entity.Test; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 功能 Mapper 接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author Funkye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @since 2019-04-10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface TestMapper extends BaseMapper&lt;Test&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 	创建org.test.config包,创建SeataAutoConfig.java,配置信息都在此处,主要作用为代理数据,连接事务服务分组 </p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.sql.DataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Qualifier;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Primary;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.druid.pool.DruidDataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.rm.datasource.DataSourceProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.spring.annotation.GlobalTransactionScanner;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SeataAutoConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired(required = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DataSourceProperties dataSourceProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(SeataAutoConfig.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(name = &quot;druidDataSource&quot;) // 声明其为Bean实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSource druidDataSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DruidDataSource druidDataSource = new DruidDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;dataSourceProperties.getUrl():{}&quot;, dataSourceProperties.getUrl());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setUrl(dataSourceProperties.getUrl());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setUsername(dataSourceProperties.getUsername());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setPassword(dataSourceProperties.getPassword());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setDriverClassName(dataSourceProperties.getDriverClassName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setInitialSize(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMaxActive(180);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMaxWait(60000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMinIdle(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setValidationQuery(&quot;Select 1 from DUAL&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTestOnBorrow(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTestOnReturn(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTestWhileIdle(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setTimeBetweenEvictionRunsMillis(60000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setMinEvictableIdleTimeMillis(25200000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setRemoveAbandoned(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setRemoveAbandonedTimeout(1800);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        druidDataSource.setLogAbandoned(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;装载dataSource........&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return druidDataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * init datasource proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @Param: druidDataSource datasource bean instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @Return: DataSourceProxy datasource proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(name = &quot;dataSource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Primary // 在同样的DataSource中，首先使用被标注的DataSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSourceProxy dataSourceProxy(@Qualifier(value = &quot;druidDataSource&quot;) DruidDataSource druidDataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;代理dataSource........&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DataSourceProxy(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * init global transaction scanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @Return: GlobalTransactionScanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GlobalTransactionScanner globalTransactionScanner() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;配置seata........&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new GlobalTransactionScanner(&quot;test-service&quot;, &quot;test-group&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 	再创建mybatisplus所需的配置文件MybatisPlusConfig  </p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.mybatis.spring.mapper.MapperScannerConfigurer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.core.parser.ISqlParser;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.extension.parsers.BlockAttackSqlParser;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.extension.plugins.PaginationInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// @MapperScan(&quot;com.baomidou.springboot.mapper*&quot;)//这个注解，作用相当于下面的@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// MapperScannerConfigurer，2者配置1份即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MybatisPlusConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * mybatis-plus分页插件&lt;br&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 文档：http://mp.baomidou.com&lt;br&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PaginationInterceptor paginationInterceptor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PaginationInterceptor paginationInterceptor = new PaginationInterceptor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ISqlParser&gt; sqlParserList = new ArrayList&lt;ISqlParser&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 攻击 SQL 阻断解析器、加入解析链</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sqlParserList.add(new BlockAttackSqlParser());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paginationInterceptor.setSqlParserList(sqlParserList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return paginationInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 相当于顶部的： {@code @MapperScan(&quot;com.baomidou.springboot.mapper*&quot;)} 这里可以扩展，比如使用配置文件来配置扫描Mapper的路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public MapperScannerConfigurer mapperScannerConfigurer() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MapperScannerConfigurer scannerConfigurer = new MapperScannerConfigurer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scannerConfigurer.setBasePackage(&quot;org.test.mapper&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return scannerConfigurer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	 再创建<strong>resources目录,创建mapper文件夹,application.yml等文件</strong> </p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">38888</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datasource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> com.alibaba.druid.pool.DruidDataSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jdbc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">mysql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">3306/test</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">useUnicode=true</span><span class="token important">&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">driver-class-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dubbo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">loadbalance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> leastactive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">threadpool</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cached</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scan</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">base-packages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> org。test.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">qos-enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> testserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  zookeeper</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">2181</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">client=curator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">mybatis-plus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">mapper-locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> classpath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/mapper/</span><span class="token important">*Mapper.xml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">typeAliasesPackage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> org.test.entity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">global-config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">db-config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">field-strategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> not</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">id-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">db-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">configuration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">map-underscore-to-camel-case</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cache-enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">auto-mapping-unknown-column-behavior</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	 创建file.conf,此处的service 内的vgroup_mapping.你的事务分组,比如上<strong>面SeataAutoConfig内配置了test-group,那么这里也要改为test-group</strong>,然后下面ip端口都是seata运行的ip跟端口就行了 </p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">transport {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;TCP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server = &quot;NIO&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  heartbeat = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  thread-factory {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boss-thread-prefix = &quot;NettyBoss&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    worker-thread-prefix = &quot;NettyServerNIOWorker&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server-executor-thread-prefix = &quot;NettyServerBizHandler&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    share-boss-worker = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client-selector-thread-prefix = &quot;NettyClientSelector&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client-selector-thread-size = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client-worker-thread-prefix = &quot;NettyClientWorkerThread&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boss-thread-size = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    worker-thread-size = 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shutdown {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wait = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serialization = &quot;seata&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  compressor = &quot;none&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vgroup_mapping.test-group = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default.grouplist = &quot;127.0.0.1:8091&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enableDegrade = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  max.commit.retry.timeout = &quot;-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  max.rollback.retry.timeout = &quot;-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  async.commit.buffer.limit = 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lock {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retry.internal = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retry.times = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  report.retry.count = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tm.commit.retry.count = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tm.rollback.retry.count = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  undo.log.table = &quot;undo_log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recovery {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  committing-retry-period = 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  asyn-committing-retry-period = 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rollbacking-retry-period = 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeout-retry-period = 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transaction {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  undo.data.validation = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  undo.log.serialization = &quot;jackson&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  undo.log.save.days = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  undo.log.delete.period = 86400000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  undo.log.table = &quot;undo_log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metrics {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry-type = &quot;compact&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exporter-list = &quot;prometheus&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exporter-prometheus-port = 9898</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">support {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spring {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    datasource.autoproxy = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 创建registry.conf,来指定file,zk的ip端口之类的配置 </p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">registry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;file&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;file.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;file&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;file.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.timeout = 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect.timeout = 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	 大功告成,可以直接运行啦,这时候观察seata-server<img loading="lazy" alt="20191129142115" src="/zh-cn/assets/images/20191129142115-3d08387e87a3a80200ecffadca799917.png" width="695" height="492" class="img_ev3q"></p><p>​	接下来我们创建test-client项目项目,这里就不赘述了,跟上面的test-service一样的创建方式</p><p>​	接下来我们复制test-service内的service跟实体过去,当然你嫌麻烦,可以单独搞个子项目放通用的service跟实体,一些工具类等等,我这边为了快速搭建这个demo,就选择复制黏贴的方式了.</p><p>目录结构:<img loading="lazy" src="/zh-cn/assets/images/20191129142349-ae02ff4b6762d6733cca6b1e672ce738.png" width="483" height="275" class="img_ev3q"></p><p> 	然后我们创建ClientApplication:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.TimeZone;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.Executor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.config.spring.context.annotation.EnableDubbo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.SpringApplication;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.ComponentScan;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.scheduling.annotation.EnableAsync;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.scheduling.annotation.EnableScheduling;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.baomidou.mybatisplus.autoconfigure.MybatisPlusAutoConfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class, MybatisPlusAutoConfiguration.class})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableScheduling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableAsync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableDubbo(scanBasePackages = {&quot;org.test.service&quot;})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ComponentScan(basePackages = {&quot;org.test.service&quot;, &quot;org.test.controller&quot;, &quot;org.test.config&quot;})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ClientApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TimeZone.setDefault(TimeZone.getTimeZone(&quot;Asia/Shanghai&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SpringApplication app = new SpringApplication(ClientApplication.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app.run(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(name = &quot;threadPoolTaskExecutor&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Executor threadPoolTaskExecutor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ThreadPoolTaskExecutor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 再到config包内创建SwaggerConfig :</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import springfox.documentation.builders.ApiInfoBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import springfox.documentation.builders.PathSelectors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import springfox.documentation.builders.RequestHandlerSelectors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import springfox.documentation.service.ApiInfo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import springfox.documentation.service.Contact;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import springfox.documentation.service.Parameter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import springfox.documentation.spi.DocumentationType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import springfox.documentation.spring.web.plugins.Docket;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableSwagger2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SwaggerConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // swagger2的配置文件，这里可以配置swagger2的一些基本的内容，比如扫描的包等等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Docket createRestApi() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Parameter&gt; pars = new ArrayList&lt;Parameter&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new Docket(DocumentationType.SWAGGER_2).apiInfo(apiInfo()).select()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 为当前包路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .apis(RequestHandlerSelectors.basePackage(&quot;org.test.controller&quot;)).paths(PathSelectors.any()).build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .globalOperationParameters(pars);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 构建 api文档的详细信息函数,注意这里的注解引用的是哪个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ApiInfo apiInfo() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ApiInfoBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 页面标题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .title(&quot;项目接口&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 创建人</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .contact(new Contact(&quot;FUNKYE&quot;, &quot;&quot;, &quot;&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 版本号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .version(&quot;1.0&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .description(&quot;API 描述&quot;).build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	再创建SpringMvcConfigure,再里面放入seata的配置,我为了偷懒直接集成在mvc配置的类里了,大家规范点可以另外创建个配置seata的类,大家可以发现下面还是有个组名称,我把两个项目都分配到一个组去,貌似另外取一个也没事的. </p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.nio.charset.Charset; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.config.annotation.Reference;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.core.Ordered;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.MediaType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.converter.HttpMessageConverter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.converter.StringHttpMessageConverter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.cors.CorsConfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.filter.CorsFilter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.HandlerInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.servlet.view.InternalResourceViewResolver;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.serializer.SerializerFeature;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.support.config.FastJsonConfig;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.google.common.collect.Maps;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.spring.annotation.GlobalTransactionScanner;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringMvcConfigure implements WebMvcConfigurer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FilterRegistrationBean corsFilter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CorsConfiguration config = new CorsConfiguration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config.setAllowCredentials(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config.addAllowedOrigin(&quot;*&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config.addAllowedHeader(CorsConfiguration.ALL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config.addAllowedMethod(CorsConfiguration.ALL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        source.registerCorsConfiguration(&quot;/**&quot;, config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(new CorsFilter(source));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filterRegistrationBean.setOrder(Ordered.HIGHEST_PRECEDENCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filterRegistrationBean.setOrder(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filterRegistrationBean.setEnabled(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filterRegistrationBean.addUrlPatterns(&quot;/**&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, String&gt; initParameters = Maps.newHashMap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        initParameters.put(&quot;excludes&quot;, &quot;/favicon.ico,/img/*,/js/*,/css/*&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        initParameters.put(&quot;isIncludeRichText&quot;, &quot;true&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filterRegistrationBean.setInitParameters(initParameters);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return filterRegistrationBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public InternalResourceViewResolver viewResolver() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        InternalResourceViewResolver viewResolver = new InternalResourceViewResolver();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        viewResolver.setPrefix(&quot;/WEB-INF/jsp/&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        viewResolver.setSuffix(&quot;.jsp&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // viewResolver.setViewClass(JstlView.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这个属性通常并不需要手动配置，高版本的Spring会自动检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return viewResolver;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 替换框架json为fastjson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void configureMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FastJsonHttpMessageConverter fastConverter = new FastJsonHttpMessageConverter();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FastJsonConfig fastJsonConfig = new FastJsonConfig();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fastJsonConfig.setSerializerFeatures(SerializerFeature.PrettyFormat, SerializerFeature.WriteMapNullValue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SerializerFeature.WriteNullStringAsEmpty, SerializerFeature.DisableCircularReferenceDetect);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理中文乱码问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;MediaType&gt; fastMediaTypes = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fastMediaTypes.add(MediaType.APPLICATION_JSON_UTF8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fastConverter.setSupportedMediaTypes(fastMediaTypes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fastConverter.setFastJsonConfig(fastJsonConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理字符串, 避免直接返回字符串的时候被添加了引号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StringHttpMessageConverter smc = new StringHttpMessageConverter(Charset.forName(&quot;UTF-8&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        converters.add(smc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        converters.add(fastConverter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GlobalTransactionScanner globalTransactionScanner() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new GlobalTransactionScanner(&quot;test-client&quot;, &quot;test-group&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 再创建c<strong>ontroller包,再包下创建TestController</strong> :</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Lazy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.GetMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.RequestMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.RestController;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.test.service.DemoService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.swagger.annotations.Api;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.swagger.annotations.ApiOperation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 文件表 前端控制器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author funkye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @since 2019-03-20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/test&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Api(tags = &quot;测试接口&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TestController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(TestController.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Lazy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DemoService demoService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(value = &quot;testSeataOne&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ApiOperation(value = &quot;测试手动回滚分布式事务接口&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object testSeataOne() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return demoService.One();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(value = &quot;testSeataTwo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ApiOperation(value = &quot;测试异常回滚分布式事务接口&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object testSeataTwo() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return demoService.Two();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 再到service去创建需要依赖的DemoService </p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.test.service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.LocalDateTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.config.annotation.Reference;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.test.controller.TestController;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.test.entity.Test;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.core.context.RootContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.core.exception.TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.spring.annotation.GlobalTransactional;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.tm.api.GlobalTransactionContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DemoService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Reference(version = &quot;1.0.0&quot;, timeout = 60000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ITestService testService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static Logger logger = LoggerFactory.getLogger(DemoService.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 手动回滚示例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object One() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;seata分布式事务Id:{}&quot;, RootContext.getXID());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Test t = new Test();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.setOne(&quot;1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.setTwo(&quot;2&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.setCreateTime(LocalDateTime.now());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        testService.save(t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int i = 1 / 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // TODO: handle exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger.info(&quot;载入事务id进行回滚&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalTransactionContext.reload(RootContext.getXID()).rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (TransactionException e1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // TODO Auto-generated catch block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e1.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 抛出异常进行回滚示例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object Two() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;seata分布式事务Id:{}&quot;, RootContext.getXID());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Test t = new Test();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.setOne(&quot;1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.setTwo(&quot;2&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.setCreateTime(LocalDateTime.now());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        testService.save(t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int i = 1 / 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // TODO: handle exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 一样创建resources文件夹,先创建常用的<strong>application.yml</strong> </p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     name: test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  datasource:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     driver-class-name: com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     url: jdbc:mysql://127.0.0.1:3306/test?userSSL=true&amp;useUnicode=true&amp;characterEncoding=UTF8&amp;serverTimezone=Asia/Shanghai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     username: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     password: 123456</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mvc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    servlet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      load-on-startup: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoding:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            force: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            charset: utf-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    multipart:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-file-size: 10MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-request-size: 10MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dubbo:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id: my-registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    address:  zookeeper://127.0.0.1:2181?client=curator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#    address:  zookeeper://127.0.0.1:2181?client=curator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: dubbo-demo-client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    qos-enable: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  port: 28888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  max-http-header-size: 8192</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address: 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tomcat:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max-http-post-size: 104857600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> 再把之前service配置好的file跟registry文件复制来,如果你的client组名称再配置类里修改了,那么这里的file文件内的组名称一样需要更改.</p><p><img loading="lazy" src="/zh-cn/assets/images/20191129142851-be44001f4b861b83fd022d0b2c979158.png" width="298" height="452" class="img_ev3q"></p><p> 完整的目录结构如上,这时候可以启动test-service后,再启动test-client,到swagger里测试咯</p><p>​	4.访问127.0.0.1:28888/swagger-ui.html做最后的收尾		<img loading="lazy" src="/zh-cn/assets/images/20191129143041-5cba24d3bf073b4af87cac29666ced76.png" width="947" height="426" class="img_ev3q"></p><p><img loading="lazy" alt="20191129143124" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAiUAAABDCAYAAABDX3WFAAALW0lEQVR4nO3db2wb9R3H8Y9btrZMUzSg0iaEphEnSMHswYT8INUKUjWKgwpBXVMeLVOBRGsXGpBCH6wPAxLLqJxmTErWVuqzkTKRFtVOgEowKdEW8YiGAolDH3Wb1IwpT1q6lnh3/nt2fJdz4rPPzvtVnRT7fL/7/n73S35f/35nN5A0CAAAoMa21DoAAAAA011OO5eXl6sVBzaB69eva+fOnbUOA/AE/dtZU1NTrUNAHWCmBAAA+AJJCQAA8IWA042uLN8AACqB5Ru4wUwJAADwBccbXa3KyXIXFxe17f7mdQVUTbeuLaq52f9xlsNs+0aqU6PVB7VHnwL8i5kSAADgCyQlAADAF0hKAACAL5CUAAAAX/A+KUlE9cyOdp1K2Oyf6tUDj0V11fNAgCoy+n17oF1Ru34PAFiFmRJgneK9AQUCJbbeeK1DA4C65H1SEuzX+ZszeiHo+ZmwSkLR9oAYI8vhvs0io0mZ3z2YTMbUY/yLJTOPRyOpfj+TnFE//R4AXHP9PSXf3LpdVsHzN1y+8JaxrUhXjdeXd4aN+7HKr1c9yNfptm5/K925fdt4rqYhbUh1r9F62uyO8W9F/zPi/MbL0ACgwXk/U/JVVH339uofuSfiOnFvQHuy28Exz0Nwb1JHtn9XO3LbYU0V7NutkZHDuf2PjSRsjy3cVwtmPG16dVY684wR0+6TGjlijSsd75FsBacOp16TsOwr3Q61VqqdExrZbdYls8+mHgXXZPGkHrPsS7fD6jZbsxw7qfKz7ZbpO1P5c6bON1UvfQkAqsN1UpLMTk272OyZCUmH9HZSl/6T3l7vrkAtNiAfd9wYCJ7W3O8/042bt9LbRFKd23+jyVy9/q5XP9+X3nd5SBr4tU4uZI8d1EOXM8fd/Ez7z7XpyKT7NqvUlq/TXv3RiOONsHRowojp4z49+VBYs58vpPdPntdcOKy5L9OPJ8+fUviXETW7aIfa1Kf0Nfrot83pfTITifPadzNd12bHa7Kgk28mdSpXv+eNY836rW4z53KscRbFvlL4XKrvvJY5Z+p8RsJx3tqX3sy0r3/6UqNuAPzLs5mS4j/OMn/+4F1dfPSEuvbk/0CEIy/m99fyj9PUBZ0JD+lUn+UmgL2vGAPUab2XmyYI642Xn0z/GOzQ/rDlWM3q2CPbdPcOc3tYx4x323Pz/nqHG4wcUPjMhdS796kLl7X/9O8UeiemhPFvfi6s/ZGgy3aokVKxWRya+JP2Wl9re02C6nvrJWnk5+l9naedz1mRa2v0ndMvKRX53qd1qKAvtSqky0oVWSd9CQC84Pqeks0rrIfc/DcZxmD56ceZQcevUonUOWPwm9SXcwfUHzSjfU1xI9n4qw7olPlw0e5gl+3gJ3bXJHFSjz8yIKVmXIKZx1+UX45X6qEvAYAHPFu+SSYzm1L3saZ/3tOpjk9e0dsfZvcn9M4f/lz4+ipuBfV6wnj3OjugF04m8s9NntAxY7CONCdzr8/P6FgeZ46NWqbYp44c1lSNZn/yj4tjblZkv5GAPP+azoRa1Zx9/Po5aX+H8dhNO9SwPqvaeVIjqTiL67nGNUl8oVlzxiWz9JOIndNs7viislxd2xLnL3jOoe/4uC816gbAv6r8PSURvfyXFxV7bot+sdPcfiU982J1Q7C1VyM3zit07GF97+7t6e1Z6d2P+rT2BIFx7KdDmnt2e+7Y9/a9pSeqELUzM+kI64wZ1+MjqUmQ5sgBaXZWh/alFzrSj42cJJKt5UbawWvF7XxBrX12UTlcE3M5SgP6aeb5F758ROHcccVtVu1r69e+BADeCyQd3josLy/nfr7rO9tcF/rvf13TV/f8ZGORVcGDX1/VD390f63DqCiz7RupTo1WH9Se2aeam2ufYgNYzfU9JWVPe9bJFzY04nRuo9Wp0eoDACjNsxtdk1sZSAAAgHvezZTcKTeU2mjEd+GNVqdGqw8AoDTPkpKVLfUxkDTigNdodWq0+gAASuN/CQYAAL7g+tM3S0tLVQkIALzGp28Af3K9fLPtfve/xLeuLergJf//0l86uKympqZah1FRZiLZSHVqtPqg9qxvtgD4C8s3AADAF0hKAACAL5CUAAAAXyApAQAAvrCupOSBHYFKxwEAADa5dc+U1EVi0ix90iOdKOeDQPFeBQIB9cY9i6q6EsPaZdQnkNnqvl6O9YmrN7dvl4YTRcfaXduCMkscV4pTPymnD7muT6/WLM5FTM5llW6/xPAuy7H5bVfJhnIRc6bOpY8HsJltaPnGz4lJ3wEjIfmZ9Lf/uj0ioeFdxh/SQamn3cvIqskYILqls8lk6ltRkwtRzXW4GNx8y6k+5vXr0Fx0Ib0vFlJ/i3Wf3bU1ymzpVyiWzB/XPSz74dKprHL70Fr1mVBnZl+sZ0wdtlnOGuc1E5LBNi1kz5McVaRkGaXbL3h0OnNcPs529ej40WCJMtaK2XhN97jUML9jACrJdVIyfyO/WZmJiXVf8f5aGTknPWpsV10fEdTRaeOP6fSA2jyMq7oiGp0+qtzQEXxKXe1zmq/bN6gO9Ulc1PiMZaCMDCjaPqaJ1JjocG3jExprj2ogO0qbx2lcF23byKmflNuHnK6PWVY+eYh09khz8zbJktN5jSRgcE7Rs5bzlOLYfsUvHddMT2eJxGbtmBPD3RrvOqvjIadgAGxWFbnRdc+9/p0xgdWCrsyE1Oo4OtUTS30WrhQNlEG1hswxcT0Z2IyuLFQsyDLYX5/4xJjau55yTixKMZMNdUlDJZZdUssomWUa1+0X11C/FM1mcdYy1orZeG33eJfOrpphAYC0in36hsTE/+K95vT8QIl3uPXJWp/E/Nz6CmlpU/tMv4ayMwLxIfXPVCrC8qy6Ppb7TSY6k5pez2BuJhtG/a505pde1N+9Kolw3X6pmaUuPWUXim3M5rJNv0LH15ixAbCpuU5KrGvKpXy4tOK4H7UV7w2oQ7H1DWw+VFyfYOs61wOCRzUd69FYR2YmYbBN0Z52tbWkzuJ842x5ETuWVfL6mLFlfqc6J4zjdjnd6+LAujxllHm8Z0bj5vpUqvxpmad0137mUtCYeqyJhaUMp5jNZZv+UEyjjZIRA/BERWZKzIQE/pUd8JINMiLY1qfg/oWEzDf/ITdrVZHRfNI93aorY9kllIhGc8m4ZeBdF/uy3FyfyGhMPTNO97rYMGeC3L52rfbL3HfS6bIb5WNO6OL4jIzML7eE1DEmzfS3KFD3HwcDUEllzJTkN6sPrq8U7GOixE/Sn8oYbFtokITEoT6pG1SLlmFkmSFwqbpLXA71MZdBLAN2YnjQednEjnnzrNES3Zb7SAbH2tVlFmS9H8RF+8XTN5MUto21DNuYMzfiWmZbYz3mBE6j9EsAlbKhmRIzIfGr1EeCjT983T+Qdu9x830lmY9VBlpS9xRkp/Pr+o1c5v6I1DvSii1D1JBjfYyB76z5kdrM8x1SLPfJFqdrm92X3swEwXmJy01ZLvuQU32CR3W2bTD3fEt/yFKfcmIyE4KYQtlzpD7+XGrWx6n9VJjM2CkrZgBYLZB0uAnE+l98z658P/fzE/ds1ftff2tb6INfX9XBS+V8Y1ltXDq4rKamplqHUVHmNWukOjVafVB79CnAv+5y/cpv8j++/89vCx4DAABslOukJLmVm0UAAIB33M+U3PEwCgAAsOm5TkpWtjBTAgAAvFOxb3QFAADYCNefvllaWiqr4Pvuu2/9UQGAh/j0DeBPrpMSfokBAICXWL4BAAC+QFICAAB8gaQEAAD4AkkJAADwBZISAADgCyQlAADAF0hKAACAL5CUAAAAXyApAQAAvkBSAgAAfIGkBAAA+AJJCQAA8AWSEgAA4AskJQAAwBdISgAAgC/8H2L/ykgIkt+QAAAAAElFTkSuQmCC" width="549" height="67" class="img_ev3q"></p><p>  这里数据我已经存了一条记录了,我们看看会不会成功回滚: </p><p><img loading="lazy" alt="20191129143252" src="/zh-cn/assets/images/20191129143252-2f06cbc92fdf2fc68db30ebf51fcd5d3.png" width="943" height="588" class="img_ev3q"></p><p> 刷新数据库,发现还是只有一条数据: </p><p><img loading="lazy" alt="20191129143124" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAiUAAABDCAYAAABDX3WFAAALW0lEQVR4nO3db2wb9R3H8Y9btrZMUzSg0iaEphEnSMHswYT8INUKUjWKgwpBXVMeLVOBRGsXGpBCH6wPAxLLqJxmTErWVuqzkTKRFtVOgEowKdEW8YiGAolDH3Wb1IwpT1q6lnh3/nt2fJdz4rPPzvtVnRT7fL/7/n73S35f/35nN5A0CAAAoMa21DoAAAAA011OO5eXl6sVBzaB69eva+fOnbUOA/AE/dtZU1NTrUNAHWCmBAAA+AJJCQAA8IWA042uLN8AACqB5Ru4wUwJAADwBccbXa3KyXIXFxe17f7mdQVUTbeuLaq52f9xlsNs+0aqU6PVB7VHnwL8i5kSAADgCyQlAADAF0hKAACAL5CUAAAAX/A+KUlE9cyOdp1K2Oyf6tUDj0V11fNAgCoy+n17oF1Ru34PAFiFmRJgneK9AQUCJbbeeK1DA4C65H1SEuzX+ZszeiHo+ZmwSkLR9oAYI8vhvs0io0mZ3z2YTMbUY/yLJTOPRyOpfj+TnFE//R4AXHP9PSXf3LpdVsHzN1y+8JaxrUhXjdeXd4aN+7HKr1c9yNfptm5/K925fdt4rqYhbUh1r9F62uyO8W9F/zPi/MbL0ACgwXk/U/JVVH339uofuSfiOnFvQHuy28Exz0Nwb1JHtn9XO3LbYU0V7NutkZHDuf2PjSRsjy3cVwtmPG16dVY684wR0+6TGjlijSsd75FsBacOp16TsOwr3Q61VqqdExrZbdYls8+mHgXXZPGkHrPsS7fD6jZbsxw7qfKz7ZbpO1P5c6bON1UvfQkAqsN1UpLMTk272OyZCUmH9HZSl/6T3l7vrkAtNiAfd9wYCJ7W3O8/042bt9LbRFKd23+jyVy9/q5XP9+X3nd5SBr4tU4uZI8d1EOXM8fd/Ez7z7XpyKT7NqvUlq/TXv3RiOONsHRowojp4z49+VBYs58vpPdPntdcOKy5L9OPJ8+fUviXETW7aIfa1Kf0Nfrot83pfTITifPadzNd12bHa7Kgk28mdSpXv+eNY836rW4z53KscRbFvlL4XKrvvJY5Z+p8RsJx3tqX3sy0r3/6UqNuAPzLs5mS4j/OMn/+4F1dfPSEuvbk/0CEIy/m99fyj9PUBZ0JD+lUn+UmgL2vGAPUab2XmyYI642Xn0z/GOzQ/rDlWM3q2CPbdPcOc3tYx4x323Pz/nqHG4wcUPjMhdS796kLl7X/9O8UeiemhPFvfi6s/ZGgy3aokVKxWRya+JP2Wl9re02C6nvrJWnk5+l9naedz1mRa2v0ndMvKRX53qd1qKAvtSqky0oVWSd9CQC84Pqeks0rrIfc/DcZxmD56ceZQcevUonUOWPwm9SXcwfUHzSjfU1xI9n4qw7olPlw0e5gl+3gJ3bXJHFSjz8yIKVmXIKZx1+UX45X6qEvAYAHPFu+SSYzm1L3saZ/3tOpjk9e0dsfZvcn9M4f/lz4+ipuBfV6wnj3OjugF04m8s9NntAxY7CONCdzr8/P6FgeZ46NWqbYp44c1lSNZn/yj4tjblZkv5GAPP+azoRa1Zx9/Po5aX+H8dhNO9SwPqvaeVIjqTiL67nGNUl8oVlzxiWz9JOIndNs7viislxd2xLnL3jOoe/4uC816gbAv6r8PSURvfyXFxV7bot+sdPcfiU982J1Q7C1VyM3zit07GF97+7t6e1Z6d2P+rT2BIFx7KdDmnt2e+7Y9/a9pSeqELUzM+kI64wZ1+MjqUmQ5sgBaXZWh/alFzrSj42cJJKt5UbawWvF7XxBrX12UTlcE3M5SgP6aeb5F758ROHcccVtVu1r69e+BADeCyQd3josLy/nfr7rO9tcF/rvf13TV/f8ZGORVcGDX1/VD390f63DqCiz7RupTo1WH9Se2aeam2ufYgNYzfU9JWVPe9bJFzY04nRuo9Wp0eoDACjNsxtdk1sZSAAAgHvezZTcKTeU2mjEd+GNVqdGqw8AoDTPkpKVLfUxkDTigNdodWq0+gAASuN/CQYAAL7g+tM3S0tLVQkIALzGp28Af3K9fLPtfve/xLeuLergJf//0l86uKympqZah1FRZiLZSHVqtPqg9qxvtgD4C8s3AADAF0hKAACAL5CUAAAAXyApAQAAvrCupOSBHYFKxwEAADa5dc+U1EVi0ix90iOdKOeDQPFeBQIB9cY9i6q6EsPaZdQnkNnqvl6O9YmrN7dvl4YTRcfaXduCMkscV4pTPymnD7muT6/WLM5FTM5llW6/xPAuy7H5bVfJhnIRc6bOpY8HsJltaPnGz4lJ3wEjIfmZ9Lf/uj0ioeFdxh/SQamn3cvIqskYILqls8lk6ltRkwtRzXW4GNx8y6k+5vXr0Fx0Ib0vFlJ/i3Wf3bU1ymzpVyiWzB/XPSz74dKprHL70Fr1mVBnZl+sZ0wdtlnOGuc1E5LBNi1kz5McVaRkGaXbL3h0OnNcPs529ej40WCJMtaK2XhN97jUML9jACrJdVIyfyO/WZmJiXVf8f5aGTknPWpsV10fEdTRaeOP6fSA2jyMq7oiGp0+qtzQEXxKXe1zmq/bN6gO9Ulc1PiMZaCMDCjaPqaJ1JjocG3jExprj2ogO0qbx2lcF23byKmflNuHnK6PWVY+eYh09khz8zbJktN5jSRgcE7Rs5bzlOLYfsUvHddMT2eJxGbtmBPD3RrvOqvjIadgAGxWFbnRdc+9/p0xgdWCrsyE1Oo4OtUTS30WrhQNlEG1hswxcT0Z2IyuLFQsyDLYX5/4xJjau55yTixKMZMNdUlDJZZdUssomWUa1+0X11C/FM1mcdYy1orZeG33eJfOrpphAYC0in36hsTE/+K95vT8QIl3uPXJWp/E/Nz6CmlpU/tMv4ayMwLxIfXPVCrC8qy6Ppb7TSY6k5pez2BuJhtG/a505pde1N+9Kolw3X6pmaUuPWUXim3M5rJNv0LH15ixAbCpuU5KrGvKpXy4tOK4H7UV7w2oQ7H1DWw+VFyfYOs61wOCRzUd69FYR2YmYbBN0Z52tbWkzuJ842x5ETuWVfL6mLFlfqc6J4zjdjnd6+LAujxllHm8Z0bj5vpUqvxpmad0137mUtCYeqyJhaUMp5jNZZv+UEyjjZIRA/BERWZKzIQE/pUd8JINMiLY1qfg/oWEzDf/ITdrVZHRfNI93aorY9kllIhGc8m4ZeBdF/uy3FyfyGhMPTNO97rYMGeC3L52rfbL3HfS6bIb5WNO6OL4jIzML7eE1DEmzfS3KFD3HwcDUEllzJTkN6sPrq8U7GOixE/Sn8oYbFtokITEoT6pG1SLlmFkmSFwqbpLXA71MZdBLAN2YnjQednEjnnzrNES3Zb7SAbH2tVlFmS9H8RF+8XTN5MUto21DNuYMzfiWmZbYz3mBE6j9EsAlbKhmRIzIfGr1EeCjT983T+Qdu9x830lmY9VBlpS9xRkp/Pr+o1c5v6I1DvSii1D1JBjfYyB76z5kdrM8x1SLPfJFqdrm92X3swEwXmJy01ZLvuQU32CR3W2bTD3fEt/yFKfcmIyE4KYQtlzpD7+XGrWx6n9VJjM2CkrZgBYLZB0uAnE+l98z658P/fzE/ds1ftff2tb6INfX9XBS+V8Y1ltXDq4rKamplqHUVHmNWukOjVafVB79CnAv+5y/cpv8j++/89vCx4DAABslOukJLmVm0UAAIB33M+U3PEwCgAAsOm5TkpWtjBTAgAAvFOxb3QFAADYCNefvllaWiqr4Pvuu2/9UQGAh/j0DeBPrpMSfokBAICXWL4BAAC+QFICAAB8gaQEAAD4AkkJAADwBZISAADgCyQlAADAF0hKAACAL5CUAAAAXyApAQAAvkBSAgAAfIGkBAAA+AJJCQAA8AWSEgAA4AskJQAAwBdISgAAgC/8H2L/ykgIkt+QAAAAAElFTkSuQmCC" width="549" height="67" class="img_ev3q"></p><p> 再查看日志: </p><p><img loading="lazy" alt="20191129143407" src="/zh-cn/assets/images/20191129143407-7a7f98cf84b5d992c536e7e75e95e296.png" width="987" height="89" class="img_ev3q"></p><p> 显示已经回滚,我们再看看seata-server的日志: </p><img loading="lazy" src="/img/blog/20191129143419.png" style="zoom:200%" class="img_ev3q"><p> 显示回滚成功,事务id也是一致的,这下我们的分布式事务就跑通咯,通过打断点方式,大家可以查看undo_log,会发现再事务提交前,会存入一条事务信息的数据,如果回滚成功,该信息就会被删除. </p><h1>总结</h1><p>seata的整合还是比较简单易入手,稍微用心一些你肯定写的比我更好!</p><p>欢迎大家也多去阅读seata,dubbo之类的源代码,能解决业务中遇到的大量的坑哦!</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-11-28T00:00:00.000Z" itemprop="datePublished">2019年11月28日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>在分析启动部分源码时，我发现 GlobalTransactionScanner 会同时启动 RM 和 TM client，但根据 Seata 的设计来看，TM 负责全局事务的操作，如果一个服务中不需要开启全局事务，此时是不需要启动 TM client的，也就是说项目中如果没有全局事务注解，此时是不是就不需要初始化 TM client 了，因为不是每个微服务，都需要 GlobalTransactional，它此时仅仅作为一个 RM client 而已。</p><p>于是我着手将 GlobalTransactionScanner 稍微更改了初始化的规则，由于之前 GlobalTransactionScanner 调用 初始化方法是在 InitializingBean 中的 afterPropertiesSet() 方法中进行，afterPropertySet() 仅仅是当前 bean 初始化后被调用，此时无法得知当前 Spring 容器是否有全局事务注解。</p><p>因此我去掉了 InitializingBean，改成了是实现 ApplicationListener，在实例化 bean 的过程中检查是否有 GlobalTransactional 注解的存在，最后在 Spring 容器初始化完成之后再调用 RM 和 TM client 初始化方法，这时候就可以根据项目是否有用到全局事务注解来决定是否启动 TM client 了。</p><p>这里附上 PR 地址：<a href="https://github.com/seata/seata/pull/1936" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata/pull/1936</a></p><p>随后在 pr 中讨论中得知，目前 Seata 的设计是只有在发起方的 TM 才可以发起 GlobalRollbackRequest，RM 只能发送 BranchReport(false) 上报分支状态个 TC 服务端，无法直接发送 GlobalRollbackRequest 进行全局回滚操作。具体的交互逻辑如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191128094250.png" class="img_ev3q"></p><p>那么根据上面的设计模型，自然可以按需启动 TM client 了。</p><p>但是 Seata 后面的优化迭代中，还需要考虑的一点是：</p><p>当参与方出现异常时，是否可以直接由参与方的 TM client 发起全局回滚？这也就意味着可以缩短分布式事务的周期时间，尽快释放全局锁让其他数据冲突的事务尽早的获取到锁执行。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191127202606.png" class="img_ev3q"></p><p>也就是说在一个全局事务当中，只要有一个 RM client 执行本地事务失败了，直接当前服务的 TM client 发起全局事务回滚，不必要等待发起方的 TM 发起的决议回滚通知了。如果要实现这个优化，那么就需要每个服务都需要同时启动 TM client 和 RM client。</p><h1>作者简介：</h1><p>张乘辉，目前就职于中通科技信息中心技术平台部，担任 Java 工程师，主要负责中通消息平台与全链路压测项目的研发，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Contributor，GitHub ID：objcoding。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-11-27T00:00:00.000Z" itemprop="datePublished">2019年11月27日</time> · <!-- -->阅读需 14 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>从上一篇文章「<a href="https://mp.weixin.qq.com/s/Pypkm5C9aLPJHYwcM6tAtA" target="_blank" rel="noopener noreferrer">分布式事务中间件Seata的设计原理</a>」讲了下 Seata AT 模式的一些设计原理，从中也知道了 AT 模式的三个角色（RM、TM、TC），接下来我会更新 Seata 源码分析系列文章。今天就来分析 Seata AT 模式在启动的时候都做了哪些操作。</p><h1>客户端启动逻辑</h1><p>TM 是负责整个全局事务的管理器，因此一个全局事务是由 TM 开启的，TM 有个全局管理类 GlobalTransaction，结构如下：</p><p>io.seata.tm.api.GlobalTransaction</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface GlobalTransaction {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void begin() throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void begin(int timeout) throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void begin(int timeout, String name) throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void commit() throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void rollback() throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GlobalStatus getStatus() throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以通过 GlobalTransactionContext 创建一个 GlobalTransaction，然后用 GlobalTransaction 进行全局事务的开启、提交、回滚等操作，因此我们直接用 API 方式使用 Seata AT 模式：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//init seata;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//trx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tx.begin(60000, &quot;testBiz&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 事务处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (Exception exx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tx.rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throw exx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果每次使用全局事务都这样写，难免会造成代码冗余，我们的项目都是基于 Spring 容器，这时我们可以利用 Spring AOP 的特性，用模板模式把这些冗余代码封装模版里，参考 Mybatis-spring 也是做了这么一件事情，那么接下来我们来分析一下基于 Spring 的项目启动 Seata 并注册全局事务时都做了哪些工作。</p><p>我们开启一个全局事务是在方法上加上 <code>@GlobalTransactional</code>注解，Seata 的 Spring 模块中，有个 GlobalTransactionScanner，它的继承关系如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionScanner extends AbstractAutoProxyCreator implements InitializingBean, ApplicationContextAware, DisposableBean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在基于 Spring 项目的启动过程中，对该类会有如下初始化流程：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/image-20191124155455309.png" alt="image-20191124155455309" class="img_ev3q"></p><p>InitializingBean 的 afterPropertiesSet() 方法调用了 initClient() 方法：</p><p>io.seata.spring.annotation.GlobalTransactionScanner#initClient</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RMClient.init(applicationId, txServiceGroup);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>对 TM 和 RM 做了初始化操作。</p><ul><li>TM 初始化</li></ul><p>io.seata.tm.TMClient#init</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void init(String applicationId, String transactionServiceGroup) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 获取 TmRpcClient 实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TmRpcClient tmRpcClient = TmRpcClient.getInstance(applicationId, transactionServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 初始化 TM Client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tmRpcClient.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>调用 TmRpcClient.getInstance() 方法会获取一个 TM 客户端实例，在获取过程中，会创建 Netty 客户端配置文件对象，以及创建 messageExecutor 线程池，该线程池用于在处理各种与服务端的消息交互，在创建 TmRpcClient 实例时，创建 ClientBootstrap，用于管理 Netty 服务的启停，以及 ClientChannelManager，它是专门用于管理 Netty 客户端对象池，Seata 的 Netty 部分配合使用了对象池，后面在分析网络模块会讲到。</p><p>io.seata.core.rpc.netty.AbstractRpcRemotingClient#init</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clientBootstrap.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 定时尝试连接服务端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timerExecutor.scheduleAtFixedRate(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      clientChannelManager.reconnect(getTransactionServiceGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }, SCHEDULE_INTERVAL_MILLS, SCHEDULE_INTERVAL_MILLS, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mergeSendExecutorService = new ThreadPoolExecutor(MAX_MERGE_SEND_THREAD,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                    MAX_MERGE_SEND_THREAD,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                    KEEP_ALIVE_TIME, TimeUnit.MILLISECONDS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                    new LinkedBlockingQueue&lt;&gt;(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                    new NamedThreadFactory(getThreadPrefix(), MAX_MERGE_SEND_THREAD));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mergeSendExecutorService.submit(new MergedSendRunnable());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  super.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>调用 TM 客户端 init() 方法，最终会启动 netty 客户端（此时还未真正启动，在对象池被调用时才会被真正启动）；开启一个定时任务，定时重新发送 RegisterTMRequest（RM 客户端会发送 RegisterRMRequest）请求尝试连接服务端，具体逻辑是在 NettyClientChannelManager 中的 channels 中缓存了客户端 channel，如果此时 channels 不存在获取已过期，那么就会尝试连接服务端以重新获取 channel 并将其缓存到 channels 中；开启一条单独线程，用于处理异步请求发送，这里用得很巧妙，之后在分析网络模块在具体对其进行分析。</p><p>io.seata.core.rpc.netty.AbstractRpcRemoting#init</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timerExecutor.scheduleAtFixedRate(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (Map.Entry&lt;Integer, MessageFuture&gt; entry : futures.entrySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (entry.getValue().isTimeout()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          futures.remove(entry.getKey());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          entry.getValue().setResultMessage(null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug(&quot;timeout clear future: {}&quot;, entry.getValue().getRequestMessage().getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      nowMills = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }, TIMEOUT_CHECK_INTERNAL, TIMEOUT_CHECK_INTERNAL, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 AbstractRpcRemoting 的 init 方法中，又是开启了一个定时任务，该定时任务主要是用于定时清除 futures 已过期的 futrue，futures 是保存发送请求需要返回结果的 future 对象，该对象有个超时时间，过了超时时间就会自动抛异常，因此需要定时清除已过期的 future 对象。</p><ul><li>RM 初始化</li></ul><p>io.seata.rm.RMClient#init</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void init(String applicationId, String transactionServiceGroup) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RmRpcClient rmRpcClient = RmRpcClient.getInstance(applicationId, transactionServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rmRpcClient.setResourceManager(DefaultResourceManager.get());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rmRpcClient.setClientMessageListener(new RmMessageListener(DefaultRMHandler.get()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rmRpcClient.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> RmRpcClient.getInstance 处理逻辑与 TM 大致相同；ResourceManager 是 RM 资源管理器，负责分支事务的注册、提交、上报、以及回滚操作，以及全局锁的查询操作，DefaultResourceManager 会持有当前所有的 RM 资源管理器，进行统一调用处理，而 get() 方法主要是加载当前的资源管理器，主要用了类似 SPI 的机制，进行灵活加载，如下图，Seata 会扫描 META-INF/services/ 目录下的配置类并进行动态加载。</p><p>ClientMessageListener 是 RM 消息处理监听器，用于负责处理从 TC 发送过来的指令，并对分支进行分支提交、分支回滚，以及 undo log 删除操作；最后 init 方法跟 TM 逻辑也大体一致；DefaultRMHandler 封装了 RM 分支事务的一些具体操作逻辑。</p><p>接下来再看看 wrapIfNecessary 方法究竟做了哪些操作。</p><p>io.seata.spring.annotation.GlobalTransactionScanner#wrapIfNecessary</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 判断是否有开启全局事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (disableGlobalTransaction) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (PROXYED_SET) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (PROXYED_SET.contains(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      interceptor = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //check TCC proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (TCCBeanParserUtils.isTccAutoProxy(bean, beanName, applicationContext)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //TCC interceptor, proxy bean of sofa:reference/dubbo:reference, and LocalTCC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interceptor = new TccActionInterceptor(TCCBeanParserUtils.getRemotingDesc(beanName));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; serviceInterface = SpringProxyUtils.findTargetClass(bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt;[] interfacesIfJdk = SpringProxyUtils.findInterfaces(bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断 bean 中是否有 GlobalTransactional 和 GlobalLock 注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!existsAnnotation(new Class[]{serviceInterface})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp;&amp; !existsAnnotation(interfacesIfJdk)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (interceptor == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 创建代理类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          interceptor = new GlobalTransactionalInterceptor(failureHandlerHook);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOGGER.info(&quot;Bean[{}] with name [{}] would use interceptor [{}]&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  bean.getClass().getName(), beanName, interceptor.getClass().getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (!AopUtils.isAopProxy(bean)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bean = super.wrapIfNecessary(bean, beanName, cacheKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AdvisedSupport advised = SpringProxyUtils.getAdvisedSupport(bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 执行包装目标对象到代理对象  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Advisor[] advisor = super.buildAdvisors(beanName, getAdvicesAndAdvisorsForBean(null, null, null));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Advisor avr : advisor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          advised.addAdvisor(0, avr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      PROXYED_SET.add(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (Exception exx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new RuntimeException(exx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>GlobalTransactionScanner 继承了 AbstractAutoProxyCreator，用于对 Spring AOP 支持，从代码中可看出，用GlobalTransactionalInterceptor 代替了被 GlobalTransactional 和 GlobalLock 注解的方法。</p><p>GlobalTransactionalInterceptor 实现了 MethodInterceptor：</p><p>io.seata.spring.annotation.GlobalTransactionalInterceptor#invoke</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Object invoke(final MethodInvocation methodInvocation) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Class&lt;?&gt; targetClass = methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis()) : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final GlobalTransactional globalTransactionalAnnotation = getAnnotation(method, GlobalTransactional.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final GlobalLock globalLockAnnotation = getAnnotation(method, GlobalLock.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (globalTransactionalAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 全局事务注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else if (globalLockAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 全局锁注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return handleGlobalLock(methodInvocation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return methodInvocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上是代理方法执行的逻辑逻辑，其中 handleGlobalTransaction() 方法里面调用了 TransactionalTemplate 模版：</p><p>io.seata.spring.annotation.GlobalTransactionalInterceptor#handleGlobalTransaction</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private Object handleGlobalTransaction(final MethodInvocation methodInvocation,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final GlobalTransactional globalTrxAnno) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionalTemplate.execute(new TransactionalExecutor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      public Object execute() throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return methodInvocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      public TransactionInfo getTransactionInfo() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (TransactionalExecutor.ExecutionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>handleGlobalTransaction() 方法执行了就是 TransactionalTemplate 模版类的 execute 方法：</p><p>io.seata.tm.api.TransactionalTemplate#execute</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Object execute(TransactionalExecutor business) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 1. get or create a transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 1.1 get transactionInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TransactionInfo txInfo = business.getTransactionInfo();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (txInfo == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new ShouldNeverHappenException(&quot;transactionInfo does not exist&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. begin transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    beginTransaction(txInfo, tx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Do Your Business</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rs = business.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 3.the needed business exception to rollback.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      completeTransactionAfterThrowing(txInfo,tx,ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 4. everything is fine, commit.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    commitTransaction(tx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //5. clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    triggerAfterCompletion();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cleanUp();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上是不是有一种似曾相识的感觉？没错，以上就是我们使用 API 时经常写的冗余代码，现在 Spring 通过代理模式，把这些冗余代码都封装带模版里面了，它将那些冗余代码统统封装起来统一流程处理，并不需要你显示写出来了，有兴趣的也可以去看看 Mybatis-spring 的源码，也是写得非常精彩。</p><h1>服务端处理逻辑</h1><p>服务端收到客户端的连接，那当然是将其 channel 也缓存起来，前面也说到客户端会发送 RegisterRMRequest/RegisterTMRequest 请求给服务端，服务端收到后会调用 ServerMessageListener 监听器处理：</p><p>io.seata.core.rpc.ServerMessageListener</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ServerMessageListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 处理各种事务，如分支注册、分支提交、分支上报、分支回滚等等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void onTrxMessage(RpcMessage request, ChannelHandlerContext ctx, ServerMessageSender sender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理 RM 客户端的注册连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void onRegRmMessage(RpcMessage request, ChannelHandlerContext ctx,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ServerMessageSender sender, RegisterCheckAuthHandler checkAuthHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 处理 TM 客户端的注册连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void onRegTmMessage(RpcMessage request, ChannelHandlerContext ctx,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ServerMessageSender sender, RegisterCheckAuthHandler checkAuthHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 服务端与客户端保持心跳</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void onCheckMessage(RpcMessage request, ChannelHandlerContext ctx, ServerMessageSender sender)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ChannelManager 是服务端 channel 的管理器，服务端每次和客户端通信，都需要从 ChannelManager 中获取客户端对应的 channel，它用于保存 TM 和 RM 客户端 channel 的缓存结构如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * resourceId -&gt; applicationId -&gt; ip -&gt; port -&gt; RpcContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static final ConcurrentMap&lt;String, ConcurrentMap&lt;String, ConcurrentMap&lt;String, ConcurrentMap&lt;Integer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RpcContext&gt;&gt;&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RM_CHANNELS = new ConcurrentHashMap&lt;String, ConcurrentMap&lt;String, ConcurrentMap&lt;String, ConcurrentMap&lt;Integer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RpcContext&gt;&gt;&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ip+appname,port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static final ConcurrentMap&lt;String, ConcurrentMap&lt;Integer, RpcContext&gt;&gt; TM_CHANNELS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = new ConcurrentHashMap&lt;String, ConcurrentMap&lt;Integer, RpcContext&gt;&gt;();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上的 Map 结构有点复杂：</p><p>RM_CHANNELS：</p><ol><li>resourceId 指的是 RM client 的数据库地址；</li><li>applicationId 指的是 RM client 的服务 Id，比如 springboot 的配置 spring.application.name=account-service 中的 account-service 即是  applicationId；</li><li>ip 指的是 RM client 服务地址；</li><li>port 指的是 RM client 服务地址；</li><li>RpcContext 保存了本次注册请求的信息。</li></ol><p>TM_CHANNELS：</p><ol><li>ip+appname：这里的注释应该是写错了，应该是 appname+ip，即 TM_CHANNELS 的 Map 结构第一个 key 为 appname+ip；</li><li>port：客户端的端口号。</li></ol><p>以下是 RM Client 注册逻辑：</p><p>io.seata.core.rpc.ChannelManager#registerRMChannel</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void registerRMChannel(RegisterRMRequest resourceManagerRequest, Channel channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throws IncompatibleVersionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Version.checkVersion(resourceManagerRequest.getVersion());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 将 ResourceIds 数据库连接连接信息放入一个set中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Set&lt;String&gt; dbkeySet = dbKeytoSet(resourceManagerRequest.getResourceIds());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RpcContext rpcContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 从缓存中判断是否有该channel信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (!IDENTIFIED_CHANNELS.containsKey(channel)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 根据请求注册信息，构建 rpcContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcContext = buildChannelHolder(NettyPoolKey.TransactionRole.RMROLE, resourceManagerRequest.getVersion(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    resourceManagerRequest.getApplicationId(), resourceManagerRequest.getTransactionServiceGroup(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    resourceManagerRequest.getResourceIds(), channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 将 rpcContext 放入缓存中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcContext.holdInIdentifiedChannels(IDENTIFIED_CHANNELS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcContext = IDENTIFIED_CHANNELS.get(channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcContext.addResources(dbkeySet);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (null == dbkeySet || dbkeySet.isEmpty()) { return; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for (String resourceId : dbkeySet) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String clientIp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 将请求信息存入 RM_CHANNELS 中，这里用了 java8 的 computeIfAbsent 方法操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConcurrentMap&lt;Integer, RpcContext&gt; portMap = RM_CHANNELS.computeIfAbsent(resourceId, resourceIdKey -&gt; new ConcurrentHashMap&lt;&gt;())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .computeIfAbsent(resourceManagerRequest.getApplicationId(), applicationId -&gt; new ConcurrentHashMap&lt;&gt;())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .computeIfAbsent(clientIp = getClientIpFromChannel(channel), clientIpKey -&gt; new ConcurrentHashMap&lt;&gt;());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将当前 rpcContext 放入 portMap 中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcContext.holdInResourceManagerChannels(resourceId, portMap);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    updateChannelsResource(resourceId, clientIp, resourceManagerRequest.getApplicationId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从以上代码逻辑能够看出，注册 RM client 主要是将注册请求信息，放入 RM_CHANNELS 缓存中，同时还会从 IDENTIFIED_CHANNELS 中判断本次请求的 channel 是否已验证过，IDENTIFIED_CHANNELS 的结构如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static final ConcurrentMap&lt;Channel, RpcContext&gt; IDENTIFIED_CHANNELS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = new ConcurrentHashMap&lt;&gt;();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>IDENTIFIED_CHANNELS 包含了所有 TM 和 RM 已注册的 channel。</p><p>以下是 TM 注册逻辑：</p><p>io.seata.core.rpc.ChannelManager#registerTMChannel</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void registerTMChannel(RegisterTMRequest request, Channel channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throws IncompatibleVersionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Version.checkVersion(request.getVersion());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 根据请求注册信息，构建 RpcContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RpcContext rpcContext = buildChannelHolder(NettyPoolKey.TransactionRole.TMROLE, request.getVersion(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             request.getApplicationId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             request.getTransactionServiceGroup(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             null, channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 将 RpcContext 放入 IDENTIFIED_CHANNELS 缓存中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rpcContext.holdInIdentifiedChannels(IDENTIFIED_CHANNELS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // account-service:127.0.0.1:63353</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String clientIdentified = rpcContext.getApplicationId() + Constants.CLIENT_ID_SPLIT_CHAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    + getClientIpFromChannel(channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 将请求信息存入 TM_CHANNELS 缓存中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TM_CHANNELS.putIfAbsent(clientIdentified, new ConcurrentHashMap&lt;Integer, RpcContext&gt;());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 将上一步创建好的get出来，之后再将rpcContext放入这个map的value中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ConcurrentMap&lt;Integer, RpcContext&gt; clientIdentifiedMap = TM_CHANNELS.get(clientIdentified);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rpcContext.holdInClientChannels(clientIdentifiedMap);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TM client 的注册大体类似，把本次注册的信息放入对应的缓存中保存，但比 RM client 的注册逻辑简单一些，主要是 RM client 会涉及分支事务资源的信息，需要注册的信息也会比 TM client 多。</p><p>以上源码分析基于 0.9.0 版本。</p><h1>作者简介</h1><p>张乘辉，目前就职于中通科技信息中心技术平台部，担任 Java 工程师，主要负责中通消息平台与全链路压测项目的研发，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Contributor，GitHub ID：objcoding。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-11-04T00:00:00.000Z" itemprop="datePublished">2019年11月4日</time> · <!-- -->阅读需 29 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">long187</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Seata 意为：Simple Extensible Autonomous Transaction Architecture，是一套一站式分布式事务解决方案，提供了 AT、TCC、Saga 和 XA 事务模式，本文详解其中的 Saga 模式。<br>项目地址：<a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata</a></p><p>本文作者：屹远（陈龙），蚂蚁金服分布式事务核心研发，Seata Committer。</p><a name="uTwja"></a># 金融分布式应用开发的痛点<p>分布式系统有一个比较明显的问题就是，一个业务流程需要组合一组服务。这样的事情在微服务下就更为明显了，因为这需要业务上的一致性的保证。也就是说，如果一个步骤失败了，那么要么回滚到以前的服务调用，要么不断重试保证所有的步骤都成功。---《左耳听风-弹力设计之“补偿事务”》</p><p>而在金融领域微服务架构下的业务流程往往会更复杂，流程很长，比如一个互联网微贷业务流程调十几个服务很正常，再加上异常处理的流程那就更复杂了，做过金融业务开发的同学会很有体感。</p><p>所以在金融分布式应用开发过程中我们面临一些痛点：</p><ul><li><strong>业务一致性难以保障</strong><br></li></ul><p>我们接触到的大多数业务（比如在渠道层、产品层、集成层的系统），为了保障业务最终一致性，往往会采用“补偿”的方式来做，如果没有一个协调器来支持，开发难度是比较大的，每一步都要在 catch 里去处理前面所有的“回滚”操作，这将会形成“箭头形”的代码，可读性及维护性差。或者重试异常的操作，如果重试不成功可能要转异步重试，甚至最后转人工处理。这些都给开发人员带来极大的负担，开发效率低，且容易出错。</p><ul><li><strong>业务状态难以管理</strong><br></li></ul><p>业务实体很多、实体的状态也很多，往往做完一个业务活动后就将实体的状态更新到了数据库里，没有一个状态机来管理整个状态的变迁过程，不直观，容易出错，造成业务进入一个不正确的状态。</p><ul><li><strong>幂等性难以保障</strong><br></li></ul><p>服务的幂等性是分布式环境下的基本要求，为了保证服务的幂等性往往需要服务开发者逐个去设计，有用数据库唯一键实现的，有用分布式缓存实现的，没有一个统一的方案，开发人员负担大，也容易遗漏，从而造成资损。</p><ul><li><strong>业务监控运维难，缺乏统一的差错守护能力</strong><br></li></ul><p>业务的执行情况监控一般通过打印日志，再基于日志监控平台查看，大多数情况是没有问题的，但是如果业务出错，这些监控缺乏当时的业务上下文，对排查问题不友好，往往需要再去数据库里查。同时日志的打印也依赖于开发，容易遗漏。对于补偿事务往往需要有“差错守护触发补偿”、“工人触发补偿”操作，没有统一的差错守护和处理规范，这些都要开发者逐个开发，负担沉重。</p><a name="hvEU6"></a><h1>理论基础</h1><p>一些场景下，我们对数据有强一致性的需求时，会采用在业务层上需要使用“两阶段提交”这样的分布式事务方案。而在另外一些场景下，我们并不需要这么强的一致性，那就只需要保证最终一致性就可以了。</p><p>例如蚂蚁金服目前在金融核心系统使用的就是 TCC 模式，金融核心系统的特点是一致性要求高（业务上的隔离性）、短流程、并发高。</p><p>而在很多金融核心以上的业务（比如在渠道层、产品层、集成层的系统），这些系统的特点是最终一致即可、流程多、流程长、还可能要调用其它公司的服务（如金融网络）。这是如果每个服务都开发 Try、Confirm、Cancel 三个方法成本高。如果事务中有其它公司的服务，也无法要求其它公司的服务也遵循 TCC 这种开发模式。同时流程长，事务边界太长会影响性能。</p><p>对于事务我们都知道 ACID，也很熟悉 CAP 理论最多只能满足其中两个，所以，为了提高性能，出现了 ACID 的一个变种 BASE。ACID 强调的是一致性（CAP 中的 C），而 BASE 强调的是可用性（CAP 中的 A）。我们知道，在很多情况下，我们是无法做到强一致性的 ACID 的。特别是我们需要跨多个系统的时候，而且这些系统还不是由一个公司所提供的。BASE 的系统倾向于设计出更加有弹力的系统，在短时间内，就算是有数据不同步的风险，我们也应该允许新的交易可以发生，而后面我们在业务上将可能出现问题的事务通过补偿的方式处理掉，以保证最终的一致性。</p><p>所以我们在实际开发中会进行取舍，对于更多的金融核心以上的业务系统可以采用补偿事务，补偿事务处理方面在30年前就提出了 Saga 理论，随着微服务的发展，近些年才逐步受到大家的关注。目前业界比较也公认 Saga 是作为长事务的解决方案。</p><blockquote><p><a href="https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf" target="_blank" rel="noopener noreferrer">https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf</a>[1][http://microservices.io/patterns/data/saga.html]<!-- -->(<a href="http://microservices.io/patterns/data/saga.html)%5B2%5D" target="_blank" rel="noopener noreferrer">http://microservices.io/patterns/data/saga.html)[2]</a></p></blockquote><a name="k8kbY"></a><h1>社区和业界的方案</h1><a name="Oc5Er"></a>## Apache Camel Saga<p>Camel 是实现 EIP（Enterprise Integration Patterns）企业集成模式的一款开源产品，它基于事件驱动的架构，有着良好的性能和吞吐量，它在2.21版本新增加了 Saga EIP。</p><p>Saga EIP 提供了一种方式可以通过 camel route 定义一系列有关联关系的 Action，这些 Action 要么都执行成功，要么都回滚，Saga 可以协调任何通讯协议的分布式服务或本地服务，并达到全局的最终一致性。Saga 不要求整个处理在短时间内完成，因为它不占用任何数据库锁，它可以支持需要长时间处理的请求，从几秒到几天，Camel 的 Saga EIP 是基于 <a href="https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA" target="_blank" rel="noopener noreferrer">Microprofile 的 LRA</a>[3]<!-- -->（Long Running Action），同样也是支持协调任何通讯协议任何语言实现的分布式服务。</p><p>Saga 的实现不会对数据进行加锁，而是在给操作定义它的“补偿操作”，当正常流程执行出错的时候触发那些已经执行过的操作的“补偿操作”，将流程回滚掉。“补偿操作”可以在 Camel route 上用 Java 或 XML DSL（Definition Specific Language）来定义。</p><p>下面是一个 Java DSL 示例：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from(&quot;direct:reserveCredit&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .bean(idService, &quot;generateCustomId&quot;) // generate a custom Id and set it in the body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .to(&quot;direct:creditReservation&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// delegate action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from(&quot;direct:creditReservation&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .saga()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .propagation(SagaPropagation.SUPPORTS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .option(&quot;CreditId&quot;, body()) // mark the current body as needed in the compensating action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .compensation(&quot;direct:creditRefund&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .bean(creditService, &quot;reserveCredit&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .log(&quot;Credit ${header.amount} reserved. Custom Id used is ${body}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// called only if the saga is cancelled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from(&quot;direct:creditRefund&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .transform(header(&quot;CreditId&quot;)) // retrieve the CreditId option from headers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .bean(creditService, &quot;refundCredit&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .log(&quot;Credit for Custom Id ${body} refunded&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>XML DSL 示例：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">route</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">from</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">direct:start</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">saga</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">compensation</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">direct:compensation</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">completion</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">direct:completion</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">option</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">optionName</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">myOptionKey</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">myOptionValue</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">option</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">option</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">optionName</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">myOptionKey2</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">myOptionValue2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">option</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">saga</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">to</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">direct:action1</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">to</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">direct:action2</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">route</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="pQWuF"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eventuate-tram-saga">Eventuate Tram Saga<a href="#eventuate-tram-saga" class="hash-link" aria-label="Eventuate Tram Saga的直接链接" title="Eventuate Tram Saga的直接链接">​</a></h2><p><a href="https://github.com/eventuate-tram/eventuate-tram-sagas" target="_blank" rel="noopener noreferrer">Eventuate Tram Saga</a>[4]<!-- --> 框架是使用 JDBC / JPA 的 Java 微服务的一个 Saga 框架。它也和 Camel Saga 一样采用了 Java DSL 来定义补偿操作：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CreateOrderSaga implements SimpleSaga&lt;CreateOrderSagaData&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private SagaDefinition&lt;CreateOrderSagaData&gt; sagaDefinition =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .withCompensation(this::reject)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .invokeParticipant(this::reserveCredit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .invokeParticipant(this::approve)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public SagaDefinition&lt;CreateOrderSagaData&gt; getSagaDefinition() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return this.sagaDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private CommandWithDestination reserveCredit(CreateOrderSagaData data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long orderId = data.getOrderId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Long customerId = data.getOrderDetails().getCustomerId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Money orderTotal = data.getOrderDetails().getOrderTotal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return send(new ReserveCreditCommand(customerId, orderId, orderTotal))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .to(&quot;customerService&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="scN9h"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="apache-servicecomb-saga">Apache ServiceComb Saga<a href="#apache-servicecomb-saga" class="hash-link" aria-label="Apache ServiceComb Saga的直接链接" title="Apache ServiceComb Saga的直接链接">​</a></h2><p><a href="https://github.com/apache/incubator-servicecomb-saga" target="_blank" rel="noopener noreferrer">ServiceComb Saga</a>[5]<!-- --> 也是一个微服务应用的数据最终一致性解决方案。相对于 <a href="http://design.inf.usi.ch/sites/default/files/biblio/rest-tcc.pdf" target="_blank" rel="noopener noreferrer">TCC</a> 而言，在 try 阶段，Saga 会直接提交事务，后续 rollback 阶段则通过反向的补偿操作来完成。与前面两种不同是它是采用 Java 注解+拦截器的方式来进行“补偿”服务的定义。<br></p><a name="ouwrmp"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="架构">架构：<a href="#架构" class="hash-link" aria-label="架构：的直接链接" title="架构：的直接链接">​</a></h4><p>Saga 是由 <strong>alpha</strong> 和 <strong>omega </strong>组成，其中：</p><ul><li>alpha 充当协调者的角色，主要负责对事务进行管理和协调；<br></li><li>omega 是微服务中内嵌的一个 agent，负责对网络请求进行拦截并向 alpha 上报事务事件；<br></li></ul><p>下图展示了 alpha，omega 以及微服务三者的关系：<br>
<img loading="lazy" alt="ServiceComb Saga" src="/zh-cn/assets/images/service-comb-saga-cb30d341b536a9227801771bc0836ee2.png" width="746" height="261" class="img_ev3q"></p><a name="ggflbq"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="使用示例">使用示例：<a href="#使用示例" class="hash-link" aria-label="使用示例：的直接链接" title="使用示例：的直接链接">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ServiceA extends AbsService implements IServiceA {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static final Logger LOG = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private IServiceB serviceB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private IServiceC serviceC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public String getServiceName() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;servicea&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public String getTableName() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;testa&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @SagaStart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Compensable(compensationMethod = &quot;cancelRun&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Transactional(rollbackFor = Exception.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Object run(InvokeContext invokeContext) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;A.run called&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    doRunBusi();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invokeContext.isInvokeB(getServiceName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceB.run(invokeContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invokeContext.isInvokeC(getServiceName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceC.run(invokeContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invokeContext.isException(getServiceName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.info(&quot;A.run exception&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new Exception(&quot;A.run exception&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void cancelRun(InvokeContext invokeContext) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;A.cancel called&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    doCancelBusi();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="CnD8r"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="蚂蚁金服的实践">蚂蚁金服的实践<a href="#蚂蚁金服的实践" class="hash-link" aria-label="蚂蚁金服的实践的直接链接" title="蚂蚁金服的实践的直接链接">​</a></h2><p>蚂蚁金服内部大规模在使用 TCC 模式分布式事务，主要用于金融核心等对一致性要求高、性能要求高的场景。在更上层的业务系统因为流程多流程长，开发 TCC 成本比较高，大都会权衡采用 Saga 模式来到达业务最终一致性，由于历史的原因不同的 BU 有自己的一套“补偿”事务的方案，基本上是两种：</p><ul><li>一种是当一个服务在失败时需要“重试”或“补偿”时，在执行服务前在数据库插入一条记录，记录状态，当异常时通过定时任务去查询数据库记录并进行“重试”或“补偿”，当业务流程执行成功则删除记录；</li><li>另一种是设计一个状态机引擎和简单的 DSL，编排业务流程和记录业务状态，状态机引擎可以定义“补偿服务”，当异常时由状态机引擎反向调用“补偿服务”进行回滚，同时还会有一个“差错守护”平台，监控那些执行失败或补偿失败的业务流水，并不断进行“补偿”或“重试”；</li></ul><a name="MAZEu"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="方案对比">方案对比<a href="#方案对比" class="hash-link" aria-label="方案对比的直接链接" title="方案对比的直接链接">​</a></h2><p>社区和业界的解决方案一般是两种，一种基本状态机或流程引擎通过 DSL 方式编排流程程和补偿定义，一种是基于 Java 注解+拦截器实现补偿，那么这两种方案有什么优缺点呢？</p><table><thead><tr><th><strong>方式</strong></th><th><strong>优点</strong></th><th><strong>缺点</strong></th></tr></thead><tbody><tr><td>状态机+DSL</td><td><br>- 可以用可视化工具来定义业务流程，标准化，可读性高，可实现服务编排的功能<br>- 提高业务分析人员与程序开发人员的沟通效率<br>- 业务状态管理：流程本质就是一个状态机，可以很好的反映业务状态的流转<br>- 提高异常处理灵活性：可以实现宕机恢复后的“向前重试”或“向后补偿”<br>- 天然可以使用 Actor 模型或 SEDA 架构等异步处理引擎来执行，提高整体吞吐量<br></td><td><br>- 业务流程实际是由 JAVA 程序与 DSL 配置组成，程序与配置分离，开发起来比较繁琐<br>- 如果是改造现有业务，对业务侵入性高<br>- 引擎实现成本高<br></td></tr><tr><td>拦截器+java 注解</td><td><br>- 程序与注解是在一起的，开发简单，学习成本低<br>- 方便接入现有业务<br>- 基于动态代理拦截器，框架实现成本低<br></td><td><br>- 框架无法提供 Actor 模型或 SEDA 架构等异步处理模式来提高系统吞吐量<br>- 框架无法提供业务状态管理<br>- 难以实现宕机恢复后的“向前重试”，因为无法恢复线程上下文<br></td></tr></tbody></table><a name="EKm6f"></a><h1></h1><a name="tw6CG"></a><h1>Seata Saga 的方案</h1><p>Seata Saga 的简介可以看一下<a href="http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">《Seata Saga 官网文档》</a>[6]<!-- -->。</p><p>Seata Saga 采用了状态机+DSL 方案来实现，原因有以下几个：</p><ul><li>状态机+DSL 方案在实际生产中应用更广泛；</li><li>可以使用 Actor 模型或 SEDA 架构等异步处理引擎来执行，提高整体吞吐量；</li><li>通常在核心系统以上层的业务系统会伴随有“服务编排”的需求，而服务编排又有事务最终一致性要求，两者很难分割开，状态机+DSL 方案可以同时满足这两个需求；</li><li>由于 Saga 模式在理论上是不保证隔离性的，在极端情况下可能由于脏写无法完成回滚操作，比如举一个极端的例子, 分布式事务内先给用户 A 充值，然后给用户 B 扣减余额，如果在给A用户充值成功，在事务提交以前，A 用户把线消费掉了，如果事务发生回滚，这时则没有办法进行补偿了，有些业务场景可以允许让业务最终成功，在回滚不了的情况下可以继续重试完成后面的流程，状态机+DSL的方案可以实现“向前”恢复上下文继续执行的能力, 让业务最终执行成功，达到最终一致性的目的。</li></ul><blockquote><p>在不保证隔离性的情况下：业务流程设计时要遵循“宁可长款, 不可短款”的原则，长款意思是客户少了线机构多了钱，以机构信誉可以给客户退款，反之则是短款，少的线可能追不回来了。所以在业务流程设计上一定是先扣款。</p></blockquote><a name="4yL9U"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="状态定义语言seata-state-language">状态定义语言(Seata State Language)<a href="#状态定义语言seata-state-language" class="hash-link" aria-label="状态定义语言(Seata State Language)的直接链接" title="状态定义语言(Seata State Language)的直接链接">​</a></h3><ol><li><p>通过状态图来定义服务调用的流程并生成 json 状态语言定义文件；</p></li><li><p>状态图中一个节点可以是调用一个服务，节点可以配置它的补偿节点；</p></li><li><p>状态图 json 由状态机引擎驱动执行，当出现异常时状态引擎反向执行已成功节点对应的补偿节点将事务回滚；</p><blockquote><p>注意: 异常发生时是否进行补偿也可由用户自定义决定</p></blockquote></li><li><p>可以实现服务编排需求，支持单项选择、并发、异步、子状态机、参数转换、参数映射、服务执行状态判断、异常捕获等功能；</p></li></ol><p>假设有一个业务流程要调两个服务，先调库存扣减（InventoryService），再调余额扣减（BalanceService），保证在一个分布式内要么同时成功，要么同时回滚。两个参与者服务都有一个 reduce 方法，表示库存扣减或余额扣减，还有一个 compensateReduce 方法，表示补偿扣减操作。以 InventoryService 为例看一下它的接口定义：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface InventoryService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * reduce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param businessKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param amount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean reduce(String businessKey, BigDecimal amount, Map&lt;String, Object&gt; params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * compensateReduce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param businessKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean compensateReduce(String businessKey, Map&lt;String, Object&gt; params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个业务流程对应的状态图：</p><p><img loading="lazy" alt="示例状态图" src="/zh-cn/assets/images/demo_statelang-90f1fc01bfaf3a795c3b3357e1046f16.png" width="508" height="543" class="img_ev3q"></p><br>对应的 JSON<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reduceInventoryAndBalance&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Comment&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reduce inventory then reduce balance in a transaction&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;StartState&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ReduceInventory&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;States&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;ReduceInventory&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ServiceTask&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;inventoryAction&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceMethod&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reduce&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;CompensateState&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CompensateReduceInventory&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Next&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ChoiceState&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Input&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[businessKey]&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[count]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Output&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;reduceInventoryResult&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$.#root&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Status&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;#root == true&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SU&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;#root == false&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;FA&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;$Exception{java.lang.Throwable}&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;UN&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;ChoiceState&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Choice&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Choices&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;Expression&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;[reduceInventoryResult] == true&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;Next&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;ReduceBalance&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Default&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fail&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;ReduceBalance&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ServiceTask&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;balanceAction&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceMethod&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reduce&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;CompensateState&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CompensateReduceBalance&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Input&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[businessKey]&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[amount]&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;throwException&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$.[mockReduceBalanceFail]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Output&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;compensateReduceBalanceResult&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$.#root&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Status&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;#root == true&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SU&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;#root == false&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;FA&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;$Exception{java.lang.Throwable}&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;UN&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Catch&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;Exceptions&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token string" style="color:#e3116c">&quot;java.lang.Throwable&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;Next&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CompensationTrigger&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Next&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Succeed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;CompensateReduceInventory&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ServiceTask&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;inventoryAction&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceMethod&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;compensateReduce&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Input&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[businessKey]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;CompensateReduceBalance&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ServiceTask&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;balanceAction&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceMethod&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;compensateReduce&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Input&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[businessKey]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;CompensationTrigger&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CompensationTrigger&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Next&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Fail&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;Succeed&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Succeed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;Fail&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fail&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ErrorCode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PURCHASE_FAILED&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Message&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;purchase failed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>状态语言在一定程度上参考了 <a href="https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html" target="_blank" rel="noopener noreferrer">AWS Step Functions</a>[7]<!-- -->。</p><a name="2de9b28a"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="状态机-属性简介">&quot;状态机&quot; 属性简介:<a href="#状态机-属性简介" class="hash-link" aria-label="&quot;状态机&quot; 属性简介:的直接链接" title="&quot;状态机&quot; 属性简介:的直接链接">​</a></h4><ul><li>Name: 表示状态机的名称，必须唯一；</li><li>Comment: 状态机的描述；</li><li>Version: 状态机定义版本；</li><li>StartState: 启动时运行的第一个&quot;状态&quot;；</li><li>States: 状态列表，是一个 map 结构，key 是&quot;状态&quot;的名称，在状态机内必须唯一；</li></ul><a name="2b956670"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="状态-属性简介">&quot;状态&quot; 属性简介:<a href="#状态-属性简介" class="hash-link" aria-label="&quot;状态&quot; 属性简介:的直接链接" title="&quot;状态&quot; 属性简介:的直接链接">​</a></h4><ul><li>Type：&quot;状态&quot; 的类型，比如有：<ul><li>ServiceTask: 执行调用服务任务；</li><li>Choice: 单条件选择路由；</li><li>CompensationTrigger: 触发补偿流程；</li><li>Succeed: 状态机正常结束；</li><li>Fail: 状态机异常结束；</li><li>SubStateMachine: 调用子状态机；</li></ul></li><li>ServiceName: 服务名称，通常是服务的beanId；</li><li>ServiceMethod: 服务方法名称；</li><li>CompensateState: 该&quot;状态&quot;的补偿&quot;状态&quot;；</li><li>Input: 调用服务的输入参数列表，是一个数组，对应于服务方法的参数列表， $.表示使用表达式从状态机上下文中取参数，表达使用的 <a href="https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html" target="_blank" rel="noopener noreferrer">SpringEL</a>[8]<!-- -->， 如果是常量直接写值即可；</li><li>Output: 将服务返回的参数赋值到状态机上下文中，是一个 map 结构，key 为放入到状态机上文时的 key（状态机上下文也是一个 map），value 中 $. 是表示 SpringEL 表达式，表示从服务的返回参数中取值，#root 表示服务的整个返回参数；</li><li>Status: 服务执行状态映射，框架定义了三个状态，SU 成功、FA 失败、UN 未知，我们需要把服务执行的状态映射成这三个状态，帮助框架判断整个事务的一致性，是一个 map 结构，key 是条件表达式，一般是取服务的返回值或抛出的异常进行判断，默认是 SpringEL 表达式判断服务返回参数，带 $Exception{开头表示判断异常类型，value 是当这个条件表达式成立时则将服务执行状态映射成这个值；</li><li>Catch: 捕获到异常后的路由；</li><li>Next: 服务执行完成后下一个执行的&quot;状态&quot;；</li><li>Choices: Choice 类型的&quot;状态&quot;里, 可选的分支列表, 分支中的 Expression 为 SpringEL 表达式，Next 为当表达式成立时执行的下一个&quot;状态&quot;；</li><li>ErrorCode: Fail 类型&quot;状态&quot;的错误码；</li><li>Message: Fail 类型&quot;状态&quot;的错误信息；</li></ul><p>更多详细的状态语言解释请看<a href="http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">《Seata Saga 官网文档》</a>[6<a href="http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">http://seata.io/zh-cn/docs/user/saga.html</a>]。</p><a name="209f0e37"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="状态机引擎原理">状态机引擎原理:<a href="#状态机引擎原理" class="hash-link" aria-label="状态机引擎原理:的直接链接" title="状态机引擎原理:的直接链接">​</a></h3><p><img loading="lazy" alt="状态机引擎原理" src="/zh-cn/assets/images/saga_engine_mechanism-38f1563ee8316a5dcabeeba27f511f79.png" width="936" height="672" class="img_ev3q"></p><ul><li>图中的状态图是先执行 stateA, 再执行 stataB，然后执行 stateC；</li><li>&quot;状态&quot;的执行是基于事件驱动的模型，stataA 执行完成后，会产生路由消息放入 EventQueue，事件消费端从 EventQueue 取出消息，执行 stateB；</li><li>在整个状态机启动时会调用 Seata Server 开启分布式事务，并生产 xid, 然后记录&quot;状态机实例&quot;启动事件到本地数据库；</li><li>当执行到一个&quot;状态&quot;时会调用 Seata Server 注册分支事务，并生产 branchId, 然后记录&quot;状态实例&quot;开始执行事件到本地数据库；</li><li>当一个&quot;状态&quot;执行完成后会记录&quot;状态实例&quot;执行结束事件到本地数据库, 然后调用 Seata Server 上报分支事务的状态；</li><li>当整个状态机执行完成，会记录&quot;状态机实例&quot;执行完成事件到本地数据库, 然后调用 Seata Server 提交或回滚分布式事务；</li></ul><a name="808e95dc"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="状态机引擎设计">状态机引擎设计:<a href="#状态机引擎设计" class="hash-link" aria-label="状态机引擎设计:的直接链接" title="状态机引擎设计:的直接链接">​</a></h3><p><img loading="lazy" alt="状态机引擎设计" src="/zh-cn/assets/images/saga_engine-41e75396b108b8e6c157d08766368124.png" width="1044" height="702" class="img_ev3q"></p><p>状态机引擎的设计主要分成三层, 上层依赖下层，从下往上分别是：</p><ul><li><p>Eventing 层：</p><ul><li>实现事件驱动架构, 可以压入事件, 并由消费端消费事件, 本层不关心事件是什么消费端执行什么，由上层实现；</li></ul></li><li><p>ProcessController 层：</p><ul><li>由于上层的 Eventing 驱动一个“空”流程执行的执行，&quot;state&quot;的行为和路由都未实现，由上层实现；<blockquote><p>基于以上两层理论上可以自定义扩展任何&quot;流程&quot;引擎。这两层的设计是参考了内部金融网络平台的设计。</p></blockquote></li></ul></li></ul><ul><li>StateMachineEngine 层：<ul><li>实现状态机引擎每种 state 的行为和路由逻辑；</li><li>提供 API、状态机语言仓库；</li></ul></li></ul><a name="73a9fddd"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="saga-模式下服务设计的实践经验">Saga 模式下服务设计的实践经验<a href="#saga-模式下服务设计的实践经验" class="hash-link" aria-label="Saga 模式下服务设计的实践经验的直接链接" title="Saga 模式下服务设计的实践经验的直接链接">​</a></h3><p>下面是实践中总结的在 Saga 模式下微服务设计的一些经验，当然这是推荐做法，并不是说一定要 100% 遵循，没有遵循也有“绕过”方案。</p><blockquote><p>好消息：Seata Saga 模式对微服务的接口参数没有任务要求，这使得 Saga 模式可用于集成遗留系统或外部机构的服务。</p></blockquote><a name="d64c5051"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="允许空补偿">允许空补偿<a href="#允许空补偿" class="hash-link" aria-label="允许空补偿的直接链接" title="允许空补偿的直接链接">​</a></h4><ul><li>空补偿：原服务未执行，补偿服务执行了；</li><li>出现原因：<ul><li>原服务 超时（丢包）；</li><li>Saga 事务触发 回滚；</li><li>未收到原服务请求，先收到补偿请求；</li></ul></li></ul><p>所以服务设计时需要允许空补偿，即没有找到要补偿的业务主键时返回补偿成功并将原业务主键记录下来。</p><a name="88a92b17"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="防悬挂控制">防悬挂控制<a href="#防悬挂控制" class="hash-link" aria-label="防悬挂控制的直接链接" title="防悬挂控制的直接链接">​</a></h4><ul><li>悬挂：补偿服务 比 原服务 先执行；</li><li>出现原因：<ul><li>原服务 超时（拥堵）；</li><li>Saga 事务回滚，触发 回滚；</li><li>拥堵的原服务到达；</li></ul></li></ul><p>所以要检查当前业务主键是否已经在空补偿记录下来的业务主键中存在，如果存在则要拒绝服务的执行。</p><a name="ce766631"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="幂等控制">幂等控制<a href="#幂等控制" class="hash-link" aria-label="幂等控制的直接链接" title="幂等控制的直接链接">​</a></h4><ul><li>原服务与补偿服务都需要保证幂等性, 由于网络可能超时，可以设置重试策略，重试发生时要通过幂等控制避免业务数据重复更新。</li></ul><a name="FO5YS"></a><h1>总结</h1><p>很多时候我们不需要强调强一性，我们基于 BASE 和 Saga 理论去设计更有弹性的系统，在分布式架构下获得更好的性能和容错能力。分布式架构没有银弹，只有适合特定场景的方案，事实上 Seata Saga 是一个具备“服务编排”和“Saga 分布式事务”能力的产品，总结下来它的适用场景是：</p><ul><li>适用于微服务架构下的“长事务”处理；</li><li>适用于微服务架构下的“服务编排”需求；</li><li>适用于金融核心系统以上的有大量组合服务的业务系统（比如在渠道层、产品层、集成层的系统）；</li><li>适用于业务流程中需要集成遗留系统或外部机构提供的服务的场景（这些服务不可变不能对其提出改造要求）。</li></ul><a name="3X7vO"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="文中涉及相关链接">文中涉及相关链接<a href="#文中涉及相关链接" class="hash-link" aria-label="文中涉及相关链接的直接链接" title="文中涉及相关链接的直接链接">​</a></h2><p>[1][https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf]<!-- -->(<a href="https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf" target="_blank" rel="noopener noreferrer">https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf</a>)<br>[2][http://microservices.io/patterns/data/saga.html]<!-- -->(<a href="http://microservices.io/patterns/data/saga.html" target="_blank" rel="noopener noreferrer">http://microservices.io/patterns/data/saga.html</a>)<br>[3][Microprofile 的 LRA]<!-- -->(<a href="https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA)%EF%BC%9A%5Bhttps://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA%5D(https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA" target="_blank" rel="noopener noreferrer">https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA)：[https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA](https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA</a>)<br>[4][Eventuate Tram Saga]<!-- -->(<a href="https://github.com/eventuate-tram/eventuate-tram-sagas)%EF%BC%9A%5Bhttps://github.com/eventuate-tram/eventuate-tram-sagas%5D(https://github.com/eventuate-tram/eventuate-tram-sagas" target="_blank" rel="noopener noreferrer">https://github.com/eventuate-tram/eventuate-tram-sagas)：[https://github.com/eventuate-tram/eventuate-tram-sagas](https://github.com/eventuate-tram/eventuate-tram-sagas</a>)<br>[5][ServiceComb Saga]<!-- -->(<a href="https://github.com/apache/incubator-servicecomb-saga)%EF%BC%9A%5Bhttps://github.com/apache/servicecomb-pack%5D(https://github.com/apache/servicecomb-pack" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-servicecomb-saga)：[https://github.com/apache/servicecomb-pack](https://github.com/apache/servicecomb-pack</a>)<br>[6][Seata Saga 官网文档]<!-- -->(<a href="http://seata.io/zh-cn/docs/user/saga.html)%EF%BC%9A%5Bhttp://seata.io/zh-cn/docs/user/saga.html%5D(http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">http://seata.io/zh-cn/docs/user/saga.html)：[http://seata.io/zh-cn/docs/user/saga.html](http://seata.io/zh-cn/docs/user/saga.html</a>)<br>[7][AWS Step Functions]<!-- -->(<a href="https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html)%EF%BC%9A%5Bhttps://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html%5D(https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html)：[https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html](https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html</a>)<br>[8][SpringEL]<!-- -->(<a href="https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html)%EF%BC%9A%5Bhttps://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html%5D(https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html" target="_blank" rel="noopener noreferrer">https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html)：[https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html](https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html</a>)<br></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-08-11T00:00:00.000Z" itemprop="datePublished">2019年8月11日</time> · <!-- -->阅读需 26 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">long187</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>作者：屹远（陈龙），蚂蚁金服分布式事务框架核心研发，Seata Committer。</p><br>本文根据 8 月 11 日 SOFA Meetup#3 广州站 《分布式事务 Seata 及其三种模式详解》主题分享整理，着重分享分布式事务产生的背景、理论基础，以及 Seata 分布式事务的原理以及三种模式（AT、TCC、Saga）的分布式事务实现。<p>现场回顾视频以及 PPT 见文末链接。</p><p><img loading="lazy" alt="3 分布式事务 Seata 三种模式详解-屹远.jpg" src="/zh-cn/assets/images/1-59eeb2c64e493e827495e0417125db43.jpeg" width="746" height="420" class="img_ev3q"></p><a name="Ad95d"></a>## 一、分布式事务产生的背景<a name="Q2ayF"></a>### 1.1 分布式架构演进之 - 数据库的水平拆分<p>蚂蚁金服的业务数据库起初是单库单表，但随着业务数据规模的快速发展，数据量越来越大，单库单表逐渐成为瓶颈。所以我们对数据库进行了水平拆分，将原单库单表拆分成数据库分片。</p><p>如下图所示，分库分表之后，原来在一个数据库上就能完成的写操作，可能就会跨多个数据库，这就产生了跨数据库事务问题。</p><p><img loading="lazy" alt="image.png" src="/zh-cn/assets/images/2-e3a8a7b0f1e093d70faf16a548dd6742.png" width="325" height="214" class="img_ev3q"></p><a name="WBQbC"></a>### 1.2 分布式架构演进之 - 业务服务化拆分<p>在业务发展初期，“一块大饼”的单业务系统架构，能满足基本的业务需求。但是随着业务的快速发展，系统的访问量和业务复杂程度都在快速增长，单系统架构逐渐成为业务发展瓶颈，解决业务系统的高耦合、可伸缩问题的需求越来越强烈。</p><p>如下图所示，蚂蚁金服按照面向服务架构（SOA）的设计原则，将单业务系统拆分成多个业务系统，降低了各系统之间的耦合度，使不同的业务系统专注于自身业务，更有利于业务的发展和系统容量的伸缩。</p><p><img loading="lazy" alt="image.png" src="/zh-cn/assets/images/3-548d85e1cdfbab71650a542d5de5d10a.png" width="557" height="277" class="img_ev3q"></p><p>业务系统按照服务拆分之后，一个完整的业务往往需要调用多个服务，如何保证多个服务间的数据一致性成为一个难题。</p><a name="3oIxE"></a>## 二、分布式事务理论基础<a name="akRiW"></a>### 2.1 两阶段提交协议<p><img loading="lazy" alt="16_16_18__08_13_2019.jpg" src="/zh-cn/assets/images/4-5933efe8b07271b941670f74b7322a1f.jpeg" width="746" height="419" class="img_ev3q"></p><p>两阶段提交协议：事务管理器分两个阶段来协调资源管理器，第一阶段准备资源，也就是预留事务所需的资源，如果每个资源管理器都资源预留成功，则进行第二阶段资源提交，否则协调资源管理器回滚资源。</p><a name="8tfKI"></a>### 2.2 TCC<p><img loading="lazy" alt="16_16_51__08_13_2019.jpg" src="/zh-cn/assets/images/5-79c36a571b40ceb0119e48100150675b.jpeg" width="746" height="416" class="img_ev3q"></p><p>TCC（Try-Confirm-Cancel） 实际上是服务化的两阶段提交协议，业务开发者需要实现这三个服务接口，第一阶段服务由业务代码编排来调用 Try 接口进行资源预留，所有参与者的 Try 接口都成功了，事务管理器会提交事务，并调用每个参与者的 Confirm 接口真正提交业务操作，否则调用每个参与者的 Cancel 接口回滚事务。</p><a name="IXxpF"></a>### 2.3 Saga<p><img loading="lazy" alt="3 分布式事务 Seata 三种模式详解-屹远-9.jpg" src="/zh-cn/assets/images/6-9d33493d97af453a8450f0739fa60a0f.jpeg" width="746" height="420" class="img_ev3q"></p><p>Saga 是一种补偿协议，在 Saga 模式下，分布式事务内有多个参与者，每一个参与者都是一个冲正补偿服务，需要用户根据业务场景实现其正向操作和逆向回滚操作。</p><p>分布式事务执行过程中，依次执行各参与者的正向操作，如果所有正向操作均执行成功，那么分布式事务提交。如果任何一个正向操作执行失败，那么分布式事务会退回去执行前面各参与者的逆向回滚操作，回滚已提交的参与者，使分布式事务回到初始状态。</p><p>Saga 理论出自 Hector &amp; Kenneth 1987发表的论文 Sagas。<br></p><br>Saga 正向服务与补偿服务也需要业务开发者实现。<a name="fZPaN"></a>## 三、Seata 及其三种模式详解<a name="IgVM7"></a>### 3.1 分布式事务 Seata 介绍<p>Seata（Simple Extensible Autonomous Transaction Architecture，简单可扩展自治事务框架）是 2019 年 1 月份蚂蚁金服和阿里巴巴共同开源的分布式事务解决方案。Seata 开源半年左右，目前已经有超过 1.1 万 star，社区非常活跃。我们热忱欢迎大家参与到 Seata 社区建设中，一同将 Seata 打造成开源分布式事务标杆产品。</p><p>Seata：<a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">https://</a><a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">github.com/seata/seata</a><br></p><br>![image.png](/img/saga/sofameetup3_img/7.png)<a name="zyy0l"></a>### 3.2 分布式事务 Seata 产品模块<p>如下图所示，Seata 中有三大模块，分别是 TM、RM 和 TC。 其中 TM 和 RM 是作为 Seata 的客户端与业务系统集成在一起，TC 作为 Seata 的服务端独立部署。</p><p><img loading="lazy" alt="image.png" src="/zh-cn/assets/images/8-1e7e5bd472714f2a5eaf932b449942b2.png" width="564" height="301" class="img_ev3q"></p><p>在 Seata 中，分布式事务的执行流程：</p><ul><li>TM 开启分布式事务（TM 向 TC 注册全局事务记录）；</li><li>按业务场景，编排数据库、服务等事务内资源（RM 向 TC 汇报资源准备状态 ）；</li><li>TM 结束分布式事务，事务一阶段结束（TM 通知 TC 提交/回滚分布式事务）；</li><li>TC 汇总事务信息，决定分布式事务是提交还是回滚；</li><li>TC 通知所有 RM 提交/回滚 资源，事务二阶段结束；</li></ul><a name="1QKqI"></a>### 3.3 分布式事务 Seata 解决方案<p>Seata 会有 4 种分布式事务解决方案，分别是 AT 模式、TCC 模式、Saga 模式和 XA 模式。</p><p><img loading="lazy" alt="15_49_23__08_13_2019.jpg" src="/zh-cn/assets/images/9-92fbc62876258a48b6778d72eaab6af6.jpeg" width="746" height="385" class="img_ev3q"><br></p><a name="784n4"></a>#### 2.3.1 AT 模式<p>今年 1 月份，Seata 开源了 AT 模式。AT 模式是一种无侵入的分布式事务解决方案。在 AT 模式下，用户只需关注自己的“业务 SQL”，用户的 “业务 SQL” 作为一阶段，Seata 框架会自动生成事务的二阶段提交和回滚操作。</p><p><img loading="lazy" alt="image.png" src="/zh-cn/assets/images/10-c19d842e385a2e54cc4b838e11642851.png" width="521" height="238" class="img_ev3q"><br></p><a name="Acfeo"></a>##### AT 模式如何做到对业务的无侵入 ：<ul><li>一阶段：</li></ul><p>在一阶段，Seata 会拦截“业务 SQL”，首先解析 SQL 语义，找到“业务 SQL”要更新的业务数据，在业务数据被更新前，将其保存成“before image”，然后执行“业务 SQL”更新业务数据，在业务数据更新之后，再将其保存成“after image”，最后生成行锁。以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性。</p><p><img loading="lazy" alt="图片3.png" src="/zh-cn/assets/images/11-b62ee2dfd6ab6e9094d2b51451b41cdd.png" width="524" height="314" class="img_ev3q"></p><ul><li>二阶段提交：</li></ul><p>二阶段如果是提交的话，因为“业务 SQL”在一阶段已经提交至数据库， 所以 Seata 框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理即可。</p><p><img loading="lazy" alt="图片4.png" src="/zh-cn/assets/images/12-fb7571a44266fa4692599f2907e93125.png" width="480" height="206" class="img_ev3q"></p><ul><li>二阶段回滚：</li></ul><p>二阶段如果是回滚的话，Seata 就需要回滚一阶段已经执行的“业务 SQL”，还原业务数据。回滚方式便是用“before image”还原业务数据；但在还原前要首先要校验脏写，对比“数据库当前业务数据”和 “after image”，如果两份数据完全一致就说明没有脏写，可以还原业务数据，如果不一致就说明有脏写，出现脏写就需要转人工处理。</p><p><img loading="lazy" alt="图片5.png" src="/zh-cn/assets/images/13-67b42e8743563de3117194847e4119de.png" width="463" height="317" class="img_ev3q"></p><p>AT 模式的一阶段、二阶段提交和回滚均由 Seata 框架自动生成，用户只需编写“业务 SQL”，便能轻松接入分布式事务，AT 模式是一种对业务无任何侵入的分布式事务解决方案。</p><a name="FnD1S"></a>#### 2.3.2 TCC 模式<p>2019 年 3 月份，Seata 开源了 TCC 模式，该模式由蚂蚁金服贡献。TCC 模式需要用户根据自己的业务场景实现 Try、Confirm 和 Cancel 三个操作；事务发起方在一阶段执行 Try 方式，在二阶段提交执行 Confirm 方法，二阶段回滚执行 Cancel 方法。</p><p><img loading="lazy" alt="图片6.png" src="/zh-cn/assets/images/14-bd8bfbb4c59f42028ab03a8c409b1c73.png" width="372" height="325" class="img_ev3q"></p><p>TCC 三个方法描述：</p><ul><li>Try：资源的检测和预留；</li><li>Confirm：执行的业务操作提交；要求 Try 成功 Confirm 一定要能成功；</li><li>Cancel：预留资源释放；</li></ul><p><strong>蚂蚁金服在 TCC 的实践经验</strong><br>**<br><img loading="lazy" alt="16_48_02__08_13_2019.jpg" src="/zh-cn/assets/images/15-02cfa1203b468d38c80caa594a7644f7.jpeg" width="746" height="414" class="img_ev3q"></p><p><strong>1 TCC 设计 - 业务模型分 2 阶段设计：</strong></p><p>用户接入 TCC ，最重要的是考虑如何将自己的业务模型拆成两阶段来实现。</p><p>以“扣钱”场景为例，在接入 TCC 前，对 A 账户的扣钱，只需一条更新账户余额的 SQL 便能完成；但是在接入 TCC 之后，用户就需要考虑如何将原来一步就能完成的扣钱操作，拆成两阶段，实现成三个方法，并且保证一阶段 Try  成功的话 二阶段 Confirm 一定能成功。</p><p><img loading="lazy" alt="图片7.png" src="/zh-cn/assets/images/16-e07ff8c531571c0ef2887d9dc8b4c83f.png" width="588" height="265" class="img_ev3q"></p><p>如上图所示，</p><p>Try 方法作为一阶段准备方法，需要做资源的检查和预留。在扣钱场景下，Try 要做的事情是就是检查账户余额是否充足，预留转账资金，预留的方式就是冻结 A 账户的 转账资金。Try 方法执行之后，账号 A 余额虽然还是 100，但是其中 30 元已经被冻结了，不能被其他事务使用。</p><p>二阶段 Confirm 方法执行真正的扣钱操作。Confirm 会使用 Try 阶段冻结的资金，执行账号扣款。Confirm 方法执行之后，账号 A 在一阶段中冻结的 30 元已经被扣除，账号 A 余额变成 70 元 。</p><p>如果二阶段是回滚的话，就需要在 Cancel 方法内释放一阶段 Try 冻结的 30 元，使账号 A 的回到初始状态，100 元全部可用。</p><p>用户接入 TCC 模式，最重要的事情就是考虑如何将业务模型拆成 2 阶段，实现成 TCC 的 3 个方法，并且保证 Try 成功 Confirm 一定能成功。相对于 AT 模式，TCC 模式对业务代码有一定的侵入性，但是 TCC 模式无 AT 模式的全局行锁，TCC 性能会比 AT 模式高很多。</p><p><strong>2 TCC 设计 - 允许空回滚：</strong><br>**<br><img loading="lazy" alt="16_51_44__08_13_2019.jpg" src="/zh-cn/assets/images/17-b2c8866f3bee9d7eacf27c0e02f0ef68.jpeg" width="746" height="414" class="img_ev3q"></p><p>Cancel 接口设计时需要允许空回滚。在 Try 接口因为丢包时没有收到，事务管理器会触发回滚，这时会触发 Cancel 接口，这时 Cancel 执行时发现没有对应的事务 xid 或主键时，需要返回回滚成功。让事务服务管理器认为已回滚，否则会不断重试，而 Cancel 又没有对应的业务数据可以进行回滚。</p><p><strong>3 TCC 设计 - 防悬挂控制：</strong><br>**<br><img loading="lazy" alt="16_51_56__08_13_2019.jpg" src="/zh-cn/assets/images/18-3cfd6186d46d6c1cf79f4b5aea91aea0.jpeg" width="746" height="416" class="img_ev3q"></p><p>悬挂的意思是：Cancel 比 Try 接口先执行，出现的原因是 Try 由于网络拥堵而超时，事务管理器生成回滚，触发 Cancel 接口，而最终又收到了 Try 接口调用，但是 Cancel 比 Try 先到。按照前面允许空回滚的逻辑，回滚会返回成功，事务管理器认为事务已回滚成功，则此时的 Try 接口不应该执行，否则会产生数据不一致，所以我们在 Cancel 空回滚返回成功之前先记录该条事务 xid 或业务主键，标识这条记录已经回滚过，Try 接口先检查这条事务xid或业务主键如果已经标记为回滚成功过，则不执行 Try 的业务操作。</p><p><strong>4 TCC 设计 - 幂等控制：</strong><br>**<br><img loading="lazy" alt="16_52_07__08_13_2019.jpg" src="/zh-cn/assets/images/19-cbc9396d9760ae9eee6ef163c21e8034.jpeg" width="746" height="415" class="img_ev3q"></p><p>幂等性的意思是：对同一个系统，使用同样的条件，一次请求和重复的多次请求对系统资源的影响是一致的。因为网络抖动或拥堵可能会超时，事务管理器会对资源进行重试操作，所以很可能一个业务操作会被重复调用，为了不因为重复调用而多次占用资源，需要对服务设计时进行幂等控制，通常我们可以用事务 xid 或业务主键判重来控制。</p><a name="dsMch"></a>#### 2.3.3 Saga 模式<p>Saga 模式是 Seata 即将开源的长事务解决方案，将由蚂蚁金服主要贡献。在 Saga 模式下，分布式事务内有多个参与者，每一个参与者都是一个冲正补偿服务，需要用户根据业务场景实现其正向操作和逆向回滚操作。</p><p>分布式事务执行过程中，依次执行各参与者的正向操作，如果所有正向操作均执行成功，那么分布式事务提交。如果任何一个正向操作执行失败，那么分布式事务会去退回去执行前面各参与者的逆向回滚操作，回滚已提交的参与者，使分布式事务回到初始状态。</p><p><img loading="lazy" alt="图片8.png" src="/zh-cn/assets/images/20-7a8ab27e616b4987792c11ff82ac900d.png" width="360" height="359" class="img_ev3q"></p><p>Saga 模式下分布式事务通常是由事件驱动的，各个参与者之间是异步执行的，Saga 模式是一种长事务解决方案。</p><p><strong>1 Saga 模式使用场景</strong><br>**<br><img loading="lazy" alt="16_44_58__08_13_2019.jpg" src="/zh-cn/assets/images/21-cb2c15b7cda9ba7e3870b03efb42b0f7.jpeg" width="746" height="416" class="img_ev3q"></p><p>Saga 模式适用于业务流程长且需要保证事务最终一致性的业务系统，Saga 模式一阶段就会提交本地事务，无锁、长流程情况下可以保证性能。</p><p>事务参与者可能是其它公司的服务或者是遗留系统的服务，无法进行改造和提供 TCC 要求的接口，可以使用 Saga 模式。</p><p>Saga模式的优势是：</p><ul><li>一阶段提交本地数据库事务，无锁，高性能；</li><li>参与者可以采用事务驱动异步执行，高吞吐；</li><li>补偿服务即正向服务的“反向”，易于理解，易于实现；</li></ul><p>缺点：Saga 模式由于一阶段已经提交本地数据库事务，且没有进行“预留”动作，所以不能保证隔离性。后续会讲到对于缺乏隔离性的应对措施。<br><strong>2 基于状态机引擎的 Saga 实现</strong></p><p><img loading="lazy" alt="17_13_19__08_13_2019.jpg" src="/zh-cn/assets/images/22-d2bafd9570e63096283bb8cad41a0f43.png" width="1222" height="646" class="img_ev3q"></p><p>目前 Saga 的实现一般有两种，一种是通过事件驱动架构实现，一种是基于注解加拦截器拦截业务的正向服务实现。Seata 目前是采用事件驱动的机制来实现的，Seata 实现了一个状态机，可以编排服务的调用流程及正向服务的补偿服务，生成一个 json 文件定义的状态图，状态机引擎驱动到这个图的运行，当发生异常的时候状态机触发回滚，逐个执行补偿服务。当然在什么情况下触发回滚用户是可以自定义决定的。该状态机可以实现服务编排的需求，它支持单项选择、并发、异步、子状态机调用、参数转换、参数映射、服务执行状态判断、异常捕获等功能。</p><p><strong>3 状态机引擎原理</strong><br></p><p><img loading="lazy" alt="16_45_32__08_13_2019.jpg" src="/zh-cn/assets/images/23-1d09ccedb0eb9f45ddda46963f6a9f12.png" width="1240" height="647" class="img_ev3q"></p><p>该状态机引擎的基本原理是，它基于事件驱动架构，每个步骤都是异步执行的，步骤与步骤之间通过事件队列流转，<br>极大的提高系统吞吐量。每个步骤执行时会记录事务日志，用于出现异常时回滚时使用，事务日志会记录在与业务表所在的数据库内，提高性能。</p><p><strong>4 状态机引擎设计</strong></p><p><img loading="lazy" alt="16_45_46__08_13_2019.jpg" src="/zh-cn/assets/images/24-15fdd730a55833c61ceb860ada0f871b.jpeg" width="746" height="411" class="img_ev3q"></p><p>该状态机引擎分成了三层架构的设计，最底层是“事件驱动”层，实现了 EventBus 和消费事件的线程池，是一个 Pub-Sub 的架构。第二层是“流程控制器”层，它实现了一个极简的流程引擎框架，它驱动一个“空”的流程执行，“空”的意思是指它不关心流程节点做什么事情，它只执行每个节点的 process 方法，然后执行 route 方法流转到下一个节点。这是一个通用框架，基于这两层，开发者可以实现任何流程引擎。最上层是“状态机引擎”层，它实现了每种状态节点的“行为”及“路由”逻辑代码，提供 API 和状态图仓库，同时还有一些其它组件，比如表达式语言、逻辑计算器、流水生成器、拦截器、配置管理、事务日志记录等。</p><p><strong>5 Saga 服务设计经验</strong></p><p>和TCC类似，Saga的正向服务与反向服务也需求遵循以下设计原则：</p><p><strong>1）Saga 服务设计 - 允许空补偿</strong><br>**<br><img loading="lazy" alt="16_52_22__08_13_2019.jpg" src="/zh-cn/assets/images/25-2cae6395619166a3c23e698ac2306f8b.jpeg" width="746" height="415" class="img_ev3q"></p><p><strong>2）Saga 服务设计 - 防悬挂控制</strong><br>**<br><img loading="lazy" alt="16_52_52__08_13_2019.jpg" src="/zh-cn/assets/images/26-ead26d36857d8ae91dbb16ff72873653.jpeg" width="746" height="417" class="img_ev3q"></p><p><strong>3）Saga 服务设计 - 幂等控制</strong><br>**<br><img loading="lazy" alt="3 分布式事务 Seata 三种模式详解-屹远-31.jpg" src="/zh-cn/assets/images/27-11883ffbfbca7e56a3a5984f3e0c3fe6.jpeg" width="746" height="420" class="img_ev3q"></p><p><strong>4）Saga 设计 - 自定义事务恢复策略</strong><br>**<br><img loading="lazy" alt="16_53_07__08_13_2019.jpg" src="/zh-cn/assets/images/28-73c6b9cfb082be166cb84a9381b81c0f.jpeg" width="746" height="414" class="img_ev3q"></p><p>前面讲到 Saga 模式不保证事务的隔离性，在极端情况下可能出现脏写。比如在分布式事务未提交的情况下，前一个服务的数据被修改了，而后面的服务发生了异常需要进行回滚，可能由于前面服务的数据被修改后无法进行补偿操作。这时的一种处理办法可以是“重试”继续往前完成这个分布式事务。由于整个业务流程是由状态机编排的，即使是事后恢复也可以继续往前重试。所以用户可以根据业务特点配置该流程的事务处理策略是优先“回滚”还是“重试”，当事务超时的时候，Server 端会根据这个策略不断进行重试。</p><p>由于 Saga 不保证隔离性，所以我们在业务设计的时候需要做到“宁可长款，不可短款”的原则，长款是指在出现差错的时候站在我方的角度钱多了的情况，钱少了则是短款，因为如果长款可以给客户退款，而短款则可能钱追不回来了，也就是说在业务设计的时候，一定是先扣客户帐再入帐，如果因为隔离性问题造成覆盖更新，也不会出现钱少了的情况。</p><p><strong>6 基于注解和拦截器的 Saga 实现</strong><br>**<br><img loading="lazy" alt="17_13_37__08_13_2019.jpg" src="/zh-cn/assets/images/29-3d3a00510ed54a37763e1558f7343789.jpeg" width="746" height="416" class="img_ev3q"></p><p>还有一种 Saga 的实现是基于注解+拦截器的实现，Seata 目前没有实现，可以看上面的伪代码来理解一下，one 方法上定义了 @SagaCompensable 的注解，用于定义 one 方法的补偿方法是 compensateOne 方法。然后在业务流程代码 processA 方法上定义 @SagaTransactional 注解，启动 Saga 分布式事务，通过拦截器拦截每个正向方法当出现异常的时候触发回滚操作，调用正向方法的补偿方法。</p><p><strong>7 两种 Saga 实现优劣对比</strong></p><p>两种 Saga 的实现各有又缺点，下面表格是一个对比：</p><p><img loading="lazy" alt="17_13_49__08_13_2019.jpg" src="/zh-cn/assets/images/30-990cbb972417453d06119316c2c1bc7e.jpeg" width="746" height="415" class="img_ev3q"></p><p>状态机引擎的最大优势是可以通过事件驱动的方法异步执行提高系统吞吐，可以实现服务编排需求，在 Saga 模式缺乏隔离性的情况下，可以多一种“向前重试”的事情恢复策略。注解加拦截器的的最大优势是，开发简单、学习成本低。</p><a name="Gpkrf"></a>## 总结<p>本文先回顾了分布式事务产生的背景及理论基础，然后重点讲解了 Seata 分布式事务的原理以及三种模式（AT、TCC、Saga）的分布式事务实现。</p><p>Seata 的定位是分布式事全场景解决方案，未来还会有 XA 模式的分布式事务实现，每种模式都有它的适用场景，AT 模式是无侵入的分布式事务解决方案，适用于不希望对业务进行改造的场景，几乎0学习成本。TCC 模式是高性能分布式事务解决方案，适用于核心系统等对性能有很高要求的场景。Saga 模式是长事务解决方案，适用于业务流程长且需要保证事务最终一致性的业务系统，Saga 模式一阶段就会提交本地事务，无锁，长流程情况下可以保证性能，多用于渠道层、集成层业务系统。事务参与者可能是其它公司的服务或者是遗留系统的服务，无法进行改造和提供 TCC 要求的接口，也可以使用 Saga 模式。</p><p>本次分享的视频回顾以及PPT 查看地址：<a href="https://tech.antfin.com/community/activities/779/review" target="_blank" rel="noopener noreferrer">https://tech.antfin.com/community/activities/779/review</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-07-11T00:00:00.000Z" itemprop="datePublished">2019年7月11日</time> · <!-- -->阅读需 15 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>在微服务架构体系下，我们可以按照业务模块分层设计，单独部署，减轻了服务部署压力，也解耦了业务的耦合，避免了应用逐渐变成一个庞然怪物，从而可以轻松扩展，在某些服务出现故障时也不会影响其它服务的正常运行。总之，微服务在业务的高速发展中带给我们越来越多的优势，但是微服务并不是十全十美，因此不能盲目过度滥用，它有很多不足，而且会给系统带来一定的复杂度，其中伴随而来的分布式事务问题，是微服务架构体系下必然需要处理的一个痛点，也是业界一直关注的一个领域，因此也出现了诸如 CAP 和 BASE 等理论。</p><p>在今年年初，阿里开源了一个分布式事务中间件，起初起名为 Fescar，后改名为 Seata，在它开源之初，我就知道它肯定要火，因为这是一个解决痛点的开源项目，Seata 一开始就是冲着对业务无侵入与高性能方向走，这正是我们对解决分布式事务问题迫切的需求。因为待过的几家公司，用的都是微服务架构，但是在解决分布式事务的问题上都不太优雅，所以我也在一直关注 Seata 的发展，今天就简要说说它的一些设计上的原理，后续我将会对它的各个模块进行深入源码分析，感兴趣的可以持续关注我的公众号或者博客，不要跟丢。</p><h1>分布式事务解决的方案有哪些？</h1><p>目前分布式事务解决的方案主要有对业务无入侵和有入侵的方案，无入侵方案主要有基于数据库 XA 协议的两段式提交（2PC）方案，它的优点是对业务代码无入侵，但是它的缺点也是很明显：必须要求数据库对 XA 协议的支持，且由于 XA 协议自身的特点，它会造成事务资源长时间得不到释放，锁定周期长，而且在应用层上面无法干预，因此它性能很差，它的存在相当于七伤拳那样“伤人七分，损己三分”，因此在互联网项目中并不是很流行这种解决方案。</p><p>为了这个弥补这种方案带来性能低的问题，大佬们又想出了很多种方案来解决，但这无一例外都需要通过在应用层做手脚，即入侵业务的方式，比如很出名的 TCC 方案，基于 TCC 也有很多成熟的框架，如 ByteTCC、tcc-transaction 等。以及基于可靠消息的最终一致性来实现，如 RocketMQ 的事务消息。</p><p>入侵代码的方案是基于现有情形“迫不得已”才推出的解决方案，实际上它们实现起来非常不优雅，一个事务的调用通常伴随而来的是对该事务接口增加一系列的反向操作，比如 TCC 三段式提交，提交逻辑必然伴随着回滚的逻辑，这样的代码会使得项目非常臃肿，维护成本高。</p><h1>Seata 各模块之间的关系</h1><p>针对上面所说的分布式事务解决方案的痛点，那很显然，我们理想的分布式事务解决方案肯定是性能要好而且要对业务无入侵，业务层上无需关心分布式事务机制的约束，Seata 正是往这个方向发展的，因此它非常值得期待，它将给我们的微服务架构带来质的提升。</p><p>那 Seata 是怎么做到的呢？下面说说它的各个模块之间的关系。</p><p>Seata 的设计思路是将一个分布式事务可以理解成一个全局事务，下面挂了若干个分支事务，而一个分支事务是一个满足 ACID 的本地事务，因此我们可以操作分布式事务像操作本地事务一样。</p><p>Seata 内部定义了 3个模块来处理全局事务和分支事务的关系和处理过程，这三个组件分别是：</p><ul><li>Transaction Coordinator (TC)： 事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚。</li><li>Transaction Manager (TM)： 控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议。</li><li>Resource Manager (RM)： 控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚。</li></ul><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata.png" class="img_ev3q"></p><p>简要说说整个全局事务的执行步骤：</p><ol><li>TM 向 TC 申请开启一个全局事务，TC 创建全局事务后返回全局唯一的 XID，XID 会在全局事务的上下文中传播；</li><li>RM 向 TC 注册分支事务，该分支事务归属于拥有相同 XID 的全局事务；</li><li>TM 向 TC 发起全局提交或回滚；</li><li>TC 调度 XID 下的分支事务完成提交或者回滚。</li></ol><h1>与 XA 方案有什么不同？</h1><p>Seata 的事务提交方式跟 XA 协议的两段式提交在总体上来说基本是一致的，那它们之间有什么不同呢？</p><p>我们都知道 XA 协议它依赖的是数据库层面来保障事务的一致性，也即是说 XA 的各个分支事务是在数据库层面上驱动的，由于 XA 的各个分支事务需要有 XA 的驱动程序，一方面会导致数据库与 XA 驱动耦合，另一方面它会导致各个分支的事务资源锁定周期长，这也是它没有在互联网公司流行的重要因素。</p><p>基于 XA 协议以上的问题，Seata 另辟蹊径，既然在依赖数据库层会导致这么多问题，那我就从应用层做手脚，这还得从 Seata 的 RM 模块说起，前面也说过 RM 的主要作用了，其实 RM 在内部做了对数据库操作的代理层，如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata5.png" class="img_ev3q"></p><p>Seata 在数据源做了一层代理层，所以我们使用 Seata 时，我们使用的数据源实际上用的是 Seata 自带的数据源代理 DataSourceProxy，Seata 在这层代理中加入了很多逻辑，主要是解析 SQL，把业务数据在更新前后的数据镜像组织成回滚日志，并将 undo log 日志插入 undo_log 表中，保证每条更新数据的业务 sql 都有对应的回滚日志存在。</p><p>这样做的好处就是，本地事务执行完可以立即释放本地事务锁定的资源，然后向 TC 上报分支状态。当 TM 决议全局提交时，就不需要同步协调处理了，TC 会异步调度各个 RM 分支事务删除对应的 undo log 日志即可，这个步骤非常快速地可以完成；当 TM 决议全局回滚时，RM 收到 TC 发送的回滚请求，RM 通过 XID 找到对应的 undo log 回滚日志，然后执行回滚日志完成回滚操作。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata6.png" class="img_ev3q"></p><p>如上图所示，XA 方案的 RM 是放在数据库层的，它依赖了数据库的 XA 驱动程序。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/Seata7.png" class="img_ev3q"></p><p>如上图所示，Seata 的 RM 实际上是已中间件的形式放在应用层，不用依赖数据库对协议的支持，完全剥离了分布式事务方案对数据库在协议支持上的要求。</p><h1>分支事务如何提交和回滚？</h1><p>下面详细说说分支事务是如何提交和回滚的：</p><ul><li>第一阶段：</li></ul><p>分支事务利用 RM 模块中对 JDBC 数据源代理，加入了若干流程，对业务 SQL 进行解释，把业务数据在更新前后的数据镜像组织成回滚日志，并生成 undo log 日志，对全局事务锁的检查以及分支事务的注册等，利用本地事务 ACID 特性，将业务 SQL 和 undo log 写入同一个事物中一同提交到数据库中，保证业务 SQL 必定存在相应的回滚日志，最后对分支事务状态向 TC 进行上报。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata2.png" class="img_ev3q"></p><ul><li>第二阶段：</li></ul><p>TM决议全局提交：</p><p>当 TM 决议提交时，就不需要同步协调处理了，TC 会异步调度各个 RM 分支事务删除对应的 undo log 日志即可，这个步骤非常快速地可以完成。这个机制对于性能提升非常关键，我们知道正常的业务运行过程中，事务执行的成功率是非常高的，因此可以直接在本地事务中提交，这步对于提升性能非常显著。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata3.png" class="img_ev3q"></p><p>TM决议全局回滚：</p><p>当 TM 决议回滚时，RM 收到 TC 发送的回滚请求，RM 通过 XID 找到对应的 undo log 回滚日志，然后利用本地事务 ACID 特性，执行回滚日志完成回滚操作并删除 undo log 日志，最后向 TC 进行回滚结果上报。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata4.png" class="img_ev3q"></p><p>业务对以上所有的流程都无感知，业务完全不关心全局事务的具体提交和回滚，而且最重要的一点是 Seata 将两段式提交的同步协调分解到各个分支事务中了，分支事务与普通的本地事务无任何差异，这意味着我们使用 Seata 后，分布式事务就像使用本地事务一样，完全将数据库层的事务协调机制交给了中间件层 Seata 去做了，这样虽然事务协调搬到应用层了，但是依然可以做到对业务的零侵入，从而剥离了分布式事务方案对数据库在协议支持上的要求，且 Seata 在分支事务完成之后直接释放资源，极大减少了分支事务对资源的锁定时间，完美避免了 XA 协议需要同步协调导致资源锁定时间过长的问题。</p><h1>其它方案的补充</h1><p>上面说的其实是 Seata 的默认模式，也叫 AT 模式，它是类似于 XA 方案的两段式提交方案，并且是对业务无侵入，但是这种机制依然是需要依赖数据库本地事务的 ACID 特性，有没有发现，我在上面的图中都强调了必须是支持 ACID 特性的关系型数据库，那么问题就来了，非关系型或者不支持 ACID 的数据库就无法使用 Seata 了，别慌，Seata 现阶段为我们准备了另外一种模式，叫 MT 模式，它是一种对业务有入侵的方案，提交回滚等操作需要我们自行定义，业务逻辑需要被分解为 Prepare/Commit/Rollback 3 部分，形成一个 MT 分支，加入全局事务，它存在的意义是为 Seata 触达更多的场景。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata8.png" class="img_ev3q"></p><p>只不过，它不是 Seata “主打”的模式，它的存在仅仅作为补充的方案，从以上官方的发展远景就可以看出来，Seata 的目标是始终是对业务无入侵的方案。</p><p><em>注：本文图片设计参考Seata官方图</em></p><h1>作者简介：</h1><p>张乘辉，目前就职于中通科技信息中心技术平台部，担任 Java 工程师，主要负责中通消息平台与全链路压测项目的研发，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Contributor，GitHub ID：objcoding。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-04-23T00:00:00.000Z" itemprop="datePublished">2019年4月23日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">fagongzi(zhangxu19830126@gmail.com)</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h3><p>TaaS 是 Seata 服务端（TC, Transaction Coordinator）的一种高可用实现，使用 <code>Golang</code> 编写。Taas 由InfiniVision (<a href="http://infinivision.cn" target="_blank" rel="noopener noreferrer">http://infinivision.cn</a>) 贡献给Seata开源社区。现已正式开源，并贡献给 Seata 社区。</p><p>在Seata开源之前，我们内部开始借鉴GTS以及一些开源项目来实现分布式事务的解决方案TaaS(Transaction as a Service)。</p><p>在我们完成TaaS的服务端的开发工作后，Seata（当时还叫Fescar）开源了，并且引起了开源社区的广泛关注，加上阿里巴巴的平台影响力以及社区活跃度，我们认为Seata会成为今后开源分布式事务的标准，我们决定TaaS兼容Seata。</p><p>在发现Seata的服务端的实现是单机的，高可用等并没有实现，于是我们与Seata社区负责人取得联系，并且决定把TaaS开源，回馈开源社区。 同时，我们会长期维护，并且和Seata版本保持同步。</p><p>目前，Seata官方的Java高可用版本也在开发中，TaaS和该高可用版本的设计思想不同，在今后会长期共存。</p><p>TaaS已经开源， github (<a href="https://github.com/seata/seata-go-server)%EF%BC%8C%E6%AC%A2%E8%BF%8E%E5%A4%A7%E5%AE%B6%E8%AF%95%E7%94%A8%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-go-server)，欢迎大家试用。</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="设计原则">设计原则<a href="#设计原则" class="hash-link" aria-label="设计原则的直接链接" title="设计原则的直接链接">​</a></h3><ol><li>高性能，性能和机器数量成正比，即通过加入新机器到集群中，就可以提升性能</li><li>高可用，一台机器出现故障，系统能依旧可以对外提供服务，或者在较短的时间内恢复对外服务（Leader切换的时间）</li><li>Auto-Rebalance，集群中增加新的机器，或者有机器下线，系统能够自动的做负载均衡</li><li>强一致，系统的元数据强一致在多个副本中存储</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="设计">设计<a href="#设计" class="hash-link" aria-label="设计的直接链接" title="设计的直接链接">​</a></h3><p><img loading="lazy" src="/zh-cn/assets/images/taas-7be6d3d8b28495c0c4e06791b334836a.png" width="828" height="1003" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="高性能">高性能<a href="#高性能" class="hash-link" aria-label="高性能的直接链接" title="高性能的直接链接">​</a></h4><p>TaaS的性能和机器数量成正比，为了支持这个特性，在TaaS中处理全局事务的最小单元称为<code>Fragment</code>，系统在启动的时候会设定每个Fragment支持的活跃全局事务的并发数，同时系统会对每个Fragment进行采样，一旦发现Fragment超负荷，会生成新的Fragment来处理更多的并发。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="高可用">高可用<a href="#高可用" class="hash-link" aria-label="高可用的直接链接" title="高可用的直接链接">​</a></h4><p>每个<code>Fragment</code>有多个副本和一个Leader，由Leader来处理请求。当Leader出现故障，系统会产生一个新的Leader来处理请求，在新Leader的选举过程中，这个Fragment对外不提供服务，通常这个间隔时间是几秒钟。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="强一致">强一致<a href="#强一致" class="hash-link" aria-label="强一致的直接链接" title="强一致的直接链接">​</a></h4><p>TaaS本身不存储全局事务的元数据，元数据存储在Elasticell   (<a href="https://github.com/deepfabric/elasticell" target="_blank" rel="noopener noreferrer">https://github.com/deepfabric/elasticell</a>) 中，Elasticell是一个兼容redis协议的分布式的KV存储，它基于Raft协议来保证数据的一致性。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="auto-rebalance">Auto-Rebalance<a href="#auto-rebalance" class="hash-link" aria-label="Auto-Rebalance的直接链接" title="Auto-Rebalance的直接链接">​</a></h4><p>随着系统的运行，在系统中会存在许多<code>Fragment</code>以及它们的副本，这样会导致在每个机器上，<code>Fragment</code>的分布不均匀，特别是当旧的机器下线或者新的机器上线的时候。TaaS在启动的时候，会选择3个节点作为调度器的角色，调度器负责调度这些<code>Fragment</code>，用来保证每个机器上的Fragment的数量以及Leader个数大致相等，同时还会保证每个Fragment的副本数维持在指定的副本个数。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="fragment副本创建">Fragment副本创建<a href="#fragment副本创建" class="hash-link" aria-label="Fragment副本创建的直接链接" title="Fragment副本创建的直接链接">​</a></h5><p><img loading="lazy" src="/zh-cn/assets/images/taas_add-6451cc0e5ab23c96d9d4db5e3c6cb510.png" width="885" height="596" class="img_ev3q"></p><ol><li>t0时间点，Fragment1在Seata-TC1机器上创建</li><li>t1时间点，Fragment1的副本Fragment1&#x27;在Seata-TC2机器上创建</li><li>t2时间点，Fragment1的副本Fragment1&quot;在Seata-TC3机器上创建</li></ol><p>在t2时间点，Fragment1的三个副本创建完毕。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="fragment副本迁移">Fragment副本迁移<a href="#fragment副本迁移" class="hash-link" aria-label="Fragment副本迁移的直接链接" title="Fragment副本迁移的直接链接">​</a></h5><p><img loading="lazy" src="/zh-cn/assets/images/taas_move-a147fafaaf5a403fe3b493756aeefdea.png" width="1081" height="1121" class="img_ev3q"></p><ol><li>t0时刻点，系统一个存在4个Fragment，分别存在于Seata-TC1，Seata-TC2，Seata-TC3三台机器上</li><li>t1时刻，加入新机器Seata-TC4</li><li>t2时刻，有3个Fragment的副本被迁移到了Seata-TC4这台机器上</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="在线快速体验">在线快速体验<a href="#在线快速体验" class="hash-link" aria-label="在线快速体验的直接链接" title="在线快速体验的直接链接">​</a></h3><p>我们在公网搭建了一个体验的环境：</p><ul><li>Seata服务端地址： 39.97.115.141:8091</li><li>UI： <a href="http://39.97.115.141:8084/ui/index.html" target="_blank" rel="noopener noreferrer">http://39.97.115.141:8084/ui/index.html</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="本地快速体验">本地快速体验<a href="#本地快速体验" class="hash-link" aria-label="本地快速体验的直接链接" title="本地快速体验的直接链接">​</a></h3><p>使用docker-compose快速体验TaaS的功能。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/seata/taas.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compse up -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于组件依赖较多，docker-compose启动30秒后，可以对外服务</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata服务地址">Seata服务地址<a href="#seata服务地址" class="hash-link" aria-label="Seata服务地址的直接链接" title="Seata服务地址的直接链接">​</a></h4><p>服务默认监听在8091端口，修改Seata对应的服务端地址体验</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-ui">Seata UI<a href="#seata-ui" class="hash-link" aria-label="Seata UI的直接链接" title="Seata UI的直接链接">​</a></h4><p>访问WEB UI <code>http://127.0.0.1:8084/ui/index.html</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="关于infinivision">关于InfiniVision<a href="#关于infinivision" class="hash-link" aria-label="关于InfiniVision的直接链接" title="关于InfiniVision的直接链接">​</a></h3><p>深见网络是一家技术驱动的企业级服务提供商，致力于利用人工智能、云计算、区块链、大数据，以及物联网边缘计算技术助力传统企业的数字化转型和升级。深见网络积极拥抱开源文化并将核心算法和架构开源，知名人脸识别软件 InsightFace (<a href="https://github.com/deepinsight/insightface" target="_blank" rel="noopener noreferrer">https://github.com/deepinsight/insightface</a>) (曾多次获得大规模人脸识别挑战冠军)，以及分布式存储引擎 Elasticell (<a href="https://github.com/deepfabric/elasticell" target="_blank" rel="noopener noreferrer">https://github.com/deepfabric/elasticell</a>) 等均是深见网络的开源产品。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="关于作者">关于作者<a href="#关于作者" class="hash-link" aria-label="关于作者的直接链接" title="关于作者的直接链接">​</a></h3><p>作者张旭，开源网关Gateway (<a href="https://github.com/fagongzi/gateway" target="_blank" rel="noopener noreferrer">https://github.com/fagongzi/gateway</a>) 作者，目前就职于InfiniVision，负责基础架构相关的研发工作。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-04-15T00:00:00.000Z" itemprop="datePublished">2019年4月15日</time> · <!-- -->阅读需 21 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">郭树抗 季敏</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-简介">Fescar 简介<a href="#fescar-简介" class="hash-link" aria-label="Fescar 简介的直接链接" title="Fescar 简介的直接链接">​</a></h3><p>常见的分布式事务方式有基于 2PC 的 XA (e.g. atomikos)，从业务层入手的 TCC( e.g. byteTCC)、事务消息 ( e.g. RocketMQ Half Message) 等等。XA 是需要本地数据库支持的分布式事务的协议，资源锁在数据库层面导致性能较差，而支付宝作为布道师引入的 TCC 模式需要大量的业务代码保证，开发维护成本较高。</p><p>分布式事务是业界比较关注的领域，这也是短短时间 Fescar 能收获6k Star的原因之一。Fescar 名字取自 <strong>Fast &amp; Easy Commit And Rollback</strong> ，简单来说 Fescar 通过对本地 RDBMS 分支事务的协调来驱动完成全局事务，是工作在应用层的中间件。主要优点是相对于XA模式是性能较好不长时间占用连接资源，相对于 TCC 方式开发成本和业务侵入性较低。</p><p>类似于 XA，Fescar 将角色分为 TC、RM、TM，事务整体过程模型如下：</p><p><img loading="lazy" alt="Fescar事务过程" src="/zh-cn/assets/images/fescar-microservices-88885eb3928c478894342041e066a5ce.png" width="794" height="478" class="img_ev3q"></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的 XID。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. XID 在微服务调用链路的上下文中传播。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. TM 向 TC 发起针对 XID 的全局提交或回滚决议。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中在目前的实现版本中 TC 是独立部署的进程，维护全局事务的操作记录和全局锁记录，负责协调并驱动全局事务的提交或回滚。TM RM 则与应用程序工作在同一应用进程。RM 对 JDBC 数据源采用代理的方式对底层数据库做管理，利用语法解析，在执行事务时保留快照，并生成 undo log。大概的流程和模型划分就介绍到这里，下面开始对 Fescar 事务传播机制的分析。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-事务传播机制">Fescar 事务传播机制<a href="#fescar-事务传播机制" class="hash-link" aria-label="Fescar 事务传播机制的直接链接" title="Fescar 事务传播机制的直接链接">​</a></h3><p>Fescar 事务传播包括应用内事务嵌套调用和跨服务调用的事务传播。Fescar 事务是怎么在微服务调用链中传播的呢？Fescar 提供了事务 API 允许用户手动绑定事务的 XID 并加入到全局事务中，所以我们根据不同的服务框架机制，将 XID 在链路中传递即可实现事务的传播。</p><p>RPC 请求过程分为调用方与被调用方两部分，我们需要对 XID 在请求与响应时做相应的处理。大致过程为：调用方即请求方将当前事务上下文中的 XID 取出，通过RPC协议传递给被调用方；被调用方从请求中的将 XID 取出，并绑定到自己的事务上下文中，纳入全局事务。微服务框架一般都有相应的 Filter 和 Interceptor 机制，我们来具体分析下 Spring Cloud 与Fescar 的整合过程。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-与-spring-cloud-alibaba-集成部分源码解析">Fescar 与 Spring Cloud Alibaba 集成部分源码解析<a href="#fescar-与-spring-cloud-alibaba-集成部分源码解析" class="hash-link" aria-label="Fescar 与 Spring Cloud Alibaba 集成部分源码解析的直接链接" title="Fescar 与 Spring Cloud Alibaba 集成部分源码解析的直接链接">​</a></h3><p>本部分源码全部来自于 spring-cloud-alibaba-fescar. 源码解析部分主要包括 AutoConfiguration、微服务被调用方和微服务调用方三大部分。对于微服务调用方方式具体分为 RestTemplate 和 Feign，其中对于 Feign 请求方式又进一步细分为结合 Hystrix 和 Sentinel 的使用模式。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-autoconfiguration">Fescar AutoConfiguration<a href="#fescar-autoconfiguration" class="hash-link" aria-label="Fescar AutoConfiguration的直接链接" title="Fescar AutoConfiguration的直接链接">​</a></h4><p>对于 AutoConfiguration 的解析此处只介绍与 Fescar 启动相关的部分，其他部分的解析将穿插于【微服务被调用方】和 【微服务调用方】章节进行介绍。</p><p>Fescar 的启动需要配置 GlobalTransactionScanner，GlobalTransactionScanner 负责初始化 Fescar 的 RM client、TM  client 和 自动代理标注 GlobalTransactional 注解的类。GlobalTransactionScanner bean 的启动通过 GlobalTransactionAutoConfiguration 加载并注入FescarProperties。<br>
<!-- -->FescarProperties 包含了 Fescar 的重要属性 txServiceGroup ，此属性的可通过 application.properties 文件中的 key: spring.cloud.alibaba.fescar.txServiceGroup 读取，默认值为 ${spring.application.name}-fescar-service-group 。txServiceGroup 表示 Fescar 的逻辑事务分组名，此分组名通过配置中心（目前支持文件、Apollo）获取逻辑事务分组名对应的 TC 集群名称，进一步通过集群名称构造出 TC 集群的服务名，通过注册中心（目前支持nacos、redis、zk和eureka）和服务名找到可用的 TC 服务节点，然后 RM client、TM  client 与 TC 进行 rpc 交互。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="微服务被调用方">微服务被调用方<a href="#微服务被调用方" class="hash-link" aria-label="微服务被调用方的直接链接" title="微服务被调用方的直接链接">​</a></h4><p>由于调用方的逻辑比较多一点，我们先分析被调用方的逻辑。针对于 Spring Cloud 项目，默认采用的 RPC 传输协议是 HTTP 协议，所以使用了 HandlerInterceptor 机制来对HTTP的请求做拦截。</p><p>HandlerInterceptor 是 Spring 提供的接口， 它有以下三个方法可以被覆写。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Intercept the execution of a handler. Called after HandlerMapping determined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * an appropriate handler object, but before HandlerAdapter invokes the handler.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Intercept the execution of a handler. Called after HandlerAdapter actually</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * invoked the handler, but before the DispatcherServlet renders the view.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Can expose additional model objects to the view via the given ModelAndView.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Nullable ModelAndView modelAndView) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Callback after completion of request processing, that is, after rendering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * the view. Will be called on any outcome of handler execution, thus allows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * for proper resource cleanup.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Nullable Exception ex) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根据注释，我们可以很明确的看到各个方法的作用时间和常用用途。对于 Fescar 集成来讲，它根据需要重写了 preHandle、afterCompletion 方法。</p><p>FescarHandlerInterceptor 的作用是将服务链路传递过来的 XID，绑定到服务节点的事务上下文中，并且在请求完成后清理相关资源。FescarHandlerInterceptorConfiguration 中配置了所有的 url 均进行拦截，对所有的请求过来均会执行该拦截器，进行 XID 的转换与事务绑定。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author xiaojing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Fescar HandlerInterceptor, Convert Fescar information into</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @see com.alibaba.fescar.core.context.RootContext from http request&#x27;s header in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link org.springframework.web.servlet.HandlerInterceptor#preHandle(HttpServletRequest , HttpServletResponse , Object )},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * And clean up Fescar information after servlet method invocation in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link org.springframework.web.servlet.HandlerInterceptor#afterCompletion(HttpServletRequest, HttpServletResponse, Object, Exception)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHandlerInterceptor implements HandlerInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger log = LoggerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .getLogger(FescarHandlerInterceptor.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object handler) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = request.getHeader(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;xid in RootContext {} xid in RpcContext {}&quot;, xid, rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid == null &amp;&amp; rpcXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RootContext.bind(rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.debug(&quot;bind {} to RootContext&quot;, rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void afterCompletion(HttpServletRequest request, HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object handler, Exception e) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = request.getHeader(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(rpcXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String unbindXid = RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;unbind {} from RootContext&quot;, unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!rpcXid.equalsIgnoreCase(unbindXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.warn(&quot;xid in change during RPC from {} to {}&quot;, rpcXid, unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (unbindXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn(&quot;bind {} back to RootContext&quot;, unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>preHandle 在请求执行前被调用，xid 为当前事务上下文已经绑定的全局事务的唯一标识，rpcXid 为请求通过 HTTP Header 传递过来需要绑定的全局事务标识。preHandle 方法中判断如果当前事务上下文中没有 XID，且 rpcXid 不为空，那么就将 rpcXid 绑定到当前的事务上下文。</p><p>afterCompletion 在请求完成后被调用，该方法用来执行资源的相关清理动作。Fescar 通过 RootContext.unbind() 方法对事务上下文涉及到的 XID 进行解绑。下面 if 中的逻辑是为了代码的健壮性考虑，如果遇到 rpcXid和 unbindXid 不相等的情况，再将 unbindXid 重新绑定回去。</p><p>对于 Spring Cloud 来讲，默认采用的 RPC 方式是 HTTP 的方式，所以对被调用方来讲，它的请求拦截方式不用做任何区分，只需要从 Header 中将 XID 就可以取出绑定到自己的事务上下文中即可。但是对于调用方由于请求组件的多样化，包括熔断隔离机制，所以要区分不同的情况做处理，后面我们来具体分析一下。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="微服务调用方">微服务调用方<a href="#微服务调用方" class="hash-link" aria-label="微服务调用方的直接链接" title="微服务调用方的直接链接">​</a></h4><p>Fescar 将请求方式分为：RestTemplate、Feign、Feign+Hystrix 和 Feign+Sentinel 。不同的组件通过 Spring Boot 的 Auto Configuration 来完成自动的配置，具体的配置类清单可以看 spring.factories ，下文也会介绍相关的配置类。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="resttemplate">RestTemplate<a href="#resttemplate" class="hash-link" aria-label="RestTemplate的直接链接" title="RestTemplate的直接链接">​</a></h5><p>先来看下如果调用方如果是是基于 RestTemplate 的请求，Fescar 是怎么传递 XID 的。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarRestTemplateInterceptor implements ClientHttpRequestInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ClientHttpResponse intercept(HttpRequest httpRequest, byte[] bytes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClientHttpRequestExecution clientHttpRequestExecution) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpRequestWrapper requestWrapper = new HttpRequestWrapper(httpRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.isEmpty(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requestWrapper.getHeaders().add(RootContext.KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return clientHttpRequestExecution.execute(requestWrapper, bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FescarRestTemplateInterceptor 实现了 ClientHttpRequestInterceptor 接口的 intercept 方法，对调用的请求做了包装，在发送请求时若存在 Fescar 事务上下文 XID 则取出并放到 HTTP Header 中。</p><p>FescarRestTemplateInterceptor 通过 FescarRestTemplateAutoConfiguration 实现将 FescarRestTemplateInterceptor 配置到 RestTemplate 中去。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarRestTemplateAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FescarRestTemplateInterceptor fescarRestTemplateInterceptor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarRestTemplateInterceptor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired(required = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Collection&lt;RestTemplate&gt; restTemplates;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private FescarRestTemplateInterceptor fescarRestTemplateInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostConstruct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.restTemplates != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (RestTemplate restTemplate : restTemplates) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;ClientHttpRequestInterceptor&gt; interceptors = new ArrayList&lt;ClientHttpRequestInterceptor&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        restTemplate.getInterceptors());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                interceptors.add(this.fescarRestTemplateInterceptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                restTemplate.setInterceptors(interceptors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>init 方法遍历所有的 restTemplate ，并将原来 restTemplate 中的拦截器取出，增加 fescarRestTemplateInterceptor 后置入并重排序。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="feign">Feign<a href="#feign" class="hash-link" aria-label="Feign的直接链接" title="Feign的直接链接">​</a></h5><p><img loading="lazy" alt="Feign 类关系图" src="/zh-cn/assets/images/20190305184812-46ab74f3830c4789b6f410150de067d6.png" width="1986" height="788" class="img_ev3q"></p><p>接下来看下 Feign 的相关代码，该包下面的类还是比较多的，我们先从其 AutoConfiguration 入手。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(Client.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AutoConfigureBefore(FeignAutoConfiguration.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarFeignClientAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope(&quot;prototype&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnClass(name = &quot;com.netflix.hystrix.HystrixCommand&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;feign.hystrix.enabled&quot;, havingValue = &quot;true&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignHystrixBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarHystrixFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope(&quot;prototype&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnClass(name = &quot;com.alibaba.csp.sentinel.SphU&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;feign.sentinel.enabled&quot;, havingValue = &quot;true&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignSentinelBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarSentinelFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope(&quot;prototype&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static class FeignBeanPostProcessorConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarBeanPostProcessor fescarBeanPostProcessor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                FescarFeignObjectWrapper fescarFeignObjectWrapper) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarBeanPostProcessor(fescarFeignObjectWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarContextBeanPostProcessor fescarContextBeanPostProcessor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarContextBeanPostProcessor(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarFeignObjectWrapper fescarFeignObjectWrapper(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignObjectWrapper(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FescarFeignClientAutoConfiguration 在存在 Client.class 时生效，且要求作用在 FeignAutoConfiguration 之前。由于FeignClientsConfiguration 是在 FeignAutoConfiguration 生成 FeignContext 生效的，所以根据依赖关系， FescarFeignClientAutoConfiguration 同样早于 FeignClientsConfiguration。</p><p>FescarFeignClientAutoConfiguration 自定义了 Feign.Builder，针对于 feign.sentinel，feign.hystrix  和 feign 的情况做了适配，目的是自定义 feign 中 Client 的真正实现为 FescarFeignClient。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HystrixFeign.builder().retryer(Retryer.NEVER_RETRY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .client(new FescarFeignClient(beanFactory))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SentinelFeign.builder().retryer(Retryer.NEVER_RETRY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .client(new FescarFeignClient(beanFactory));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Feign.builder().client(new FescarFeignClient(beanFactory));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FescarFeignClient 是对原来的 Feign 客户端代理增强，具体代码见下图：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarFeignClient implements Client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Client delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BeanFactory beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarFeignClient(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = new Client.Default(null, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarFeignClient(BeanFactory beanFactory, Client delegate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Response execute(Request request, Request.Options options) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Request modifiedRequest = getModifyRequest(request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.delegate.execute(modifiedRequest, options);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Request getModifyRequest(Request request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, Collection&lt;String&gt;&gt; headers = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.putAll(request.headers());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; fescarXid = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fescarXid.add(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.put(RootContext.KEY_XID, fescarXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Request.create(request.method(), request.url(), headers, request.body(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                request.charset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的过程中我们可以看到，FescarFeignClient 对原来的 Request 做了修改，它首先将 XID 从当前的事务上下文中取出，在 XID 不为空的情况下，将 XID 放到了 Header 中。</p><p>FeignBeanPostProcessorConfiguration 定义了3个 bean：FescarContextBeanPostProcessor、FescarBeanPostProcessor 和 FescarFeignObjectWrapper。其中 FescarContextBeanPostProcessor FescarBeanPostProcessor 实现了Spring  BeanPostProcessor 接口。
以下为 FescarContextBeanPostProcessor 实现。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessBeforeInitialization(Object bean, String beanName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bean instanceof FeignContext &amp;&amp; !(bean instanceof FescarFeignContext)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignContext(getFescarFeignObjectWrapper(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    (FeignContext) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(Object bean, String beanName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>BeanPostProcessor 中的两个方法可以对 Spring 容器中的 Bean 做前后处理，postProcessBeforeInitialization 处理时机是初始化之前，postProcessAfterInitialization 的处理时机是初始化之后，这2个方法的返回值可以是原先生成的实例 bean，或者使用 wrapper 包装后的实例。</p><p>FescarContextBeanPostProcessor  将 FeignContext 包装成 FescarFeignContext。<br>
<!-- -->FescarBeanPostProcessor  将 FeignClient 根据是否继承了 LoadBalancerFeignClient 包装成 FescarLoadBalancerFeignClient 和 FescarFeignClient。</p><p>FeignAutoConfiguration 中的 FeignContext 并没有加 ConditionalOnXXX 的条件，所以 Fescar 采用预置处理的方式将 FeignContext 包装成 FescarFeignContext。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FeignContext feignContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FeignContext context = new FeignContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setConfigurations(this.configurations);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而对于 Feign Client，FeignClientFactoryBean 中会获取 FeignContext 的实例对象。对于开发者采用 @Configuration 注解的自定义配置的 Feign Client 对象，这里会被配置到 builder，导致 FescarFeignBuilder 中增强后的 FescarFeignCliet 失效。FeignClientFactoryBean 中关键代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt; the target type of the Feign client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return a {@link Feign} client created with the specified data and the context information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getTarget() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FeignContext context = applicationContext.getBean(FeignContext.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Feign.Builder builder = feign(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.hasText(this.url)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!this.name.startsWith(&quot;http&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                url = &quot;http://&quot; + this.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                url = this.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            url += cleanPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (T) loadBalance(builder, context, new HardCodedTarget&lt;&gt;(this.type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.name, url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.hasText(this.url) &amp;&amp; !this.url.startsWith(&quot;http&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.url = &quot;http://&quot; + this.url;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = this.url + cleanPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Client client = getOptional(context, Client.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (client != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (client instanceof LoadBalancerFeignClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // not load balancing because we have a url,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // but ribbon is on the classpath, so unwrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                client = ((LoadBalancerFeignClient)client).getDelegate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder.client(client);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Targeter targeter = get(context, Targeter.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (T) targeter.target(this, builder, context, new HardCodedTarget&lt;&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.type, this.name, url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述代码根据是否指定了注解参数中的 URL 来选择直接调用 URL 还是走负载均衡，targeter.target 通过动态代理创建对象。大致过程为：将解析出的feign方法放入map
，再通过将其作为参数传入生成InvocationHandler，进而生成动态代理对象。<br>
<!-- -->FescarContextBeanPostProcessor 的存在，即使开发者对 FeignClient 自定义操作，依旧可以完成 Fescar 所需的全局事务的增强。</p><p>对于 FescarFeignObjectWrapper，我们重点关注下Wrapper方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Object wrap(Object bean) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bean instanceof Client &amp;&amp; !(bean instanceof FescarFeignClient)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (bean instanceof LoadBalancerFeignClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LoadBalancerFeignClient client = ((LoadBalancerFeignClient) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new FescarLoadBalancerFeignClient(client.getDelegate(), factory(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        clientFactory(), this.beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignClient(this.beanFactory, (Client) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>wrap 方法中，如果 bean 是 LoadBalancerFeignClient 的实例对象，那么首先通过 client.getDelegate() 方法将 LoadBalancerFeignClient 代理的实际 Client 对象取出后包装成 FescarFeignClient，再生成 LoadBalancerFeignClient 的子类 FescarLoadBalancerFeignClient 对象。如果 bean 是 Client 的实例对象且不是 FescarFeignClient LoadBalancerFeignClient，那么 bean 会直接包装生成 FescarFeignClient。</p><p>上面的流程设计还是比较巧妙的，首先根据 Spring boot 的 Auto Configuration 控制了配置的先后顺序，同时自定义了 Feign Builder 的Bean，保证了 Client 均是经过增强后的 FescarFeignClient 。再通过 BeanPostProcessor 对Spring 容器中的 Bean 做了一遍包装，保证容器内的Bean均是增强后 FescarFeignClient ，避免 FeignClientFactoryBean getTarget 方法的替换动作。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="hystrix-隔离">Hystrix 隔离<a href="#hystrix-隔离" class="hash-link" aria-label="Hystrix 隔离的直接链接" title="Hystrix 隔离的直接链接">​</a></h5><p>下面我们再来看下 Hystrix 部分，为什么要单独把 Hystrix 拆出来看呢，而且 Fescar 代码也单独实现了个策略类。目前事务上下文 RootContext 的默认实现是基于 ThreadLocal 方式的 ThreadLocalContextCore，也就是上下文其实是和线程绑定的。Hystrix 本身有两种隔离状态的模式，基于信号量或者基于线程池进行隔离。Hystrix 官方建议是采取线程池的方式来充分隔离，也是一般情况下在采用的模式： </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Thread or Semaphore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The default, and the recommended setting, is to run HystrixCommands using thread isolation (THREAD) and HystrixObservableCommands using semaphore isolation (SEMAPHORE).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Commands executed in threads have an extra layer of protection against latencies beyond what network timeouts can offer.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Generally the only time you should use semaphore isolation for HystrixCommands is when the call is so high volume (hundreds per second, per instance) that the overhead of separate threads is too high; this typically only applies to non-network calls.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>service 层的业务代码和请求发出的线程肯定不是同一个，那么 ThreadLocal 的方式就没办法将 XID 传递给 Hystrix 的线程并传递给被调用方的。怎么处理这件事情呢，Hystrix 提供了机制让开发者去自定义并发策略，只需要继承 HystrixConcurrencyStrategy 重写 wrapCallable 方法即可。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHystrixConcurrencyStrategy extends HystrixConcurrencyStrategy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private HystrixConcurrencyStrategy delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FescarHystrixConcurrencyStrategy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = HystrixPlugins.getInstance().getConcurrencyStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HystrixPlugins.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HystrixPlugins.getInstance().registerConcurrencyStrategy(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;K&gt; Callable&lt;K&gt; wrapCallable(Callable&lt;K&gt; c) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (c instanceof FescarContextCallable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Callable&lt;K&gt; wrappedCallable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.delegate != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wrappedCallable = this.delegate.wrapCallable(c);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wrappedCallable = c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (wrappedCallable instanceof FescarContextCallable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return wrappedCallable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarContextCallable&lt;&gt;(wrappedCallable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class FescarContextCallable&lt;K&gt; implements Callable&lt;K&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final Callable&lt;K&gt; actual;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final String xid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarContextCallable(Callable&lt;K&gt; actual) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.actual = actual;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public K call() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return actual.call();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fescar 也提供一个 FescarHystrixAutoConfiguration，在存在 HystrixCommand 的时候生成FescarHystrixConcurrencyStrategy</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(HystrixCommand.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHystrixAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarHystrixConcurrencyStrategy fescarHystrixConcurrencyStrategy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarHystrixConcurrencyStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="参考文献">参考文献<a href="#参考文献" class="hash-link" aria-label="参考文献的直接链接" title="参考文献的直接链接">​</a></h3><ul><li><p>Fescar: <a href="https://github.com/alibaba/fescar" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/fescar</a></p></li><li><p>Spring Cloud Alibaba: <a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba" target="_blank" rel="noopener noreferrer">https://github.com/spring-cloud-incubator/spring-cloud-alibaba</a></p></li><li><p>spring-cloud-openfeign: <a href="https://github.com/spring-cloud/spring-cloud-openfeign" target="_blank" rel="noopener noreferrer">https://github.com/spring-cloud/spring-cloud-openfeign</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="本文作者">本文作者<a href="#本文作者" class="hash-link" aria-label="本文作者的直接链接" title="本文作者的直接链接">​</a></h3><p> 郭树抗，社区昵称 ywind，曾就职于华为终端云，现搜狐智能媒体中心Java工程师，目前主要负责搜狐号相关开发，对分布式事务、分布式系统和微服务架构有异常浓厚的兴趣。<br>
<!-- -->季敏(清铭)，社区昵称 slievrly，Fescar 开源项目负责人，阿里巴巴中间件 TXC/GTS 核心研发成员，长期从事于分布式中间件核心研发工作，在分布式事务领域有着较丰富的技术积累。</p></li></ul></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-04-15T00:00:00.000Z" itemprop="datePublished">2019年4月15日</time> · <!-- -->阅读需 9 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">大菲.Fei</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>针对Fescar 相信很多开发者已经对他并不陌生，当然Fescar 已经成为了过去时，为什么说它是过去时，因为Fescar 已经华丽的变身为Seata。如果还不知道Seata 的朋友，请登录下面网址查看。</p><p>  SEATA GITHUB:<!-- -->[https://github.com/seata/seata]</p><p>对于阿里各位同学的前仆后继，给我们广大开发者带来很多开源软件，在这里对他们表示真挚的感谢与问候。</p><p>今天在这里和大家分享下Spring Cloud 整合Seata 的相关心得。也让更多的朋友在搭建的道路上少走一些弯路，少踩一些坑。</p><h1>2.工程内容</h1><p>本次搭建流程为：client-&gt;网关-&gt;服务消费者-&gt;服务提供者.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                        技术框架：spring cloud gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                spring cloud fegin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                nacos1.0.RC2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                fescar-server0.4.1(Seata)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>关于nacos的启动方式请参考：<a href="https://nacos.io/zh-cn/docs/quick-start.html" target="_blank" rel="noopener noreferrer">Nacos启动参考</a>       </p><p>首先seata支持很多种注册服务方式，在 fescar-server-0.4.1\conf 目录下</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    file.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logback.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nacos-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nacos-config.text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registry.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>总共包含五个文件，其中 file.conf和 registry.conf 分别是我们在 服务消费者 &amp; 服务提供者 代码段需要用到的文件。
注：file.conf和 registry.conf 必须在当前使用的应用程序中，即： 服务消费者 &amp; 服务提供者 两个应用在都需要包含。
如果你采用了配置中心 是nacos 、zk ，file.cnf 是可以忽略的。但是type=“file” 如果是为file  就必须得用file.cnf</p><p>下面是registry.conf 文件中的配置信息，其中 registry 是注册服务中心配置。config为配置中心的配置地方。</p><p>从下面可知道目前seata支持nacos，file eureka redis zookeeper 等注册配置方式，默认下载的type=“file” 文件方式，当然这里选用什么方式，取决于</p><p>每个人项目的实际情况，这里我选用的是nacos，eureka的也是可以的，我这边分别对这两个版本进行整合测试均可以通过。</p><p>注：如果整合eureka请选用官方最新版本。</p><h1>3.核心配置</h1><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">registry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # file 、nacos 、eureka、redis、zk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;public&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eureka {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serviceUrl = &quot;http://localhost:1001/eureka&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weight = &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost:6379&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db = &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.timeout = 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect.timeout = 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;file.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # file、nacos 、apollo、zk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;public&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apollo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.id = &quot;fescar-server&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apollo.meta = &quot;http://192.168.1.204:8801&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.timeout = 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect.timeout = 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;file.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里要说明的是nacos-config.sh 是针对采用nacos配置中心的话，需要执行的一些默认初始化针对nacos的脚本。</p><p>SEATA的启动方式参考官方： 注意，这里需要说明下，命令启动官方是通过 空格区分参数，所以要注意。这里的IP 是可选参数，因为涉及到DNS解析，在部分情况下，有的时候在注册中心fescar 注入nacos的时候会通过获取地址，如果启动报错注册发现是计算机名称，需要指定IP。或者host配置IP指向。不过这个问题，在最新的SEATA中已经进行了修复。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> fescar-server.sh </span><span class="token number" style="color:#36acaa">8091</span><span class="token plain"> /home/admin/fescar/data/ IP（可选）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面提到过，在我们的代码中也是需要file.conf 和registry.conf 这里着重的地方要说的是file.conf,file.conf只有当registry中
配置file的时候才会进行加载，如果采用ZK、nacos、作为配置中心，可以忽略。因为type指定其他是不加载file.conf的，但是对应的 service.localRgroup.grouplist  和 service.vgroupMapping  需要在支持配置中心 进行指定，这样你的client 在启动后会通过自动从配置中心获取对应的 SEATA 服务 和地址。如果不配置会出现无法连接server的错误。当然如果你采用的eureka在config的地方就需要采用type=&quot;file&quot; 目前SEATA config暂时不支持eureka的形势</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">transport {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # tcp udt unix-domain-socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;TCP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #NIO NATIVE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server = &quot;NIO&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #enable heartbeat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  heartbeat = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #thread factory for netty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  thread-factory {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boss-thread-prefix = &quot;NettyBoss&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    worker-thread-prefix = &quot;NettyServerNIOWorker&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server-executor-thread-prefix = &quot;NettyServerBizHandler&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    share-boss-worker = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client-selector-thread-prefix = &quot;NettyClientSelector&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client-selector-thread-size = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client-worker-thread-prefix = &quot;NettyClientWorkerThread&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # netty boss thread size,will not be used for UDT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boss-thread-size = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #auto default pin or 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    worker-thread-size = 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #vgroup-&gt;rgroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vgroup_mapping.service-provider-fescar-service-group = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #only support single node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  localRgroup.grouplist = &quot;127.0.0.1:8091&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #degrade current not support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enableDegrade = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  async.commit.buffer.limit = 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lock {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retry.internal = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retry.times = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>4.服务相关</h1><p> 这里有两个地方需要注意</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    grouplist IP，这里是当前fescar-sever的IP端口，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vgroup_mapping的配置。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> vgroup_mapping.服务名称-fescar-service-group,这里 要说下服务名称其实是你当前的consumer 或者provider application.properties的配置的应用名称：spring.application.name=service-provider，源代码中是 获取应用名称与 fescar-service-group 进行拼接，做key值。同理value是当前fescar的服务名称，  cluster = &quot;default&quot;  / application = &quot;default&quot;</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     vgroup_mapping.service-provider-fescar-service-group = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #only support single node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      localRgroup.grouplist = &quot;127.0.0.1:8091&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同理无论是provider 还是consumer 都需要这两个文件进行配置。</p><p>如果你采用nacos做配置中心，需要在nacos通过添加配置方式进行配置添加。</p><h1>5.事务使用</h1><p>我这里的代码逻辑是请求通过网关进行负载转发到我的consumer上，在consumer 中通过fegin进行provider请求。官方的例子中是通过fegin进行的，而我们这边直接通过网关转发，所以全局事务同官方的demo一样 也都是在controller层。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DemoController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DemoFeignClient demoFeignClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DemoFeignClient2 demoFeignClient2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional(timeoutMills = 300000, name = &quot;spring-cloud-demo-tx&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/getdemo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String demo() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 调用A 服务  简单save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResponseData&lt;Integer&gt; result = demoFeignClient.insertService(&quot;test&quot;,1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(result.getStatus()==400) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(result+&quot;+++++++++++++++++++++++++++++++++++++++&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException(&quot;this is error1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 调用B 服务。报错测试A 服务回滚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResponseData&lt;Integer&gt;  result2 = demoFeignClient2.saveService();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(result2.getStatus()==400) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(result2+&quot;+++++++++++++++++++++++++++++++++++++++&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException(&quot;this is error2&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;SUCCESS&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>到此为止核心的事务整合基本到此结束了，我这里是针对A,B 两个provider进行调用，当B发生报错后，进行全局事务回滚。当然每个事务内部都可以通过自己的独立本地事务去处理自己本地事务方式。</p><p>SEATA是通过全局的XID方式进行事务统一标识方式。这里就不列出SEATA需要用的数据库表。具体参考：<a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba/tree/master/spring-cloud-alibaba-examples/fescar-example" target="_blank" rel="noopener noreferrer">spring-cloud-fescar 官方DEMO</a></p><h1>5.数据代理</h1><p>这里还有一个重要的说明就是，在分库服务的情况下，每一个数据库内都需要有一个undo_log的数据库表进行XID统一存储处理。</p><p>同事针对每个提供服务的项目，需要进行数据库连接池的代理。也就是：</p><p>目前只支持Druid连接池，后续会继续支持。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DatabaseConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(destroyMethod = &quot;close&quot;, initMethod = &quot;init&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix=&quot;spring.datasource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DruidDataSource druidDataSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DruidDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSourceProxy dataSourceProxy(DruidDataSource druidDataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DataSourceProxy(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SqlSessionFactory sqlSessionFactory(DataSourceProxy dataSourceProxy) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factoryBean.setDataSource(dataSourceProxy);    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return factoryBean.getObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>大家要注意的就是配置文件和数据代理。如果没有进行数据源代理，undo_log是无数据的，也就是没办进行XID的管理。</p><p>本文作者：大菲.Fei</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-04-15T00:00:00.000Z" itemprop="datePublished">2019年4月15日</time> · <!-- -->阅读需 26 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">fangliangsheng</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>在分布式系统中，分布式事务是一个必须要解决的问题，目前使用较多的是最终一致性方案。自年初阿里开源了Fescar（四月初更名为Seata）后，该项目受到了极大的关注度，目前已接近8000Star。<a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">Seata</a>以高性能和零侵入的方式为目标解决微服务领域的分布式事务难题，目前正处于快速迭代中，近期小目标是生产可用的Mysql版本。关于Seata的总体介绍，可以查看<a href="https://github.com/seata/seata/wiki/%E6%A6%82%E8%A7%88" target="_blank" rel="noopener noreferrer">官方WIKI</a>获得更多更全面的内容介绍。</p><p>本文主要基于spring cloud+spring jpa+spring cloud alibaba fescar+mysql+seata的结构，搭建一个分布式系统的demo，通过seata的debug日志和源代码，从client端（RM、TM）的角度分析说明其工作流程及原理。</p><p>文中代码基于fescar-0.4.1，由于项目刚更名为seata不久，例如一些包名、类名、jar包名称还都是fescar的命名，故下文中仍使用fescar进行表述。</p><p>示例项目：<a href="https://github.com/fescar-group/fescar-samples/tree/master/springcloud-jpa-seata" target="_blank" rel="noopener noreferrer">https://github.com/fescar-group/fescar-samples/tree/master/springcloud-jpa-seata</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="相关概念">相关概念<a href="#相关概念" class="hash-link" aria-label="相关概念的直接链接" title="相关概念的直接链接">​</a></h2><ul><li>XID：全局事务的唯一标识，由ip:port:sequence组成</li><li>Transaction Coordinator (TC)：事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚</li><li>Transaction Manager (TM )：控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议</li><li>Resource Manager (RM)：控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分布式框架支持">分布式框架支持<a href="#分布式框架支持" class="hash-link" aria-label="分布式框架支持的直接链接" title="分布式框架支持的直接链接">​</a></h2><p>Fescar使用XID表示一个分布式事务，XID需要在一次分布式事务请求所涉的系统中进行传递，从而向feacar-server发送分支事务的处理情况，以及接收feacar-server的commit、rollback指令。
Fescar官方已支持全版本的dubbo协议，而对于spring cloud（spring-boot）的分布式项目社区也提供了相应的实现</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.springframework.cloud</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">spring-cloud-alibaba-fescar</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">2.1.0.BUILD-SNAPSHOT</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>该组件实现了基于RestTemplate、Feign通信时的XID传递功能。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="业务逻辑">业务逻辑<a href="#业务逻辑" class="hash-link" aria-label="业务逻辑的直接链接" title="业务逻辑的直接链接">​</a></h2><p>业务逻辑是经典的下订单、扣余额、减库存流程。
根据模块划分为三个独立的服务，且分别连接对应的数据库</p><ul><li>订单：order-server</li><li>账户：account-server</li><li>库存：storage-server</li></ul><p>另外还有发起分布式事务的业务系统</p><ul><li>业务：business-server</li></ul><p>项目结构如下图
<img loading="lazy" alt="在这里插入图片描述" src="/zh-cn/assets/images/20190410114411366-32c3a0b5d1265bbd65911d6d46d284ef.png" width="1034" height="658" class="img_ev3q"></p><p><strong>正常业务</strong></p><ol><li>business发起购买请求</li><li>storage扣减库存</li><li>order创建订单</li><li>account扣减余额</li></ol><p><strong>异常业务</strong></p><ol><li>business发起购买请求</li><li>storage扣减库存</li><li>order创建订单</li><li>account<code>扣减余额异常</code></li></ol><p>正常流程下2、3、4步的数据正常更新全局commit，异常流程下的数据则由于第4步的异常报错全局回滚。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置文件">配置文件<a href="#配置文件" class="hash-link" aria-label="配置文件的直接链接" title="配置文件的直接链接">​</a></h2><p>fescar的配置入口文件是<a href="https://github.com/seata/seata/blob/develop/config/src/main/resources/registry.conf" target="_blank" rel="noopener noreferrer">registry.conf</a>,查看代码<a href="https://github.com/seata/seata/blob/develop/config/src/main/java/com/alibaba/fescar/config/ConfigurationFactory.java" target="_blank" rel="noopener noreferrer">ConfigurationFactory</a>得知目前还不能指定该配置文件，所以配置文件名称只能为registry.conf</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static final String REGISTRY_CONF = &quot;registry.conf&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static final Configuration FILE_INSTANCE = new FileConfiguration(REGISTRY_CONF);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在<code>registry</code>中可以指定具体配置的形式，默认使用file类型，在file.conf中有3部分配置内容</p><ol><li>transport
transport部分的配置对应<a href="https://github.com/seata/seata/blob/develop/core/src/main/java/com/alibaba/fescar/core/rpc/netty/NettyServerConfig.java" target="_blank" rel="noopener noreferrer">NettyServerConfig</a>类，用于定义Netty相关的参数，TM、RM与fescar-server之间使用Netty进行通信</li><li>service</li></ol><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     service </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #vgroup</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">rgroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vgroup_mapping</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">my_test_tx_group</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #配置Client连接</span><span class="token constant" style="color:#36acaa">TC</span><span class="token plain">的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword module" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">grouplist</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;127.0.0.1:8091&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #degrade current not support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enableDegrade </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      是否启用seata的分布式事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disableGlobalTransaction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>client</li></ol><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    client </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #</span><span class="token constant" style="color:#36acaa">RM</span><span class="token plain">接收</span><span class="token constant" style="color:#36acaa">TC</span><span class="token plain">的commit通知后缓冲上限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      async</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">commit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">limit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lock </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">internal</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">times</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="数据源proxy">数据源Proxy<a href="#数据源proxy" class="hash-link" aria-label="数据源Proxy的直接链接" title="数据源Proxy的直接链接">​</a></h2><p>除了前面的配置文件，fescar在AT模式下稍微有点代码量的地方就是对数据源的代理指定，且目前只能基于<code>DruidDataSource</code>的代理。
注：在最新发布的0.4.2版本中已支持任意数据源类型</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DruidDataSource druidDataSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DruidDataSource druidDataSource = new DruidDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return druidDataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(&quot;dataSource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DataSourceProxy dataSource(DruidDataSource druidDataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DataSourceProxy(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用<code>DataSourceProxy</code>的目的是为了引入<code>ConnectionProxy</code>,fescar无侵入的一方面就体现在<code>ConnectionProxy</code>的实现上，即分支事务加入全局事务的切入点是在本地事务的<code>commit</code>阶段，这样设计可以保证业务数据与<code>undo_log</code>是在一个本地事务中。</p><p><code>undo_log</code>是需要在业务库上创建的一个表，fescar依赖该表记录每笔分支事务的状态及二阶段<code>rollback</code>的回放数据。不用担心该表的数据量过大形成单点问题，在全局事务<code>commit</code>的场景下事务对应的<code>undo_log</code>会异步删除。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">undo_log</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">rollback_info</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">longblob</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_status</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_created</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">datetime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_modified</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">datetime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">ext</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">UNIQUE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">ux_undo_log</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动server">启动Server<a href="#启动server" class="hash-link" aria-label="启动Server的直接链接" title="启动Server的直接链接">​</a></h2><p>前往<a href="https://github.com/seata/seata/releases" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata/releases</a> 下载与Client版本对应的fescar-server,避免由于版本的不同导致的协议不一致问题
进入解压之后的 bin 目录，执行</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./fescar-server.sh </span><span class="token number" style="color:#36acaa">8091</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>启动成功输出</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">2019</span><span class="token plain">-04-09 </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">:27:24.637 INFO </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">c.a.fescar.core.rpc.netty.AbstractRpcRemotingServer.start:152 -Server started </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动client">启动Client<a href="#启动client" class="hash-link" aria-label="启动Client的直接链接" title="启动Client的直接链接">​</a></h2><p>fescar的加载入口类位于<a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba/blob/finchley/spring-cloud-alibaba-fescar/src/main/java/org/springframework/cloud/alibaba/fescar/GlobalTransactionAutoConfiguration.java" target="_blank" rel="noopener noreferrer">GlobalTransactionAutoConfiguration</a>，对基于spring boot的项目能够自动加载，当然也可以通过其他方式示例化<code>GlobalTransactionScanner</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties({FescarProperties.class})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationContext applicationContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final FescarProperties fescarProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GlobalTransactionAutoConfiguration(ApplicationContext applicationContext, FescarProperties fescarProperties) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.applicationContext = applicationContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.fescarProperties = fescarProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * 示例化GlobalTransactionScanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * scanner为client初始化的发起类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GlobalTransactionScanner globalTransactionScanner() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String applicationName = this.applicationContext.getEnvironment().getProperty(&quot;spring.application.name&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String txServiceGroup = this.fescarProperties.getTxServiceGroup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(txServiceGroup)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            txServiceGroup = applicationName + &quot;-fescar-service-group&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.fescarProperties.setTxServiceGroup(txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new GlobalTransactionScanner(applicationName, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到支持一个配置项FescarProperties，用于配置事务分组名称</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.alibaba.fescar.tx-service-group=my_test_tx_group</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果不指定服务组，则默认使用spring.application.name+ -fescar-service-group生成名称，所以不指定spring.application.name启动会报错</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(&quot;spring.cloud.alibaba.fescar&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarProperties {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String txServiceGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FescarProperties() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getTxServiceGroup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.txServiceGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setTxServiceGroup(String txServiceGroup) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.txServiceGroup = txServiceGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>获取applicationId和txServiceGroup后，创建<a href="https://github.com/seata/seata/blob/develop/spring/src/main/java/com/alibaba/fescar/spring/annotation/GlobalTransactionScanner.java" target="_blank" rel="noopener noreferrer">GlobalTransactionScanner</a>对象，主要看类中initClient方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void initClient() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isNullOrEmpty(applicationId) || StringUtils.isNullOrEmpty(txServiceGroup)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;applicationId: &quot; + applicationId + &quot;, txServiceGroup: &quot; + txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //init TM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //init RM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>方法中可以看到初始化了<code>TMClient</code>和<code>RMClient</code>，对于一个服务既可以是TM角色也可以是RM角色，至于什么时候是TM或者RM则要看在一次全局事务中<code>@GlobalTransactional</code>注解标注在哪。
Client创建的结果是与TC的一个Netty连接，所以在启动日志中可以看到两个Netty Channel，其中标明了transactionRole分别为<code>TMROLE</code>和<code>RMROLE</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.417  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : NettyPool create channel to {&quot;address&quot;:&quot;127.0.0.1:8091&quot;,&quot;message&quot;:{&quot;applicationId&quot;:&quot;business-service&quot;,&quot;byteBuffer&quot;:{&quot;char&quot;:&quot;\u0000&quot;,&quot;direct&quot;:false,&quot;double&quot;:0.0,&quot;float&quot;:0.0,&quot;int&quot;:0,&quot;long&quot;:0,&quot;readOnly&quot;:false,&quot;short&quot;:0},&quot;transactionServiceGroup&quot;:&quot;my_test_tx_group&quot;,&quot;typeCode&quot;:101,&quot;version&quot;:&quot;0.4.1&quot;},&quot;transactionRole&quot;:&quot;TMROLE&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.505  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : NettyPool create channel to {&quot;address&quot;:&quot;127.0.0.1:8091&quot;,&quot;message&quot;:{&quot;applicationId&quot;:&quot;business-service&quot;,&quot;byteBuffer&quot;:{&quot;char&quot;:&quot;\u0000&quot;,&quot;direct&quot;:false,&quot;double&quot;:0.0,&quot;float&quot;:0.0,&quot;int&quot;:0,&quot;long&quot;:0,&quot;readOnly&quot;:false,&quot;short&quot;:0},&quot;transactionServiceGroup&quot;:&quot;my_test_tx_group&quot;,&quot;typeCode&quot;:103,&quot;version&quot;:&quot;0.4.1&quot;},&quot;transactionRole&quot;:&quot;RMROLE&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.629 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:RegisterTMRequest{applicationId=&#x27;business-service&#x27;, transactionServiceGroup=&#x27;my_test_tx_group&#x27;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.629 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:RegisterRMRequest{resourceIds=&#x27;null&#x27;, applicationId=&#x27;business-service&#x27;, transactionServiceGroup=&#x27;my_test_tx_group&#x27;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.699 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.699 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.701 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.RmRpcClient@3b06d101 msgId:1, future :com.alibaba.fescar.core.protocol.MessageFuture@28bb1abd, body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.701 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.TmRpcClient@65fc3fb7 msgId:2, future :com.alibaba.fescar.core.protocol.MessageFuture@9a1e3df, body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.710  INFO 93715 --- [imeoutChecker_1] c.a.fescar.core.rpc.netty.RmRpcClient    : register RM success. server version:0.4.1,channel:[id: 0xe6468995, L:/127.0.0.1:57397 - R:/127.0.0.1:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.710  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : register success, cost 114 ms, version:0.4.1,role:TMROLE,channel:[id: 0xd22fe0c5, L:/127.0.0.1:57398 - R:/127.0.0.1:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.711  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : register success, cost 125 ms, version:0.4.1,role:RMROLE,channel:[id: 0xe6468995, L:/127.0.0.1:57397 - R:/127.0.0.1:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>日志中可以看到</p><ol><li>创建Netty连接</li><li>发送注册请求</li><li>得到响应结果</li><li><code>RmRpcClient</code>、<code>TmRpcClient</code>成功实例化</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tm处理流程">TM处理流程<a href="#tm处理流程" class="hash-link" aria-label="TM处理流程的直接链接" title="TM处理流程的直接链接">​</a></h2><p>在本例中，TM的角色是business-service,BusinessService的purchase方法标注了<code>@GlobalTransactional</code>注解</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class BusinessService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private StorageFeignClient storageFeignClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private OrderFeignClient orderFeignClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void purchase(String userId, String commodityCode, int orderCount){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageFeignClient.deduct(commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderFeignClient.create(userId, commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>方法调用后将会创建一个全局事务，首先关注<code>@GlobalTransactional</code>注解的作用，在<a href="https://github.com/seata/seata/blob/develop/spring/src/main/java/com/alibaba/fescar/spring/annotation/GlobalTransactionalInterceptor.java" target="_blank" rel="noopener noreferrer">GlobalTransactionalInterceptor</a>中被拦截处理</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * AOP拦截方法调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object invoke(final MethodInvocation methodInvocation) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; targetClass = (methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis()) : null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //获取方法GlobalTransactional注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final GlobalTransactional globalTransactionalAnnotation = getAnnotation(method, GlobalTransactional.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final GlobalLock globalLockAnnotation = getAnnotation(method, GlobalLock.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果方法有GlobalTransactional注解，则拦截到相应方法处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (globalTransactionalAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (globalLockAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return handleGlobalLock(methodInvocation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return methodInvocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>handleGlobalTransaction</code>方法中对<a href="https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/TransactionalTemplate.java" target="_blank" rel="noopener noreferrer">TransactionalTemplate</a>的execute进行了调用，从类名可以看到这是一个标准的模版方法，它定义了TM对全局事务处理的标准步骤，注释已经比较清楚了</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Object execute(TransactionalExecutor business) throws TransactionalExecutor.ExecutionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. get or create a transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. begin transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerBeforeBegin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.begin(business.timeout(), business.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerAfterBegin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TransactionalExecutor.Code.BeginFailure);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Do Your Business</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rs = business.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. any business exception, rollback.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                triggerBeforeRollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tx.rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                triggerAfterRollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 3.1 Successfully rolled back</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new TransactionalExecutor.ExecutionException(tx, TransactionalExecutor.Code.RollbackDone, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 3.2 Failed to rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TransactionalExecutor.Code.RollbackFailure, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. everything is fine, commit.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerBeforeCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerAfterCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4.1 Failed to commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TransactionalExecutor.Code.CommitFailure);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //5. clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        triggerAfterCompletion();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cleanUp();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过<a href="https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/DefaultGlobalTransaction.java" target="_blank" rel="noopener noreferrer">DefaultGlobalTransaction</a>的begin方法开启全局事务</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void begin(int timeout, String name) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (role != GlobalTransactionRole.Launcher) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug(&quot;Ignore Begin(): just involved in global transaction [&quot; + xid + &quot;]&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (xid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (RootContext.getXID() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //具体开启事务的方法，获取TC返回的XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xid = transactionManager.begin(null, null, name, timeout);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status = GlobalStatus.Begin;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RootContext.bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.debug(&quot;Begin a NEW global transaction [&quot; + xid + &quot;]&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>方法开头处<code>if (role != GlobalTransactionRole.Launcher)</code>对role的判断有关键的作用，表明当前是全局事务的发起者（Launcher）还是参与者（Participant）。如果在分布式事务的下游系统方法中也加上<code>@GlobalTransactional</code>注解，那么它的角色就是Participant，会忽略后面的begin直接return，而判断是Launcher还是Participant是根据当前上下文是否已存在XID来判断，没有XID的就是Launcher，已经存在XID的就是Participant.
由此可见，全局事务的创建只能由Launcher执行，而一次分布式事务中也只有一个Launcher存在。</p><p><a href="https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/DefaultTransactionManager.java" target="_blank" rel="noopener noreferrer">DefaultTransactionManager</a>负责TM与TC通讯，发送begin、commit、rollback指令</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public String begin(String applicationId, String transactionServiceGroup, String name, int timeout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalBeginRequest request = new GlobalBeginRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request.setTransactionName(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request.setTimeout(timeout);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalBeginResponse response = (GlobalBeginResponse)syncCall(request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return response.getXid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至此拿到fescar-server返回的XID表示一个全局事务创建成功，日志中也反应了上述流程</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.417 DEBUG 31326 --- [nio-8084-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : offer message: timeout=60000,transactionName=purchase(java.lang.String,java.lang.String,int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.417 DEBUG 31326 --- [geSend_TMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : write message:FescarMergeMessage timeout=60000,transactionName=purchase(java.lang.String,java.lang.String,int), channel:[id: 0xa148545e, L:/127.0.0.1:56120 - R:/127.0.0.1:8091],active?true,writable?true,isopen?true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.418 DEBUG 31326 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:FescarMergeMessage timeout=60000,transactionName=purchase(java.lang.String,java.lang.String,int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.421 DEBUG 31326 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:MergeResultMessage com.alibaba.fescar.core.protocol.transaction.GlobalBeginResponse@2dc480dc,messageId:1196</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.421 DEBUG 31326 --- [nio-8084-exec-1] c.a.fescar.core.context.RootContext      : bind 192.168.224.93:8091:2008502699</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.421 DEBUG 31326 --- [nio-8084-exec-1] c.a.f.tm.api.DefaultGlobalTransaction    : Begin a NEW global transaction [192.168.224.93:8091:2008502699]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>全局事务创建后，就开始执行business.execute()，即业务代码<code>storageFeignClient.deduct(commodityCode, orderCount)</code>进入RM处理流程，此处的业务逻辑为调用storage-service的扣减库存接口。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rm处理流程">RM处理流程<a href="#rm处理流程" class="hash-link" aria-label="RM处理流程的直接链接" title="RM处理流程的直接链接">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@GetMapping(path = &quot;/deduct&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Boolean deduct(String commodityCode, Integer count){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storageService.deduct(commodityCode,count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Transactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void deduct(String commodityCode, int count){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Storage storage = storageDAO.findByCommodityCode(commodityCode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage.setCount(storage.getCount()-count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storageDAO.save(storage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>storage的接口和service方法并未出现fescar相关的代码和注解，体现了fescar的无侵入。那它是如何加入到这次全局事务中的呢？答案在<a href="https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/ConnectionProxy.java" target="_blank" rel="noopener noreferrer">ConnectionProxy</a>中，这也是前面说为什么必须要使用<code>DataSourceProxy</code>的原因，通过DataSourceProxy才能在业务代码的本地事务提交时，fescar通过该切入点，向TC注册分支事务并发送RM的处理结果。</p><p>由于业务代码本身的事务提交被<code>ConnectionProxy</code>代理实现，所以在提交本地事务时，实际执行的是ConnectionProxy的commit方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void commit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果当前是全局事务，则执行全局事务的提交</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //判断是不是全局事务，就是看当前上下文是否存在XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context.inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processGlobalTransactionCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (context.isGlobalLockRequire()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processLocalCommitWithGlobalLocks();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void processGlobalTransactionCommit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //首先是向TC注册RM，拿到TC分配的branchId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        register();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (TransactionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recognizeLockKeyConflictException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (context.hasUndoLog()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //写入undolog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            UndoLogManager.flushUndoLogs(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //提交本地事务，写入undo_log和业务数据在同一个本地事务中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //向TC发送RM的事务处理失败的通知</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        report(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ex instanceof SQLException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //向TC发送RM的事务处理成功的通知</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    report(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void register() throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //注册RM，构建request通过netty向TC发送注册指令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Long branchId = DefaultResourceManager.get().branchRegister(BranchType.AT, getDataSourceProxy().getResourceId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            null, context.getXid(), null, context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //将返回的branchId存在上下文中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.setBranchId(branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过日志印证一下上面的流程</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor   : xid in RootContext null xid in RpcContext 192.168.0.2:8091:2008546211</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] c.a.fescar.core.context.RootContext      : bind 192.168.0.2:8091:2008546211</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor   : bind 192.168.0.2:8091:2008546211 to RootContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.386  INFO 38933 --- [nio-8081-exec-1] o.h.h.i.QueryTranslatorFactoryInitiator  : HHH000397: Using ASTQueryTranslatorFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hibernate: select storage0_.id as id1_0_, storage0_.commodity_code as commodit2_0_, storage0_.count as count3_0_ from storage_tbl storage0_ where storage0_.commodity_code=?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hibernate: update storage_tbl set count=? where id=?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.673  INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient    : will connect to 192.168.0.2:8091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.673  INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient    : RM will register :jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.673  INFO 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.NettyPoolableFactory   : NettyPool create channel to {&quot;address&quot;:&quot;192.168.0.2:8091&quot;,&quot;message&quot;:{&quot;applicationId&quot;:&quot;storage-service&quot;,&quot;byteBuffer&quot;:{&quot;char&quot;:&quot;\u0000&quot;,&quot;direct&quot;:false,&quot;double&quot;:0.0,&quot;float&quot;:0.0,&quot;int&quot;:0,&quot;long&quot;:0,&quot;readOnly&quot;:false,&quot;short&quot;:0},&quot;resourceIds&quot;:&quot;jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false&quot;,&quot;transactionServiceGroup&quot;:&quot;hello-service-fescar-service-group&quot;,&quot;typeCode&quot;:103,&quot;version&quot;:&quot;0.4.0&quot;},&quot;transactionRole&quot;:&quot;RMROLE&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.677 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:RegisterRMRequest{resourceIds=&#x27;jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false&#x27;, applicationId=&#x27;storage-service&#x27;, transactionServiceGroup=&#x27;hello-service-fescar-service-group&#x27;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.680 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.680 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.RmRpcClient@7d61f5d4 msgId:9, future :com.alibaba.fescar.core.protocol.MessageFuture@186cd3e0, body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.680  INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient    : register RM success. server version:0.4.1,channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.680  INFO 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.NettyPoolableFactory   : register success, cost 3 ms, version:0.4.1,role:RMROLE,channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.680 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : offer message: transactionId=2008546211,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,lockKey=storage_tbl:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.681 DEBUG 38933 --- [geSend_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : write message:FescarMergeMessage transactionId=2008546211,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,lockKey=storage_tbl:1, channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091],active?true,writable?true,isopen?true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.681 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:FescarMergeMessage transactionId=2008546211,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,lockKey=storage_tbl:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.687 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:MergeResultMessage BranchRegisterResponse: transactionId=2008546211,branchId=2008546212,result code =Success,getMsg =null,messageId:11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.702 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.rm.datasource.undo.UndoLogManager  : Flushing UNDO LOG: {&quot;branchId&quot;:2008546212,&quot;sqlUndoLogs&quot;:[{&quot;afterImage&quot;:{&quot;rows&quot;:[{&quot;fields&quot;:[{&quot;keyType&quot;:&quot;PrimaryKey&quot;,&quot;name&quot;:&quot;id&quot;,&quot;type&quot;:4,&quot;value&quot;:1},{&quot;keyType&quot;:&quot;NULL&quot;,&quot;name&quot;:&quot;count&quot;,&quot;type&quot;:4,&quot;value&quot;:993}]}],&quot;tableName&quot;:&quot;storage_tbl&quot;},&quot;beforeImage&quot;:{&quot;rows&quot;:[{&quot;fields&quot;:[{&quot;keyType&quot;:&quot;PrimaryKey&quot;,&quot;name&quot;:&quot;id&quot;,&quot;type&quot;:4,&quot;value&quot;:1},{&quot;keyType&quot;:&quot;NULL&quot;,&quot;name&quot;:&quot;count&quot;,&quot;type&quot;:4,&quot;value&quot;:994}]}],&quot;tableName&quot;:&quot;storage_tbl&quot;},&quot;sqlType&quot;:&quot;UPDATE&quot;,&quot;tableName&quot;:&quot;storage_tbl&quot;}],&quot;xid&quot;:&quot;192.168.0.2:8091:2008546211&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.755 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : offer message: transactionId=2008546211,branchId=2008546212,resourceId=null,status=PhaseOne_Done,applicationData=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.755 DEBUG 38933 --- [geSend_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : write message:FescarMergeMessage transactionId=2008546211,branchId=2008546212,resourceId=null,status=PhaseOne_Done,applicationData=null, channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091],active?true,writable?true,isopen?true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.756 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:FescarMergeMessage transactionId=2008546211,branchId=2008546212,resourceId=null,status=PhaseOne_Done,applicationData=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.758 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:MergeResultMessage com.alibaba.fescar.core.protocol.transaction.BranchReportResponse@582a08cf,messageId:13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.799 DEBUG 38933 --- [nio-8081-exec-1] c.a.fescar.core.context.RootContext      : unbind 192.168.0.2:8091:2008546211</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.799 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor   : unbind 192.168.0.2:8091:2008546211 from RootContext</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>获取business-service传来的XID</li><li>绑定XID到当前上下文中</li><li>执行业务逻辑sql</li><li>向TC创建本次RM的Netty连接</li><li>向TC发送分支事务的相关信息</li><li>获得TC返回的branchId</li><li>记录Undo Log数据</li><li>向TC发送本次事务PhaseOne阶段的处理结果</li><li>从当前上下文中解绑XID</li></ol><p>其中第1步和第9步，是在<a href="https://github.com/dongsheep/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-fescar/src/main/java/org/springframework/cloud/alibaba/fescar/web/FescarHandlerInterceptor.java" target="_blank" rel="noopener noreferrer">FescarHandlerInterceptor</a>中完成的，该类并不属于fescar，是前面提到的spring-cloud-alibaba-fescar,它实现了基于feign、rest通信时将xid bind和unbind到当前请求上下文中。到这里RM完成了PhaseOne阶段的工作，接着看PhaseTwo阶段的处理逻辑。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="事务提交">事务提交<a href="#事务提交" class="hash-link" aria-label="事务提交的直接链接" title="事务提交的直接链接">​</a></h2><p>各分支事务执行完成后，TC对各RM的汇报结果进行汇总，给各RM发送commit或rollback的指令</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.813 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:xid=192.168.0.2:8091:2008546211,branchId=2008546212,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,applicationData=null,messageId:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.813 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.RmRpcClient@7d61f5d4 msgId:1, body:xid=192.168.0.2:8091:2008546211,branchId=2008546212,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,applicationData=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.814  INFO 38933 --- [atch_RMROLE_1_8] c.a.f.core.rpc.netty.RmMessageListener   : onMessage:xid=192.168.0.2:8091:2008546211,branchId=2008546212,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,applicationData=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.816  INFO 38933 --- [atch_RMROLE_1_8] com.alibaba.fescar.rm.AbstractRMHandler  : Branch committing: 192.168.0.2:8091:2008546211 2008546212 jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.816  INFO 38933 --- [atch_RMROLE_1_8] com.alibaba.fescar.rm.AbstractRMHandler  : Branch commit result: PhaseTwo_Committed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.817  INFO 38933 --- [atch_RMROLE_1_8] c.a.fescar.core.rpc.netty.RmRpcClient    : RmRpcClient sendResponse branchStatus=PhaseTwo_Committed,result code =Success,getMsg =null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.817 DEBUG 38933 --- [atch_RMROLE_1_8] c.a.f.c.rpc.netty.AbstractRpcRemoting    : send response:branchStatus=PhaseTwo_Committed,result code =Success,getMsg =null,channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.817 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:branchStatus=PhaseTwo_Committed,result code =Success,getMsg =null</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从日志中可以看到</p><ol><li>RM收到XID=192.168.0.2:8091:2008546211,branchId=2008546212的commit通知</li><li>执行commit动作</li><li>将commit结果发送给TC，branchStatus为PhaseTwo_Committed</li></ol><p>具体看下二阶段commit的执行过程，在<a href="https://github.com/seata/seata/blob/develop/rm/src/main/java/com/alibaba/fescar/rm/AbstractRMHandler.java" target="_blank" rel="noopener noreferrer">AbstractRMHandler</a>类的doBranchCommit方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 拿到通知的xid、branchId等关键参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 然后调用RM的branchCommit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected void doBranchCommit(BranchCommitRequest request, BranchCommitResponse response) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String xid = request.getXid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long branchId = request.getBranchId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resourceId = request.getResourceId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String applicationData = request.getApplicationData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;Branch committing: &quot; + xid + &quot; &quot; + branchId + &quot; &quot; + resourceId + &quot; &quot; + applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BranchStatus status = getResourceManager().branchCommit(request.getBranchType(), xid, branchId, resourceId, applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response.setBranchStatus(status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;Branch commit result: &quot; + status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最终会将branchCommit的请求调用到<a href="https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/AsyncWorker.java" target="_blank" rel="noopener noreferrer">AsyncWorker</a>的branchCommit方法。AsyncWorker的处理方式是fescar架构的一个关键部分，因为大部分事务都是会正常提交的，所以在PhaseOne阶段就已经结束了，这样就可以将锁最快的释放。PhaseTwo阶段接收commit的指令后，异步处理即可。将PhaseTwo的时间消耗排除在一次分布式事务之外。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static final List&lt;Phase2Context&gt; ASYNC_COMMIT_BUFFER = Collections.synchronizedList( new ArrayList&lt;Phase2Context&gt;());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 将需要提交的XID加入list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId, String applicationData) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ASYNC_COMMIT_BUFFER.size() &lt; ASYNC_COMMIT_BUFFER_LIMIT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ASYNC_COMMIT_BUFFER.add(new Phase2Context(branchType, xid, branchId, resourceId, applicationData));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.warn(&quot;Async commit buffer is FULL. Rejected branch [&quot; + branchId + &quot;/&quot; + xid + &quot;] will be handled by housekeeping later.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return BranchStatus.PhaseTwo_Committed;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通过定时任务消费list中的XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public synchronized void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;Async Commit Buffer Limit: &quot; + ASYNC_COMMIT_BUFFER_LIMIT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timerExecutor = new ScheduledThreadPoolExecutor(1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new NamedThreadFactory(&quot;AsyncWorker&quot;, 1, true));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timerExecutor.scheduleAtFixedRate(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                doBranchCommits();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.info(&quot;Failed at async committing ... &quot; + e.getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, 10, 1000 * 1, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void doBranchCommits() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ASYNC_COMMIT_BUFFER.size() == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, List&lt;Phase2Context&gt;&gt; mappedContexts = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Iterator&lt;Phase2Context&gt; iterator = ASYNC_COMMIT_BUFFER.iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //一次定时循环取出ASYNC_COMMIT_BUFFER中的所有待办数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //以resourceId作为key分组待commit数据，resourceId是一个数据库的连接url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //在前面的日志中可以看到，目的是为了覆盖应用的多数据源创建</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (iterator.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Phase2Context commitContext = iterator.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Phase2Context&gt; contextsGroupedByResourceId = mappedContexts.get(commitContext.resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (contextsGroupedByResourceId == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            contextsGroupedByResourceId = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mappedContexts.put(commitContext.resourceId, contextsGroupedByResourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        contextsGroupedByResourceId.add(commitContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        iterator.remove();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Map.Entry&lt;String, List&lt;Phase2Context&gt;&gt; entry : mappedContexts.entrySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //根据resourceId获取数据源以及连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataSourceProxy dataSourceProxy = DataSourceManager.get().get(entry.getKey());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn = dataSourceProxy.getPlainConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (SQLException sqle) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.warn(&quot;Failed to get connection for async committing on &quot; + entry.getKey(), sqle);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;Phase2Context&gt; contextsGroupedByResourceId = entry.getValue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Phase2Context commitContext : contextsGroupedByResourceId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //执行undolog的处理，即删除xid、branchId对应的记录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    UndoLogManager.deleteUndoLog(commitContext.xid, commitContext.branchId, conn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.warn(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Failed to delete undo log [&quot; + commitContext.branchId + &quot;/&quot; + commitContext.xid + &quot;]&quot;, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (conn != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    conn.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (SQLException closeEx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.warn(&quot;Failed to close JDBC resource while deleting undo_log &quot;, closeEx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所以对于commit动作的处理，RM只需删除xid、branchId对应的undo_log即可。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="事务回滚">事务回滚<a href="#事务回滚" class="hash-link" aria-label="事务回滚的直接链接" title="事务回滚的直接链接">​</a></h2><p>对于rollback场景的触发有两种情况</p><ol><li>分支事务处理异常，即<a href="https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/ConnectionProxy.java" target="_blank" rel="noopener noreferrer">ConnectionProxy</a>中<code>report(false)</code>的情况</li><li>TM捕获到下游系统上抛的异常，即发起全局事务标有<code>@GlobalTransactional</code>注解的方法捕获到的异常。在前面<a href="https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/TransactionalTemplate.java" target="_blank" rel="noopener noreferrer">TransactionalTemplate</a>类的execute模版方法中，对business.execute()的调用进行了catch，catch后会调用rollback，由TM通知TC对应XID需要回滚事务</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> public void rollback() throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //只有Launcher能发起这个rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (role == GlobalTransactionRole.Participant) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Participant has no responsibility of committing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug(&quot;Ignore Rollback(): just involved in global transaction [&quot; + xid + &quot;]&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (xid == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status = transactionManager.rollback(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (RootContext.getXID() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid.equals(RootContext.getXID())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TC汇总后向参与者发送rollback指令，RM在<a href="https://github.com/seata/seata/blob/develop/rm/src/main/java/com/alibaba/fescar/rm/AbstractRMHandler.java" target="_blank" rel="noopener noreferrer">AbstractRMHandler</a>类的doBranchRollback方法中接收这个rollback的通知</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected void doBranchRollback(BranchRollbackRequest request, BranchRollbackResponse response) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String xid = request.getXid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long branchId = request.getBranchId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resourceId = request.getResourceId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String applicationData = request.getApplicationData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;Branch rolling back: &quot; + xid + &quot; &quot; + branchId + &quot; &quot; + resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BranchStatus status = getResourceManager().branchRollback(request.getBranchType(), xid, branchId, resourceId, applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response.setBranchStatus(status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;Branch rollback result: &quot; + status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后将rollback请求传递到<code>DataSourceManager</code>类的branchRollback方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public BranchStatus branchRollback(BranchType branchType, String xid, long branchId, String resourceId, String applicationData) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //根据resourceId获取对应的数据源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DataSourceProxy dataSourceProxy = get(resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dataSourceProxy == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ShouldNeverHappenException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UndoLogManager.undo(dataSourceProxy, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (TransactionException te) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (te.getCode() == TransactionExceptionCode.BranchRollbackFailed_Unretriable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return BranchStatus.PhaseTwo_RollbackFailed_Unretryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return BranchStatus.PhaseTwo_RollbackFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return BranchStatus.PhaseTwo_Rollbacked;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最终会执行<a href="https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/undo/UndoLogManager.java" target="_blank" rel="noopener noreferrer">UndoLogManager</a>类的undo方法，因为是纯jdbc操作代码比较长就不贴出来了，可以通过连接到github查看源码，说一下undo的具体流程</p><ol><li>根据xid和branchId查找PhaseOne阶段提交的undo_log</li><li>如果找到了就根据undo_log中记录的数据生成回放sql并执行，即还原PhaseOne阶段修改的数据</li><li>第2步处理完后，删除该条undo_log数据</li><li>如果第1步没有找到对应的undo_log，就插入一条状态为<code>GlobalFinished</code>的undo_log.
出现没找到的原因可能是PhaseOne阶段的本地事务异常了，导致没有正常写入。
因为xid和branchId是唯一索引，所以第4步的插入，可以防止PhaseOne阶段恢复后的成功写入，那么PhaseOne阶段就会异常，这样一来业务数据也就不会提交成功，数据达到了最终回滚了的效果</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>本地结合分布式业务场景，分析了fescar client侧的主要处理流程，对TM和RM角色的主要源码进行了解析，希望能对大家理解fescar的工作原理有所帮助。</p><p>随着fescar的快速迭代以及后期的Roadmap规划，假以时日相信fescar能够成为开源分布式事务的标杆解决方案。</p></div><footer class="row docusaurus-mt-lg"></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/page/4"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/page/6"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">
                  <div class="fs-12">
                    <div class="center-div">
                      <span>Apache Seata is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</span>
                    </div>
                    <br>
                    <div class="center-div">
                      <span>Copyright © 2023-2024, The Apache Software Foundation Apache Seata, Seata, Apache, Apache Incubator, the Apache feather, the Apache Incubator logo and the Apache Seata project logo are either registered trademarks or trademarks of the Apache Software Foundation.</span>
                      <br>
                    </div>
                    <br>
                  </div>
                  </div></div></div></footer></div>
<script src="/zh-cn/assets/js/runtime~main.97cc0e32.js"></script>
<script src="/zh-cn/assets/js/main.fb767bfe.js"></script>
</body>
</html>