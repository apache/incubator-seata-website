{
  "filename": "seata-ha-practice.md",
  "__html": "<h1>Seata 高可用部署实践</h1>\n<p>使用配置中心和数据库来实现 Seata 的高可用，以 Nacos 和 MySQL 为例，将<a href=\"https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-nacos/\">cloud-seata-nacos</a>应用部署到 Kubernetes 集群中</p>\n<h2>准备工作</h2>\n<p>需要准备可用的注册中心、配置中心 Nacos 和 MySQL，在大多数情况下，注册中心、配置中心和数据库都是已有的，不需要特别配置，在这个实践中，为了简单，只部署单机的注册中心、配置中心和数据库，假设他们是可靠的</p>\n<ul>\n<li>部署 Nacos</li>\n</ul>\n<p>在服务器部署 Nacos，开放 8848 端口，用于 seata-server 注册，服务器地址为 <code>192.168.199.2</code></p>\n<pre><code class=\"language-bash\">docker run --name nacos -p 8848:8848 -e MODE=standalone nacos/nacos-server\n</code></pre>\n<ul>\n<li>部署 MySQL</li>\n</ul>\n<p>部署一台MySQL 数据库，用于 seata-server 保存事务数据，服务器地址为 <code>192.168.199.2</code></p>\n<pre><code class=\"language-bash\">docker run --name mysql7 -p 30060:3306<span class=\"hljs-_\">-e</span> MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7.17\n</code></pre>\n<h2>部署 seata-server</h2>\n<ul>\n<li>创建seata-server需要的表</li>\n</ul>\n<p>具体的 SQL 参考 <a href=\"https://github.com/seata/seata/tree/develop/script/server/db\">script/server/db</a>，这里使用的是 MySQL 的脚本，数据库名称为 <code>seata</code></p>\n<p>同时，也需要创建 undo_log 表， 可以参考 <a href=\"https://github.com/seata/seata/blob/develop/script/client/at/db/\">script/client/at/db/</a></p>\n<ul>\n<li>修改seata-server配置</li>\n</ul>\n<p>将以下配置添加到配置中心，具体添加方法可以参考 <a href=\"https://github.com/seata/seata/tree/develop/script/config-center\">script/config-center</a></p>\n<pre><code>service.vgroupMapping.my_test_tx_group=default\nstore.mode=db\nstore.db.datasource=druid\nstore.db.dbType=mysql\nstore.db.driverClassName=com.mysql.jdbc.Driver\nstore.db.url=jdbc:mysql://192.168.199.2:30060/seata?useUnicode=true\nstore.db.user=root\nstore.db.password=123456\n</code></pre>\n<h3>部署 seata-server 到 Kubernetes</h3>\n<ul>\n<li>seata-server.yaml</li>\n</ul>\n<p>需要将 ConfigMap 的注册中心和配置中心地址改成相应的地址</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Service</span>\n<span class=\"hljs-attr\">metadata:</span>\n<span class=\"hljs-attr\">  name:</span> <span class=\"hljs-string\">seata-ha-server</span>\n<span class=\"hljs-attr\">  namespace:</span> <span class=\"hljs-string\">default</span>\n<span class=\"hljs-attr\">  labels:</span>\n    <span class=\"hljs-string\">app.kubernetes.io/name:</span> <span class=\"hljs-string\">seata-ha-server</span>\n<span class=\"hljs-attr\">spec:</span>\n<span class=\"hljs-attr\">  type:</span> <span class=\"hljs-string\">ClusterIP</span>\n<span class=\"hljs-attr\">  ports:</span>\n<span class=\"hljs-attr\">    - port:</span> <span class=\"hljs-number\">8091</span>\n<span class=\"hljs-attr\">      protocol:</span> <span class=\"hljs-string\">TCP</span>\n<span class=\"hljs-attr\">      name:</span> <span class=\"hljs-string\">http</span>\n<span class=\"hljs-attr\">  selector:</span>\n    <span class=\"hljs-string\">app.kubernetes.io/name:</span> <span class=\"hljs-string\">seata-ha-server</span>\n\n<span class=\"hljs-meta\">---</span>\n\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Deployment</span>\n<span class=\"hljs-attr\">metadata:</span>\n<span class=\"hljs-attr\">  name:</span> <span class=\"hljs-string\">seata-ha-server</span>\n<span class=\"hljs-attr\">  namespace:</span> <span class=\"hljs-string\">default</span>\n<span class=\"hljs-attr\">  labels:</span>\n    <span class=\"hljs-string\">app.kubernetes.io/name:</span> <span class=\"hljs-string\">seata-ha-server</span>\n<span class=\"hljs-attr\">spec:</span>\n<span class=\"hljs-attr\">  replicas:</span> <span class=\"hljs-number\">3</span>\n<span class=\"hljs-attr\">  selector:</span>\n<span class=\"hljs-attr\">    matchLabels:</span>\n      <span class=\"hljs-string\">app.kubernetes.io/name:</span> <span class=\"hljs-string\">seata-ha-server</span>\n<span class=\"hljs-attr\">  template:</span>\n<span class=\"hljs-attr\">    metadata:</span>\n<span class=\"hljs-attr\">      labels:</span>\n        <span class=\"hljs-string\">app.kubernetes.io/name:</span> <span class=\"hljs-string\">seata-ha-server</span>\n<span class=\"hljs-attr\">    spec:</span>\n<span class=\"hljs-attr\">      containers:</span>\n<span class=\"hljs-attr\">        - name:</span> <span class=\"hljs-string\">seata-ha-server</span>\n<span class=\"hljs-attr\">          image:</span> <span class=\"hljs-string\">docker.io/seataio/seata-server:latest</span>\n<span class=\"hljs-attr\">          imagePullPolicy:</span> <span class=\"hljs-string\">IfNotPresent</span>\n<span class=\"hljs-attr\">          env:</span>\n<span class=\"hljs-attr\">            - name:</span> <span class=\"hljs-string\">SEATA_CONFIG_NAME</span>\n<span class=\"hljs-attr\">              value:</span> <span class=\"hljs-attr\">file:/root/seata-config/registry</span>\n<span class=\"hljs-attr\">          ports:</span>\n<span class=\"hljs-attr\">            - name:</span> <span class=\"hljs-string\">http</span>\n<span class=\"hljs-attr\">              containerPort:</span> <span class=\"hljs-number\">8091</span>\n<span class=\"hljs-attr\">              protocol:</span> <span class=\"hljs-string\">TCP</span>\n<span class=\"hljs-attr\">          volumeMounts:</span>\n<span class=\"hljs-attr\">            - name:</span> <span class=\"hljs-string\">seata-config</span>\n<span class=\"hljs-attr\">              mountPath:</span> <span class=\"hljs-string\">/root/seata-config</span>\n<span class=\"hljs-attr\">      volumes:</span>\n<span class=\"hljs-attr\">        - name:</span> <span class=\"hljs-string\">seata-config</span>\n<span class=\"hljs-attr\">          configMap:</span>\n<span class=\"hljs-attr\">            name:</span> <span class=\"hljs-string\">seata-ha-server-config</span>\n\n\n<span class=\"hljs-meta\">---</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">ConfigMap</span>\n<span class=\"hljs-attr\">metadata:</span>\n<span class=\"hljs-attr\">  name:</span> <span class=\"hljs-string\">seata-ha-server-config</span>\n<span class=\"hljs-attr\">data:</span>\n  <span class=\"hljs-string\">registry.conf:</span> <span class=\"hljs-string\">|\n    registry {\n        type = \"nacos\"\n        nacos {\n          application = \"seata-server\"\n          serverAddr = \"192.168.199.2\"\n        }\n    }\n    config {\n      type = \"nacos\"\n      nacos {\n        serverAddr = \"192.168.199.2\"\n        group = \"SEATA_GROUP\"\n      }\n    }\n</span></code></pre>\n<ul>\n<li>部署</li>\n</ul>\n<pre><code class=\"language-bash\">kubectl apply -f seata-server.yaml\n</code></pre>\n<p>部署完成后，会有三个 pod</p>\n<pre><code class=\"language-bash\">kubectl get pod | grep seata-ha-server\n\nseata-ha-server-645844b8b6-9qh5j    1/1     Running   0          3m14s\nseata-ha-server-645844b8b6-pzczs    1/1     Running   0          3m14s\nseata-ha-server-645844b8b6-wkpw8    1/1     Running   0          3m14s\n</code></pre>\n<p>待启动完成后，可以在 Nacos 的服务列表中发现三个 seata-server 的实例，至此，已经完成 seata-server 的高可用部署</p>\n<h2>部署服务</h2>\n<ul>\n<li>创建业务表并初始化数据</li>\n</ul>\n<p>具体的业务表可以参考 <a href=\"https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-nacos/README.md\">cloud-seata-nacos/README.md</a></p>\n<ul>\n<li>添加 Nacos 配置</li>\n</ul>\n<p>在 public 的命名空间下，分别创建 data-id 为 <code>order-service.properties</code>, <code>pay-service.properties</code>, <code>storage-service.properties</code> 的配置，内容相同，需要修改数据库的地址、用户名和密码</p>\n<pre><code># MySQL\nspring.datasource.url=jdbc:mysql://192.168.199.2:30060/seata?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false\nspring.datasource.username=root\nspring.datasource.password=123456\nspring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver\n# Seata\nspring.cloud.alibaba.seata.tx-service-group=my_test_tx_group\n</code></pre>\n<ul>\n<li>部署服务</li>\n</ul>\n<p>通过 application.yaml 配置文件部署服务，需要注意的是修改 ConfigMap 的 <code>NACOS_ADDR</code>为自己的 Nacos 地址</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Service</span>\n<span class=\"hljs-attr\">metadata:</span>\n<span class=\"hljs-attr\">  namespace:</span> <span class=\"hljs-string\">default</span>\n<span class=\"hljs-attr\">  name:</span> <span class=\"hljs-string\">seata-ha-service</span>\n<span class=\"hljs-attr\">  labels:</span>\n    <span class=\"hljs-string\">app.kubernetes.io/name:</span> <span class=\"hljs-string\">seata-ha-service</span>\n<span class=\"hljs-attr\">spec:</span>\n<span class=\"hljs-attr\">  type:</span> <span class=\"hljs-string\">NodePort</span>\n<span class=\"hljs-attr\">  ports:</span>\n<span class=\"hljs-attr\">    - port:</span> <span class=\"hljs-number\">8081</span>\n<span class=\"hljs-attr\">      nodePort:</span> <span class=\"hljs-number\">30081</span>\n<span class=\"hljs-attr\">      protocol:</span> <span class=\"hljs-string\">TCP</span>\n<span class=\"hljs-attr\">      name:</span> <span class=\"hljs-string\">http</span>\n<span class=\"hljs-attr\">  selector:</span>\n    <span class=\"hljs-string\">app.kubernetes.io/name:</span> <span class=\"hljs-string\">seata-ha-service</span>\n\n<span class=\"hljs-meta\">---</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">ConfigMap</span>\n<span class=\"hljs-attr\">metadata:</span>\n<span class=\"hljs-attr\">  name:</span> <span class=\"hljs-string\">seata-ha-service-config</span>\n<span class=\"hljs-attr\">data:</span>\n<span class=\"hljs-attr\">  NACOS_ADDR:</span> <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.199</span><span class=\"hljs-number\">.2</span><span class=\"hljs-string\">:8848</span>\n\n<span class=\"hljs-meta\">---</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Deployment</span>\n<span class=\"hljs-attr\">metadata:</span>\n<span class=\"hljs-attr\">  namespace:</span> <span class=\"hljs-string\">default</span>\n<span class=\"hljs-attr\">  name:</span> <span class=\"hljs-string\">seata-ha-service</span>\n<span class=\"hljs-attr\">  labels:</span>\n    <span class=\"hljs-string\">app.kubernetes.io/name:</span> <span class=\"hljs-string\">seata-ha-service</span>\n<span class=\"hljs-attr\">spec:</span>\n<span class=\"hljs-attr\">  replicas:</span> <span class=\"hljs-number\">1</span>\n<span class=\"hljs-attr\">  selector:</span>\n<span class=\"hljs-attr\">    matchLabels:</span>\n      <span class=\"hljs-string\">app.kubernetes.io/name:</span> <span class=\"hljs-string\">seata-ha-service</span>\n<span class=\"hljs-attr\">  template:</span>\n<span class=\"hljs-attr\">    metadata:</span>\n<span class=\"hljs-attr\">      labels:</span>\n        <span class=\"hljs-string\">app.kubernetes.io/name:</span> <span class=\"hljs-string\">seata-ha-service</span>\n<span class=\"hljs-attr\">    spec:</span>\n<span class=\"hljs-attr\">      serviceAccountName:</span> <span class=\"hljs-string\">springcloud</span>\n<span class=\"hljs-attr\">      containers:</span>\n<span class=\"hljs-attr\">        - name:</span> <span class=\"hljs-string\">seata-ha-order-service</span>\n<span class=\"hljs-attr\">          image:</span> <span class=\"hljs-string\">\"registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-order-service:1.1\"</span>\n<span class=\"hljs-attr\">          imagePullPolicy:</span> <span class=\"hljs-string\">IfNotPresent</span>\n<span class=\"hljs-attr\">          env:</span>\n<span class=\"hljs-attr\">            - name:</span> <span class=\"hljs-string\">NACOS_ADDR</span>\n<span class=\"hljs-attr\">              valueFrom:</span>\n<span class=\"hljs-attr\">                configMapKeyRef:</span>\n<span class=\"hljs-attr\">                  key:</span> <span class=\"hljs-string\">NACOS_ADDR</span>\n<span class=\"hljs-attr\">                  name:</span> <span class=\"hljs-string\">seata-ha-service-config</span>\n<span class=\"hljs-attr\">          ports:</span>\n<span class=\"hljs-attr\">            - name:</span> <span class=\"hljs-string\">http</span>\n<span class=\"hljs-attr\">              containerPort:</span> <span class=\"hljs-number\">8081</span>\n<span class=\"hljs-attr\">              protocol:</span> <span class=\"hljs-string\">TCP</span>\n<span class=\"hljs-attr\">        - name:</span> <span class=\"hljs-string\">seata-ha-pay-service</span>\n<span class=\"hljs-attr\">          image:</span> <span class=\"hljs-string\">\"registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-pay-service:1.1\"</span>\n<span class=\"hljs-attr\">          imagePullPolicy:</span> <span class=\"hljs-string\">IfNotPresent</span>\n<span class=\"hljs-attr\">          env:</span>\n<span class=\"hljs-attr\">            - name:</span> <span class=\"hljs-string\">NACOS_ADDR</span>\n<span class=\"hljs-attr\">              valueFrom:</span>\n<span class=\"hljs-attr\">                configMapKeyRef:</span>\n<span class=\"hljs-attr\">                  key:</span> <span class=\"hljs-string\">NACOS_ADDR</span>\n<span class=\"hljs-attr\">                  name:</span> <span class=\"hljs-string\">seata-ha-service-config</span>\n<span class=\"hljs-attr\">          ports:</span>\n<span class=\"hljs-attr\">            - name:</span> <span class=\"hljs-string\">http</span>\n<span class=\"hljs-attr\">              containerPort:</span> <span class=\"hljs-number\">8082</span>\n<span class=\"hljs-attr\">              protocol:</span> <span class=\"hljs-string\">TCP</span>\n<span class=\"hljs-attr\">        - name:</span> <span class=\"hljs-string\">seata-ha-storage-service</span>\n<span class=\"hljs-attr\">          image:</span> <span class=\"hljs-string\">\"registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-storage-service:1.1\"</span>\n<span class=\"hljs-attr\">          imagePullPolicy:</span> <span class=\"hljs-string\">IfNotPresent</span>\n<span class=\"hljs-attr\">          env:</span>\n<span class=\"hljs-attr\">            - name:</span> <span class=\"hljs-string\">NACOS_ADDR</span>\n<span class=\"hljs-attr\">              valueFrom:</span>\n<span class=\"hljs-attr\">                configMapKeyRef:</span>\n<span class=\"hljs-attr\">                  key:</span> <span class=\"hljs-string\">NACOS_ADDR</span>\n<span class=\"hljs-attr\">                  name:</span> <span class=\"hljs-string\">seata-ha-service-config</span>\n<span class=\"hljs-attr\">          ports:</span>\n<span class=\"hljs-attr\">            - name:</span> <span class=\"hljs-string\">http</span>\n<span class=\"hljs-attr\">              containerPort:</span> <span class=\"hljs-number\">8083</span>\n<span class=\"hljs-attr\">              protocol:</span> <span class=\"hljs-string\">TCP</span>\n</code></pre>\n<p>通过以下命令，将应用部署到集群中</p>\n<pre><code class=\"language-bash\">kubectl apply -f application.yaml\n</code></pre>\n<p>然后查看创建的 pod，seata-ha-service 这个服务下有三个 pod</p>\n<pre><code class=\"language-bash\">kubectl get pod | grep seata-ha-service\n\nseata-ha-service-7dbdc6894b-5r8q4      3/3     Running   0          12m\n</code></pre>\n<p>待应用启动后，在 Nacos 的服务列表中，会有相应的服务</p>\n<p><img src=\"/img/blog/seata-ha-service-list.png\" alt=\"seata-ha-service-list.png\"></p>\n<p>此时查看服务的日志，会看到服务向每一个 TC 都注册了</p>\n<p><img src=\"/img/blog/seata-ha-service-register.png\" alt=\"seata-ha-service-register.png\"></p>\n<h2>测试</h2>\n<ul>\n<li>测试成功场景</li>\n</ul>\n<p>调用 placeOrder 接口，将 price 设置为 1，此时余额为 10，可以下单成功</p>\n<pre><code class=\"language-bash\">curl -X POST \\\n  http://192.168.199.2:30081/order/placeOrder \\\n  -H <span class=\"hljs-string\">'Content-Type: application/json'</span> \\\n  -d <span class=\"hljs-string\">'{\n    \"userId\": 1,\n    \"productId\": 1,\n    \"price\": 1\n}'</span>\n</code></pre>\n<p>此时返回结果为：</p>\n<pre><code class=\"language-json\">{<span class=\"hljs-attr\">\"success\"</span>:<span class=\"hljs-literal\">true</span>,<span class=\"hljs-attr\">\"message\"</span>:<span class=\"hljs-literal\">null</span>,<span class=\"hljs-attr\">\"data\"</span>:<span class=\"hljs-literal\">null</span>}\n</code></pre>\n<ul>\n<li>测试失败场景</li>\n</ul>\n<p>设置 price 为 100，此时余额不足，会下单失败，pay-service会抛出异常，事务会回滚</p>\n<pre><code class=\"language-bash\">curl -X POST \\\n  http://192.168.199.2:30081/order/placeOrder \\\n  -H <span class=\"hljs-string\">'Content-Type: application/json'</span> \\\n  -d <span class=\"hljs-string\">'{\n    \"userId\": 1,\n    \"productId\": 1,\n    \"price\": 100\n}'</span>\n</code></pre>\n<p>多次调用查看服务日志，发现会随机的向其中某台TC发起事务注册，当扩容或缩容后，有相应的 TC 参与或退出</p>\n",
  "link": "/zh-cn/blog/seata-ha-practice.html",
  "meta": {
    "hidden": "true",
    "title": "Seata 高可用部署实践",
    "keywords": "kubernetes,ops",
    "description": "Seata 高可用部署实践",
    "author": "helloworlde",
    "date": "2020-04-10"
  }
}