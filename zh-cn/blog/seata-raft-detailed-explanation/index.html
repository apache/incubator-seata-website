<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Seata-Raft 存储模式详解及入门 | Apache Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.apache.org/zh-cn/img/seata_logo.png"><meta data-rh="true" name="twitter:image" content="https://seata.apache.org/zh-cn/img/seata_logo.png"><meta data-rh="true" property="og:url" content="https://seata.apache.org/zh-cn/blog/seata-raft-detailed-explanation"><meta data-rh="true" property="og:locale" content="zh_CN"><meta data-rh="true" property="og:locale:alternate" content="en_US"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Seata-Raft 存储模式详解及入门 | Apache Seata"><meta data-rh="true" name="description" content="从传统的存算分离，再到及存算一体化依靠分布式一致性算法保证事务数据一致性下的高可用模式，Seata 2.x做出了哪些改动？本文将详细介绍架构，及性能比对"><meta data-rh="true" property="og:description" content="从传统的存算分离，再到及存算一体化依靠分布式一致性算法保证事务数据一致性下的高可用模式，Seata 2.x做出了哪些改动？本文将详细介绍架构，及性能比对"><meta data-rh="true" name="keywords" content="fescar、seata、分布式事务,raft"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-10-13T00:00:00.000Z"><link data-rh="true" rel="icon" href="/zh-cn/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.apache.org/zh-cn/blog/seata-raft-detailed-explanation"><link data-rh="true" rel="alternate" href="https://seata.apache.org/blog/seata-raft-detailed-explanation" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.apache.org/zh-cn/blog/seata-raft-detailed-explanation" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.apache.org/blog/seata-raft-detailed-explanation" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ICHFIJRDZF-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Apache Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Apache Seata Atom Feed">


<link rel="search" type="application/opensearchdescription+xml" title="Apache Seata" href="/zh-cn/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=seata"><link rel="stylesheet" href="/zh-cn/assets/css/styles.9644caf2.css">
<script src="/zh-cn/assets/js/runtime~main.6db9ffb7.js" defer="defer"></script>
<script src="/zh-cn/assets/js/main.09bc4e66.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/overview/what-is-seata" href="/zh-cn/docs/overview/what-is-seata">v2.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-cn/docs/next/overview/what-is-seata">预览版</a></li><li><a class="dropdown__link" href="/zh-cn/docs/overview/what-is-seata">v2.0</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.8/overview/what-is-seata">v1.8</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.7/overview/what-is-seata">v1.7</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.6/overview/what-is-seata">v1.6</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.5/overview/what-is-seata">v1.5</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.4/overview/what-is-seata">v1.4</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.3/overview/what-is-seata">v1.3</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.2/overview/what-is-seata">v1.2</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.1/overview/what-is-seata">v1.1</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.0/overview/what-is-seata">v1.0</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/contributor-guide/new-contributor-guide_dev">开发者</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/users">用户</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a class="navbar__item navbar__link" href="/zh-cn/unversioned/download/seata-server">下载</a><a class="navbar__item navbar__link" href="/zh-cn/solution">解决方案</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">设计器</a><ul class="dropdown__menu"><li><a href="/zh-cn/saga-designer" class="dropdown__link" target="_blank">Saga 设计器</a></li><li><a href="/zh-cn/saga-designer-legacy" class="dropdown__link" target="_blank">Saga 设计器（旧版）</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/blog/seata-raft-detailed-explanation" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/seata-raft-detailed-explanation" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-multi-protocol01">Seata的RPC通信源码分析01：传输篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-multi-protocol02">Seata的RPC通信源码分析02：协议篇（多版本协议）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/how-to-write-unit-tests">如何在seata中编写测试用例</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/explore-seata-journey">探索 Seata 项目开源开发之旅</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zh-cn/blog/seata-raft-detailed-explanation">Seata-Raft 存储模式详解及入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-observable-practice">Seata的可观测实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-lock">详解 Seata AT 模式事务隔离级别与全局锁设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-snowflake-explain">关于新版雪花算法的答疑</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-UUID-generator">Seata基于改良版雪花算法的分布式UUID生成器分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-feature-undo-log-compress">Seata新特性支持 -- undo_log压缩</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dsproxy-deadlock">ConcurrentHashMap导致的Seata死锁问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-02">Seata应用侧启动过程剖析——注册中心与配置中心模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-01">Seata应用侧启动过程剖析——RM &amp; TM如何与TC建立连接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-tcc-mode-with-spring-cloud">Spring Cloud集成Seata分布式事务-TCC模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-manager">Seata配置管理原理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-golang-communication-mode">seata-golang 通信模型详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-datasource-proxy">Seata数据源代理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-demo-in-mac">Mac下的Seata Demo环境搭建（AT模式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-quick-start">Seata 极简入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-ha-practice">Seata 高可用部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-center">Seata 配置中心实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/quick-start-use-seata-and-dubbo-services">如何使用Seata保证Dubbo微服务间的一致性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/manual-transaction-mode">MT 模式</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="从传统的存算分离，再到及存算一体化依靠分布式一致性算法保证事务数据一致性下的高可用模式，Seata 2.x做出了哪些改动？本文将详细介绍架构，及性能比对"><meta itemprop="keywords" content="fescar、seata、分布  式事务,raft"><header><h1 class="title_f1Hy" itemprop="headline">Seata-Raft 存储模式详解及入门</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-10-13T00:00:00.000Z" itemprop="datePublished">2023年10月13日</time> · <!-- -->阅读需 24 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">funkye</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><ul>
<li><a href="#">1. 概述</a></li>
<li><a href="#">2. 架构介绍</a></li>
<li><a href="#">3. 使用部署</a></li>
<li><a href="#">4. 压测对比</a></li>
<li><a href="#">5. 总结</a></li>
</ul>
<p>Seata 是一款开源的分布式事务解决方案，star高达24000+，社区活跃度极高，致力于在微服务架构下提供高性能和简单易用的分布式事务服务.</p>
<p>目前Seata的分布式事务数据存储模式有file，db，redis，而本篇文章将Seata-Server Raft模式的架构，部署使用，压测对比，及为什么Seata需要Raft,并领略从调研对比,设计,到具体实现,再到知识沉淀的过程.</p>
<p>分享人：陈健斌（funkye） github id: <a href="https://github.com/funky-eyes" target="_blank" rel="noopener noreferrer">funky-eyes</a></p>
<h1>2. 架构介绍</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-raft-模式是什么">2.1 Raft 模式是什么？<a href="#21-raft-模式是什么" class="hash-link" aria-label="2.1 Raft 模式是什么？的直接链接" title="2.1 Raft 模式是什么？的直接链接">​</a></h2>
<p>首先需要明白什么是raft分布式一致性算法,这里直接摘抄sofa-jraft官网的相关介绍:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RAFT 是一种新型易于理解的分布式一致性复制协议，由斯坦福大学的 Diego Ongaro 和 John Ousterhout 提出，作为 RAMCloud 项目中的中心协调组件。Raft 是一种 Leader-Based 的 Multi-Paxos 变种，相比 Paxos、Zab、View Stamped Replication 等协议提供了更完整更清晰的协议描述，并提供了清晰的节点增删描述。 Raft 作为复制状态机，是分布式系统中最核心最基础的组件，提供命令在多个节点之间有序复制和执行，当多个节点初始状态一致的时候，保证节点之间状态一致。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">简而言之Seata的Raft模式就是基于Sofa-Jraft组件实现可保证Seata-Server自身的数据一致性和服务高可用.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-为什么需要raft模式">2.2 为什么需要raft模式<a href="#22-为什么需要raft模式" class="hash-link" aria-label="2.2 为什么需要raft模式的直接链接" title="2.2 为什么需要raft模式的直接链接">​</a></h2>
<p>看完上述的Seata-Raft模式是什么的定义后,是否就有疑问,难道现在Seata-Server就无法保证一致性和高可用了吗?那么下面从一致性和高可用来看看目前Seata-Server是如何做的.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="221-现有存储模式">2.2.1 现有存储模式<a href="#221-现有存储模式" class="hash-link" aria-label="2.2.1 现有存储模式的直接链接" title="2.2.1 现有存储模式的直接链接">​</a></h3>
<p>在当前的 Seata 设计中，Server 端的作用是保证事务的二阶段被正确执行。然而，这取决于事务记录的正确存储。为确保事务记录不丢失，需要在保持状态正确的前提下，驱动所有的 Seata-RM 执行正确的二阶段行为。那么，Seata 目前是如何存储事务状态和记录的呢？</p>
<p>首先介绍一下 Seata 支持的三种事务存储模式：file、db 和 redis。根据一致性的排名，db 模式下的事务记录可以得到最好的保证，其次是 file 模式的异步刷盘，最后是 redis 模式下的 aof 和 rdb</p>
<p>顾名思义:</p>
<ul>
<li>file 模式是 Seata 自实现的事务存储方式，它以顺序写的形式将事务信息存储到本地磁盘上。为了兼顾性能，默认采用异步方式，并将事务信息存储在内存中，确保内存和磁盘上的数据一致性。当 Seata-Server（TC）意外宕机时，在重新启动时会从磁盘读取事务信息并恢复到内存中，以便继续运行事务上下文。</li>
<li>db 是 Seata 的抽象事务存储管理器（AbstractTransactionStoreManager）的另一种实现方式。它依赖于数据库，如 PostgreSQL、MySQL、Oracle 等，在数据库中进行事务信息的增删改查操作。一致性由数据库的本地事务保证，数据也由数据库负责持久化到磁盘。</li>
<li>redis 和 db 类似，也是一种事务存储方式。它利用 Jedis 和 Lua 脚本来进行事务的增删改查操作，部分操作（  如竞争锁）在 Seata 2.x 版本中全部采用了 Lua 脚本。数据的存储与 db 类似，依赖于存储方（Redis）来保证数据的一致性。与 db 类似，redis 在 Seata 中采用了计算和存储分离的架构设计.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="222-高可用">2.2.2 高可用<a href="#222-高可用" class="hash-link" aria-label="2.2.2 高可用的直接链接" title="2.2.2 高可用的直接链接">​</a></h3>
<p>高可用简单理解就是集群能够在主节点宕机后继续正常运行，常见的方式是通过部署多个提供相同服务的节点，并通过注册中心实时感知主节点的上下线情况，以便及时切换到可用的节点。</p>
<p>看起来似乎只需要加几台机器进行部署，但实际上背后存在一个问题，即如何确保多个节点像一个整体一样运作。如果其中一个节点宕机，另一个节点能够完美接替宕机节点的工作，包括处理宕机节点的数据。解决这个问题的答案其实很简单，在计算与存储分离的架构下，只需将数据存储在共享的存储中间件中，任何一个节点都可以通过访问该公共存储区域获取所有节点操作的事务信息，从而实现高可用的能力。</p>
<p>然而，前提条件是计算与存储必须分离。为什么计算与存储一体化设计不可行呢？这就要说到 File 模式的实现了。如之前描述的，File 模式将数据存储在本地磁盘和节点内存中，数据写操作没有任何同步，这意味着目前的 File 模式无法实现高可用，仅支持单机部署。作为初级的快速入门和简单使用而言，File 模式适用性较低，高性能的基于内存的 File 模式也基本上不再被生产环境使用。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="23-seata-raft是如何设计的呢">2.3 Seata-Raft是如何设计的呢？<a href="#23-seata-raft是如何设计的呢" class="hash-link" aria-label="2.3 Seata-Raft是如何设计的呢？的直接链接" title="2.3 Seata-Raft是如何设计的呢？的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="231-设计原理">2.3.1 设计原理<a href="#231-设计原理" class="hash-link" aria-label="2.3.1 设计原理的直接链接" title="2.3.1 设计原理的直接链接">​</a></h3>
<p>Seata-Raft模式的设计思路是通过封装无法高可用的file模式，利用Raft算法实现多个TC之间数据的同步。该模式保证了使用file模式时多个TC的数据一致性，同时将异步刷盘操作改为使用Raft日志和快照进行数据恢复。
<img decoding="async" loading="lazy" alt="流程图" src="/zh-cn/assets/images/Dingtalk_20230105203431-6a34d0f29cb4b8663f604d87cd73920c.jpg" width="600" height="467" class="img_ev3q"></p>
<p>在Seata-Raft模式中，client端在启动时会从配置中心获取当前client的事务分组（例如default）以及相关Raft集群节点的IP地址。通过向Seata-Server的控制端口发送请求，client可以获取到default分组对应的Raft集群的元数据，包括leader、follower和learner成员节点。然后，client会监视（watch）非leader节点的任意成员节点。</p>
<p>假设TM开始一个事务，并且本地的metadata中的leader节点指向了TC1的地址，那么TM只会与TC1进行交互。当TC1添加一个全局事务信息时，通过Raft协议，即图中标注为步骤1的日志发送，TC1会将日志发送给其他节点，步骤2是follower节点响应日志接收情况。当超过半数的节点（如TC2）接受并响应成功时，TC1上的状态机（FSM）将执行添加全局事务的动作。</p>
<p><img decoding="async" loading="lazy" alt="watch" src="/zh-cn/assets/images/Dingtalk_20230105204423-03b6eb78f785f04c532df8119fe9ddc9.jpg" width="815" height="591" class="img_ev3q">
<img decoding="async" loading="lazy" alt="watch2" src="/zh-cn/assets/images/Dingtalk_20230105211035-6a61157bb4bb72208c63caf3dd647856.jpg" width="808" height="595" class="img_ev3q"></p>
<p>如果TC1宕机或发生重选举，会发生什么呢？由于首次启动时已经获取到了元数据，client会执行watch follower节点的接口来更新本地的metadata信息。因此，后续的事务请求将发送到新的leader（例如TC2）。同时，TC1的数据已经被同步到了TC2和TC3，因此数据一致性不会受到影响。只在选举发生的瞬间，如果某个事务正好发送给了旧的leader，该事务会被主动回滚，以确保数据的正确性。</p>
<p>需要注意的是，在该模式下，如果事务处于决议发送请求或一阶段流程还未走完的时刻，并且恰好在选举时发生，这些事务会被主动回滚。因为RPC节点已经宕机或发生了重选举，当前没有实现RPC重试。TM侧默认有5次重试机制，但由于选举需要大约1s-2s的时间，这些处于begin状态的事务可能无法成功决议，因此会优先回滚，释放锁，以避免影响其他业务的正确性。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="232-故障恢复">2.3.2 故障恢复<a href="#232-故障恢复" class="hash-link" aria-label="2.3.2 故障恢复的直接链接" title="2.3.2 故障恢复的直接链接">​</a></h3>
<p>在Seata中，当TC发生故障时，数据恢复的过程如下：</p>
<p><img decoding="async" loading="lazy" alt="故障恢复" src="/zh-cn/assets/images/Dingtalk_20230106231817-3ab6f266e902a1778a874edd974cfabd.jpg" width="835" height="572" class="img_ev3q"></p>
<p>如上图所示</p>
<ul>
<li>
<p>检查是否存在最新的数据快照：首先，系统会检查是否存在最新的数据快照文件。数据快照是基于内存的数据状态的一次全量拷贝，如果有最新的数据快照，则系统将直接加载该快照到内存中。</p>
</li>
<li>
<p>根据快照后的Raft日志进行回放：如果存在最新的快照或者没有快照文件，系统将根据之前记录的Raft日志进行数据回放。每个Seata-Server中的请求最终会经过ServerOnRequestProcessor进行处理，然后转移到具体 的协调者类(DefaultCoordinator或RaftCoordinator)中，再转向具体的业务代码(DefaultCore)进行相应的事务处理（如begin、commit、rollback等）。</p>
</li>
<li>
<p>当日志回放完成后，便会由leader发起日志的同步，并继续执行相关事务的增删改动作。f</p>
</li>
</ul>
<p>通过以上步骤，Seata能够实现在故障发生后的数据恢复。首先尝试加载最新的快照，如果有的话可以减少回放的时间；然后根据Raft日志进行回放，保证数据操作的一致性；最后通过日志同步机制，确保数据在多节点之间的一致性。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="233-业务处理同步过程">2.3.3 业务处理同步过程<a href="#233-业务处理同步过程" class="hash-link" aria-label="2.3.3 业务处理同步过程的直接链接" title="2.3.3 业务处理同步过程的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="流程" src="/zh-cn/assets/images/Dingtalk_20230106230931-89b853c79183f50afd746c4a662df1e7.jpg" width="1228" height="566" class="img_ev3q">
对于client侧获取最新metadata时恰好有业务线程在执行begin、commit或registry等操作的情况，Seata采取了以下处理方式：</p>
<ul>
<li>
<p>client侧：</p>
<ul>
<li>如果客户端正在执行begin、commit或registry等操作，并且此时需要获取最新metadata，由于此时的leader可能已经不存在或不是当前leader，因此客户端的RPC请求可能会失败。</li>
<li>如果请求失败，客户端会收到异常响应，此时客户端需要根据请求的结果进行回滚操作。</li>
</ul>
</li>
<li>
<p>TC侧对旧leader的检测：</p>
<ul>
<li>在TC侧，如果此时客户端的请求到达旧的leader节点，TC会进行当前是否是leader的检测，如果不是leader，则会拒绝该请求。</li>
<li>如果是leader但在中途失败，比如在提交任务到状态机的过程中失败，由于当前已经不是leader，创建任务（createTask）的动作会 失败。这样，客户端也会接收到响应异常。</li>
<li>旧leader的提交任务也会失败，确保了事务信息的一致性。
通过上述处理方式，当客户端获取最新metadata时恰好遇到业务操作的情况，Seata能够保证数据的一致性和事务的正确性。如果客户端的RPC请求失败，将触发回滚操作；而在TC侧，对旧leader的检测和任务提交的失败可以防止事务信息不一致的问题。这样，客户端的数据也能保持一致性。</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3使用部署">3.使用部署<a href="#3使用部署" class="hash-link" aria-label="3.使用部署的直接链接" title="3.使用部署的直接链接">​</a></h2>
<p>在使用和部署上，社区秉持着最小侵入，最小改动的原则，所以整体的部署上手应该是非常简单的，接下来分开client与server两端的部署改动点进行介绍</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-client">3.1 client<a href="#31-client" class="hash-link" aria-label="3.1 client的直接链接" title="3.1 client的直接链接">​</a></h3>
<p>首先，使用注册配置中心较多的同学应该知道Seata的配置项中有一个<code>seata.registry.type</code>的配置项，支持了nacos，zk，etcd，redis等等，而在2.0以后增加了一个raft的配置项</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      raft:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         server-addr: 192.168.0.111:7091, 192.168.0.112:7091, 192.168.0.113:7091</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将<code>registry.type</code> 改为raft，并配置raft相关元数据的获取地址，该地址统一为seata-server的ip+http端口
然后必不可少的就是传统的事务分组的配置</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">seata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   tx-service-group: default_tx_group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vgroup-mapping:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         default_tx_group: default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如现在使用的事务分组为<code>default_tx_group</code>，那么对应的seata集群/分组就是default，这个是有对应关系的，后续再server部署环节上会介绍
至此client的改动已经完成了</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-server">3.2 server<a href="#32-server" class="hash-link" aria-label="3.2 server的直接链接" title="3.2 server的直接链接">​</a></h3>
<p>对于server的改动可能会多一些，要熟悉一些调优参数和配置，当然也可以选择默认值不做任何修改</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">seata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    raft:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      group: default #此值代表该raft集群的group，client的事务分组对应的值要与之对应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      server-addr: 192.168.0.111:9091,192.168.0.112:9091,192.168.0.113:9091 # 3台节点的ip和端口，端口为该节点的netty端口+1000，默认netty端口为8091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      snapshot-interval: 600 # 600秒做一次数据的快照，以便raftlog的快速滚动，但是每次做快照如果内存中事务数据过多会导致每600秒产生一次业务rt的抖动，但是对于故障恢复比较友好，重启节点较快，可以调整为30分钟，1小时都行，具体按业务来，可以自行压测看看是否有抖动，在rt抖动和故障恢复中自行找个平衡点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      apply-batch: 32 # 最多批量32次动作做一次提交raftlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-append-bufferSize: 262144 #日志存储缓冲区最大大小，默认256K</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-replicator-inflight-msgs: 256 #在启用 pipeline 请求情况下，最大 in-flight 请求数，默认256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disruptor-buffer-size: 16384 #内部 disruptor buffer 大小，如果是写入吞吐量较高场景，需要适当调高该值，默认 16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      election-timeout-ms: 1000 #超过多久没有leader的心跳开始重选举</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reporter-enabled: false # raft自身的监控是否开启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reporter-initial-delay: 60 # 监控的区间间隔</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serialization: jackson # 序列化方式，不要改动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      compressor: none # raftlog的压缩方式，如gzip，zstd等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sync: true # raft日志的刷盘方式，默认是同步刷盘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: nacos, consul, apollo, zk, etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: file # 该配置可以选择不同的配置中心</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: nacos, eureka, redis, zk, consul, etcd3, sofa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: file # raft模式下不允许使用非file的其他注册中心</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  store:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: file 、 db 、 redis 、 raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode: raft # 使用raft存储模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dir: sessionStore # 该路径为raftlog及事务相关日志的存储位置，默认是相对路径，最好设置一个固定的位置</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在3个或者大于3个节点的seata-server中配置完以上参数后，直接启动便可以看到类似以下的日志输出,就代表集群已经正常启动了</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.392  WARN --- [Rpc-netty-server-worker-10-thread-1] [com.alipay.sofa.jraft.rpc.impl.BoltRaftRpcFactory] [ensurePipeline] []: JRaft SET bolt.rpc.dispatch-msg-list-in-default-executor to be false for replicator pipeline optimistic.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.439  INFO --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage] [save] []: Save raft meta, path=sessionStore/raft/9091/default/raft_meta, term=4, votedFor=0.0.0.0:0, cost time=25 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.441  WARN --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.core.NodeImpl] [handleAppendEntriesRequest] []: Node &lt;default/10.58.16.231:9091&gt; reject term_unmatched AppendEntriesRequest from 10.58.12.217:9091, term=4, prevLogIndex=4, prevLogTerm=4, localPrevLogTerm=0, lastLogIndex=0, entriesSize=0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.442  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onStartFollowing] []: groupId: default, onStartFollowing: LeaderChangeContext [leaderId=10.58.12.217:9091, term=4, status=Status[ENEWLEADER&lt;10011&gt;: Raft node receives message from new leader with higher term.]].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.449  WARN --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.core.NodeImpl] [handleAppendEntriesRequest] []: Node &lt;default/10.58.16.231:9091&gt; reject term_unmatched AppendEntriesRequest from 10.58.12.217:9091, term=4, prevLogIndex=4, prevLogTerm=4, localPrevLogTerm=0, lastLogIndex=0, entriesSize=0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.459  INFO --- [Bolt-default-executor-4-thread-1] [com.alipay.sofa.jraft.core.NodeImpl] [handleInstallSnapshot] []: Node &lt;default/10.58.16.231:9091&gt; received InstallSnapshotRequest from 10.58.12.217:9091, lastIncludedLogIndex=4, lastIncludedLogTerm=4, lastLogId=LogId [index=0, term=0].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.489  INFO --- [Bolt-conn-event-executor-13-thread-1] [com.alipay.sofa.jraft.rpc.impl.core.ClientServiceConnectionEventProcessor] [onEvent] []: Peer 10.58.12.217:9091 is connected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.519  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.util.Recyclers] [&lt;clinit&gt;] []: -Djraft.recyclers.maxCapacityPerThread: 4096.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.574  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.storage.snapshot.local.LocalSnapshotStorage] [destroySnapshot] []: Deleting snapshot sessionStore/raft/9091/default/snapshot/snapshot_4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.574  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.storage.snapshot.local.LocalSnapshotStorage] [close] []: Renaming sessionStore/raft/9091/default/snapshot/temp to sessionStore/raft/9091/default/snapshot/snapshot_4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.689  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.snapshot.session.SessionSnapshotFile] [load] []: on snapshot load start index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.snapshot.session.SessionSnapshotFile] [load] []: on snapshot load end index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onSnapshotLoad] []: groupId: default, onSnapshotLoad cost: 110 ms.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onConfigurationCommitted] []: groupId: default, onConfigurationCommitted: 10.58.12.165:9091,10.58.12.217:9091,10.58.16.231:9091.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.705  INFO --- [JRaft-FSMCaller-Disruptor-0] [com.alipay.sofa.jraft.storage.snapshot.SnapshotExecutorImpl] [onSnapshotLoadDone] []: Node &lt;default/10.58.16.231:9091&gt; onSnapshotLoadDone, last_included_index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">last_included_term: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: &quot;10.58.12.165:9091&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: &quot;10.58.12.217:9091&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: &quot;10.58.16.231:9091&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.722  INFO --- [JRaft-Group-Default-Executor-1] [com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage] [lambda$truncatePrefixInBackground$2] []: Truncated prefix logs in data path: sessionStore/raft/9091/default/log from log index 1 to 5, cost 0 ms.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-faq">3.3 faq<a href="#33-faq" class="hash-link" aria-label="3.3 faq的直接链接" title="3.3 faq的直接链接">​</a></h3>
<ul>
<li>当<code>seata.raft.server-addr</code>配置好后，必须通过server的openapi进行集群的扩缩容，直接改动该配置进行重启是不会生效的
接口为<code>/metadata/v1/changeCluster?raftClusterStr=新的集群列表</code></li>
<li>如果<code>server-addr:</code>中的地址都为本机，那么需要根据本机上不同的server的netty端口增加1000的偏移量，如<code>server.port: 7092</code>那么netty端口为8092，raft选举和通信端口便为9092，需要增加启动参数<code>-Dserver.raftPort=9092</code>.
Linux下可以通过<code>export JAVA_OPT=&quot;-Dserver.raftPort=9092&quot;</code>等方式指定。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4压测对比">4.压测对比<a href="#4压测对比" class="hash-link" aria-label="4.压测对比的直接链接" title="4.压测对比的直接链接">​</a></h2>
<p>压测对比分为两种场景,并且为了避免数据热点冲突与线程调优等情况,将Client侧的数据初始化300W条商品,并直接使用jdk21虚拟线程+spring boot3+seata AT来测试,在gc方面全部采用分代ZGC进行,压测工具为阿里云PTS，Server侧统一使用jdk21(目前还未适配虚拟线程) 服务器配置如下
TC: 4c8g<em>3  Client: 4c</em>8G*1  数据库为阿里云rds 4c16g</p>
<ul>
<li>64并发压测只增加<code>@Globaltransactional</code>注解接口空提交的性能</li>
<li>随机300W数据进行32并发10分钟的扣库存</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-171-db模式">4.1 1.7.1 db模式<a href="#41-171-db模式" class="hash-link" aria-label="4.1 1.7.1 db模式的直接链接" title="4.1 1.7.1 db模式的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN011dNh3H1UK8G5prQAg_!!6000000002498-0-tps-731-333.jpg" alt="raft压测模型" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="空提交-64c">空提交 64C<a href="#空提交-64c" class="hash-link" aria-label="空提交 64C的直接链接" title="空提交 64C的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01pE1Anf1nRtgcnlx9t_!!6000000005087-0-tps-622-852.jpg" alt="db64-2" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="随机扣库存-32c">随机扣库存 32C<a href="#随机扣库存-32c" class="hash-link" aria-label="随机扣库存 32C的直接链接" title="随机扣库存 32C的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN016hZkJC20OJax9ce31_!!6000000006839-0-tps-624-852.jpg" alt="db32-2" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-20-raft模式">4.2 2.0 raft模式<a href="#42-20-raft模式" class="hash-link" aria-label="4.2 2.0 raft模式的直接链接" title="4.2 2.0 raft模式的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01nNL6oe1X95YcQQEjs_!!6000000002880-0-tps-773-353.jpg" alt="raft压测模型" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="空提交-64c-1">空提交 64C<a href="#空提交-64c-1" class="hash-link" aria-label="空提交 64C的直接链接" title="空提交 64C的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01rs1ykr1dhnH8qnXj3_!!6000000003768-0-tps-631-851.jpg" alt="raft64-2" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="随机扣库存-32c-1">随机扣库存 32C<a href="#随机扣库存-32c-1" class="hash-link" aria-label="随机扣库存 32C的直接链接" title="随机扣库存 32C的直接链接">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN015OwA2k20enquV7Yfu_!!6000000006875-0-tps-624-856.jpg" alt="raft32c-2" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-压测结果对比">4.3 压测结果对比<a href="#43-压测结果对比" class="hash-link" aria-label="4.3 压测结果对比的直接链接" title="4.3 压测结果对比的直接链接">​</a></h3>
<p>32并发对300W商品随机扣库存场景</p>
<table><thead><tr><th>tps avg</th><th>tps max</th><th>count</th><th>rt</th><th>error</th><th>存储类型</th></tr></thead><tbody><tr><td>1709(42%↑)</td><td>2019(21%↑)</td><td>1228803(42%↑)</td><td>13.86ms(30%↓)</td><td>0</td><td>Raft</td></tr><tr><td>1201</td><td>1668</td><td>864105</td><td>19.86ms</td><td>0</td><td>DB</td></tr></tbody></table>
<p>64并发空压<code>@Globaltransactional</code>接口（压测峰值上限为8000）</p>
<table><thead><tr><th>tps avg</th><th>tps max</th><th>count</th><th>rt</th><th>error</th><th>存储类型</th></tr></thead><tbody><tr><td>5704(20%↑)</td><td>8062(30%↑)</td><td>4101236(20%↑)</td><td>7.79ms(19%↓)</td><td>0</td><td>Raft</td></tr><tr><td>4743</td><td>6172</td><td>3410240</td><td>9.65ms</td><td>0</td><td>DB</td></tr></tbody></table>
<p>除了以上数据上的直观对比,通过对压测的曲线图来观察,raft模式下tps与rt更加平稳,抖动更少,性能与吞吐量上更佳.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5总结">5.总结<a href="#5总结" class="hash-link" aria-label="5.总结的直接链接" title="5.总结的直接链接">​</a></h2>
<p>在Seata未来的发展中，性能、入门门槛、部署运维成本，都是我们需要关注和不断优化的方向，在raft模式推出后有以下几个特点:</p>
<ol>
<li>如存储方面，存算分离后Seata对其优化的上限被拔高，自主可控</li>
<li>部署成本更低，无需额外的注册中心，存储中间件</li>
<li>入门的门槛更低，无需学习其他的一些如注册中心的知识，一站式直接使用Seata Raft 即可上手</li>
</ol>
<p>针对业界发展趋势，一些开源项目如ClickHouse和Kafka已经开始放弃使用ZooKeeper，并转而采用自研的解决方案，比如ClickKeeper和KRaft。这些方案将元数据等信息交由自身保证存储，以减少对第三方依赖的需求，从而降低运维成本和学习成本。这些特性是非常成熟和可借鉴的。</p>
<p>当然，目前来看，基于Raft模式的解决方案可能还不够成熟，可能无法完全达到上述描述的那样美好。然而，正是因为存在这样的理论基础，社区更应该朝着这个方向努力，让实践逐步接近理论的要求。在这里，欢迎所有对Seata感兴趣的同学加入社区，共同为Seata添砖加瓦！</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col margin-top--sm"><a href="https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/zh-cn/docusaurus-plugin-content-blog/seata-raft-detailed-explanation.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/explore-seata-journey"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">探索 Seata 项目开源开发之旅</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/seata-connect-data-and-application"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Seata：连接数据与应用</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#21-raft-模式是什么" class="table-of-contents__link toc-highlight">2.1 Raft 模式是什么？</a></li><li><a href="#22-为什么需要raft模式" class="table-of-contents__link toc-highlight">2.2 为什么需要raft模式</a><ul><li><a href="#221-现有存储模式" class="table-of-contents__link toc-highlight">2.2.1 现有存储模式</a></li><li><a href="#222-高可用" class="table-of-contents__link toc-highlight">2.2.2 高可用</a></li></ul></li><li><a href="#23-seata-raft是如何设计的呢" class="table-of-contents__link toc-highlight">2.3 Seata-Raft是如何设计的呢？</a><ul><li><a href="#231-设计原理" class="table-of-contents__link toc-highlight">2.3.1 设计原理</a></li><li><a href="#232-故障恢复" class="table-of-contents__link toc-highlight">2.3.2 故障恢复</a></li><li><a href="#233-业务处理同步过程" class="table-of-contents__link toc-highlight">2.3.3 业务处理同步过程</a></li></ul></li><li><a href="#3使用部署" class="table-of-contents__link toc-highlight">3.使用部署</a><ul><li><a href="#31-client" class="table-of-contents__link toc-highlight">3.1 client</a></li><li><a href="#32-server" class="table-of-contents__link toc-highlight">3.2 server</a></li><li><a href="#33-faq" class="table-of-contents__link toc-highlight">3.3 faq</a></li></ul></li><li><a href="#4压测对比" class="table-of-contents__link toc-highlight">4.压测对比</a><ul><li><a href="#41-171-db模式" class="table-of-contents__link toc-highlight">4.1 1.7.1 db模式</a></li><li><a href="#42-20-raft模式" class="table-of-contents__link toc-highlight">4.2 2.0 raft模式</a></li><li><a href="#43-压测结果对比" class="table-of-contents__link toc-highlight">4.3 压测结果对比</a></li></ul></li><li><a href="#5总结" class="table-of-contents__link toc-highlight">5.总结</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">
                  <div class="fs-12">
                    <div class="center-div">
                      <span>Apache Seata (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</span>
                    </div>
                    <br>
                    <div class="center-div">
                      <span>Copyright © 2023-2024, The Apache Software Foundation Apache Seata, Seata, Apache, Apache Incubator, the Apache feather, the Apache Incubator logo and the Apache Seata project logo are either registered trademarks or trademarks of the Apache Software Foundation.</span>
                      <br>
                    </div>
                    <br>
                  </div>
                  </div></div></div></footer></div>
</body>
</html>