<!doctype html>
<html lang="en-US" dir="ltr" class="docs-wrapper docs-doc-page docs-version-v1.2 plugin-docs plugin-id-default docs-doc-id-user/appendix/isolation">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Transaction Isolation | Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://seata.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://seata.io/docs/v1.2/user/appendix/isolation"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v1.2"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v1.2"><meta data-rh="true" name="docsearch:version" content="v1.2"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v1.2"><meta data-rh="true" property="og:title" content="Transaction Isolation | Seata"><meta data-rh="true" name="description" content="Seata Transaction Isolation"><meta data-rh="true" property="og:description" content="Seata Transaction Isolation"><meta data-rh="true" name="keywords" content="Seata Transaction Isolation"><link data-rh="true" rel="icon" href="/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.io/docs/v1.2/user/appendix/isolation"><link data-rh="true" rel="alternate" href="https://seata.io/docs/v1.2/user/appendix/isolation" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.io/zh-cn/docs/v1.2/user/appendix/isolation" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.io/docs/v1.2/user/appendix/isolation" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ICHFIJRDZF-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Seata Atom Feed">


<link rel="search" type="application/opensearchdescription+xml" title="Seata" href="/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=seata">
<script src="https://www.googletagmanager.com/gtag/js?id=G-X4LJGF90X2" async></script><link rel="stylesheet" href="/assets/css/styles.b7817018.css">
<link rel="preload" href="/assets/js/runtime~main.c989ad4e.js" as="script">
<link rel="preload" href="/assets/js/main.db935d91.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="https://hm.baidu.com/hm.js?104e73ef0c18b416b27abb23757ed8ee"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/overview/what-is-seata" href="/docs/v1.2/overview/what-is-seata">v1.2</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/user/appendix/isolation">Next Version</a></li><li><a class="dropdown__link" href="/docs/user/appendix/isolation">v2.0</a></li><li><a class="dropdown__link" href="/docs/v1.8/user/appendix/isolation">v1.8</a></li><li><a class="dropdown__link" href="/docs/v1.7/user/appendix/isolation">v1.7</a></li><li><a class="dropdown__link" href="/docs/v1.6/user/appendix/isolation">v1.6</a></li><li><a class="dropdown__link" href="/docs/v1.5/user/appendix/isolation">v1.5</a></li><li><a class="dropdown__link" href="/docs/v1.4/user/appendix/isolation">v1.4</a></li><li><a class="dropdown__link" href="/docs/v1.3/user/appendix/isolation">v1.3</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/v1.2/user/appendix/isolation">v1.2</a></li><li><a class="dropdown__link" href="/docs/v1.1/user/appendix/isolation">v1.1</a></li><li><a class="dropdown__link" href="/docs/v1.0/user/appendix/isolation">v1.0</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/v1.2/developers/contributor-guide/new-contributor-guide_dev">Developers</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/unversioned/download/seata-server">Download</a><a href="http://demo.seata.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Console sample</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>En</a><ul class="dropdown__menu"><li><a href="/docs/v1.2/user/appendix/isolation" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">En</a></li><li><a href="/zh-cn/docs/v1.2/user/appendix/isolation" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Overview</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/overview/what-is-seata">What Is Seata?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/overview/terminology">Terminology</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/overview/faq">FAQ</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">User Doc</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/user/quickstart">Quick Start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/user/configurations">Seata Parameter Configuration</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/v1.2/user/mode/at">Transaction Mode</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/v1.2/user/txgroup/transaction-group">Transactions Grouping</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/v1.2/user/configuration/">Configuration Center</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/v1.2/user/registry/">Registry Center</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/user/api">Api Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/user/microservice">Microservice Framework Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/user/ormframework">ORM Framework Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/user/datasource">Data Source support</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/v1.2/user/sqlreference/sql-restrictions">SQL Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/v1.2/user/apm/skywalking">APM</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/v1.2/user/performance">Testing Report</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/v1.2/user/appendix/global-transaction-status">Appendix</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/user/appendix/global-transaction-status">Global Transaction Status</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/v1.2/user/appendix/isolation">Transaction Isolation</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Developer Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/v1.2/dev/mode/at-mode">Transaction Mode</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/v1.2/dev/domain/overviewDomainModel">Domain Model</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/dev/seata-mertics">Metrics Design</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Ops Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/ops/upgrade">Version Upgrade Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.2/ops/multi-configuration-isolation">Multi-configuration Isolation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/v1.2/ops/deploy-guide-beginner">Deploy</a></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Seata<!-- --> <b>v1.2</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/user/appendix/isolation">latest version</a></b> (<!-- -->v2.0<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">User Doc</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Appendix</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Transaction Isolation</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v1.2</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Seata Transaction Isolation</h1><blockquote><p>This article aims to help users understand how to correctly implement transaction isolation when using Seata <strong>AT mode</strong> to prevent dirty reads and writes.</p><p><strong>It is expected that readers have already read the introduction to the AT mode on the Seata official website and have an understanding of local database locks.</strong></p><p>(For example, when two transactions are simultaneously updating the same record, only the transaction that holds the record lock can update successfully, while the other transaction must wait until the record lock is released, or until the transaction times out)</p></blockquote><p>First, take a look at this piece of code. Although it looks &quot;basic,&quot; the main thing that the persistence layer framework actually does for us is just that.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DataSource dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void batchUpdate() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection connection = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement preparedStatement = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection = dataSource.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection.setAutoCommit(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String sql = &quot;update storage_tbl set count = ?&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;    where id = ? and commodity_code = ?&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement = connection.prepareStatement(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setInt(1, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setLong(2, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setString(3, &quot;2001&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.executeUpdate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IOutils.close(preparedStatement);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IOutils.close(connection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="starting-with-the-proxy-data-source">Starting with the Proxy Data Source<a href="#starting-with-the-proxy-data-source" class="hash-link" aria-label="Direct link to Starting with the Proxy Data Source" title="Direct link to Starting with the Proxy Data Source">​</a></h2><p>When using the AT mode, the most important thing is the proxy data source. So what is the purpose of using <code>DataSourceProxy</code> to proxy the data source?</p><p><code>DataSourceProxy</code> can help us obtain several important proxy objects</p><ul><li><p>Obtain <code>ConnectionProxy</code> through <code>DataSourceProxy.getConnection()</code></p></li><li><p>Obtain <code>StatementProxy</code> through <code>ConnectionProxy.prepareStatement(...)</code></p></li></ul><p>Seata&#x27;s implementation of transaction isolation is hidden in these 2 proxies, let me outline the implementation logic first.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="processing-logic-of-statementproxyexecutexxx"><strong>Processing logic of <code>StatementProxy.executeXXX()</code></strong><a href="#processing-logic-of-statementproxyexecutexxx" class="hash-link" aria-label="Direct link to processing-logic-of-statementproxyexecutexxx" title="Direct link to processing-logic-of-statementproxyexecutexxx">​</a></h3><ul><li><p>When calling <code>io.seata.rm.datasource.StatementProxy.executeXXX()</code>, the SQL is passed to <code>io.seata.rm.datasource.exec.ExecuteTemplate.execute(...)</code> to process.</p><ul><li>In the <code>ExecuteTemplate.execute(...)</code> method, Seata uses different Executers based on different <code>dbType</code> and SQL statement types, and calls the <code>execute(Object... args)</code> method of the <code>io.seata.rm.datasource.exec.Executer</code> class.</li><li>If a DML type Executer is chosen, the following main actions are performed:<ul><li>Pre-query image (select for update, obtaining local lock at this time)</li><li>Execute business SQL</li><li>Post-query image</li><li>Prepare undoLog</li></ul></li><li>If your SQL is <code>select for update</code>, then <code>SelectForUpdateExecutor</code> will be used (Seata proxies <code>select for update</code>), and the logic for post-processing after proxying is as follows:<ul><li>First, execute select for update (obtain the database&#x27;s local lock)</li><li>If in <code>@GlobalTransactional</code> or <code>@GlobalLock</code>, <strong>check</strong> if there is a global lock</li><li>If there is a global lock, under the condition of not starting a local transaction, rollback the local transaction, then re-acquire the local lock and global lock, and so on, unless the global lock is obtained.</li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="handling-logic-of-connectionproxycommit"><strong>Handling logic of <code>ConnectionProxy.commit()</code></strong><a href="#handling-logic-of-connectionproxycommit" class="hash-link" aria-label="Direct link to handling-logic-of-connectionproxycommit" title="Direct link to handling-logic-of-connectionproxycommit">​</a></h3><ul><li>In a global transaction (i.e., the data persistence method has <code>@GlobalTransactional</code>)<ul><li>Register branch transaction, obtain global lock</li><li>UndoLog data persistence</li><li>Let the database commit the current transaction</li></ul></li><li>In <code>@GlobalLock</code> (i.e., the data persistence method has <code>@GlobalLock</code>)<ul><li>Query the TC for the existence of a global lock, and if it exists, throw an exception</li><li>Let the database commit the current transaction</li></ul></li><li>For other cases (the <code>else</code> branch)<ul><li>Let the database commit the current transaction</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="purpose-of-globaltransactional"><strong>Purpose of <code>@GlobalTransactional</code></strong><a href="#purpose-of-globaltransactional" class="hash-link" aria-label="Direct link to purpose-of-globaltransactional" title="Direct link to purpose-of-globaltransactional">​</a></h3><p>Identifies a global transaction</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="purpose-of-globallock--select-for-update"><strong>Purpose of <code>@GlobalLock</code> + <code>select for update</code></strong><a href="#purpose-of-globallock--select-for-update" class="hash-link" aria-label="Direct link to purpose-of-globallock--select-for-update" title="Direct link to purpose-of-globallock--select-for-update">​</a></h3><p>If a method like <code>updateA()</code> has <code>@GlobalLock + select for update</code>, Seata, in processing, will first obtain a database local lock, then query if there is a global lock for that record, and if there is, it will throw a LockConflictException.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lets-first-give-an-example-of-dirty-write-and-then-see-how-seata-prevents-dirty-write">Let&#x27;s first give an example of dirty write, and then see how Seata prevents dirty write<a href="#lets-first-give-an-example-of-dirty-write-and-then-see-how-seata-prevents-dirty-write" class="hash-link" aria-label="Direct link to Let&#x27;s first give an example of dirty write, and then see how Seata prevents dirty write" title="Direct link to Let&#x27;s first give an example of dirty write, and then see how Seata prevents dirty write">​</a></h2><p>Let&#x27;s assume your business code is like this:</p><ul><li><code>updateAll()</code> is used to update records in both table A and B, <code>updateA()</code> and <code>updateB()</code> are used to update records in table A and B respectively</li><li><code>updateAll()</code> has already been annotated with <code>@GlobalTransactional</code></li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class YourBussinessService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DbServiceA serviceA;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DbServiceB serviceB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean updateAll(DTO dto) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceA.update(dto.getA());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceB.update(dto.getB());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean updateA(DTO dto) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceA.update(dto.getA());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class DbServiceA {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean update(A a) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="dirty-write" src="/assets/images/dirty-write-e87d2b06d84c820fd786932b58583404.png" width="1964" height="1946" class="img_ev3q">
|</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-prevent-dirty-write-using-seata"><strong>How to prevent dirty write using Seata?</strong><a href="#how-to-prevent-dirty-write-using-seata" class="hash-link" aria-label="Direct link to how-to-prevent-dirty-write-using-seata" title="Direct link to how-to-prevent-dirty-write-using-seata">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="method-1-add-globaltransactional-to-updatea-as-well-how-does-seata-ensure-transaction-isolation-in-this-case">Method 1: Add <code>@GlobalTransactional</code> to <code>updateA()</code> as well, how does Seata ensure transaction isolation in this case?<a href="#method-1-add-globaltransactional-to-updatea-as-well-how-does-seata-ensure-transaction-isolation-in-this-case" class="hash-link" aria-label="Direct link to method-1-add-globaltransactional-to-updatea-as-well-how-does-seata-ensure-transaction-isolation-in-this-case" title="Direct link to method-1-add-globaltransactional-to-updatea-as-well-how-does-seata-ensure-transaction-isolation-in-this-case">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class DbServiceA {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean updateA(DTO dto) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceA.update(dto.getA());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>updateAll()</code> is called first (not completed), <code>updateA()</code> is called afterwards</li></ul><p><img loading="lazy" alt="dirty-write" src="/assets/images/prevent-dirty-write-by-GlobalTransaction-7a7b3233283a355ca3a609e67841e43c.png" width="2236" height="1932" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="method-2-globallock--select-for-update">Method 2: <strong>@GlobalLock + select for update</strong><a href="#method-2-globallock--select-for-update" class="hash-link" aria-label="Direct link to method-2-globallock--select-for-update" title="Direct link to method-2-globallock--select-for-update">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class DbServiceA {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalLock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean updateA(DTO dto) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceA.selectForUpdate(dto.getA());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceA.update(dto.getA());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>updateAll()</code> is called first (not completed), <code>updateA()</code> is called afterwards</li></ul><p><img loading="lazy" alt="dirty-write" src="/assets/images/prevent-dirty-write-by-GlobalLock-2371e8e82186fce823044f836a2e02c2.png" width="2860" height="1830" class="img_ev3q"></p><ul><li>What if <code>updateA()</code> is called first (not completed), and then <code>updateAll()</code> is called?
Since both transactions need to acquire local locks first, dirty write will not occur.</li><li>Someone may ask, &quot;Why do we need to add select for update here? Can&#x27;t we prevent dirty write with just @GlobalLock?&quot;
Yes. But please refer to the diagram above, select for update brings a few advantages:<ul><li>Lock conflicts are handled more gracefully. If only @GlobalLock is used, it immediately throws an exception when a global lock is detected. It&#x27;s a pity to release the global lock after a little &quot;persistence&quot; and throw an exception.</li><li>In <code>updateA()</code>, we can use select for update to get the latest A and then perform the update.</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-prevent-dirty-reads"><strong>How to prevent dirty reads?</strong><a href="#how-to-prevent-dirty-reads" class="hash-link" aria-label="Direct link to how-to-prevent-dirty-reads" title="Direct link to how-to-prevent-dirty-reads">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scenario---one-business-calls-updateall-first-updateall-is-not-completed-and-then-another-business-calls-querya">Scenario:   One business calls <code>updateAll()</code> first, <code>updateAll()</code> is not completed, and then another business calls <code>queryA()</code><a href="#scenario---one-business-calls-updateall-first-updateall-is-not-completed-and-then-another-business-calls-querya" class="hash-link" aria-label="Direct link to scenario---one-business-calls-updateall-first-updateall-is-not-completed-and-then-another-business-calls-querya" title="Direct link to scenario---one-business-calls-updateall-first-updateall-is-not-completed-and-then-another-business-calls-querya">​</a></h3><p><img loading="lazy" alt="dirty-write" src="/assets/images/prevent-dirty-read-ce251ac833cb2ea643757c1816ab9903.png" width="2860" height="1830" class="img_ev3q"></p><hr><h1><strong>Source Code Display</strong></h1><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DataSource dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void update() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection connection = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement preparedStatement = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection = dataSource.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection.setAutoCommit(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String sql = &quot;update storage_tbl set count = ?&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;    where id = ? and commodity_code = ?&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement = connection.prepareStatement(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setInt(1, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setLong(2, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setString(3, &quot;2001&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IOutils.close(preparedStatement);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IOutils.close(connection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Although this code looks very basic and does not use the persistence layer framework, if we abstract what the framework does for us, it is actually the above code.</p><p><strong>Brief explanation of the context of the following source code introduction (mainly focusing on source code related to transaction isolation)</strong></p><ul><li>Purpose of proxy data source<ul><li>The role of <code>DataSourceProxy</code> (returns <code>ConnectionProxy</code>)<ul><li>Introducing a small function of <code>ConnectionProxy</code> (storing undolog)</li></ul></li><li>The role of <code>ConnectionProxy</code> (returns <code>StatementProxy</code>)</li><li>Processing logic of <code>StatementProxy.execute()</code><ul><li>Execution logic of <code>io.seata.rm.datasource.exec.UpdateExecutor</code> (pre-check image, execute sql, post-check image, prepare undoLog)</li><li>Execution logic of <code>SelectForUpdateExecutor</code> (fight for local lock, check global lock. If there is a global lock, roll back, fight again...)</li></ul></li><li>Processing logic of <code>ConnectionProxy.commit()</code> (register branch transaction (fight for global lock), write undoLog, database commit)</li></ul></li><li>Introducing RootContext</li><li>Different proxy logic for <code>GlobalTransactionalInterceptor</code><ul><li>How to handle with <code>@GlobalTransactional</code></li><li>How to deal with <code>@GlobalLock</code></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-role-of-datasourceproxy"><strong>The role of DataSourceProxy</strong><a href="#the-role-of-datasourceproxy" class="hash-link" aria-label="Direct link to the-role-of-datasourceproxy" title="Direct link to the-role-of-datasourceproxy">​</a></h2><p>DataSourceProxy helps us obtain several important proxy objects</p><ul><li>Obtain <code>ConnectionProxy</code> through <code>DataSourceProxy.getConnection()</code></li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSourceProxy extends AbstractDataSourceProxy implements Resource {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConnectionProxy getConnection() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection targetConnection = targetDataSource.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ConnectionProxy(this, targetConnection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>First, let&#x27;s introduce <code>ConnectionContext</code> in <code>ConnectionProxy</code>, one of its functions is to <strong>store undoLog</strong>.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.rm.datasource.undo.SQLUndoLog;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void appendUndoLog(SQLUndoLog sqlUndoLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.appendUndoItem(sqlUndoLog);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Savepoint DEFAULT_SAVEPOINT = new Savepoint() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public int getSavepointId() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getSavepointName() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;DEFAULT_SEATA_SAVEPOINT&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;Savepoint, List&lt;SQLUndoLog&gt;&gt; sqlUndoItemsBuffer = new LinkedHashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Savepoint currentSavepoint = DEFAULT_SAVEPOINT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void appendUndoItem(SQLUndoLog sqlUndoLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sqlUndoItemsBuffer.computeIfAbsent(currentSavepoint, k -&gt; new ArrayList&lt;&gt;()).add(sqlUndoLog);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="get-statementproxy-through-connectionproxypreparestatement"><strong>Get <code>StatementProxy</code> through <code>ConnectionProxy.prepareStatement(...)</code></strong><a href="#get-statementproxy-through-connectionproxypreparestatement" class="hash-link" aria-label="Direct link to get-statementproxy-through-connectionproxypreparestatement" title="Direct link to get-statementproxy-through-connectionproxypreparestatement">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConnectionProxy(DataSourceProxy dataSourceProxy, Connection targetConnection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(dataSourceProxy, targetConnection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractConnectionProxy implements Connection {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Connection targetConnection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AbstractConnectionProxy(DataSourceProxy dataSourceProxy, Connection targetConnection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.dataSourceProxy = dataSourceProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.targetConnection = targetConnection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PreparedStatement prepareStatement(String sql) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String dbType = getDbType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // support oracle 10.2+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement targetPreparedStatement = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (BranchType.AT == RootContext.getBranchType()) { //为什么这里会返回AT？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SQLRecognizer&gt; sqlRecognizers = SQLVisitorFactory.get(sql, dbType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (sqlRecognizers != null &amp;&amp; sqlRecognizers.size() == 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SQLRecognizer sqlRecognizer = sqlRecognizers.get(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (sqlRecognizer != null &amp;&amp; sqlRecognizer.getSQLType() == SQLType.INSERT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TableMeta tableMeta = TableMetaCacheFactory.getTableMetaCache(dbType).getTableMeta(getTargetConnection(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            sqlRecognizer.getTableName(), getDataSourceProxy().getResourceId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] pkNameArray = new String[tableMeta.getPrimaryKeyOnlyName().size()];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tableMeta.getPrimaryKeyOnlyName().toArray(pkNameArray);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If it is an insert statement, the PreparedStatement created here needs to be able to return the automatically generated primary key, so use this prepareStatement()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    targetPreparedStatement = getTargetConnection().prepareStatement(sql,pkNameArray);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (targetPreparedStatement == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            targetPreparedStatement = getTargetConnection().prepareStatement(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new PreparedStatementProxy(this, targetPreparedStatement, sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Connection getTargetConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return targetConnection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>First, let&#x27;s raise a question here, and explain it later.<br>
<strong>How could <code>RootContext.getBranchType()</code> return AT?</strong></p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="processing-logic-for-statementproxyexecute"><strong>Processing logic for <code>StatementProxy.execute()</code></strong><a href="#processing-logic-for-statementproxyexecute" class="hash-link" aria-label="Direct link to processing-logic-for-statementproxyexecute" title="Direct link to processing-logic-for-statementproxyexecute">​</a></h2><ul><li><p>When calling <code>io.seata.rm.datasource.StatementProxy.execute()</code>, the SQL will be handed over to <code>io.seata.rm.datasource.exec.ExecuteTemplate.execute(...)</code> for processing.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PreparedStatementProxy extends AbstractPreparedStatementProxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implements PreparedStatement, ParametersHolder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean execute() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExecuteTemplate.execute(this, (statement, args) -&gt; statement.execute());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>In the <code>ExecuteTemplate.execute(...)</code> method, Seata uses different Executers based on the dbType and the type of SQL statement, and calls the <code>execute(Object... args)</code> method of the <code>io.seata.rm.datasource.exec.Executer</code> class.<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource.exec;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public class ExecuteTemplate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public static &lt;T, S extends Statement&gt; T execute(StatementProxy&lt;S&gt; statementProxy,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 StatementCallback&lt;T, S&gt; statementCallback,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 Object... args) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return execute(null, statementProxy, statementCallback, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public static &lt;T, S extends Statement&gt; T execute(List&lt;SQLRecognizer&gt; sqlRecognizers,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             StatementProxy&lt;S&gt; statementProxy,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             StatementCallback&lt;T, S&gt; statementCallback,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             Object... args) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!RootContext.requireGlobalLock() &amp;&amp; BranchType.AT != RootContext.getBranchType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Just work as original statement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return statementCallback.execute(statementProxy.getTargetStatement(), args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String dbType = statementProxy.getConnectionProxy().getDbType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(sqlRecognizers)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sqlRecognizers = SQLVisitorFactory.get(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        statementProxy.getTargetSQL(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        dbType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Executor&lt;T&gt; executor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(sqlRecognizers)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                executor = new PlainExecutor&lt;&gt;(statementProxy, statementCallback);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (sqlRecognizers.size() == 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SQLRecognizer sqlRecognizer = sqlRecognizers.get(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    switch (sqlRecognizer.getSQLType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        case INSERT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            executor = EnhancedServiceLoader.load(InsertExecutor.class, dbType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    new Class[]{StatementProxy.class, StatementCallback.class, SQLRecognizer.class},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    new Object[]{statementProxy, statementCallback, sqlRecognizer});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        case UPDATE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            executor = new UpdateExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        case DELETE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            executor = new DeleteExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        case SELECT_FOR_UPDATE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            executor = new SelectForUpdateExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            executor = new PlainExecutor&lt;&gt;(statementProxy, statementCallback);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    executor = new MultiExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            T rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rs = executor.execute(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!(ex instanceof SQLException)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Turn other exception into SQLException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ex = new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw (SQLException) ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &gt; Also, a question is raised here, explained later.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &gt; **How does `RootContext.requireGlobalLock()` determine if the global lock is needed?**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Taking `io.seata.rm.datasource.exec.UpdateExecutor` as an example, `UpdateExecutor` extends `AbstractDMLBaseExecutor` extends `BaseTransactionalExecutor`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Observing what the `execute()` method does</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract class BaseTransactionalExecutor&lt;T, S extends Statement&gt; implements Executor&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected StatementProxy&lt;S&gt; statementProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected StatementCallback&lt;T, S&gt; statementCallback;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected SQLRecognizer sqlRecognizer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public BaseTransactionalExecutor(StatementProxy&lt;S&gt; statementProxy, StatementCallback&lt;T, S&gt; statementCallback,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SQLRecognizer sqlRecognizer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.statementProxy = statementProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.statementCallback = statementCallback;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.sqlRecognizer = sqlRecognizer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public T execute(Object... args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (xid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                statementProxy.getConnectionProxy().bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            statementProxy.getConnectionProxy().setGlobalLockRequire(RootContext.requireGlobalLock());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doExecute(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract class AbstractDMLBaseExecutor&lt;T, S extends Statement&gt; extends BaseTransactionalExecutor&lt;T, S&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public AbstractDMLBaseExecutor(StatementProxy&lt;S&gt; statementProxy, StatementCallback&lt;T, S&gt; statementCallback,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               SQLRecognizer sqlRecognizer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            super(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public T doExecute(Object... args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AbstractConnectionProxy connectionProxy = statementProxy.getConnectionProxy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (connectionProxy.getAutoCommit()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return executeAutoCommitTrue(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return executeAutoCommitFalse(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected T executeAutoCommitTrue(Object[] args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConnectionProxy connectionProxy = statementProxy.getConnectionProxy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                connectionProxy.changeAutoCommit(); // 注意，你如果没开启事务，seata帮你开启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new LockRetryPolicy(connectionProxy).execute(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    T result = executeAutoCommitFalse(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    connectionProxy.commit(); // 帮你开启事务后，通过connectionProxy来提交</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // when exception occur in finally,this exception will lost, so just print it here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;execute executeAutoCommitTrue error:{}&quot;, e.getMessage(), e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!LockRetryPolicy.isLockRetryPolicyBranchRollbackOnConflict()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    connectionProxy.getTargetConnection().rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                connectionProxy.getContext().reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                connectionProxy.setAutoCommit(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected T executeAutoCommitFalse(Object[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!JdbcConstants.MYSQL.equalsIgnoreCase(getDbType()) &amp;&amp; isMultiPk()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new NotSupportYetException(&quot;multi pk only support mysql!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TableRecords beforeImage = beforeImage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            T result = statementCallback.execute(statementProxy.getTargetStatement(), args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TableRecords afterImage = afterImage(beforeImage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            prepareUndoLog(beforeImage, afterImage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public class UpdateExecutor&lt;T, S extends Statement&gt; extends AbstractDMLBaseExecutor&lt;T, S&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public UpdateExecutor(StatementProxy&lt;S&gt; statementProxy, StatementCallback&lt;T, S&gt; statementCallback,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            SQLRecognizer sqlRecognizer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            super(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- If you have chosen a DML type Executer, you can see in the executeAutoCommitFalse() method above, it mainly does the following:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - Query before image (select for update, so local lock is acquired at this time)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public class UpdateExecutor&lt;T, S extends Statement&gt; extends AbstractDMLBaseExecutor&lt;T, S&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            private static final boolean ONLY_CARE_UPDATE_COLUMNS = CONFIG.getBoolean(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ConfigurationKeys.TRANSACTION_UNDO_ONLY_CARE_UPDATE_COLUMNS, DefaultValues.DEFAULT_ONLY_CARE_UPDATE_COLUMNS); // 默认为true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            protected TableRecords beforeImage() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ArrayList&lt;List&lt;Object&gt;&gt; paramAppenderList = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TableMeta tmeta = getTableMeta();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String selectSQL = buildBeforeImageSQL(tmeta, paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // SELECT id, count FROM storage_tbl WHERE id = ? FOR UPDATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildTableRecords(tmeta, selectSQL, paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            private String buildBeforeImageSQL(TableMeta tableMeta, ArrayList&lt;List&lt;Object&gt;&gt; paramAppenderList) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SQLUpdateRecognizer recognizer = (SQLUpdateRecognizer) sqlRecognizer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;String&gt; updateColumns = recognizer.getUpdateColumns();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                StringBuilder prefix = new StringBuilder(&quot;SELECT &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                StringBuilder suffix = new StringBuilder(&quot; FROM &quot;).append(getFromTableInSQL());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String whereCondition = buildWhereCondition(recognizer, paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNotBlank(whereCondition)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    suffix.append(WHERE).append(whereCondition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String orderBy = recognizer.getOrderBy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNotBlank(orderBy)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    suffix.append(orderBy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ParametersHolder parametersHolder = statementProxy instanceof ParametersHolder ? (ParametersHolder)statementProxy : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String limit = recognizer.getLimit(parametersHolder, paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNotBlank(limit)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    suffix.append(limit);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                suffix.append(&quot; FOR UPDATE&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                StringJoiner selectSQLJoin = new StringJoiner(&quot;, &quot;, prefix.toString(), suffix.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ONLY_CARE_UPDATE_COLUMNS) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (!containsPK(updateColumns)) {// 如果本次更新的行不包含主键，那select for update的时候加上主键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        selectSQLJoin.add(getColumnNamesInSQL(tableMeta.getEscapePkNameList(getDbType())));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for (String columnName : updateColumns) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        selectSQLJoin.add(columnName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for (String columnName : tableMeta.getAllColumns().keySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        selectSQLJoin.add(ColumnUtils.addEscape(columnName, getDbType()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return selectSQLJoin.toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            protected TableRecords buildTableRecords(TableMeta tableMeta, String selectSQL, ArrayList&lt;List&lt;Object&gt;&gt; paramAppenderList) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ResultSet rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try (PreparedStatement ps = statementProxy.getConnection().prepareStatement(selectSQL)) { // 执行select for update，然后就拿到了本地锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (CollectionUtils.isNotEmpty(paramAppenderList)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        for (int i = 0, ts = paramAppenderList.size(); i &lt; ts; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            List&lt;Object&gt; paramAppender = paramAppenderList.get(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            for (int j = 0, ds = paramAppender.size(); j &lt; ds; j++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                ps.setObject(i * ds + j + 1, paramAppender.get(j));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rs = ps.executeQuery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return TableRecords.buildRecords(tableMeta, rs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    IOUtil.close(rs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - Execute business SQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - Query the mirrored image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public class UpdateExecutor&lt;T, S extends Statement&gt; extends AbstractDMLBaseExecutor&lt;T, S&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            protected TableRecords afterImage(TableRecords beforeImage) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TableMeta tmeta = getTableMeta();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (beforeImage == null || beforeImage.size() == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return TableRecords.empty(getTableMeta());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String selectSQL = buildAfterImageSQL(tmeta, beforeImage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //SELECT id, count FROM storage_tbl WHERE (id) in ( (?) )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ResultSet rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try (PreparedStatement pst = statementProxy.getConnection().prepareStatement(selectSQL)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SqlGenerateUtils.setParamForPk(beforeImage.pkRows(), getTableMeta().getPrimaryKeyOnlyName(), pst);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rs = pst.executeQuery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return TableRecords.buildRecords(tmeta, rs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    IOUtil.close(rs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - Prepare undoLog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public abstract class BaseTransactionalExecutor&lt;T, S extends Statement&gt; implements Executor&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            protected void prepareUndoLog(TableRecords beforeImage, TableRecords afterImage) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (beforeImage.getRows().isEmpty() &amp;&amp; afterImage.getRows().isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (SQLType.UPDATE == sqlRecognizer.getSQLType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (beforeImage.getRows().size() != afterImage.getRows().size()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new ShouldNeverHappenException(&quot;Before image size is not equaled to after image size, probably because you updated the primary keys.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ConnectionProxy connectionProxy = statementProxy.getConnectionProxy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TableRecords lockKeyRecords = sqlRecognizer.getSQLType() == SQLType.DELETE ? beforeImage : afterImage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String lockKeys = buildLockKey(lockKeyRecords);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (null != lockKeys) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    connectionProxy.appendLockKey(lockKeys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SQLUndoLog sqlUndoLog = buildUndoItem(beforeImage, afterImage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    connectionProxy.appendUndoLog(sqlUndoLog); // 把undoLog存到connectionProxy中，具体怎么回事上面有提过</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- If your sql is select for update, `SelectForUpdateExecutor` will be used (Seata proxies select for update), and the processing logic after proxy is as follows:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - First execute select for update (obtain the database local lock)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - If it is in `@GlobalTransactional` or `@GlobalLock`, **check** whether there is a global lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - If there is a global lock, and local transaction is not started, roll back the local transaction, then re-acquire the local lock and query the global lock until the global lock is released</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       public class SelectForUpdateExecutor&lt;T, S extends Statement&gt; extends BaseTransactionalExecutor&lt;T, S&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public T doExecute(Object... args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Connection conn = statementProxy.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    DatabaseMetaData dbmd = conn.getMetaData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    T rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Savepoint sp = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean originalAutoCommit = conn.getAutoCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (originalAutoCommit) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             * In order to hold the local db lock during global lock checking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             * set auto commit value to false first if original auto commit was true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            conn.setAutoCommit(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else if (dbmd.supportsSavepoints()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             * In order to release the local db lock when global lock conflict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             * create a save point if original auto commit was false, then use the save point here to release db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             * lock during global lock checking if necessary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            sp = conn.setSavepoint();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            throw new SQLException(&quot;not support savepoint. please check your db version&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LockRetryController lockRetryController = new LockRetryController();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ArrayList&lt;List&lt;Object&gt;&gt; paramAppenderList = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String selectPKSQL = buildSelectSQL(paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // #870</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // execute return Boolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // executeQuery return ResultSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                rs = statementCallback.execute(statementProxy.getTargetStatement(), args); // execute select for update (get database local lock)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // Try to get global lock of those rows selected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                TableRecords selectPKRows = buildTableRecords(getTableMeta(), selectPKSQL, paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                String lockKeys = buildLockKey(selectPKRows);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (StringUtils.isNullOrEmpty(lockKeys)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (RootContext.inGlobalTransaction() || RootContext.requireGlobalLock()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    // Do the same thing under either @GlobalTransactional or @GlobalLock, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    // that only check the global lock  here.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    statementProxy.getConnectionProxy().checkLock(lockKeys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    throw new RuntimeException(&quot;Unknown situation!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } catch (LockConflictException lce) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (sp != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    conn.rollback(sp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    conn.rollback();// Roll back and release local lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // trigger retry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                lockRetryController.sleep(lce);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (sp != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (!JdbcConstants.ORACLE.equalsIgnoreCase(getDbType())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    conn.releaseSavepoint(sp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } catch (SQLException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                LOGGER.error(&quot;{} release save point error.&quot;, getDbType(), e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (originalAutoCommit) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            conn.setAutoCommit(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="processing-logic-of-connectionproxycommit"><strong>Processing Logic of <code>ConnectionProxy.commit()</code></strong><a href="#processing-logic-of-connectionproxycommit" class="hash-link" aria-label="Direct link to processing-logic-of-connectionproxycommit" title="Direct link to processing-logic-of-connectionproxycommit">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static LockRetryPolicy LOCK_RETRY_POLICY = new LockRetryPolicy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void commit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOCK_RETRY_POLICY.execute(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                doCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (targetConnection != null &amp;&amp; !getAutoCommit() &amp;&amp; !getContext().isAutoCommitChanged()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SQLException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void doCommit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (context.inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            processGlobalTransactionCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (context.isGlobalLockRequire()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            processLocalCommitWithGlobalLocks();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>Also, a question has been raised here, which will be explained later.
How does <code>ConnectionContext</code> in <code>ConnectionProxy</code> determine <code>inGlobalTransaction()</code> or <code>isGlobalLockRequire()</code>?</p></blockquote><ul><li><p>In a global transaction (i.e., data persistence method with <code>@GlobalTransactional</code>)</p><ul><li><p>Register branch transaction, acquire global lock</p></li><li><p>Store undo log data</p></li><li><p>Commit the transaction in the database</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final static LockRetryPolicy LOCK_RETRY_POLICY = new LockRetryPolicy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void processGlobalTransactionCommit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                register(); // Register branch and contend for global lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (TransactionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                recognizeLockKeyConflictException(e, context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                UndoLogManagerFactory.getUndoLogManager(this.getDbType()).flushUndoLogs(this); // Store undolog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                targetConnection.commit(); // Commit branch transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;process connectionProxy commit error: {}&quot;, ex.getMessage(), ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                report(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (IS_REPORT_SUCCESS_ENABLE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                report(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void register() throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!context.hasUndoLog() || !context.hasLockKey()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Long branchId = DefaultResourceManager.get().branchRegister(BranchType.AT, getDataSourceProxy().getResourceId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                null, context.getXid(), null, context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.setBranchId(branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>In <code>@GlobalLock</code> (i.e., data persistence method with <code>@GlobalLock</code>):</p><ul><li><p>Query tc for the presence of global lock</p></li><li><p>Commit the transaction to the database</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       private final static LockRetryPolicy LOCK_RETRY_POLICY = new LockRetryPolicy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       private void processLocalCommitWithGlobalLocks() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           checkLock(context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               throw new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           context.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       public void checkLock(String lockKeys) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           if (StringUtils.isBlank(lockKeys)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // Just check lock without requiring lock by now.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               boolean lockable = DefaultResourceManager.get().lockQuery(BranchType.AT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   getDataSourceProxy().getResourceId(), context.getXid(), lockKeys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               if (!lockable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   throw new LockConflictException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           } catch (TransactionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               recognizeLockKeyConflictException(e, lockKeys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Other than the above cases (the <code>else</code> branch)<ul><li>Let the database commit the current transaction.</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-rootcontext">Introduction to <code>RootContext</code><a href="#introduction-to-rootcontext" class="hash-link" aria-label="Direct link to introduction-to-rootcontext" title="Direct link to introduction-to-rootcontext">​</a></h2><p>We left three &quot;clues&quot; above, now it&#x27;s time to answer them in conjunction with the <code>RootContext</code> source code.</p><ol><li><p><strong>How could the return value of <code>RootContext.getBranchType()</code> be AT?</strong><br>
<!-- -->The logic in this method is: as long as it is determined that the <strong>current transaction is in a global state</strong> (i.e., as long as <code>RootContext.bind(xid)</code> has been called somewhere), it will return the default <code>BranchType.AT</code>.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class RootContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String KEY_XID = &quot;TX_XID&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static ContextCore CONTEXT_HOLDER = ContextCoreLoader.load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static BranchType DEFAULT_BRANCH_TYPE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BranchType getBranchType() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BranchType branchType = (BranchType) CONTEXT_HOLDER.get(KEY_BRANCH_TYPE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (branchType != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return branchType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Returns the default branch type.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return DEFAULT_BRANCH_TYPE != null ? DEFAULT_BRANCH_TYPE : BranchType.AT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static boolean inGlobalTransaction() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return CONTEXT_HOLDER.get(KEY_XID) != null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void bind(@Nonnull String xid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.debug(&quot;xid is blank, switch to unbind operation!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MDC.put(MDC_KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.debug(&quot;bind {}&quot;, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CONTEXT_HOLDER.put(KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>How to determine whether <code>RootContext.requireGlobalLock()</code> needs a global lock?</strong>
Somewhere needs to call <code>RootContext.bindGlobalLockFlag()</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class RootContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String KEY_GLOBAL_LOCK_FLAG = &quot;TX_LOCK&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final Boolean VALUE_GLOBAL_LOCK_FLAG = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static ContextCore CONTEXT_HOLDER = ContextCoreLoader.load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static boolean requireGlobalLock() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return CONTEXT_HOLDER.get(KEY_GLOBAL_LOCK_FLAG) != null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void bindGlobalLockFlag() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug(&quot;Local Transaction Global Lock support enabled&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //just put something not null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CONTEXT_HOLDER.put(KEY_GLOBAL_LOCK_FLAG, VALUE_GLOBAL_LOCK_FLAG);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>How does <code>ConnectionProxy.commit()</code> distinguish between different states based on the context, and how does <code>ConnectionContext</code> determine <code>inGlobalTransaction()</code> or <code>isGlobalLockRequire()</code>?</strong></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void doCommit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (context.inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            processGlobalTransactionCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (context.isGlobalLockRequire()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            processLocalCommitWithGlobalLocks();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>How is <code>inGlobalTransaction()</code> determined? (Note that this is different from the mentioned <code>RootContext</code> above)</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String xid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setXid(String xid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.xid = xid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean inGlobalTransaction() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return xid != null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void bind(String xid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException(&quot;xid should not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            setXid(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!this.xid.equals(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new ShouldNeverHappenException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Where is <code>ConnectionContext.bind(xid)</code> called?</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class BaseTransactionalExecutor&lt;T, S extends Statement&gt; implements Executor&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public T execute(Object... args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // So, where does the XID come from here? Look ahead and you will know that it comes from when the global transaction is opened, and is related to @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      String xid = RootContext.getXID(); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (xid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          statementProxy.getConnectionProxy().bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // This is the position to set isGlobalLockRequire, related to @GlobalLock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      statementProxy.getConnectionProxy().setGlobalLockRequire(RootContext.requireGlobalLock());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return doExecute(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void bind(String xid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setGlobalLockRequire(boolean isLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setGlobalLockRequire(isLock);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>How to determine <code>isGlobalLockRequire()</code>?</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isGlobalLockRequire;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isGlobalLockRequire() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       return isGlobalLockRequire;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setGlobalLockRequire(boolean isGlobalLockRequire) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isGlobalLockRequire = isGlobalLockRequire;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After looking at the code, we know that as long as somewhere in <code>RootContext</code> sets xid, or <code>bindGlobalLockFlag()</code>, it will be recognized as a different state.
So where is it called? The answer is in the <code>GlobalTransactionalInterceptor</code> below.</p></li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="globaltransactionalinterceptor-handles-methods-with-globaltransactional-or-globallock"><strong><code>GlobalTransactionalInterceptor</code> handles methods with <code>@GlobalTransactional</code> or <code>@GlobalLock</code></strong><a href="#globaltransactionalinterceptor-handles-methods-with-globaltransactional-or-globallock" class="hash-link" aria-label="Direct link to globaltransactionalinterceptor-handles-methods-with-globaltransactional-or-globallock" title="Direct link to globaltransactionalinterceptor-handles-methods-with-globaltransactional-or-globallock">​</a></h2><p>Methods with <code>@GlobalTransactional</code> and <code>@GlobalLock</code> will be proxied and handled by <code>GlobalTransactionalInterceptor</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionalInterceptor implements ConfigurationChangeListener, MethodInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object invoke(final MethodInvocation methodInvocation) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; targetClass =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis()) : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (specificMethod != null &amp;&amp; !specificMethod.getDeclaringClass().equals(Object.class)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final GlobalTransactional globalTransactionalAnnotation =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                getAnnotation(method, targetClass, GlobalTransactional.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final GlobalLock globalLockAnnotation = getAnnotation(method, targetClass, GlobalLock.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean localDisable = disable || (degradeCheck &amp;&amp; degradeNum &gt;= degradeCheckAllowTimes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!localDisable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (globalTransactionalAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);// Handle @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (globalLockAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return handleGlobalLock(methodInvocation, globalLockAnnotation); // Handle @GlobalLock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return methodInvocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="first-handle-globaltransactional"><strong>First, handle <code>@GlobalTransactional</code></strong><a href="#first-handle-globaltransactional" class="hash-link" aria-label="Direct link to first-handle-globaltransactional" title="Direct link to first-handle-globaltransactional">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionalInterceptor implements ConfigurationChangeListener, MethodInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final TransactionalTemplate transactionalTemplate = new TransactionalTemplate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object handleGlobalTransaction(final MethodInvocation methodInvocation,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final GlobalTransactional globalTrxAnno) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return transactionalTemplate.execute(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionalExecutor.ExecutionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We have arrived at the classic seata transaction template method, and we need to focus on the part where the transaction is initiated.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class TransactionalTemplate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object execute(TransactionalExecutor business) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Get transactionInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.1 Get current transaction, if not null, the tx role is &#x27;GlobalTransactionRole.Participant&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GlobalTransaction tx = GlobalTransactionContext.getCurrent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.2 Handle the transaction propagation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1.3 If null, create new transaction with role &#x27;GlobalTransactionRole.Launcher&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tx == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tx = GlobalTransactionContext.createNew();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 2. If the tx role is &#x27;GlobalTransactionRole.Launcher&#x27;, send the request of beginTransaction to TC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //    else do nothing. Of course, the hooks will still be triggered.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                beginTransaction(txInfo, tx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Do Your Business</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rs = business.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 3. The needed business exception to rollback.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    completeTransactionAfterThrowing(txInfo, tx, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 4. everything is fine, commit.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                commitTransaction(tx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //5. clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // If the transaction is suspended, resume it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void beginTransaction(TransactionInfo txInfo, GlobalTransaction tx) throws TransactionalExecutor.ExecutionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerBeforeBegin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.begin(txInfo.getTimeOut(), txInfo.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerAfterBegin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TransactionalExecutor.Code.BeginFailure);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class DefaultGlobalTransaction implements GlobalTransaction {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void begin(int timeout, String name) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (role != GlobalTransactionRole.Launcher) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            assertXIDNotNull();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.debug(&quot;Ignore Begin(): just involved in global transaction [{}]&quot;, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assertXIDNull();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String currentXid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (currentXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(&quot;Global transaction already exists,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot; can&#x27;t begin a new global transaction, currentXid = &quot; + currentXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xid = transactionManager.begin(null, null, name, timeout);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        status = GlobalStatus.Begin;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RootContext.bind(xid); // Bind xid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isInfoEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;Begin new global transaction [{}]&quot;, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>See <code>RootContext.bind(xid);</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="continue-to-handle-globallock"><strong>Continue to handle <code>@GlobalLock</code></strong><a href="#continue-to-handle-globallock" class="hash-link" aria-label="Direct link to continue-to-handle-globallock" title="Direct link to continue-to-handle-globallock">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionalInterceptor implements ConfigurationChangeListener, MethodInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final GlobalLockTemplate globalLockTemplate = new GlobalLockTemplate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object handleGlobalLock(final MethodInvocation methodInvocation,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final GlobalLock globalLockAnno) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return globalLockTemplate.execute(new GlobalLockExecutor() {...});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Also using the template method to handle GlobalLock</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalLockTemplate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object execute(GlobalLockExecutor executor) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean alreadyInGlobalLock = RootContext.requireGlobalLock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!alreadyInGlobalLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RootContext.bindGlobalLockFlag();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set my config to config holder so that it can be access in further execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // for example, LockRetryController can access it with config holder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GlobalLockConfig myConfig = executor.getGlobalLockConfig();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GlobalLockConfig previousConfig = GlobalLockConfigHolder.setAndReturnPrevious(myConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return executor.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // only unbind when this is the root caller.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // otherwise, the outer caller would lose global lock flag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!alreadyInGlobalLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.unbindGlobalLockFlag();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // if previous config is not null, we need to set it back</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // so that the outer logic can still use their config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (previousConfig != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalLockConfigHolder.setAndReturnPrevious(previousConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalLockConfigHolder.remove();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>See, as soon as it enters the template method, <code>RootContext.bindGlobalLockFlag();</code></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/en/docusaurus-plugin-content-docs/version-v1.2/user/appendix/isolation.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/v1.2/user/appendix/global-transaction-status"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Global Transaction Status</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/v1.2/dev/mode/at-mode"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Seata AT Mode</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#starting-with-the-proxy-data-source" class="table-of-contents__link toc-highlight">Starting with the Proxy Data Source</a><ul><li><a href="#processing-logic-of-statementproxyexecutexxx" class="table-of-contents__link toc-highlight"><strong>Processing logic of <code>StatementProxy.executeXXX()</code></strong></a></li><li><a href="#handling-logic-of-connectionproxycommit" class="table-of-contents__link toc-highlight"><strong>Handling logic of <code>ConnectionProxy.commit()</code></strong></a></li><li><a href="#purpose-of-globaltransactional" class="table-of-contents__link toc-highlight"><strong>Purpose of <code>@GlobalTransactional</code></strong></a></li><li><a href="#purpose-of-globallock--select-for-update" class="table-of-contents__link toc-highlight"><strong>Purpose of <code>@GlobalLock</code> + <code>select for update</code></strong></a></li></ul></li><li><a href="#lets-first-give-an-example-of-dirty-write-and-then-see-how-seata-prevents-dirty-write" class="table-of-contents__link toc-highlight">Let&#39;s first give an example of dirty write, and then see how Seata prevents dirty write</a></li><li><a href="#how-to-prevent-dirty-write-using-seata" class="table-of-contents__link toc-highlight"><strong>How to prevent dirty write using Seata?</strong></a><ul><li><a href="#method-1-add-globaltransactional-to-updatea-as-well-how-does-seata-ensure-transaction-isolation-in-this-case" class="table-of-contents__link toc-highlight">Method 1: Add <code>@GlobalTransactional</code> to <code>updateA()</code> as well, how does Seata ensure transaction isolation in this case?</a></li><li><a href="#method-2-globallock--select-for-update" class="table-of-contents__link toc-highlight">Method 2: <strong>@GlobalLock + select for update</strong></a></li></ul></li><li><a href="#how-to-prevent-dirty-reads" class="table-of-contents__link toc-highlight"><strong>How to prevent dirty reads?</strong></a><ul><li><a href="#scenario---one-business-calls-updateall-first-updateall-is-not-completed-and-then-another-business-calls-querya" class="table-of-contents__link toc-highlight">Scenario:   One business calls <code>updateAll()</code> first, <code>updateAll()</code> is not completed, and then another business calls <code>queryA()</code></a></li></ul></li><li><a href="#the-role-of-datasourceproxy" class="table-of-contents__link toc-highlight"><strong>The role of DataSourceProxy</strong></a></li><li><a href="#get-statementproxy-through-connectionproxypreparestatement" class="table-of-contents__link toc-highlight"><strong>Get <code>StatementProxy</code> through <code>ConnectionProxy.prepareStatement(...)</code></strong></a></li><li><a href="#processing-logic-for-statementproxyexecute" class="table-of-contents__link toc-highlight"><strong>Processing logic for <code>StatementProxy.execute()</code></strong></a></li><li><a href="#processing-logic-of-connectionproxycommit" class="table-of-contents__link toc-highlight"><strong>Processing Logic of <code>ConnectionProxy.commit()</code></strong></a></li><li><a href="#introduction-to-rootcontext" class="table-of-contents__link toc-highlight">Introduction to <code>RootContext</code></a></li><li><a href="#globaltransactionalinterceptor-handles-methods-with-globaltransactional-or-globallock" class="table-of-contents__link toc-highlight"><strong><code>GlobalTransactionalInterceptor</code> handles methods with <code>@GlobalTransactional</code> or <code>@GlobalLock</code></strong></a><ul><li><a href="#first-handle-globaltransactional" class="table-of-contents__link toc-highlight"><strong>First, handle <code>@GlobalTransactional</code></strong></a></li><li><a href="#continue-to-handle-globallock" class="table-of-contents__link toc-highlight"><strong>Continue to handle <code>@GlobalLock</code></strong></a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">
                  <div class="fs-12">
                    <div class="center-div">
                      <span>Apache Seata is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</span>
                    </div>
                    <br>
                    <div class="center-div">
                      <span>Copyright © 2023-2024, The Apache Software Foundation Apache Seata, Seata, Apache, Apache Incubator, the Apache feather, the Apache Incubator logo and the Apache Seata project logo are either registered trademarks or trademarks of the Apache Software Foundation.</span>
                      <br>
                    </div>
                    <br>
                  </div>
                  </div></div></div></footer></div>
<script src="/assets/js/runtime~main.c989ad4e.js"></script>
<script src="/assets/js/main.db935d91.js"></script>
</body>
</html>