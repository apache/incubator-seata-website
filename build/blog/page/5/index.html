<!doctype html>
<html lang="en-US" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://chai001125.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="http://chai001125.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="http://chai001125.github.io/blog/page/5"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="keywords" content="Seata"><meta data-rh="true" property="og:title" content="Blog | Seata"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="http://chai001125.github.io/blog/page/5"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/blog/page/5" hreflang="en-US"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/zh-cn/blog/page/5" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/blog/page/5" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Seata Atom Feed">




<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.js"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/assets/css/styles.c84d55f4.css">
<link rel="preload" href="/assets/js/runtime~main.6888d26e.js" as="script">
<link rel="preload" href="/assets/js/main.96f5711d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/">Home</a><a class="navbar__item navbar__link" href="/docs/overview/what-is-seata">Docs</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Solutions</a><ul class="dropdown__menu"><li><a href="https://cn.aliyun.com/product/aliware/mse?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Seata in cloud<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://cn.aliyun.com/product/aliware/mse?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Microservice solutions<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/ahas?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">High-availability solution<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://cn.aliyun.com/product/aliware/sae?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Serverless solution for microservices<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/edas?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">PaaS solution<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/servicemesh?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Service mesh solution<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://help.aliyun.com/document_detail/132903.html?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">SOFA distributed transaction<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a class="navbar__item navbar__link" href="/docs/developers/developers_dev">Developers</a><a href="https://mp.weixin.qq.com/s/nvDmIJEuDaNEY3RfTA3UyA" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Recruitment</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/docs/download">Download</a><a href="http://demo.seata.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Console sample</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>En</a><ul class="dropdown__menu"><li><a href="/blog/page/5" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">En</a></li><li><a href="/zh-cn/blog/page/5" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-observable-practice">Seata的可观测实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-lock">详解 Seata AT 模式事务隔离级别与全局锁设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-snowflake-explain">关于新版雪花算法的答疑</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-UUID-generator">Seata基于改良版雪花算法的分布式UUID生成器分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-feature-undo-log-compress">Seata新特性支持 -- undo_log压缩</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-dsproxy-deadlock">ConcurrentHashMap导致的Seata死锁问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-client-start-analysis-02">Seata应用侧启动过程剖析——注册中心与配置中心模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-client-start-analysis-01">Seata应用侧启动过程剖析——RM &amp; TM如何与TC建立连接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrate-seata-tcc-mode-with-spring-cloud">Spring Cloud集成Seata分布式事务-TCC模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-config-manager">Seata配置管理原理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-golang-communication-mode">seata-golang 通信模型详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-datasource-proxy">Seata数据源代理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-demo-in-mac">Mac下的Seata Demo环境搭建（AT模式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-quick-start">Seata 极简入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-ha-practice">Seata 高可用部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-config-center">Seata 配置中心实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/quick-start-use-seata-and-dubbo-services">How to use Seata to ensure consistency between Dubbo Microservices</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/manual-transaction-mode">MT mode</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-11-28T00:00:00.000Z" itemprop="datePublished">November 28, 2019</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>在分析启动部分源码时，我发现 GlobalTransactionScanner 会同时启动 RM 和 TM client，但根据 Seata 的设计来看，TM 负责全局事务的操作，如果一个服务中不需要开启全局事务，此时是不需要启动 TM client的，也就是说项目中如果没有全局事务注解，此时是不是就不需要初始化 TM client 了，因为不是每个微服务，都需要 GlobalTransactional，它此时仅仅作为一个 RM client 而已。</p><p>于是我着手将 GlobalTransactionScanner 稍微更改了初始化的规则，由于之前 GlobalTransactionScanner 调用 初始化方法是在 InitializingBean 中的 afterPropertiesSet() 方法中进行，afterPropertySet() 仅仅是当前 bean 初始化后被调用，此时无法得知当前 Spring 容器是否有全局事务注解。</p><p>因此我去掉了 InitializingBean，改成了是实现 ApplicationListener，在实例化 bean 的过程中检查是否有 GlobalTransactional 注解的存在，最后在 Spring 容器初始化完成之后再调用 RM 和 TM client 初始化方法，这时候就可以根据项目是否有用到全局事务注解来决定是否启动 TM client 了。</p><p>这里附上 PR 地址：<a href="https://github.com/seata/seata/pull/1936" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata/pull/1936</a></p><p>随后在 pr 中讨论中得知，目前 Seata 的设计是只有在发起方的 TM 才可以发起 GlobalRollbackRequest，RM 只能发送 BranchReport(false) 上报分支状态个 TC 服务端，无法直接发送 GlobalRollbackRequest 进行全局回滚操作。具体的交互逻辑如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191128094250.png" class="img_ev3q"></p><p>那么根据上面的设计模型，自然可以按需启动 TM client 了。</p><p>但是 Seata 后面的优化迭代中，还需要考虑的一点是：</p><p>当参与方出现异常时，是否可以直接由参与方的 TM client 发起全局回滚？这也就意味着可以缩短分布式事务的周期时间，尽快释放全局锁让其他数据冲突的事务尽早的获取到锁执行。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20191127202606.png" class="img_ev3q"></p><p>也就是说在一个全局事务当中，只要有一个 RM client 执行本地事务失败了，直接当前服务的 TM client 发起全局事务回滚，不必要等待发起方的 TM 发起的决议回滚通知了。如果要实现这个优化，那么就需要每个服务都需要同时启动 TM client 和 RM client。</p><h1>作者简介：</h1><p>张乘辉，目前就职于中通科技信息中心技术平台部，担任 Java 工程师，主要负责中通消息平台与全链路压测项目的研发，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Contributor，GitHub ID：objcoding。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-11-27T00:00:00.000Z" itemprop="datePublished">November 27, 2019</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>从上一篇文章「<a href="https://mp.weixin.qq.com/s/Pypkm5C9aLPJHYwcM6tAtA" target="_blank" rel="noopener noreferrer">分布式事务中间件Seata的设计原理</a>」讲了下 Seata AT 模式的一些设计原理，从中也知道了 AT 模式的三个角色（RM、TM、TC），接下来我会更新 Seata 源码分析系列文章。今天就来分析 Seata AT 模式在启动的时候都做了哪些操作。</p><h1>客户端启动逻辑</h1><p>TM 是负责整个全局事务的管理器，因此一个全局事务是由 TM 开启的，TM 有个全局管理类 GlobalTransaction，结构如下：</p><p>io.seata.tm.api.GlobalTransaction</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface GlobalTransaction {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void begin() throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void begin(int timeout) throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void begin(int timeout, String name) throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void commit() throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void rollback() throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GlobalStatus getStatus() throws TransactionException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以通过 GlobalTransactionContext 创建一个 GlobalTransaction，然后用 GlobalTransaction 进行全局事务的开启、提交、回滚等操作，因此我们直接用 API 方式使用 Seata AT 模式：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//init seata;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//trx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tx.begin(60000, &quot;testBiz&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 事务处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (Exception exx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tx.rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throw exx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果每次使用全局事务都这样写，难免会造成代码冗余，我们的项目都是基于 Spring 容器，这时我们可以利用 Spring AOP 的特性，用模板模式把这些冗余代码封装模版里，参考 Mybatis-spring 也是做了这么一件事情，那么接下来我们来分析一下基于 Spring 的项目启动 Seata 并注册全局事务时都做了哪些工作。</p><p>我们开启一个全局事务是在方法上加上 <code>@GlobalTransactional</code>注解，Seata 的 Spring 模块中，有个 GlobalTransactionScanner，它的继承关系如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionScanner extends AbstractAutoProxyCreator implements InitializingBean, ApplicationContextAware, DisposableBean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在基于 Spring 项目的启动过程中，对该类会有如下初始化流程：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/image-20191124155455309.png" alt="image-20191124155455309" class="img_ev3q"></p><p>InitializingBean 的 afterPropertiesSet() 方法调用了 initClient() 方法：</p><p>io.seata.spring.annotation.GlobalTransactionScanner#initClient</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RMClient.init(applicationId, txServiceGroup);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>对 TM 和 RM 做了初始化操作。</p><ul><li>TM 初始化</li></ul><p>io.seata.tm.TMClient#init</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void init(String applicationId, String transactionServiceGroup) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 获取 TmRpcClient 实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TmRpcClient tmRpcClient = TmRpcClient.getInstance(applicationId, transactionServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 初始化 TM Client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tmRpcClient.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>调用 TmRpcClient.getInstance() 方法会获取一个 TM 客户端实例，在获取过程中，会创建 Netty 客户端配置文件对象，以及创建 messageExecutor 线程池，该线程池用于在处理各种与服务端的消息交互，在创建 TmRpcClient 实例时，创建 ClientBootstrap，用于管理 Netty 服务的启停，以及 ClientChannelManager，它是专门用于管理 Netty 客户端对象池，Seata 的 Netty 部分配合使用了对象池，后面在分析网络模块会讲到。</p><p>io.seata.core.rpc.netty.AbstractRpcRemotingClient#init</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  clientBootstrap.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 定时尝试连接服务端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timerExecutor.scheduleAtFixedRate(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      clientChannelManager.reconnect(getTransactionServiceGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }, SCHEDULE_INTERVAL_MILLS, SCHEDULE_INTERVAL_MILLS, TimeUnit.SECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mergeSendExecutorService = new ThreadPoolExecutor(MAX_MERGE_SEND_THREAD,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                    MAX_MERGE_SEND_THREAD,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                    KEEP_ALIVE_TIME, TimeUnit.MILLISECONDS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                    new LinkedBlockingQueue&lt;&gt;(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                    new NamedThreadFactory(getThreadPrefix(), MAX_MERGE_SEND_THREAD));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mergeSendExecutorService.submit(new MergedSendRunnable());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  super.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>调用 TM 客户端 init() 方法，最终会启动 netty 客户端（此时还未真正启动，在对象池被调用时才会被真正启动）；开启一个定时任务，定时重新发送 RegisterTMRequest（RM 客户端会发送 RegisterRMRequest）请求尝试连接服务端，具体逻辑是在 NettyClientChannelManager 中的 channels 中缓存了客户端 channel，如果此时 channels 不存在获取已过期，那么就会尝试连接服务端以重新获取 channel 并将其缓存到 channels 中；开启一条单独线程，用于处理异步请求发送，这里用得很巧妙，之后在分析网络模块在具体对其进行分析。</p><p>io.seata.core.rpc.netty.AbstractRpcRemoting#init</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timerExecutor.scheduleAtFixedRate(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (Map.Entry&lt;Integer, MessageFuture&gt; entry : futures.entrySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (entry.getValue().isTimeout()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          futures.remove(entry.getKey());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          entry.getValue().setResultMessage(null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug(&quot;timeout clear future: {}&quot;, entry.getValue().getRequestMessage().getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      nowMills = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }, TIMEOUT_CHECK_INTERNAL, TIMEOUT_CHECK_INTERNAL, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 AbstractRpcRemoting 的 init 方法中，又是开启了一个定时任务，该定时任务主要是用于定时清除 futures 已过期的 futrue，futures 是保存发送请求需要返回结果的 future 对象，该对象有个超时时间，过了超时时间就会自动抛异常，因此需要定时清除已过期的 future 对象。</p><ul><li>RM 初始化</li></ul><p>io.seata.rm.RMClient#init</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void init(String applicationId, String transactionServiceGroup) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RmRpcClient rmRpcClient = RmRpcClient.getInstance(applicationId, transactionServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rmRpcClient.setResourceManager(DefaultResourceManager.get());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rmRpcClient.setClientMessageListener(new RmMessageListener(DefaultRMHandler.get()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rmRpcClient.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> RmRpcClient.getInstance 处理逻辑与 TM 大致相同；ResourceManager 是 RM 资源管理器，负责分支事务的注册、提交、上报、以及回滚操作，以及全局锁的查询操作，DefaultResourceManager 会持有当前所有的 RM 资源管理器，进行统一调用处理，而 get() 方法主要是加载当前的资源管理器，主要用了类似 SPI 的机制，进行灵活加载，如下图，Seata 会扫描 META-INF/services/ 目录下的配置类并进行动态加载。</p><p>ClientMessageListener 是 RM 消息处理监听器，用于负责处理从 TC 发送过来的指令，并对分支进行分支提交、分支回滚，以及 undo log 删除操作；最后 init 方法跟 TM 逻辑也大体一致；DefaultRMHandler 封装了 RM 分支事务的一些具体操作逻辑。</p><p>接下来再看看 wrapIfNecessary 方法究竟做了哪些操作。</p><p>io.seata.spring.annotation.GlobalTransactionScanner#wrapIfNecessary</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 判断是否有开启全局事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (disableGlobalTransaction) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (PROXYED_SET) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (PROXYED_SET.contains(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      interceptor = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //check TCC proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (TCCBeanParserUtils.isTccAutoProxy(bean, beanName, applicationContext)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //TCC interceptor, proxy bean of sofa:reference/dubbo:reference, and LocalTCC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interceptor = new TccActionInterceptor(TCCBeanParserUtils.getRemotingDesc(beanName));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; serviceInterface = SpringProxyUtils.findTargetClass(bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt;[] interfacesIfJdk = SpringProxyUtils.findInterfaces(bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断 bean 中是否有 GlobalTransactional 和 GlobalLock 注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!existsAnnotation(new Class[]{serviceInterface})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp;&amp; !existsAnnotation(interfacesIfJdk)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (interceptor == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 创建代理类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          interceptor = new GlobalTransactionalInterceptor(failureHandlerHook);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOGGER.info(&quot;Bean[{}] with name [{}] would use interceptor [{}]&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  bean.getClass().getName(), beanName, interceptor.getClass().getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (!AopUtils.isAopProxy(bean)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bean = super.wrapIfNecessary(bean, beanName, cacheKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AdvisedSupport advised = SpringProxyUtils.getAdvisedSupport(bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 执行包装目标对象到代理对象  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Advisor[] advisor = super.buildAdvisors(beanName, getAdvicesAndAdvisorsForBean(null, null, null));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Advisor avr : advisor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          advised.addAdvisor(0, avr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      PROXYED_SET.add(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (Exception exx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new RuntimeException(exx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>GlobalTransactionScanner 继承了 AbstractAutoProxyCreator，用于对 Spring AOP 支持，从代码中可看出，用GlobalTransactionalInterceptor 代替了被 GlobalTransactional 和 GlobalLock 注解的方法。</p><p>GlobalTransactionalInterceptor 实现了 MethodInterceptor：</p><p>io.seata.spring.annotation.GlobalTransactionalInterceptor#invoke</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Object invoke(final MethodInvocation methodInvocation) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Class&lt;?&gt; targetClass = methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis()) : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final GlobalTransactional globalTransactionalAnnotation = getAnnotation(method, GlobalTransactional.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final GlobalLock globalLockAnnotation = getAnnotation(method, GlobalLock.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (globalTransactionalAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 全局事务注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else if (globalLockAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 全局锁注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return handleGlobalLock(methodInvocation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return methodInvocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上是代理方法执行的逻辑逻辑，其中 handleGlobalTransaction() 方法里面调用了 TransactionalTemplate 模版：</p><p>io.seata.spring.annotation.GlobalTransactionalInterceptor#handleGlobalTransaction</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private Object handleGlobalTransaction(final MethodInvocation methodInvocation,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       final GlobalTransactional globalTrxAnno) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionalTemplate.execute(new TransactionalExecutor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      public Object execute() throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return methodInvocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      public TransactionInfo getTransactionInfo() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (TransactionalExecutor.ExecutionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>handleGlobalTransaction() 方法执行了就是 TransactionalTemplate 模版类的 execute 方法：</p><p>io.seata.tm.api.TransactionalTemplate#execute</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Object execute(TransactionalExecutor business) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 1. get or create a transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 1.1 get transactionInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TransactionInfo txInfo = business.getTransactionInfo();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (txInfo == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new ShouldNeverHappenException(&quot;transactionInfo does not exist&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. begin transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    beginTransaction(txInfo, tx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Do Your Business</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rs = business.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 3.the needed business exception to rollback.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      completeTransactionAfterThrowing(txInfo,tx,ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 4. everything is fine, commit.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    commitTransaction(tx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //5. clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    triggerAfterCompletion();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cleanUp();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上是不是有一种似曾相识的感觉？没错，以上就是我们使用 API 时经常写的冗余代码，现在 Spring 通过代理模式，把这些冗余代码都封装带模版里面了，它将那些冗余代码统统封装起来统一流程处理，并不需要你显示写出来了，有兴趣的也可以去看看 Mybatis-spring 的源码，也是写得非常精彩。</p><h1>服务端处理逻辑</h1><p>服务端收到客户端的连接，那当然是将其 channel 也缓存起来，前面也说到客户端会发送 RegisterRMRequest/RegisterTMRequest 请求给服务端，服务端收到后会调用 ServerMessageListener 监听器处理：</p><p>io.seata.core.rpc.ServerMessageListener</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ServerMessageListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 处理各种事务，如分支注册、分支提交、分支上报、分支回滚等等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void onTrxMessage(RpcMessage request, ChannelHandlerContext ctx, ServerMessageSender sender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理 RM 客户端的注册连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void onRegRmMessage(RpcMessage request, ChannelHandlerContext ctx,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ServerMessageSender sender, RegisterCheckAuthHandler checkAuthHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 处理 TM 客户端的注册连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void onRegTmMessage(RpcMessage request, ChannelHandlerContext ctx,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ServerMessageSender sender, RegisterCheckAuthHandler checkAuthHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 服务端与客户端保持心跳</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void onCheckMessage(RpcMessage request, ChannelHandlerContext ctx, ServerMessageSender sender)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ChannelManager 是服务端 channel 的管理器，服务端每次和客户端通信，都需要从 ChannelManager 中获取客户端对应的 channel，它用于保存 TM 和 RM 客户端 channel 的缓存结构如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * resourceId -&gt; applicationId -&gt; ip -&gt; port -&gt; RpcContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static final ConcurrentMap&lt;String, ConcurrentMap&lt;String, ConcurrentMap&lt;String, ConcurrentMap&lt;Integer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RpcContext&gt;&gt;&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RM_CHANNELS = new ConcurrentHashMap&lt;String, ConcurrentMap&lt;String, ConcurrentMap&lt;String, ConcurrentMap&lt;Integer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RpcContext&gt;&gt;&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ip+appname,port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static final ConcurrentMap&lt;String, ConcurrentMap&lt;Integer, RpcContext&gt;&gt; TM_CHANNELS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = new ConcurrentHashMap&lt;String, ConcurrentMap&lt;Integer, RpcContext&gt;&gt;();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上的 Map 结构有点复杂：</p><p>RM_CHANNELS：</p><ol><li>resourceId 指的是 RM client 的数据库地址；</li><li>applicationId 指的是 RM client 的服务 Id，比如 springboot 的配置 spring.application.name=account-service 中的 account-service 即是  applicationId；</li><li>ip 指的是 RM client 服务地址；</li><li>port 指的是 RM client 服务地址；</li><li>RpcContext 保存了本次注册请求的信息。</li></ol><p>TM_CHANNELS：</p><ol><li>ip+appname：这里的注释应该是写错了，应该是 appname+ip，即 TM_CHANNELS 的 Map 结构第一个 key 为 appname+ip；</li><li>port：客户端的端口号。</li></ol><p>以下是 RM Client 注册逻辑：</p><p>io.seata.core.rpc.ChannelManager#registerRMChannel</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void registerRMChannel(RegisterRMRequest resourceManagerRequest, Channel channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throws IncompatibleVersionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Version.checkVersion(resourceManagerRequest.getVersion());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 将 ResourceIds 数据库连接连接信息放入一个set中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Set&lt;String&gt; dbkeySet = dbKeytoSet(resourceManagerRequest.getResourceIds());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RpcContext rpcContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 从缓存中判断是否有该channel信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (!IDENTIFIED_CHANNELS.containsKey(channel)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 根据请求注册信息，构建 rpcContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcContext = buildChannelHolder(NettyPoolKey.TransactionRole.RMROLE, resourceManagerRequest.getVersion(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    resourceManagerRequest.getApplicationId(), resourceManagerRequest.getTransactionServiceGroup(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    resourceManagerRequest.getResourceIds(), channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 将 rpcContext 放入缓存中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcContext.holdInIdentifiedChannels(IDENTIFIED_CHANNELS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcContext = IDENTIFIED_CHANNELS.get(channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcContext.addResources(dbkeySet);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (null == dbkeySet || dbkeySet.isEmpty()) { return; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for (String resourceId : dbkeySet) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String clientIp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 将请求信息存入 RM_CHANNELS 中，这里用了 java8 的 computeIfAbsent 方法操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConcurrentMap&lt;Integer, RpcContext&gt; portMap = RM_CHANNELS.computeIfAbsent(resourceId, resourceIdKey -&gt; new ConcurrentHashMap&lt;&gt;())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .computeIfAbsent(resourceManagerRequest.getApplicationId(), applicationId -&gt; new ConcurrentHashMap&lt;&gt;())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .computeIfAbsent(clientIp = getClientIpFromChannel(channel), clientIpKey -&gt; new ConcurrentHashMap&lt;&gt;());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将当前 rpcContext 放入 portMap 中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcContext.holdInResourceManagerChannels(resourceId, portMap);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    updateChannelsResource(resourceId, clientIp, resourceManagerRequest.getApplicationId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从以上代码逻辑能够看出，注册 RM client 主要是将注册请求信息，放入 RM_CHANNELS 缓存中，同时还会从 IDENTIFIED_CHANNELS 中判断本次请求的 channel 是否已验证过，IDENTIFIED_CHANNELS 的结构如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static final ConcurrentMap&lt;Channel, RpcContext&gt; IDENTIFIED_CHANNELS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = new ConcurrentHashMap&lt;&gt;();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>IDENTIFIED_CHANNELS 包含了所有 TM 和 RM 已注册的 channel。</p><p>以下是 TM 注册逻辑：</p><p>io.seata.core.rpc.ChannelManager#registerTMChannel</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void registerTMChannel(RegisterTMRequest request, Channel channel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throws IncompatibleVersionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Version.checkVersion(request.getVersion());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 根据请求注册信息，构建 RpcContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RpcContext rpcContext = buildChannelHolder(NettyPoolKey.TransactionRole.TMROLE, request.getVersion(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             request.getApplicationId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             request.getTransactionServiceGroup(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             null, channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 将 RpcContext 放入 IDENTIFIED_CHANNELS 缓存中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rpcContext.holdInIdentifiedChannels(IDENTIFIED_CHANNELS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // account-service:127.0.0.1:63353</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String clientIdentified = rpcContext.getApplicationId() + Constants.CLIENT_ID_SPLIT_CHAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    + getClientIpFromChannel(channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 将请求信息存入 TM_CHANNELS 缓存中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TM_CHANNELS.putIfAbsent(clientIdentified, new ConcurrentHashMap&lt;Integer, RpcContext&gt;());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 将上一步创建好的get出来，之后再将rpcContext放入这个map的value中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ConcurrentMap&lt;Integer, RpcContext&gt; clientIdentifiedMap = TM_CHANNELS.get(clientIdentified);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rpcContext.holdInClientChannels(clientIdentifiedMap);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TM client 的注册大体类似，把本次注册的信息放入对应的缓存中保存，但比 RM client 的注册逻辑简单一些，主要是 RM client 会涉及分支事务资源的信息，需要注册的信息也会比 TM client 多。</p><p>以上源码分析基于 0.9.0 版本。</p><h1>作者简介</h1><p>张乘辉，目前就职于中通科技信息中心技术平台部，担任 Java 工程师，主要负责中通消息平台与全链路压测项目的研发，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Contributor，GitHub ID：objcoding。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-11-04T00:00:00.000Z" itemprop="datePublished">November 4, 2019</time> · <!-- -->29 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">long187</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Seata 意为：Simple Extensible Autonomous Transaction Architecture，是一套一站式分布式事务解决方案，提供了 AT、TCC、Saga 和 XA 事务模式，本文详解其中的 Saga 模式。<br>项目地址：<a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata</a></p><p>本文作者：屹远（陈龙），蚂蚁金服分布式事务核心研发，Seata Committer。</p><a name="uTwja"></a># 金融分布式应用开发的痛点<p>分布式系统有一个比较明显的问题就是，一个业务流程需要组合一组服务。这样的事情在微服务下就更为明显了，因为这需要业务上的一致性的保证。也就是说，如果一个步骤失败了，那么要么回滚到以前的服务调用，要么不断重试保证所有的步骤都成功。---《左耳听风-弹力设计之“补偿事务”》</p><p>而在金融领域微服务架构下的业务流程往往会更复杂，流程很长，比如一个互联网微贷业务流程调十几个服务很正常，再加上异常处理的流程那就更复杂了，做过金融业务开发的同学会很有体感。</p><p>所以在金融分布式应用开发过程中我们面临一些痛点：</p><ul><li><strong>业务一致性难以保障</strong><br></li></ul><p>我们接触到的大多数业务（比如在渠道层、产品层、集成层的系统），为了保障业务最终一致性，往往会采用“补偿”的方式来做，如果没有一个协调器来支持，开发难度是比较大的，每一步都要在 catch 里去处理前面所有的“回滚”操作，这将会形成“箭头形”的代码，可读性及维护性差。或者重试异常的操作，如果重试不成功可能要转异步重试，甚至最后转人工处理。这些都给开发人员带来极大的负担，开发效率低，且容易出错。</p><ul><li><strong>业务状态难以管理</strong><br></li></ul><p>业务实体很多、实体的状态也很多，往往做完一个业务活动后就将实体的状态更新到了数据库里，没有一个状态机来管理整个状态的变迁过程，不直观，容易出错，造成业务进入一个不正确的状态。</p><ul><li><strong>幂等性难以保障</strong><br></li></ul><p>服务的幂等性是分布式环境下的基本要求，为了保证服务的幂等性往往需要服务开发者逐个去设计，有用数据库唯一键实现的，有用分布式缓存实现的，没有一个统一的方案，开发人员负担大，也容易遗漏，从而造成资损。</p><ul><li><strong>业务监控运维难，缺乏统一的差错守护能力</strong><br></li></ul><p>业务的执行情况监控一般通过打印日志，再基于日志监控平台查看，大多数情况是没有问题的，但是如果业务出错，这些监控缺乏当时的业务上下文，对排查问题不友好，往往需要再去数据库里查。同时日志的打印也依赖于开发，容易遗漏。对于补偿事务往往需要有“差错守护触发补偿”、“工人触发补偿”操作，没有统一的差错守护和处理规范，这些都要开发者逐个开发，负担沉重。</p><a name="hvEU6"></a><h1>理论基础</h1><p>一些场景下，我们对数据有强一致性的需求时，会采用在业务层上需要使用“两阶段提交”这样的分布式事务方案。而在另外一些场景下，我们并不需要这么强的一致性，那就只需要保证最终一致性就可以了。</p><p>例如蚂蚁金服目前在金融核心系统使用的就是 TCC 模式，金融核心系统的特点是一致性要求高（业务上的隔离性）、短流程、并发高。</p><p>而在很多金融核心以上的业务（比如在渠道层、产品层、集成层的系统），这些系统的特点是最终一致即可、流程多、流程长、还可能要调用其它公司的服务（如金融网络）。这是如果每个服务都开发 Try、Confirm、Cancel 三个方法成本高。如果事务中有其它公司的服务，也无法要求其它公司的服务也遵循 TCC 这种开发模式。同时流程长，事务边界太长会影响性能。</p><p>对于事务我们都知道 ACID，也很熟悉 CAP 理论最多只能满足其中两个，所以，为了提高性能，出现了 ACID 的一个变种 BASE。ACID 强调的是一致性（CAP 中的 C），而 BASE 强调的是可用性（CAP 中的 A）。我们知道，在很多情况下，我们是无法做到强一致性的 ACID 的。特别是我们需要跨多个系统的时候，而且这些系统还不是由一个公司所提供的。BASE 的系统倾向于设计出更加有弹力的系统，在短时间内，就算是有数据不同步的风险，我们也应该允许新的交易可以发生，而后面我们在业务上将可能出现问题的事务通过补偿的方式处理掉，以保证最终的一致性。</p><p>所以我们在实际开发中会进行取舍，对于更多的金融核心以上的业务系统可以采用补偿事务，补偿事务处理方面在30年前就提出了 Saga 理论，随着微服务的发展，近些年才逐步受到大家的关注。目前业界比较也公认 Saga 是作为长事务的解决方案。</p><blockquote><p><a href="https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf" target="_blank" rel="noopener noreferrer">https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf</a>[1][http://microservices.io/patterns/data/saga.html]<!-- -->(<a href="http://microservices.io/patterns/data/saga.html)%5B2%5D" target="_blank" rel="noopener noreferrer">http://microservices.io/patterns/data/saga.html)[2]</a></p></blockquote><a name="k8kbY"></a><h1>社区和业界的方案</h1><a name="Oc5Er"></a>## Apache Camel Saga<p>Camel 是实现 EIP（Enterprise Integration Patterns）企业集成模式的一款开源产品，它基于事件驱动的架构，有着良好的性能和吞吐量，它在2.21版本新增加了 Saga EIP。</p><p>Saga EIP 提供了一种方式可以通过 camel route 定义一系列有关联关系的 Action，这些 Action 要么都执行成功，要么都回滚，Saga 可以协调任何通讯协议的分布式服务或本地服务，并达到全局的最终一致性。Saga 不要求整个处理在短时间内完成，因为它不占用任何数据库锁，它可以支持需要长时间处理的请求，从几秒到几天，Camel 的 Saga EIP 是基于 <a href="https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA" target="_blank" rel="noopener noreferrer">Microprofile 的 LRA</a>[3]<!-- -->（Long Running Action），同样也是支持协调任何通讯协议任何语言实现的分布式服务。</p><p>Saga 的实现不会对数据进行加锁，而是在给操作定义它的“补偿操作”，当正常流程执行出错的时候触发那些已经执行过的操作的“补偿操作”，将流程回滚掉。“补偿操作”可以在 Camel route 上用 Java 或 XML DSL（Definition Specific Language）来定义。</p><p>下面是一个 Java DSL 示例：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from(&quot;direct:reserveCredit&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .bean(idService, &quot;generateCustomId&quot;) // generate a custom Id and set it in the body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .to(&quot;direct:creditReservation&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// delegate action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from(&quot;direct:creditReservation&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .saga()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .propagation(SagaPropagation.SUPPORTS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .option(&quot;CreditId&quot;, body()) // mark the current body as needed in the compensating action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .compensation(&quot;direct:creditRefund&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .bean(creditService, &quot;reserveCredit&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .log(&quot;Credit ${header.amount} reserved. Custom Id used is ${body}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// called only if the saga is cancelled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from(&quot;direct:creditRefund&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .transform(header(&quot;CreditId&quot;)) // retrieve the CreditId option from headers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .bean(creditService, &quot;refundCredit&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .log(&quot;Credit for Custom Id ${body} refunded&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>XML DSL 示例：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">route</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">from</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">direct:start</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">saga</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">compensation</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">direct:compensation</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">completion</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">direct:completion</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">option</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">optionName</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">myOptionKey</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">myOptionValue</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">option</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">option</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">optionName</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">myOptionKey2</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">myOptionValue2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">option</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">saga</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">to</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">direct:action1</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">to</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">direct:action2</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">route</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="pQWuF"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eventuate-tram-saga">Eventuate Tram Saga<a href="#eventuate-tram-saga" class="hash-link" aria-label="Direct link to Eventuate Tram Saga" title="Direct link to Eventuate Tram Saga">​</a></h2><p><a href="https://github.com/eventuate-tram/eventuate-tram-sagas" target="_blank" rel="noopener noreferrer">Eventuate Tram Saga</a>[4]<!-- --> 框架是使用 JDBC / JPA 的 Java 微服务的一个 Saga 框架。它也和 Camel Saga 一样采用了 Java DSL 来定义补偿操作：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CreateOrderSaga implements SimpleSaga&lt;CreateOrderSagaData&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private SagaDefinition&lt;CreateOrderSagaData&gt; sagaDefinition =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .withCompensation(this::reject)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .invokeParticipant(this::reserveCredit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .invokeParticipant(this::approve)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public SagaDefinition&lt;CreateOrderSagaData&gt; getSagaDefinition() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return this.sagaDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private CommandWithDestination reserveCredit(CreateOrderSagaData data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long orderId = data.getOrderId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Long customerId = data.getOrderDetails().getCustomerId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Money orderTotal = data.getOrderDetails().getOrderTotal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return send(new ReserveCreditCommand(customerId, orderId, orderTotal))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .to(&quot;customerService&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="scN9h"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="apache-servicecomb-saga">Apache ServiceComb Saga<a href="#apache-servicecomb-saga" class="hash-link" aria-label="Direct link to Apache ServiceComb Saga" title="Direct link to Apache ServiceComb Saga">​</a></h2><p><a href="https://github.com/apache/incubator-servicecomb-saga" target="_blank" rel="noopener noreferrer">ServiceComb Saga</a>[5]<!-- --> 也是一个微服务应用的数据最终一致性解决方案。相对于 <a href="http://design.inf.usi.ch/sites/default/files/biblio/rest-tcc.pdf" target="_blank" rel="noopener noreferrer">TCC</a> 而言，在 try 阶段，Saga 会直接提交事务，后续 rollback 阶段则通过反向的补偿操作来完成。与前面两种不同是它是采用 Java 注解+拦截器的方式来进行“补偿”服务的定义。<br></p><a name="ouwrmp"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="架构">架构：<a href="#架构" class="hash-link" aria-label="Direct link to 架构：" title="Direct link to 架构：">​</a></h4><p>Saga 是由 <strong>alpha</strong> 和 <strong>omega </strong>组成，其中：</p><ul><li>alpha 充当协调者的角色，主要负责对事务进行管理和协调；<br></li><li>omega 是微服务中内嵌的一个 agent，负责对网络请求进行拦截并向 alpha 上报事务事件；<br></li></ul><p>下图展示了 alpha，omega 以及微服务三者的关系：<br>
<img loading="lazy" alt="ServiceComb Saga" src="/assets/images/service-comb-saga-cb30d341b536a9227801771bc0836ee2.png" width="746" height="261" class="img_ev3q"></p><a name="ggflbq"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="使用示例">使用示例：<a href="#使用示例" class="hash-link" aria-label="Direct link to 使用示例：" title="Direct link to 使用示例：">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ServiceA extends AbsService implements IServiceA {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static final Logger LOG = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private IServiceB serviceB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private IServiceC serviceC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public String getServiceName() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;servicea&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public String getTableName() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;testa&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @SagaStart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Compensable(compensationMethod = &quot;cancelRun&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Transactional(rollbackFor = Exception.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Object run(InvokeContext invokeContext) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;A.run called&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    doRunBusi();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invokeContext.isInvokeB(getServiceName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceB.run(invokeContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invokeContext.isInvokeC(getServiceName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceC.run(invokeContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invokeContext.isException(getServiceName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.info(&quot;A.run exception&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new Exception(&quot;A.run exception&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void cancelRun(InvokeContext invokeContext) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;A.cancel called&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    doCancelBusi();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="CnD8r"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="蚂蚁金服的实践">蚂蚁金服的实践<a href="#蚂蚁金服的实践" class="hash-link" aria-label="Direct link to 蚂蚁金服的实践" title="Direct link to 蚂蚁金服的实践">​</a></h2><p>蚂蚁金服内部大规模在使用 TCC 模式分布式事务，主要用于金融核心等对一致性要求高、性能要求高的场景。在更上层的业务系统因为流程多流程长，开发 TCC 成本比较高，大都会权衡采用 Saga 模式来到达业务最终一致性，由于历史的原因不同的 BU 有自己的一套“补偿”事务的方案，基本上是两种：</p><ul><li>一种是当一个服务在失败时需要“重试”或“补偿”时，在执行服务前在数据库插入一条记录，记录状态，当异常时通过定时任务去查询数据库记录并进行“重试”或“补偿”，当业务流程执行成功则删除记录；</li><li>另一种是设计一个状态机引擎和简单的 DSL，编排业务流程和记录业务状态，状态机引擎可以定义“补偿服务”，当异常时由状态机引擎反向调用“补偿服务”进行回滚，同时还会有一个“差错守护”平台，监控那些执行失败或补偿失败的业务流水，并不断进行“补偿”或“重试”；</li></ul><a name="MAZEu"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="方案对比">方案对比<a href="#方案对比" class="hash-link" aria-label="Direct link to 方案对比" title="Direct link to 方案对比">​</a></h2><p>社区和业界的解决方案一般是两种，一种基本状态机或流程引擎通过 DSL 方式编排流程程和补偿定义，一种是基于 Java 注解+拦截器实现补偿，那么这两种方案有什么优缺点呢？</p><table><thead><tr><th><strong>方式</strong></th><th><strong>优点</strong></th><th><strong>缺点</strong></th></tr></thead><tbody><tr><td>状态机+DSL</td><td><br>- 可以用可视化工具来定义业务流程，标准化，可读性高，可实现服务编排的功能<br>- 提高业务分析人员与程序开发人员的沟通效率<br>- 业务状态管理：流程本质就是一个状态机，可以很好的反映业务状态的流转<br>- 提高异常处理灵活性：可以实现宕机恢复后的“向前重试”或“向后补偿”<br>- 天然可以使用 Actor 模型或 SEDA 架构等异步处理引擎来执行，提高整体吞吐量<br></td><td><br>- 业务流程实际是由 JAVA 程序与 DSL 配置组成，程序与配置分离，开发起来比较繁琐<br>- 如果是改造现有业务，对业务侵入性高<br>- 引擎实现成本高<br></td></tr><tr><td>拦截器+java 注解</td><td><br>- 程序与注解是在一起的，开发简单，学习成本低<br>- 方便接入现有业务<br>- 基于动态代理拦截器，框架实现成本低<br></td><td><br>- 框架无法提供 Actor 模型或 SEDA 架构等异步处理模式来提高系统吞吐量<br>- 框架无法提供业务状态管理<br>- 难以实现宕机恢复后的“向前重试”，因为无法恢复线程上下文<br></td></tr></tbody></table><a name="EKm6f"></a><h1></h1><a name="tw6CG"></a><h1>Seata Saga 的方案</h1><p>Seata Saga 的简介可以看一下<a href="http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">《Seata Saga 官网文档》</a>[6]<!-- -->。</p><p>Seata Saga 采用了状态机+DSL 方案来实现，原因有以下几个：</p><ul><li>状态机+DSL 方案在实际生产中应用更广泛；</li><li>可以使用 Actor 模型或 SEDA 架构等异步处理引擎来执行，提高整体吞吐量；</li><li>通常在核心系统以上层的业务系统会伴随有“服务编排”的需求，而服务编排又有事务最终一致性要求，两者很难分割开，状态机+DSL 方案可以同时满足这两个需求；</li><li>由于 Saga 模式在理论上是不保证隔离性的，在极端情况下可能由于脏写无法完成回滚操作，比如举一个极端的例子, 分布式事务内先给用户 A 充值，然后给用户 B 扣减余额，如果在给A用户充值成功，在事务提交以前，A 用户把线消费掉了，如果事务发生回滚，这时则没有办法进行补偿了，有些业务场景可以允许让业务最终成功，在回滚不了的情况下可以继续重试完成后面的流程，状态机+DSL的方案可以实现“向前”恢复上下文继续执行的能力, 让业务最终执行成功，达到最终一致性的目的。</li></ul><blockquote><p>在不保证隔离性的情况下：业务流程设计时要遵循“宁可长款, 不可短款”的原则，长款意思是客户少了线机构多了钱，以机构信誉可以给客户退款，反之则是短款，少的线可能追不回来了。所以在业务流程设计上一定是先扣款。</p></blockquote><a name="4yL9U"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="状态定义语言seata-state-language">状态定义语言(Seata State Language)<a href="#状态定义语言seata-state-language" class="hash-link" aria-label="Direct link to 状态定义语言(Seata State Language)" title="Direct link to 状态定义语言(Seata State Language)">​</a></h3><ol><li><p>通过状态图来定义服务调用的流程并生成 json 状态语言定义文件；</p></li><li><p>状态图中一个节点可以是调用一个服务，节点可以配置它的补偿节点；</p></li><li><p>状态图 json 由状态机引擎驱动执行，当出现异常时状态引擎反向执行已成功节点对应的补偿节点将事务回滚；</p><blockquote><p>注意: 异常发生时是否进行补偿也可由用户自定义决定</p></blockquote></li><li><p>可以实现服务编排需求，支持单项选择、并发、异步、子状态机、参数转换、参数映射、服务执行状态判断、异常捕获等功能；</p></li></ol><p>假设有一个业务流程要调两个服务，先调库存扣减（InventoryService），再调余额扣减（BalanceService），保证在一个分布式内要么同时成功，要么同时回滚。两个参与者服务都有一个 reduce 方法，表示库存扣减或余额扣减，还有一个 compensateReduce 方法，表示补偿扣减操作。以 InventoryService 为例看一下它的接口定义：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface InventoryService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * reduce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param businessKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param amount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean reduce(String businessKey, BigDecimal amount, Map&lt;String, Object&gt; params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * compensateReduce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param businessKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean compensateReduce(String businessKey, Map&lt;String, Object&gt; params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个业务流程对应的状态图：</p><p><img loading="lazy" alt="示例状态图" src="/assets/images/demo_statelang-90f1fc01bfaf3a795c3b3357e1046f16.png" width="508" height="543" class="img_ev3q"></p><br>对应的 JSON<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reduceInventoryAndBalance&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Comment&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reduce inventory then reduce balance in a transaction&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;StartState&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ReduceInventory&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;States&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;ReduceInventory&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ServiceTask&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;inventoryAction&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceMethod&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reduce&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;CompensateState&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CompensateReduceInventory&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Next&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ChoiceState&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Input&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[businessKey]&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[count]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Output&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;reduceInventoryResult&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$.#root&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Status&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;#root == true&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SU&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;#root == false&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;FA&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;$Exception{java.lang.Throwable}&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;UN&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;ChoiceState&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Choice&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Choices&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;Expression&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;[reduceInventoryResult] == true&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;Next&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;ReduceBalance&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Default&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fail&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;ReduceBalance&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ServiceTask&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;balanceAction&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceMethod&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reduce&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;CompensateState&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CompensateReduceBalance&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Input&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[businessKey]&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[amount]&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;throwException&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$.[mockReduceBalanceFail]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Output&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;compensateReduceBalanceResult&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$.#root&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Status&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;#root == true&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SU&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;#root == false&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;FA&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;$Exception{java.lang.Throwable}&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;UN&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Catch&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;Exceptions&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token string" style="color:#e3116c">&quot;java.lang.Throwable&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;Next&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CompensationTrigger&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Next&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Succeed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;CompensateReduceInventory&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ServiceTask&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;inventoryAction&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceMethod&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;compensateReduce&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Input&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[businessKey]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;CompensateReduceBalance&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ServiceTask&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;balanceAction&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ServiceMethod&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;compensateReduce&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Input&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;$.[businessKey]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;CompensationTrigger&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CompensationTrigger&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Next&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Fail&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;Succeed&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Succeed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;Fail&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fail&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ErrorCode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PURCHASE_FAILED&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Message&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;purchase failed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>状态语言在一定程度上参考了 <a href="https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html" target="_blank" rel="noopener noreferrer">AWS Step Functions</a>[7]<!-- -->。</p><a name="2de9b28a"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="状态机-属性简介">&quot;状态机&quot; 属性简介:<a href="#状态机-属性简介" class="hash-link" aria-label="Direct link to &quot;状态机&quot; 属性简介:" title="Direct link to &quot;状态机&quot; 属性简介:">​</a></h4><ul><li>Name: 表示状态机的名称，必须唯一；</li><li>Comment: 状态机的描述；</li><li>Version: 状态机定义版本；</li><li>StartState: 启动时运行的第一个&quot;状态&quot;；</li><li>States: 状态列表，是一个 map 结构，key 是&quot;状态&quot;的名称，在状态机内必须唯一；</li></ul><a name="2b956670"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="状态-属性简介">&quot;状态&quot; 属性简介:<a href="#状态-属性简介" class="hash-link" aria-label="Direct link to &quot;状态&quot; 属性简介:" title="Direct link to &quot;状态&quot; 属性简介:">​</a></h4><ul><li>Type：&quot;状态&quot; 的类型，比如有：<ul><li>ServiceTask: 执行调用服务任务；</li><li>Choice: 单条件选择路由；</li><li>CompensationTrigger: 触发补偿流程；</li><li>Succeed: 状态机正常结束；</li><li>Fail: 状态机异常结束；</li><li>SubStateMachine: 调用子状态机；</li></ul></li><li>ServiceName: 服务名称，通常是服务的beanId；</li><li>ServiceMethod: 服务方法名称；</li><li>CompensateState: 该&quot;状态&quot;的补偿&quot;状态&quot;；</li><li>Input: 调用服务的输入参数列表，是一个数组，对应于服务方法的参数列表， $.表示使用表达式从状态机上下文中取参数，表达使用的 <a href="https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html" target="_blank" rel="noopener noreferrer">SpringEL</a>[8]<!-- -->， 如果是常量直接写值即可；</li><li>Output: 将服务返回的参数赋值到状态机上下文中，是一个 map 结构，key 为放入到状态机上文时的 key（状态机上下文也是一个 map），value 中 $. 是表示 SpringEL 表达式，表示从服务的返回参数中取值，#root 表示服务的整个返回参数；</li><li>Status: 服务执行状态映射，框架定义了三个状态，SU 成功、FA 失败、UN 未知，我们需要把服务执行的状态映射成这三个状态，帮助框架判断整个事务的一致性，是一个 map 结构，key 是条件表达式，一般是取服务的返回值或抛出的异常进行判断，默认是 SpringEL 表达式判断服务返回参数，带 $Exception{开头表示判断异常类型，value 是当这个条件表达式成立时则将服务执行状态映射成这个值；</li><li>Catch: 捕获到异常后的路由；</li><li>Next: 服务执行完成后下一个执行的&quot;状态&quot;；</li><li>Choices: Choice 类型的&quot;状态&quot;里, 可选的分支列表, 分支中的 Expression 为 SpringEL 表达式，Next 为当表达式成立时执行的下一个&quot;状态&quot;；</li><li>ErrorCode: Fail 类型&quot;状态&quot;的错误码；</li><li>Message: Fail 类型&quot;状态&quot;的错误信息；</li></ul><p>更多详细的状态语言解释请看<a href="http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">《Seata Saga 官网文档》</a>[6<a href="http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">http://seata.io/zh-cn/docs/user/saga.html</a>]。</p><a name="209f0e37"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="状态机引擎原理">状态机引擎原理:<a href="#状态机引擎原理" class="hash-link" aria-label="Direct link to 状态机引擎原理:" title="Direct link to 状态机引擎原理:">​</a></h3><p><img loading="lazy" alt="状态机引擎原理" src="/assets/images/saga_engine_mechanism-38f1563ee8316a5dcabeeba27f511f79.png" width="936" height="672" class="img_ev3q"></p><ul><li>图中的状态图是先执行 stateA, 再执行 stataB，然后执行 stateC；</li><li>&quot;状态&quot;的执行是基于事件驱动的模型，stataA 执行完成后，会产生路由消息放入 EventQueue，事件消费端从 EventQueue 取出消息，执行 stateB；</li><li>在整个状态机启动时会调用 Seata Server 开启分布式事务，并生产 xid, 然后记录&quot;状态机实例&quot;启动事件到本地数据库；</li><li>当执行到一个&quot;状态&quot;时会调用 Seata Server 注册分支事务，并生产 branchId, 然后记录&quot;状态实例&quot;开始执行事件到本地数据库；</li><li>当一个&quot;状态&quot;执行完成后会记录&quot;状态实例&quot;执行结束事件到本地数据库, 然后调用 Seata Server 上报分支事务的状态；</li><li>当整个状态机执行完成，会记录&quot;状态机实例&quot;执行完成事件到本地数据库, 然后调用 Seata Server 提交或回滚分布式事务；</li></ul><a name="808e95dc"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="状态机引擎设计">状态机引擎设计:<a href="#状态机引擎设计" class="hash-link" aria-label="Direct link to 状态机引擎设计:" title="Direct link to 状态机引擎设计:">​</a></h3><p><img loading="lazy" alt="状态机引擎设计" src="/assets/images/saga_engine-41e75396b108b8e6c157d08766368124.png" width="1044" height="702" class="img_ev3q"></p><p>状态机引擎的设计主要分成三层, 上层依赖下层，从下往上分别是：</p><ul><li><p>Eventing 层：</p><ul><li>实现事件驱动架构, 可以压入事件, 并由消费端消费事件, 本层不关心事件是什么消费端执行什么，由上层实现；</li></ul></li><li><p>ProcessController 层：</p><ul><li>由于上层的 Eventing 驱动一个“空”流程执行的执行，&quot;state&quot;的行为和路由都未实现，由上层实现；<blockquote><p>基于以上两层理论上可以自定义扩展任何&quot;流程&quot;引擎。这两层的设计是参考了内部金融网络平台的设计。</p></blockquote></li></ul></li></ul><ul><li>StateMachineEngine 层：<ul><li>实现状态机引擎每种 state 的行为和路由逻辑；</li><li>提供 API、状态机语言仓库；</li></ul></li></ul><a name="73a9fddd"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="saga-模式下服务设计的实践经验">Saga 模式下服务设计的实践经验<a href="#saga-模式下服务设计的实践经验" class="hash-link" aria-label="Direct link to Saga 模式下服务设计的实践经验" title="Direct link to Saga 模式下服务设计的实践经验">​</a></h3><p>下面是实践中总结的在 Saga 模式下微服务设计的一些经验，当然这是推荐做法，并不是说一定要 100% 遵循，没有遵循也有“绕过”方案。</p><blockquote><p>好消息：Seata Saga 模式对微服务的接口参数没有任务要求，这使得 Saga 模式可用于集成遗留系统或外部机构的服务。</p></blockquote><a name="d64c5051"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="允许空补偿">允许空补偿<a href="#允许空补偿" class="hash-link" aria-label="Direct link to 允许空补偿" title="Direct link to 允许空补偿">​</a></h4><ul><li>空补偿：原服务未执行，补偿服务执行了；</li><li>出现原因：<ul><li>原服务 超时（丢包）；</li><li>Saga 事务触发 回滚；</li><li>未收到原服务请求，先收到补偿请求；</li></ul></li></ul><p>所以服务设计时需要允许空补偿，即没有找到要补偿的业务主键时返回补偿成功并将原业务主键记录下来。</p><a name="88a92b17"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="防悬挂控制">防悬挂控制<a href="#防悬挂控制" class="hash-link" aria-label="Direct link to 防悬挂控制" title="Direct link to 防悬挂控制">​</a></h4><ul><li>悬挂：补偿服务 比 原服务 先执行；</li><li>出现原因：<ul><li>原服务 超时（拥堵）；</li><li>Saga 事务回滚，触发 回滚；</li><li>拥堵的原服务到达；</li></ul></li></ul><p>所以要检查当前业务主键是否已经在空补偿记录下来的业务主键中存在，如果存在则要拒绝服务的执行。</p><a name="ce766631"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="幂等控制">幂等控制<a href="#幂等控制" class="hash-link" aria-label="Direct link to 幂等控制" title="Direct link to 幂等控制">​</a></h4><ul><li>原服务与补偿服务都需要保证幂等性, 由于网络可能超时，可以设置重试策略，重试发生时要通过幂等控制避免业务数据重复更新。</li></ul><a name="FO5YS"></a><h1>总结</h1><p>很多时候我们不需要强调强一性，我们基于 BASE 和 Saga 理论去设计更有弹性的系统，在分布式架构下获得更好的性能和容错能力。分布式架构没有银弹，只有适合特定场景的方案，事实上 Seata Saga 是一个具备“服务编排”和“Saga 分布式事务”能力的产品，总结下来它的适用场景是：</p><ul><li>适用于微服务架构下的“长事务”处理；</li><li>适用于微服务架构下的“服务编排”需求；</li><li>适用于金融核心系统以上的有大量组合服务的业务系统（比如在渠道层、产品层、集成层的系统）；</li><li>适用于业务流程中需要集成遗留系统或外部机构提供的服务的场景（这些服务不可变不能对其提出改造要求）。</li></ul><a name="3X7vO"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="文中涉及相关链接">文中涉及相关链接<a href="#文中涉及相关链接" class="hash-link" aria-label="Direct link to 文中涉及相关链接" title="Direct link to 文中涉及相关链接">​</a></h2><p>[1][https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf]<!-- -->(<a href="https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf" target="_blank" rel="noopener noreferrer">https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf</a>)<br>[2][http://microservices.io/patterns/data/saga.html]<!-- -->(<a href="http://microservices.io/patterns/data/saga.html" target="_blank" rel="noopener noreferrer">http://microservices.io/patterns/data/saga.html</a>)<br>[3][Microprofile 的 LRA]<!-- -->(<a href="https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA)%EF%BC%9A%5Bhttps://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA%5D(https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA" target="_blank" rel="noopener noreferrer">https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA)：[https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA](https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA</a>)<br>[4][Eventuate Tram Saga]<!-- -->(<a href="https://github.com/eventuate-tram/eventuate-tram-sagas)%EF%BC%9A%5Bhttps://github.com/eventuate-tram/eventuate-tram-sagas%5D(https://github.com/eventuate-tram/eventuate-tram-sagas" target="_blank" rel="noopener noreferrer">https://github.com/eventuate-tram/eventuate-tram-sagas)：[https://github.com/eventuate-tram/eventuate-tram-sagas](https://github.com/eventuate-tram/eventuate-tram-sagas</a>)<br>[5][ServiceComb Saga]<!-- -->(<a href="https://github.com/apache/incubator-servicecomb-saga)%EF%BC%9A%5Bhttps://github.com/apache/servicecomb-pack%5D(https://github.com/apache/servicecomb-pack" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-servicecomb-saga)：[https://github.com/apache/servicecomb-pack](https://github.com/apache/servicecomb-pack</a>)<br>[6][Seata Saga 官网文档]<!-- -->(<a href="http://seata.io/zh-cn/docs/user/saga.html)%EF%BC%9A%5Bhttp://seata.io/zh-cn/docs/user/saga.html%5D(http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">http://seata.io/zh-cn/docs/user/saga.html)：[http://seata.io/zh-cn/docs/user/saga.html](http://seata.io/zh-cn/docs/user/saga.html</a>)<br>[7][AWS Step Functions]<!-- -->(<a href="https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html)%EF%BC%9A%5Bhttps://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html%5D(https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html)：[https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html](https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html</a>)<br>[8][SpringEL]<!-- -->(<a href="https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html)%EF%BC%9A%5Bhttps://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html%5D(https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html" target="_blank" rel="noopener noreferrer">https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html)：[https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html](https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html</a>)<br></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-08-11T00:00:00.000Z" itemprop="datePublished">August 11, 2019</time> · <!-- -->26 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">long187</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>作者：屹远（陈龙），蚂蚁金服分布式事务框架核心研发，Seata Committer。</p><br>本文根据 8 月 11 日 SOFA Meetup#3 广州站 《分布式事务 Seata 及其三种模式详解》主题分享整理，着重分享分布式事务产生的背景、理论基础，以及 Seata 分布式事务的原理以及三种模式（AT、TCC、Saga）的分布式事务实现。<p>现场回顾视频以及 PPT 见文末链接。</p><p><img loading="lazy" alt="3 分布式事务 Seata 三种模式详解-屹远.jpg" src="/assets/images/1-59eeb2c64e493e827495e0417125db43.jpeg" width="746" height="420" class="img_ev3q"></p><a name="Ad95d"></a>## 一、分布式事务产生的背景<a name="Q2ayF"></a>### 1.1 分布式架构演进之 - 数据库的水平拆分<p>蚂蚁金服的业务数据库起初是单库单表，但随着业务数据规模的快速发展，数据量越来越大，单库单表逐渐成为瓶颈。所以我们对数据库进行了水平拆分，将原单库单表拆分成数据库分片。</p><p>如下图所示，分库分表之后，原来在一个数据库上就能完成的写操作，可能就会跨多个数据库，这就产生了跨数据库事务问题。</p><p><img loading="lazy" alt="image.png" src="/assets/images/2-e3a8a7b0f1e093d70faf16a548dd6742.png" width="325" height="214" class="img_ev3q"></p><a name="WBQbC"></a>### 1.2 分布式架构演进之 - 业务服务化拆分<p>在业务发展初期，“一块大饼”的单业务系统架构，能满足基本的业务需求。但是随着业务的快速发展，系统的访问量和业务复杂程度都在快速增长，单系统架构逐渐成为业务发展瓶颈，解决业务系统的高耦合、可伸缩问题的需求越来越强烈。</p><p>如下图所示，蚂蚁金服按照面向服务架构（SOA）的设计原则，将单业务系统拆分成多个业务系统，降低了各系统之间的耦合度，使不同的业务系统专注于自身业务，更有利于业务的发展和系统容量的伸缩。</p><p><img loading="lazy" alt="image.png" src="/assets/images/3-548d85e1cdfbab71650a542d5de5d10a.png" width="557" height="277" class="img_ev3q"></p><p>业务系统按照服务拆分之后，一个完整的业务往往需要调用多个服务，如何保证多个服务间的数据一致性成为一个难题。</p><a name="3oIxE"></a>## 二、分布式事务理论基础<a name="akRiW"></a>### 2.1 两阶段提交协议<p><img loading="lazy" alt="16_16_18__08_13_2019.jpg" src="/assets/images/4-5933efe8b07271b941670f74b7322a1f.jpeg" width="746" height="419" class="img_ev3q"></p><p>两阶段提交协议：事务管理器分两个阶段来协调资源管理器，第一阶段准备资源，也就是预留事务所需的资源，如果每个资源管理器都资源预留成功，则进行第二阶段资源提交，否则协调资源管理器回滚资源。</p><a name="8tfKI"></a>### 2.2 TCC<p><img loading="lazy" alt="16_16_51__08_13_2019.jpg" src="/assets/images/5-79c36a571b40ceb0119e48100150675b.jpeg" width="746" height="416" class="img_ev3q"></p><p>TCC（Try-Confirm-Cancel） 实际上是服务化的两阶段提交协议，业务开发者需要实现这三个服务接口，第一阶段服务由业务代码编排来调用 Try 接口进行资源预留，所有参与者的 Try 接口都成功了，事务管理器会提交事务，并调用每个参与者的 Confirm 接口真正提交业务操作，否则调用每个参与者的 Cancel 接口回滚事务。</p><a name="IXxpF"></a>### 2.3 Saga<p><img loading="lazy" alt="3 分布式事务 Seata 三种模式详解-屹远-9.jpg" src="/assets/images/6-9d33493d97af453a8450f0739fa60a0f.jpeg" width="746" height="420" class="img_ev3q"></p><p>Saga 是一种补偿协议，在 Saga 模式下，分布式事务内有多个参与者，每一个参与者都是一个冲正补偿服务，需要用户根据业务场景实现其正向操作和逆向回滚操作。</p><p>分布式事务执行过程中，依次执行各参与者的正向操作，如果所有正向操作均执行成功，那么分布式事务提交。如果任何一个正向操作执行失败，那么分布式事务会退回去执行前面各参与者的逆向回滚操作，回滚已提交的参与者，使分布式事务回到初始状态。</p><p>Saga 理论出自 Hector &amp; Kenneth 1987发表的论文 Sagas。<br></p><br>Saga 正向服务与补偿服务也需要业务开发者实现。<a name="fZPaN"></a>## 三、Seata 及其三种模式详解<a name="IgVM7"></a>### 3.1 分布式事务 Seata 介绍<p>Seata（Simple Extensible Autonomous Transaction Architecture，简单可扩展自治事务框架）是 2019 年 1 月份蚂蚁金服和阿里巴巴共同开源的分布式事务解决方案。Seata 开源半年左右，目前已经有超过 1.1 万 star，社区非常活跃。我们热忱欢迎大家参与到 Seata 社区建设中，一同将 Seata 打造成开源分布式事务标杆产品。</p><p>Seata：<a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">https://</a><a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">github.com/seata/seata</a><br></p><br>![image.png](/img/saga/sofameetup3_img/7.png)<a name="zyy0l"></a>### 3.2 分布式事务 Seata 产品模块<p>如下图所示，Seata 中有三大模块，分别是 TM、RM 和 TC。 其中 TM 和 RM 是作为 Seata 的客户端与业务系统集成在一起，TC 作为 Seata 的服务端独立部署。</p><p><img loading="lazy" alt="image.png" src="/assets/images/8-1e7e5bd472714f2a5eaf932b449942b2.png" width="564" height="301" class="img_ev3q"></p><p>在 Seata 中，分布式事务的执行流程：</p><ul><li>TM 开启分布式事务（TM 向 TC 注册全局事务记录）；</li><li>按业务场景，编排数据库、服务等事务内资源（RM 向 TC 汇报资源准备状态 ）；</li><li>TM 结束分布式事务，事务一阶段结束（TM 通知 TC 提交/回滚分布式事务）；</li><li>TC 汇总事务信息，决定分布式事务是提交还是回滚；</li><li>TC 通知所有 RM 提交/回滚 资源，事务二阶段结束；</li></ul><a name="1QKqI"></a>### 3.3 分布式事务 Seata 解决方案<p>Seata 会有 4 种分布式事务解决方案，分别是 AT 模式、TCC 模式、Saga 模式和 XA 模式。</p><p><img loading="lazy" alt="15_49_23__08_13_2019.jpg" src="/assets/images/9-92fbc62876258a48b6778d72eaab6af6.jpeg" width="746" height="385" class="img_ev3q"><br></p><a name="784n4"></a>#### 2.3.1 AT 模式<p>今年 1 月份，Seata 开源了 AT 模式。AT 模式是一种无侵入的分布式事务解决方案。在 AT 模式下，用户只需关注自己的“业务 SQL”，用户的 “业务 SQL” 作为一阶段，Seata 框架会自动生成事务的二阶段提交和回滚操作。</p><p><img loading="lazy" alt="image.png" src="/assets/images/10-c19d842e385a2e54cc4b838e11642851.png" width="521" height="238" class="img_ev3q"><br></p><a name="Acfeo"></a>##### AT 模式如何做到对业务的无侵入 ：<ul><li>一阶段：</li></ul><p>在一阶段，Seata 会拦截“业务 SQL”，首先解析 SQL 语义，找到“业务 SQL”要更新的业务数据，在业务数据被更新前，将其保存成“before image”，然后执行“业务 SQL”更新业务数据，在业务数据更新之后，再将其保存成“after image”，最后生成行锁。以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性。</p><p><img loading="lazy" alt="图片3.png" src="/assets/images/11-b62ee2dfd6ab6e9094d2b51451b41cdd.png" width="524" height="314" class="img_ev3q"></p><ul><li>二阶段提交：</li></ul><p>二阶段如果是提交的话，因为“业务 SQL”在一阶段已经提交至数据库， 所以 Seata 框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理即可。</p><p><img loading="lazy" alt="图片4.png" src="/assets/images/12-fb7571a44266fa4692599f2907e93125.png" width="480" height="206" class="img_ev3q"></p><ul><li>二阶段回滚：</li></ul><p>二阶段如果是回滚的话，Seata 就需要回滚一阶段已经执行的“业务 SQL”，还原业务数据。回滚方式便是用“before image”还原业务数据；但在还原前要首先要校验脏写，对比“数据库当前业务数据”和 “after image”，如果两份数据完全一致就说明没有脏写，可以还原业务数据，如果不一致就说明有脏写，出现脏写就需要转人工处理。</p><p><img loading="lazy" alt="图片5.png" src="/assets/images/13-67b42e8743563de3117194847e4119de.png" width="463" height="317" class="img_ev3q"></p><p>AT 模式的一阶段、二阶段提交和回滚均由 Seata 框架自动生成，用户只需编写“业务 SQL”，便能轻松接入分布式事务，AT 模式是一种对业务无任何侵入的分布式事务解决方案。</p><a name="FnD1S"></a>#### 2.3.2 TCC 模式<p>2019 年 3 月份，Seata 开源了 TCC 模式，该模式由蚂蚁金服贡献。TCC 模式需要用户根据自己的业务场景实现 Try、Confirm 和 Cancel 三个操作；事务发起方在一阶段执行 Try 方式，在二阶段提交执行 Confirm 方法，二阶段回滚执行 Cancel 方法。</p><p><img loading="lazy" alt="图片6.png" src="/assets/images/14-bd8bfbb4c59f42028ab03a8c409b1c73.png" width="372" height="325" class="img_ev3q"></p><p>TCC 三个方法描述：</p><ul><li>Try：资源的检测和预留；</li><li>Confirm：执行的业务操作提交；要求 Try 成功 Confirm 一定要能成功；</li><li>Cancel：预留资源释放；</li></ul><p><strong>蚂蚁金服在 TCC 的实践经验</strong><br>**<br><img loading="lazy" alt="16_48_02__08_13_2019.jpg" src="/assets/images/15-02cfa1203b468d38c80caa594a7644f7.jpeg" width="746" height="414" class="img_ev3q"></p><p><strong>1 TCC 设计 - 业务模型分 2 阶段设计：</strong></p><p>用户接入 TCC ，最重要的是考虑如何将自己的业务模型拆成两阶段来实现。</p><p>以“扣钱”场景为例，在接入 TCC 前，对 A 账户的扣钱，只需一条更新账户余额的 SQL 便能完成；但是在接入 TCC 之后，用户就需要考虑如何将原来一步就能完成的扣钱操作，拆成两阶段，实现成三个方法，并且保证一阶段 Try  成功的话 二阶段 Confirm 一定能成功。</p><p><img loading="lazy" alt="图片7.png" src="/assets/images/16-e07ff8c531571c0ef2887d9dc8b4c83f.png" width="588" height="265" class="img_ev3q"></p><p>如上图所示，</p><p>Try 方法作为一阶段准备方法，需要做资源的检查和预留。在扣钱场景下，Try 要做的事情是就是检查账户余额是否充足，预留转账资金，预留的方式就是冻结 A 账户的 转账资金。Try 方法执行之后，账号 A 余额虽然还是 100，但是其中 30 元已经被冻结了，不能被其他事务使用。</p><p>二阶段 Confirm 方法执行真正的扣钱操作。Confirm 会使用 Try 阶段冻结的资金，执行账号扣款。Confirm 方法执行之后，账号 A 在一阶段中冻结的 30 元已经被扣除，账号 A 余额变成 70 元 。</p><p>如果二阶段是回滚的话，就需要在 Cancel 方法内释放一阶段 Try 冻结的 30 元，使账号 A 的回到初始状态，100 元全部可用。</p><p>用户接入 TCC 模式，最重要的事情就是考虑如何将业务模型拆成 2 阶段，实现成 TCC 的 3 个方法，并且保证 Try 成功 Confirm 一定能成功。相对于 AT 模式，TCC 模式对业务代码有一定的侵入性，但是 TCC 模式无 AT 模式的全局行锁，TCC 性能会比 AT 模式高很多。</p><p><strong>2 TCC 设计 - 允许空回滚：</strong><br>**<br><img loading="lazy" alt="16_51_44__08_13_2019.jpg" src="/assets/images/17-b2c8866f3bee9d7eacf27c0e02f0ef68.jpeg" width="746" height="414" class="img_ev3q"></p><p>Cancel 接口设计时需要允许空回滚。在 Try 接口因为丢包时没有收到，事务管理器会触发回滚，这时会触发 Cancel 接口，这时 Cancel 执行时发现没有对应的事务 xid 或主键时，需要返回回滚成功。让事务服务管理器认为已回滚，否则会不断重试，而 Cancel 又没有对应的业务数据可以进行回滚。</p><p><strong>3 TCC 设计 - 防悬挂控制：</strong><br>**<br><img loading="lazy" alt="16_51_56__08_13_2019.jpg" src="/assets/images/18-3cfd6186d46d6c1cf79f4b5aea91aea0.jpeg" width="746" height="416" class="img_ev3q"></p><p>悬挂的意思是：Cancel 比 Try 接口先执行，出现的原因是 Try 由于网络拥堵而超时，事务管理器生成回滚，触发 Cancel 接口，而最终又收到了 Try 接口调用，但是 Cancel 比 Try 先到。按照前面允许空回滚的逻辑，回滚会返回成功，事务管理器认为事务已回滚成功，则此时的 Try 接口不应该执行，否则会产生数据不一致，所以我们在 Cancel 空回滚返回成功之前先记录该条事务 xid 或业务主键，标识这条记录已经回滚过，Try 接口先检查这条事务xid或业务主键如果已经标记为回滚成功过，则不执行 Try 的业务操作。</p><p><strong>4 TCC 设计 - 幂等控制：</strong><br>**<br><img loading="lazy" alt="16_52_07__08_13_2019.jpg" src="/assets/images/19-cbc9396d9760ae9eee6ef163c21e8034.jpeg" width="746" height="415" class="img_ev3q"></p><p>幂等性的意思是：对同一个系统，使用同样的条件，一次请求和重复的多次请求对系统资源的影响是一致的。因为网络抖动或拥堵可能会超时，事务管理器会对资源进行重试操作，所以很可能一个业务操作会被重复调用，为了不因为重复调用而多次占用资源，需要对服务设计时进行幂等控制，通常我们可以用事务 xid 或业务主键判重来控制。</p><a name="dsMch"></a>#### 2.3.3 Saga 模式<p>Saga 模式是 Seata 即将开源的长事务解决方案，将由蚂蚁金服主要贡献。在 Saga 模式下，分布式事务内有多个参与者，每一个参与者都是一个冲正补偿服务，需要用户根据业务场景实现其正向操作和逆向回滚操作。</p><p>分布式事务执行过程中，依次执行各参与者的正向操作，如果所有正向操作均执行成功，那么分布式事务提交。如果任何一个正向操作执行失败，那么分布式事务会去退回去执行前面各参与者的逆向回滚操作，回滚已提交的参与者，使分布式事务回到初始状态。</p><p><img loading="lazy" alt="图片8.png" src="/assets/images/20-7a8ab27e616b4987792c11ff82ac900d.png" width="360" height="359" class="img_ev3q"></p><p>Saga 模式下分布式事务通常是由事件驱动的，各个参与者之间是异步执行的，Saga 模式是一种长事务解决方案。</p><p><strong>1 Saga 模式使用场景</strong><br>**<br><img loading="lazy" alt="16_44_58__08_13_2019.jpg" src="/assets/images/21-cb2c15b7cda9ba7e3870b03efb42b0f7.jpeg" width="746" height="416" class="img_ev3q"></p><p>Saga 模式适用于业务流程长且需要保证事务最终一致性的业务系统，Saga 模式一阶段就会提交本地事务，无锁、长流程情况下可以保证性能。</p><p>事务参与者可能是其它公司的服务或者是遗留系统的服务，无法进行改造和提供 TCC 要求的接口，可以使用 Saga 模式。</p><p>Saga模式的优势是：</p><ul><li>一阶段提交本地数据库事务，无锁，高性能；</li><li>参与者可以采用事务驱动异步执行，高吞吐；</li><li>补偿服务即正向服务的“反向”，易于理解，易于实现；</li></ul><p>缺点：Saga 模式由于一阶段已经提交本地数据库事务，且没有进行“预留”动作，所以不能保证隔离性。后续会讲到对于缺乏隔离性的应对措施。<br><strong>2 基于状态机引擎的 Saga 实现</strong></p><p><img loading="lazy" alt="17_13_19__08_13_2019.jpg" src="/assets/images/22-d2bafd9570e63096283bb8cad41a0f43.png" width="1222" height="646" class="img_ev3q"></p><p>目前 Saga 的实现一般有两种，一种是通过事件驱动架构实现，一种是基于注解加拦截器拦截业务的正向服务实现。Seata 目前是采用事件驱动的机制来实现的，Seata 实现了一个状态机，可以编排服务的调用流程及正向服务的补偿服务，生成一个 json 文件定义的状态图，状态机引擎驱动到这个图的运行，当发生异常的时候状态机触发回滚，逐个执行补偿服务。当然在什么情况下触发回滚用户是可以自定义决定的。该状态机可以实现服务编排的需求，它支持单项选择、并发、异步、子状态机调用、参数转换、参数映射、服务执行状态判断、异常捕获等功能。</p><p><strong>3 状态机引擎原理</strong><br></p><p><img loading="lazy" alt="16_45_32__08_13_2019.jpg" src="/assets/images/23-1d09ccedb0eb9f45ddda46963f6a9f12.png" width="1240" height="647" class="img_ev3q"></p><p>该状态机引擎的基本原理是，它基于事件驱动架构，每个步骤都是异步执行的，步骤与步骤之间通过事件队列流转，<br>极大的提高系统吞吐量。每个步骤执行时会记录事务日志，用于出现异常时回滚时使用，事务日志会记录在与业务表所在的数据库内，提高性能。</p><p><strong>4 状态机引擎设计</strong></p><p><img loading="lazy" alt="16_45_46__08_13_2019.jpg" src="/assets/images/24-15fdd730a55833c61ceb860ada0f871b.jpeg" width="746" height="411" class="img_ev3q"></p><p>该状态机引擎分成了三层架构的设计，最底层是“事件驱动”层，实现了 EventBus 和消费事件的线程池，是一个 Pub-Sub 的架构。第二层是“流程控制器”层，它实现了一个极简的流程引擎框架，它驱动一个“空”的流程执行，“空”的意思是指它不关心流程节点做什么事情，它只执行每个节点的 process 方法，然后执行 route 方法流转到下一个节点。这是一个通用框架，基于这两层，开发者可以实现任何流程引擎。最上层是“状态机引擎”层，它实现了每种状态节点的“行为”及“路由”逻辑代码，提供 API 和状态图仓库，同时还有一些其它组件，比如表达式语言、逻辑计算器、流水生成器、拦截器、配置管理、事务日志记录等。</p><p><strong>5 Saga 服务设计经验</strong></p><p>和TCC类似，Saga的正向服务与反向服务也需求遵循以下设计原则：</p><p><strong>1）Saga 服务设计 - 允许空补偿</strong><br>**<br><img loading="lazy" alt="16_52_22__08_13_2019.jpg" src="/assets/images/25-2cae6395619166a3c23e698ac2306f8b.jpeg" width="746" height="415" class="img_ev3q"></p><p><strong>2）Saga 服务设计 - 防悬挂控制</strong><br>**<br><img loading="lazy" alt="16_52_52__08_13_2019.jpg" src="/assets/images/26-ead26d36857d8ae91dbb16ff72873653.jpeg" width="746" height="417" class="img_ev3q"></p><p><strong>3）Saga 服务设计 - 幂等控制</strong><br>**<br><img loading="lazy" alt="3 分布式事务 Seata 三种模式详解-屹远-31.jpg" src="/assets/images/27-11883ffbfbca7e56a3a5984f3e0c3fe6.jpeg" width="746" height="420" class="img_ev3q"></p><p><strong>4）Saga 设计 - 自定义事务恢复策略</strong><br>**<br><img loading="lazy" alt="16_53_07__08_13_2019.jpg" src="/assets/images/28-73c6b9cfb082be166cb84a9381b81c0f.jpeg" width="746" height="414" class="img_ev3q"></p><p>前面讲到 Saga 模式不保证事务的隔离性，在极端情况下可能出现脏写。比如在分布式事务未提交的情况下，前一个服务的数据被修改了，而后面的服务发生了异常需要进行回滚，可能由于前面服务的数据被修改后无法进行补偿操作。这时的一种处理办法可以是“重试”继续往前完成这个分布式事务。由于整个业务流程是由状态机编排的，即使是事后恢复也可以继续往前重试。所以用户可以根据业务特点配置该流程的事务处理策略是优先“回滚”还是“重试”，当事务超时的时候，Server 端会根据这个策略不断进行重试。</p><p>由于 Saga 不保证隔离性，所以我们在业务设计的时候需要做到“宁可长款，不可短款”的原则，长款是指在出现差错的时候站在我方的角度钱多了的情况，钱少了则是短款，因为如果长款可以给客户退款，而短款则可能钱追不回来了，也就是说在业务设计的时候，一定是先扣客户帐再入帐，如果因为隔离性问题造成覆盖更新，也不会出现钱少了的情况。</p><p><strong>6 基于注解和拦截器的 Saga 实现</strong><br>**<br><img loading="lazy" alt="17_13_37__08_13_2019.jpg" src="/assets/images/29-3d3a00510ed54a37763e1558f7343789.jpeg" width="746" height="416" class="img_ev3q"></p><p>还有一种 Saga 的实现是基于注解+拦截器的实现，Seata 目前没有实现，可以看上面的伪代码来理解一下，one 方法上定义了 @SagaCompensable 的注解，用于定义 one 方法的补偿方法是 compensateOne 方法。然后在业务流程代码 processA 方法上定义 @SagaTransactional 注解，启动 Saga 分布式事务，通过拦截器拦截每个正向方法当出现异常的时候触发回滚操作，调用正向方法的补偿方法。</p><p><strong>7 两种 Saga 实现优劣对比</strong></p><p>两种 Saga 的实现各有又缺点，下面表格是一个对比：</p><p><img loading="lazy" alt="17_13_49__08_13_2019.jpg" src="/assets/images/30-990cbb972417453d06119316c2c1bc7e.jpeg" width="746" height="415" class="img_ev3q"></p><p>状态机引擎的最大优势是可以通过事件驱动的方法异步执行提高系统吞吐，可以实现服务编排需求，在 Saga 模式缺乏隔离性的情况下，可以多一种“向前重试”的事情恢复策略。注解加拦截器的的最大优势是，开发简单、学习成本低。</p><a name="Gpkrf"></a>## 总结<p>本文先回顾了分布式事务产生的背景及理论基础，然后重点讲解了 Seata 分布式事务的原理以及三种模式（AT、TCC、Saga）的分布式事务实现。</p><p>Seata 的定位是分布式事全场景解决方案，未来还会有 XA 模式的分布式事务实现，每种模式都有它的适用场景，AT 模式是无侵入的分布式事务解决方案，适用于不希望对业务进行改造的场景，几乎0学习成本。TCC 模式是高性能分布式事务解决方案，适用于核心系统等对性能有很高要求的场景。Saga 模式是长事务解决方案，适用于业务流程长且需要保证事务最终一致性的业务系统，Saga 模式一阶段就会提交本地事务，无锁，长流程情况下可以保证性能，多用于渠道层、集成层业务系统。事务参与者可能是其它公司的服务或者是遗留系统的服务，无法进行改造和提供 TCC 要求的接口，也可以使用 Saga 模式。</p><p>本次分享的视频回顾以及PPT 查看地址：<a href="https://tech.antfin.com/community/activities/779/review" target="_blank" rel="noopener noreferrer">https://tech.antfin.com/community/activities/779/review</a></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-07-11T00:00:00.000Z" itemprop="datePublished">July 11, 2019</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>在微服务架构体系下，我们可以按照业务模块分层设计，单独部署，减轻了服务部署压力，也解耦了业务的耦合，避免了应用逐渐变成一个庞然怪物，从而可以轻松扩展，在某些服务出现故障时也不会影响其它服务的正常运行。总之，微服务在业务的高速发展中带给我们越来越多的优势，但是微服务并不是十全十美，因此不能盲目过度滥用，它有很多不足，而且会给系统带来一定的复杂度，其中伴随而来的分布式事务问题，是微服务架构体系下必然需要处理的一个痛点，也是业界一直关注的一个领域，因此也出现了诸如 CAP 和 BASE 等理论。</p><p>在今年年初，阿里开源了一个分布式事务中间件，起初起名为 Fescar，后改名为 Seata，在它开源之初，我就知道它肯定要火，因为这是一个解决痛点的开源项目，Seata 一开始就是冲着对业务无侵入与高性能方向走，这正是我们对解决分布式事务问题迫切的需求。因为待过的几家公司，用的都是微服务架构，但是在解决分布式事务的问题上都不太优雅，所以我也在一直关注 Seata 的发展，今天就简要说说它的一些设计上的原理，后续我将会对它的各个模块进行深入源码分析，感兴趣的可以持续关注我的公众号或者博客，不要跟丢。</p><h1>分布式事务解决的方案有哪些？</h1><p>目前分布式事务解决的方案主要有对业务无入侵和有入侵的方案，无入侵方案主要有基于数据库 XA 协议的两段式提交（2PC）方案，它的优点是对业务代码无入侵，但是它的缺点也是很明显：必须要求数据库对 XA 协议的支持，且由于 XA 协议自身的特点，它会造成事务资源长时间得不到释放，锁定周期长，而且在应用层上面无法干预，因此它性能很差，它的存在相当于七伤拳那样“伤人七分，损己三分”，因此在互联网项目中并不是很流行这种解决方案。</p><p>为了这个弥补这种方案带来性能低的问题，大佬们又想出了很多种方案来解决，但这无一例外都需要通过在应用层做手脚，即入侵业务的方式，比如很出名的 TCC 方案，基于 TCC 也有很多成熟的框架，如 ByteTCC、tcc-transaction 等。以及基于可靠消息的最终一致性来实现，如 RocketMQ 的事务消息。</p><p>入侵代码的方案是基于现有情形“迫不得已”才推出的解决方案，实际上它们实现起来非常不优雅，一个事务的调用通常伴随而来的是对该事务接口增加一系列的反向操作，比如 TCC 三段式提交，提交逻辑必然伴随着回滚的逻辑，这样的代码会使得项目非常臃肿，维护成本高。</p><h1>Seata 各模块之间的关系</h1><p>针对上面所说的分布式事务解决方案的痛点，那很显然，我们理想的分布式事务解决方案肯定是性能要好而且要对业务无入侵，业务层上无需关心分布式事务机制的约束，Seata 正是往这个方向发展的，因此它非常值得期待，它将给我们的微服务架构带来质的提升。</p><p>那 Seata 是怎么做到的呢？下面说说它的各个模块之间的关系。</p><p>Seata 的设计思路是将一个分布式事务可以理解成一个全局事务，下面挂了若干个分支事务，而一个分支事务是一个满足 ACID 的本地事务，因此我们可以操作分布式事务像操作本地事务一样。</p><p>Seata 内部定义了 3个模块来处理全局事务和分支事务的关系和处理过程，这三个组件分别是：</p><ul><li>Transaction Coordinator (TC)： 事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚。</li><li>Transaction Manager (TM)： 控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议。</li><li>Resource Manager (RM)： 控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚。</li></ul><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata.png" class="img_ev3q"></p><p>简要说说整个全局事务的执行步骤：</p><ol><li>TM 向 TC 申请开启一个全局事务，TC 创建全局事务后返回全局唯一的 XID，XID 会在全局事务的上下文中传播；</li><li>RM 向 TC 注册分支事务，该分支事务归属于拥有相同 XID 的全局事务；</li><li>TM 向 TC 发起全局提交或回滚；</li><li>TC 调度 XID 下的分支事务完成提交或者回滚。</li></ol><h1>与 XA 方案有什么不同？</h1><p>Seata 的事务提交方式跟 XA 协议的两段式提交在总体上来说基本是一致的，那它们之间有什么不同呢？</p><p>我们都知道 XA 协议它依赖的是数据库层面来保障事务的一致性，也即是说 XA 的各个分支事务是在数据库层面上驱动的，由于 XA 的各个分支事务需要有 XA 的驱动程序，一方面会导致数据库与 XA 驱动耦合，另一方面它会导致各个分支的事务资源锁定周期长，这也是它没有在互联网公司流行的重要因素。</p><p>基于 XA 协议以上的问题，Seata 另辟蹊径，既然在依赖数据库层会导致这么多问题，那我就从应用层做手脚，这还得从 Seata 的 RM 模块说起，前面也说过 RM 的主要作用了，其实 RM 在内部做了对数据库操作的代理层，如下：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata5.png" class="img_ev3q"></p><p>Seata 在数据源做了一层代理层，所以我们使用 Seata 时，我们使用的数据源实际上用的是 Seata 自带的数据源代理 DataSourceProxy，Seata 在这层代理中加入了很多逻辑，主要是解析 SQL，把业务数据在更新前后的数据镜像组织成回滚日志，并将 undo log 日志插入 undo_log 表中，保证每条更新数据的业务 sql 都有对应的回滚日志存在。</p><p>这样做的好处就是，本地事务执行完可以立即释放本地事务锁定的资源，然后向 TC 上报分支状态。当 TM 决议全局提交时，就不需要同步协调处理了，TC 会异步调度各个 RM 分支事务删除对应的 undo log 日志即可，这个步骤非常快速地可以完成；当 TM 决议全局回滚时，RM 收到 TC 发送的回滚请求，RM 通过 XID 找到对应的 undo log 回滚日志，然后执行回滚日志完成回滚操作。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata6.png" class="img_ev3q"></p><p>如上图所示，XA 方案的 RM 是放在数据库层的，它依赖了数据库的 XA 驱动程序。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/Seata7.png" class="img_ev3q"></p><p>如上图所示，Seata 的 RM 实际上是已中间件的形式放在应用层，不用依赖数据库对协议的支持，完全剥离了分布式事务方案对数据库在协议支持上的要求。</p><h1>分支事务如何提交和回滚？</h1><p>下面详细说说分支事务是如何提交和回滚的：</p><ul><li>第一阶段：</li></ul><p>分支事务利用 RM 模块中对 JDBC 数据源代理，加入了若干流程，对业务 SQL 进行解释，把业务数据在更新前后的数据镜像组织成回滚日志，并生成 undo log 日志，对全局事务锁的检查以及分支事务的注册等，利用本地事务 ACID 特性，将业务 SQL 和 undo log 写入同一个事物中一同提交到数据库中，保证业务 SQL 必定存在相应的回滚日志，最后对分支事务状态向 TC 进行上报。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata2.png" class="img_ev3q"></p><ul><li>第二阶段：</li></ul><p>TM决议全局提交：</p><p>当 TM 决议提交时，就不需要同步协调处理了，TC 会异步调度各个 RM 分支事务删除对应的 undo log 日志即可，这个步骤非常快速地可以完成。这个机制对于性能提升非常关键，我们知道正常的业务运行过程中，事务执行的成功率是非常高的，因此可以直接在本地事务中提交，这步对于提升性能非常显著。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata3.png" class="img_ev3q"></p><p>TM决议全局回滚：</p><p>当 TM 决议回滚时，RM 收到 TC 发送的回滚请求，RM 通过 XID 找到对应的 undo log 回滚日志，然后利用本地事务 ACID 特性，执行回滚日志完成回滚操作并删除 undo log 日志，最后向 TC 进行回滚结果上报。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata4.png" class="img_ev3q"></p><p>业务对以上所有的流程都无感知，业务完全不关心全局事务的具体提交和回滚，而且最重要的一点是 Seata 将两段式提交的同步协调分解到各个分支事务中了，分支事务与普通的本地事务无任何差异，这意味着我们使用 Seata 后，分布式事务就像使用本地事务一样，完全将数据库层的事务协调机制交给了中间件层 Seata 去做了，这样虽然事务协调搬到应用层了，但是依然可以做到对业务的零侵入，从而剥离了分布式事务方案对数据库在协议支持上的要求，且 Seata 在分支事务完成之后直接释放资源，极大减少了分支事务对资源的锁定时间，完美避免了 XA 协议需要同步协调导致资源锁定时间过长的问题。</p><h1>其它方案的补充</h1><p>上面说的其实是 Seata 的默认模式，也叫 AT 模式，它是类似于 XA 方案的两段式提交方案，并且是对业务无侵入，但是这种机制依然是需要依赖数据库本地事务的 ACID 特性，有没有发现，我在上面的图中都强调了必须是支持 ACID 特性的关系型数据库，那么问题就来了，非关系型或者不支持 ACID 的数据库就无法使用 Seata 了，别慌，Seata 现阶段为我们准备了另外一种模式，叫 MT 模式，它是一种对业务有入侵的方案，提交回滚等操作需要我们自行定义，业务逻辑需要被分解为 Prepare/Commit/Rollback 3 部分，形成一个 MT 分支，加入全局事务，它存在的意义是为 Seata 触达更多的场景。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata8.png" class="img_ev3q"></p><p>只不过，它不是 Seata “主打”的模式，它的存在仅仅作为补充的方案，从以上官方的发展远景就可以看出来，Seata 的目标是始终是对业务无入侵的方案。</p><p><em>注：本文图片设计参考Seata官方图</em></p><h1>作者简介：</h1><p>张乘辉，目前就职于中通科技信息中心技术平台部，担任 Java 工程师，主要负责中通消息平台与全链路压测项目的研发，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Contributor，GitHub ID：objcoding。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-04-23T00:00:00.000Z" itemprop="datePublished">April 23, 2019</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">fagongzi(zhangxu19830126@gmail.com)</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="Direct link to 前言" title="Direct link to 前言">​</a></h3><p>TaaS 是 Seata 服务端（TC, Transaction Coordinator）的一种高可用实现，使用 <code>Golang</code> 编写。Taas 由InfiniVision (<a href="http://infinivision.cn" target="_blank" rel="noopener noreferrer">http://infinivision.cn</a>) 贡献给Seata开源社区。现已正式开源，并贡献给 Seata 社区。</p><p>在Seata开源之前，我们内部开始借鉴GTS以及一些开源项目来实现分布式事务的解决方案TaaS(Transaction as a Service)。</p><p>在我们完成TaaS的服务端的开发工作后，Seata（当时还叫Fescar）开源了，并且引起了开源社区的广泛关注，加上阿里巴巴的平台影响力以及社区活跃度，我们认为Seata会成为今后开源分布式事务的标准，我们决定TaaS兼容Seata。</p><p>在发现Seata的服务端的实现是单机的，高可用等并没有实现，于是我们与Seata社区负责人取得联系，并且决定把TaaS开源，回馈开源社区。 同时，我们会长期维护，并且和Seata版本保持同步。</p><p>目前，Seata官方的Java高可用版本也在开发中，TaaS和该高可用版本的设计思想不同，在今后会长期共存。</p><p>TaaS已经开源， github (<a href="https://github.com/seata/seata-go-server)%EF%BC%8C%E6%AC%A2%E8%BF%8E%E5%A4%A7%E5%AE%B6%E8%AF%95%E7%94%A8%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-go-server)，欢迎大家试用。</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="设计原则">设计原则<a href="#设计原则" class="hash-link" aria-label="Direct link to 设计原则" title="Direct link to 设计原则">​</a></h3><ol><li>高性能，性能和机器数量成正比，即通过加入新机器到集群中，就可以提升性能</li><li>高可用，一台机器出现故障，系统能依旧可以对外提供服务，或者在较短的时间内恢复对外服务（Leader切换的时间）</li><li>Auto-Rebalance，集群中增加新的机器，或者有机器下线，系统能够自动的做负载均衡</li><li>强一致，系统的元数据强一致在多个副本中存储</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="设计">设计<a href="#设计" class="hash-link" aria-label="Direct link to 设计" title="Direct link to 设计">​</a></h3><p><img loading="lazy" src="/assets/images/taas-7be6d3d8b28495c0c4e06791b334836a.png" width="828" height="1003" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="高性能">高性能<a href="#高性能" class="hash-link" aria-label="Direct link to 高性能" title="Direct link to 高性能">​</a></h4><p>TaaS的性能和机器数量成正比，为了支持这个特性，在TaaS中处理全局事务的最小单元称为<code>Fragment</code>，系统在启动的时候会设定每个Fragment支持的活跃全局事务的并发数，同时系统会对每个Fragment进行采样，一旦发现Fragment超负荷，会生成新的Fragment来处理更多的并发。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="高可用">高可用<a href="#高可用" class="hash-link" aria-label="Direct link to 高可用" title="Direct link to 高可用">​</a></h4><p>每个<code>Fragment</code>有多个副本和一个Leader，由Leader来处理请求。当Leader出现故障，系统会产生一个新的Leader来处理请求，在新Leader的选举过程中，这个Fragment对外不提供服务，通常这个间隔时间是几秒钟。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="强一致">强一致<a href="#强一致" class="hash-link" aria-label="Direct link to 强一致" title="Direct link to 强一致">​</a></h4><p>TaaS本身不存储全局事务的元数据，元数据存储在Elasticell   (<a href="https://github.com/deepfabric/elasticell" target="_blank" rel="noopener noreferrer">https://github.com/deepfabric/elasticell</a>) 中，Elasticell是一个兼容redis协议的分布式的KV存储，它基于Raft协议来保证数据的一致性。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="auto-rebalance">Auto-Rebalance<a href="#auto-rebalance" class="hash-link" aria-label="Direct link to Auto-Rebalance" title="Direct link to Auto-Rebalance">​</a></h4><p>随着系统的运行，在系统中会存在许多<code>Fragment</code>以及它们的副本，这样会导致在每个机器上，<code>Fragment</code>的分布不均匀，特别是当旧的机器下线或者新的机器上线的时候。TaaS在启动的时候，会选择3个节点作为调度器的角色，调度器负责调度这些<code>Fragment</code>，用来保证每个机器上的Fragment的数量以及Leader个数大致相等，同时还会保证每个Fragment的副本数维持在指定的副本个数。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="fragment副本创建">Fragment副本创建<a href="#fragment副本创建" class="hash-link" aria-label="Direct link to Fragment副本创建" title="Direct link to Fragment副本创建">​</a></h5><p><img loading="lazy" src="/assets/images/taas_add-6451cc0e5ab23c96d9d4db5e3c6cb510.png" width="885" height="596" class="img_ev3q"></p><ol><li>t0时间点，Fragment1在Seata-TC1机器上创建</li><li>t1时间点，Fragment1的副本Fragment1&#x27;在Seata-TC2机器上创建</li><li>t2时间点，Fragment1的副本Fragment1&quot;在Seata-TC3机器上创建</li></ol><p>在t2时间点，Fragment1的三个副本创建完毕。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="fragment副本迁移">Fragment副本迁移<a href="#fragment副本迁移" class="hash-link" aria-label="Direct link to Fragment副本迁移" title="Direct link to Fragment副本迁移">​</a></h5><p><img loading="lazy" src="/assets/images/taas_move-a147fafaaf5a403fe3b493756aeefdea.png" width="1081" height="1121" class="img_ev3q"></p><ol><li>t0时刻点，系统一个存在4个Fragment，分别存在于Seata-TC1，Seata-TC2，Seata-TC3三台机器上</li><li>t1时刻，加入新机器Seata-TC4</li><li>t2时刻，有3个Fragment的副本被迁移到了Seata-TC4这台机器上</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="在线快速体验">在线快速体验<a href="#在线快速体验" class="hash-link" aria-label="Direct link to 在线快速体验" title="Direct link to 在线快速体验">​</a></h3><p>我们在公网搭建了一个体验的环境：</p><ul><li>Seata服务端地址： 39.97.115.141:8091</li><li>UI： <a href="http://39.97.115.141:8084/ui/index.html" target="_blank" rel="noopener noreferrer">http://39.97.115.141:8084/ui/index.html</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="本地快速体验">本地快速体验<a href="#本地快速体验" class="hash-link" aria-label="Direct link to 本地快速体验" title="Direct link to 本地快速体验">​</a></h3><p>使用docker-compose快速体验TaaS的功能。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/seata/taas.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compse up -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于组件依赖较多，docker-compose启动30秒后，可以对外服务</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata服务地址">Seata服务地址<a href="#seata服务地址" class="hash-link" aria-label="Direct link to Seata服务地址" title="Direct link to Seata服务地址">​</a></h4><p>服务默认监听在8091端口，修改Seata对应的服务端地址体验</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-ui">Seata UI<a href="#seata-ui" class="hash-link" aria-label="Direct link to Seata UI" title="Direct link to Seata UI">​</a></h4><p>访问WEB UI <code>http://127.0.0.1:8084/ui/index.html</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="关于infinivision">关于InfiniVision<a href="#关于infinivision" class="hash-link" aria-label="Direct link to 关于InfiniVision" title="Direct link to 关于InfiniVision">​</a></h3><p>深见网络是一家技术驱动的企业级服务提供商，致力于利用人工智能、云计算、区块链、大数据，以及物联网边缘计算技术助力传统企业的数字化转型和升级。深见网络积极拥抱开源文化并将核心算法和架构开源，知名人脸识别软件 InsightFace (<a href="https://github.com/deepinsight/insightface" target="_blank" rel="noopener noreferrer">https://github.com/deepinsight/insightface</a>) (曾多次获得大规模人脸识别挑战冠军)，以及分布式存储引擎 Elasticell (<a href="https://github.com/deepfabric/elasticell" target="_blank" rel="noopener noreferrer">https://github.com/deepfabric/elasticell</a>) 等均是深见网络的开源产品。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="关于作者">关于作者<a href="#关于作者" class="hash-link" aria-label="Direct link to 关于作者" title="Direct link to 关于作者">​</a></h3><p>作者张旭，开源网关Gateway (<a href="https://github.com/fagongzi/gateway" target="_blank" rel="noopener noreferrer">https://github.com/fagongzi/gateway</a>) 作者，目前就职于InfiniVision，负责基础架构相关的研发工作。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-04-15T00:00:00.000Z" itemprop="datePublished">April 15, 2019</time> · <!-- -->21 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">郭树抗 季敏</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-简介">Fescar 简介<a href="#fescar-简介" class="hash-link" aria-label="Direct link to Fescar 简介" title="Direct link to Fescar 简介">​</a></h3><p>常见的分布式事务方式有基于 2PC 的 XA (e.g. atomikos)，从业务层入手的 TCC( e.g. byteTCC)、事务消息 ( e.g. RocketMQ Half Message) 等等。XA 是需要本地数据库支持的分布式事务的协议，资源锁在数据库层面导致性能较差，而支付宝作为布道师引入的 TCC 模式需要大量的业务代码保证，开发维护成本较高。</p><p>分布式事务是业界比较关注的领域，这也是短短时间 Fescar 能收获6k Star的原因之一。Fescar 名字取自 <strong>Fast &amp; Easy Commit And Rollback</strong> ，简单来说 Fescar 通过对本地 RDBMS 分支事务的协调来驱动完成全局事务，是工作在应用层的中间件。主要优点是相对于XA模式是性能较好不长时间占用连接资源，相对于 TCC 方式开发成本和业务侵入性较低。</p><p>类似于 XA，Fescar 将角色分为 TC、RM、TM，事务整体过程模型如下：</p><p><img loading="lazy" alt="Fescar事务过程" src="/assets/images/fescar-microservices-88885eb3928c478894342041e066a5ce.png" width="794" height="478" class="img_ev3q"></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的 XID。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. XID 在微服务调用链路的上下文中传播。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. TM 向 TC 发起针对 XID 的全局提交或回滚决议。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中在目前的实现版本中 TC 是独立部署的进程，维护全局事务的操作记录和全局锁记录，负责协调并驱动全局事务的提交或回滚。TM RM 则与应用程序工作在同一应用进程。RM 对 JDBC 数据源采用代理的方式对底层数据库做管理，利用语法解析，在执行事务时保留快照，并生成 undo log。大概的流程和模型划分就介绍到这里，下面开始对 Fescar 事务传播机制的分析。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-事务传播机制">Fescar 事务传播机制<a href="#fescar-事务传播机制" class="hash-link" aria-label="Direct link to Fescar 事务传播机制" title="Direct link to Fescar 事务传播机制">​</a></h3><p>Fescar 事务传播包括应用内事务嵌套调用和跨服务调用的事务传播。Fescar 事务是怎么在微服务调用链中传播的呢？Fescar 提供了事务 API 允许用户手动绑定事务的 XID 并加入到全局事务中，所以我们根据不同的服务框架机制，将 XID 在链路中传递即可实现事务的传播。</p><p>RPC 请求过程分为调用方与被调用方两部分，我们需要对 XID 在请求与响应时做相应的处理。大致过程为：调用方即请求方将当前事务上下文中的 XID 取出，通过RPC协议传递给被调用方；被调用方从请求中的将 XID 取出，并绑定到自己的事务上下文中，纳入全局事务。微服务框架一般都有相应的 Filter 和 Interceptor 机制，我们来具体分析下 Spring Cloud 与Fescar 的整合过程。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-与-spring-cloud-alibaba-集成部分源码解析">Fescar 与 Spring Cloud Alibaba 集成部分源码解析<a href="#fescar-与-spring-cloud-alibaba-集成部分源码解析" class="hash-link" aria-label="Direct link to Fescar 与 Spring Cloud Alibaba 集成部分源码解析" title="Direct link to Fescar 与 Spring Cloud Alibaba 集成部分源码解析">​</a></h3><p>本部分源码全部来自于 spring-cloud-alibaba-fescar. 源码解析部分主要包括 AutoConfiguration、微服务被调用方和微服务调用方三大部分。对于微服务调用方方式具体分为 RestTemplate 和 Feign，其中对于 Feign 请求方式又进一步细分为结合 Hystrix 和 Sentinel 的使用模式。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-autoconfiguration">Fescar AutoConfiguration<a href="#fescar-autoconfiguration" class="hash-link" aria-label="Direct link to Fescar AutoConfiguration" title="Direct link to Fescar AutoConfiguration">​</a></h4><p>对于 AutoConfiguration 的解析此处只介绍与 Fescar 启动相关的部分，其他部分的解析将穿插于【微服务被调用方】和 【微服务调用方】章节进行介绍。</p><p>Fescar 的启动需要配置 GlobalTransactionScanner，GlobalTransactionScanner 负责初始化 Fescar 的 RM client、TM  client 和 自动代理标注 GlobalTransactional 注解的类。GlobalTransactionScanner bean 的启动通过 GlobalTransactionAutoConfiguration 加载并注入FescarProperties。<br>
<!-- -->FescarProperties 包含了 Fescar 的重要属性 txServiceGroup ，此属性的可通过 application.properties 文件中的 key: spring.cloud.alibaba.fescar.txServiceGroup 读取，默认值为 ${spring.application.name}-fescar-service-group 。txServiceGroup 表示 Fescar 的逻辑事务分组名，此分组名通过配置中心（目前支持文件、Apollo）获取逻辑事务分组名对应的 TC 集群名称，进一步通过集群名称构造出 TC 集群的服务名，通过注册中心（目前支持nacos、redis、zk和eureka）和服务名找到可用的 TC 服务节点，然后 RM client、TM  client 与 TC 进行 rpc 交互。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="微服务被调用方">微服务被调用方<a href="#微服务被调用方" class="hash-link" aria-label="Direct link to 微服务被调用方" title="Direct link to 微服务被调用方">​</a></h4><p>由于调用方的逻辑比较多一点，我们先分析被调用方的逻辑。针对于 Spring Cloud 项目，默认采用的 RPC 传输协议是 HTTP 协议，所以使用了 HandlerInterceptor 机制来对HTTP的请求做拦截。</p><p>HandlerInterceptor 是 Spring 提供的接口， 它有以下三个方法可以被覆写。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Intercept the execution of a handler. Called after HandlerMapping determined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * an appropriate handler object, but before HandlerAdapter invokes the handler.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Intercept the execution of a handler. Called after HandlerAdapter actually</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * invoked the handler, but before the DispatcherServlet renders the view.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Can expose additional model objects to the view via the given ModelAndView.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Nullable ModelAndView modelAndView) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Callback after completion of request processing, that is, after rendering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * the view. Will be called on any outcome of handler execution, thus allows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * for proper resource cleanup.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Nullable Exception ex) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根据注释，我们可以很明确的看到各个方法的作用时间和常用用途。对于 Fescar 集成来讲，它根据需要重写了 preHandle、afterCompletion 方法。</p><p>FescarHandlerInterceptor 的作用是将服务链路传递过来的 XID，绑定到服务节点的事务上下文中，并且在请求完成后清理相关资源。FescarHandlerInterceptorConfiguration 中配置了所有的 url 均进行拦截，对所有的请求过来均会执行该拦截器，进行 XID 的转换与事务绑定。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author xiaojing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Fescar HandlerInterceptor, Convert Fescar information into</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @see com.alibaba.fescar.core.context.RootContext from http request&#x27;s header in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link org.springframework.web.servlet.HandlerInterceptor#preHandle(HttpServletRequest , HttpServletResponse , Object )},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * And clean up Fescar information after servlet method invocation in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link org.springframework.web.servlet.HandlerInterceptor#afterCompletion(HttpServletRequest, HttpServletResponse, Object, Exception)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHandlerInterceptor implements HandlerInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger log = LoggerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .getLogger(FescarHandlerInterceptor.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object handler) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = request.getHeader(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;xid in RootContext {} xid in RpcContext {}&quot;, xid, rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid == null &amp;&amp; rpcXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RootContext.bind(rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.debug(&quot;bind {} to RootContext&quot;, rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void afterCompletion(HttpServletRequest request, HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object handler, Exception e) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = request.getHeader(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(rpcXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String unbindXid = RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;unbind {} from RootContext&quot;, unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!rpcXid.equalsIgnoreCase(unbindXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.warn(&quot;xid in change during RPC from {} to {}&quot;, rpcXid, unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (unbindXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn(&quot;bind {} back to RootContext&quot;, unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>preHandle 在请求执行前被调用，xid 为当前事务上下文已经绑定的全局事务的唯一标识，rpcXid 为请求通过 HTTP Header 传递过来需要绑定的全局事务标识。preHandle 方法中判断如果当前事务上下文中没有 XID，且 rpcXid 不为空，那么就将 rpcXid 绑定到当前的事务上下文。</p><p>afterCompletion 在请求完成后被调用，该方法用来执行资源的相关清理动作。Fescar 通过 RootContext.unbind() 方法对事务上下文涉及到的 XID 进行解绑。下面 if 中的逻辑是为了代码的健壮性考虑，如果遇到 rpcXid和 unbindXid 不相等的情况，再将 unbindXid 重新绑定回去。</p><p>对于 Spring Cloud 来讲，默认采用的 RPC 方式是 HTTP 的方式，所以对被调用方来讲，它的请求拦截方式不用做任何区分，只需要从 Header 中将 XID 就可以取出绑定到自己的事务上下文中即可。但是对于调用方由于请求组件的多样化，包括熔断隔离机制，所以要区分不同的情况做处理，后面我们来具体分析一下。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="微服务调用方">微服务调用方<a href="#微服务调用方" class="hash-link" aria-label="Direct link to 微服务调用方" title="Direct link to 微服务调用方">​</a></h4><p>Fescar 将请求方式分为：RestTemplate、Feign、Feign+Hystrix 和 Feign+Sentinel 。不同的组件通过 Spring Boot 的 Auto Configuration 来完成自动的配置，具体的配置类清单可以看 spring.factories ，下文也会介绍相关的配置类。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="resttemplate">RestTemplate<a href="#resttemplate" class="hash-link" aria-label="Direct link to RestTemplate" title="Direct link to RestTemplate">​</a></h5><p>先来看下如果调用方如果是是基于 RestTemplate 的请求，Fescar 是怎么传递 XID 的。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarRestTemplateInterceptor implements ClientHttpRequestInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ClientHttpResponse intercept(HttpRequest httpRequest, byte[] bytes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClientHttpRequestExecution clientHttpRequestExecution) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpRequestWrapper requestWrapper = new HttpRequestWrapper(httpRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.isEmpty(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requestWrapper.getHeaders().add(RootContext.KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return clientHttpRequestExecution.execute(requestWrapper, bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FescarRestTemplateInterceptor 实现了 ClientHttpRequestInterceptor 接口的 intercept 方法，对调用的请求做了包装，在发送请求时若存在 Fescar 事务上下文 XID 则取出并放到 HTTP Header 中。</p><p>FescarRestTemplateInterceptor 通过 FescarRestTemplateAutoConfiguration 实现将 FescarRestTemplateInterceptor 配置到 RestTemplate 中去。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarRestTemplateAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FescarRestTemplateInterceptor fescarRestTemplateInterceptor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarRestTemplateInterceptor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired(required = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Collection&lt;RestTemplate&gt; restTemplates;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private FescarRestTemplateInterceptor fescarRestTemplateInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostConstruct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.restTemplates != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (RestTemplate restTemplate : restTemplates) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;ClientHttpRequestInterceptor&gt; interceptors = new ArrayList&lt;ClientHttpRequestInterceptor&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        restTemplate.getInterceptors());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                interceptors.add(this.fescarRestTemplateInterceptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                restTemplate.setInterceptors(interceptors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>init 方法遍历所有的 restTemplate ，并将原来 restTemplate 中的拦截器取出，增加 fescarRestTemplateInterceptor 后置入并重排序。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="feign">Feign<a href="#feign" class="hash-link" aria-label="Direct link to Feign" title="Direct link to Feign">​</a></h5><p><img loading="lazy" alt="Feign 类关系图" src="/assets/images/20190305184812-46ab74f3830c4789b6f410150de067d6.png" width="1986" height="788" class="img_ev3q"></p><p>接下来看下 Feign 的相关代码，该包下面的类还是比较多的，我们先从其 AutoConfiguration 入手。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(Client.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AutoConfigureBefore(FeignAutoConfiguration.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarFeignClientAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope(&quot;prototype&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnClass(name = &quot;com.netflix.hystrix.HystrixCommand&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;feign.hystrix.enabled&quot;, havingValue = &quot;true&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignHystrixBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarHystrixFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope(&quot;prototype&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnClass(name = &quot;com.alibaba.csp.sentinel.SphU&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;feign.sentinel.enabled&quot;, havingValue = &quot;true&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignSentinelBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarSentinelFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope(&quot;prototype&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static class FeignBeanPostProcessorConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarBeanPostProcessor fescarBeanPostProcessor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                FescarFeignObjectWrapper fescarFeignObjectWrapper) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarBeanPostProcessor(fescarFeignObjectWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarContextBeanPostProcessor fescarContextBeanPostProcessor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarContextBeanPostProcessor(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarFeignObjectWrapper fescarFeignObjectWrapper(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignObjectWrapper(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FescarFeignClientAutoConfiguration 在存在 Client.class 时生效，且要求作用在 FeignAutoConfiguration 之前。由于FeignClientsConfiguration 是在 FeignAutoConfiguration 生成 FeignContext 生效的，所以根据依赖关系， FescarFeignClientAutoConfiguration 同样早于 FeignClientsConfiguration。</p><p>FescarFeignClientAutoConfiguration 自定义了 Feign.Builder，针对于 feign.sentinel，feign.hystrix  和 feign 的情况做了适配，目的是自定义 feign 中 Client 的真正实现为 FescarFeignClient。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HystrixFeign.builder().retryer(Retryer.NEVER_RETRY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .client(new FescarFeignClient(beanFactory))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SentinelFeign.builder().retryer(Retryer.NEVER_RETRY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .client(new FescarFeignClient(beanFactory));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Feign.builder().client(new FescarFeignClient(beanFactory));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FescarFeignClient 是对原来的 Feign 客户端代理增强，具体代码见下图：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarFeignClient implements Client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Client delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BeanFactory beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarFeignClient(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = new Client.Default(null, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarFeignClient(BeanFactory beanFactory, Client delegate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Response execute(Request request, Request.Options options) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Request modifiedRequest = getModifyRequest(request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.delegate.execute(modifiedRequest, options);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Request getModifyRequest(Request request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, Collection&lt;String&gt;&gt; headers = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.putAll(request.headers());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; fescarXid = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fescarXid.add(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.put(RootContext.KEY_XID, fescarXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Request.create(request.method(), request.url(), headers, request.body(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                request.charset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的过程中我们可以看到，FescarFeignClient 对原来的 Request 做了修改，它首先将 XID 从当前的事务上下文中取出，在 XID 不为空的情况下，将 XID 放到了 Header 中。</p><p>FeignBeanPostProcessorConfiguration 定义了3个 bean：FescarContextBeanPostProcessor、FescarBeanPostProcessor 和 FescarFeignObjectWrapper。其中 FescarContextBeanPostProcessor FescarBeanPostProcessor 实现了Spring  BeanPostProcessor 接口。
以下为 FescarContextBeanPostProcessor 实现。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessBeforeInitialization(Object bean, String beanName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bean instanceof FeignContext &amp;&amp; !(bean instanceof FescarFeignContext)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignContext(getFescarFeignObjectWrapper(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    (FeignContext) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(Object bean, String beanName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>BeanPostProcessor 中的两个方法可以对 Spring 容器中的 Bean 做前后处理，postProcessBeforeInitialization 处理时机是初始化之前，postProcessAfterInitialization 的处理时机是初始化之后，这2个方法的返回值可以是原先生成的实例 bean，或者使用 wrapper 包装后的实例。</p><p>FescarContextBeanPostProcessor  将 FeignContext 包装成 FescarFeignContext。<br>
<!-- -->FescarBeanPostProcessor  将 FeignClient 根据是否继承了 LoadBalancerFeignClient 包装成 FescarLoadBalancerFeignClient 和 FescarFeignClient。</p><p>FeignAutoConfiguration 中的 FeignContext 并没有加 ConditionalOnXXX 的条件，所以 Fescar 采用预置处理的方式将 FeignContext 包装成 FescarFeignContext。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FeignContext feignContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FeignContext context = new FeignContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setConfigurations(this.configurations);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而对于 Feign Client，FeignClientFactoryBean 中会获取 FeignContext 的实例对象。对于开发者采用 @Configuration 注解的自定义配置的 Feign Client 对象，这里会被配置到 builder，导致 FescarFeignBuilder 中增强后的 FescarFeignCliet 失效。FeignClientFactoryBean 中关键代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt; the target type of the Feign client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return a {@link Feign} client created with the specified data and the context information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getTarget() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FeignContext context = applicationContext.getBean(FeignContext.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Feign.Builder builder = feign(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.hasText(this.url)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!this.name.startsWith(&quot;http&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                url = &quot;http://&quot; + this.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                url = this.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            url += cleanPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (T) loadBalance(builder, context, new HardCodedTarget&lt;&gt;(this.type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.name, url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.hasText(this.url) &amp;&amp; !this.url.startsWith(&quot;http&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.url = &quot;http://&quot; + this.url;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = this.url + cleanPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Client client = getOptional(context, Client.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (client != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (client instanceof LoadBalancerFeignClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // not load balancing because we have a url,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // but ribbon is on the classpath, so unwrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                client = ((LoadBalancerFeignClient)client).getDelegate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder.client(client);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Targeter targeter = get(context, Targeter.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (T) targeter.target(this, builder, context, new HardCodedTarget&lt;&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.type, this.name, url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述代码根据是否指定了注解参数中的 URL 来选择直接调用 URL 还是走负载均衡，targeter.target 通过动态代理创建对象。大致过程为：将解析出的feign方法放入map
，再通过将其作为参数传入生成InvocationHandler，进而生成动态代理对象。<br>
<!-- -->FescarContextBeanPostProcessor 的存在，即使开发者对 FeignClient 自定义操作，依旧可以完成 Fescar 所需的全局事务的增强。</p><p>对于 FescarFeignObjectWrapper，我们重点关注下Wrapper方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Object wrap(Object bean) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bean instanceof Client &amp;&amp; !(bean instanceof FescarFeignClient)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (bean instanceof LoadBalancerFeignClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LoadBalancerFeignClient client = ((LoadBalancerFeignClient) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new FescarLoadBalancerFeignClient(client.getDelegate(), factory(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        clientFactory(), this.beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignClient(this.beanFactory, (Client) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>wrap 方法中，如果 bean 是 LoadBalancerFeignClient 的实例对象，那么首先通过 client.getDelegate() 方法将 LoadBalancerFeignClient 代理的实际 Client 对象取出后包装成 FescarFeignClient，再生成 LoadBalancerFeignClient 的子类 FescarLoadBalancerFeignClient 对象。如果 bean 是 Client 的实例对象且不是 FescarFeignClient LoadBalancerFeignClient，那么 bean 会直接包装生成 FescarFeignClient。</p><p>上面的流程设计还是比较巧妙的，首先根据 Spring boot 的 Auto Configuration 控制了配置的先后顺序，同时自定义了 Feign Builder 的Bean，保证了 Client 均是经过增强后的 FescarFeignClient 。再通过 BeanPostProcessor 对Spring 容器中的 Bean 做了一遍包装，保证容器内的Bean均是增强后 FescarFeignClient ，避免 FeignClientFactoryBean getTarget 方法的替换动作。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="hystrix-隔离">Hystrix 隔离<a href="#hystrix-隔离" class="hash-link" aria-label="Direct link to Hystrix 隔离" title="Direct link to Hystrix 隔离">​</a></h5><p>下面我们再来看下 Hystrix 部分，为什么要单独把 Hystrix 拆出来看呢，而且 Fescar 代码也单独实现了个策略类。目前事务上下文 RootContext 的默认实现是基于 ThreadLocal 方式的 ThreadLocalContextCore，也就是上下文其实是和线程绑定的。Hystrix 本身有两种隔离状态的模式，基于信号量或者基于线程池进行隔离。Hystrix 官方建议是采取线程池的方式来充分隔离，也是一般情况下在采用的模式： </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Thread or Semaphore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The default, and the recommended setting, is to run HystrixCommands using thread isolation (THREAD) and HystrixObservableCommands using semaphore isolation (SEMAPHORE).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Commands executed in threads have an extra layer of protection against latencies beyond what network timeouts can offer.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Generally the only time you should use semaphore isolation for HystrixCommands is when the call is so high volume (hundreds per second, per instance) that the overhead of separate threads is too high; this typically only applies to non-network calls.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>service 层的业务代码和请求发出的线程肯定不是同一个，那么 ThreadLocal 的方式就没办法将 XID 传递给 Hystrix 的线程并传递给被调用方的。怎么处理这件事情呢，Hystrix 提供了机制让开发者去自定义并发策略，只需要继承 HystrixConcurrencyStrategy 重写 wrapCallable 方法即可。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHystrixConcurrencyStrategy extends HystrixConcurrencyStrategy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private HystrixConcurrencyStrategy delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FescarHystrixConcurrencyStrategy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = HystrixPlugins.getInstance().getConcurrencyStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HystrixPlugins.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HystrixPlugins.getInstance().registerConcurrencyStrategy(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;K&gt; Callable&lt;K&gt; wrapCallable(Callable&lt;K&gt; c) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (c instanceof FescarContextCallable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Callable&lt;K&gt; wrappedCallable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.delegate != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wrappedCallable = this.delegate.wrapCallable(c);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wrappedCallable = c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (wrappedCallable instanceof FescarContextCallable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return wrappedCallable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarContextCallable&lt;&gt;(wrappedCallable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class FescarContextCallable&lt;K&gt; implements Callable&lt;K&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final Callable&lt;K&gt; actual;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final String xid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarContextCallable(Callable&lt;K&gt; actual) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.actual = actual;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public K call() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return actual.call();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fescar 也提供一个 FescarHystrixAutoConfiguration，在存在 HystrixCommand 的时候生成FescarHystrixConcurrencyStrategy</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(HystrixCommand.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHystrixAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarHystrixConcurrencyStrategy fescarHystrixConcurrencyStrategy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarHystrixConcurrencyStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="参考文献">参考文献<a href="#参考文献" class="hash-link" aria-label="Direct link to 参考文献" title="Direct link to 参考文献">​</a></h3><ul><li><p>Fescar: <a href="https://github.com/alibaba/fescar" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/fescar</a></p></li><li><p>Spring Cloud Alibaba: <a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba" target="_blank" rel="noopener noreferrer">https://github.com/spring-cloud-incubator/spring-cloud-alibaba</a></p></li><li><p>spring-cloud-openfeign: <a href="https://github.com/spring-cloud/spring-cloud-openfeign" target="_blank" rel="noopener noreferrer">https://github.com/spring-cloud/spring-cloud-openfeign</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="本文作者">本文作者<a href="#本文作者" class="hash-link" aria-label="Direct link to 本文作者" title="Direct link to 本文作者">​</a></h3><p> 郭树抗，社区昵称 ywind，曾就职于华为终端云，现搜狐智能媒体中心Java工程师，目前主要负责搜狐号相关开发，对分布式事务、分布式系统和微服务架构有异常浓厚的兴趣。<br>
<!-- -->季敏(清铭)，社区昵称 slievrly，Fescar 开源项目负责人，阿里巴巴中间件 TXC/GTS 核心研发成员，长期从事于分布式中间件核心研发工作，在分布式事务领域有着较丰富的技术积累。</p></li></ul></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-04-15T00:00:00.000Z" itemprop="datePublished">April 15, 2019</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">大菲.Fei</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>针对Fescar 相信很多开发者已经对他并不陌生，当然Fescar 已经成为了过去时，为什么说它是过去时，因为Fescar 已经华丽的变身为Seata。如果还不知道Seata 的朋友，请登录下面网址查看。</p><p>  SEATA GITHUB:<!-- -->[https://github.com/seata/seata]</p><p>对于阿里各位同学的前仆后继，给我们广大开发者带来很多开源软件，在这里对他们表示真挚的感谢与问候。</p><p>今天在这里和大家分享下Spring Cloud 整合Seata 的相关心得。也让更多的朋友在搭建的道路上少走一些弯路，少踩一些坑。</p><h1>2.工程内容</h1><p>本次搭建流程为：client-&gt;网关-&gt;服务消费者-&gt;服务提供者.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                        技术框架：spring cloud gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                spring cloud fegin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                nacos1.0.RC2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                fescar-server0.4.1(Seata)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>关于nacos的启动方式请参考：<a href="https://nacos.io/zh-cn/docs/quick-start.html" target="_blank" rel="noopener noreferrer">Nacos启动参考</a>       </p><p>首先seata支持很多种注册服务方式，在 fescar-server-0.4.1\conf 目录下</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    file.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logback.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nacos-config.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nacos-config.text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registry.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>总共包含五个文件，其中 file.conf和 registry.conf 分别是我们在 服务消费者 &amp; 服务提供者 代码段需要用到的文件。
注：file.conf和 registry.conf 必须在当前使用的应用程序中，即： 服务消费者 &amp; 服务提供者 两个应用在都需要包含。
如果你采用了配置中心 是nacos 、zk ，file.cnf 是可以忽略的。但是type=“file” 如果是为file  就必须得用file.cnf</p><p>下面是registry.conf 文件中的配置信息，其中 registry 是注册服务中心配置。config为配置中心的配置地方。</p><p>从下面可知道目前seata支持nacos，file eureka redis zookeeper 等注册配置方式，默认下载的type=“file” 文件方式，当然这里选用什么方式，取决于</p><p>每个人项目的实际情况，这里我选用的是nacos，eureka的也是可以的，我这边分别对这两个版本进行整合测试均可以通过。</p><p>注：如果整合eureka请选用官方最新版本。</p><h1>3.核心配置</h1><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">registry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # file 、nacos 、eureka、redis、zk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;public&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eureka {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serviceUrl = &quot;http://localhost:1001/eureka&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weight = &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost:6379&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db = &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.timeout = 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect.timeout = 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;file.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # file、nacos 、apollo、zk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace = &quot;public&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apollo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.id = &quot;fescar-server&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apollo.meta = &quot;http://192.168.1.204:8801&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.timeout = 6000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connect.timeout = 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;file.conf&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里要说明的是nacos-config.sh 是针对采用nacos配置中心的话，需要执行的一些默认初始化针对nacos的脚本。</p><p>SEATA的启动方式参考官方： 注意，这里需要说明下，命令启动官方是通过 空格区分参数，所以要注意。这里的IP 是可选参数，因为涉及到DNS解析，在部分情况下，有的时候在注册中心fescar 注入nacos的时候会通过获取地址，如果启动报错注册发现是计算机名称，需要指定IP。或者host配置IP指向。不过这个问题，在最新的SEATA中已经进行了修复。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> fescar-server.sh </span><span class="token number" style="color:#36acaa">8091</span><span class="token plain"> /home/admin/fescar/data/ IP（可选）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面提到过，在我们的代码中也是需要file.conf 和registry.conf 这里着重的地方要说的是file.conf,file.conf只有当registry中
配置file的时候才会进行加载，如果采用ZK、nacos、作为配置中心，可以忽略。因为type指定其他是不加载file.conf的，但是对应的 service.localRgroup.grouplist  和 service.vgroupMapping  需要在支持配置中心 进行指定，这样你的client 在启动后会通过自动从配置中心获取对应的 SEATA 服务 和地址。如果不配置会出现无法连接server的错误。当然如果你采用的eureka在config的地方就需要采用type=&quot;file&quot; 目前SEATA config暂时不支持eureka的形势</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">transport {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # tcp udt unix-domain-socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = &quot;TCP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #NIO NATIVE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server = &quot;NIO&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #enable heartbeat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  heartbeat = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #thread factory for netty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  thread-factory {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boss-thread-prefix = &quot;NettyBoss&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    worker-thread-prefix = &quot;NettyServerNIOWorker&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server-executor-thread-prefix = &quot;NettyServerBizHandler&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    share-boss-worker = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client-selector-thread-prefix = &quot;NettyClientSelector&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client-selector-thread-size = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client-worker-thread-prefix = &quot;NettyClientWorkerThread&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # netty boss thread size,will not be used for UDT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boss-thread-size = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #auto default pin or 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    worker-thread-size = 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #vgroup-&gt;rgroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vgroup_mapping.service-provider-fescar-service-group = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #only support single node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  localRgroup.grouplist = &quot;127.0.0.1:8091&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #degrade current not support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enableDegrade = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  async.commit.buffer.limit = 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lock {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retry.internal = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retry.times = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>4.服务相关</h1><p> 这里有两个地方需要注意</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    grouplist IP，这里是当前fescar-sever的IP端口，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vgroup_mapping的配置。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> vgroup_mapping.服务名称-fescar-service-group,这里 要说下服务名称其实是你当前的consumer 或者provider application.properties的配置的应用名称：spring.application.name=service-provider，源代码中是 获取应用名称与 fescar-service-group 进行拼接，做key值。同理value是当前fescar的服务名称，  cluster = &quot;default&quot;  / application = &quot;default&quot;</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     vgroup_mapping.service-provider-fescar-service-group = &quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #only support single node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      localRgroup.grouplist = &quot;127.0.0.1:8091&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同理无论是provider 还是consumer 都需要这两个文件进行配置。</p><p>如果你采用nacos做配置中心，需要在nacos通过添加配置方式进行配置添加。</p><h1>5.事务使用</h1><p>我这里的代码逻辑是请求通过网关进行负载转发到我的consumer上，在consumer 中通过fegin进行provider请求。官方的例子中是通过fegin进行的，而我们这边直接通过网关转发，所以全局事务同官方的demo一样 也都是在controller层。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DemoController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DemoFeignClient demoFeignClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DemoFeignClient2 demoFeignClient2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional(timeoutMills = 300000, name = &quot;spring-cloud-demo-tx&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/getdemo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String demo() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 调用A 服务  简单save</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResponseData&lt;Integer&gt; result = demoFeignClient.insertService(&quot;test&quot;,1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(result.getStatus()==400) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(result+&quot;+++++++++++++++++++++++++++++++++++++++&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException(&quot;this is error1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 调用B 服务。报错测试A 服务回滚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResponseData&lt;Integer&gt;  result2 = demoFeignClient2.saveService();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(result2.getStatus()==400) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(result2+&quot;+++++++++++++++++++++++++++++++++++++++&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException(&quot;this is error2&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;SUCCESS&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>到此为止核心的事务整合基本到此结束了，我这里是针对A,B 两个provider进行调用，当B发生报错后，进行全局事务回滚。当然每个事务内部都可以通过自己的独立本地事务去处理自己本地事务方式。</p><p>SEATA是通过全局的XID方式进行事务统一标识方式。这里就不列出SEATA需要用的数据库表。具体参考：<a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba/tree/master/spring-cloud-alibaba-examples/fescar-example" target="_blank" rel="noopener noreferrer">spring-cloud-fescar 官方DEMO</a></p><h1>5.数据代理</h1><p>这里还有一个重要的说明就是，在分库服务的情况下，每一个数据库内都需要有一个undo_log的数据库表进行XID统一存储处理。</p><p>同事针对每个提供服务的项目，需要进行数据库连接池的代理。也就是：</p><p>目前只支持Druid连接池，后续会继续支持。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DatabaseConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(destroyMethod = &quot;close&quot;, initMethod = &quot;init&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix=&quot;spring.datasource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DruidDataSource druidDataSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DruidDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSourceProxy dataSourceProxy(DruidDataSource druidDataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DataSourceProxy(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SqlSessionFactory sqlSessionFactory(DataSourceProxy dataSourceProxy) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factoryBean.setDataSource(dataSourceProxy);    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return factoryBean.getObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>大家要注意的就是配置文件和数据代理。如果没有进行数据源代理，undo_log是无数据的，也就是没办进行XID的管理。</p><p>本文作者：大菲.Fei</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-04-15T00:00:00.000Z" itemprop="datePublished">April 15, 2019</time> · <!-- -->26 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">fangliangsheng</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="Direct link to 前言" title="Direct link to 前言">​</a></h2><p>在分布式系统中，分布式事务是一个必须要解决的问题，目前使用较多的是最终一致性方案。自年初阿里开源了Fescar（四月初更名为Seata）后，该项目受到了极大的关注度，目前已接近8000Star。<a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">Seata</a>以高性能和零侵入的方式为目标解决微服务领域的分布式事务难题，目前正处于快速迭代中，近期小目标是生产可用的Mysql版本。关于Seata的总体介绍，可以查看<a href="https://github.com/seata/seata/wiki/%E6%A6%82%E8%A7%88" target="_blank" rel="noopener noreferrer">官方WIKI</a>获得更多更全面的内容介绍。</p><p>本文主要基于spring cloud+spring jpa+spring cloud alibaba fescar+mysql+seata的结构，搭建一个分布式系统的demo，通过seata的debug日志和源代码，从client端（RM、TM）的角度分析说明其工作流程及原理。</p><p>文中代码基于fescar-0.4.1，由于项目刚更名为seata不久，例如一些包名、类名、jar包名称还都是fescar的命名，故下文中仍使用fescar进行表述。</p><p>示例项目：<a href="https://github.com/fescar-group/fescar-samples/tree/master/springcloud-jpa-seata" target="_blank" rel="noopener noreferrer">https://github.com/fescar-group/fescar-samples/tree/master/springcloud-jpa-seata</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="相关概念">相关概念<a href="#相关概念" class="hash-link" aria-label="Direct link to 相关概念" title="Direct link to 相关概念">​</a></h2><ul><li>XID：全局事务的唯一标识，由ip:port:sequence组成</li><li>Transaction Coordinator (TC)：事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚</li><li>Transaction Manager (TM )：控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议</li><li>Resource Manager (RM)：控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分布式框架支持">分布式框架支持<a href="#分布式框架支持" class="hash-link" aria-label="Direct link to 分布式框架支持" title="Direct link to 分布式框架支持">​</a></h2><p>Fescar使用XID表示一个分布式事务，XID需要在一次分布式事务请求所涉的系统中进行传递，从而向feacar-server发送分支事务的处理情况，以及接收feacar-server的commit、rollback指令。
Fescar官方已支持全版本的dubbo协议，而对于spring cloud（spring-boot）的分布式项目社区也提供了相应的实现</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.springframework.cloud</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">spring-cloud-alibaba-fescar</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">2.1.0.BUILD-SNAPSHOT</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>该组件实现了基于RestTemplate、Feign通信时的XID传递功能。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="业务逻辑">业务逻辑<a href="#业务逻辑" class="hash-link" aria-label="Direct link to 业务逻辑" title="Direct link to 业务逻辑">​</a></h2><p>业务逻辑是经典的下订单、扣余额、减库存流程。
根据模块划分为三个独立的服务，且分别连接对应的数据库</p><ul><li>订单：order-server</li><li>账户：account-server</li><li>库存：storage-server</li></ul><p>另外还有发起分布式事务的业务系统</p><ul><li>业务：business-server</li></ul><p>项目结构如下图
<img loading="lazy" alt="在这里插入图片描述" src="/assets/images/20190410114411366-32c3a0b5d1265bbd65911d6d46d284ef.png" width="1034" height="658" class="img_ev3q"></p><p><strong>正常业务</strong></p><ol><li>business发起购买请求</li><li>storage扣减库存</li><li>order创建订单</li><li>account扣减余额</li></ol><p><strong>异常业务</strong></p><ol><li>business发起购买请求</li><li>storage扣减库存</li><li>order创建订单</li><li>account<code>扣减余额异常</code></li></ol><p>正常流程下2、3、4步的数据正常更新全局commit，异常流程下的数据则由于第4步的异常报错全局回滚。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置文件">配置文件<a href="#配置文件" class="hash-link" aria-label="Direct link to 配置文件" title="Direct link to 配置文件">​</a></h2><p>fescar的配置入口文件是<a href="https://github.com/seata/seata/blob/develop/config/src/main/resources/registry.conf" target="_blank" rel="noopener noreferrer">registry.conf</a>,查看代码<a href="https://github.com/seata/seata/blob/develop/config/src/main/java/com/alibaba/fescar/config/ConfigurationFactory.java" target="_blank" rel="noopener noreferrer">ConfigurationFactory</a>得知目前还不能指定该配置文件，所以配置文件名称只能为registry.conf</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static final String REGISTRY_CONF = &quot;registry.conf&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static final Configuration FILE_INSTANCE = new FileConfiguration(REGISTRY_CONF);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在<code>registry</code>中可以指定具体配置的形式，默认使用file类型，在file.conf中有3部分配置内容</p><ol><li>transport
transport部分的配置对应<a href="https://github.com/seata/seata/blob/develop/core/src/main/java/com/alibaba/fescar/core/rpc/netty/NettyServerConfig.java" target="_blank" rel="noopener noreferrer">NettyServerConfig</a>类，用于定义Netty相关的参数，TM、RM与fescar-server之间使用Netty进行通信</li><li>service</li></ol><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     service </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #vgroup</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">rgroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vgroup_mapping</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">my_test_tx_group</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #配置Client连接</span><span class="token constant" style="color:#36acaa">TC</span><span class="token plain">的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword module" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">grouplist</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;127.0.0.1:8091&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #degrade current not support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enableDegrade </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      是否启用seata的分布式事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disableGlobalTransaction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>client</li></ol><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    client </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #</span><span class="token constant" style="color:#36acaa">RM</span><span class="token plain">接收</span><span class="token constant" style="color:#36acaa">TC</span><span class="token plain">的commit通知后缓冲上限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      async</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">commit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">limit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lock </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">internal</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">times</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="数据源proxy">数据源Proxy<a href="#数据源proxy" class="hash-link" aria-label="Direct link to 数据源Proxy" title="Direct link to 数据源Proxy">​</a></h2><p>除了前面的配置文件，fescar在AT模式下稍微有点代码量的地方就是对数据源的代理指定，且目前只能基于<code>DruidDataSource</code>的代理。
注：在最新发布的0.4.2版本中已支持任意数据源类型</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DruidDataSource druidDataSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DruidDataSource druidDataSource = new DruidDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return druidDataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(&quot;dataSource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DataSourceProxy dataSource(DruidDataSource druidDataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DataSourceProxy(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用<code>DataSourceProxy</code>的目的是为了引入<code>ConnectionProxy</code>,fescar无侵入的一方面就体现在<code>ConnectionProxy</code>的实现上，即分支事务加入全局事务的切入点是在本地事务的<code>commit</code>阶段，这样设计可以保证业务数据与<code>undo_log</code>是在一个本地事务中。</p><p><code>undo_log</code>是需要在业务库上创建的一个表，fescar依赖该表记录每笔分支事务的状态及二阶段<code>rollback</code>的回放数据。不用担心该表的数据量过大形成单点问题，在全局事务<code>commit</code>的场景下事务对应的<code>undo_log</code>会异步删除。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">undo_log</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">rollback_info</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">longblob</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_status</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_created</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">datetime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_modified</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">datetime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">ext</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">UNIQUE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">ux_undo_log</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动server">启动Server<a href="#启动server" class="hash-link" aria-label="Direct link to 启动Server" title="Direct link to 启动Server">​</a></h2><p>前往<a href="https://github.com/seata/seata/releases" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata/releases</a> 下载与Client版本对应的fescar-server,避免由于版本的不同导致的协议不一致问题
进入解压之后的 bin 目录，执行</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./fescar-server.sh </span><span class="token number" style="color:#36acaa">8091</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>启动成功输出</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">2019</span><span class="token plain">-04-09 </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">:27:24.637 INFO </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">c.a.fescar.core.rpc.netty.AbstractRpcRemotingServer.start:152 -Server started </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动client">启动Client<a href="#启动client" class="hash-link" aria-label="Direct link to 启动Client" title="Direct link to 启动Client">​</a></h2><p>fescar的加载入口类位于<a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba/blob/finchley/spring-cloud-alibaba-fescar/src/main/java/org/springframework/cloud/alibaba/fescar/GlobalTransactionAutoConfiguration.java" target="_blank" rel="noopener noreferrer">GlobalTransactionAutoConfiguration</a>，对基于spring boot的项目能够自动加载，当然也可以通过其他方式示例化<code>GlobalTransactionScanner</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties({FescarProperties.class})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationContext applicationContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final FescarProperties fescarProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GlobalTransactionAutoConfiguration(ApplicationContext applicationContext, FescarProperties fescarProperties) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.applicationContext = applicationContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.fescarProperties = fescarProperties;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * 示例化GlobalTransactionScanner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * scanner为client初始化的发起类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GlobalTransactionScanner globalTransactionScanner() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String applicationName = this.applicationContext.getEnvironment().getProperty(&quot;spring.application.name&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String txServiceGroup = this.fescarProperties.getTxServiceGroup();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(txServiceGroup)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            txServiceGroup = applicationName + &quot;-fescar-service-group&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.fescarProperties.setTxServiceGroup(txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new GlobalTransactionScanner(applicationName, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到支持一个配置项FescarProperties，用于配置事务分组名称</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.alibaba.fescar.tx-service-group=my_test_tx_group</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果不指定服务组，则默认使用spring.application.name+ -fescar-service-group生成名称，所以不指定spring.application.name启动会报错</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(&quot;spring.cloud.alibaba.fescar&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarProperties {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String txServiceGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FescarProperties() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getTxServiceGroup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.txServiceGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setTxServiceGroup(String txServiceGroup) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.txServiceGroup = txServiceGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>获取applicationId和txServiceGroup后，创建<a href="https://github.com/seata/seata/blob/develop/spring/src/main/java/com/alibaba/fescar/spring/annotation/GlobalTransactionScanner.java" target="_blank" rel="noopener noreferrer">GlobalTransactionScanner</a>对象，主要看类中initClient方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void initClient() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isNullOrEmpty(applicationId) || StringUtils.isNullOrEmpty(txServiceGroup)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;applicationId: &quot; + applicationId + &quot;, txServiceGroup: &quot; + txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //init TM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //init RM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>方法中可以看到初始化了<code>TMClient</code>和<code>RMClient</code>，对于一个服务既可以是TM角色也可以是RM角色，至于什么时候是TM或者RM则要看在一次全局事务中<code>@GlobalTransactional</code>注解标注在哪。
Client创建的结果是与TC的一个Netty连接，所以在启动日志中可以看到两个Netty Channel，其中标明了transactionRole分别为<code>TMROLE</code>和<code>RMROLE</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.417  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : NettyPool create channel to {&quot;address&quot;:&quot;127.0.0.1:8091&quot;,&quot;message&quot;:{&quot;applicationId&quot;:&quot;business-service&quot;,&quot;byteBuffer&quot;:{&quot;char&quot;:&quot;\u0000&quot;,&quot;direct&quot;:false,&quot;double&quot;:0.0,&quot;float&quot;:0.0,&quot;int&quot;:0,&quot;long&quot;:0,&quot;readOnly&quot;:false,&quot;short&quot;:0},&quot;transactionServiceGroup&quot;:&quot;my_test_tx_group&quot;,&quot;typeCode&quot;:101,&quot;version&quot;:&quot;0.4.1&quot;},&quot;transactionRole&quot;:&quot;TMROLE&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.505  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : NettyPool create channel to {&quot;address&quot;:&quot;127.0.0.1:8091&quot;,&quot;message&quot;:{&quot;applicationId&quot;:&quot;business-service&quot;,&quot;byteBuffer&quot;:{&quot;char&quot;:&quot;\u0000&quot;,&quot;direct&quot;:false,&quot;double&quot;:0.0,&quot;float&quot;:0.0,&quot;int&quot;:0,&quot;long&quot;:0,&quot;readOnly&quot;:false,&quot;short&quot;:0},&quot;transactionServiceGroup&quot;:&quot;my_test_tx_group&quot;,&quot;typeCode&quot;:103,&quot;version&quot;:&quot;0.4.1&quot;},&quot;transactionRole&quot;:&quot;RMROLE&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.629 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:RegisterTMRequest{applicationId=&#x27;business-service&#x27;, transactionServiceGroup=&#x27;my_test_tx_group&#x27;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.629 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:RegisterRMRequest{resourceIds=&#x27;null&#x27;, applicationId=&#x27;business-service&#x27;, transactionServiceGroup=&#x27;my_test_tx_group&#x27;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.699 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.699 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.701 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.RmRpcClient@3b06d101 msgId:1, future :com.alibaba.fescar.core.protocol.MessageFuture@28bb1abd, body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.701 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.TmRpcClient@65fc3fb7 msgId:2, future :com.alibaba.fescar.core.protocol.MessageFuture@9a1e3df, body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.710  INFO 93715 --- [imeoutChecker_1] c.a.fescar.core.rpc.netty.RmRpcClient    : register RM success. server version:0.4.1,channel:[id: 0xe6468995, L:/127.0.0.1:57397 - R:/127.0.0.1:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.710  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : register success, cost 114 ms, version:0.4.1,role:TMROLE,channel:[id: 0xd22fe0c5, L:/127.0.0.1:57398 - R:/127.0.0.1:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:42:57.711  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : register success, cost 125 ms, version:0.4.1,role:RMROLE,channel:[id: 0xe6468995, L:/127.0.0.1:57397 - R:/127.0.0.1:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>日志中可以看到</p><ol><li>创建Netty连接</li><li>发送注册请求</li><li>得到响应结果</li><li><code>RmRpcClient</code>、<code>TmRpcClient</code>成功实例化</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tm处理流程">TM处理流程<a href="#tm处理流程" class="hash-link" aria-label="Direct link to TM处理流程" title="Direct link to TM处理流程">​</a></h2><p>在本例中，TM的角色是business-service,BusinessService的purchase方法标注了<code>@GlobalTransactional</code>注解</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class BusinessService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private StorageFeignClient storageFeignClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private OrderFeignClient orderFeignClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void purchase(String userId, String commodityCode, int orderCount){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageFeignClient.deduct(commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderFeignClient.create(userId, commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>方法调用后将会创建一个全局事务，首先关注<code>@GlobalTransactional</code>注解的作用，在<a href="https://github.com/seata/seata/blob/develop/spring/src/main/java/com/alibaba/fescar/spring/annotation/GlobalTransactionalInterceptor.java" target="_blank" rel="noopener noreferrer">GlobalTransactionalInterceptor</a>中被拦截处理</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * AOP拦截方法调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object invoke(final MethodInvocation methodInvocation) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; targetClass = (methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis()) : null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //获取方法GlobalTransactional注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final GlobalTransactional globalTransactionalAnnotation = getAnnotation(method, GlobalTransactional.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final GlobalLock globalLockAnnotation = getAnnotation(method, GlobalLock.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果方法有GlobalTransactional注解，则拦截到相应方法处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (globalTransactionalAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (globalLockAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return handleGlobalLock(methodInvocation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return methodInvocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>handleGlobalTransaction</code>方法中对<a href="https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/TransactionalTemplate.java" target="_blank" rel="noopener noreferrer">TransactionalTemplate</a>的execute进行了调用，从类名可以看到这是一个标准的模版方法，它定义了TM对全局事务处理的标准步骤，注释已经比较清楚了</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Object execute(TransactionalExecutor business) throws TransactionalExecutor.ExecutionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. get or create a transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. begin transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerBeforeBegin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.begin(business.timeout(), business.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerAfterBegin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TransactionalExecutor.Code.BeginFailure);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Do Your Business</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rs = business.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. any business exception, rollback.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                triggerBeforeRollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tx.rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                triggerAfterRollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 3.1 Successfully rolled back</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new TransactionalExecutor.ExecutionException(tx, TransactionalExecutor.Code.RollbackDone, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 3.2 Failed to rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TransactionalExecutor.Code.RollbackFailure, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. everything is fine, commit.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerBeforeCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerAfterCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4.1 Failed to commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TransactionalExecutor.Code.CommitFailure);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //5. clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        triggerAfterCompletion();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cleanUp();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过<a href="https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/DefaultGlobalTransaction.java" target="_blank" rel="noopener noreferrer">DefaultGlobalTransaction</a>的begin方法开启全局事务</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void begin(int timeout, String name) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (role != GlobalTransactionRole.Launcher) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        check();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug(&quot;Ignore Begin(): just involved in global transaction [&quot; + xid + &quot;]&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (xid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (RootContext.getXID() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //具体开启事务的方法，获取TC返回的XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xid = transactionManager.begin(null, null, name, timeout);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status = GlobalStatus.Begin;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RootContext.bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.debug(&quot;Begin a NEW global transaction [&quot; + xid + &quot;]&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>方法开头处<code>if (role != GlobalTransactionRole.Launcher)</code>对role的判断有关键的作用，表明当前是全局事务的发起者（Launcher）还是参与者（Participant）。如果在分布式事务的下游系统方法中也加上<code>@GlobalTransactional</code>注解，那么它的角色就是Participant，会忽略后面的begin直接return，而判断是Launcher还是Participant是根据当前上下文是否已存在XID来判断，没有XID的就是Launcher，已经存在XID的就是Participant.
由此可见，全局事务的创建只能由Launcher执行，而一次分布式事务中也只有一个Launcher存在。</p><p><a href="https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/DefaultTransactionManager.java" target="_blank" rel="noopener noreferrer">DefaultTransactionManager</a>负责TM与TC通讯，发送begin、commit、rollback指令</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public String begin(String applicationId, String transactionServiceGroup, String name, int timeout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalBeginRequest request = new GlobalBeginRequest();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request.setTransactionName(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request.setTimeout(timeout);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalBeginResponse response = (GlobalBeginResponse)syncCall(request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return response.getXid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至此拿到fescar-server返回的XID表示一个全局事务创建成功，日志中也反应了上述流程</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.417 DEBUG 31326 --- [nio-8084-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : offer message: timeout=60000,transactionName=purchase(java.lang.String,java.lang.String,int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.417 DEBUG 31326 --- [geSend_TMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : write message:FescarMergeMessage timeout=60000,transactionName=purchase(java.lang.String,java.lang.String,int), channel:[id: 0xa148545e, L:/127.0.0.1:56120 - R:/127.0.0.1:8091],active?true,writable?true,isopen?true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.418 DEBUG 31326 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:FescarMergeMessage timeout=60000,transactionName=purchase(java.lang.String,java.lang.String,int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.421 DEBUG 31326 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:MergeResultMessage com.alibaba.fescar.core.protocol.transaction.GlobalBeginResponse@2dc480dc,messageId:1196</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.421 DEBUG 31326 --- [nio-8084-exec-1] c.a.fescar.core.context.RootContext      : bind 192.168.224.93:8091:2008502699</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 13:46:57.421 DEBUG 31326 --- [nio-8084-exec-1] c.a.f.tm.api.DefaultGlobalTransaction    : Begin a NEW global transaction [192.168.224.93:8091:2008502699]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>全局事务创建后，就开始执行business.execute()，即业务代码<code>storageFeignClient.deduct(commodityCode, orderCount)</code>进入RM处理流程，此处的业务逻辑为调用storage-service的扣减库存接口。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rm处理流程">RM处理流程<a href="#rm处理流程" class="hash-link" aria-label="Direct link to RM处理流程" title="Direct link to RM处理流程">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@GetMapping(path = &quot;/deduct&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Boolean deduct(String commodityCode, Integer count){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storageService.deduct(commodityCode,count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Transactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void deduct(String commodityCode, int count){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Storage storage = storageDAO.findByCommodityCode(commodityCode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage.setCount(storage.getCount()-count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storageDAO.save(storage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>storage的接口和service方法并未出现fescar相关的代码和注解，体现了fescar的无侵入。那它是如何加入到这次全局事务中的呢？答案在<a href="https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/ConnectionProxy.java" target="_blank" rel="noopener noreferrer">ConnectionProxy</a>中，这也是前面说为什么必须要使用<code>DataSourceProxy</code>的原因，通过DataSourceProxy才能在业务代码的本地事务提交时，fescar通过该切入点，向TC注册分支事务并发送RM的处理结果。</p><p>由于业务代码本身的事务提交被<code>ConnectionProxy</code>代理实现，所以在提交本地事务时，实际执行的是ConnectionProxy的commit方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void commit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果当前是全局事务，则执行全局事务的提交</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //判断是不是全局事务，就是看当前上下文是否存在XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context.inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processGlobalTransactionCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (context.isGlobalLockRequire()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processLocalCommitWithGlobalLocks();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void processGlobalTransactionCommit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //首先是向TC注册RM，拿到TC分配的branchId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        register();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (TransactionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recognizeLockKeyConflictException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (context.hasUndoLog()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //写入undolog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            UndoLogManager.flushUndoLogs(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //提交本地事务，写入undo_log和业务数据在同一个本地事务中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //向TC发送RM的事务处理失败的通知</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        report(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ex instanceof SQLException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //向TC发送RM的事务处理成功的通知</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    report(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void register() throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //注册RM，构建request通过netty向TC发送注册指令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Long branchId = DefaultResourceManager.get().branchRegister(BranchType.AT, getDataSourceProxy().getResourceId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            null, context.getXid(), null, context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //将返回的branchId存在上下文中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.setBranchId(branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过日志印证一下上面的流程</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor   : xid in RootContext null xid in RpcContext 192.168.0.2:8091:2008546211</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] c.a.fescar.core.context.RootContext      : bind 192.168.0.2:8091:2008546211</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor   : bind 192.168.0.2:8091:2008546211 to RootContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.386  INFO 38933 --- [nio-8081-exec-1] o.h.h.i.QueryTranslatorFactoryInitiator  : HHH000397: Using ASTQueryTranslatorFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hibernate: select storage0_.id as id1_0_, storage0_.commodity_code as commodit2_0_, storage0_.count as count3_0_ from storage_tbl storage0_ where storage0_.commodity_code=?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hibernate: update storage_tbl set count=? where id=?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.673  INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient    : will connect to 192.168.0.2:8091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.673  INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient    : RM will register :jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.673  INFO 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.NettyPoolableFactory   : NettyPool create channel to {&quot;address&quot;:&quot;192.168.0.2:8091&quot;,&quot;message&quot;:{&quot;applicationId&quot;:&quot;storage-service&quot;,&quot;byteBuffer&quot;:{&quot;char&quot;:&quot;\u0000&quot;,&quot;direct&quot;:false,&quot;double&quot;:0.0,&quot;float&quot;:0.0,&quot;int&quot;:0,&quot;long&quot;:0,&quot;readOnly&quot;:false,&quot;short&quot;:0},&quot;resourceIds&quot;:&quot;jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false&quot;,&quot;transactionServiceGroup&quot;:&quot;hello-service-fescar-service-group&quot;,&quot;typeCode&quot;:103,&quot;version&quot;:&quot;0.4.0&quot;},&quot;transactionRole&quot;:&quot;RMROLE&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.677 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:RegisterRMRequest{resourceIds=&#x27;jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false&#x27;, applicationId=&#x27;storage-service&#x27;, transactionServiceGroup=&#x27;hello-service-fescar-service-group&#x27;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.680 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.680 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.RmRpcClient@7d61f5d4 msgId:9, future :com.alibaba.fescar.core.protocol.MessageFuture@186cd3e0, body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.680  INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient    : register RM success. server version:0.4.1,channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.680  INFO 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.NettyPoolableFactory   : register success, cost 3 ms, version:0.4.1,role:RMROLE,channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.680 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : offer message: transactionId=2008546211,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,lockKey=storage_tbl:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.681 DEBUG 38933 --- [geSend_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : write message:FescarMergeMessage transactionId=2008546211,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,lockKey=storage_tbl:1, channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091],active?true,writable?true,isopen?true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.681 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:FescarMergeMessage transactionId=2008546211,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,lockKey=storage_tbl:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.687 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:MergeResultMessage BranchRegisterResponse: transactionId=2008546211,branchId=2008546212,result code =Success,getMsg =null,messageId:11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.702 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.rm.datasource.undo.UndoLogManager  : Flushing UNDO LOG: {&quot;branchId&quot;:2008546212,&quot;sqlUndoLogs&quot;:[{&quot;afterImage&quot;:{&quot;rows&quot;:[{&quot;fields&quot;:[{&quot;keyType&quot;:&quot;PrimaryKey&quot;,&quot;name&quot;:&quot;id&quot;,&quot;type&quot;:4,&quot;value&quot;:1},{&quot;keyType&quot;:&quot;NULL&quot;,&quot;name&quot;:&quot;count&quot;,&quot;type&quot;:4,&quot;value&quot;:993}]}],&quot;tableName&quot;:&quot;storage_tbl&quot;},&quot;beforeImage&quot;:{&quot;rows&quot;:[{&quot;fields&quot;:[{&quot;keyType&quot;:&quot;PrimaryKey&quot;,&quot;name&quot;:&quot;id&quot;,&quot;type&quot;:4,&quot;value&quot;:1},{&quot;keyType&quot;:&quot;NULL&quot;,&quot;name&quot;:&quot;count&quot;,&quot;type&quot;:4,&quot;value&quot;:994}]}],&quot;tableName&quot;:&quot;storage_tbl&quot;},&quot;sqlType&quot;:&quot;UPDATE&quot;,&quot;tableName&quot;:&quot;storage_tbl&quot;}],&quot;xid&quot;:&quot;192.168.0.2:8091:2008546211&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.755 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : offer message: transactionId=2008546211,branchId=2008546212,resourceId=null,status=PhaseOne_Done,applicationData=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.755 DEBUG 38933 --- [geSend_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : write message:FescarMergeMessage transactionId=2008546211,branchId=2008546212,resourceId=null,status=PhaseOne_Done,applicationData=null, channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091],active?true,writable?true,isopen?true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.756 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:FescarMergeMessage transactionId=2008546211,branchId=2008546212,resourceId=null,status=PhaseOne_Done,applicationData=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.758 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:MergeResultMessage com.alibaba.fescar.core.protocol.transaction.BranchReportResponse@582a08cf,messageId:13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.799 DEBUG 38933 --- [nio-8081-exec-1] c.a.fescar.core.context.RootContext      : unbind 192.168.0.2:8091:2008546211</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:48.799 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor   : unbind 192.168.0.2:8091:2008546211 from RootContext</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>获取business-service传来的XID</li><li>绑定XID到当前上下文中</li><li>执行业务逻辑sql</li><li>向TC创建本次RM的Netty连接</li><li>向TC发送分支事务的相关信息</li><li>获得TC返回的branchId</li><li>记录Undo Log数据</li><li>向TC发送本次事务PhaseOne阶段的处理结果</li><li>从当前上下文中解绑XID</li></ol><p>其中第1步和第9步，是在<a href="https://github.com/dongsheep/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-fescar/src/main/java/org/springframework/cloud/alibaba/fescar/web/FescarHandlerInterceptor.java" target="_blank" rel="noopener noreferrer">FescarHandlerInterceptor</a>中完成的，该类并不属于fescar，是前面提到的spring-cloud-alibaba-fescar,它实现了基于feign、rest通信时将xid bind和unbind到当前请求上下文中。到这里RM完成了PhaseOne阶段的工作，接着看PhaseTwo阶段的处理逻辑。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="事务提交">事务提交<a href="#事务提交" class="hash-link" aria-label="Direct link to 事务提交" title="Direct link to 事务提交">​</a></h2><p>各分支事务执行完成后，TC对各RM的汇报结果进行汇总，给各RM发送commit或rollback的指令</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.813 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:xid=192.168.0.2:8091:2008546211,branchId=2008546212,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,applicationData=null,messageId:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.813 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.RmRpcClient@7d61f5d4 msgId:1, body:xid=192.168.0.2:8091:2008546211,branchId=2008546212,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,applicationData=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.814  INFO 38933 --- [atch_RMROLE_1_8] c.a.f.core.rpc.netty.RmMessageListener   : onMessage:xid=192.168.0.2:8091:2008546211,branchId=2008546212,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,applicationData=null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.816  INFO 38933 --- [atch_RMROLE_1_8] com.alibaba.fescar.rm.AbstractRMHandler  : Branch committing: 192.168.0.2:8091:2008546211 2008546212 jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.816  INFO 38933 --- [atch_RMROLE_1_8] com.alibaba.fescar.rm.AbstractRMHandler  : Branch commit result: PhaseTwo_Committed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.817  INFO 38933 --- [atch_RMROLE_1_8] c.a.fescar.core.rpc.netty.RmRpcClient    : RmRpcClient sendResponse branchStatus=PhaseTwo_Committed,result code =Success,getMsg =null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.817 DEBUG 38933 --- [atch_RMROLE_1_8] c.a.f.c.rpc.netty.AbstractRpcRemoting    : send response:branchStatus=PhaseTwo_Committed,result code =Success,getMsg =null,channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2019-04-09 21:57:49.817 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:branchStatus=PhaseTwo_Committed,result code =Success,getMsg =null</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从日志中可以看到</p><ol><li>RM收到XID=192.168.0.2:8091:2008546211,branchId=2008546212的commit通知</li><li>执行commit动作</li><li>将commit结果发送给TC，branchStatus为PhaseTwo_Committed</li></ol><p>具体看下二阶段commit的执行过程，在<a href="https://github.com/seata/seata/blob/develop/rm/src/main/java/com/alibaba/fescar/rm/AbstractRMHandler.java" target="_blank" rel="noopener noreferrer">AbstractRMHandler</a>类的doBranchCommit方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 拿到通知的xid、branchId等关键参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 然后调用RM的branchCommit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected void doBranchCommit(BranchCommitRequest request, BranchCommitResponse response) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String xid = request.getXid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long branchId = request.getBranchId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resourceId = request.getResourceId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String applicationData = request.getApplicationData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;Branch committing: &quot; + xid + &quot; &quot; + branchId + &quot; &quot; + resourceId + &quot; &quot; + applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BranchStatus status = getResourceManager().branchCommit(request.getBranchType(), xid, branchId, resourceId, applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response.setBranchStatus(status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;Branch commit result: &quot; + status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最终会将branchCommit的请求调用到<a href="https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/AsyncWorker.java" target="_blank" rel="noopener noreferrer">AsyncWorker</a>的branchCommit方法。AsyncWorker的处理方式是fescar架构的一个关键部分，因为大部分事务都是会正常提交的，所以在PhaseOne阶段就已经结束了，这样就可以将锁最快的释放。PhaseTwo阶段接收commit的指令后，异步处理即可。将PhaseTwo的时间消耗排除在一次分布式事务之外。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static final List&lt;Phase2Context&gt; ASYNC_COMMIT_BUFFER = Collections.synchronizedList( new ArrayList&lt;Phase2Context&gt;());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 将需要提交的XID加入list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId, String applicationData) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ASYNC_COMMIT_BUFFER.size() &lt; ASYNC_COMMIT_BUFFER_LIMIT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ASYNC_COMMIT_BUFFER.add(new Phase2Context(branchType, xid, branchId, resourceId, applicationData));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.warn(&quot;Async commit buffer is FULL. Rejected branch [&quot; + branchId + &quot;/&quot; + xid + &quot;] will be handled by housekeeping later.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return BranchStatus.PhaseTwo_Committed;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通过定时任务消费list中的XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public synchronized void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;Async Commit Buffer Limit: &quot; + ASYNC_COMMIT_BUFFER_LIMIT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timerExecutor = new ScheduledThreadPoolExecutor(1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new NamedThreadFactory(&quot;AsyncWorker&quot;, 1, true));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timerExecutor.scheduleAtFixedRate(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                doBranchCommits();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.info(&quot;Failed at async committing ... &quot; + e.getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, 10, 1000 * 1, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void doBranchCommits() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ASYNC_COMMIT_BUFFER.size() == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, List&lt;Phase2Context&gt;&gt; mappedContexts = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Iterator&lt;Phase2Context&gt; iterator = ASYNC_COMMIT_BUFFER.iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //一次定时循环取出ASYNC_COMMIT_BUFFER中的所有待办数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //以resourceId作为key分组待commit数据，resourceId是一个数据库的连接url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //在前面的日志中可以看到，目的是为了覆盖应用的多数据源创建</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (iterator.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Phase2Context commitContext = iterator.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Phase2Context&gt; contextsGroupedByResourceId = mappedContexts.get(commitContext.resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (contextsGroupedByResourceId == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            contextsGroupedByResourceId = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mappedContexts.put(commitContext.resourceId, contextsGroupedByResourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        contextsGroupedByResourceId.add(commitContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        iterator.remove();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Map.Entry&lt;String, List&lt;Phase2Context&gt;&gt; entry : mappedContexts.entrySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //根据resourceId获取数据源以及连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataSourceProxy dataSourceProxy = DataSourceManager.get().get(entry.getKey());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn = dataSourceProxy.getPlainConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (SQLException sqle) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.warn(&quot;Failed to get connection for async committing on &quot; + entry.getKey(), sqle);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;Phase2Context&gt; contextsGroupedByResourceId = entry.getValue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Phase2Context commitContext : contextsGroupedByResourceId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //执行undolog的处理，即删除xid、branchId对应的记录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    UndoLogManager.deleteUndoLog(commitContext.xid, commitContext.branchId, conn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.warn(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Failed to delete undo log [&quot; + commitContext.branchId + &quot;/&quot; + commitContext.xid + &quot;]&quot;, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (conn != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    conn.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (SQLException closeEx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.warn(&quot;Failed to close JDBC resource while deleting undo_log &quot;, closeEx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所以对于commit动作的处理，RM只需删除xid、branchId对应的undo_log即可。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="事务回滚">事务回滚<a href="#事务回滚" class="hash-link" aria-label="Direct link to 事务回滚" title="Direct link to 事务回滚">​</a></h2><p>对于rollback场景的触发有两种情况</p><ol><li>分支事务处理异常，即<a href="https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/ConnectionProxy.java" target="_blank" rel="noopener noreferrer">ConnectionProxy</a>中<code>report(false)</code>的情况</li><li>TM捕获到下游系统上抛的异常，即发起全局事务标有<code>@GlobalTransactional</code>注解的方法捕获到的异常。在前面<a href="https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/TransactionalTemplate.java" target="_blank" rel="noopener noreferrer">TransactionalTemplate</a>类的execute模版方法中，对business.execute()的调用进行了catch，catch后会调用rollback，由TM通知TC对应XID需要回滚事务</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> public void rollback() throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //只有Launcher能发起这个rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (role == GlobalTransactionRole.Participant) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Participant has no responsibility of committing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug(&quot;Ignore Rollback(): just involved in global transaction [&quot; + xid + &quot;]&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (xid == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status = transactionManager.rollback(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (RootContext.getXID() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid.equals(RootContext.getXID())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TC汇总后向参与者发送rollback指令，RM在<a href="https://github.com/seata/seata/blob/develop/rm/src/main/java/com/alibaba/fescar/rm/AbstractRMHandler.java" target="_blank" rel="noopener noreferrer">AbstractRMHandler</a>类的doBranchRollback方法中接收这个rollback的通知</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected void doBranchRollback(BranchRollbackRequest request, BranchRollbackResponse response) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String xid = request.getXid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long branchId = request.getBranchId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resourceId = request.getResourceId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String applicationData = request.getApplicationData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;Branch rolling back: &quot; + xid + &quot; &quot; + branchId + &quot; &quot; + resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BranchStatus status = getResourceManager().branchRollback(request.getBranchType(), xid, branchId, resourceId, applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response.setBranchStatus(status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.info(&quot;Branch rollback result: &quot; + status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后将rollback请求传递到<code>DataSourceManager</code>类的branchRollback方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public BranchStatus branchRollback(BranchType branchType, String xid, long branchId, String resourceId, String applicationData) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //根据resourceId获取对应的数据源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DataSourceProxy dataSourceProxy = get(resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dataSourceProxy == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ShouldNeverHappenException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UndoLogManager.undo(dataSourceProxy, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (TransactionException te) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (te.getCode() == TransactionExceptionCode.BranchRollbackFailed_Unretriable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return BranchStatus.PhaseTwo_RollbackFailed_Unretryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return BranchStatus.PhaseTwo_RollbackFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return BranchStatus.PhaseTwo_Rollbacked;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最终会执行<a href="https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/undo/UndoLogManager.java" target="_blank" rel="noopener noreferrer">UndoLogManager</a>类的undo方法，因为是纯jdbc操作代码比较长就不贴出来了，可以通过连接到github查看源码，说一下undo的具体流程</p><ol><li>根据xid和branchId查找PhaseOne阶段提交的undo_log</li><li>如果找到了就根据undo_log中记录的数据生成回放sql并执行，即还原PhaseOne阶段修改的数据</li><li>第2步处理完后，删除该条undo_log数据</li><li>如果第1步没有找到对应的undo_log，就插入一条状态为<code>GlobalFinished</code>的undo_log.
出现没找到的原因可能是PhaseOne阶段的本地事务异常了，导致没有正常写入。
因为xid和branchId是唯一索引，所以第4步的插入，可以防止PhaseOne阶段恢复后的成功写入，那么PhaseOne阶段就会异常，这样一来业务数据也就不会提交成功，数据达到了最终回滚了的效果</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2><p>本地结合分布式业务场景，分析了fescar client侧的主要处理流程，对TM和RM角色的主要源码进行了解析，希望能对大家理解fescar的工作原理有所帮助。</p><p>随着fescar的快速迭代以及后期的Roadmap规划，假以时日相信fescar能够成为开源分布式事务的标杆解决方案。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-04-08T00:00:00.000Z" itemprop="datePublished">April 8, 2019</time> · <!-- -->30 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">李钊,季敏</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>再前不久，我写了一篇关于分布式事务中间件Fescar的解析，没过几天Fescar团队对其进行了品牌升级，取名为Seata(Simpe Extensible Autonomous Transcaction Architecture)，而以前的Fescar的英文全称为Fast &amp; EaSy Commit And Rollback。可以看见Fescar从名字上来看更加局限于Commit和Rollback，而新的品牌名字Seata旨在打造一套一站式分布式事务解决方案。更换名字之后，我对其未来的发展更有信心。</p><p>这里先大概回忆一下Seata的整个过程模型:</p><p><img loading="lazy" src="/assets/images/20190327000119-20382b15f6fcf95833b54a3b2f735c5d.png" width="1716" height="986" class="img_ev3q"></p><ul><li>TM:事务的发起者。用来告诉TC，全局事务的开始，提交，回滚。</li><li>RM:具体的事务资源，每一个RM都会作为一个分支事务注册在TC。</li><li>TC:事务的协调者。也可以看做是Fescar-server，用于接收我们的事务的注册，提交和回滚。</li></ul><p>在之前的文章中对整个角色有个大体的介绍，在这篇文章中我将重点介绍其中的核心角色TC，也就是事务协调器。</p><h1>2.Transcation Coordinator</h1><p>为什么之前一直强调 TC 是核心呢？那因为TC这个角色就好像上帝一样，管控着云云众生的RM和TM。如果TC一旦不好使，那么RM和TM一旦出现小问题，那必定会乱的一塌糊涂。所以要想了解Seata，那么必须要了解它的TC。</p><p>那么一个优秀的事务协调者应该具备哪些能力呢？我觉得应该有以下几个:</p><ul><li>正确的协调：能正确的协调RM和TM接下来应该做什么，做错了应该怎么办，做对了应该怎么办。</li><li>高可用: 事务协调器在分布式事务中很重要，如果不能保证高可用，那么它也没有存在的必要了。</li><li>高性能：事务协调器的性能一定要高，如果事务协调器性能有瓶颈那么它所管理的RM和TM那么会经常遇到超时，从而引起回滚频繁。</li><li>高扩展性：这个特点是属于代码层面的，如果是一个优秀的框架，那么需要给使用方很多自定义扩展，比如服务注册/发现，读取配置等等。</li></ul><p>下面我也将逐步阐述Seata是如何做到上面四点。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-seata-server的设计">2.1 Seata-Server的设计<a href="#21-seata-server的设计" class="hash-link" aria-label="Direct link to 2.1 Seata-Server的设计" title="Direct link to 2.1 Seata-Server的设计">​</a></h2><p><img loading="lazy" src="/assets/images/design-593e833d29ab54ac77d5a9da7a196a08.png" width="954" height="503" class="img_ev3q"></p><p>Seata-Server整体的模块图如上所示:</p><ul><li>Coordinator Core: 在最下面的模块是事务协调器核心代码，主要用来处理事务协调的逻辑，如是否commit,rollback等协调活动。</li><li>Store:存储模块，用来将我们的数据持久化，防止重启或者宕机数据丢失。</li><li>Discovery: 服务注册/发现模块，用于将Server地址暴露给我们Client。</li><li>Config: 用来存储和查找我们服务端的配置。</li><li>Lock: 锁模块，用于给Seata提供全局锁的功能。</li><li>RPC:用于和其它端通信。</li><li>HA-Cluster:高可用集群，目前还没开源，为Seata提供可靠的高可用服务，预计将会在0.6版本开源。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-discovery">2.2 Discovery<a href="#22-discovery" class="hash-link" aria-label="Direct link to 2.2 Discovery" title="Direct link to 2.2 Discovery">​</a></h2><p>首先来讲讲比较基础的Discovery模块，又称服务注册/发现模块。我们将Seata-Sever启动之后，需要将自己的地址暴露给其它使用者，那么就需要我们这个模块帮忙。</p><p><img loading="lazy" src="/assets/images/discover-123b6b65796c5fac1dbfad5192bde0d2.png" width="583" height="409" class="img_ev3q"></p><p>这个模块有个核心接口RegistryService，如上图所示:</p><ul><li>register：服务端使用，进行服务注册。</li><li>unregister：服务端使用，一般在JVM关闭钩子，ShutdownHook中调用。</li><li>subscribe：客户端使用，注册监听事件，用来监听地址的变化。</li><li>unsubscribe：客户端使用，取消注册监听事件。</li><li>lookup：客户端使用，根据key查找服务地址列表。</li><li>close：都可以使用，用于关闭Registry资源。</li></ul><p>如果需要添加自己定义的服务注册/发现，那么实现这个接口即可。截止目前在社区的不断开发推动下，已经有五种服务注册/发现，分别是redis、zk、nacos、eruka 和 consul。下面简单介绍下Nacos的实现：</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="221-register接口">2.2.1 register接口：<a href="#221-register接口" class="hash-link" aria-label="Direct link to 2.2.1 register接口：" title="Direct link to 2.2.1 register接口：">​</a></h4><p><img loading="lazy" src="/assets/images/register-9c033585329a607956f4a576c500a0f3.png" width="702" height="117" class="img_ev3q"></p><p>step1:校验地址是否合法</p><p>step2:获取Nacos的 Naming 实例，然后将地址注册到服务名为 serverAddr（固定服务名） 的对应集群分组（registry.conf 文件配置）上面。</p><p>unregister接口类似，这里不做详解。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="222-lookup接口">2.2.2 lookup接口：<a href="#222-lookup接口" class="hash-link" aria-label="Direct link to 2.2.2 lookup接口：" title="Direct link to 2.2.2 lookup接口：">​</a></h4><p><img loading="lazy" src="/assets/images/lookup-a057c9d992510131026a9bd89e2b94e9.png" width="890" height="652" class="img_ev3q"></p><p>step1：获取当前clusterName名字。</p><p>step2：判断当前集群名对应的服务是否已经订阅过了，如果是直接从map中取订阅返回的数据。</p><p>step3：如果没有订阅先主动查询一次服务实例列表，然后添加订阅并将订阅返回的数据存放到map中，之后直接从map获取最新数据。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="223-subscribe接口">2.2.3 subscribe接口<a href="#223-subscribe接口" class="hash-link" aria-label="Direct link to 2.2.3 subscribe接口" title="Direct link to 2.2.3 subscribe接口">​</a></h4><p><img loading="lazy" src="/assets/images/subscribe-2be2aa5b1bcb8b9bb0a32711b67fc49b.png" width="712" height="143" class="img_ev3q"></p><p>这个接口比较简单，具体分两步:</p><p>step1：对将要订阅的cluster-&gt; listener 存放到map中，此处nacos未提交单机已订阅列表，所以需要自己实现。</p><p>step2：使用Nacos api 订阅。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="23-config">2.3 Config<a href="#23-config" class="hash-link" aria-label="Direct link to 2.3 Config" title="Direct link to 2.3 Config">​</a></h2><p>配置模块也是一个比较基础，比较简单的模块。我们需要配置一些常用的参数比如:Netty的select线程数量，work线程数量，session允许最大为多少等等，当然这些参数再Seata中都有自己的默认设置。</p><p>同样的在Seata中也提供了一个接口Configuration，用来自定义我们需要的获取配置的地方:</p><p><img loading="lazy" src="/assets/images/config-0cb2807fcc90c4dd96e784665c5ee074.png" width="735" height="403" class="img_ev3q"></p><ul><li>getInt/Long/Boolean/getConfig()：通过dataId来获取对应的值，读取不到配置、异常或超时将返回参数中的默认值。</li><li>putConfig：用于添加配置。</li><li>removeConfig：删除一个配置。</li><li>add/remove/get ConfigListener：添加/删除/获取 配置监听器，一般用来监听配置的变更。</li></ul><p>目前为止有四种方式获取Config：File(文件获取)、Nacos、Apollo 和 ZK（不推荐）。在Seata中首先需要配置registry.conf，来配置config.type 。实现conf比较简单这里就不深入分析。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="24-store">2.4 Store<a href="#24-store" class="hash-link" aria-label="Direct link to 2.4 Store" title="Direct link to 2.4 Store">​</a></h2><p>存储层的实现对于Seata是否高性能，是否可靠非常关键。
如果存储层没有实现好，那么如果发生宕机，在TC中正在进行分布式事务处理的数据将会被丢失，既然使用了分布式事务，那么其肯定不能容忍丢失。如果存储层实现好了，但是其性能有很大问题，RM可能会发生频繁回滚那么其完全无法应对高并发的场景。</p><p>在Seata中默认提供了文件方式的存储，下面我们定义我们存储的数据为Session，而我们的TM创造的全局事务操作数据叫GloabSession，RM创造的分支事务操作数据叫BranchSession，一个GloabSession可以拥有多个BranchSession。我们的目的就是要将这么多Session存储下来。</p><p>在FileTransactionStoreManager#writeSession代码中:</p><p><img loading="lazy" src="/assets/images/store-11995c04c2ae5a0b14ce70fe74837dbf.png" width="876" height="258" class="img_ev3q"></p><p>上面的代码主要分为下面几步：</p><ul><li>step1：生成一个TransactionWriteFuture。</li><li>step2：将这个futureRequest丢进一个LinkedBlockingQueue中。为什么需要将所有数据都丢进队列中呢？当然这里其实也可以用锁来实现，再另外一个阿里开源的RocketMQ中，使用的锁。不论是队列还是锁它们的目的是为了保证单线程写，这又是为什么呢？有人会解释说，需要保证顺序写，这样速度就很快，这个理解是错误的，我们的FileChannel的写方法是线程安全的，已经能保证顺序写了。保证单线程写其实是为了让我们这个写逻辑都是单线程的，因为可能有些文件写满或者记录写数据位置等等逻辑，当然这些逻辑都可以主动加锁去做，但是为了实现简单方便，直接再整个写逻辑排队处理是最为合适的。</li><li>step3：调用future.get，等待我们该条数据写逻辑完成通知。</li></ul><p>我们将数据提交到队列之后，我们接下来需要对其进行消费，代码如下：</p><p><img loading="lazy" src="/assets/images/storewrite-d7cf58998ec8ae864c12d42bb0af2295.png" width="719" height="101" class="img_ev3q"></p><p>这里将一个WriteDataFileRunnable()提交进我们的线程池，这个Runnable的run()方法如下:</p><p><img loading="lazy" src="/assets/images/storerun-50f3041c552421e9cdc2666489a4d46a.png" width="855" height="526" class="img_ev3q"></p><p>分为下面几步:</p><p>step1： 判断是否停止，如果stopping为true则返回null。</p><p>step2：从我们的队列中获取数据。</p><p>step3：判断future是否已经超时了，如果超时，则设置结果为false，此时我们生产者get()方法会接触阻塞。</p><p>step4：将我们的数据写进文件，此时数据还在pageCahce层并没有刷新到磁盘，如果写成功然后根据条件判断是否进行刷盘操作。</p><p>step5：当写入数量到达一定的时候，或者写入时间到达一定的时候，需要将我们当前的文件保存为历史文件，删除以前的历史文件，然后创建新的文件。这一步是为了防止我们文件无限增长，大量无效数据浪费磁盘资源。</p><p>在我们的writeDataFile中有如下代码:</p><p><img loading="lazy" src="/assets/images/writedatafile-d999695c1986d60cdd5f2945f81d9882.png" width="748" height="557" class="img_ev3q"></p><p>step1：首先获取我们的ByteBuffer，如果超出最大循环BufferSize就直接创建一个新的，否则就使用我们缓存的Buffer。这一步可以很大的减少GC。</p><p>step2：然后将数据添加进入ByteBuffer。</p><p>step3：最后将ByteBuffer写入我们的fileChannel,这里会重试三次。此时的数据还在pageCache层，受两方面的影响，OS有自己的刷新策略，但是这个业务程序不能控制，为了防止宕机等事件出现造成大量数据丢失，所以就需要业务自己控制flush。下面是flush的代码:</p><p><img loading="lazy" src="/assets/images/flush-ba1b0df70804b3501b6ccdf503b01ca8.png" width="868" height="273" class="img_ev3q"></p><p>这里flush的条件写入一定数量或者写的时间超过一定时间，这样也会有个小问题如果是停电，那么pageCache中有可能还有数据并没有被刷盘，会导致少量的数据丢失。目前还不支持同步模式，也就是每条数据都需要做刷盘操作，这样可以保证每条消息都落盘，但是性能也会受到极大的影响，当然后续会不断的演进支持。</p><p>我们的store核心流程主要是上面几个方法，当然还有一些比如，session重建等，这些比较简单，读者可以自行阅读。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="25-lock">2.5 Lock<a href="#25-lock" class="hash-link" aria-label="Direct link to 2.5 Lock" title="Direct link to 2.5 Lock">​</a></h2><p>大家知道数据库实现隔离级别主要是通过锁来实现的，同样的再分布式事务框架Seata中要实现隔离级别也需要通过锁。一般在数据库中数据库的隔离级别一共有四种:读未提交，读已提交，可重复读，串行化。在Seata中可以保证隔离级别是读已提交，但是提供了达到读已提交隔离的手段。</p><p>Lock模块也就是Seata实现隔离级别的核心模块。在Lock模块中提供了一个接口用于管理我们的锁:
<img loading="lazy" src="/assets/images/lockManager-ea0f0672144a891b0f4b8c1d79572c23.png" width="759" height="368" class="img_ev3q"></p><p>其中有三个方法:</p><ul><li>acquireLock：用于对我们的BranchSession加锁，这里虽然是传的分支事务Session，实际上是对分支事务的资源加锁，成功返回true。</li><li>isLockable：根据事务ID，资源Id，锁住的Key来查询是否已经加锁。</li><li>cleanAllLocks：清除所有的锁。
对于锁我们可以在本地实现，也可以通过redis或者mysql来帮助我们实现。官方默认提供了本地全局锁的实现：
<img loading="lazy" src="/assets/images/defaultLock-1df1bfa4a52ecb7b29a9fdf7f759db8c.png" width="887" height="223" class="img_ev3q"></li></ul><p>在本地锁的实现中有两个常量需要关注:</p><ul><li>BUCKET_PER_TABLE：用来定义每个table有多少个bucket，目的是为了后续对同一个表加锁的时候减少竞争。</li><li>LOCK_MAP：这个map从定义上来看非常复杂，里里外外套了很多层Map，这里用个表格具体说明一下：</li></ul><table><thead><tr><th>层数</th><th>key</th><th>value</th></tr></thead><tbody><tr><td>1-LOCK_MAP</td><td>resourceId（jdbcUrl）</td><td>dbLockMap</td></tr><tr><td>2- dbLockMap</td><td>tableName （表名）</td><td>tableLockMap</td></tr><tr><td>3- tableLockMap</td><td>PK.hashcode%Bucket （主键值的hashcode%bucket）</td><td>bucketLockMap</td></tr><tr><td>4- bucketLockMap</td><td>PK</td><td>trascationId</td></tr></tbody></table><p>可以看见实际上的加锁在bucketLockMap这个map中，这里具体的加锁方法比较简单就不作详细阐述，主要是逐步的找到bucketLockMap,然后将当前trascationId塞进去，如果这个主键当前有TranscationId，那么比较是否是自己，如果不是则加锁失败。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="26-rpc">2.6 RPC<a href="#26-rpc" class="hash-link" aria-label="Direct link to 2.6 RPC" title="Direct link to 2.6 RPC">​</a></h2><p>保证Seata高性能的关键之一也是使用了Netty作为RPC框架，采用默认配置的线程模型如下图所示：</p><p><img loading="lazy" src="/assets/images/reactor-08b0f8b4eacf85d471715b468a919377.png" width="1019" height="379" class="img_ev3q"></p><p>如果采用默认的基本配置那么会有一个Acceptor线程用于处理客户端的链接，会有cpu*2数量的NIO-Thread，再这个线程中不会做业务太重的事情，只会做一些速度比较快的事情，比如编解码，心跳事件，和TM注册。一些比较费时间的业务操作将会交给业务线程池，默认情况下业务线程池配置为最小线程为100，最大为500。</p><p>Seata 目前允许配置的传输层配置如图所示，用户可根据需要进行Netty传输层面的调优，配置通过配置中心配置，首次加载时生效。  </p><p><img loading="lazy" src="/assets/images/transport-72c1b92a7e58aefcead18accf36697b6.png" width="1052" height="818" class="img_ev3q"></p><p>这里需要提一下的是Seata的心跳机制，这里是使用Netty的IdleStateHandler完成的，如下:</p><p><img loading="lazy" src="/assets/images/idleStateHandler-777d7088d0487a1d6cc3aa82c6155b0c.png" width="885" height="53" class="img_ev3q"></p><p>在Sever端对于写没有设置最大空闲时间，对于读设置了最大空闲时间，默认为15s(客户端默认写空闲为5s，发送ping消息)，如果超过15s则会将链接断开，关闭资源。</p><p><img loading="lazy" src="/assets/images/userEventTriggered-dde1066ce734ef88b3a6acc562e70f9c.png" width="656" height="326" class="img_ev3q"></p><p>step1：判断是否是读空闲的检测事件。</p><p>step2：如果是则断开链接，关闭资源。<br>
<!-- -->另外Seata 做了内存池、客户端做了批量小包合并发送、Netty连接池（减少连接创建时的服务不可用时间）等功能，以下为批量小包合并功能。   </p><p><img loading="lazy" src="/assets/images/send-166e53dadab35ea5272470c6056d27c1.png" width="1472" height="1572" class="img_ev3q"></p><p>客户端的消息发送并不是真正的消息发送通过 AbstractRpcRemoting#sendAsyncRequest 包装成 RpcMessage 存储至 basket 中并唤醒合并发送线程。合并发送线程通过 while true 的形式
最长等待1ms对basket的消息取出包装成 merge 消息进行真正发送，此时若 channel 出现异常则会通过 fail-fast 快速失败返回结果。merge消息发送前在 map 中标识，收到结果后批量确认（AbstractRpcRemotingClient#channelRead），并通过 dispatch 分发至 messageListener 和 handler 去处理。同时，timerExecutor 定时对已发送消息进行超时检测，若超时置为失败。具体消息协议设计将会在后续的文章中给出，敬请关注。<br>
<!-- -->Seata 的 Netty Client由 TMClient和RMClient 组成，根据事务角色功能区分，都继承 AbstractRpcRemotingClient，AbstractRpcRemotingClient 实现了 RemotingService（服务启停）, RegisterMsgListener（netty 连接池连接创建回调）和 ClientMessageSender（消息发送）继承了 AbstractRpcRemoting（ Client和Server 顶层消息发送和处理的模板）。<br>
<!-- -->RMClient类关系图如下图所示：
<img loading="lazy" src="/assets/images/class-e9d7be588754b2b5a08756e05dc79ea1.png" width="1626" height="838" class="img_ev3q">
TMClient 和 RMClient 又会根据自身的 poolConfig 配置与 NettyPoolableFactory implements KeyedPoolableObjectFactory&lt;NettyPoolKey, Channel&gt; 进行 channel 连接的交互，channel 连接池根据角色 key+ip 作为连接池的 key 来定位各个连接池
，连接池对 channel 进行统一的管理。TMClient 和 RMClient 在发送过程中对于每个 ip 只会使用一个长连接，但连接不可用时，会从连接池中快速取出已经创建好并可用的连接，减少服务的不可用时间。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="27-ha-cluster">2.7 HA-Cluster<a href="#27-ha-cluster" class="hash-link" aria-label="Direct link to 2.7 HA-Cluster" title="Direct link to 2.7 HA-Cluster">​</a></h2><p>目前官方没有公布HA-Cluster,但是通过一些其它中间件和官方的一些透露，可以将HA-Cluster用如下方式设计:
<img loading="lazy" src="/assets/images/hacluster-3b88f79394b7ffe7c02f3b249fae582f.png" width="1085" height="622" class="img_ev3q"></p><p>具体的流程如下:</p><p>step1：客户端发布信息的时候根据transcationId保证同一个transcation是在同一个master上，通过多个Master水平扩展，提供并发处理性能。</p><p>step2：在server端中一个master有多个slave，master中的数据近实时同步到slave上，保证当master宕机的时候，还能有其它slave顶上来可以用。</p><p>当然上述一切都是猜测，具体的设计实现还得等0.5版本之后。目前有一个Go版本的Seata-Server也捐赠给了Seata(还在流程中)，其通过raft实现副本一致性，其它细节不是太清楚。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="28-metrics">2.8 Metrics<a href="#28-metrics" class="hash-link" aria-label="Direct link to 2.8 Metrics" title="Direct link to 2.8 Metrics">​</a></h2><p>这个模块也是一个没有具体公布实现的模块，当然有可能会提供插件口，让其它第三方metric接入进来，最近Apache SkyWalking 正在和Seata小组商讨如何接入进来。</p><h1>3.Coordinator Core</h1><p>上面我们讲了很多Server基础模块，想必大家对Seata的实现已经有个大概，接下来我会讲解事务协调器具体逻辑是如何实现的，让大家更加了解Seata的实现内幕。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-启动流程">3.1 启动流程<a href="#31-启动流程" class="hash-link" aria-label="Direct link to 3.1 启动流程" title="Direct link to 3.1 启动流程">​</a></h2><p>启动方法在Server类有个main方法，定义了我们启动流程：</p><p><img loading="lazy" src="/assets/images/main-616485b1d53577f53bdca2ea7817757b.png" width="651" height="643" class="img_ev3q"></p><p>step1：创建一个RpcServer，再这个里面包含了我们网络的操作，用Netty实现了服务端。</p><p>step2：解析端口号、本地文件地址（用户Server宕机未处理完成事务恢复)、IP(可选，本机只能获取内网ip，在跨网络时需要一个对外的vip注册服务)。</p><p>step3：初始化SessionHoler,其中最重要的重要就是重我们dataDir这个文件夹中恢复我们的数据，重建我们的Session。</p><p>step4：创建一个CoorDinator,这个也是我们事务协调器的逻辑核心代码，然后将其初始化，其内部初始化的逻辑会创建四个定时任务：</p><ul><li>retryRollbacking：重试rollback定时任务，用于将那些失败的rollback进行重试的，每隔5ms执行一次。</li><li>retryCommitting：重试commit定时任务，用于将那些失败的commit进行重试的，每隔5ms执行一次。</li><li>asyncCommitting：异步commit定时任务，用于执行异步的commit，每隔10ms一次。</li><li>timeoutCheck：超时定时任务检测，用于检测超时的任务，然后执行超时的逻辑，每隔2ms执行一次。</li></ul><p>step5： 初始化UUIDGenerator这个也是我们生成各种ID(transcationId,branchId)的基本类。</p><p>step6：将本地IP和监听端口设置到XID中，初始化rpcServer等待客户端的连接。</p><p>启动流程比较简单，下面我会介绍分布式事务框架中的常见的一些业务逻辑Seata是如何处理的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-begin-开启全局事务">3.2 Begin-开启全局事务<a href="#32-begin-开启全局事务" class="hash-link" aria-label="Direct link to 3.2 Begin-开启全局事务" title="Direct link to 3.2 Begin-开启全局事务">​</a></h2><p>一次分布式事务的起始点一定是开启全局事务，首先我们看看全局事务Seata是如何实现的：</p><p><img loading="lazy" src="/assets/images/begin-074ada9f769abc9a5011ce878814e570.png" width="894" height="211" class="img_ev3q"></p><p>step1： 根据应用ID，事务分组，名字，超时时间创建一个GloabSession，这个在前面也提到过它和branchSession分别是什么。</p><p>step2：对其添加一个RootSessionManager用于监听一些事件，这里要说一下目前在Seata里面有四种类型的Listener(这里要说明的是所有的sessionManager都实现了SessionLifecycleListener)：</p><ul><li>ROOT_SESSION_MANAGER：最全，最大的，拥有所有的Session。</li><li>ASYNC_COMMITTING_SESSION_MANAGER：用于管理需要做异步commit的Session。</li><li>RETRY_COMMITTING_SESSION_MANAGER：用于管理重试commit的Session。</li><li>RETRY_ROLLBACKING_SESSION_MANAGER：用于管理重试回滚的Session。
由于这里是开启事务，其它SessionManager不需要关注，我们只添加RootSessionManager即可。</li></ul><p>step3：开启Globalsession</p><p><img loading="lazy" src="/assets/images/begin2-6e0b8fe3620f79a765a756c755da0169.png" width="895" height="340" class="img_ev3q"></p><p>这一步会把状态变为Begin,记录开始时间,并且调用RootSessionManager的onBegin监听方法，将Session保存到map并写入到我们的文件。</p><p>step4：最后返回XID，这个XID是由 ip+port+transactionId 组成的，非常重要，当TM申请到之后需要将这个ID传到RM中，RM通过XID来决定到底应该访问哪一台Server。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-branchregister-分支事务注册">3.3 BranchRegister-分支事务注册<a href="#33-branchregister-分支事务注册" class="hash-link" aria-label="Direct link to 3.3 BranchRegister-分支事务注册" title="Direct link to 3.3 BranchRegister-分支事务注册">​</a></h2><p>当我们全局事务在TM开启之后，我们RM的分支事务也需要注册到我们的全局事务之上，这里看看是如何处理的：</p><p><img loading="lazy" src="/assets/images/branchRegister-fb53633441af1f3dab28ea6ad31ef84d.png" width="878" height="376" class="img_ev3q"></p><p>step1：通过transactionId获取并校验全局事务是否是开启状态。</p><p>step2：创建一个新的分支事务，也就是我们的BranchSession。</p><p>step3：对分支事务进行加全局锁，这里的逻辑就是使用的我们锁模块的逻辑。</p><p>step4：添加branchSession，主要是将其添加到globalSession对象中，并写入到我们的文件中。</p><p>step5：返回branchId,这个ID也很重要，我们后续需要用它来回滚我们的事务，或者对我们分支事务状态更新。</p><p>分支事务注册之后，还需要汇报分支事务的本地事务的执行到底是成功还是失败，在Server目前只是简单的做一下保存记录，汇报的目的是，就算这个分支事务失败，如果TM还是执意要提交全局事务（catch 异常不抛出），那么再遍历提交分支事务的时候，这个失败的分支事务就不需要提交（用户选择性跳过）。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="34-globalcommit---全局提交">3.4 GlobalCommit - 全局提交<a href="#34-globalcommit---全局提交" class="hash-link" aria-label="Direct link to 3.4 GlobalCommit - 全局提交" title="Direct link to 3.4 GlobalCommit - 全局提交">​</a></h2><p>当我们分支事务执行完成之后，就轮到我们的TM-事务管理器来决定是提交还是回滚，如果是提交，那么就会走到下面的逻辑:</p><p><img loading="lazy" src="/assets/images/commit-2583aeb4369e3f50d4deeeef29fa65a0.png" width="890" height="397" class="img_ev3q"></p><p>step1：首先找到我们的globalSession。如果它为null证明已经被commit过了，那么直接幂等操作，返回成功。</p><p>step2：关闭我们的GloabSession防止再次有新的branch进来(跨服务调用超时回滚，provider在继续执行)。</p><p>step3：如果status是等于Begin，那么久证明还没有提交过，改变其状态为Committing也就是正在提交。</p><p>step4：判断是否是可以异步提交，目前只有AT模式可以异步提交，二阶段全局提交时只是删除undolog并无严格顺序，此处使用定时任务，客户端收到后批量合并删除。</p><p>step5：如果是异步提交，直接将其放进我们ASYNC_COMMITTING_SESSION_MANAGER，让其再后台线程异步去做我们的step6，如果是同步的那么直接执行我们的step6。</p><p>step6：遍历我们的BranchSession进行提交，如果某个分支事务失败，根据不同的条件来判断是否进行重试，可异步执行此branchSession不成功可以继续执行下一个，因为其本身都在manager中，只要没有成功就不会被删除会一直重试，如果是同步提交的会放进重试队列进行定时重试并卡住按照顺序提交。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="35-globalrollback---全局回滚">3.5 GlobalRollback - 全局回滚<a href="#35-globalrollback---全局回滚" class="hash-link" aria-label="Direct link to 3.5 GlobalRollback - 全局回滚" title="Direct link to 3.5 GlobalRollback - 全局回滚">​</a></h2><p>如果我们的TM决定全局回滚，那么会走到下面的逻辑：</p><p><img loading="lazy" src="/assets/images/rollback-16f69f2b916af5c4cd61f0f194979646.png" width="1738" height="652" class="img_ev3q"></p><p>这个逻辑和提交流程基本一致，可以看作是它的反向，这里就不展开讲了。</p><h1>4.总结</h1><p>最后在总结一下开始我们提出了分布式事务的关键4点，Seata到底是怎么解决的：</p><ul><li>正确的协调：通过后台定时任务各种正确的重试，并且未来会推出监控平台有可能可以手动回滚。</li><li>高可用: 通过HA-Cluster保证高可用。</li><li>高性能：文件顺序写，RPC通过netty实现，Seata未来可以水平扩展，提高处理性能。</li><li>高扩展性：提供给用户可以自由实现的地方，比如配置，服务发现和注册，全局锁等等。</li></ul><p>最后希望大家能从这篇文章能了解Seata-Server的核心设计原理，当然你也可以想象如果你自己去实现一个分布式事务的Server应该怎样去设计？</p><p>Seata GitHub地址：<a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata</a>   </p><p>本文作者：</p><p>李钊，GitHub ID @CoffeeLatte007，公众号「咖啡拿铁」作者，Seata社区 Committer，猿辅导Java工程师，曾就职于美团。对分布式中间件，分布式系统有浓厚的兴趣。<br>
<!-- -->季敏(清铭)，GitHub ID @slievrly，Seata 开源项目负责人，阿里巴巴中间件 TXC/GTS 核心研发成员，长期从事于分布式中间件核心研发工作，在分布式事务领域有着较丰富的技术积累。</p></div></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/page/4"><div class="pagination-nav__label">Newer Entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/6"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Vision</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Seata is ...</a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/overview/what-is-seata">What is Seata?</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/user/quickstart">Quick Start</a></li><li class="footer__item"><a href="https://github.com/seata/seata.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">Report a doc issue<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/seata/seata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Edit This Page on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/community">Community</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="//img.alicdn.com/tfs/TB1dGrSwVT7gK0jSZFpXXaTkpXa-4802-1285.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="120" height="36"><img src="//img.alicdn.com/tfs/TB1dGrSwVT7gK0jSZFpXXaTkpXa-4802-1285.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="120" height="36"></div><div class="footer__copyright">Copyright © 2023 Seata</div></div></div></footer></div>
<script src="/assets/js/runtime~main.6888d26e.js"></script>
<script src="/assets/js/main.96f5711d.js"></script>
</body>
</html>