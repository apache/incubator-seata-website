<!doctype html>
<html lang="en-US" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">ConcurrentHashMap导致的Seata死锁问题 | Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://chai001125.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="http://chai001125.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="http://chai001125.github.io/blog/seata-dsproxy-deadlock"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="ConcurrentHashMap导致的Seata死锁问题 | Seata"><meta data-rh="true" name="description" content="本文主要介绍了一个线上问题，因ConcurrentHashMap的Bug而导致的Seata动态数据源代理死锁"><meta data-rh="true" property="og:description" content="本文主要介绍了一个线上问题，因ConcurrentHashMap的Bug而导致的Seata动态数据源代理死锁"><meta data-rh="true" name="keywords" content="Seata、动态数据源、DataSource、ConcurrentHashMap、computeIfAbsent"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-03-13T00:00:00.000Z"><link data-rh="true" rel="icon" href="/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="http://chai001125.github.io/blog/seata-dsproxy-deadlock"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/blog/seata-dsproxy-deadlock" hreflang="en-US"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/zh-cn/blog/seata-dsproxy-deadlock" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/blog/seata-dsproxy-deadlock" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Seata Atom Feed">




<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.js"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/assets/css/styles.c84d55f4.css">
<link rel="preload" href="/assets/js/runtime~main.6888d26e.js" as="script">
<link rel="preload" href="/assets/js/main.96f5711d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/">Home</a><a class="navbar__item navbar__link" href="/docs/overview/what-is-seata">Docs</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Solutions</a><ul class="dropdown__menu"><li><a href="https://cn.aliyun.com/product/aliware/mse?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Seata in cloud<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://cn.aliyun.com/product/aliware/mse?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Microservice solutions<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/ahas?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">High-availability solution<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://cn.aliyun.com/product/aliware/sae?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Serverless solution for microservices<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/edas?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">PaaS solution<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/servicemesh?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Service mesh solution<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://help.aliyun.com/document_detail/132903.html?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">SOFA distributed transaction<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a class="navbar__item navbar__link" href="/docs/developers/developers_dev">Developers</a><a href="https://mp.weixin.qq.com/s/nvDmIJEuDaNEY3RfTA3UyA" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Recruitment</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/docs/download">Download</a><a href="http://demo.seata.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Console sample</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>En</a><ul class="dropdown__menu"><li><a href="/blog/seata-dsproxy-deadlock" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">En</a></li><li><a href="/zh-cn/blog/seata-dsproxy-deadlock" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-observable-practice">Seata的可观测实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-lock">详解 Seata AT 模式事务隔离级别与全局锁设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-snowflake-explain">关于新版雪花算法的答疑</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-UUID-generator">Seata基于改良版雪花算法的分布式UUID生成器分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-feature-undo-log-compress">Seata新特性支持 -- undo_log压缩</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/seata-dsproxy-deadlock">ConcurrentHashMap导致的Seata死锁问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-client-start-analysis-02">Seata应用侧启动过程剖析——注册中心与配置中心模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-client-start-analysis-01">Seata应用侧启动过程剖析——RM &amp; TM如何与TC建立连接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrate-seata-tcc-mode-with-spring-cloud">Spring Cloud集成Seata分布式事务-TCC模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-config-manager">Seata配置管理原理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-golang-communication-mode">seata-golang 通信模型详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-datasource-proxy">Seata数据源代理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-demo-in-mac">Mac下的Seata Demo环境搭建（AT模式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-quick-start">Seata 极简入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-ha-practice">Seata 高可用部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-config-center">Seata 配置中心实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/quick-start-use-seata-and-dubbo-services">How to use Seata to ensure consistency between Dubbo Microservices</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/manual-transaction-mode">MT mode</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">ConcurrentHashMap导致的Seata死锁问题</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-03-13T00:00:00.000Z" itemprop="datePublished">March 13, 2021</time> · <!-- -->16 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">罗小勇</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><ol><li>seata版本：1.4.0，但1.4以下的所有版本也都有这个问题</li><li>问题描述：在一个全局事务中，一个分支事务上的纯查询操作突然卡住了，没有任何反馈(日志/异常)，直到消费端RPC超时</li></ol><p><img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03a7f737b56e45b4b74e662033ec74f6~tplv-k3u1fbpfcp-watermark.image" alt="image.png" class="img_ev3q"></p><h1>问题排查</h1><ol><li>整个流程在一个全局事务中，消费者和提供者可以看成是全局事务中的两个分支事务，消费者 --&gt; 提供者</li><li>消费者先执行本地的一些逻辑，然后向提供者发送RPC请求，确定消费者发出了请求已经并且提供者接到了请求</li><li>提供者先打印一条日志，然后执行一条纯查询SQL，如果SQL正常执行会打印日志，但目前的现象是只打印了执行SQL前的那条日志，而没有打印任何SQL相关的日志。找DBA查SQL日志，发现该SQL没有执行</li><li>确定了该操作只是全局事务下的一个纯查询操作，在该操作之前，全局事务中的整体流程完全正常</li><li>其实到这里现象已经很明显了，不过当时想法没转变过来，一直关注那条查询SQL，总在想就算查询超时等原因也应该抛出异常啊，不应该什么都没有。DBA都找不到查询记录，那是不是说明SQL可能根本就没执行啊，而是在执行SQL前就出问题了，比如代理？</li><li>借助arthas的watch命令，一直没有东西输出。第一条日志的输出代表这个方法一定执行了，迟迟没有结果输出说明当前请求卡住了，为什么卡住了呢？</li><li>借助arthas的thread命令 <code>thread -b</code> 、<code>thread -n</code>，就是要找出当前最忙的线程。这个效果很好，有一个线程CPU使用率<code>92%</code>,并且因为该线程导致其它20多个Dubbo线程<code>BLOCKED</code>了。堆栈信息如下</li><li>分析堆栈信息，已经可以很明显的发现和seata相关的接口了，估计和seata的数据源代理有关；同时发现CPU占用最高的那个线程卡在了<code>ConcurrentHashMap#computeIfAbsent</code>方法中。难道<code>ConcurrentHashMap#computeIfAbsent</code>方法有bug？</li><li>到这里，问题的具体原因我们还不知道，但应该和seata的数据源代理有点关系，具体原因我们需要分析业务代码和seata代码</li></ol><p><img loading="lazy" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/faac0be0982e45a7a43b335e8f8b44bf~tplv-k3u1fbpfcp-watermark.image" alt="image.png" class="img_ev3q"></p><h1>问题分析</h1><h3 class="anchor anchorWithStickyNavbar_LWe7" id="concurrenthashmapcomputeifabsent">ConcurrentHashMap#computeIfAbsent<a href="#concurrenthashmapcomputeifabsent" class="hash-link" aria-label="Direct link to ConcurrentHashMap#computeIfAbsent" title="Direct link to ConcurrentHashMap#computeIfAbsent">​</a></h3><p>这个方法确实有可能出问题：如果两个key的hascode相同，并且在对应的mappingFunction中又进行了computeIfAbsent操作，则会导致死循环，具体分析参考这篇文章：<a href="https://juejin.cn/post/6844904191077384200" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844904191077384200</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata数据源自动代理">Seata数据源自动代理<a href="#seata数据源自动代理" class="hash-link" aria-label="Direct link to Seata数据源自动代理" title="Direct link to Seata数据源自动代理">​</a></h3><p>相关内容之前有分析过，我们重点来看看以下几个核心的类：</p><ol><li>SeataDataSourceBeanPostProcessor</li><li>SeataAutoDataSourceProxyAdvice</li><li>DataSourceProxyHolder</li></ol><h5 class="anchor anchorWithStickyNavbar_LWe7" id="seatadatasourcebeanpostprocessor">SeataDataSourceBeanPostProcessor<a href="#seatadatasourcebeanpostprocessor" class="hash-link" aria-label="Direct link to SeataDataSourceBeanPostProcessor" title="Direct link to SeataDataSourceBeanPostProcessor">​</a></h5><p><code>SeataDataSourceBeanPostProcessor</code>是<code>BeanPostProcessor</code>实现类，在<code>postProcessAfterInitialization</code>方法(即Bean初始化之后)中，会为业务方配置的数据源创建对应的<code>seata代理数据源</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class SeataDataSourceBeanPostProcessor implements BeanPostProcessor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bean instanceof DataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //When not in the excludes, put and init proxy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!excludes.contains(bean.getClass().getName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //Only put and init proxy, not return proxy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataSourceProxyHolder.get().putDataSource((DataSource) bean, dataSourceProxyMode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //If is SeataDataSourceProxy, return the original data source.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (bean instanceof SeataDataSourceProxy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.info(&quot;Unwrap the bean of the data source,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot; and return the original data source to replace the data source proxy.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return ((SeataDataSourceProxy) bean).getTargetDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="seataautodatasourceproxyadvice">SeataAutoDataSourceProxyAdvice<a href="#seataautodatasourceproxyadvice" class="hash-link" aria-label="Direct link to SeataAutoDataSourceProxyAdvice" title="Direct link to SeataAutoDataSourceProxyAdvice">​</a></h5><p><code>SeataAutoDataSourceProxyAdvice</code>是一个MethodInterceptor，seata中的<code>SeataAutoDataSourceProxyCreator</code>会针对<code>DataSource类型的Bean</code>创建动态代理对象，代理逻辑就是<code>SeataAutoDataSourceProxyAdvice#invoke</code>逻辑。即：执行<code>数据源AOP代理对象</code>的相关方法时候，会经过其<code>invoke</code>方法，在<code>invoke</code>方法中再根据当原生数据源，找到对应的<code>seata代理数据源</code>，最终达到执行<code>seata代理数据源</code>逻辑的目的</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class SeataAutoDataSourceProxyAdvice implements MethodInterceptor, IntroductionInfo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object invoke(MethodInvocation invocation) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!RootContext.requireGlobalLock() &amp;&amp; dataSourceProxyMode != RootContext.getBranchType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return invocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method method = invocation.getMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object[] args = invocation.getArguments();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method m = BeanUtils.findDeclaredMethod(dataSourceProxyClazz, method.getName(), method.getParameterTypes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (m != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SeataDataSourceProxy dataSourceProxy = DataSourceProxyHolder.get().putDataSource((DataSource) invocation.getThis(), dataSourceProxyMode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return m.invoke(dataSourceProxy, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return invocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="datasourceproxyholder">DataSourceProxyHolder<a href="#datasourceproxyholder" class="hash-link" aria-label="Direct link to DataSourceProxyHolder" title="Direct link to DataSourceProxyHolder">​</a></h5><p>流程上我们已经清楚了，现在还有一个问题，如何维护<code>原生数据源</code>和<code>seata代理数据源</code>之间的关系？通过<code>DataSourceProxyHolder</code>维护，这是一个单例对象，该对象中通过一个ConcurrentHashMap维护两者的关系：<code>原生数据源</code>为key --&gt; <code>seata代理数据源</code> 为value</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSourceProxyHolder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      public SeataDataSourceProxy putDataSource(DataSource dataSource, BranchType dataSourceProxyMode) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataSource originalDataSource = dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return CollectionUtils.computeIfAbsent(this.dataSourceProxyMap, originalDataSource,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                BranchType.XA == dataSourceProxyMode ? DataSourceProxyXA::new : DataSourceProxy::new);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// CollectionUtils.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;K, V&gt; V computeIfAbsent(Map&lt;K, V&gt; map, K key, Function&lt;? super K, ? extends V&gt; mappingFunction) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    V value = map.get(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (value != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return map.computeIfAbsent(key, mappingFunction);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="客户端数据源配置">客户端数据源配置<a href="#客户端数据源配置" class="hash-link" aria-label="Direct link to 客户端数据源配置" title="Direct link to 客户端数据源配置">​</a></h3><ol><li>配置了两个数据源：<code>DynamicDataSource</code>、<code>P6DataSource</code></li><li><code>P6DataSource</code>可以看成是对<code>DynamicDataSource</code>的一层包装</li><li>我们暂时不去管这个配置合不合理，现在只是单纯的基于这个数据源配置分析问题</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Qualifier(&quot;dsMaster&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(&quot;dsMaster&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DynamicDataSource dsMaster() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DynamicDataSource(masterDsRoute);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Qualifier(&quot;p6DataSource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(&quot;p6DataSource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P6DataSource p6DataSource(@Qualifier(&quot;dsMaster&quot;) DataSource dataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P6DataSource p6DataSource =  new P6DataSource(dsMaster());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return p6DataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分析过程">分析过程<a href="#分析过程" class="hash-link" aria-label="Direct link to 分析过程" title="Direct link to 分析过程">​</a></h3><p><code>假设现在大家都已经知道了 ConcurrentHashMap#computeIfAbsent 可能会产生的问题</code>，已知现在产生了这个问题，结合堆栈信息，我们可以知道大概哪里产生了这个问题。</p><p>1、<code>ConcurrentHashMap#computeIfAbsent</code>会产生这个问题的前提条件是：<code>两个key的hashcode相同</code>；<code>mappingFunction中对应了一个put操作</code>。结合我们seata的使用场景，mappingFunction对应的是<code>DataSourceProxy::new</code>，说明在DataSourceProxy的构造方法中可能会触发put操作</p><p><img loading="lazy" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/00d8e13f71644c63b3bbb58c93b30e0c~tplv-k3u1fbpfcp-watermark.image" alt="image.png" class="img_ev3q"></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">执行AOP代理数据源相关方法 =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">进入SeataAutoDataSourceProxyAdvice切面逻辑 =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行DataSourceProxyHolder#putDataSource方法 =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行DataSourceProxy::new =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AOP代理数据源的getConnection方法 =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">原生数据源的getConnection方法  =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">进入SeataAutoDataSourceProxyAdvice切面逻辑 =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行DataSourceProxyHolder#putDataSource方法 =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行DataSourceProxy::new  =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DuridDataSource的getConnection方法</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2、步骤1中说的<code>AOP代理数据源</code>和<code>原生数据源</code>分别是什么？看下面这张图
<img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3579631f58df4d17bfcd6f28ccc3fd79~tplv-k3u1fbpfcp-watermark.image" alt="image.png" class="img_ev3q"></p><p>3、上面还说到了产生这个问题还有一个条件<code>两个key的hashcode相同</code>，但我看这两个数据源对象都没有重写<code>hashcode</code>方法，所以按理来说，这两个对象的hashcode一定是不同的。后面又再看了一遍ConcurrentHashMap这个问题，感觉<code>两个key的hashcode相同</code>这个说法是不对的，<code>两个key会产生hash冲突</code>更合理一些，这样就能解释两个hashcode不同的对象为啥会遇上这个问题了。为了证明这个，下面我给了一个例子</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Test {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConcurrentHashMap map = new ConcurrentHashMap(8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Num n1 = new Num(3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Num n2 = new Num(19);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Num n3 = new Num(20);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//      map.computeIfAbsent(n1, k1 -&gt; map.computeIfAbsent(n3, k2 -&gt; 200));      //  这行代码不会导致程序死循环</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        map.computeIfAbsent(n1, k1 -&gt; map.computeIfAbsent(n2, k2 -&gt; 200));      // 这行代码会导致程序死循环</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class Num{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Num(int i){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.i = i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public int hashCode() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>为了方便重现问题，我们重写了<code>Num#hashCode</code>方法，保证构造函数入参就是hashcode的值</li><li>创建一个ConcurrentHashMap对象，initialCapacity为8，sizeCtl计算出来的值为16，即该map中数组长度默认为16</li><li>创建对象<code>n1</code>，入参为3，即hashcode为3，计算得出其对应的数组下标为3</li><li>创建对象<code>n2</code>，入参为19，即hashcode为19，计算得出其对应的数组下标为3，此时我们可以认为<code>n1和n2产生了hash冲突</code></li><li>创建对象<code>n3</code>，入参为20，即hashcode为20，计算得出其对应的数组下标为4</li><li>执行<code>map.computeIfAbsent(n1, k1 -&gt; map.computeIfAbsent(n3, k2 -&gt; 200))</code>，程序正常退出：<code>因为n1和n3没有hash冲突，所以正常结束</code></li><li>执行<code>map.computeIfAbsent(n1, k1 -&gt; map.computeIfAbsent(n2, k2 -&gt; 200))</code>，程序正常退出：<code>因为n1和n2产生了hash冲突，所以陷入死循环</code></li></ol><p>4、在对象初始化的时候，<code>SeataDataSourceBeanPostProcessor</code>不是已经将对象对应的数据源代理初始化好了吗？为什么在<code>SeataAutoDataSourceProxyAdvice</code>中还是会创建对应的数据源代理呢？</p><ol><li>首先，<code>SeataDataSourceBeanPostProcessor</code>执行时期是晚于AOP代理对象创建的，所以在执行<code>SeataDataSourceBeanPostProcessor</code>相关方法的时候，<code>SeataAutoDataSourceProxyAdvice</code>其实应生效了</li><li><code>SeataDataSourceBeanPostProcessor</code>中向map中添加元素时，key为<code>AOP代理数据源</code>；<code>SeataAutoDataSourceProxyAdvice</code>中的<code>invocation.getThis()</code>中拿到的是<code>原生数据源</code>，所以key不相同</li></ol><p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/747b664a0b6c4f58843947576dd0856e~tplv-k3u1fbpfcp-watermark.image" alt="image.png" class="img_ev3q"></p><p>5、还有一个问题，<code>SeataAutoDataSourceProxyAdvic#invoke</code>方法中并没有过滤<code>toString、hashCode</code>等方法，cglib创建的代理对象默认会重写这几个方法，如果在向map中put元素的时候触发了代理对象的这些方法，此时又会重新进入<code>SeataAutoDataSourceProxyAdvic#invoke</code>切面，直到线程堆栈益处</p><h1>问题总结</h1><ol><li>在两个key会产生hash冲突的时候，会触发<code>ConcurrentHashMap#computeIfAbsent</code>BUG，该BUG的表现就是让当前线程陷入死循环</li><li>业务反馈，该问题是偶现的，偶现的原因有两种：首先，该应用是多节点部署，但线上只有一个节点触发了该BUG(hashcode冲突)，所以只有当请求打到这个节点的时候才有可能会触发该BUG；其次，因为每次重启对象地址(hashcode)都是不确定的，所以并不是每次应用重启之后都会触发，但如果一旦触发，该节点就会一直存在这个问题。有一个线程一直在死循环，并将其它尝试从map中获取代理数据源的线程阻塞了，这种现象在业务上的反馈就是请求卡住了。如果连续请求都是这样，此时业务方可能会重启服务，然后<code>因为重启后hash冲突不一定存在，可能重启后业务表现就正常了，但也有可能在下次重启的时候又会触发了这个BUG</code></li><li>当遇到这个问题时，从整个问题上来看，确实就是死锁了，因为那个死循环的线程占者锁一直不释放，导致其它操作该map的线程被BLOCK了</li><li>本质上还是因为<code>ConcurrentHashMap#computeIfAbsent方法可能会触发BUG</code>，而seata的使用场景刚好就触发了该BUG</li><li>下面这个demo其实就完整的模拟了线上出问题时的场景，如下：</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Test {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConcurrentHashMap map = new ConcurrentHashMap(8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Num n1 = new Num(3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Num n2 = new Num(19);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for(int i = 0; i&lt; 20; i++){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new Thread(()-&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Thread.sleep(1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                map.computeIfAbsent(n1, k-&gt; 200);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }).start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        map.computeIfAbsent(n1, k1 -&gt; map.computeIfAbsent(n2, k2 -&gt; 200));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class Num{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Num(int i){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.i = i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public int hashCode() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d6134c6498fa49c4a68b2745ba0895e3~tplv-k3u1fbpfcp-watermark.image" alt="image.png" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决问题">解决问题<a href="#解决问题" class="hash-link" aria-label="Direct link to 解决问题" title="Direct link to 解决问题">​</a></h3><p>可以从两方面解决这个问题：</p><ol><li>业务方改动：P6DataSource 和 DynamicDataSource 没必要都被代理，直接代理P6DataSource就可以了，DynamicDataSource没有必要声明成一个Bean；或者通过excluds属性排除P6DataSource，这样就不会存在重复代理问题</li><li>Seata完善：完善数据源代理相关逻辑</li></ol><h5 class="anchor anchorWithStickyNavbar_LWe7" id="业务方改动">业务方改动<a href="#业务方改动" class="hash-link" aria-label="Direct link to 业务方改动" title="Direct link to 业务方改动">​</a></h5><p>1、数据源相关的配置改成如下即可：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Qualifier(&quot;p6DataSource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(&quot;p6DataSource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P6DataSource p6DataSource(@Qualifier(&quot;dsMaster&quot;) DataSource dataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P6DataSource p6DataSource =  new P6DataSource(new TuYaDynamicDataSource(masterDsRoute));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger.warn(&quot;dsMaster={}, hashcode={}&quot;,p6DataSource, p6DataSource.hashCode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return p6DataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2、或者不改变目前的数据源配置，添加excluds属性</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@EnableAutoDataSourceProxy(excludes={&quot;P6DataSource&quot;})</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="seata完善">Seata完善<a href="#seata完善" class="hash-link" aria-label="Direct link to Seata完善" title="Direct link to Seata完善">​</a></h5><p>1、<code>ConcurrentHashMap#computeIfAbsent</code>方法改成双重检查，如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SeataDataSourceProxy dsProxy = dataSourceProxyMap.get(originalDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (dsProxy == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (dataSourceProxyMap) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dsProxy = dataSourceProxyMap.get(originalDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dsProxy == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dsProxy = createDsProxyByMode(dataSourceProxyMode, originalDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dataSourceProxyMap.put(originalDataSource, dsProxy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return dsProxy;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>之前我想直接改<code>CollectionUtils#computeIfAbsent</code>方法，群里大佬反馈这样可能会导致数据源多次创建，确实有这个问题：如下</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static &lt;K, V&gt; V computeIfAbsent(Map&lt;K, V&gt; map, K key, Function&lt;? super K, ? extends V&gt; mappingFunction) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    V value = map.get(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (value != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value = mappingFunction.apply(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return map.computeIfAbsent(key, value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2、SeataAutoDataSourceProxyAdvice切面逻辑中添加一些过滤</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Method m = BeanUtils.findDeclaredMethod(dataSourceProxyClazz, method.getName(), method.getParameterTypes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (m != null &amp;&amp; DataSource.class.isAssignableFrom(method.getDeclaringClass())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SeataDataSourceProxy dataSourceProxy = DataSourceProxyHolder.get().putDataSource((DataSource) invocation.getThis(), dataSourceProxyMode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return m.invoke(dataSourceProxy, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return invocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="遗留问题">遗留问题<a href="#遗留问题" class="hash-link" aria-label="Direct link to 遗留问题" title="Direct link to 遗留问题">​</a></h3><p>在<code>SeataDataSourceBeanPostProcessor</code>和<code>SeataAutoDataSourceProxyAdvice</code>对应方法中，向map中初始化<code>seata数据源代理</code>时对应的key根本就不同，<code>SeataDataSourceBeanPostProcessor</code>中对应的key是<code>AOP代理数据源</code>；<code>SeataAutoDataSourceProxyAdvice</code>中对应的key是原生对象，此时就造成了不必要的<code>seata数据源代理</code>对象的创建。</p><p>针对这个问题，大家有什么好的建议？能不能为<code>SeataDataSourceBeanPostProcessor</code>指定一个order，让其在创建AOP代理对象之前生效</p><h1>原文链接</h1><p><a href="https://juejin.cn/post/6939041336964153352/" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6939041336964153352/</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/seata-feature-undo-log-compress"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Seata新特性支持 -- undo_log压缩</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/seata-client-start-analysis-02"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Seata应用侧启动过程剖析——注册中心与配置中心模块</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#concurrenthashmapcomputeifabsent" class="table-of-contents__link toc-highlight">ConcurrentHashMap#computeIfAbsent</a></li><li><a href="#seata数据源自动代理" class="table-of-contents__link toc-highlight">Seata数据源自动代理</a></li><li><a href="#客户端数据源配置" class="table-of-contents__link toc-highlight">客户端数据源配置</a></li><li><a href="#分析过程" class="table-of-contents__link toc-highlight">分析过程</a></li><li><a href="#解决问题" class="table-of-contents__link toc-highlight">解决问题</a></li><li><a href="#遗留问题" class="table-of-contents__link toc-highlight">遗留问题</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Vision</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Seata is ...</a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/overview/what-is-seata">What is Seata?</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/user/quickstart">Quick Start</a></li><li class="footer__item"><a href="https://github.com/seata/seata.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">Report a doc issue<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/seata/seata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Edit This Page on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/community">Community</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="//img.alicdn.com/tfs/TB1dGrSwVT7gK0jSZFpXXaTkpXa-4802-1285.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="120" height="36"><img src="//img.alicdn.com/tfs/TB1dGrSwVT7gK0jSZFpXXaTkpXa-4802-1285.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="120" height="36"></div><div class="footer__copyright">Copyright © 2023 Seata</div></div></div></footer></div>
<script src="/assets/js/runtime~main.6888d26e.js"></script>
<script src="/assets/js/main.96f5711d.js"></script>
</body>
</html>