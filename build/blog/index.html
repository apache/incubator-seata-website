<!doctype html>
<html lang="en-US" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://seata.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://seata.io/blog"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="keywords" content="Seata"><meta data-rh="true" property="og:title" content="Blog | Seata"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.io/blog"><link data-rh="true" rel="alternate" href="https://seata.io/blog" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.io/zh-cn/blog" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.io/blog" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Seata Atom Feed">




<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.js"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/assets/css/styles.c84d55f4.css">
<link rel="preload" href="/assets/js/runtime~main.a3727777.js" as="script">
<link rel="preload" href="/assets/js/main.ab6a73b0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/">Home</a><a class="navbar__item navbar__link" href="/docs/overview/what-is-seata">Docs</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Solutions</a><ul class="dropdown__menu"><li><a href="https://www.aliyun.com/product/aliware/mse?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Seata in Cloud<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://help.aliyun.com/document_detail/132903.html?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">SOFA distributed transaction<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://free.aliyun.com/?searchKey=nacos&amp;spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Free trial<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/docs/developers/developers_dev">Developers</a><a href="https://mp.weixin.qq.com/s/nvDmIJEuDaNEY3RfTA3UyA" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Recruitment</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/docs/download">Download</a><a href="http://demo.seata.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Console sample</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>En</a><ul class="dropdown__menu"><li><a href="/blog" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">En</a></li><li><a href="/zh-cn/blog" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-observable-practice">Seata的可观测实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-lock">详解 Seata AT 模式事务隔离级别与全局锁设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-snowflake-explain">关于新版雪花算法的答疑</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-UUID-generator">Seata基于改良版雪花算法的分布式UUID生成器分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-feature-undo-log-compress">Seata新特性支持 -- undo_log压缩</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-dsproxy-deadlock">ConcurrentHashMap导致的Seata死锁问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-client-start-analysis-02">Seata应用侧启动过程剖析——注册中心与配置中心模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-client-start-analysis-01">Seata应用侧启动过程剖析——RM &amp; TM如何与TC建立连接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrate-seata-tcc-mode-with-spring-cloud">Spring Cloud集成Seata分布式事务-TCC模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-config-manager">Seata配置管理原理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-golang-communication-mode">seata-golang 通信模型详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-datasource-proxy">Seata数据源代理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-demo-in-mac">Mac下的Seata Demo环境搭建（AT模式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-quick-start">Seata 极简入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-ha-practice">Seata 高可用部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-config-center">Seata 配置中心实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/quick-start-use-seata-and-dubbo-services">How to use Seata to ensure consistency between Dubbo Microservices</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/manual-transaction-mode">MT mode</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-08-15T13:12:46.000Z" itemprop="datePublished">August 15, 2023</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="活动介绍">活动介绍<a href="#活动介绍" class="hash-link" aria-label="Direct link to 活动介绍" title="Direct link to 活动介绍">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="亮点解读">亮点解读<a href="#亮点解读" class="hash-link" aria-label="Direct link to 亮点解读" title="Direct link to 亮点解读">​</a></h3><ul><li>Seata 开源项目发起人带来《Seata 过去、现在和未来》以及 Seata 1.0 的新特性。</li><li>Seata 核心贡献者详解 Seata AT, TCC, Saga 模式。</li><li>Seata 落地互联网医疗，滴滴出行实践剖析。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如您不能前来参会">如您不能前来参会<a href="#如您不能前来参会" class="hash-link" aria-label="Direct link to 如您不能前来参会" title="Direct link to 如您不能前来参会">​</a></h3><ul><li><a href="https://developer.aliyun.com/live/1760" target="_blank" rel="noopener noreferrer">预约直播（开发者社区）</a></li><li><a href="http://w2wz.com/h2nb" target="_blank" rel="noopener noreferrer">加入 Seata 千人钉钉群</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="现场福利">现场福利<a href="#现场福利" class="hash-link" aria-label="Direct link to 现场福利" title="Direct link to 现场福利">​</a></h3><ul><li>讲师 PPT 打包下载</li><li>精美茶歇,阿里公仔,天猫精灵等好礼等你来拿</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="议程">议程<a href="#议程" class="hash-link" aria-label="Direct link to 议程" title="Direct link to 议程">​</a></h3><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1K5nYwVP7gK0jSZFjXXc5aXXa-3175-14507.png" class="img_ev3q"></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-08-15T13:12:46.000Z" itemprop="datePublished">August 15, 2023</time> · <!-- -->2 min read</div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1qH2YwVP7gK0jSZFjXXc5aXXa-2002-901.jpg" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="活动介绍">活动介绍<a href="#活动介绍" class="hash-link" aria-label="Direct link to 活动介绍" title="Direct link to 活动介绍">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="亮点解读">亮点解读<a href="#亮点解读" class="hash-link" aria-label="Direct link to 亮点解读" title="Direct link to 亮点解读">​</a></h3><ul><li><p>Seata 开源项目发起人带来《Seata 过去、现在和未来》以及 Seata 1.0 的新特性。</p></li><li><p>Seata 核心贡献者详解 Seata AT, TCC, Saga 模式。</p></li><li><p>Seata 落地互联网医疗，滴滴出行实践剖析。</p></li><li><p><a href="https://developer.aliyun.com/live/1760" target="_blank" rel="noopener noreferrer">回放福利（开发者社区）</a></p></li><li><p><a href="http://w2wz.com/h2nb" target="_blank" rel="noopener noreferrer">加入 Seata 千人钉钉群</a></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分享嘉宾">分享嘉宾<a href="#分享嘉宾" class="hash-link" aria-label="Direct link to 分享嘉宾" title="Direct link to 分享嘉宾">​</a></h3><ul><li><p>季敏(清铭) 《Seata 的过去、现在和未来》 <a href="https://github.com/a364176773/awesome-seata/blob/master/slides/meetup/201912%40hangzhou/%E5%AD%A3%E6%95%8F%EF%BC%88%E6%B8%85%E9%93%AD%EF%BC%89%E3%80%8ASeata%20%E7%9A%84%E8%BF%87%E5%8E%BB%E3%80%81%E7%8E%B0%E5%9C%A8%E5%92%8C%E6%9C%AA%E6%9D%A5%E3%80%8B.pdf" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1BALWw4z1gK0jSZSgXXavwpXa-6720-4480.jpg" class="img_ev3q"></p></li><li><p>吴江坷《我与SEATA的开源之路以及SEATA在互联网医疗系统中的应用》 <a href="https://github.com/seata/awesome-seata/blob/master/slides/meetup/201912%40hangzhou/%E5%AD%A3%E6%95%8F%EF%BC%88%E6%B8%85%E9%93%AD%EF%BC%89%E3%80%8ASeata%20%E7%9A%84%E8%BF%87%E5%8E%BB%E3%80%81%E7%8E%B0%E5%9C%A8%E5%92%8C%E6%9C%AA%E6%9D%A5%E3%80%8B.pdf" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1Xzz1w4v1gK0jSZFFXXb0sXXa-6720-4480.jpg" alt="1577282651" class="img_ev3q"></p></li><li><p>申海强（煊檍)《带你读透 Seata AT 模式的精髓》 <a href="https://github.com/seata/awesome-seata/tree/master/slides/meetup/201912%40hangzhou" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1UK22w7T2gK0jSZPcXXcKkpXa-6720-4480.jpg" alt="1577282652" class="img_ev3q"></p></li><li><p>张森 《分布式事务Seata之TCC模式详解》</p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1fCPZw.T1gK0jSZFhXXaAtVXa-6720-4480.jpg" alt="1577282653" class="img_ev3q"></p></li><li><p>陈龙（屹远）《Seata 长事务解决方案 Saga 模式》</p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1zLv3wYj1gK0jSZFuXXcrHpXa-6720-4480.jpg" alt="1577282654" class="img_ev3q"></p></li><li><p>陈鹏志《Seata%20在滴滴两轮车业务的实践》 <a href="https://github.com/seata/awesome-seata/blob/master/slides/meetup/201912%40hangzhou/%E9%99%88%E9%B9%8F%E5%BF%97%E3%80%8ASeata%20%E5%9C%A8%E6%BB%B4%E6%BB%B4%E4%B8%A4%E8%BD%AE%E8%BD%A6%E4%B8%9A%E5%8A%A1%E7%9A%84%E5%AE%9E%E8%B7%B5%E3%80%8B.pdf" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1phvYw4n1gK0jSZKPXXXvUXXa-6720-4480.jpg" alt="1577282655" class="img_ev3q"></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="特别嘉奖">特别嘉奖<a href="#特别嘉奖" class="hash-link" aria-label="Direct link to 特别嘉奖" title="Direct link to 特别嘉奖">​</a></h3><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1khDVw.z1gK0jSZLeXXb9kVXa-6720-4480.jpg" class="img_ev3q"></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-observable-practice">Seata的可观测实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-25T00:00:00.000Z" itemprop="datePublished">June 25, 2023</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">刘戎-Seata</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata简介">Seata简介<a href="#seata简介" class="hash-link" aria-label="Direct link to Seata简介" title="Direct link to Seata简介">​</a></h2><p>Seata的前身是阿里巴巴集团内大规模使用保证分布式事务一致性的中间件，Seata是其开源产品，由社区维护。在介绍Seata前，先与大家讨论下我们业务发展过程中经常遇到的一些问题场景。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="业务场景">业务场景<a href="#业务场景" class="hash-link" aria-label="Direct link to 业务场景" title="Direct link to 业务场景">​</a></h3><p>我们业务在发展的过程中，基本上都是从一个简单的应用，逐渐过渡到规模庞大、业务复杂的应用。这些复杂的场景难免遇到分布式事务管理问题，Seata的出现正是解决这些分布式场景下的事务管理问题。介绍下其中几个经典的场景：</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="场景一分库分表场景下的分布式事务">场景一：分库分表场景下的分布式事务<a href="#场景一分库分表场景下的分布式事务" class="hash-link" aria-label="Direct link to 场景一：分库分表场景下的分布式事务" title="Direct link to 场景一：分库分表场景下的分布式事务">​</a></h4><p><img loading="lazy" alt="image.png" src="/assets/images/metrics-分库分表场景下的分布式事务-ee0eff8cf24e6e3e997b0b040c56690e.png" width="1200" height="624" class="img_ev3q">
起初我们的业务规模小、轻量化，单一数据库就能保障我们的数据链路。但随着业务规模不断扩大、业务不断复杂化，通常单一数据库在容量、性能上会遭遇瓶颈。通常的解决方案是向分库、分表的架构演进。此时，即引入了<strong>分库分表场景下</strong>的分布式事务场景。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="场景二跨服务场景下的分布式事务">场景二：跨服务场景下的分布式事务<a href="#场景二跨服务场景下的分布式事务" class="hash-link" aria-label="Direct link to 场景二：跨服务场景下的分布式事务" title="Direct link to 场景二：跨服务场景下的分布式事务">​</a></h4><p><img loading="lazy" alt="image.png" src="/assets/images/metrics-跨服务场景下的分布式事务-ccc122e03531914d0945e82137912655.png" width="1200" height="647" class="img_ev3q">
降低单体应用复杂度的方案：应用微服务化拆分。拆分后，我们的产品由多个功能各异的微服务组件构成，每个微服务都使用独立的数据库资源。在涉及到跨服务调用的数据一致性场景时，就引入了<strong>跨服务场景下</strong>的分布式事务。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata架构">Seata架构<a href="#seata架构" class="hash-link" aria-label="Direct link to Seata架构" title="Direct link to Seata架构">​</a></h3><p><img loading="lazy" alt="image.png" src="/assets/images/metrics-Seata架构-d45c1d1bf146b044c4f1b7f85ba3beb8.png" width="1534" height="908" class="img_ev3q">
其核心组件主要如下：</p><ul><li><strong>Transaction Coordinator（TC）</strong></li></ul><p>事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚。</p><ul><li><strong>Transaction Manager（TM）</strong></li></ul><p>控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议，TM定义全局事务的边界。</p><ul><li><strong>Resource Manager（RM）</strong></li></ul><p>控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚。RM负责定义分支事务的边界和行为。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata的可观测实践">Seata的可观测实践<a href="#seata的可观测实践" class="hash-link" aria-label="Direct link to Seata的可观测实践" title="Direct link to Seata的可观测实践">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="为什么需要可观测">为什么需要可观测？<a href="#为什么需要可观测" class="hash-link" aria-label="Direct link to 为什么需要可观测？" title="Direct link to 为什么需要可观测？">​</a></h3><ul><li><strong>分布式事务消息链路较复杂</strong></li></ul><p>Seata在解决了用户易用性和分布式事务一致性这些问题的同时，需要多次TC与TM、RM之间的交互，尤其当微服务的链路变复杂时，Seata的交互链路也会呈正相关性增加。这种情况下，其实我们就需要引入可观测的能力来观察、分析事物链路。</p><ul><li><strong>异常链路、故障排查难定位，性能优化无从下手</strong></li></ul><p>在排查Seata的异常事务链路时，传统的方法需要看日志，这样检索起来比较麻烦。在引入可观测能力后，帮助我们直观的分析链路，快速定位问题；为优化耗时的事务链路提供依据。</p><ul><li><strong>可视化、数据可量化</strong></li></ul><p>可视化能力可让用户对事务执行情况有直观的感受；借助可量化的数据，可帮助用户评估资源消耗、规划预算。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="可观测能力概览">可观测能力概览<a href="#可观测能力概览" class="hash-link" aria-label="Direct link to 可观测能力概览" title="Direct link to 可观测能力概览">​</a></h3><table><thead><tr><th><strong>可观测维度</strong></th><th><strong>seata期望的能力</strong></th><th><strong>技术选型参考</strong></th></tr></thead><tbody><tr><td>Metrics</td><td>功能层面：可按业务分组隔离，采集事务总量、耗时等重要指标</td><td></td></tr></tbody></table><p>性能层面：高度量性能，插件按需加载
架构层面：减少第三方依赖，服务端、客户端能够采用统一的架构，减少技术复杂度
兼容性层面：至少兼容Prometheus生态 | Prometheus：指标存储和查询等领域有着业界领先的地位
OpenTelemetry：可观测数据采集和规范的事实标准。但自身并不负责数据的存储，展示和分析 |
| Tracing | 功能层面：全链路追踪分布式事务生命周期，反应分布式事务执行性能消耗
易用性方面：对使用seata的用户而言简单易接入 | SkyWalking：利用Java的Agent探针技术，效率高，简单易用。 |
| Logging | 功能层面：记录服务端、客户端全部生命周期信息
易用性层面：能根据XID快速匹配全局事务对应链路日志 | Alibaba Cloud Service
ELK |</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="metrics维度">Metrics维度<a href="#metrics维度" class="hash-link" aria-label="Direct link to Metrics维度" title="Direct link to Metrics维度">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="设计思路">设计思路<a href="#设计思路" class="hash-link" aria-label="Direct link to 设计思路" title="Direct link to 设计思路">​</a></h4><ol><li>Seata作为一个被集成的数据一致性框架，Metrics模块将尽可能少的使用第三方依赖以降低发生冲突的风险</li><li>Metrics模块将竭力争取更高的度量性能和更低的资源开销，尽可能降低开启后带来的副作用</li><li>配置时，Metrics是否激活、数据如何发布，取决于对应的配置；开启配置则自动启用，并默认将度量数据通过prometheusexporter的形式发布</li><li>不使用Spring，使用SPI(Service Provider Interface)加载扩展</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="模块设计">模块设计<a href="#模块设计" class="hash-link" aria-label="Direct link to 模块设计" title="Direct link to 模块设计">​</a></h4><p><img loading="lazy" alt="图片 1.png" src="/assets/images/metrics-模块设计-44acf0482c9b8fbb5f6ec11a1423440c.png" width="1296" height="746" class="img_ev3q"></p><ul><li>seata-metrics-core：Metrics核心模块，根据配置组织（加载）1个Registry和N个Exporter；</li><li>seata-metrics-api：定义了Meter指标接口，Registry指标注册中心接口；</li><li>seata-metrics-exporter-prometheus：内置的prometheus-exporter实现；</li><li>seata-metrics-registry-compact：内置的Registry实现，并轻量级实现了Gauge、Counter、Summay、Timer指标；</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics模块工作流">metrics模块工作流<a href="#metrics模块工作流" class="hash-link" aria-label="Direct link to metrics模块工作流" title="Direct link to metrics模块工作流">​</a></h4><p><img loading="lazy" alt="图片 1.png" src="/assets/images/metrics-模块工作流-cf55ed8598aa42930fb5d0c58399463d.png" width="1534" height="964" class="img_ev3q">
上图是metrics模块的工作流，其工作流程如下：</p><ol><li>利用SPI机制，根据配置加载Exporter和Registry的实现类；</li><li>基于消息订阅与通知机制，监听所有全局事务的状态变更事件，并publish到EventBus；</li><li>事件订阅者消费事件，并将生成的metrics写入Registry；</li><li>监控系统（如prometheus）从Exporter中拉取数据。</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tc核心指标">TC核心指标<a href="#tc核心指标" class="hash-link" aria-label="Direct link to TC核心指标" title="Direct link to TC核心指标">​</a></h4><p><img loading="lazy" alt="image.png" src="/assets/images/metrics-TC核心指标-7de91006545ab3e5518b6889456a8302.png" width="1746" height="1072" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tm核心指标">TM核心指标<a href="#tm核心指标" class="hash-link" aria-label="Direct link to TM核心指标" title="Direct link to TM核心指标">​</a></h4><p><img loading="lazy" alt="image.png" src="/assets/images/metrics-TM核心指标-8ef5523801c632ae5af707ade30576b5.png" width="2308" height="1094" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rm核心指标">RM核心指标<a href="#rm核心指标" class="hash-link" aria-label="Direct link to RM核心指标" title="Direct link to RM核心指标">​</a></h4><p><img loading="lazy" alt="image.png" src="/assets/images/metrics-RM核心指标-30ac5fe4e5c6e0d0727a3d28bf94ec82.png" width="2122" height="1580" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="大盘展示">大盘展示<a href="#大盘展示" class="hash-link" aria-label="Direct link to 大盘展示" title="Direct link to 大盘展示">​</a></h4><p><img loading="lazy" alt="lQLPJxZhZlqESU3NBpjNBp6w8zYK6VbMgzYCoKVrWEDWAA_1694_1688.png" src="/assets/images/metrics-大盘展示-1f6d2bdf7f5bc02f56244b361764ee7c.png" width="1694" height="1688" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tracing维度">Tracing维度<a href="#tracing维度" class="hash-link" aria-label="Direct link to Tracing维度" title="Direct link to Tracing维度">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata为什么需要tracing">Seata为什么需要tracing？<a href="#seata为什么需要tracing" class="hash-link" aria-label="Direct link to Seata为什么需要tracing？" title="Direct link to Seata为什么需要tracing？">​</a></h4><ol><li>对业务侧而言，引入Seata后，对业务性能会带来多大损耗？主要时间消耗在什么地方？如何针对性的优化业务逻辑？这些都是未知的。</li><li>Seata的所有消息记录都通过日志持久化落盘，但对不了解Seata的用户而言，日志非常不友好。能否通过接入Tracing，提升事务链路排查效率？</li><li>对于新手用户，可通过Tracing记录，快速了解seata的工作原理，降低seata使用门槛。</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata的tracing解决方案">Seata的tracing解决方案<a href="#seata的tracing解决方案" class="hash-link" aria-label="Direct link to Seata的tracing解决方案" title="Direct link to Seata的tracing解决方案">​</a></h4><ul><li>Seata在自定义的RPC消息协议中定义了Header信息；</li><li>SkyWalking拦截指定的RPC消息，并注入tracing相关的span信息；</li><li>以RPC消息的发出&amp;接收为临界点，定义了span的生命周期范围。</li></ul><p>基于上述的方式，Seata实现了事务全链路的tracing，具体接入可参考<a href="https://seata.io/zh-cn/docs/user/apm/skywalking.html" target="_blank" rel="noopener noreferrer">为[Seata应用 | Seata-server]接入Skywalking</a>。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tracing效果">tracing效果<a href="#tracing效果" class="hash-link" aria-label="Direct link to tracing效果" title="Direct link to tracing效果">​</a></h4><ul><li>基于的demo场景：</li></ul><ol><li>用户请求交易服务</li><li>交易服务锁定库存</li><li>交易服务创建账单</li><li>账单服务进行扣款</li></ol><p><img loading="lazy" alt="image.png" src="/assets/images/metrics-tracing效果-业务逻辑图-92ed3a1bb1fc62135d8d02d1a21951fb.png" width="865" height="489" class="img_ev3q"></p><ul><li>GlobalCommit成功的事务链路（事例）</li></ul><p><img loading="lazy" alt="image.png" src="/assets/images/metrics-tracing效果-tracing链1-e4e8b13e4b0a74c76631560a66973d2a.png" width="1080" height="1788" class="img_ev3q">
<img loading="lazy" alt="image.png" src="/assets/images/metrics-tracing效果-tracing链2-d5a816ec8b49b6ca95309eeda8470825.png" width="1080" height="2647" class="img_ev3q">
<img loading="lazy" alt="image.png" src="/assets/images/metrics-tracing效果-tracing链3-c50deab1728f8e61946a26d7d1b49da8.png" width="1080" height="1466" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="logging维度">Logging维度<a href="#logging维度" class="hash-link" aria-label="Direct link to Logging维度" title="Direct link to Logging维度">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="设计思路-1">设计思路<a href="#设计思路-1" class="hash-link" aria-label="Direct link to 设计思路" title="Direct link to 设计思路">​</a></h4><p><img loading="lazy" alt="image.png" src="/assets/images/metrics-logging设计思路-c90fe7b88cab305e7b3c918df2cba8b6.png" width="1434" height="454" class="img_ev3q">
Logging这一块其实承担的是可观测这几个维度当中的兜底角色。放在最底层的，其实就是我们日志格式的设计，只有好日志格式，我们才能对它进行更好的采集、模块化的存储和展示。在其之上，是日志的采集、存储、监控、告警、数据可视化，这些模块更多的是有现成的工具，比如阿里的SLS日志服务、还有ELK的一套技术栈，我们更多是将开销成本、接入复杂度、生态繁荣度等作为考量。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="日志格式设计">日志格式设计<a href="#日志格式设计" class="hash-link" aria-label="Direct link to 日志格式设计" title="Direct link to 日志格式设计">​</a></h4><p>这里拿Seata-Server的一个日志格式作为案例：
<img loading="lazy" alt="image.png" src="/assets/images/metrics-logging日志效果-049f409856a4895fe3d27d7930e028f8.png" width="1342" height="364" class="img_ev3q"></p><ul><li>线程池规范命名：当线程池、线程比较多时，规范的线程命名能将无序执行的线程执行次序清晰展示。</li><li>方法全类名可追溯：快速定位到具体的代码块。</li><li>重点运行时信息透出：重点突出关键日志，不关键的日志不打印，减少日志冗余。</li><li>消息格式可扩展：通过扩展消息类的输出格式，减少日志的代码修改量。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结展望">总结&amp;展望<a href="#总结展望" class="hash-link" aria-label="Direct link to 总结&amp;展望" title="Direct link to 总结&amp;展望">​</a></h2><h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics">Metrics<a href="#metrics" class="hash-link" aria-label="Direct link to Metrics" title="Direct link to Metrics">​</a></h4><p>总结：基本实现分布式事务的可量化、可观测。
展望：更细粒度的指标、更广阔的生态兼容。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tracing">Tracing<a href="#tracing" class="hash-link" aria-label="Direct link to Tracing" title="Direct link to Tracing">​</a></h4><p>总结：分布式事务全链路的可追溯。
展望：根据xid追溯事务链路，异常链路根因快速定位。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="logging">Logging<a href="#logging" class="hash-link" aria-label="Direct link to Logging" title="Direct link to Logging">​</a></h4><p>总结：结构化的日志格式。
展望：日志可观测体系演进。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-10T00:00:00.000Z" itemprop="datePublished">June 10, 2023</time> · <!-- -->23 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">季敏-Seata 开源社区创始人，分布式事务团队负责人</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>本文主要介绍分布式事务从内部到商业化和开源的演进历程，Seata社区当前进展和未来规划。</p><p>Seata是一款开源的分布式事务解决方案，旨在为现代化微服务架构下的分布式事务提供解决方案。Seata提供了完整的分布式事务解决方案，包括AT、TCC、Saga和XA事务模式，可支持多种编程语言和数据存储方案。Seata还提供了简便易用的API，以及丰富的文档和示例，方便企业在应用Seata时进行快速开发和部署。</p><p><strong>Seata的优势在于具有高可用性、高性能、高扩展性等特点，同时在进行横向扩展时也无需做额外的复杂操作。</strong> 目前Seata已在阿里云上几千家客户业务系统中使用，其可靠性得到了业内各大厂商的认可和应用。</p><p>作为一个开源项目，Seata的社区也在不断扩大，现已成为开发者交流、分享和学习的重要平台，也得到了越来越多企业的支持和关注。</p><p>今天我主要针对以下三个小议题对Seata进行分享：</p><ul><li><strong>从TXC/GTS 到 Seata</strong></li><li><strong>Seata 社区最新进展</strong></li><li><strong>Seata 社区未来规划</strong><br></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="从txcgts-到seata">从TXC/GTS 到Seata<a href="#从txcgts-到seata" class="hash-link" aria-label="Direct link to 从TXC/GTS 到Seata" title="Direct link to 从TXC/GTS 到Seata">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="分布式事务的缘起">分布式事务的缘起<a href="#分布式事务的缘起" class="hash-link" aria-label="Direct link to 分布式事务的缘起" title="Direct link to 分布式事务的缘起">​</a></h4><p><img loading="lazy" alt="产品矩阵" src="/assets/images/产品矩阵-911645846cd62c27fb3e2aaef802b52e.jpg" width="1468" height="1316" class="img_ev3q">
Seata 在阿里内部的产品代号叫TXC（taobao transaction constructor），这个名字有非常浓厚的组织架构色彩。TXC 起源于阿里五彩石项目，五彩石是上古神话中女娲补天所用的石子，项目名喻意为打破关键技术壁垒，象征着阿里在从单体架构向分布式架构的演进过程中的重要里程碑。在这个项目的过程中演进出一批划时代的互联网中间件，包括我们常说的三大件：</p><ul><li><strong>HSF 服务调用框架</strong><br>解决单体应用到服务化后的服务通信调用问题。</li><li><strong>TDDL 分库分表框架</strong><br>解决规模化后单库存储容量和连接数问题。</li><li><strong>MetaQ 消息框架</strong><br>解决异步调用问题。</li></ul><p>三大件的诞生满足了微服务化业务开发的基本需求，但是微服务化后的数据一致性问题并未得到妥善解决，缺少统一的解决方案。应用微服务化后出现数据一致性问题概率远大于单体应用，从进程内调用到网络调用这种复杂的环境加剧了异常场景的产生，服务跳数的增多使得在出现业务处理异常时无法协同上下游服务同时进行数据回滚。TXC的诞生正是为了解决应用架构层数据一致性的痛点问题，TXC 核心要解决的数据一致性场景包括：</p><ul><li><strong>跨服务的一致性。</strong> 应对系统异常如调用超时和业务异常时协调上下游服务节点回滚。</li><li><strong>分库分表的数据一致性。</strong> 应对业务层逻辑SQL操作的数据在不同数据分片上，保证其分库分表操作的内部事务。</li><li><strong>消息发送的数据一致性。</strong> 应对数据操作和消息发送成功的不一致性问题。</li></ul><p>为了克服以上通用场景遇到的问题，TXC与三大件做了无缝集成。业务使用三大件开发时，完全感知不到背后TXC的存在，业务不需要考虑数据一致性的设计问题，数据一致性保证交给了框架托管，业务更加聚焦于业务本身的开发，极大的提升了开发的效率。</p><br><p><img loading="lazy" alt="GTS架构" src="/assets/images/GTS架构-f19f670582426aaac8da0f69c1d7ae35.jpg" width="1482" height="1294" class="img_ev3q"> </p><p>TXC已在阿里集团内部广泛应用多年，经过双11等大型活动的洪荒流量洗礼，TXC极大提高了业务的开发效率，保证了数据的正确性，消除了数据不一致导致的资损和商誉问题。随着架构的不断演进，<strong>标准的三节点集群已可以承载接近10W TPS的峰值和毫秒级事务处理。在可用性和性能方面都达到了4个9的SLA保证，即使在无值守状态下也能保证全年无故障。</strong></p><br><h4 class="anchor anchorWithStickyNavbar_LWe7" id="分布式事务的演进">分布式事务的演进<a href="#分布式事务的演进" class="hash-link" aria-label="Direct link to 分布式事务的演进" title="Direct link to 分布式事务的演进">​</a></h4><p>新事物的诞生总是会伴随着质疑的声音。中间件层来保证数据一致性到底可靠吗？TXC最初的诞生只是一种模糊的理论，缺乏理论模型和工程实践。在我们进行MVP（最小可行产品）模型测试并推广业务上线后，经常出现故障，常常需要在深夜起床处理问题，睡觉时要佩戴手环来应对紧急响应，这也是我接管这个团队在技术上过的最痛苦的几年。</p><p><img loading="lazy" alt="分布式事务演进" src="/assets/images/分布式事务演进-cd118286fd5a0add7ecf5775e381a1f5.jpg" width="1488" height="702" class="img_ev3q">  </p><p>随后，我们进行了广泛的讨论和系统梳理。我们首先需要定义一致性问题，我们是要像RAFT一样实现多数共识一致性，还是要像Google Spanner一样解决数据库一致性问题，还是其他方式？从应用节点自上而下的分层结构来看，主要包括开发框架、服务调用框架、数据中间件、数据库Driver和数据库。我们需要决定在哪一层解决数据一致性问题。我们比较了解决不同层次数据一致性问题所面临的一致性要求、通用性、实现复杂度和业务接入成本。最后，我们权衡利弊，把实现复杂度留给我们，作为一个一致性组件，我们需要确保较高的一致性，但又不能锁定到具体数据库的实现上，确保场景的通用性和业务接入成本足够低以便更容易实现业务，这也是TXC最初采用AT模式的原因。</p><p><strong>分布式事务它不仅仅是一个框架，它是一个体系。</strong>  我们在理论上定义了一致性问题，概念上抽象出了模式、角色、动作和隔离性等。从工程实践的角度，我们定义了编程模型，包括低侵入的注解、简单的方法模板和灵活的API ，定义了事务的基础能力和增强能力（例如如何以低成本支持大量活动），以及运维、安全、性能、可观测性和高可用等方面的能力。</p><p><img loading="lazy" alt="事务逻辑模型" src="/assets/images/事务逻辑模型-bd13bfb9738e5aca63823d268e543280.jpg" width="1482" height="656" class="img_ev3q">
分布式事务解决了哪些问题呢？一个经典且具有体感的例子就是转账场景。转账过程包括减去余额和增加余额两个步骤，我们如何保证操作的原子性？在没有任何干预的情况下，这两个步骤可能会遇到各种问题，例如B账户已销户或出现服务调用超时等情况。</p><p><strong>超时问题一直是分布式应用中比较难解决的问题</strong>，我们无法准确知晓B服务是否执行以及其执行顺序。从数据的角度来看，这意味着B 账户的钱未必会被成功加起来。在服务化改造之后，每个节点仅获知部分信息，而事务本身需要全局协调所有节点，因此需要一个拥有上帝视角、能够获取全部信息的中心化角色，这个角色就是<strong>TC（transaction coordinator）</strong>，它用于全局协调事务的状态。<strong>TM（Transaction Manager）</strong> 则是驱动事务生成提议的角色。但是，即使上帝也有打瞌睡的时候，他的判断也并不总是正确的，因此需要一个<strong>RM（resource manager）</strong> 角色作为灵魂的代表来验证事务的真实性。这就是TXC 最基本的哲学模型。我们从方法论上验证了它的数据一致性是非常完备的，当然，我们的认知是有边界的。也许未来会证明我们是火鸡工程师，但在当前情况下，它的模型已经足以解决大部分现有问题。</p><p><img loading="lazy" alt="分布式事务性能" src="/assets/images/分布式事务性能-379ce638304757417a8ed74fe07fc69c.jpg" width="1494" height="674" class="img_ev3q">
<strong>经过多年的架构演进，从事务的单链路耗时角度来看，TXC在事务开始时的处理平均时间约为0.2毫秒，分支注册的平均时间约为0.4毫秒，整个事务额外的耗时在毫秒级别之内。这也是我们推算出的极限理论值。在吞吐量方面，单节点的TPS达到3万次/秒，标准集群的TPS接近10万次/秒。</strong></p><br>#### Seata 开源 为什么要做开源？这是很多人问过我的问题。2017年我们做了商业化的 GTS（Global Transaction Service ）产品产品在阿里云上售卖，有公有云和专有云两种形态。此时集团内发展的顺利，但是在我们商业化的过程中并不顺利，我们遇到了各种各样的问题，问题总结起来主要包括两类：**一是开发者对于分布式事务的理论相当匮乏，** 大多数人连本地事务都没搞明白是怎么回事更何况是分布式事务。 **二是产品成熟度上存在问题，** 经常遇到稀奇古怪的场景问题，导致了支持交付成本的急剧上升，研发变成了售后客服。<p>我们反思为什么遇到如此多的问题，这里主要的问题是在阿里集团内部是统一语言栈和统一技术栈的，我们对特定场景的打磨是非常成熟的，服务阿里一家公司和服务云上成千上万家企业有本质的区，这也启示我们产品的场景生态做的不够好。在GitHub 80%以上的开源软件是基础软件，基础软件首要解决的是场景通用性问题，因此它不能被有一家企业Lock In，比如像Linux，它有非常多的社区分发版本。因此，为了让我们的产品变得更好，我们选择了开源，与开发者们共建，普及更多的企业用户。</p><p><img loading="lazy" alt="阿里开源" src="/assets/images/阿里开源-b55a3c66abd52e6502162a991c8e92c3.jpg" width="1484" height="696" class="img_ev3q">
阿里的开源经历了三个主要阶段。<strong>第一个阶段是Dubbo所处的阶段，开发者用爱发电，</strong> Dubbo开源了有10几年的时间，时间充分证明了Dubbo是非常优秀的开源软件，它的微内核插件化的扩展性设计也是我最初开源Seata 的重要参考。做软件设计的时候我们要思考扩展性和性能权衡起来哪个会更重要一些，我们到底是要做一个三年的设计，五年的设计亦或是满足业务发展的十年设计。我们在做0-1服务调用问题的解决方案的同时，能否预测到1-100规模化后的治理问题。</p><p><strong>第二个阶段是开源和商业化的闭环，商业化反哺于开源社区，促进了开源社区的发展。</strong> 我认为云厂商更容易做好开源的原因如下：</p><ul><li>首先，云是一个规模化的经济，必然要建立在稳定成熟的内核基础上，在上面去包装其产品化能力包括高可用、免运维和弹性能力。不稳定的内核必然导致过高的交付支持成本，研发团队的支持答疑穿透过高，过高的交付成本无法实现大规模的复制，穿透率过高无法使产品快速的演进迭代。</li><li>其次，商业产品是更懂业务需求的。我们内部团队做技术的经常是站在研发的视角YY 需求，做出来的东西没有人使用，也就不会形成价值的转换。商业化收集到的都是真实的业务需求，因此，它的开源内核也必须会朝着这个方向演进。如果不朝着这个方向去演进必然导致两边架构上的分裂，增加团队的维护成本。</li><li>最后，开源和商业化闭环，能促进双方更好的发展。如果开源内核经常出现各种问题，你是否愿意相信的它的商业化产品是足够优秀的。</li></ul><p><strong>第三个阶段是体系化和标准化。</strong> 首先，体系化是开源解决方案的基础。阿里的开源项目大多是基于内部电商场景的实践而诞生的。例如Higress，它用于打通蚂蚁集团的网关；Nacos承载着服务的百万实例和千万连接；Sentinel 提供大促时的降级和限流等高可用性能力；而Seata负责保障交易数据的一致性。这套体系化的开源解决方案是基于阿里电商生态的最佳实践而设计的。其次，标准化是另一个重要的特点。以OpenSergo为例，它既是一个标准，又是一个实现。在过去几年里，国内开源项目数量呈爆发式增长。然而，各个开源产品的能力差异很大，彼此集成时会遇到许多兼容性问题。因此，像OpenSergo这样的开源项目能够定义一些标准化的能力和接口，并提供一些实现，这将为整个开源生态系统的发展提供极大的帮助。</p><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-社区最新进展">Seata 社区最新进展<a href="#seata-社区最新进展" class="hash-link" aria-label="Direct link to Seata 社区最新进展" title="Direct link to Seata 社区最新进展">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-社区简介">Seata 社区简介<a href="#seata-社区简介" class="hash-link" aria-label="Direct link to Seata 社区简介" title="Direct link to Seata 社区简介">​</a></h4><p><img loading="lazy" alt="社区简介" src="/assets/images/社区简介-f911410600da0ddea225d92d7a0e3e96.jpg" width="1484" height="686" class="img_ev3q">
<strong>目前，Seata已经开源了4种事务模式，包括AT、TCC、Saga和XA，并在积极探索其他可行的事务解决方案。</strong> Seata已经与10多个主流的RPC框架和关系数据库进行了集成，同时与20 多个社区存在集成和被集成的关系。此外，我们还在多语言体系上探索除Java之外的语言，如Golang、PHP、Python和JS。</p><p>Seata已经被几千家客户应用到业务系统中。Seata的应用已经变得越来越成熟，在金融业务场景中信银行和光大银行与社区做了很好的合作，并成功将其纳入到核心账务系统中。在金融场景对微服务体系的落地是非常严苛的，这也标志着Seata的内核成熟度迈上了一个新台阶。</p><br>#### Seata 扩展生态 ![扩展生态](/img/blog/扩展生态.jpg) **Seata采用了微内核和插件化的设计，它在API、注册配置中心、存储模式、锁控制、SQL解析器、负载均衡、传输、协议编解码、可观察性等方面暴露了丰富的扩展点。** 这使得业务可以方便地进行灵活的扩展和技术组件的选择。<br><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-应用案例">Seata 应用案例<a href="#seata-应用案例" class="hash-link" aria-label="Direct link to Seata 应用案例" title="Direct link to Seata 应用案例">​</a></h4><p><img loading="lazy" alt="应用案例" src="/assets/images/应用案例-be6fb71d8ac5031679b2b52a9f158f61.jpg" width="1268" height="1286" class="img_ev3q">
<strong>案例1：中航信航旅纵横项目</strong><br>
<!-- -->中航信航旅纵横项目在Seata 0.2版本中引入Seata解决机票和优惠券业务的数据一致性问题，大大提高了开发效率、减少了数据不一致造成的资损并提升了用户交互体验。</p><p><strong>案例2：滴滴出行二轮车事业部</strong><br>
<!-- -->滴滴出行二轮车事业部在Seata 0.6.1版本中引入Seata，解决了小蓝单车、电动车、资产等业务流程的数据一致性问题，优化了用户使用体验并减少了资产的损失。</p><p><strong>案例3：美团基础架构</strong><br>
<!-- -->美团基础架构团队基于开源的Seata项目开发了内部分布式事务解决方案Swan，被用于解决美团内部各业务的分布式事务问题。</p><p><strong>场景4：盒马小镇</strong><br>
<!-- -->盒马小镇在游戏互动中使用Seata控制偷花的流程，开发周期大大缩短，从20天缩短到了5天，有效降低了开发成本。</p><br><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-事务模式的演进">Seata 事务模式的演进<a href="#seata-事务模式的演进" class="hash-link" aria-label="Direct link to Seata 事务模式的演进" title="Direct link to Seata 事务模式的演进">​</a></h4><p><img loading="lazy" alt="模式演进" src="/assets/images/模式演进-ec00bf742388aa93e4aa2624f5d6fbc1.jpg" width="1492" height="574" class="img_ev3q"></p><br><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-当前进展">Seata 当前进展<a href="#seata-当前进展" class="hash-link" aria-label="Direct link to Seata 当前进展" title="Direct link to Seata 当前进展">​</a></h4><ul><li>支持 Oracle和 Postgresql 多主键。</li><li>支持 Dubbo3</li><li>支持 Spring Boot3</li><li>支持 JDK 17</li><li>支持 ARM64 镜像</li><li>支持多注册模型</li><li>扩展了多种SQL语法</li><li>支持 GraalVM Native Image</li><li>支持 Redis lua 存储模式<br></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-2x-发展规划">Seata 2.x 发展规划<a href="#seata-2x-发展规划" class="hash-link" aria-label="Direct link to Seata 2.x 发展规划" title="Direct link to Seata 2.x 发展规划">​</a></h3><p><img loading="lazy" alt="发展规划" src="/assets/images/发展规划-9b7132eb93fdaaa430a832be0142cebc.jpg" width="1476" height="678" class="img_ev3q"> </p><p>主要包括下面几个方面：</p><ul><li><strong>存储/协议/特性</strong><br>存储模式上探索存算不分离的Raft集群模式；更好的体验，统一当前4种事务模式的API；兼容GTS协议；支持Saga注解；支持分布式锁的控制；支持以数据视角的洞察和治理。</li><li><strong>生态</strong><br>融合支持更多的数据库，更多的服务框架，同时探索国产化信创生态的支持；支持MQ生态；进一步完善APM的支持。</li><li><strong>解决方案</strong><br>解决方案上除了支持微服务生态探索多云方案；更贴近云原生的解决方案；增加安全和流量防护能力；实现架构上核心组件的自闭环收敛。</li><li><strong>多语言生态</strong><br>多语言生态中Java最成熟，其他已支持的编程语言继续完善，同时探索与语言无关的Transaction Mesh方案。</li><li><strong>研发效能/体验</strong><br>提升测试的覆盖率，优先保证质量、兼容性和稳定性；重构官网文档结构，提升文档搜索的命中率；在体验上简化运维部署，实现一键安装和配置元数据简化；控制台支持事务控制和在线分析能力。
</li></ul><p>一句话总结2.x 的规划：<strong>更大的场景，更大的生态，从可用到好用。</strong></p><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-社区联系方式">Seata 社区联系方式<a href="#seata-社区联系方式" class="hash-link" aria-label="Direct link to Seata 社区联系方式" title="Direct link to Seata 社区联系方式">​</a></h3><p><img loading="lazy" alt="联系方式" src="/assets/images/联系方式-9883f643b19238bb617036df09d2731f.jpg" width="1158" height="356" class="img_ev3q"></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-08T00:00:00.000Z" itemprop="datePublished">June 8, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Seata社区</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="生产环境可用的-seata-go-120-来了">生产环境可用的 seata-go 1.2.0 来了！！！<a href="#生产环境可用的-seata-go-120-来了" class="hash-link" aria-label="Direct link to 生产环境可用的 seata-go 1.2.0 来了！！！" title="Direct link to 生产环境可用的 seata-go 1.2.0 来了！！！">​</a></h2><p>Seata 是一款开源的分布式事务解决方案，提供高性能和简单易用的分布式事务服务。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="发布概览">发布概览<a href="#发布概览" class="hash-link" aria-label="Direct link to 发布概览" title="Direct link to 发布概览">​</a></h3><p>Seata-go 1.2.0 版本支持 XA 模式。XA 协议是由 X/Open 组织提出的分布式事务处理规范，其优点是对业务代码无侵入。当前 Seata-go 的 XA 模式支持 MySQL 数据库。至此，seata-go 已经集齐 AT、TCC、Saga 和 XA 四种事务模式，完成了与 Seata Java 的功能对齐。 XA 模式的主要功能:</p><ul><li>支持了 XA 数据源代理 </li><li>支持了 XA 事务模式<br>XA 相关的 samples 可以参考示例：<a href="https://github.com/seata/seata-go-samples/tree/main/xa" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-go-samples/tree/main/xa</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature">feature：<a href="#feature" class="hash-link" aria-label="Direct link to feature：" title="Direct link to feature：">​</a></h3><ul><li>[<a href="https://github.com/seata/seata-go/pull/467" target="_blank" rel="noopener noreferrer">#467</a>] 实现 XA 模式支持 MySQL</li><li>[<a href="https://github.com/seata/seata-go/pull/534" target="_blank" rel="noopener noreferrer">#534</a>] 支持 session 的负载均衡</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bugfix">bugfix：<a href="#bugfix" class="hash-link" aria-label="Direct link to bugfix：" title="Direct link to bugfix：">​</a></h3><ul><li>[<a href="https://github.com/seata/seata-go/pull/540" target="_blank" rel="noopener noreferrer">#540</a>] 修复初始化 xa 模式的 bug</li><li>[<a href="https://github.com/seata/seata-go/pull/545" target="_blank" rel="noopener noreferrer">#545</a>] 修复 xa 模式获取 db 版本号的 bug</li><li>[<a href="https://github.com/seata/seata-go/pull/548" target="_blank" rel="noopener noreferrer">#548</a>] 修复启动 xa 会失败的 bug</li><li>[<a href="https://github.com/seata/seata-go/pull/556" target="_blank" rel="noopener noreferrer">#556</a>] 修复 xa 数据源的 bug</li><li>[<a href="https://github.com/seata/seata-go/pull/562" target="_blank" rel="noopener noreferrer">#562</a>] 修复提交 xa 全局事务的 bug</li><li>[<a href="https://github.com/seata/seata-go/pull/564" target="_blank" rel="noopener noreferrer">#564</a>] 修复提交 xa 分支事务的 bug</li><li>[<a href="https://github.com/seata/seata-go/pull/566" target="_blank" rel="noopener noreferrer">#566</a>] 修复使用 xa 数据源执行本地事务的 bug</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimize">optimize:<a href="#optimize" class="hash-link" aria-label="Direct link to optimize:" title="Direct link to optimize:">​</a></h3><ul><li>[<a href="https://github.com/seata/seata-go/pull/523" target="_blank" rel="noopener noreferrer">#523</a>] 优化 CI 流程</li><li>[<a href="https://github.com/seata/seata-go/pull/456" target="_blank" rel="noopener noreferrer">#525</a>] 将 jackson 序列化重命名为 json</li><li>[<a href="https://github.com/seata/seata-go/pull/532" target="_blank" rel="noopener noreferrer">#532</a>] 移除重复的代码</li><li>[<a href="https://github.com/seata/seata-go/pull/536" target="_blank" rel="noopener noreferrer">#536</a>] 优化 go import 代码格式</li><li>[<a href="https://github.com/seata/seata-go/pull/554" target="_blank" rel="noopener noreferrer">#554</a>] 优化 xa 模式的性能</li><li>[<a href="https://github.com/seata/seata-go/pull/561" target="_blank" rel="noopener noreferrer">#561</a>] 优化 xa 模式的日志输出</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="test">test:<a href="#test" class="hash-link" aria-label="Direct link to test:" title="Direct link to test:">​</a></h3><ul><li>[<a href="https://github.com/seata/seata-go/pull/535" target="_blank" rel="noopener noreferrer">#535</a>] 添加集成测试</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="doc">doc:<a href="#doc" class="hash-link" aria-label="Direct link to doc:" title="Direct link to doc:">​</a></h3><ul><li>[<a href="https://github.com/seata/seata-go/pull/550" target="_blank" rel="noopener noreferrer">#550</a>] 添加 1.2.0 版本的改动日志</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="contributors">contributors:<a href="#contributors" class="hash-link" aria-label="Direct link to contributors:" title="Direct link to contributors:">​</a></h3><p>Thanks to these contributors for their code commits. Please report an unintended omission.</p><ul><li><a href="https://github.com/georgehao" target="_blank" rel="noopener noreferrer">georgehao</a></li><li><a href="https://github.com/luky116" target="_blank" rel="noopener noreferrer">luky116</a></li><li><a href="https://github.com/jasondeng1997" target="_blank" rel="noopener noreferrer">jasondeng1997</a></li><li><a href="https://github.com/106umao" target="_blank" rel="noopener noreferrer">106umao</a></li><li><a href="https://github.com/wang1309" target="_blank" rel="noopener noreferrer">wang1309</a></li><li><a href="https://github.com/iSuperCoder" target="_blank" rel="noopener noreferrer">iSuperCoder</a></li><li><a href="https://github.com/Charlie17Li" target="_blank" rel="noopener noreferrer">Charlie17Li</a></li><li><a href="https://github.com/Code-Fight" target="_blank" rel="noopener noreferrer">Code-Fight</a></li><li><a href="https://github.com/Kirhaku" target="_blank" rel="noopener noreferrer">Kirhaku</a></li><li><a href="https://github.com/VaderKai" target="_blank" rel="noopener noreferrer">Vaderkai</a></li></ul><p>同时，我们收到了社区反馈的很多有价值的issue和建议，非常感谢大家。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="link">Link<a href="#link" class="hash-link" aria-label="Direct link to Link" title="Direct link to Link">​</a></h4><ul><li><a href="http://github.com/seata/seata" target="_blank" rel="noopener noreferrer">http://github.com/seata/seata</a></li><li><a href="https://github.com/seata/seata-php" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-php</a></li><li><a href="https://github.com/seata/seata-js" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-js</a></li><li><a href="https://github.com/seata/seata-go" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-go</a><br><strong>Samples：</strong></li><li><a href="https://github.com/seata/seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-samples</a></li><li><a href="https://github.com/seata/seata-go-samples" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-go-samples</a><br><strong>官网：</strong>   </li><li><a href="https://seata.io/" target="_blank" rel="noopener noreferrer">https://seata.io/</a></li></ul></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-05-12T00:00:00.000Z" itemprop="datePublished">May 12, 2023</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Seata社区</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="欢迎大家报名seata-开源之夏2023课题">欢迎大家报名Seata 开源之夏2023课题<a href="#欢迎大家报名seata-开源之夏2023课题" class="hash-link" aria-label="Direct link to 欢迎大家报名Seata 开源之夏2023课题" title="Direct link to 欢迎大家报名Seata 开源之夏2023课题">​</a></h3><p>开源之夏 2023 学生报名期为 <strong>4 月 29 日-6月4日</strong>，欢迎报名Seata 2023 课题！在这里，您将有机会深入探讨分布式事务的理论和应用，并与来自不同背景的同学一起合作完成实践项目。我们期待着您的积极参与和贡献，共同推动分布式事务领域的发展。</p><p><img loading="lazy" alt="summer2023-1" src="/assets/images/summer2023-1-354d728bacb1640f84811b82ac954a9d.jpg" width="1290" height="2796" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="开源之夏2023">开源之夏2023<a href="#开源之夏2023" class="hash-link" aria-label="Direct link to 开源之夏2023" title="Direct link to 开源之夏2023">​</a></h3><p>开源之夏是由中科院软件所“开源软件供应链点亮计划”发起并长期支持的一项暑期开源活动，旨在鼓励在校学生积极参与开源软件的开发维护，培养和发掘更多优秀的开发者，促进优秀开源软件社区的蓬勃发展，助力开源软件供应链建设。</p><p>参与学生通过远程线上协作方式，配有资深导师指导，参与到开源社区各组织项目开发中并收获奖金、礼品与证书。<strong>这些收获，不仅仅是未来毕业简历上浓墨重彩的一笔，更是迈向顶尖开发者的闪亮起点，可以说非常值得一试。</strong>  每个项目难度分为基础和进阶两档，对应学生结项奖金分别为税前人民币 8000 元和税前人民币 12000 元。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata社区介绍">Seata社区介绍<a href="#seata社区介绍" class="hash-link" aria-label="Direct link to Seata社区介绍" title="Direct link to Seata社区介绍">​</a></h3><p><strong>Seata</strong> 是一款开源的分布式事务解决方案，GitHub获得超过23K+ Starts致力于在微服务架构下提供高性能和简单易用的分布式事务服务。在 Seata 开源之前，Seata 在阿里内部一直扮演着分布式数据一致性的中间件角色，几乎每笔交易都要使用Seata，历经双11洪荒流量的洗礼，对业务进行了有力的技术支撑。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata社区开源之夏2023项目课题汇总">Seata社区开源之夏2023项目课题汇总<a href="#seata社区开源之夏2023项目课题汇总" class="hash-link" aria-label="Direct link to Seata社区开源之夏2023项目课题汇总" title="Direct link to Seata社区开源之夏2023项目课题汇总">​</a></h3><p>Seata社区为开源之夏2023组委会推荐6项精选项目课题，您可以访问以下链接进行选报：<br>
<a href="https://summer-ospp.ac.cn/org/orgdetail/064c15df-705c-483a-8fc8-02831370db14?lang=zh" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/orgdetail/064c15df-705c-483a-8fc8-02831370db14?lang=zh</a><br>
<!-- -->请及时与各导师沟通并准备项目申请材料，并登录官方注册申报（以下课题顺序不分先后）：
<img loading="lazy" alt="seata2023-2" src="/assets/images/summer2023-2-cff41105a59822fdd5e8d88d84ad0e2a.png" width="706" height="271" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="项目一-实现用于服务发现和注册的namingserver">项目一: 实现用于服务发现和注册的NamingServer<a href="#项目一-实现用于服务发现和注册的namingserver" class="hash-link" aria-label="Direct link to 项目一: 实现用于服务发现和注册的NamingServer" title="Direct link to 项目一: 实现用于服务发现和注册的NamingServer">​</a></h4><p><strong>难度：</strong> 进阶/Advanced</p><p><strong>项目社区导师：</strong> 陈健斌</p><p><strong>导师联系邮箱：</strong> <a href="mailto:364176773@qq.com" target="_blank" rel="noopener noreferrer">364176773@qq.com</a></p><p><strong>项目简述：</strong><br>
<!-- -->目前seata的服务暴露及发现主要依赖于第三方注册中心，随着项目的演进发展，带来了额外的学习使用成本，而业内主流具有服务端的中间件大多都开始演进自身的服务自闭环和控制及提供于服务端更高契合度和可靠性的组件或功能如kafka 的KRaft，rocketmq的NameServer，clickhouse的ClickHouse Keeper等.故为了解决如上问题和架构演进要求,seata需要构建自身的nameserver来保证更加稳定可靠。</p><p><strong>项目链接：</strong>
<a href="https://summer-ospp.ac.cn/org/prodetail/230640380?list=org&amp;navpage=org" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/prodetail/230640380?list=org&amp;navpage=org</a></p><br><br><h4 class="anchor anchorWithStickyNavbar_LWe7" id="项目二-在seata-go中实现saga事务模式">项目二: 在seata-go中实现saga事务模式<a href="#项目二-在seata-go中实现saga事务模式" class="hash-link" aria-label="Direct link to 项目二: 在seata-go中实现saga事务模式" title="Direct link to 项目二: 在seata-go中实现saga事务模式">​</a></h4><p><strong>难度：</strong> 进阶/Advanced</p><p><strong>项目社区导师：</strong> 刘月财</p><p><strong>导师联系邮箱：</strong> <a href="mailto:luky116@apache.org" target="_blank" rel="noopener noreferrer">luky116@apache.org</a></p><p><strong>项目简述：</strong>
Saga模式是SEATA提供的长事务解决方案，在Saga模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者，一阶段正向服务和二阶段补偿服务都由业务开发实现。Seata-go 中当前没有支持saga模式，希望后面参考Java版本的实现能将该功能支持上。</p><p><strong>项目链接：</strong>
<a href="https://summer-ospp.ac.cn/org/prodetail/230640382?list=org&amp;navpage=org" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/prodetail/230640382?list=org&amp;navpage=org</a></p><br><br><h4 class="anchor anchorWithStickyNavbar_LWe7" id="项目三-seata-saga模式产品化能力提升">项目三: seata saga模式产品化能力提升<a href="#项目三-seata-saga模式产品化能力提升" class="hash-link" aria-label="Direct link to 项目三: seata saga模式产品化能力提升" title="Direct link to 项目三: seata saga模式产品化能力提升">​</a></h4><p><strong>难度：</strong> 进阶/Advanced</p><p><strong>项目社区导师：</strong> 李宗杰</p><p><strong>导师联系邮箱：</strong> <a href="mailto:leezongjie@163.com" target="_blank" rel="noopener noreferrer">leezongjie@163.com</a></p><p><strong>项目简述：</strong>
saga作为分布式事务的解决方案之一，在长事务上应用尤其广泛，seata也提供了对应的状态机实现。随着业务的不断发展和接入，对seata提出了更高的要求，我们需要支持流式saga 编排，对当前状态机的实现进行优化和扩展，进一步服务业务。</p><p><strong>项目链接：</strong>
<a href="https://summer-ospp.ac.cn/org/prodetail/230640415?list=org&amp;navpage=org" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/prodetail/230640415?list=org&amp;navpage=org</a></p><br><br><h4 class="anchor anchorWithStickyNavbar_LWe7" id="项目四--增加控制台事务控制能力">项目四:  增加控制台事务控制能力<a href="#项目四--增加控制台事务控制能力" class="hash-link" aria-label="Direct link to 项目四:  增加控制台事务控制能力" title="Direct link to 项目四:  增加控制台事务控制能力">​</a></h4><p><strong>难度：</strong> 进阶/Advanced</p><p><strong>项目社区导师：</strong> 王良</p><p><strong>导师联系邮箱：</strong> <a href="mailto:841369634@qq.com" target="_blank" rel="noopener noreferrer">841369634@qq.com</a></p><p><strong>项目简述：</strong>
在分布式事务中，经常会存在非常多的异常情况，这些异常情况往往会导致系统无法继续运行。而这些异常往往需要人工介入排查原因并排除故障，才能够使系统继续正常运行。虽然seata 提供了控制台查询事务数据，但还未提供任何事务控制能力，帮助排除故障。所以，本课题主要是在seata服务端控制台上，添加事务控制能力。</p><p><strong>项目链接：</strong>
<a href="https://summer-ospp.ac.cn/org/prodetail/230640423?list=org&amp;navpage=org" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/prodetail/230640423?list=org&amp;navpage=org</a></p><br><br><h4 class="anchor anchorWithStickyNavbar_LWe7" id="项目五--提高单测覆盖率和建立集成测试">项目五:  提高单测覆盖率和建立集成测试<a href="#项目五--提高单测覆盖率和建立集成测试" class="hash-link" aria-label="Direct link to 项目五:  提高单测覆盖率和建立集成测试" title="Direct link to 项目五:  提高单测覆盖率和建立集成测试">​</a></h4><p><strong>难度：</strong> 基础/Basic</p><p><strong>项目社区导师：</strong> 张嘉伟</p><p><strong>导师联系邮箱：</strong> <a href="mailto:349071347@qq.com" target="_blank" rel="noopener noreferrer">349071347@qq.com</a></p><p><strong>项目简述：</strong>
为了进一步提高项目的质量以及稳定性, 需要进一步提升项目单元测试覆盖率以及加入集成测试来模拟生产中不同的场景. 集成测试的目的是为了模拟client与server的交互过程, 而非单一的对某个接口进行测试。</p><p><strong>项目链接：</strong>
<a href="https://summer-ospp.ac.cn/org/prodetail/230640424?list=org&amp;navpage=org" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/prodetail/230640424?list=org&amp;navpage=org</a></p><br><br><h4 class="anchor anchorWithStickyNavbar_LWe7" id="项目六-实现seata运维ctl工具">项目六: 实现Seata运维ctl工具<a href="#项目六-实现seata运维ctl工具" class="hash-link" aria-label="Direct link to 项目六: 实现Seata运维ctl工具" title="Direct link to 项目六: 实现Seata运维ctl工具">​</a></h4><p><strong>难度：</strong> 进阶/Advanced</p><p><strong>项目社区导师：</strong> 季敏</p><p><strong>导师联系邮箱：</strong>  <a href="mailto:jimin.jm@alibaba-inc.com" target="_blank" rel="noopener noreferrer">jimin.jm@alibaba-inc.com</a></p><p><strong>项目简述：</strong> 运维ctl命令在Seata中非常重要，它是Seata的命令行工具，可以帮助我们管理和操作Seata的各种组件。运维ctl命令可以让我们快速地启动、停止和管理Seata服务，定位和解决问题。此外，运维ctl 命令还提供了丰富的指令，可以让我们方便地检查Seata的健康状态、模拟事务和打印导出配置信息等，大大提高了我们的工作效率和运维体验。</p><p>以下是对实现定制ctl运维命令行的一些建议： </p><ul><li>借鉴其他开源项目的实现方式，比如kubectl，helm等，并根据Seata的特点和需求进行定制。</li><li>将常用的运维操作直接封装进命令行，减少用户的手动操作。</li><li>考虑使用友好的命令和参数名称，将命令行设计得易于理解和记忆。</li><li>提供详细的帮助文档和示例，帮助用户快速上手和了解如何使用各种参数和选项。</li><li>考虑命令行的跨平台支持，例如支持Windows、Linux和MacOS等操作系统。
一款好的ctl命令行应该是易用、灵活、可定制、健壮和易维护的。</li></ul><p>项目链接：<a href="https://summer-ospp.ac.cn/org/prodetail/230640431?list=org&amp;navpage=org" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/prodetail/230640431?list=org&amp;navpage=org</a></p><br><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何参与开源之夏2023并快速选定项目">如何参与开源之夏2023并快速选定项目？<a href="#如何参与开源之夏2023并快速选定项目" class="hash-link" aria-label="Direct link to 如何参与开源之夏2023并快速选定项目？" title="Direct link to 如何参与开源之夏2023并快速选定项目？">​</a></h3><p><strong>欢迎通过上方联系方式，与各导师沟通并准备项目申请材料。</strong></p><p>课题参与期间，学生可以在世界任何地方线上工作，Seata相关项目结项需要在<strong>9月30日</strong>前以 PR 的形式提交到Seata社区仓库中并完成合并，请务必尽早准备。
<img loading="lazy" alt="seata2023-3" src="/assets/images/summer2023-3-9b3b418ef64bd3c1afb2782d17af315a.png" width="1080" height="471" class="img_ev3q"></p><p><strong>需要在课题期间第一时间获取导师及其他信息,可扫码进入钉钉群交流</strong> ——了解Seata社区各领域项目、结识Seata社区开源导师，以助力后续申请。</p><br><img loading="lazy" src="/img/blog/summer2023-4.jpg" height="290" width="250" class="img_ev3q"><br><h4 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料：<a href="#参考资料" class="hash-link" aria-label="Direct link to 参考资料：" title="Direct link to 参考资料：">​</a></h4><p><strong>Seata网站 :</strong>  <a href="https://seata.io/" target="_blank" rel="noopener noreferrer">https://seata.io/</a></p><p><strong>Seata GitHub :</strong> <a href="https://github.com/seata" target="_blank" rel="noopener noreferrer">https://github.com/seata</a></p><p><strong>开源之夏官网：</strong> <a href="https://summer-ospp.ac.cn/org/orgdetail/ab188e59-fab8-468f-bc89-bdc2bd8b5e64?lang=zh" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/orgdetail/ab188e59-fab8-468f-bc89-bdc2bd8b5e64?lang=zh</a></p><p>如果同学们对微服务其他领域项目感兴趣，也可以尝试申请，例如：</p><ul><li>对于<strong>微服务配置注册中心</strong>有兴趣的同学，可以尝试填报<a href="https://nacos.io/zh-cn/blog/iscas2023.html" target="_blank" rel="noopener noreferrer">Nacos 开源之夏</a>；</li><li>对于<strong>微服务框架和RPC框架</strong>有兴趣的同学，可以尝试填报<a href="https://summer-ospp.ac.cn/org/orgdetail/41d68399-ed48-4d6d-9d4d-3ff4128dc132?lang=zh" target="_blank" rel="noopener noreferrer">Spring Cloud Alibaba 开源之夏</a> 和 <a href="https://summer-ospp.ac.cn/org/orgdetail/a7f6e2ad-4acc-47f8-9471-4e54b9a166a6?lang=zh" target="_blank" rel="noopener noreferrer">Dubbo 开源之夏</a> ；</li><li>对于<strong>云原生网关</strong>有兴趣的同学，可以尝试填报<a href="https://higress.io/zh-cn/blog/ospp-2023" target="_blank" rel="noopener noreferrer">Higress 开源之夏</a>；</li><li>对于<strong>分布式高可用防护</strong>有兴趣的同学，可以尝试填报 <!-- -->[Sentinel 开源之夏]<!-- -->(<a href="https://summer-ospp.ac." target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.</a> cn/org/orgdetail/5e879522-bd90-4a8b-bf8b-b11aea48626b?lang=zh) ；</li><li>对于<strong>微服务治理</strong>有兴趣的同学，可以尝试填报  <!-- -->[OpenSergo 开源之夏]<!-- -->(<a href="https://summer-ospp.ac." target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.</a> cn/org/orgdetail/aaff4eec-11b1-4375-997d-5eea8f51762b?lang=zh)。</li></ul></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-12-17T00:00:00.000Z" itemprop="datePublished">December 17, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Seata社区</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-160-重磅发布大幅提升性能">Seata 1.6.0 重磅发布，大幅提升性能<a href="#seata-160-重磅发布大幅提升性能" class="hash-link" aria-label="Direct link to Seata 1.6.0 重磅发布，大幅提升性能" title="Direct link to Seata 1.6.0 重磅发布，大幅提升性能">​</a></h3><p>Seata 是一款开源的分布式事务解决方案，提供高性能和简单易用的分布式事务服务。</p><p><strong>seata-server 下载链接：</strong></p><p><a href="https://github.com/seata/seata/archive/v1.6.0.zip" target="_blank" rel="noopener noreferrer">source</a> |
<a href="https://github.com/seata/seata/releases/download/v1.6.0/seata-server-1.6.0.zip" target="_blank" rel="noopener noreferrer">binary</a></p><p>此版本更新如下：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature">feature：<a href="#feature" class="hash-link" aria-label="Direct link to feature：" title="Direct link to feature：">​</a></h3><ul><li>[<a href="https://github.com/seata/seata/pull/4863" target="_blank" rel="noopener noreferrer">#4863</a>] 支持 oracle 和 postgresql 多主键</li><li>[<a href="https://github.com/seata/seata/pull/4649" target="_blank" rel="noopener noreferrer">#4649</a>] seata-server支持多注册中心</li><li>[<a href="https://github.com/seata/seata/pull/4779" target="_blank" rel="noopener noreferrer">#4779</a>] 支持 Apache Dubbo3</li><li>[<a href="https://github.com/seata/seata/pull/4479" target="_blank" rel="noopener noreferrer">#4479</a>] TCC注解支持添加在接口和实现类上</li><li>[<a href="https://github.com/seata/seata/pull/4877" target="_blank" rel="noopener noreferrer">#4877</a>] client sdk 支持jdk17</li><li>[<a href="https://github.com/seata/seata/pull/4914" target="_blank" rel="noopener noreferrer">#4914</a>] 支持 mysql 的update join联表更新语法</li><li>[<a href="https://github.com/seata/seata/pull/4542" target="_blank" rel="noopener noreferrer">#4542</a>] 支持 oracle timestamp 类型</li><li>[<a href="https://github.com/seata/seata/pull/5111" target="_blank" rel="noopener noreferrer">#5111</a>] 支持Nacos contextPath 配置</li><li>[<a href="https://github.com/seata/seata/pull/4802" target="_blank" rel="noopener noreferrer">#4802</a>] dockerfile 支持 arm64</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bugfix">bugfix：<a href="#bugfix" class="hash-link" aria-label="Direct link to bugfix：" title="Direct link to bugfix：">​</a></h3><ul><li>[<a href="https://github.com/seata/seata/pull/4780" target="_blank" rel="noopener noreferrer">#4780</a>] 修复超时回滚成功后无法发送TimeoutRollbacked事件</li><li>[<a href="https://github.com/seata/seata/pull/4954" target="_blank" rel="noopener noreferrer">#4954</a>] 修复output表达式错误时，保存执行结果空指针异常</li><li>[<a href="https://github.com/seata/seata/pull/4817" target="_blank" rel="noopener noreferrer">#4817</a>] 修复高版本springboot配置不标准的问题</li><li>[<a href="https://github.com/seata/seata/pull/4838" target="_blank" rel="noopener noreferrer">#4838</a>] 修复使用 Statement.executeBatch() 时无法生成undo log 的问题</li><li>[<a href="https://github.com/seata/seata/pull/4533" target="_blank" rel="noopener noreferrer">#4533</a>] 修复handleRetryRollbacking的event重复导致的指标数据不准确</li><li>[<a href="https://github.com/seata/seata/pull/4912" target="_blank" rel="noopener noreferrer">#4912</a>] 修复mysql InsertOnDuplicateUpdate 列名大小写不一致无法正确匹配</li><li>[<a href="https://github.com/seata/seata/pull/4543" target="_blank" rel="noopener noreferrer">#4543</a>] 修复对 Oracle 数据类型nclob的支持</li><li>[<a href="https://github.com/seata/seata/pull/4915" target="_blank" rel="noopener noreferrer">#4915</a>] 修复获取不到ServerRecoveryProperties属性的问题</li><li>[<a href="https://github.com/seata/seata/pull/4919" target="_blank" rel="noopener noreferrer">#4919</a>] 修复XID的port和address出现null:0的情况</li><li>[<a href="https://github.com/seata/seata/pull/4928" target="_blank" rel="noopener noreferrer">#4928</a>] 修复 rpcContext.getClientRMHolderMap NPE 问题</li><li>[<a href="https://github.com/seata/seata/pull/4953" target="_blank" rel="noopener noreferrer">#4953</a>] 修复InsertOnDuplicateUpdate可绕过修改主键的问题</li><li>[<a href="https://github.com/seata/seata/pull/4978" target="_blank" rel="noopener noreferrer">#4978</a>] 修复 kryo 支持循环依赖</li><li>[<a href="https://github.com/seata/seata/pull/4985" target="_blank" rel="noopener noreferrer">#4985</a>] 修复 undo_log id重复的问题</li><li>[<a href="https://github.com/seata/seata/pull/4874" target="_blank" rel="noopener noreferrer">#4874</a>] 修复OpenJDK 11 启动失败</li><li>[<a href="https://github.com/seata/seata/pull/5018" target="_blank" rel="noopener noreferrer">#5018</a>] 修复启动脚本中 loader path 使用相对路径导致 server 启动失败问题</li><li>[<a href="https://github.com/seata/seata/pull/5004" target="_blank" rel="noopener noreferrer">#5004</a>] 修复mysql update join行数据重复的问题</li><li>[<a href="https://github.com/seata/seata/pull/5032" target="_blank" rel="noopener noreferrer">#5032</a>] 修复mysql InsertOnDuplicateUpdate中条件参数填充位置计算错误导致的镜像查询SQL语句异常问题</li><li>[<a href="https://github.com/seata/seata/pull/5033" target="_blank" rel="noopener noreferrer">#5033</a>] 修复InsertOnDuplicateUpdate的SQL语句中无插入列字段导致的空指针问题</li><li>[<a href="https://github.com/seata/seata/pull/5038" target="_blank" rel="noopener noreferrer">#5038</a>] 修复SagaAsyncThreadPoolProperties冲突问题</li><li>[<a href="https://github.com/seata/seata/pull/5050" target="_blank" rel="noopener noreferrer">#5050</a>] 修复Saga模式下全局状态未正确更改成Committed问题</li><li>[<a href="https://github.com/seata/seata/pull/5052" target="_blank" rel="noopener noreferrer">#5052</a>] 修复update join条件中占位符参数问题</li><li>[<a href="https://github.com/seata/seata/pull/5031" target="_blank" rel="noopener noreferrer">#5031</a>] 修复InsertOnDuplicateUpdate中不应该使用null值索引作为查询条件</li><li>[<a href="https://github.com/seata/seata/pull/5075" target="_blank" rel="noopener noreferrer">#5075</a>] 修复InsertOnDuplicateUpdate无法拦截无主键和唯一索引的SQL</li><li>[<a href="https://github.com/seata/seata/pull/5093" target="_blank" rel="noopener noreferrer">#5093</a>] 修复seata server重启后accessKey丢失问题</li><li>[<a href="https://github.com/seata/seata/pull/5092" target="_blank" rel="noopener noreferrer">#5092</a>] 修复当seata and jpa共同使用时, AutoConfiguration的顺序不正确的问题</li><li>[<a href="https://github.com/seata/seata/pull/5109" target="_blank" rel="noopener noreferrer">#5109</a>] 修复当RM侧没有加@GlobalTransactional报NPE的问题</li><li>[<a href="https://github.com/seata/seata/pull/5098" target="_blank" rel="noopener noreferrer">#5098</a>] Druid 禁用 oracle implicit cache</li><li>[<a href="https://github.com/seata/seata/pull/4860" target="_blank" rel="noopener noreferrer">#4860</a>] 修复metrics tag覆盖问题</li><li>[<a href="https://github.com/seata/seata/pull/5028" target="_blank" rel="noopener noreferrer">#5028</a>] 修复 insert on duplicate SQL中 null 值问题</li><li>[<a href="https://github.com/seata/seata/pull/5078" target="_blank" rel="noopener noreferrer">#5078</a>] 修复SQL语句中无主键和唯一键拦截问题</li><li>[<a href="https://github.com/seata/seata/pull/5097" target="_blank" rel="noopener noreferrer">#5097</a>] 修复当Server重启时 accessKey 丢失问题</li><li>[<a href="https://github.com/seata/seata/pull/5131" target="_blank" rel="noopener noreferrer">#5131</a>] 修复XAConn处于active状态时无法回滚的问题</li><li>[<a href="https://github.com/seata/seata/pull/5134" target="_blank" rel="noopener noreferrer">#5134</a>] 修复hikariDataSource 自动代理在某些情况下失效的问题</li><li>[<a href="https://github.com/seata/seata/pull/5163" target="_blank" rel="noopener noreferrer">#5163</a>] 修复高版本JDK编译失败的问题</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimize">optimize：<a href="#optimize" class="hash-link" aria-label="Direct link to optimize：" title="Direct link to optimize：">​</a></h3><ul><li>[<a href="https://github.com/seata/seata/pull/4681" target="_blank" rel="noopener noreferrer">#4681</a>] 优化竞争锁过程</li><li>[<a href="https://github.com/seata/seata/pull/4774" target="_blank" rel="noopener noreferrer">#4774</a>] 优化 seataio/seata-server 镜像中的 mysql8 依赖</li><li>[<a href="https://github.com/seata/seata/pull/4750" target="_blank" rel="noopener noreferrer">#4750</a>] 优化AT分支释放全局锁不使用xid</li><li>[<a href="https://github.com/seata/seata/pull/4790" target="_blank" rel="noopener noreferrer">#4790</a>] 添加自动发布 OSSRH github action</li><li>[<a href="https://github.com/seata/seata/pull/4765" target="_blank" rel="noopener noreferrer">#4765</a>] mysql8.0.29版本及以上XA模式不持connection至二阶段</li><li>[<a href="https://github.com/seata/seata/pull/4797" target="_blank" rel="noopener noreferrer">#4797</a>] 优化所有github actions脚本</li><li>[<a href="https://github.com/seata/seata/pull/4800" target="_blank" rel="noopener noreferrer">#4800</a>] 添加 NOTICE 文件</li><li>[<a href="https://github.com/seata/seata/pull/4761" target="_blank" rel="noopener noreferrer">#4761</a>] 使用 hget 代替 RedisLocker 中的 hmget</li><li>[<a href="https://github.com/seata/seata/pull/4414" target="_blank" rel="noopener noreferrer">#4414</a>] 移除log4j依赖</li><li>[<a href="https://github.com/seata/seata/pull/4836" target="_blank" rel="noopener noreferrer">#4836</a>] 优化 BaseTransactionalExecutor#buildLockKey(TableRecords rowsIncludingPK) 方法可读性</li><li>[<a href="https://github.com/seata/seata/pull/4865" target="_blank" rel="noopener noreferrer">#4865</a>] 修复 Saga 可视化设计器 GGEditor 安全漏洞</li><li>[<a href="https://github.com/seata/seata/pull/4590" target="_blank" rel="noopener noreferrer">#4590</a>] 自动降级支持开关支持动态配置</li><li>[<a href="https://github.com/seata/seata/pull/4490" target="_blank" rel="noopener noreferrer">#4490</a>] tccfence 记录表优化成按索引删除</li><li>[<a href="https://github.com/seata/seata/pull/4911" target="_blank" rel="noopener noreferrer">#4911</a>] 添加 header 和license 检测</li><li>[<a href="https://github.com/seata/seata/pull/4917" target="_blank" rel="noopener noreferrer">#4917</a>] 升级 package-lock.json 修复漏洞</li><li>[<a href="https://github.com/seata/seata/pull/4924" target="_blank" rel="noopener noreferrer">#4924</a>] 优化 pom 依赖</li><li>[<a href="https://github.com/seata/seata/pull/4932" target="_blank" rel="noopener noreferrer">#4932</a>] 抽取部分配置的默认值</li><li>[<a href="https://github.com/seata/seata/pull/4925" target="_blank" rel="noopener noreferrer">#4925</a>] 优化 javadoc 注释</li><li>[<a href="https://github.com/seata/seata/pull/4921" target="_blank" rel="noopener noreferrer">#4921</a>] 修复控制台模块安全漏洞和升级 skywalking-eyes 版本</li><li>[<a href="https://github.com/seata/seata/pull/4936" target="_blank" rel="noopener noreferrer">#4936</a>] 优化存储配置的读取</li><li>[<a href="https://github.com/seata/seata/pull/4946" target="_blank" rel="noopener noreferrer">#4946</a>] 将获取锁时遇到的sql异常传递给客户端</li><li>[<a href="https://github.com/seata/seata/pull/4962" target="_blank" rel="noopener noreferrer">#4962</a>] 优化构建配置，并修正docker镜像的基础镜像</li><li>[<a href="https://github.com/seata/seata/pull/4974" target="_blank" rel="noopener noreferrer">#4974</a>] 取消redis模式下,查询globalStatus数量的限制</li><li>[<a href="https://github.com/seata/seata/pull/4981" target="_blank" rel="noopener noreferrer">#4981</a>] 优化当tcc fence记录查不到时的错误提示</li><li>[<a href="https://github.com/seata/seata/pull/4995" target="_blank" rel="noopener noreferrer">#4995</a>] 修复mysql InsertOnDuplicateUpdate后置镜像查询SQL中重复的主键查询条件</li><li>[<a href="https://github.com/seata/seata/pull/5047" target="_blank" rel="noopener noreferrer">#5047</a>] 移除无用代码</li><li>[<a href="https://github.com/seata/seata/pull/5051" target="_blank" rel="noopener noreferrer">#5051</a>] 回滚时undolog产生脏写需要抛出不再重试(BranchRollbackFailed_Unretriable)的异常</li><li>[<a href="https://github.com/seata/seata/pull/5075" target="_blank" rel="noopener noreferrer">#5075</a>] 拦截没有主键及唯一索引值的insert on duplicate update语句</li><li>[<a href="https://github.com/seata/seata/pull/5104" target="_blank" rel="noopener noreferrer">#5104</a>] ConnectionProxy脱离对druid的依赖</li><li>[<a href="https://github.com/seata/seata/pull/5124" target="_blank" rel="noopener noreferrer">#5124</a>] 支持oracle删除TCC fence记录表</li><li>[<a href="https://github.com/seata/seata/pull/4968" target="_blank" rel="noopener noreferrer">#4468</a>] 支持kryo 5.3.0</li><li>[<a href="https://github.com/seata/seata/pull/4807" target="_blank" rel="noopener noreferrer">#4807</a>] 优化镜像和OSS仓库发布流水线</li><li>[<a href="https://github.com/seata/seata/pull/4445" target="_blank" rel="noopener noreferrer">#4445</a>] 优化事务超时判断</li><li>[<a href="https://github.com/seata/seata/pull/4958" target="_blank" rel="noopener noreferrer">#4958</a>] 优化超时事务 triggerAfterCommit() 的执行</li><li>[<a href="https://github.com/seata/seata/pull/4582" target="_blank" rel="noopener noreferrer">#4582</a>] 优化redis存储模式的事务排序</li><li>[<a href="https://github.com/seata/seata/pull/4963" target="_blank" rel="noopener noreferrer">#4963</a>] 增加 ARM64 流水线 CI 测试</li><li>[<a href="https://github.com/seata/seata/pull/4434" target="_blank" rel="noopener noreferrer">#4434</a>] 移除 seata-server CMS GC 参数</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="test">test：<a href="#test" class="hash-link" aria-label="Direct link to test：" title="Direct link to test：">​</a></h3><ul><li>[<a href="https://github.com/seata/seata/pull/4411" target="_blank" rel="noopener noreferrer">#4411</a>] 测试Oracle数据库AT模式下类型支持</li><li>[<a href="https://github.com/seata/seata/pull/4794" target="_blank" rel="noopener noreferrer">#4794</a>] 重构代码，尝试修复单元测试 <code>DataSourceProxyTest.getResourceIdTest()</code></li><li>[<a href="https://github.com/seata/seata/pull/5101" target="_blank" rel="noopener noreferrer">#5101</a>] 修复zk注册和配置中心报ClassNotFoundException的问题 <code>DataSourceProxyTest.getResourceIdTest()</code></li></ul><p>非常感谢以下 contributors 的代码贡献。若有无意遗漏，请报告。</p><ul><li><a href="https://github.com/slievrly" target="_blank" rel="noopener noreferrer">slievrly</a></li><li><a href="https://github.com/renliangyu857" target="_blank" rel="noopener noreferrer">renliangyu857</a></li><li><a href="https://github.com/wangliang181230" target="_blank" rel="noopener noreferrer">wangliang181230</a></li><li><a href="https://github.com/a364176773" target="_blank" rel="noopener noreferrer">a364176773</a></li><li><a href="https://github.com/tuwenlin" target="_blank" rel="noopener noreferrer">tuwenlin</a></li><li><a href="https://github.com/conghuhu" target="_blank" rel="noopener noreferrer">conghuhu</a></li><li><a href="https://github.com/a1104321118" target="_blank" rel="noopener noreferrer">a1104321118</a></li><li><a href="https://github.com/duanqiaoyanyu" target="_blank" rel="noopener noreferrer">duanqiaoyanyu</a></li><li><a href="https://github.com/robynron" target="_blank" rel="noopener noreferrer">robynron</a></li><li><a href="https://github.com/lcmvs" target="_blank" rel="noopener noreferrer">lcmvs</a></li><li><a href="https://github.com/github-ganyu" target="_blank" rel="noopener noreferrer">github-ganyu</a></li><li><a href="https://github.com/1181954449" target="_blank" rel="noopener noreferrer">1181954449</a></li><li><a href="https://github.com/zw201913" target="_blank" rel="noopener noreferrer">zw201913</a></li><li><a href="https://github.com/wingchi-leung" target="_blank" rel="noopener noreferrer">wingchi-leung</a></li><li><a href="https://github.com/AlexStocks" target="_blank" rel="noopener noreferrer">AlexStocks</a></li><li><a href="https://github.com/liujunlin5168" target="_blank" rel="noopener noreferrer">liujunlin5168</a></li><li><a href="https://github.com/pengten" target="_blank" rel="noopener noreferrer">pengten</a></li><li><a href="https://github.com/liuqiufeng" target="_blank" rel="noopener noreferrer">liuqiufeng</a></li><li><a href="https://github.com/yujianfei1986" target="_blank" rel="noopener noreferrer">yujianfei1986</a></li><li><a href="https://github.com/Bughue" target="_blank" rel="noopener noreferrer">Bughue</a></li><li><a href="https://github.com/AlbumenJ" target="_blank" rel="noopener noreferrer">AlbumenJ</a></li><li><a href="https://github.com/doubleDimple" target="_blank" rel="noopener noreferrer">doubleDimple</a></li><li><a href="https://github.com/jsbxyyx" target="_blank" rel="noopener noreferrer">jsbxyyx</a></li><li><a href="https://github.com/tuwenlin" target="_blank" rel="noopener noreferrer">tuwenlin</a></li><li><a href="https://github.com/JavaLionLi" target="_blank" rel="noopener noreferrer">CrazyLionLi</a></li><li><a href="https://github.com/whxxxxx" target="_blank" rel="noopener noreferrer">whxxxxx</a></li><li><a href="https://github.com/neillee95" target="_blank" rel="noopener noreferrer">neillee95</a></li><li><a href="https://github.com/crazy-sheep" target="_blank" rel="noopener noreferrer">crazy-sheep</a></li><li><a href="https://github.com/zhangzq7" target="_blank" rel="noopener noreferrer">zhangzq7</a></li><li><a href="https://github.com/l81893521" target="_blank" rel="noopener noreferrer">l81893521</a></li><li><a href="https://github.com/zhuyoufeng" target="_blank" rel="noopener noreferrer">zhuyoufeng</a></li><li><a href="https://github.com/xingfudeshi" target="_blank" rel="noopener noreferrer">xingfudeshi</a></li><li><a href="https://github.com/odidev" target="_blank" rel="noopener noreferrer">odidev</a></li><li><a href="https://github.com/miaoxueyu" target="_blank" rel="noopener noreferrer">miaoxueyu</a></li></ul><p>同时，我们收到了社区反馈的很多有价值的issue和建议，非常感谢大家。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="link">Link<a href="#link" class="hash-link" aria-label="Direct link to Link" title="Direct link to Link">​</a></h4><ul><li><strong>Seata:</strong> <a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata</a></li><li><strong>Seata-Samples:</strong> <a href="https://github.com/seata/seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-samples</a></li><li><strong>Release:</strong> <a href="https://github.com/seata/seata/releases" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata/releases</a></li><li><strong>WebSite:</strong> <a href="https://seata.io" target="_blank" rel="noopener noreferrer">https://seata.io</a></li></ul></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-07-12T00:00:00.000Z" itemprop="datePublished">July 12, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Seata社区</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-152-重磅发布支持xid负载均衡">Seata 1.5.2 重磅发布，支持xid负载均衡<a href="#seata-152-重磅发布支持xid负载均衡" class="hash-link" aria-label="Direct link to Seata 1.5.2 重磅发布，支持xid负载均衡" title="Direct link to Seata 1.5.2 重磅发布，支持xid负载均衡">​</a></h3><p>Seata 是一款开源的分布式事务解决方案，提供高性能和简单易用的分布式事务服务。</p><p><strong>seata-server 下载链接：</strong></p><p><a href="https://github.com/seata/seata/archive/v1.5.2.zip" target="_blank" rel="noopener noreferrer">source</a> |
<a href="https://github.com/seata/seata/releases/download/v1.5.2/seata-server-1.5.2.zip" target="_blank" rel="noopener noreferrer">binary</a></p><p>此版本更新如下：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature">feature：<a href="#feature" class="hash-link" aria-label="Direct link to feature：" title="Direct link to feature：">​</a></h3><ul><li>[<a href="https://github.com/seata/seata/pull/4713" target="_blank" rel="noopener noreferrer">#4661</a>] 支持根据xid负载均衡算法</li><li>[<a href="https://github.com/seata/seata/pull/4676" target="_blank" rel="noopener noreferrer">#4676</a>] 支持Nacos作为注册中心时，server通过挂载SLB暴露服务</li><li>[<a href="https://github.com/seata/seata/pull/4642" target="_blank" rel="noopener noreferrer">#4642</a>] 支持client批量请求并行处理</li><li>[<a href="https://github.com/seata/seata/pull/4567" target="_blank" rel="noopener noreferrer">#4567</a>] 支持where条件中find_in_set函数</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bugfix">bugfix：<a href="#bugfix" class="hash-link" aria-label="Direct link to bugfix：" title="Direct link to bugfix：">​</a></h3><ul><li>[<a href="https://github.com/seata/seata/pull/4515" target="_blank" rel="noopener noreferrer">#4515</a>] 修复develop分支SeataTCCFenceAutoConfiguration在客户端未使用DB时，启动抛出ClassNotFoundException的问题。</li><li>[<a href="https://github.com/seata/seata/pull/4661" target="_blank" rel="noopener noreferrer">#4661</a>] 修复控制台中使用PostgreSQL出现的SQL异常</li><li>[<a href="https://github.com/seata/seata/pull/4682" target="_blank" rel="noopener noreferrer">#4667</a>] 修复develop分支RedisTransactionStoreManager迭代时更新map的异常</li><li>[<a href="https://github.com/seata/seata/pull/4678" target="_blank" rel="noopener noreferrer">#4678</a>] 修复属性transport.enableRmClientBatchSendRequest没有配置的情况下缓存穿透的问题</li><li>[<a href="https://github.com/seata/seata/pull/4701" target="_blank" rel="noopener noreferrer">#4701</a>] 修复命令行参数丢失问题</li><li>[<a href="https://github.com/seata/seata/pull/4607" target="_blank" rel="noopener noreferrer">#4607</a>] 修复跳过全局锁校验的缺陷</li><li>[<a href="https://github.com/seata/seata/pull/4696" target="_blank" rel="noopener noreferrer">#4696</a>] 修复 oracle 存储模式时的插入问题</li><li>[<a href="https://github.com/seata/seata/pull/4726" target="_blank" rel="noopener noreferrer">#4726</a>] 修复批量发送消息时可能的NPE问题</li><li>[<a href="https://github.com/seata/seata/pull/4729" target="_blank" rel="noopener noreferrer">#4729</a>] 修复AspectTransactional.rollbackForClassName设置错误</li><li>[<a href="https://github.com/seata/seata/pull/4653" target="_blank" rel="noopener noreferrer">#4653</a>] 修复 INSERT_ON_DUPLICATE 主键为非数值异常</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimize">optimize：<a href="#optimize" class="hash-link" aria-label="Direct link to optimize：" title="Direct link to optimize：">​</a></h3><ul><li>[<a href="https://github.com/seata/seata/pull/4650" target="_blank" rel="noopener noreferrer">#4650</a>] 修复安全漏洞</li><li>[<a href="https://github.com/seata/seata/pull/4670" target="_blank" rel="noopener noreferrer">#4670</a>] 优化branchResultMessageExecutor线程池的线程数</li><li>[<a href="https://github.com/seata/seata/pull/4662" target="_blank" rel="noopener noreferrer">#4662</a>] 优化回滚事务监控指标</li><li>[<a href="https://github.com/seata/seata/pull/4693" target="_blank" rel="noopener noreferrer">#4693</a>] 优化控制台导航栏</li><li>[<a href="https://github.com/seata/seata/pull/4700" target="_blank" rel="noopener noreferrer">#4700</a>] 修复 maven-compiler-plugin 和 maven-resources-plugin 执行失败</li><li>[<a href="https://github.com/seata/seata/pull/4711" target="_blank" rel="noopener noreferrer">#4711</a>] 分离部署时 lib 依赖</li><li>[<a href="https://github.com/seata/seata/pull/4720" target="_blank" rel="noopener noreferrer">#4720</a>] 优化pom描述</li><li>[<a href="https://github.com/seata/seata/pull/4728" target="_blank" rel="noopener noreferrer">#4728</a>] 将logback版本依赖升级至1.2.9</li><li>[<a href="https://github.com/seata/seata/pull/4745" target="_blank" rel="noopener noreferrer">#4745</a>] 发行包中支持 mysql8 driver</li><li>[<a href="https://github.com/seata/seata/pull/4626" target="_blank" rel="noopener noreferrer">#4626</a>] 使用 <code>easyj-maven-plugin</code> 插件代替 <code>flatten-maven-plugin</code>插件，以修复<code>shade</code> 插件与 <code>flatten</code> 插件不兼容的问题</li><li>[<a href="https://github.com/seata/seata/pull/4629" target="_blank" rel="noopener noreferrer">#4629</a>] 更新globalSession状态时检查更改前后的约束关系</li><li>[<a href="https://github.com/seata/seata/pull/4662" target="_blank" rel="noopener noreferrer">#4662</a>] 优化 EnhancedServiceLoader 可读性</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="test">test：<a href="#test" class="hash-link" aria-label="Direct link to test：" title="Direct link to test：">​</a></h3><ul><li>[<a href="https://github.com/seata/seata/pull/4544" target="_blank" rel="noopener noreferrer">#4544</a>] 优化TransactionContextFilterTest中jackson包依赖问题</li><li>[<a href="https://github.com/seata/seata/pull/4731" target="_blank" rel="noopener noreferrer">#4731</a>] 修复 AsyncWorkerTest 和 LockManagerTest 的单测问题。</li></ul><p>非常感谢以下 contributors 的代码贡献。若有无意遗漏，请报告。</p><ul><li><a href="https://github.com/slievrly" target="_blank" rel="noopener noreferrer">slievrly</a></li><li><a href="https://github.com/pengten" target="_blank" rel="noopener noreferrer">pengten</a></li><li><a href="https://github.com/YSF-A" target="_blank" rel="noopener noreferrer">YSF-A</a></li><li><a href="https://github.com/tuwenlin" target="_blank" rel="noopener noreferrer">tuwenlin</a></li><li><a href="https://github.com/2129zxl" target="_blank" rel="noopener noreferrer">2129zxl</a></li><li><a href="https://github.com/Ifdevil" target="_blank" rel="noopener noreferrer">Ifdevil</a></li><li><a href="https://github.com/wingchi-leung" target="_blank" rel="noopener noreferrer">wingchi-leung</a></li><li><a href="https://github.com/robynron" target="_blank" rel="noopener noreferrer">liurong</a></li><li><a href="https://github.com/opelok-z" target="_blank" rel="noopener noreferrer">opelok-z</a></li><li><a href="https://github.com/a364176773" target="_blank" rel="noopener noreferrer">a364176773</a></li><li><a href="https://github.com/Smery-lxm" target="_blank" rel="noopener noreferrer">Smery-lxm</a></li><li><a href="https://github.com/lvekee" target="_blank" rel="noopener noreferrer">lvekee</a></li><li><a href="https://github.com/doubleDimple" target="_blank" rel="noopener noreferrer">doubleDimple</a></li><li><a href="https://github.com/wangliang181230" target="_blank" rel="noopener noreferrer">wangliang181230</a></li><li><a href="https://github.com/Bughue" target="_blank" rel="noopener noreferrer">Bughue</a></li><li><a href="https://github.com/AYue-94" target="_blank" rel="noopener noreferrer">AYue-94</a></li><li><a href="https://github.com/lingxiao-wu" target="_blank" rel="noopener noreferrer">lingxiao-wu</a></li><li><a href="https://github.com/caohdgege" target="_blank" rel="noopener noreferrer">caohdgege</a></li></ul><p>同时，我们收到了社区反馈的很多有价值的issue和建议，非常感谢大家。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="link">Link<a href="#link" class="hash-link" aria-label="Direct link to Link" title="Direct link to Link">​</a></h4><ul><li><strong>Seata:</strong> <a href="https://github.com/seata/seata" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata</a></li><li><strong>Seata-Samples:</strong> <a href="https://github.com/seata/seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-samples</a></li><li><strong>Release:</strong> <a href="https://github.com/seata/seata/releases" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata/releases</a></li><li><strong>WebSite:</strong> <a href="https://seata.io" target="_blank" rel="noopener noreferrer">https://seata.io</a></li></ul></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-06-25T00:00:00.000Z" itemprop="datePublished">June 25, 2022</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">朱晋君</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>今天来聊一聊阿里巴巴 Seata 新版本（1.5.1）是怎么解决 TCC 模式下的幂等、悬挂和空回滚问题的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-tcc-回顾">1 TCC 回顾<a href="#1-tcc-回顾" class="hash-link" aria-label="Direct link to 1 TCC 回顾" title="Direct link to 1 TCC 回顾">​</a></h2><p>TCC 模式是最经典的分布式事务解决方案，它将分布式事务分为两个阶段来执行，try 阶段对每个分支事务进行预留资源，如果所有分支事务都预留资源成功，则进入 commit 阶段提交全局事务，如果有一个节点预留资源失败则进入 cancel 阶段回滚全局事务。</p><p>以传统的订单、库存、账户服务为例，在 try 阶段尝试预留资源，插入订单、扣减库存、扣减金额，这三个服务都是要提交本地事务的，这里可以把资源转入中间表。在 commit 阶段，再把 try 阶段预留的资源转入最终表。而在 cancel 阶段，把 try 阶段预留的资源进行释放，比如把账户金额返回给客户的账户。</p><p><strong>注意：try 阶段必须是要提交本地事务的，比如扣减订单金额，必须把钱从客户账户扣掉，如果不扣掉，在 commit 阶段客户账户钱不够了，就会出问题。</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-try-commit">1.1 try-commit<a href="#11-try-commit" class="hash-link" aria-label="Direct link to 1.1 try-commit" title="Direct link to 1.1 try-commit">​</a></h3><p>try 阶段首先进行预留资源，然后在 commit 阶段扣除资源。如下图：</p><p><img loading="lazy" alt="fence-try-commit" src="/assets/images/fence-try-commit-453b9a1e280200057448436ecd7eef27.png" width="501" height="681" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-try-cancel">1.2 try-cancel<a href="#12-try-cancel" class="hash-link" aria-label="Direct link to 1.2 try-cancel" title="Direct link to 1.2 try-cancel">​</a></h3><p>try 阶段首先进行预留资源，预留资源时扣减库存失败导致全局事务回滚，在 cancel 阶段释放资源。如下图：</p><p><img loading="lazy" alt="fence-try-cancel" src="/assets/images/fence-try-cancel-eafbbb62134fe4e3ed61bdc2a47461b9.png" width="501" height="681" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-tcc-优势">2 TCC 优势<a href="#2-tcc-优势" class="hash-link" aria-label="Direct link to 2 TCC 优势" title="Direct link to 2 TCC 优势">​</a></h2><p>TCC 模式最大的优势是效率高。TCC 模式在 try 阶段的锁定资源并不是真正意义上的锁定，而是真实提交了本地事务，将资源预留到中间态，并不需要阻塞等待，因此效率比其他模式要高。</p><p>同时 TCC 模式还可以进行如下优化：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-异步提交">2.1 异步提交<a href="#21-异步提交" class="hash-link" aria-label="Direct link to 2.1 异步提交" title="Direct link to 2.1 异步提交">​</a></h3><p>try 阶段成功后，不立即进入 confirm/cancel 阶段，而是认为全局事务已经结束了，启动定时任务来异步执行 confirm/cancel，扣减或释放资源，这样会有很大的性能提升。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-同库模式">2.2 同库模式<a href="#22-同库模式" class="hash-link" aria-label="Direct link to 2.2 同库模式" title="Direct link to 2.2 同库模式">​</a></h3><p>TCC 模式中有三个角色：</p><ul><li>TM：管理全局事务，包括开启全局事务，提交/回滚全局事务；</li><li>RM：管理分支事务；</li><li>TC: 管理全局事务和分支事务的状态。</li></ul><p>下图来自 Seata 官网：</p><p><img loading="lazy" alt="fence-fiffrent-db" src="/assets/images/fence-fiffrent-db-1f7a834639aa755d73fa2af435c4f042.png" width="853" height="482" class="img_ev3q"></p><p>TM 开启全局事务时，RM 需要向 TC 发送注册消息，TC 保存分支事务的状态。TM 请求提交或回滚时，TC 需要向 RM 发送提交或回滚消息。这样包含两个个分支事务的分布式事务中，TC 和 RM 之间有四次 RPC。</p><p>优化后的流程如下图：</p><p><img loading="lazy" alt="fence-same-db" src="/assets/images/fence-same-db-e6de622d66afae78fd17082782192b72.png" width="943" height="442" class="img_ev3q"></p><p>TC 保存全局事务的状态。TM 开启全局事务时，RM 不再需要向 TC 发送注册消息，而是把分支事务状态保存在了本地。TM 向 TC 发送提交或回滚消息后，RM 异步线程首先查出本地保存的未提交分支事务，然后向 TC 发送消息获取（本地分支事务）所在的全局事务状态，以决定是提交还是回滚本地事务。</p><p>这样优化后，RPC 次数减少了 50%，性能大幅提升。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-rm-代码示例">3 RM 代码示例<a href="#3-rm-代码示例" class="hash-link" aria-label="Direct link to 3 RM 代码示例" title="Direct link to 3 RM 代码示例">​</a></h2><p>以库存服务为例，RM 库存服务接口代码如下：</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@LocalTCC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 扣减库存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param xid 全局xid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param productId 产品id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param count 数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TwoPhaseBusinessAction(name = &quot;storageApi&quot;, commitMethod = &quot;commit&quot;, rollbackMethod = &quot;rollback&quot;, useTCCFence = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean decrease(String xid, Long productId, Integer count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 提交事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param actionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 回滚事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param actionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean rollback(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过 @LocalTCC 这个注解，RM 初始化的时候会向 TC 注册一个分支事务。在 try 阶段的方法（decrease方法）上有一个 @TwoPhaseBusinessAction 注解，这里定义了分支事务的 resourceId，commit 方法和 cancel 方法，useTCCFence 这个属性下一节再讲。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-tcc-存在问题">4 TCC 存在问题<a href="#4-tcc-存在问题" class="hash-link" aria-label="Direct link to 4 TCC 存在问题" title="Direct link to 4 TCC 存在问题">​</a></h2><p>TCC 模式中存在的三大问题是幂等、悬挂和空回滚。在 Seata1.5.1 版本中，增加了一张事务控制表，表名是 tcc_fence_log 来解决这个问题。而在上一节 @TwoPhaseBusinessAction 注解中提到的属性 useTCCFence 就是来指定是否开启这个机制，这个属性值默认是 false。</p><p>tcc_fence_log 建表语句如下（MySQL 语法）：</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE IF NOT EXISTS `tcc_fence_log`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `xid`           VARCHAR(128)  NOT NULL COMMENT &#x27;global id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `branch_id`     BIGINT        NOT NULL COMMENT &#x27;branch id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `action_name`   VARCHAR(64)   NOT NULL COMMENT &#x27;action name&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `status`        TINYINT       NOT NULL COMMENT &#x27;status(tried:1;committed:2;rollbacked:3;suspended:4)&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_create`    DATETIME(3)   NOT NULL COMMENT &#x27;create time&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_modified`  DATETIME(3)   NOT NULL COMMENT &#x27;update time&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY (`xid`, `branch_id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_gmt_modified` (`gmt_modified`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_status` (`status`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = InnoDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DEFAULT CHARSET = utf8mb4;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-幂等">4.1 幂等<a href="#41-幂等" class="hash-link" aria-label="Direct link to 4.1 幂等" title="Direct link to 4.1 幂等">​</a></h3><p>在 commit/cancel 阶段，因为 TC 没有收到分支事务的响应，需要进行重试，这就要分支事务支持幂等。</p><p>我们看一下新版本是怎么解决的。下面的代码在 TCCResourceManager 类：</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 String applicationData) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCCResource tccResource = (TCCResource)tccResourceCache.get(resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //省略判断</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object targetTCCBean = tccResource.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Method commitMethod = tccResource.getCommitMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //省略判断</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //BusinessActionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BusinessActionContext businessActionContext = getBusinessActionContext(xid, branchId, resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object[] args = this.getTwoPhaseCommitArgs(tccResource, businessActionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //注解 useTCCFence 属性是否设置为 true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(businessActionContext.getActionContext(Constants.USE_TCC_FENCE))) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = TCCFenceHandler.commitFence(commitMethod, targetTCCBean, xid, branchId, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (SkipCallbackWrapperException | UndeclaredThrowableException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw e.getCause();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //省略逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;TCC resource commit result : {}, xid: {}, branchId: {}, resourceId: {}&quot;, result, xid, branchId, resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result ? BranchStatus.PhaseTwo_Committed : BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的代码可以看到，执行分支事务提交方法时，首先判断 useTCCFence 属性是否为 true，如果为 true，则走 TCCFenceHandler 类中的 commitFence 逻辑，否则走普通提交逻辑。</p><p>TCCFenceHandler 类中的 commitFence 方法调用了 TCCFenceHandler 类的 commitFence 方法，代码如下：</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static boolean commitFence(Method commitMethod, Object targetTCCBean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  String xid, Long branchId, Object[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TCCFenceDO tccFenceDO = TCC_FENCE_DAO.queryTCCFenceDO(conn, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tccFenceDO == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new TCCFenceException(String.format(&quot;TCC fence record not exists, commit fence method failed. xid= %s, branchId= %s&quot;, xid, branchId),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FrameworkErrorCode.RecordAlreadyExists);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (TCCFenceConstant.STATUS_COMMITTED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.info(&quot;Branch transaction has already committed before. idempotency rejected. xid: {}, branchId: {}, status: {}&quot;, xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (TCCFenceConstant.STATUS_ROLLBACKED == tccFenceDO.getStatus() || TCCFenceConstant.STATUS_SUSPENDED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (LOGGER.isWarnEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.warn(&quot;Branch transaction status is unexpected. xid: {}, branchId: {}, status: {}&quot;, xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return updateStatusAndInvokeTargetMethod(conn, commitMethod, targetTCCBean, xid, branchId, TCCFenceConstant.STATUS_COMMITTED, status, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status.setRollbackOnly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SkipCallbackWrapperException(t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从代码中可以看到，提交事务时首先会判断 tcc_fence_log 表中是否已经有记录，如果有记录，则判断事务执行状态并返回。这样如果判断到事务的状态已经是 STATUS_COMMITTED，就不会再次提交，保证了幂等。如果 tcc_fence_log 表中没有记录，则插入一条记录，供后面重试时判断。</p><p>Rollback 的逻辑跟 commit 类似，逻辑在类 TCCFenceHandler 的 rollbackFence 方法。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-空回滚">4.2 空回滚<a href="#42-空回滚" class="hash-link" aria-label="Direct link to 4.2 空回滚" title="Direct link to 4.2 空回滚">​</a></h3><p>如下图，账户服务是两个节点的集群，在 try 阶段账户服务 1 这个节点发生了故障，try 阶段在不考虑重试的情况下，全局事务必须要走向结束状态，这样就需要在账户服务上执行一次 cancel 操作。</p><p><img loading="lazy" alt="fence-empty-rollback" src="/assets/images/fence-empty-rollback-55e0c44f8e67d5df91c0f930860baa1f.png" width="591" height="681" class="img_ev3q"></p><p>Seata 的解决方案是在 try 阶段 往 tcc_fence_log  表插入一条记录，status 字段值是 STATUS_TRIED，在 Rollback 阶段判断记录是否存在，如果不存在，则不执行回滚操作。代码如下：</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//TCCFenceHandler 类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static Object prepareFence(String xid, Long branchId, String actionName, Callback&lt;Object&gt; targetCallback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean result = insertTCCFenceLog(conn, xid, branchId, actionName, TCCFenceConstant.STATUS_TRIED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;TCC fence prepare result: {}. xid: {}, branchId: {}&quot;, result, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (result) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return targetCallback.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new TCCFenceException(String.format(&quot;Insert tcc fence record error, prepare fence failed. xid= %s, branchId= %s&quot;, xid, branchId),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FrameworkErrorCode.InsertRecordError);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TCCFenceException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 Rollback 阶段的处理逻辑如下:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//TCCFenceHandler 类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static boolean rollbackFence(Method rollbackMethod, Object targetTCCBean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    String xid, Long branchId, Object[] args, String actionName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TCCFenceDO tccFenceDO = TCC_FENCE_DAO.queryTCCFenceDO(conn, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // non_rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tccFenceDO == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //不执行回滚逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (TCCFenceConstant.STATUS_ROLLBACKED == tccFenceDO.getStatus() || TCCFenceConstant.STATUS_SUSPENDED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.info(&quot;Branch transaction had already rollbacked before, idempotency rejected. xid: {}, branchId: {}, status: {}&quot;, xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (TCCFenceConstant.STATUS_COMMITTED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (LOGGER.isWarnEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOGGER.warn(&quot;Branch transaction status is unexpected. xid: {}, branchId: {}, status: {}&quot;, xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return updateStatusAndInvokeTargetMethod(conn, rollbackMethod, targetTCCBean, xid, branchId, TCCFenceConstant.STATUS_ROLLBACKED, status, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status.setRollbackOnly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SkipCallbackWrapperException(t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>updateStatusAndInvokeTargetMethod 方法执行的 sql 如下：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> tcc_fence_log </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gmt_modified </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> xid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">and</span><span class="token plain">  branch_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可见就是把 tcc_fence_log 表记录的  status  字段值从 STATUS_TRIED 改为 STATUS_ROLLBACKED，如果更新成功，就执行回滚逻辑。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-悬挂">4.3 悬挂<a href="#43-悬挂" class="hash-link" aria-label="Direct link to 4.3 悬挂" title="Direct link to 4.3 悬挂">​</a></h3><p>悬挂是指因为网络问题，RM 开始没有收到 try 指令，但是执行了 Rollback 后 RM 又收到了 try 指令并且预留资源成功，这时全局事务已经结束，最终导致预留的资源不能释放。如下图：</p><p><img loading="lazy" alt="fence-suspend" src="/assets/images/fence-suspend-054f87611ab16153c07bd28495c6902c.png" width="451" height="193" class="img_ev3q"></p><p>Seata 解决这个问题的方法是执行 Rollback 方法时先判断 tcc_fence_log 是否存在当前 xid 的记录，如果没有则向 tcc_fence_log 表插入一条记录，状态是 STATUS_SUSPENDED，并且不再执行回滚操作。代码如下：</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static boolean rollbackFence(Method rollbackMethod, Object targetTCCBean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    String xid, Long branchId, Object[] args, String actionName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TCCFenceDO tccFenceDO = TCC_FENCE_DAO.queryTCCFenceDO(conn, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // non_rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tccFenceDO == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //插入防悬挂记录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean result = insertTCCFenceLog(conn, xid, branchId, actionName, TCCFenceConstant.STATUS_SUSPENDED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //省略逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //省略逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return updateStatusAndInvokeTargetMethod(conn, rollbackMethod, targetTCCBean, xid, branchId, TCCFenceConstant.STATUS_ROLLBACKED, status, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //省略逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而后面执行 try 阶段方法时首先会向 tcc_fence_log 表插入一条当前 xid 的记录，这样就造成了主键冲突。代码如下：</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//TCCFenceHandler 类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static Object prepareFence(String xid, Long branchId, String actionName, Callback&lt;Object&gt; targetCallback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean result = insertTCCFenceLog(conn, xid, branchId, actionName, TCCFenceConstant.STATUS_TRIED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //省略逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TCCFenceException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (e.getErrcode() == FrameworkErrorCode.DuplicateKeyException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Branch transaction has already rollbacked before,prepare fence failed. xid= {},branchId = {}&quot;, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                addToLogCleanQueue(xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status.setRollbackOnly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SkipCallbackWrapperException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>注意：queryTCCFenceDO 方法 sql 中使用了 for update，这样就不用担心 Rollback 方法中获取不到 tcc_fence_log 表记录而无法判断 try 阶段本地事务的执行结果了。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-总结">5 总结<a href="#5-总结" class="hash-link" aria-label="Direct link to 5 总结" title="Direct link to 5 总结">​</a></h2><p>TCC 模式是分布式事务中非常重要的事务模式，但是幂等、悬挂和空回滚一直是 TCC 模式需要考虑的问题，Seata 框架在 1.5.1 版本完美解决了这些问题。</p><p>对 tcc_fence_log 表的操作也需要考虑事务的控制，Seata 使用了代理数据源，使 tcc_fence_log 表操作和 RM 业务操作在同一个本地事务中执行，这样就能保证本地操作和对 tcc_fence_log 的操作同时成功或失败。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-01-18T00:00:00.000Z" itemprop="datePublished">January 18, 2022</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Seata 目前支持 AT 模式、XA 模式、TCC 模式和 SAGA 模式，之前文章更多谈及的是非侵入式的 AT 模式，今天带大家认识一下同样是二阶段提交的 TCC 模式。</p><h1>什么是 TCC</h1><p>TCC 是分布式事务中的二阶段提交协议，它的全称为 Try-Confirm-Cancel，即资源预留（Try）、确认操作（Confirm）、取消操作（Cancel），他们的具体含义如下：</p><ol><li>Try：对业务资源的检查并预留；</li><li>Confirm：对业务处理进行提交，即 commit 操作，只要 Try 成功，那么该步骤一定成功；</li><li>Cancel：对业务处理进行取消，即回滚操作，该步骤回对 Try 预留的资源进行释放。</li></ol><p>TCC 是一种侵入式的分布式事务解决方案，以上三个操作都需要业务系统自行实现，对业务系统有着非常大的入侵性，设计相对复杂，但优点是 TCC
完全不依赖数据库，能够实现跨数据库、跨应用资源管理，对这些不同数据访问通过侵入式的编码方式实现一个原子操作，更好地解决了在各种复杂业务场景下的分布式事务问题。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20220116160157.png" class="img_ev3q"></p><h1>Seata TCC 模式</h1><p>Seata TCC 模式跟通用型 TCC 模式原理一致，我们先来使用 Seata TCC 模式实现一个分布式事务：</p><p>假设现有一个业务需要同时使用服务 A 和服务 B 完成一个事务操作，我们在服务 A 定义该服务的一个 TCC 接口：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface TccActionOne {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TwoPhaseBusinessAction(name = &quot;DubboTccActionOne&quot;, commitMethod = &quot;commit&quot;, rollbackMethod = &quot;rollback&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean prepare(BusinessActionContext actionContext, @BusinessActionContextParameter(paramName = &quot;a&quot;) String a);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean rollback(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同样，在服务 B 定义该服务的一个 TCC 接口：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface TccActionTwo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TwoPhaseBusinessAction(name = &quot;DubboTccActionTwo&quot;, commitMethod = &quot;commit&quot;, rollbackMethod = &quot;rollback&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void prepare(BusinessActionContext actionContext, @BusinessActionContextParameter(paramName = &quot;b&quot;) String b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void rollback(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在业务所在系统中开启全局事务并执行服务 A 和服务 B 的 TCC 预留资源方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public String doTransactionCommit(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //服务A事务参与者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccActionOne.prepare(null,&quot;one&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //服务B事务参与者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccActionTwo.prepare(null,&quot;two&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上就是使用 Seata TCC 模式实现一个全局事务的例子，可以看出，TCC 模式同样使用 <code>@GlobalTransactional</code> 注解开启全局事务，而服务 A 和服务 B 的 TCC 接口为事务参与者，Seata 会把一个 TCC
接口当成一个 Resource，也叫 TCC Resource。</p><p>TCC 接口可以是 RPC，也可以是 JVM 内部调用，意味着一个 TCC 接口，会有发起方和调用方两个身份，以上例子，TCC 接口在服务 A 和服务 B 中是发起方，在业务所在系统中是调用方。如果该 TCC 接口为 Dubbo
RPC，那么调用方就是一个 dubbo:reference，发起方则是一个 dubbo:service。</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20220116161933.png" class="img_ev3q"></p><p>Seata 启动时会对 TCC 接口进行扫描并解析，如果 TCC 接口是一个发布方，则在 Seata 启动时会向 TC 注册 TCC Resource，每个 TCC Resource 都有一个资源 ID；如果 TCC
接口时一个调用方，Seata 代理调用方，与 AT 模式一样，代理会拦截 TCC 接口的调用，即每次调用 Try 方法，会向 TC 注册一个分支事务，接着才执行原来的 RPC 调用。</p><p>当全局事务决议提交/回滚时，TC 会通过分支注册的的资源 ID 回调到对应参与者服务中执行 TCC Resource 的 Confirm/Cancel 方法。</p><h1>Seata 如何实现 TCC 模式</h1><p>从上面的 Seata TCC 模型可以看出，TCC 模式在 Seata 中也是遵循 TC、TM、RM 三种角色模型的，如何在这三种角色模型中实现 TCC 模式呢？我将其主要实现归纳为资源解析、资源管理、事务处理。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="资源解析">资源解析<a href="#资源解析" class="hash-link" aria-label="Direct link to 资源解析" title="Direct link to 资源解析">​</a></h2><p>资源解析即是把 TCC 接口进行解析并注册，前面说过，TCC 接口可以是 RPC，也可以是 JVM 内部调用，在 Seata TCC 模块有中一个 remoting
模块，该模块专门用于解析具有 <code>TwoPhaseBusinessAction</code> 注解的 TCC 接口资源：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20220116175059.png" class="img_ev3q"></p><p><code>RemotingParser</code> 接口主要有 <code>isRemoting</code>、<code>isReference</code>、<code>isService</code>、<code>getServiceDesc</code> 等方法，默认的实现为 <code>DefaultRemotingParser</code>，其余各自的
RPC 协议解析类都在 <code>DefaultRemotingParser</code> 中执行，Seata 目前已经实现了对 Dubbo、HSF、SofaRpc、LocalTCC 的 RPC 协议的解析，同时具备 SPI 可扩展性，未来欢迎大家为
Seata 提供更多的 RPC 协议解析类。</p><p>在 Seata 启动过程中，有个 <code>GlobalTransactionScanner </code> 注解进行扫描，会执行以下方法：</p><p><code>io.seata.spring.util.TCCBeanParserUtils#isTccAutoProxy</code></p><p>该方法目的是判断 bean 是否已被 TCC 代理，在过程中会先判断 bean 是否是一个 Remoting bean，如果是则调用 <code>getServiceDesc</code> 方法对 remoting bean
进行解析，同时判断如果是一个发起方，则对其进行资源注册：</p><p>io.seata.rm.tcc.remoting.parser.DefaultRemotingParser#parserRemotingServiceInfo</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public RemotingDesc parserRemotingServiceInfo(Object bean,String beanName,RemotingParser remotingParser){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RemotingDesc remotingBeanDesc=remotingParser.getServiceDesc(bean,beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(remotingBeanDesc==null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remotingServiceMap.put(beanName,remotingBeanDesc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; interfaceClass=remotingBeanDesc.getInterfaceClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Method[]methods=interfaceClass.getMethods();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(remotingParser.isService(bean,beanName)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //service bean, registry resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object targetBean=remotingBeanDesc.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for(Method m:methods){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TwoPhaseBusinessAction twoPhaseBusinessAction=m.getAnnotation(TwoPhaseBusinessAction.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(twoPhaseBusinessAction!=null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCCResource tccResource=new TCCResource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setActionName(twoPhaseBusinessAction.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setTargetBean(targetBean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setPrepareMethod(m);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setCommitMethodName(twoPhaseBusinessAction.commitMethod());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setCommitMethod(interfaceClass.getMethod(twoPhaseBusinessAction.commitMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    twoPhaseBusinessAction.commitArgsClasses()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setRollbackMethodName(twoPhaseBusinessAction.rollbackMethod());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setRollbackMethod(interfaceClass.getMethod(twoPhaseBusinessAction.rollbackMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    twoPhaseBusinessAction.rollbackArgsClasses()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set argsClasses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setCommitArgsClasses(twoPhaseBusinessAction.commitArgsClasses());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setRollbackArgsClasses(twoPhaseBusinessAction.rollbackArgsClasses());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set phase two method&#x27;s keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setPhaseTwoCommitKeys(this.getTwoPhaseArgs(tccResource.getCommitMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    twoPhaseBusinessAction.commitArgsClasses()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResource.setPhaseTwoRollbackKeys(this.getTwoPhaseArgs(tccResource.getRollbackMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    twoPhaseBusinessAction.rollbackArgsClasses()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //registry tcc resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DefaultResourceManager.get().registerResource(tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }catch(Throwable t){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new FrameworkException(t,&quot;parser remoting service error&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(remotingParser.isReference(bean,beanName)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //reference bean, TCC proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remotingBeanDesc.setReference(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return remotingBeanDesc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上方法，先调用解析类 <code>getServiceDesc</code> 方法对 remoting bean 进行解析，并将解析后的 <code>remotingBeanDesc</code> 放入 本地缓存 <code>remotingServiceMap</code>
中，同时调用解析类 <code>isService</code> 方法判断是否为发起方，如果是发起方，则解析 <code>TwoPhaseBusinessAction</code> 注解内容生成一个 <code>TCCResource</code>，并对其进行资源注册。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="资源管理">资源管理<a href="#资源管理" class="hash-link" aria-label="Direct link to 资源管理" title="Direct link to 资源管理">​</a></h2><p><strong>1、资源注册</strong></p><p>Seata TCC 模式的资源叫 <code>TCCResource</code>，其资源管理器叫 <code>TCCResourceManager</code>，前面讲过，当解析完 TCC 接口 RPC 资源后，如果是发起方，则会对其进行资源注册：</p><p>io.seata.rm.tcc.TCCResourceManager#registerResource</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void registerResource(Resource resource){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCCResource tccResource=(TCCResource)resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResourceCache.put(tccResource.getResourceId(),tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerResource(tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>TCCResource</code> 包含了 TCC 接口的相关信息，同时会在本地进行缓存。继续调用父类 <code>registerResource</code> 方法（封装了通信方法）向 TC 注册，TCC 资源的 resourceId 是
actionName，actionName 就是 <code>@TwoParseBusinessAction</code> 注解中的 name。</p><p><strong>2、资源提交/回滚</strong></p><p>io.seata.rm.tcc.TCCResourceManager#branchCommit</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public BranchStatus branchCommit(BranchType branchType,String xid,long branchId,String resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String applicationData)throws TransactionException{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCCResource tccResource=(TCCResource)tccResourceCache.get(resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(tccResource==null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new ShouldNeverHappenException(String.format(&quot;TCC resource is not exist, resourceId: %s&quot;,resourceId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object targetTCCBean=tccResource.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Method commitMethod=tccResource.getCommitMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(targetTCCBean==null||commitMethod==null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new ShouldNeverHappenException(String.format(&quot;TCC resource is not available, resourceId: %s&quot;,resourceId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //BusinessActionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BusinessActionContext businessActionContext=getBusinessActionContext(xid,branchId,resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ... </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret=commitMethod.invoke(targetTCCBean,args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ... </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result?BranchStatus.PhaseTwo_Committed:BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }catch(Throwable t){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String msg=String.format(&quot;commit TCC resource error, resourceId: %s, xid: %s.&quot;,resourceId,xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.error(msg,t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当 TM 决议二阶段提交，TC 会通过分支注册的的资源 ID 回调到对应参与者（即 TCC 接口发起方）服务中执行 TCC Resource 的 Confirm/Cancel 方法。</p><p>资源管理器中会根据 resourceId 在本地缓存找到对应的 <code>TCCResource</code>，同时根据 xid、branchId、resourceId、applicationData 找到对应的 <code>BusinessActionContext</code>
上下文，执行的参数就在上下文中。最后，执行 <code>TCCResource</code> 中获取 <code>commit</code> 的方法进行二阶段提交。</p><p>二阶段回滚同理类似。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="事务处理">事务处理<a href="#事务处理" class="hash-link" aria-label="Direct link to 事务处理" title="Direct link to 事务处理">​</a></h2><p>前面讲过，如果 TCC 接口时一个调用方，则会使用 Seata TCC 代理对调用方进行拦截处理，并在处理调用真正的 RPC 方法前对分支进行注册。</p><p>执行方法<code>io.seata.spring.util.TCCBeanParserUtils#isTccAutoProxy</code>除了对 TCC 接口资源进行解析，还会判断 TCC 接口是否为调用方，如果是调用方则返回 true：</p><p>io.seata.spring.annotation.GlobalTransactionScanner#wrapIfNecessary</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20220116192544.png" class="img_ev3q"></p><p>如图，当 <code>GlobalTransactionalScanner</code> 扫描到 TCC 接口调用方（Reference）时，会使 <code>TccActionInterceptor</code> 对其进行代理拦截处理，<code>TccActionInterceptor</code>
实现 <code>MethodInterceptor</code>。</p><p>在 <code>TccActionInterceptor</code> 中还会调用 <code>ActionInterceptorHandler</code> 类型执行拦截处理逻辑，事务相关处理就在 <code>ActionInterceptorHandler#proceed</code> 方法中：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Object proceed(Method method,Object[]arguments,String xid,TwoPhaseBusinessAction businessAction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Callback&lt;Object&gt; targetCallback)throws Throwable{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Get action context from arguments, or create a new one and then reset to arguments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BusinessActionContext actionContext=getOrCreateActionContextAndResetToArguments(method.getParameterTypes(),arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Creating Branch Record</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String branchId=doTccActionLogStore(method,arguments,businessAction,actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ... </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return targetCallback.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }finally{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //to report business action context finally if the actionContext.getUpdated() is true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BusinessActionContextUtil.reportContext(actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }finally{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ... </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上，在执行 TCC 接口一阶段之前，会调用 <code>doTccActionLogStore</code> 方法分支注册，同时还会将 TCC 相关信息比如参数放置在上下文，上面讲的资源提交/回滚就会用到这个上下文。</p><h1>如何控制异常</h1><p>在 TCC 模型执行的过程中，还可能会出现各种异常，其中最为常见的有空回滚、幂等、悬挂等。下面我讲下 Seata 是如何处理这三种异常的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何处理空回滚">如何处理空回滚<a href="#如何处理空回滚" class="hash-link" aria-label="Direct link to 如何处理空回滚" title="Direct link to 如何处理空回滚">​</a></h2><p>什么是空回滚？</p><p>空回滚指的是在一个分布式事务中，在没有调用参与方的 Try 方法的情况下，TM 驱动二阶段回滚调用了参与方的 Cancel 方法。</p><p>那么空回滚是如何产生的呢？</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20220116201900.png" class="img_ev3q"></p><p>如上图所示，全局事务开启后，参与者 A 分支注册完成之后会执行参与者一阶段 RPC 方法，如果此时参与者 A 所在的机器发生宕机，网络异常，都会造成 RPC 调用失败，即参与者 A 一阶段方法未成功执行，但是此时全局事务已经开启，Seata
必须要推进到终态，在全局事务回滚时会调用参与者 A 的 Cancel 方法，从而造成空回滚。</p><p>要想防止空回滚，那么必须在 Cancel 方法中识别这是一个空回滚，Seata 是如何做的呢？</p><p>Seata 的做法是新增一个 TCC 事务控制表，包含事务的 XID 和 BranchID 信息，在 Try 方法执行时插入一条记录，表示一阶段执行了，执行 Cancel 方法时读取这条记录，如果记录不存在，说明 Try 方法没有执行。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何处理幂等">如何处理幂等<a href="#如何处理幂等" class="hash-link" aria-label="Direct link to 如何处理幂等" title="Direct link to 如何处理幂等">​</a></h2><p>幂等问题指的是 TC 重复进行二阶段提交，因此 Confirm/Cancel 接口需要支持幂等处理，即不会产生资源重复提交或者重复释放。</p><p>那么幂等问题是如何产生的呢？</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20220116203816.png" class="img_ev3q"></p><p>如上图所示，参与者 A 执行完二阶段之后，由于网络抖动或者宕机问题，会造成 TC 收不到参与者 A 执行二阶段的返回结果，TC 会重复发起调用，直到二阶段执行结果成功。</p><p>Seata 是如何处理幂等问题的呢？</p><p>同样的也是在 TCC 事务控制表中增加一个记录状态的字段 status，该字段有 3 个值，分别为：</p><ol><li>tried：1</li><li>committed：2</li><li>rollbacked：3</li></ol><p>二阶段 Confirm/Cancel 方法执行后，将状态改为 committed 或 rollbacked 状态。当重复调用二阶段 Confirm/Cancel 方法时，判断事务状态即可解决幂等问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何处理悬挂">如何处理悬挂<a href="#如何处理悬挂" class="hash-link" aria-label="Direct link to 如何处理悬挂" title="Direct link to 如何处理悬挂">​</a></h2><p>悬挂指的是二阶段 Cancel 方法比 一阶段 Try 方法优先执行，由于允许空回滚的原因，在执行完二阶段 Cancel 方法之后直接空回滚返回成功，此时全局事务已结束，但是由于 Try 方法随后执行，这就会造成一阶段 Try
方法预留的资源永远无法提交和释放了。</p><p>那么悬挂是如何产生的呢？</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20220116205241.png" class="img_ev3q"></p><p>如上图所示，在执行参与者 A 的一阶段 Try 方法时，出现网路拥堵，由于 Seata 全局事务有超时限制，执行 Try 方法超时后，TM 决议全局回滚，回滚完成后如果此时 RPC 请求才到达参与者 A，执行 Try
方法进行资源预留，从而造成悬挂。</p><p>Seata 是怎么处理悬挂的呢？</p><p>在 TCC 事务控制表记录状态的字段 status 中增加一个状态：</p><ol><li>suspended：4</li></ol><p>当执行二阶段 Cancel 方法时，如果发现 TCC 事务控制表没有相关记录，说明二阶段 Cancel 方法优先一阶段 Try 方法执行，因此插入一条 status=4 状态的记录，当一阶段 Try 方法后面执行时，判断 status=4 ，则说明有二阶段 Cancel 已执行，并返回 false 以阻止一阶段 Try 方法执行成功。</p><h1>作者简介</h1><p>张乘辉，目前就职于蚂蚁集团，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Committer，GitHub
ID：objcoding。</p></div></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/2"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Vision</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Seata is ...</a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/overview/what-is-seata">What is Seata?</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/user/quickstart">Quick Start</a></li><li class="footer__item"><a href="https://github.com/seata/seata.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">Report a doc issue<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/seata/seata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Edit This Page on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/community">Community</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="//img.alicdn.com/tfs/TB1dGrSwVT7gK0jSZFpXXaTkpXa-4802-1285.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="120" height="36"><img src="//img.alicdn.com/tfs/TB1dGrSwVT7gK0jSZFpXXaTkpXa-4802-1285.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="120" height="36"></div><div class="footer__copyright">Copyright © 2023 Seata</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a3727777.js"></script>
<script src="/assets/js/main.ab6a73b0.js"></script>
</body>
</html>