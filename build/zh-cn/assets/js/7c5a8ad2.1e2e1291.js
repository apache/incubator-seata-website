"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[68043],{3905:(e,n,a)=>{a.d(n,{Zo:()=>u,kt:()=>k});var t=a(67294);function o(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function r(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function l(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?r(Object(a),!0).forEach((function(n){o(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function i(e,n){if(null==e)return{};var a,t,o=function(e,n){if(null==e)return{};var a,t,o={},r=Object.keys(e);for(t=0;t<r.length;t++)a=r[t],n.indexOf(a)>=0||(o[a]=e[a]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(t=0;t<r.length;t++)a=r[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var c=t.createContext({}),d=function(e){var n=t.useContext(c),a=n;return e&&(a="function"==typeof e?e(n):l(l({},n),e)),a},u=function(e){var n=d(e.components);return t.createElement(c.Provider,{value:n},e.children)},p="mdxType",s={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},m=t.forwardRef((function(e,n){var a=e.components,o=e.mdxType,r=e.originalType,c=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),p=d(a),m=o,k=p["".concat(c,".").concat(m)]||p[m]||s[m]||r;return a?t.createElement(k,l(l({ref:n},u),{},{components:a})):t.createElement(k,l({ref:n},u))}));function k(e,n){var a=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=a.length,l=new Array(r);l[0]=m;var i={};for(var c in n)hasOwnProperty.call(n,c)&&(i[c]=n[c]);i.originalType=e,i[p]="string"==typeof e?e:o,l[1]=i;for(var d=2;d<r;d++)l[d]=a[d];return t.createElement.apply(null,l)}return t.createElement.apply(null,a)}m.displayName="MDXCreateElement"},6170:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>s,frontMatter:()=>r,metadata:()=>i,toc:()=>d});var t=a(87462),o=(a(67294),a(3905));const r={title:"Seata\u6570\u636e\u6e90\u4ee3\u7406\u89e3\u6790",keywords:["Seata\u3001\u6570\u636e\u6e90\u3001\u6570\u636e\u6e90\u4ee3\u7406\u3001\u591a\u6570\u636e\u6e90"],description:"\u672c\u6587\u4e3b\u8981\u4ecb\u7ecdSeata\u6570\u636e\u6e90\u4ee3\u7406\u5b9e\u73b0\u539f\u7406\u53ca\u4f7f\u7528\u65f6\u53ef\u80fd\u4f1a\u9047\u5230\u7684\u95ee\u9898",author:"\u7f57\u5c0f\u52c7",date:"2020/10/16"},l="\u6570\u636e\u6e90\u4ee3\u7406",i={permalink:"/zh-cn/blog/seata-datasource-proxy",source:"@site/i18n/zh-cn/docusaurus-plugin-content-blog/seata-datasource-proxy.md",title:"Seata\u6570\u636e\u6e90\u4ee3\u7406\u89e3\u6790",description:"\u672c\u6587\u4e3b\u8981\u4ecb\u7ecdSeata\u6570\u636e\u6e90\u4ee3\u7406\u5b9e\u73b0\u539f\u7406\u53ca\u4f7f\u7528\u65f6\u53ef\u80fd\u4f1a\u9047\u5230\u7684\u95ee\u9898",date:"2020-10-16T00:00:00.000Z",formattedDate:"2020\u5e7410\u670816\u65e5",tags:[],readingTime:36.27,hasTruncateMarker:!1,authors:[{name:"\u7f57\u5c0f\u52c7"}],frontMatter:{title:"Seata\u6570\u636e\u6e90\u4ee3\u7406\u89e3\u6790",keywords:["Seata\u3001\u6570\u636e\u6e90\u3001\u6570\u636e\u6e90\u4ee3\u7406\u3001\u591a\u6570\u636e\u6e90"],description:"\u672c\u6587\u4e3b\u8981\u4ecb\u7ecdSeata\u6570\u636e\u6e90\u4ee3\u7406\u5b9e\u73b0\u539f\u7406\u53ca\u4f7f\u7528\u65f6\u53ef\u80fd\u4f1a\u9047\u5230\u7684\u95ee\u9898",author:"\u7f57\u5c0f\u52c7",date:"2020/10/16"},prevItem:{title:"seata-golang \u901a\u4fe1\u6a21\u578b\u8be6\u89e3",permalink:"/zh-cn/blog/seata-golang-communication-mode"},nextItem:{title:"\u5206\u5e03\u5f0f\u4e8b\u52a1Seata\u6e90\u7801-Client\u7aef\u542f\u52a8\u6d41\u7a0b",permalink:"/zh-cn/blog/seata-sourcecode-client-bootstrap"}},c={authorsImageUrls:[void 0]},d=[{value:"\u4ee3\u7406\u63cf\u8ff0",id:"\u4ee3\u7406\u63cf\u8ff0",level:2},{value:"\u624b\u52a8\u4ee3\u7406",id:"\u624b\u52a8\u4ee3\u7406",level:2},{value:"\u81ea\u52a8\u4ee3\u7406",id:"\u81ea\u52a8\u4ee3\u7406",level:2},{value:"\u6570\u636e\u6e90\u591a\u5c42\u4ee3\u7406",id:"\u6570\u636e\u6e90\u591a\u5c42\u4ee3\u7406",level:2},{value:"\u63d0\u4ea4\u4e1a\u52a1SQL",id:"\u63d0\u4ea4\u4e1a\u52a1sql",level:2},{value:"UNDO_LOG\u63d2\u5165",id:"undo_log\u63d2\u5165",level:2},{value:"\u5bf9\u5206\u652f\u4e8b\u52a1\u63d0\u4ea4\u7684\u5f71\u54cd",id:"\u5bf9\u5206\u652f\u4e8b\u52a1\u63d0\u4ea4\u7684\u5f71\u54cd",level:2},{value:"\u5bf9\u5206\u652f\u4e8b\u52a1\u56de\u6eda\u7684\u5f71\u54cd",id:"\u5bf9\u5206\u652f\u4e8b\u52a1\u56de\u6eda\u7684\u5f71\u54cd",level:2},{value:"\u95ee\u9898\u5206\u6790",id:"\u95ee\u9898\u5206\u6790",level:3},{value:"\u80cc\u666f",id:"\u80cc\u666f",level:2},{value:"\u9700\u6c42",id:"\u9700\u6c42",level:2},{value:"\u95ee\u9898\u73b0\u8c61",id:"\u95ee\u9898\u73b0\u8c61",level:2},{value:"\u95ee\u9898\u5206\u6790",id:"\u95ee\u9898\u5206\u6790-1",level:2},{value:"\u9a8c\u8bc1\u731c\u60f3",id:"\u9a8c\u8bc1\u731c\u60f3",level:2},{value:"\u6700\u7ec8\u5b9e\u73b0",id:"\u6700\u7ec8\u5b9e\u73b0",level:2},{value:"\u4ee3\u7801\u6539\u52a8",id:"\u4ee3\u7801\u6539\u52a8",level:2},{value:"DataSourceProxyHolder",id:"datasourceproxyholder",level:3},{value:"DataSourceProxy",id:"datasourceproxy",level:3},{value:"SeataDataSourceBeanPostProcessor",id:"seatadatasourcebeanpostprocessor",level:3},{value:"\u591a\u5c42\u4ee3\u7406\u603b\u7ed3",id:"\u591a\u5c42\u4ee3\u7406\u603b\u7ed3",level:2},{value:"\u4e0d\u4f7f\u7528<code>@Transactional</code>\u6ce8\u89e3",id:"\u4e0d\u4f7f\u7528transactional\u6ce8\u89e3",level:2},{value:"\u4f7f\u7528<code>@Transactional</code>\u6ce8\u89e3",id:"\u4f7f\u7528transactional\u6ce8\u89e3",level:2},{value:"\u7ed3\u8bba",id:"\u7ed3\u8bba",level:2}],u={toc:d},p="wrapper";function s(e){let{components:n,...a}=e;return(0,o.kt)(p,(0,t.Z)({},u,a,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"\u5728Seata1.3.0\u7248\u672c\u4e2d\uff0c\u6570\u636e\u6e90\u81ea\u52a8\u4ee3\u7406\u548c\u624b\u52a8\u4ee3\u7406\u4e00\u5b9a\u4e0d\u80fd\u6df7\u5408\u4f7f\u7528\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u591a\u5c42\u4ee3\u7406\uff0c\u4ece\u800c\u5bfc\u81f4\u4ee5\u4e0b\u95ee\u9898\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u5355\u6570\u636e\u6e90\u60c5\u51b5\u4e0b\uff1a\u5bfc\u81f4\u5206\u652f\u4e8b\u52a1\u63d0\u4ea4\u65f6\uff0cundo_log\u672c\u8eab\u4e5f\u88ab\u4ee3\u7406\uff0c\u5373",(0,o.kt)("inlineCode",{parentName:"li"},"\u4e3a undo_log \u751f\u6210\u4e86 undo_log\uff0c \u5047\u8bbe\u4e3aundo_log2"),"\uff0c\u6b64\u65f6undo_log\u5c06\u88ab\u5f53\u4f5c\u5206\u652f\u4e8b\u52a1\u6765\u5904\u7406\uff1b\u5206\u652f\u4e8b\u52a1\u56de\u6eda\u65f6\uff0c\u56e0\u4e3a",(0,o.kt)("inlineCode",{parentName:"li"},"undo_log2"),"\u751f\u6210\u7684\u6709\u95ee\u9898\uff0c\u5728",(0,o.kt)("inlineCode",{parentName:"li"},"undo_log\u5bf9\u5e94\u7684\u4e8b\u52a1\u5206\u652f"),"\u56de\u6eda\u65f6\u4f1a\u5c06",(0,o.kt)("inlineCode",{parentName:"li"},"\u4e1a\u52a1\u8868\u5173\u8054\u7684undo_log"),"\u4e5f\u4e00\u8d77\u5220\u9664\uff0c\u4ece\u800c\u5bfc\u81f4",(0,o.kt)("inlineCode",{parentName:"li"},"\u4e1a\u52a1\u8868\u5bf9\u5e94\u7684\u4e8b\u52a1\u5206\u652f"),"\u56de\u6eda\u65f6\u53d1\u73b0undo_log\u4e0d\u5b58\u5728\uff0c\u4ece\u800c\u53c8\u591a\u751f\u6210\u4e00\u6761\u72b6\u6001\u4e3a1\u7684undo_log\u3002\u8fd9\u65f6\u5019\u6574\u4f53\u903b\u8f91\u5df2\u7ecf\u4e71\u4e86\uff0c\u5f88\u4e25\u91cd\u7684\u95ee\u9898"),(0,o.kt)("li",{parentName:"ol"},"\u591a\u6570\u636e\u6e90\u548c",(0,o.kt)("inlineCode",{parentName:"li"},"\u903b\u8f91\u6570\u636e\u6e90\u88ab\u4ee3\u7406"),"\u60c5\u51b5\u4e0b\uff1a\u9664\u4e86\u5355\u6570\u636e\u6e90\u60c5\u51b5\u4e0b\u4f1a\u51fa\u73b0\u7684\u95ee\u9898\uff0c\u8fd8\u53ef\u80fd\u4f1a\u9020\u6210\u6b7b\u9501\u95ee\u9898\u3002\u6b7b\u9501\u7684\u539f\u56e0\u5c31\u662f\u9488\u5bf9undo_log\u7684\u64cd\u4f5c\uff0c\u672c\u8be5\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u6267\u884c\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"select for update")," \u548c ",(0,o.kt)("inlineCode",{parentName:"li"},"delete")," \u64cd\u4f5c\uff0c\u88ab\u5206\u6563\u5728\u591a\u4e2a\u4e8b\u52a1\u4e2d\u6267\u884c\uff0c\u5bfc\u81f4\u4e00\u4e2a\u4e8b\u52a1\u5728\u6267\u884c\u5b8c",(0,o.kt)("inlineCode",{parentName:"li"},"select for update"),"\u540e\u4e00\u76f4\u4e0d\u63d0\u4ea4\uff0c\u4e00\u4e2a\u4e8b\u52a1\u5728\u6267\u884c",(0,o.kt)("inlineCode",{parentName:"li"},"delete"),"\u65f6\u4e00\u76f4\u7b49\u5f85\u9501\uff0c\u76f4\u5230\u8d85\u65f6")),(0,o.kt)("h2",{id:"\u4ee3\u7406\u63cf\u8ff0"},"\u4ee3\u7406\u63cf\u8ff0"),(0,o.kt)("p",null,"\u5373\u5bf9DataSource\u4ee3\u7406\u4e00\u5c42\uff0c\u91cd\u5199\u4e00\u4e9b\u65b9\u6cd5\u3002\u6bd4\u5982",(0,o.kt)("inlineCode",{parentName:"p"},"getConnection"),"\u65b9\u6cd5\uff0c\u8fd9\u65f6\u4e0d\u76f4\u63a5\u8fd4\u56de\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"p"},"Connection"),"\uff0c\u800c\u662f\u8fd4\u56de",(0,o.kt)("inlineCode",{parentName:"p"},"ConnectionProxy"),"\uff0c\u5176\u5b83\u7684\u4ee5\u6b64\u7c7b\u63a8"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"// DataSourceProxy\n\npublic DataSourceProxy(DataSource targetDataSource) {\n    this(targetDataSource, DEFAULT_RESOURCE_GROUP_ID);\n}\n\nprivate void init(DataSource dataSource, String resourceGroupId) {\n    DefaultResourceManager.get().registerResource(this);\n}\n\npublic Connection getPlainConnection() throws SQLException {\n    return targetDataSource.getConnection();\n}\n\n@Override\npublic ConnectionProxy getConnection() throws SQLException {\n    Connection targetConnection = targetDataSource.getConnection();\n    return new ConnectionProxy(this, targetConnection);\n}\n")),(0,o.kt)("h2",{id:"\u624b\u52a8\u4ee3\u7406"},"\u624b\u52a8\u4ee3\u7406"),(0,o.kt)("p",null,"\u5373\u624b\u52a8\u6ce8\u5165\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceProxy"),"\uff0c\u5982\u4e0b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'@Bean\npublic DataSource druidDataSource() {\n    return new DruidDataSource()\n}\n\n@Primary\n@Bean("dataSource")\npublic DataSourceProxy dataSource(DataSource druidDataSource) {\n    return new DataSourceProxy(druidDataSource);\n}\n')),(0,o.kt)("h2",{id:"\u81ea\u52a8\u4ee3\u7406"},"\u81ea\u52a8\u4ee3\u7406"),(0,o.kt)("p",null,"\u9488\u5bf9",(0,o.kt)("inlineCode",{parentName:"p"},"DataSource"),"\u521b\u5efa\u4e00\u4e2a\u4ee3\u7406\u7c7b\uff0c\u5728\u4ee3\u7406\u7c7b\u91cc\u9762\u57fa\u4e8e",(0,o.kt)("inlineCode",{parentName:"p"},"DataSource"),"\u83b7\u53d6",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceProxy(\u5982\u679c\u6ca1\u6709\u5c31\u521b\u5efa)"),"\uff0c\u7136\u540e\u8c03\u7528",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceProxy"),"\u7684\u76f8\u5173\u65b9\u6cd5\u3002\u6838\u5fc3\u903b\u8f91\u5728",(0,o.kt)("inlineCode",{parentName:"p"},"SeataAutoDataSourceProxyCreator"),"\u4e2d"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'public class SeataAutoDataSourceProxyCreator extends AbstractAutoProxyCreator {\n    private static final Logger LOGGER = LoggerFactory.getLogger(SeataAutoDataSourceProxyCreator.class);\n    private final String[] excludes;\n    private final Advisor advisor = new DefaultIntroductionAdvisor(new SeataAutoDataSourceProxyAdvice());\n\n    public SeataAutoDataSourceProxyCreator(boolean useJdkProxy, String[] excludes) {\n        this.excludes = excludes;\n        setProxyTargetClass(!useJdkProxy);\n    }\n\n    @Override\n    protected Object[] getAdvicesAndAdvisorsForBean(Class<?> beanClass, String beanName, TargetSource customTargetSource) throws BeansException {\n        if (LOGGER.isInfoEnabled()) {\n            LOGGER.info("Auto proxy of [{}]", beanName);\n        }\n        return new Object[]{advisor};\n    }\n\n    @Override\n    protected boolean shouldSkip(Class<?> beanClass, String beanName) {\n        return SeataProxy.class.isAssignableFrom(beanClass) ||\n                DataSourceProxy.class.isAssignableFrom(beanClass) ||\n                !DataSource.class.isAssignableFrom(beanClass) ||\n                Arrays.asList(excludes).contains(beanClass.getName());\n    }\n}\n\npublic class SeataAutoDataSourceProxyAdvice implements MethodInterceptor, IntroductionInfo {\n    @Override\n    public Object invoke(MethodInvocation invocation) throws Throwable {\n        DataSourceProxy dataSourceProxy = DataSourceProxyHolder.get().putDataSource((DataSource) invocation.getThis());\n        Method method = invocation.getMethod();\n        Object[] args = invocation.getArguments();\n        Method m = BeanUtils.findDeclaredMethod(DataSourceProxy.class, method.getName(), method.getParameterTypes());\n        if (m != null) {\n            return m.invoke(dataSourceProxy, args);\n        } else {\n            return invocation.proceed();\n        }\n    }\n\n    @Override\n    public Class<?>[] getInterfaces() {\n        return new Class[]{SeataProxy.class};\n    }\n}\n')),(0,o.kt)("h2",{id:"\u6570\u636e\u6e90\u591a\u5c42\u4ee3\u7406"},"\u6570\u636e\u6e90\u591a\u5c42\u4ee3\u7406"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'@Bean\n@DependsOn("strangeAdapter")\npublic DataSource druidDataSource(StrangeAdapter strangeAdapter) {\n    doxx\n    return new DruidDataSource()\n}\n\n@Primary\n@Bean("dataSource")\npublic DataSourceProxy dataSource(DataSource druidDataSource) {\n    return new DataSourceProxy(druidDataSource);\n}\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u9996\u5148\u6211\u4eec\u5728\u914d\u7f6e\u7c7b\u91cc\u9762\u6ce8\u5165\u4e86\u4e24\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"DataSource"),"\uff0c\u5206\u522b\u4e3a\uff1a ",(0,o.kt)("inlineCode",{parentName:"li"},"DruidDataSource"),"\u548c",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\uff0c \u5176\u4e2d",(0,o.kt)("inlineCode",{parentName:"li"},"DruidDataSource \u4f5c\u4e3a DataSourceProxy \u7684 targetDataSource \u5c5e\u6027"),"\uff0c\u5e76\u4e14",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\u4e3a\u4f7f\u7528\u4e86",(0,o.kt)("inlineCode",{parentName:"li"},"@Primary"),"\u6ce8\u89e3\u58f0\u660e"),(0,o.kt)("li",{parentName:"ol"},"\u5e94\u7528\u9ed8\u8ba4\u5f00\u542f\u4e86\u6570\u636e\u6e90\u81ea\u52a8\u4ee3\u7406\uff0c\u6240\u4ee5\u5728\u8c03\u7528",(0,o.kt)("inlineCode",{parentName:"li"},"DruidDataSource"),"\u76f8\u5173\u65b9\u6cd5\u65f6\uff0c\u53c8\u4f1a\u4e3a\u4e3a",(0,o.kt)("inlineCode",{parentName:"li"},"DruidDataSource"),"\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684\u6570\u636e\u6e90\u4ee3\u7406",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy2")),(0,o.kt)("li",{parentName:"ol"},"\u5f53\u6211\u4eec\u5728\u7a0b\u5e8f\u4e2d\u60f3\u83b7\u53d6\u4e00\u4e2aConnection\u65f6\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"\u5148\u83b7\u53d6\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"DataSource"),"\uff0c\u56e0\u4e3a",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\u4e3a",(0,o.kt)("inlineCode",{parentName:"li"},"Primary"),"\uff0c\u6240\u4ee5\u6b64\u65f6\u62ff\u5230\u7684\u662f",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy")),(0,o.kt)("li",{parentName:"ol"},"\u57fa\u4e8e",(0,o.kt)("inlineCode",{parentName:"li"},"DataSource"),"\u83b7\u53d6\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"Connection"),"\uff0c\u5373\u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\u83b7\u53d6",(0,o.kt)("inlineCode",{parentName:"li"},"Connection"),"\u3002\u6b64\u65f6\u4f1a\u5148\u8c03\u7528",(0,o.kt)("inlineCode",{parentName:"li"},"targetDataSource \u5373 DruidDataSource \u7684 getConnection \u65b9\u6cd5"),"\uff0c\u4f46\u56e0\u4e3a\u5207\u9762\u4f1a\u5bf9",(0,o.kt)("inlineCode",{parentName:"li"},"DruidDataSource"),"\u8fdb\u884c\u62e6\u622a\uff0c\u6839\u636e\u6b65\u9aa42\u7684\u62e6\u622a\u903b\u8f91\u53ef\u4ee5\u77e5\u9053\uff0c\u6b64\u65f6\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy2"),"\uff0c\u7136\u540e\u8c03\u7528",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy2#getConnection"),"\uff0c\u7136\u540e\u518d\u8c03\u7528",(0,o.kt)("inlineCode",{parentName:"li"},"DruidDataSource#getConnection"),"\u3002\u6700\u7ec8\u5f62\u6210\u4e86\u53cc\u5c42\u4ee3\u7406\uff0c \u8fd4\u56de\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"Connection"),"\u4e5f\u662f\u4e00\u4e2a\u53cc\u5c42\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"ConnectionProxy"))))),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ac0b91bd8fc4c48aa68afd5c58a42d5~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,o.kt)("p",null,"\u4e0a\u9762\u5176\u5b9e\u662f\u6539\u9020\u4e4b\u540e\u7684\u4ee3\u7406\u903b\u8f91\uff0cSeata\u9ed8\u8ba4\u7684\u81ea\u52a8\u4ee3\u7406\u4f1a\u5bf9",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceProxy"),"\u518d\u6b21\u8fdb\u884c\u4ee3\u7406\uff0c\u540e\u679c\u5c31\u662f\u4ee3\u7406\u591a\u4e86\u4e00\u5c42\u6b64\u65f6\u5bf9\u5e94\u7684\u56fe\u5982\u4e0b"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/837aa0462d994e9a8614707c6a50b5ae~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,o.kt)("p",null,"\u6570\u636e\u6e90\u591a\u5c42\u4ee3\u7406\u4f1a\u5bfc\u81f4\u7684\u4e24\u4e2a\u95ee\u9898\u5728\u6587\u7ae0\u5f00\u5934\u5904\u5df2\u7ecf\u603b\u7ed3\u4e86\uff0c\u4e0b\u9762\u4f1a\u6709\u6848\u4f8b\u4ecb\u7ecd\u3002"),(0,o.kt)("h1",{id:"\u5206\u652f\u4e8b\u52a1\u63d0\u4ea4"},"\u5206\u652f\u4e8b\u52a1\u63d0\u4ea4"),(0,o.kt)("p",null,"\u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"p"},"ConnectionProxy"),"\u4e2d\u6267\u884c\u5bf9\u5e94\u7684\u65b9\u6cd5\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f\u4ee5update\u64cd\u4f5c\u6d89\u53ca\u5230\u7684\u4e00\u4e2a\u5206\u652f\u4e8b\u52a1\u63d0\u4ea4\u4e3a\u4f8b\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u6267\u884c",(0,o.kt)("inlineCode",{parentName:"li"},"ConnectionProxy#prepareStatement"),"\uff0c \u8fd4\u56de\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"PreparedStatementProxy")),(0,o.kt)("li",{parentName:"ol"},"\u6267\u884c",(0,o.kt)("inlineCode",{parentName:"li"},"PreparedStatementProxy#executeUpdate"),"\uff0c",(0,o.kt)("inlineCode",{parentName:"li"},"PreparedStatementProxy#executeUpdate"),"\u5927\u6982\u4f1a\u5e2e\u505a\u4e24\u4ef6\u4e8b\u60c5: \u6267\u884c\u4e1a\u52a1SQL\u548c\u63d0\u4ea4undo_log")),(0,o.kt)("h2",{id:"\u63d0\u4ea4\u4e1a\u52a1sql"},"\u63d0\u4ea4\u4e1a\u52a1SQL"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"// ExecuteTemplate#execute\nif (sqlRecognizers.size() == 1) {\n    SQLRecognizer sqlRecognizer = sqlRecognizers.get(0);\n    switch (sqlRecognizer.getSQLType()) {\n        case INSERT:\n            executor = EnhancedServiceLoader.load(InsertExecutor.class, dbType,\n                    new Class[]{StatementProxy.class, StatementCallback.class, SQLRecognizer.class},\n                    new Object[]{statementProxy, statementCallback, sqlRecognizer});\n            break;\n        case UPDATE:\n            executor = new UpdateExecutor<>(statementProxy, statementCallback, sqlRecognizer);\n            break;\n        case DELETE:\n            executor = new DeleteExecutor<>(statementProxy, statementCallback, sqlRecognizer);\n            break;\n        case SELECT_FOR_UPDATE:\n            executor = new SelectForUpdateExecutor<>(statementProxy, statementCallback, sqlRecognizer);\n            break;\n        default:\n            executor = new PlainExecutor<>(statementProxy, statementCallback);\n            break;\n    }\n} else {\n    executor = new MultiExecutor<>(statementProxy, statementCallback, sqlRecognizers);\n}\n")),(0,o.kt)("p",null,"\u4e3b\u8981\u6d41\u7a0b\u5c31\u662f\uff1a \u5148\u6267\u884c\u4e1a\u52a1SQL\uff0c\u7136\u540e\u6267\u884cConnectionProxy\u7684commit\u65b9\u6cd5\uff0c\u5728\u8fd9\u4e2a\u65b9\u6cd5\u4e2d\uff0c\u4f1a\u5148\u5e2e\u6211\u4eec\u6267\u884c\u5bf9\u5e94\u7684 undo_log SQL\uff0c\u7136\u540e\u63d0\u4ea4\u4e8b\u52a1"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"PreparedStatementProxy#executeUpdate => \nExecuteTemplate#execute => \nBaseTransactionalExecutor#execute =>\nAbstractDMLBaseExecutor#doExecute =>\nAbstractDMLBaseExecutor#executeAutoCommitTrue => \nAbstractDMLBaseExecutor#executeAutoCommitFalse => \u5728\u8fd9\u4e00\u6b65\u64cd\u4e2d\uff0c\u4f1a\u89e6\u53d1statementCallback#execute\u65b9\u6cd5\uff0c\u5373\u8c03\u7528\u8c03\u7528\u539f\u751fPreparedStatement#executeUpdate\u65b9\u6cd5\nConnectionProxy#commit\nConnectionProxy#processGlobalTransactionCommit\n")),(0,o.kt)("h2",{id:"undo_log\u63d2\u5165"},"UNDO_LOG\u63d2\u5165"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'// ConnectionProxy#processGlobalTransactionCommit\nprivate void processGlobalTransactionCommit() throws SQLException {\n    try {\n        // \u6ce8\u518c\u5206\u652f\u4e8b\u52a1\uff0c\u7b80\u5355\u7406\u89e3\u5411server\u53d1\u4e00\u4e2a\u8bf7\u6c42\uff0c\u7136\u540eserver\u5728branch_table\u8868\u91cc\u63d2\u5165\u4e00\u6761\u8bb0\u5f55\uff0c\u4e0d\u5173\u6ce8\n        register();\n    } catch (TransactionException e) {\n        // \u5982\u679c\u6ca1\u6709for update \u7684sql,\u4f1a\u76f4\u63a5\u5728commit\u4e4b\u524d\u505a\u6ce8\u518c,\u6b64\u65f6\u4e0d\u6b62\u63d2\u5165\u4e00\u6761branch\u8bb0\u5f55,\u800c\u4f1a\u9644\u5e26\u9501\u4fe1\u606f\u8fdb\u884c\u7ade\u4e89,\u4e0b\u65b9\u7684\u5f02\u5e38\u4e00\u822c\u5c31\u662f\u5728\u6ce8\u518c\u65f6\u6ca1\u62ff\u5230\u9501\u629b\u51fa,\u4e00\u822c\u5c31\u662f\u7eafupdate\u8bed\u53e5\u7684\u5e76\u53d1\u4e0b\u4f1a\u89e6\u53d1\u7ade\u4e89\u9501\u5931\u8d25\u7684\u5f02\u5e38 @FUNKYE\n        recognizeLockKeyConflictException(e, context.buildLockKeys());\n    }\n    try {\n        // undo_log\u5904\u7406\uff0c\u671f\u671b\u7528 targetConnection \u5904\u7406           @1\n        UndoLogManagerFactory.getUndoLogManager(this.getDbType()).flushUndoLogs(this);\n\n        // \u63d0\u4ea4\u672c\u5730\u4e8b\u52a1\uff0c\u671f\u671b\u7528 targetConnection \u5904\u7406             @2\n        targetConnection.commit();\n    } catch (Throwable ex) {\n        LOGGER.error("process connectionProxy commit error: {}", ex.getMessage(), ex);\n        report(false);\n        throw new SQLException(ex);\n    }\n    if (IS_REPORT_SUCCESS_ENABLE) {\n        report(true);\n    }\n    context.reset();\n}\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"undo_log\u5904\u7406@1\uff0c\u89e3\u6790\u5f53\u524d\u4e8b\u52a1\u5206\u652f\u6d89\u53ca\u5230\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"undo_log"),"\uff0c\u7136\u540e\u4f7f\u7528",(0,o.kt)("inlineCode",{parentName:"li"},"TargetConnection"),"\uff0c \u5199\u5230\u6570\u636e\u5e93")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'public void flushUndoLogs(ConnectionProxy cp) throws SQLException {\n    ConnectionContext connectionContext = cp.getContext();\n    if (!connectionContext.hasUndoLog()) {\n        return;\n    }\n\n    String xid = connectionContext.getXid();\n    long branchId = connectionContext.getBranchId();\n\n    BranchUndoLog branchUndoLog = new BranchUndoLog();\n    branchUndoLog.setXid(xid);\n    branchUndoLog.setBranchId(branchId);\n    branchUndoLog.setSqlUndoLogs(connectionContext.getUndoItems());\n\n    UndoLogParser parser = UndoLogParserFactory.getInstance();\n    byte[] undoLogContent = parser.encode(branchUndoLog);\n\n    if (LOGGER.isDebugEnabled()) {\n        LOGGER.debug("Flushing UNDO LOG: {}", new String(undoLogContent, Constants.DEFAULT_CHARSET));\n    }\n\n    insertUndoLogWithNormal(xid, branchId, buildContext(parser.getName()), undoLogContent,cp.getTargetConnection());\n}\n')),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"\u63d0\u4ea4\u672c\u5730\u4e8b\u52a1@2\uff0c\u5373\u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"li"},"TargetConnection"),"\u63d0\u4ea4\u4e8b\u52a1\u3002\u5373 ",(0,o.kt)("inlineCode",{parentName:"li"},"\u52a1SQL\u6267\u884c"),"\u3001",(0,o.kt)("inlineCode",{parentName:"li"},"undo_log\u5199\u5165"),"\u3001",(0,o.kt)("inlineCode",{parentName:"li"},"\u5373\u4e8b\u52a1\u63d0\u4ea4")," \u7528\u7684\u90fd\u662f\u540c\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"TargetConnection"))),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"lcn\u7684\u5185\u7f6e\u6570\u636e\u5e93\u65b9\u6848,lcn\u662f\u5c06undolog\u5199\u5230\u4ed6\u5185\u5d4c\u7684h2(\u5fd8\u4e86\u662f\u4e0d\u662f\u8fd9\u4e2a\u6765\u7740\u4e86)\u6570\u636e\u5e93\u4e0a,\u6b64\u65f6\u4f1a\u53d8\u62102\u4e2a\u672c\u5730\u4e8b\u52a1,\u4e00\u4e2a\u662fh2\u7684undolog\u63d2\u5165\u4e8b\u52a1,\u4e00\u4e2a\u662f\u4e1a\u52a1\u6570\u636e\u5e93\u7684\u4e8b\u52a1,\u5982\u679c\u5728h2\u63d2\u5165\u540e,\u4e1a\u52a1\u6570\u636e\u5e93\u5f02\u5e38,lcn\u7684\u65b9\u6848\u5c31\u4f1a\u51fa\u73b0\u6570\u636e\u5197\u4f59,\u56de\u6eda\u6570\u636e\u7684\u65f6\u5019\u4e5f\u662f\u4e00\u6837,\u5220\u9664undolog\u8ddf\u56de\u6eda\u4e1a\u52a1\u6570\u636e\u4e0d\u662f\u4e00\u4e2a\u672c\u5730\u4e8b\u52a1.\n\u4f46\u662flcn\u8fd9\u6837\u7684\u597d\u5904\u5c31\u662f\u5165\u4fb5\u5c0f,\u4e0d\u9700\u8981\u53e6\u5916\u6dfb\u52a0undolog\u8868\u3002 \u611f\u8c22@FUNKYE\u5927\u4f6c\u7ed9\u7684\u5efa\u8bae\uff0c\u5bf9lcn\u4e0d\u592a\u4e86\u89e3\uff0c\u6709\u673a\u4f1a\u597d\u597d\u7814\u7a76\u4e00\u4e0b")),(0,o.kt)("h1",{id:"\u5206\u652f\u4e8b\u52a1\u56de\u6eda"},"\u5206\u652f\u4e8b\u52a1\u56de\u6eda"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Server\u7aef\u5411Client\u7aef\u53d1\u9001\u56de\u6eda\u8bf7\u6c42"),(0,o.kt)("li",{parentName:"ol"},"Client\u7aef\u63a5\u6536\u5230Server\u53d1\u8fc7\u6765\u7684\u8bf7\u6c42\uff0c\u7ecf\u8fc7\u4e00\u7cfb\u5217\u5904\u7406\uff0c\u6700\u7ec8\u4f1a\u5230",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceManager#branchRollback"),"\u65b9\u6cd5"),(0,o.kt)("li",{parentName:"ol"},"\u5148\u6839\u636eresourceId\u4ece",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceManager.dataSourceCache"),"\u4e2d\u83b7\u53d6\u5bf9\u5e94\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\uff0c\u6b64\u65f6\u4e3a",(0,o.kt)("inlineCode",{parentName:"li"},"masterSlaveProxy"),"(\u56de\u6eda\u9636\u6bb5\u6211\u4eec\u5c31\u4e0d\u8003\u4ee3\u7406\u6570\u636e\u6e90\u95ee\u9898\uff0c\u7b80\u5355\u76f4\u63a5\u4e00\u4e9b\uff0c\u53cd\u6b63\u6700\u7ec8\u62ff\u5230\u7684\u90fd\u662f",(0,o.kt)("inlineCode",{parentName:"li"},"TragetConnection"),")"),(0,o.kt)("li",{parentName:"ol"},"\u6839\u636eServer\u7aef\u53d1\u8fc7\u6765\u7684xid\u548cbranchId\u67e5\u627e\u5bf9\u5e94\u7684undo_log\u5e76\u89e3\u6790\u5176",(0,o.kt)("inlineCode",{parentName:"li"},"rollback_info"),"\u5c5e\u6027\uff0c\u6bcf\u6761undo_log\u53ef\u80fd\u4f1a\u89e3\u6790\u51fa\u591a\u6761",(0,o.kt)("inlineCode",{parentName:"li"},"SQLUndoLog"),",\u6bcf\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"SQLUndoLog"),"\u53ef\u4ee5\u7406\u89e3\u6210\u662f\u4e00\u4e2a\u64cd\u4f5c\u3002\u6bd4\u5982\u4e00\u4e2a\u5206\u652f\u4e8b\u52a1\u5148\u66f4\u65b0A\u8868\uff0c\u518d\u66f4\u65b0B\u8868\uff0c\u8fd9\u65f6\u5019\u9488\u5bf9\u8be5\u5206\u652f\u4e8b\u52a1\u751f\u6210\u7684undo_log\u5c31\u5305\u542b\u4e24\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"SQLUndoLog"),"\uff1a\u7b2c\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"SQLUndoLog"),"\u5bf9\u5e94\u7684\u662f\u66f4\u65b0A\u8868\u7684\u524d\u540e\u5feb\u7167\uff1b\u7b2c\u4e8c\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"SQLUndoLog"),"\u5bf9\u5e94\u7684\u662f\u66f4\u65b0B\u8868\u7684\u524d\u540e\u5feb\u7167"),(0,o.kt)("li",{parentName:"ol"},"\u9488\u5bf9\u6bcf\u6761",(0,o.kt)("inlineCode",{parentName:"li"},"SQLUndoLog"),"\u6267\u884c\u5bf9\u5e94\u7684\u56de\u6eda\u64cd\u4f5c\uff0c\u6bd4\u5982\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"SQLUndoLog"),"\u5bf9\u5e94\u7684\u64cd\u4f5c\u662f",(0,o.kt)("inlineCode",{parentName:"li"},"INSERT"),"\uff0c\u5219\u5176\u5bf9\u5e94\u7684\u56de\u6eda\u64cd\u4f5c\u5c31\u662f",(0,o.kt)("inlineCode",{parentName:"li"},"DELETE")),(0,o.kt)("li",{parentName:"ol"},"\u6839\u636exid\u548cbranchId\u5220\u9664\u8be5undo_log")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'// AbstractUndoLogManager#undo   \u5220\u9664\u4e86\u90e8\u5206\u975e\u5173\u952e\u4ee3\u7801\n\npublic void undo(DataSourceProxy dataSourceProxy, String xid, long branchId) throws TransactionException {\n    Connection conn = null;\n    ResultSet rs = null;\n    PreparedStatement selectPST = null;\n    boolean originalAutoCommit = true;\n\n    for (; ; ) {\n        try {\n            // \u83b7\u53d6\u539f\u751f\u6570\u636e\u6e90\u7684Connection, \u56de\u6eda\u9636\u6bb5\u6211\u4eec\u4e0d\u7ba1\u4ee3\u7406\u6570\u636e\u6e90\u95ee\u9898\uff0c\u6700\u7ec8\u62ff\u5230\u7684\u90fd\u662f TargetConnection\n            conn = dataSourceProxy.getPlainConnection();\n\n            // \u5c06\u56de\u6eda\u64cd\u4f5c\u653e\u5728\u4e00\u4e2a\u672c\u5730\u4e8b\u52a1\u4e2d\uff0c\u624b\u52a8\u63d0\u4ea4\uff0c\u786e\u4fdd\u6700\u7ec8\u4e1a\u52a1SQL\u64cd\u4f5c\u548cundo_log\u5220\u9664\u64cd\u4f5c\u4e00\u8d77\u63d0\u4ea4\n            if (originalAutoCommit = conn.getAutoCommit()) {\n                conn.setAutoCommit(false);\n            }\n\n            // \u6839\u636exid \u548c branchId \u67e5\u8be2 undo_log\uff0c\u6ce8\u610f\u6b64\u65f6\u7684SQL\u8bed\u53e5  SELECT * FROM undo_log WHERE branch_id = ? AND xid = ? FOR UPDATE\n            selectPST = conn.prepareStatement(SELECT_UNDO_LOG_SQL);\n            selectPST.setLong(1, branchId);\n            selectPST.setString(2, xid);\n            rs = selectPST.executeQuery();\n\n            boolean exists = false;\n            while (rs.next()) {\n                exists = true;\n                // status == 1 undo_log\u4e0d\u5904\u7406\uff0c\u548c\u9632\u60ac\u6302\u76f8\u5173\n                if (!canUndo(state)) {\n                    return;\n                }\n\n                // \u89e3\u6790undo_log\n                byte[] rollbackInfo = getRollbackInfo(rs);\n                BranchUndoLog branchUndoLog = UndoLogParserFactory.getInstance(serializer).decode(rollbackInfo);\n                try {\n                    setCurrentSerializer(parser.getName());\n                    List<SQLUndoLog> sqlUndoLogs = branchUndoLog.getSqlUndoLogs();\n                    if (sqlUndoLogs.size() > 1) {\n                        Collections.reverse(sqlUndoLogs);\n                    }\n                    for (SQLUndoLog sqlUndoLog : sqlUndoLogs) {\n                        AbstractUndoExecutor undoExecutor = UndoExecutorFactory.getUndoExecutor(dataSourceProxy.getDbType(), sqlUndoLog);\n                        // \u6267\u884c\u5bf9\u5e94\u7684\u56de\u6eda\u64cd\u4f5c\n                        undoExecutor.executeOn(conn);\n                    }\n                } \n            }\n\n            // \n            if (exists) {\n                LOGGER.error("\\n delete from undo_log where xid={} AND branchId={} \\n", xid, branchId);\n                deleteUndoLog(xid, branchId, conn);\n                conn.commit();\n            // \u548c\u9632\u60ac\u6302\u76f8\u5173 \u5982\u679c\u6839\u636e xid\u548cbranchId \u6ca1\u6709\u67e5\u5230undo_log\uff0c\u8bf4\u660e\u8fd9\u4e2a\u5206\u652f\u4e8b\u52a1\u6709\u5f02\u5e38\uff1a\u4f8b\u5982\u4e1a\u52a1\u5904\u7406\u8d85\u65f6\uff0c\u5bfc\u81f4\u5168\u5c40\u4e8b\u52a1\u56de\u6eda\uff0c\u4f46\u8fd9\u65f6\u5019\u4e1a\u52a1undo_log\u5e76\u6ca1\u6709\u63d2\u5165\n            } else {\n                LOGGER.error("\\n insert into undo_log xid={},branchId={} \\n", xid, branchId);\n                insertUndoLogWithGlobalFinished(xid, branchId, UndoLogParserFactory.getInstance(), conn);\n                conn.commit();\n            }\n            return;\n        } catch (Throwable e) {\n            throw new BranchTransactionException(BranchRollbackFailed_Retriable, String\n                .format("Branch session rollback failed and try again later xid = %s branchId = %s %s", xid,branchId, e.getMessage()), e);\n        }\n    }\n}\n')),(0,o.kt)("p",null,"\u6709\u4ee5\u4e0b\u51e0\u4e2a\u6ce8\u610f\u70b9\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u56de\u6eda\u65f6\u4e0d\u8003\u8651\u6570\u636e\u6e90\u4ee3\u7406\u95ee\u9898\uff0c\u6700\u7ec8\u90fd\u662f\u4f7f\u7528",(0,o.kt)("inlineCode",{parentName:"li"},"TargetConnection")),(0,o.kt)("li",{parentName:"ol"},"\u8bbe\u7f6eatuoCommit\u4e3afalse\uff0c\u5373\u9700\u8981\u624b\u52a8\u63d0\u4ea4\u4e8b\u52a1"),(0,o.kt)("li",{parentName:"ol"},"\u6839\u636exid\u548cbranchId\u67e5\u8be2undo_log\u65f6\u52a0\u4e86",(0,o.kt)("inlineCode",{parentName:"li"},"for update"),"\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u4f1a\u6301\u6709\u8fd9\u6761undo_log\u7684\u9501\u76f4\u5230\u6240\u6709\u56de\u6eda\u64cd\u4f5c\u90fd\u5b8c\u6210\uff0c\u56e0\u4e3a\u5b8c\u6210\u4e4b\u540e\u624d\u4f1a")),(0,o.kt)("h1",{id:"\u591a\u5c42\u4ee3\u7406\u95ee\u9898"},"\u591a\u5c42\u4ee3\u7406\u95ee\u9898"),(0,o.kt)("p",null,"\u6570\u636e\u6e90\u591a\u5c42\u4ee3\u7406\u4f1a\u5bfc\u81f4\u7684\u51e0\u4e2a\u95ee\u9898\u5728\u6587\u7ae0\u5f00\u5934\u7684\u65f6\u5019\u5df2\u7ecf\u63d0\u5230\u8fc7\u4e86\uff0c\u91cd\u70b9\u5206\u6790\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u4f1a\u9020\u6210\u4ee5\u4e0a\u95ee\u9898\uff1a"),(0,o.kt)("h2",{id:"\u5bf9\u5206\u652f\u4e8b\u52a1\u63d0\u4ea4\u7684\u5f71\u54cd"},"\u5bf9\u5206\u652f\u4e8b\u52a1\u63d0\u4ea4\u7684\u5f71\u54cd"),(0,o.kt)("p",null,"\u5148\u5206\u6790\u4e00\u4e0b\uff0c\u5982\u679c\u4f7f\u7528\u53cc\u5c42\u4ee3\u7406\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f\u6211\u4eec\u4ece\u4e24\u4e2a\u65b9\u9762\u6765\u5206\u6790\uff1a",(0,o.kt)("inlineCode",{parentName:"p"},"\u4e1a\u52a1SQL"),"\u548c",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u4e1a\u52a1SQL")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"PreparedStatementProxy1.executeUpdate => \nstatementCallback#executeUpdate(PreparedStatementProxy2#executeUpdate) => \nPreparedStatement#executeUpdate\n")),(0,o.kt)("p",null,"\u597d\u50cf\u6ca1\u5565\u5f71\u54cd\uff0c\u5c31\u662f\u591a\u7ed5\u4e86\u4e00\u5708\uff0c\u6700\u7ec8\u8fd8\u662f\u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"p"},"PreparedStatement"),"\u6267\u884c"),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"undo_log")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"ConnectionProxy1#getTargetConnection -> \nConnectionProxy2#prepareStatement -> \nPreparedStatementProxy2#executeUpdate -> \nPreparedStatement#executeUpdate(\u539f\u751f\u7684undo_log\u5199\u5165\uff0c\u5728\u6b64\u4e4b\u524d\u4f1a\u5bf9\u4e3a\u8be5 undo_log \u751f\u6210 undo_log2(\u5373 undo_log \u7684 undo_log)) ->\nConnectionProxy2#commit -> \nConnectionProxy2#processGlobalTransactionCommit(\u5199\u5165undo_log2) ->\nConnectionProxy2#getTargetConnection ->\nTargetConnection#prepareStatement ->\nPreparedStatement#executeUpdate\n")),(0,o.kt)("h2",{id:"\u5bf9\u5206\u652f\u4e8b\u52a1\u56de\u6eda\u7684\u5f71\u54cd"},"\u5bf9\u5206\u652f\u4e8b\u52a1\u56de\u6eda\u7684\u5f71\u54cd"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u5728\u4e8b\u52a1\u56de\u6eda\u4e4b\u540e\uff0c\u4e3a\u4f55undo_log\u6ca1\u6709\u88ab\u5220\u9664\u5462\uff1f")),(0,o.kt)("p",null,"\u5176\u5b9e\u5e76\u4e0d\u662f\u6ca1\u6709\u88ab\u5220\u9664\u3002\u524d\u9762\u5df2\u7ecf\u8bf4\u8fc7\uff0c\u53cc\u5c42\u4ee3\u7406\u4f1a\u5bfc\u81f4",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log"),"\u88ab\u5f53\u4f5c\u5206\u652f\u4e8b\u52a1\u6765\u5904\u7406\uff0c\u6240\u4ee5\u4e5f\u4f1a\u4e3a\u8be5 ",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log"),"\u751f\u6210\u4e00\u4e2aundo_log(\u5047\u8bbe\u4e3a",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log2"),"),\u800c",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log2"),"\u751f\u6210\u7684\u6709\u95ee\u9898(\u5176\u5b9e\u4e5f\u6ca1\u95ee\u9898\uff0c\u5c31\u5e94\u8be5\u8fd9\u6837\u751f\u6210)\uff0c\u4ece\u800c\u5bfc\u81f4\u56de\u6eda\u65f6\u4f1a\u5c06",(0,o.kt)("inlineCode",{parentName:"p"},"\u4e1a\u52a1\u8868\u5173\u8054\u7684undo_log"),"\u4e5f\u4e00\u8d77\u5220\u9664\uff0c\u6700\u7ec8\u5bfc\u81f4",(0,o.kt)("inlineCode",{parentName:"p"},"\u4e1a\u52a1\u8868\u5bf9\u5e94\u7684\u4e8b\u52a1\u5206\u652f"),"\u56de\u6eda\u65f6\u53d1\u73b0undo_log\u4e0d\u5b58\u5728\uff0c\u4ece\u800c\u53c8\u591a\u751f\u6210\u4e00\u6761\u72b6\u6001\u4e3a\u4e3a1\u7684undo_log"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"\u56de\u6eda\u4e4b\u524d")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"// undo_log\n84  59734070967644161   172.16.120.59:23004:59734061438185472 serializer=jackson 1.1KB  0\n85  59734075254222849   172.16.120.59:23004:59734061438185472 serializer=jackson 4.0KB  0\n\n// branch_table\n59734070967644161   172.16.120.59:23004:59734061438185472       jdbc:mysql://172.16.248.10:3306/tuya_middleware\n59734075254222849   172.16.120.59:23004:59734061438185472       jdbc:mysql://172.16.248.10:3306/tuya_middleware\n\n// lock_table\njdbc:mysql://xx^^^seata_storage^^^1 59734070967644161   jdbc:mysql://172.16.248.10:3306/tuya_middleware seata_storage     1\njdbc:mysql://xx^^^undo_log^^^84     59734075254222849   jdbc:mysql://172.16.248.10:3306/tuya_middleware undo_log          84\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"\u56de\u6eda\u4e4b\u540e")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"// \u751f\u6210\u4e86\u4e00\u6761\u72b6\u6001\u4e3a1\u7684undo_log\uff0c\u5bf9\u5e94\u7684\u65e5\u5fd7\u4e3a: undo_log added with GlobalFinished\n86  59734070967644161   172.16.120.59:23004:59734061438185472 serializer=jackson 1.0Byte  1\n")),(0,o.kt)("h3",{id:"\u95ee\u9898\u5206\u6790"},"\u95ee\u9898\u5206\u6790"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u6839\u636exid\u548cbranchId\u627e\u5230\u5bf9\u5e94\u7684undo_log\u65e5\u5fd7"),(0,o.kt)("li",{parentName:"ol"},"\u5bf9undo_log\u8fdb\u884c\u89e3\u6790\uff0c\u4e3b\u8981\u5c31\u662f\u89e3\u6790\u5b83\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"rollback_info"),"\u5b57\u6bb5\uff0c",(0,o.kt)("inlineCode",{parentName:"li"},"rollback_info"),"\u89e3\u6790\u51fa\u6765\u5c31\u662f\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"SQLUndoLog\u96c6\u5408"),"\uff0c\u6bcf\u6761",(0,o.kt)("inlineCode",{parentName:"li"},"SQLUndoLog"),"\u5bf9\u5e94\u7740\u4e00\u4e2a\u64cd\u4f5c\uff0c\u91cc\u9762\u5305\u542b\u4e86\u8be5\u64cd\u4f5c\u7684\u524d\u540e\u7684\u5feb\u7167\uff0c\u7136\u540e\u6267\u884c\u5bf9\u5e94\u7684\u56de\u6eda"),(0,o.kt)("li",{parentName:"ol"},"\u6839\u636exid\u548cbranchId\u5220\u9664undo_log\u65e5\u5fd7")),(0,o.kt)("p",null,"\u56e0\u4e3a\u53cc\u5c42\u4ee3\u7406\u95ee\u9898\uff0c\u5bfc\u81f4\u4e00\u6761undo_log\u53d8\u6210\u4e86\u4e00\u4e2a\u5206\u652f\u4e8b\u52a1\uff0c\u6240\u4ee5\u53d1\u751f\u56de\u6eda\u65f6\uff0c\u6211\u4eec\u4e5f\u9700\u8981\u5bf9undo_log\u5206\u652f\u4e8b\u52a1\u8fdb\u884c\u56de\u6eda\uff1a\n1\u3001\u9996\u5148\u6839\u636exid\u548cbranchId\u627e\u5230\u5bf9\u5e94\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log"),"\u5e76\u89e3\u6790\u5176",(0,o.kt)("inlineCode",{parentName:"p"},"rollback_info"),"\u5c5e\u6027\uff0c\u8fd9\u91cc\u89e3\u6790\u51fa\u6765\u7684rollback_info\u5305\u542b\u4e86\u4e24\u6761",(0,o.kt)("inlineCode",{parentName:"p"},"SQLUndoLog"),"\u3002\u4e3a\u4ec0\u4e48\u6709\u4e24\u6761\uff1f"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u4ed4\u7ec6\u60f3\u60f3\u4e5f\u53ef\u4ee5\u53ef\u4ee5\u7406\u89e3\uff0c\u7b2c\u4e00\u5c42\u4ee3\u7406\u9488\u5bf9",(0,o.kt)("inlineCode",{parentName:"p"},"seata_storage"),"\u7684\u64cd\u4f5c\uff0c\u653e\u5230\u7f13\u5b58\u4e2d\uff0c\u672c\u6765\u6267\u884c\u5b8c\u4e4b\u540e\u662f\u9700\u8981\u6e05\u6389\u7684\uff0c\u4f46\u56e0\u4e3a\u8fd9\u91cc\u662f\u53cc\u5c42\u4ee3\u7406\uff0c\u6240\u4ee5\u8fd9\u65f6\u5019\u8fd9\u4e2a\u6d41\u7a0b\u5e76\u6ca1\u6709\u7ed3\u675f\u3002\u8f6e\u5230\u7b2c\u4e8c\u5c42\u4ee3\u7406\u5bf9",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log"),"\u64cd\u4f5c\u65f6\uff0c\u5c06\u8be5\u64cd\u4f5c\u653e\u5230\u7f13\u5b58\u4e2d\uff0c\u6b64\u65f6\u7f13\u5b58\u4e2d\u6709\u4e24\u4e2a\u64cd\u4f5c\uff0c\u5206\u522b\u4e3a",(0,o.kt)("inlineCode",{parentName:"p"},"seata_storage\u7684UPDATE")," \u548c ",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log\u7684INSERT"),"\u3002\u6240\u4ee5\u8fd9\u4e5f\u5c31\u5f88\u597d\u7406\u89e3\u4e3a\u4ec0\u4e48\u9488\u5bf9",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log\u64cd\u4f5c"),"\u7684\u90a3\u6761undo_log\u683c\u5916\u5927(4KB)\uff0c\u56e0\u4e3a\u5b83\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"rollback_info"),"\u5305\u542b\u4e86\u4e24\u4e2a\u64cd\u4f5c\u3002")),(0,o.kt)("p",null,"\u6709\u4e00\u70b9\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7b2c\u4e00\u6761",(0,o.kt)("inlineCode",{parentName:"p"},"SQLUndoLog"),"\u5bf9\u5e94\u7684after\u5feb\u7167\uff0c\u91cc\u9762\u7684branchId=",(0,o.kt)("inlineCode",{parentName:"p"},"59734070967644161")," pk=",(0,o.kt)("inlineCode",{parentName:"p"},"84"),"\uff0c \u5373 ",(0,o.kt)("inlineCode",{parentName:"p"},"seata_storage\u5206\u652f\u5bf9\u5e94\u7684branchId"),"  \u548c ",(0,o.kt)("inlineCode",{parentName:"p"},"seata_storage\u5bf9\u5e94\u7684undo_log PK"),"\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cundo_log\u56de\u6eda\u65f6\u5019 \u628a",(0,o.kt)("inlineCode",{parentName:"p"},"seata_storage\u5bf9\u5e94\u7684undo_log"),"\u5220\u6389\u4e86\u3002\n\u90a3undo_log\u672c\u8eab\u5bf9\u5e94\u7684undo_log \u5982\u4f55\u5220\u9664\u5462\uff1f\u5728\u63a5\u4e0b\u6765\u7684\u903b\u8f91\u4e2d\u4f1a\u6839\u636exid\u548cbranchId\u5220\u9664"),(0,o.kt)("p",null,"2\u3001\u89e3\u6790\u7b2c\u4e00\u6761",(0,o.kt)("inlineCode",{parentName:"p"},"SQLUndoLog"),"\uff0c\u6b64\u65f6\u5bf9\u5e94\u7684\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log\u7684INSERT"),"\u64cd\u4f5c\uff0c\u6240\u4ee5\u5176\u5bf9\u5e94\u7684\u56de\u6eda\u64cd\u4f5c\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"DELETE"),"\u3002\u56e0\u4e3a",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log"),"\u6b64\u65f6\u88ab\u5f53\u4f5c\u4e86\u4e1a\u52a1\u8868\u3002\u6240\u4ee5\u8fd9\u4e00\u6b65\u4f1a\u5c06",(0,o.kt)("inlineCode",{parentName:"p"},"59734075254222849"),"\u5bf9\u5e94\u7684undo_log\u5220\u9664\uff0c",(0,o.kt)("strong",{parentName:"p"},"\u4f46\u8fd9\u4e2a\u5176\u5b9e\u662f\u4e1a\u52a1\u8868\u5bf9\u5e94\u7684\u5bf9\u5e94\u7684",(0,o.kt)("inlineCode",{parentName:"strong"},"undo_log"))),(0,o.kt)("p",null,"3\u3001\u89e3\u6790\u7b2c\u4e8c\u6761",(0,o.kt)("inlineCode",{parentName:"p"},"SQLUndoLog"),"\uff0c\u6b64\u65f6\u5bf9\u5e94\u7684\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"seata_storage\u7684UPDATE"),"\u64cd\u4f5c\uff0c\u8fd9\u65f6\u4f1a\u901a\u8fc7\u5feb\u7167\u5c06",(0,o.kt)("inlineCode",{parentName:"p"},"seata_storage"),"\u5bf9\u5e94\u7684\u8bb0\u5f55\u6062\u590d"),(0,o.kt)("p",null,"4\u3001\u6839\u636exid\u548cbranchId\u5220\u9664undo_log\u65e5\u5fd7\uff0c\u8fd9\u91cc\u5220\u9664\u7684\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"undo_log \u7684 undo_log , \u5373 undo_log2"),"\u3002\u6240\u4ee5\uff0c\u6267\u884c\u5230\u8fd9\u91cc\uff0c\u4e24\u6761undo_log\u5c31\u5df2\u7ecf\u88ab\u5220\u9664\u4e86"),(0,o.kt)("p",null,"5\u3001\u63a5\u4e0b\u6765\u56de\u6eda",(0,o.kt)("inlineCode",{parentName:"p"},"seata_storage"),"\uff0c\u56e0\u4e3a\u8fd9\u65f6\u5019\u5b83\u5bf9\u5e94\u7684undo_log\u5df2\u7ecf\u5728\u6b65\u9aa42\u5220\u6389\u4e86\uff0c\u6240\u4ee5\u6b64\u65f6\u67e5\u4e0d\u5230undo_log\uff0c\u7136\u540e\u91cd\u65b0\u751f\u6210\u4e00\u6761",(0,o.kt)("inlineCode",{parentName:"p"},"status == 1 \u7684 undo_log")),(0,o.kt)("h1",{id:"\u6848\u4f8b\u5206\u6790"},"\u6848\u4f8b\u5206\u6790"),(0,o.kt)("h2",{id:"\u80cc\u666f"},"\u80cc\u666f"),(0,o.kt)("p",null,"1\u3001\u914d\u7f6e\u4e86\u4e09\u4e2a\u6570\u636e\u6e90: \u4e24\u4e2a\u7269\u7406\u6570\u636e\u6e90\u3001\u4e00\u4e2a\u903b\u8f91\u6570\u636e\u6e90\uff0c\u4f46\u662f\u4e24\u4e2a\u7269\u7406\u6570\u636e\u6e90\u5bf9\u5e94\u7684\u8fde\u63a5\u5730\u5740\u662f\u4e00\u6837\u7684\u3002\u8fd9\u6837\u505a\u6709\u610f\u601d\u5417\uff1f"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'@Bean("dsMaster")\nDynamicDataSource dsMaster() {\n    return new DynamicDataSource(masterDsRoute);\n}\n\n@Bean("dsSlave")\nDynamicDataSource dsSlave() {\n    return new DynamicDataSource(slaveDsRoute);\n}\n\n@Primary\n@Bean("masterSlave")\nDataSource masterSlave(@Qualifier("dsMaster") DataSource dataSourceMaster,\n                        @Qualifier("dsSlave") DataSource dataSourceSlave) throws SQLException {\n    Map<String, DataSource> dataSourceMap = new HashMap<>(2);\n    //\u4e3b\u5e93\n    dataSourceMap.put("dsMaster", dataSourceMaster);\n    //\u4ece\u5e93\n    dataSourceMap.put("dsSlave", dataSourceSlave);\n    // \u914d\u7f6e\u8bfb\u5199\u5206\u79bb\u89c4\u5219\n    MasterSlaveRuleConfiguration masterSlaveRuleConfig = new MasterSlaveRuleConfiguration(\n            "masterSlave", "dsMaster", Lists.newArrayList("dsSlave")\n    );\n    Properties shardingProperties = new Properties();\n    shardingProperties.setProperty("sql.show", "true");\n    shardingProperties.setProperty("sql.simple", "true");\n    // \u83b7\u53d6\u6570\u636e\u6e90\u5bf9\u8c61\n    DataSource dataSource = MasterSlaveDataSourceFactory.createDataSource(dataSourceMap, masterSlaveRuleConfig, shardingProperties);\n    log.info("datasource initialized!");\n    return dataSource;\u02da\n}\n')),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3e05c8fc0294a8caf4d0883a4676750~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,o.kt)("p",null,"2\u3001\u5f00\u542fseata\u7684\u6570\u636e\u6e90\u52a8\u6001\u4ee3\u7406\uff0c\u6839\u636eseata\u7684\u6570\u636e\u6e90\u4ee3\u7406\u903b\u8f91\u53ef\u4ee5\u77e5\u9053\uff0c\u6700\u7ec8\u4f1a\u751f\u6210\u4e09\u4e2a\u4ee3\u7406\u6570\u636e\u6e90\uff0c\u539f\u751f\u6570\u636e\u6e90\u548c\u4ee3\u7406\u6570\u636e\u6e90\u7684\u5173\u7cfb\u7f13\u5b58\u5728",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceProxyHolder.dataSourceProxyMap"),"\u4e2d\uff0c\u5047\u5982\u539f\u751f\u6570\u636e\u6e90\u548c\u4ee3\u7406\u6570\u636e\u6e90\u5bf9\u5e94\u7684\u5173\u7cfb\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"dsMaster(DynamicDataSource)           =>       dsMasterProxy(DataSourceProxy)\ndsSlave(DynamicDataSource)           =>       dsSlaveProxy(DataSourceProxy)\nmasterSlave(MasterSlaveDataSource)       =>       masterSlaveProxy(DataSourceProxy)\n")),(0,o.kt)("p",null,"\u6240\u4ee5\uff0c\u6700\u7ec8\u5728IOC\u5bb9\u5668\u4e2d\u5b58\u5728\u7684\u6570\u636e\u6e90\u662f\u8fd9\u4e09\u4e2a\uff1a dsMasterProxy \u3001 dsSlaveProxy \u3001 masterSlaveProxy \u3002\u6839\u636e@Primary\u7684\u7279\u6027\u53ef\u4ee5\u77e5\u9053\uff0c\u5f53\u6211\u4eec\u4ece\u5bb9\u5668\u4e2d\u83b7\u53d6\u4e00\u4e2aDataSource\u7684\u65f6\u5019\uff0c\u9ed8\u8ba4\u8fd4\u56de\u7684\u5c31\u662f\u4ee3\u7406\u6570\u636e\u6e90 masterSlaveProxy"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u5bf9shardingjdbc\u6ca1\u6709\u5177\u4f53\u7684\u7814\u7a76\u8fc7\uff0c\u53ea\u662f\u6839\u636edebug\u65f6\u770b\u5230\u7684\u4ee3\u7801\u731c\u6d4b\u5b83\u7684\u5de5\u4f5c\u673a\u5236\uff0c\u53c8\u4e0d\u5bf9\u7684\u5730\u65b9\uff0c\u8fd8\u8bf7\u5927\u4f6c\u6307\u51fa\u6765")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"masterSlaveProxy"),"\u53ef\u4ee5\u770b\u6210\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"\u88ab DataSourceProxy \u5305\u88c5\u540e\u7684 MasterSlaveDataSource"),"\u3002\u6211\u4eec\u53ef\u4ee5\u5927\u80c6\u7684\u731c\u6d4b",(0,o.kt)("inlineCode",{parentName:"p"},"MasterSlaveDataSource"),"\u5e76\u4e0d\u662f\u4e00\u4e2a\u7269\u7406\u6570\u636e\u6e90\uff0c\u800c\u662f\u4e00\u4e2a\u903b\u8f91\u6570\u636e\u6e90\uff0c\u53ef\u4ee5\u7b80\u5355\u7684\u8ba4\u4e3a\u91cc\u9762\u5305\u542b\u4e86\u8def\u7531\u7684\u903b\u8f91\u3002\u5f53\u6211\u4eec\u83b7\u53d6\u4e00\u4e2a\u8fde\u63a5\u65f6\uff0c\u4f1a\u901a\u8fc7\u91cc\u9762\u7684\u8def\u7531\u89c4\u5219\u9009\u62e9\u5230\u5177\u4f53\u7684\u7269\u7406\u6570\u636e\u6e90\uff0c\u7136\u540e\u901a\u8fc7\u8be5\u7269\u7406\u6570\u636e\u6e90\u83b7\u53d6\u4e00\u4e2a\u771f\u5b9e\u7684\u8fde\u63a5\u3002\n\u8def\u7531\u89c4\u5219\u5e94\u8be5\u53ef\u4ee5\u81ea\u5df1\u5b9a\u4e49\uff0c\u6839\u636edebug\u65f6\u89c2\u5bdf\u5230\u7684\u73b0\u8c61\uff0c\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\u5e94\u8be5\u662f\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u9488\u5bf9select \u8bfb\u64cd\u4f5c\uff0c\u4f1a\u8def\u7531\u5230\u4ece\u5e93\uff0c\u5373\u6211\u4eec\u7684 dsSlave"),(0,o.kt)("li",{parentName:"ol"},"\u9488\u5bf9update \u5199\u64cd\u4f5c\uff0c\u4f1a\u8def\u7531\u5230\u4e3b\u5e93\uff0c\u5373\u6211\u4eec\u7684 dsMaster")),(0,o.kt)("p",null,"3\u3001\u6bcf\u4e2aDataSourceProxy\u5728\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u4f1a\u89e3\u6790\u8be5\u771f\u5b9eDataSource\u7684\u8fde\u63a5\u5730\u5740\uff0c\u7136\u540e\u5c06\u8be5",(0,o.kt)("inlineCode",{parentName:"p"},"\u8fde\u63a5\u5730\u5740\u548cDataSourceProxy\u672c\u8eab"),"\u7ef4\u62a4",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceManager.dataSourceCache"),"\u4e2d\u3002",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceManager.dataSourceCache"),"\u6709\u4e00\u4e2a\u4f5c\u7528\u662f\u7528\u4e8e\u56de\u6eda\uff1a\u56de\u6eda\u65f6\u6839\u636e\u8fde\u63a5\u5730\u5740\u627e\u5230\u5bf9\u5e94\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceProxy"),",\u7136\u540e\u57fa\u4e8e\u8be5",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceProxy"),"\u505a\u56de\u6eda\u64cd\u4f5c\u3002\n\u4f46\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e2a\u95ee\u9898\uff0c\u8fd9\u4e09\u4e2a\u6570\u636e\u6e90\u89e3\u6790\u51fa\u6765\u7684\u8fde\u63a5\u5730\u5740\u662f\u4e00\u6837\u7684\uff0c\u4e5f\u5c31\u662fkey\u91cd\u590d\u4e86\uff0c\u6240\u4ee5\u5728",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceManager.dataSourceCache"),"\u4e2d\u4e2d\uff0c\u5f53\u8fde\u63a5\u5730\u76f8\u540c\u65f6\uff0c\u540e\u6ce8\u518c\u7684\u6570\u636e\u6e90\u4f1a\u8986\u76d6\u5df2\u5b58\u5728\u7684\u3002\u5373\uff1a ",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceManager.dataSourceCache"),"\u6700\u7ec8\u5b58\u5728\u7684\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"masterSlaveProxy"),",\u4e5f\u5c31\u662f\u8bf4\uff0c\u6700\u7ec8\u4f1a\u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"p"},"masterSlaveProxy"),"\u8fdb\u884c\u56de\u6eda\uff0c\u8fd9\u70b9\u5f88\u91cd\u8981\u3002"),(0,o.kt)("p",null,"4\u3001\u6d89\u53ca\u5230\u7684\u8868\uff1a\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u671f\u5f85\u7684\u5c31\u4e00\u4e2a\u4e1a\u52a1\u8868",(0,o.kt)("inlineCode",{parentName:"p"},"seata_account"),"\uff0c\u4f46\u56e0\u4e3a\u91cd\u590d\u4ee3\u7406\u95ee\u9898\uff0c\u5bfc\u81f4seata\u5c06undo_log\u4e5f\u5f53\u6210\u4e86\u4e00\u4e2a\u4e1a\u52a1\u8868"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"seata_account"),(0,o.kt)("li",{parentName:"ol"},"undo_log")),(0,o.kt)("p",null,"\u597d\u4e86\uff0c\u8fd9\u91cc\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0b\u80cc\u666f\uff0c\u63a5\u4e0b\u6765\u8fdb\u5165Seata\u73af\u8282"),(0,o.kt)("h2",{id:"\u9700\u6c42"},"\u9700\u6c42"),(0,o.kt)("p",null,"\u6211\u4eec\u7684\u9700\u6c42\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u5728\u5206\u652f\u4e8b\u52a1\u91cc\u9762\u6267\u884c\u4e00\u6761\u7b80\u5355\u7684update\u64cd\u4f5c\uff0c\u66f4\u65b0",(0,o.kt)("inlineCode",{parentName:"p"},"seata_account"),"\u7684count\u503c\u3002\u5728\u66f4\u65b0\u5b8c\u4e4b\u540e\uff0c\u624b\u52a8\u629b\u51fa\u4e00\u4e2a\u5f02\u5e38\uff0c\u89e6\u53d1\u5168\u5c40\u4e8b\u52a1\u7684\u56de\u6eda\u3002\n\u4e3a\u4e86\u66f4\u4fbf\u4e8e\u6392\u67e5\u95ee\u9898\uff0c\u51cf\u5c11\u5e72\u6270\uff0c\u6211\u4eec\u5168\u5c40\u4e8b\u52a1\u4e2d\u5c31\u4f7f\u7528\u4e00\u4e2a\u5206\u652f\u4e8b\u52a1\uff0c\u6ca1\u6709\u5176\u5b83\u5206\u652f\u4e8b\u52a1\u4e86\u3002SQL\u5982\u4e0b:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"update seata_account set count = count - 1 where id = 100;\n")),(0,o.kt)("h2",{id:"\u95ee\u9898\u73b0\u8c61"},"\u95ee\u9898\u73b0\u8c61"),(0,o.kt)("p",null,"Client\uff1a\u5728\u63a7\u5236\u53f0\u65e5\u5fd7\u4e2d\uff0c\u4e0d\u65ad\u91cd\u590d\u6253\u5370\u4ee5\u4e0b\u65e5\u5fd7"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u4ee5\u4e0a\u65e5\u5fd7\u6253\u5370\u7684\u95f4\u9694\u4e3a20s\uff0c\u800c\u6211\u67e5\u770b\u4e86\u6570\u636e\u5e93\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"innodb_lock_wait_timeout"),"\u5c5e\u6027\u503c\uff0c\u521a\u597d\u5c31\u662f20\uff0c\u8bf4\u660e\u6bcf\u6b21\u56de\u6eda\u8bf7\u6c42\u8fc7\u6765\u7684\u65f6\u5019\uff0c\u90fd\u56e0\u4e3a\u83b7\u53d6\u9501\u8d85\u65f6(20)\u800c\u56de\u6eda\u5931\u8d25"),(0,o.kt)("li",{parentName:"ol"},"\u4e3a\u4ec0\u4e48\u4f1a\u6ca1\u8fc720s\u6253\u5370\u4e00\u6b21\uff1f\u56e0\u4e3aServer\u7aef\u4f1a\u6709\u5b9a\u65f6\u5904\u7406\u56de\u6eda\u8bf7\u6c42")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"// \u5206\u652f\u4e8b\u52a1\u5f00\u59cb\u56de\u6eda\nBranch rollback start: 172.16.120.59:23004:59991911632711680 59991915571163137 jdbc:mysql://172.16.248.10:3306/tuya_middleware\n\n// undo_log\u4e8b\u52a1\u5206\u652f \u539f\u59cb\u64cd\u4f5c\u5bf9\u5e94\u662f insert, \u6240\u4ee5\u5176\u56de\u6eda\u4e3a delete\nundoSQL undoSQL=DELETE FROM undo_log WHERE id = ?  \uff0c PK=[[id,139]] \n// \u56e0\u4e3a\u7b2c\u4e00\u5c42\u4ee3\u7406\u5bf9\u5e94\u7684\u64cd\u4f5c\u4e5f\u5728\u4e0a\u4e0b\u6587\u4e2d\uff0cundo_log\u5206\u652f\u4e8b\u52a1 \u63d0\u4ea4\u65f6\u5019\uff0c \u5bf9\u5e94\u7684undo_log\u5305\u542b\u4e24\u4e2a\u64cd\u4f5c\nundoSQL undoSQL=UPDATE seata_account SET money = ? WHERE id = ?  \uff0c PK=[[id,1]] \n\n// \u8be5\u5206\u652f\u4e8b\u52a1\u56de\u6eda\u5b8c\u6210\u4e4b\u540e\uff0c\u518d\u5220\u9664\u8be5\u5206\u652f\u4e8b\u52a1\u7684\u5bf9\u5e94\u7684 undo_log\ndelete from undo_log where xid=172.16.120.59:23004:59991911632711680 AND branchId=59991915571163137 \n\n// \u629b\u51fa\u5f02\u5e38\uff0c\u63d0\u793a\u56de\u6eda\u5931\u8d25\uff0c\u5931\u8d25\u539f\u56e0\u662f`Lock wait timeout exceeded`\uff0c \u5728\u6839\u636exid\u548cbranchId\u5220\u9664undo_log\u65f6\u5931\u8d25\uff0c\u5931\u8d25\u539f\u56e0\u662f\u83b7\u53d6\u9501\u8d85\u65f6\uff0c\u8bf4\u660e\u6b64\u65f6\u6709\u53e6\u4e00\u4e2a\u64cd\u4f5c\u6301\u6709\u8be5\u8bb0\u5f55\u7684\u9501\u6ca1\u6709\u91ca\u653e\nbranchRollback failed. branchType:[AT], xid:[172.16.120.59:23004:59991911632711680], branchId:[59991915571163137], resourceId:[jdbc:mysql://172.16.248.10:3306/tuya_middleware], applicationData:[null]. reason:[Branch session rollback failed and try again later xid = 172.16.120.59:23004:59991911632711680 branchId = 59991915571163137 Lock wait timeout exceeded; try restarting transaction]\n")),(0,o.kt)("p",null,"Server\uff1a\u6bcf20s\u6253\u5370\u4ee5\u4e0b\u65e5\u5fd7\uff0c\u8bf4\u660eserver\u5728\u4e0d\u65ad\u7684\u91cd\u8bd5\u53d1\u9001\u56de\u6eda\u8bf7\u6c42"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Rollback branch transaction fail and will retry, xid = 172.16.120.59:23004:59991911632711680 branchId = 59991915571163137\n")),(0,o.kt)("p",null,"\u5728\u8be5\u8fc7\u7a0b\u4e2d\uff0c\u6d89\u53ca\u5230\u7684SQL\u5927\u6982\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"1. SELECT * FROM undo_log WHERE branch_id = ? AND xid = ? FOR UPDATE                            slaveDS\n2. SELECT * FROM undo_log WHERE  (id ) in (  (?)  )                                                     slaveDS\n3. DELETE FROM undo_log WHERE id = ?                                                                          masterDS\n4. SELECT * FROM seata_account WHERE  (id ) in (  (?)  )                                              masterDS\n5. UPDATE seata_account SET money = ? WHERE id = ?                                                      masterDS\n6. DELETE FROM undo_log WHERE branch_id = ? AND xid = ?                                               masterDS\n")),(0,o.kt)("p",null,"\u6b64\u65f6\u67e5\u770b\u6570\u636e\u5e93\u7684 \u4e8b\u52a1\u60c5\u51b5\u3001\u9501\u60c5\u51b5 \u3001\u9501\u7b49\u5f85\u5173\u7cfb\n1\u3001\u67e5\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684\u4e8b\u52a1"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM information_schema.INNODB_TRX;\n")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d9852b91a9949f781e1f90bffe95fbf~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,o.kt)("p",null,"2\u3001\u67e5\u5f53\u524d\u9501\u60c5\u51b5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM information_schema.INNODB_LOCKs;\n")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1a29748a3af34e7c90e3aa7cb78564bc~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,o.kt)("p",null,"3\u3001\u67e5\u5f53\u524d\u9501\u7b49\u5f85\u5173\u7cfb"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM information_schema.INNODB_LOCK_waits;\n\nSELECT\n    block_trx.trx_mysql_thread_id AS \u5df2\u7ecf\u6301\u6709\u9501\u7684sessionID,\n    request_trx.trx_mysql_thread_id AS \u6b63\u5728\u7533\u8bf7\u9501\u7684sessionID,\n    block_trx.trx_query AS \u5df2\u7ecf\u6301\u6709\u9501\u7684SQL\u8bed\u53e5,\n    request_trx.trx_query AS \u6b63\u5728\u7533\u8bf7\u9501\u7684SQL\u8bed\u53e5,\n    waits.blocking_trx_id AS \u5df2\u7ecf\u6301\u6709\u9501\u7684\u4e8b\u52a1ID,\n    waits.requesting_trx_id AS \u6b63\u5728\u7533\u8bf7\u9501\u7684\u4e8b\u52a1ID,\n    waits.requested_lock_id AS \u9501\u5bf9\u8c61\u7684ID,\n    locks.lock_table AS lock_table,                     -- \u9501\u5bf9\u8c61\u6240\u9501\u5b9a\u7684\u8868\n    locks.lock_type AS lock_type,                       -- \u9501\u7c7b\u578b\n    locks.lock_mode AS lock_mode                            -- \u9501\u6a21\u5f0f\nFROM\n    information_schema.innodb_lock_waits AS waits\n    INNER JOIN information_schema.innodb_trx AS block_trx ON waits.blocking_trx_id = block_trx.trx_id\n    INNER JOIN information_schema.innodb_trx AS request_trx ON waits.requesting_trx_id = request_trx.trx_id\n    INNER JOIN information_schema.innodb_locks AS locks ON waits.requested_lock_id = locks.lock_id;\n")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ca5b50cab534a69a49c3e470518e3b6~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u6d89\u53ca\u5230\u5230\u8bb0\u5f55\u4e3a ",(0,o.kt)("inlineCode",{parentName:"li"},"branch_id = 59991915571163137 AND xid = 172.16.120.59:23004:59991911632711680")),(0,o.kt)("li",{parentName:"ol"},"\u4e8b\u52a1ID",(0,o.kt)("inlineCode",{parentName:"li"},"1539483284"),"\u6301\u6709\u8be5\u8bb0\u5f55\u7684\u9501\uff0c\u4f46\u662f\u5b83\u5bf9\u5e94\u7684SQL\u4e3a\u7a7a\uff0c\u90a3\u5e94\u8be5\u662f\u5728\u7b49\u5f85commit"),(0,o.kt)("li",{parentName:"ol"},"\u4e8b\u52a1ID",(0,o.kt)("inlineCode",{parentName:"li"},"1539483286"),"\u5728\u5c1d\u8bd5\u83b7\u53d6\u8be5\u8bb0\u5f55\u7684\u9501\uff0c\u4f46\u4ece\u65e5\u5fd7\u53ef\u4ee5\u53d1\u73b0\uff0c\u5b83\u4e00\u76f4\u9501\u7b49\u5f85\u8d85\u65f6")),(0,o.kt)("p",null,"\u5927\u6982\u53ef\u4ee5\u731c\u6d4b\u662f ",(0,o.kt)("inlineCode",{parentName:"p"},"select for update")," \u548c ",(0,o.kt)("inlineCode",{parentName:"p"},"delete from undo ...")," \u53d1\u751f\u4e86\u51b2\u7a81\u3002\u6839\u636e\u4ee3\u7801\u4e2d\u7684\u903b\u8f91\uff0c\u8fd9\u4e24\u4e2a\u64cd\u4f5c\u5e94\u8be5\u662f\u653e\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u63d0\u4ea4\u4e86\uff0c\u4e3a\u4ec0\u4e48\u88ab\u5206\u5f00\u5230\u4e24\u4e2a\u4e8b\u52a1\u4e86\uff1f"),(0,o.kt)("h2",{id:"\u95ee\u9898\u5206\u6790-1"},"\u95ee\u9898\u5206\u6790"),(0,o.kt)("p",null,"\u7ed3\u5408\u4e0a\u9762\u7684\u4ecb\u7ecd\u7684\u56de\u6eda\u6d41\u7a0b\u770b\u770b\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u5728\u56de\u6eda\u65f6\u4f1a\u53d1\u751f\u4ec0\u4e48"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u5148\u83b7\u53d6\u6570\u636e\u6e90\uff0c\u6b64\u65f6dataSourceProxy.getPlainConnection()\u83b7\u53d6\u5230\u7684\u662f",(0,o.kt)("inlineCode",{parentName:"li"},"MasterSlaveDataSource"),"\u6570\u636e\u6e90"),(0,o.kt)("li",{parentName:"ol"},"\u5728",(0,o.kt)("inlineCode",{parentName:"li"},"select for update"),"\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"li"},"MasterSlaveDataSource"),"\u83b7\u53d6\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"Connection"),"\uff0c\u524d\u9762\u8bf4\u5230\u8fc7",(0,o.kt)("inlineCode",{parentName:"li"},"MasterSlaveDataSource"),"\u662f\u4e00\u4e2a\u903b\u8f91\u6570\u636e\u6e90\uff0c\u91cc\u9762\u6709\u8def\u7531\u903b\u8f91\uff0c\u6839\u636e\u4e0a\u9762\u4ecb\u7ecd\u7684\uff0c\u8fd9\u65f6\u5019\u62ff\u5230\u7684\u662f",(0,o.kt)("inlineCode",{parentName:"li"},"dsSlave"),"\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"Connection")),(0,o.kt)("li",{parentName:"ol"},"\u5728\u6267\u884c",(0,o.kt)("inlineCode",{parentName:"li"},"delete from undo ..."),"\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u8fd9\u65f6\u5019\u62ff\u5230\u7684\u662f",(0,o.kt)("inlineCode",{parentName:"li"},"dsMaster"),"\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"Connection")),(0,o.kt)("li",{parentName:"ol"},"\u867d\u7136",(0,o.kt)("inlineCode",{parentName:"li"},"dsSlave"),"\u548c",(0,o.kt)("inlineCode",{parentName:"li"},"dsMaster"),"\u5bf9\u5e94\u7684\u662f\u76f8\u540c\u7684\u5730\u5740\uff0c\u4f46\u6b64\u65f6\u83b7\u53d6\u5230\u7684\u80af\u5b9a\u662f\u4e0d\u540c\u7684\u8fde\u63a5\uff0c\u6240\u4ee5\u6b64\u65f6\u4e24\u4e2a\u64cd\u4f5c\u80af\u5b9a\u662f\u5206\u5e03\u5728\u4e24\u4e2a\u4e8b\u52a1\u4e2d"),(0,o.kt)("li",{parentName:"ol"},"\u6267\u884c",(0,o.kt)("inlineCode",{parentName:"li"},"select for update"),"\u7684\u4e8b\u52a1\uff0c\u4f1a\u4e00\u76f4\u7b49\u5f85\u76f4\u5230\u5220\u9664undo_log\u5b8c\u6210\u624d\u4f1a\u63d0\u4ea4"),(0,o.kt)("li",{parentName:"ol"},"\u6267\u884c",(0,o.kt)("inlineCode",{parentName:"li"},"delete from undo ..."),"\u7684\u4e8b\u52a1\uff0c\u4f1a\u4e00\u76f4\u7b49\u5f85",(0,o.kt)("inlineCode",{parentName:"li"},"select for update"),"\u7684\u4e8b\u52a1\u91ca\u653e\u9501"),(0,o.kt)("li",{parentName:"ol"},"\u5178\u578b\u7684\u6b7b\u9501\u95ee\u9898")),(0,o.kt)("h2",{id:"\u9a8c\u8bc1\u731c\u60f3"},"\u9a8c\u8bc1\u731c\u60f3"),(0,o.kt)("p",null,"\u6211\u5c1d\u8bd5\u7528\u4e86\u4e24\u4e2a\u65b9\u6cd5\u9a8c\u8bc1\u8fd9\u4e2a\u95ee\u9898\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u4fee\u6539Seata\u4ee3\u7801\uff0c\u5c06",(0,o.kt)("inlineCode",{parentName:"li"},"select for update"),"\u6539\u6210",(0,o.kt)("inlineCode",{parentName:"li"},"select"),"\uff0c\u6b64\u65f6\u5728\u67e5\u8be2undo_log\u5c31\u4e0d\u9700\u8981\u6301\u6709\u8be5\u8bb0\u5f55\u7684\u9501\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u9020\u6210\u6b7b\u9501")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"\u4fee\u6539\u6570\u636e\u6e90\u4ee3\u7406\u903b\u8f91\uff0c\u8fd9\u624d\u662f\u95ee\u9898\u7684\u5173\u952e\uff0c\u8be5\u95ee\u9898\u4e3b\u8981\u539f\u56e0\u4e0d\u662f",(0,o.kt)("inlineCode",{parentName:"li"},"select for update"),"\u3002\u5728\u6b64\u4e4b\u524d\u591a\u5c42\u4ee3\u7406\u95ee\u9898\u5df2\u7ecf\u4ea7\u751f\uff0c\u7136\u540e\u624d\u4f1a\u9020\u6210\u6b7b\u9501\u95ee\u9898\u3002\u4ece\u5934\u5230\u5c3e\u6211\u4eec\u5c31\u4e0d\u5e94\u8be5\u5bf9",(0,o.kt)("inlineCode",{parentName:"li"},"masterSlave"),"\u6570\u636e\u6e90\u8fdb\u884c\u4ee3\u7406\u3002\u5b83\u53ea\u662f\u4e00\u4e2a\u903b\u8f91\u6570\u636e\u6e90\uff0c\u4e3a\u4ec0\u4e48\u8981\u5bf9\u5b83\u8fdb\u884c\u4ee3\u7406\u5462\uff1f\u5982\u679c\u4ee3\u7406",(0,o.kt)("inlineCode",{parentName:"li"},"masterSlave"),"\uff0c\u5c31\u4e0d\u4f1a\u9020\u6210\u591a\u5c42\u4ee3\u7406\u95ee\u9898\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u9020\u6210\u5220\u9664undo_log\u65f6\u7684\u6b7b\u9501\u95ee\u9898")),(0,o.kt)("h2",{id:"\u6700\u7ec8\u5b9e\u73b0"},"\u6700\u7ec8\u5b9e\u73b0"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"masterSlave"),"\u4e5f\u662f\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"p"},"DataSource"),"\u7c7b\u578b\uff0c\u8be5\u5982\u4f55\u4ec5\u4ec5\u5bf9",(0,o.kt)("inlineCode",{parentName:"p"},"dsMaster")," \u548c ",(0,o.kt)("inlineCode",{parentName:"p"},"dsSlave")," \u4ee3\u7406\u800c\u4e0d\u5bf9",(0,o.kt)("inlineCode",{parentName:"p"},"masterSlave"),"\u4ee3\u7406\u5462\uff1f\u89c2\u5bdf",(0,o.kt)("inlineCode",{parentName:"p"},"SeataAutoDataSourceProxyCreator#shouldSkip"),"\u65b9\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7EnableAutoDataSourceProxy\u6ce8\u89e3\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"excludes"),"\u5c5e\u6027\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"@Override\nprotected boolean shouldSkip(Class<?> beanClass, String beanName) {\n    return SeataProxy.class.isAssignableFrom(beanClass) ||\n            DataSourceProxy.class.isAssignableFrom(beanClass) ||\n            !DataSource.class.isAssignableFrom(beanClass) ||\n            Arrays.asList(excludes).contains(beanClass.getName());\n}\n")),(0,o.kt)("p",null,"\u5373: \u5c06\u6570\u636e\u6e90\u81ea\u52a8\u4ee3\u7406\u5173\u95ed\uff0c\u7136\u540e\u5728\u542f\u52a8\u7c7b\u52a0\u4e0a\u8fd9\u4e2a\u6ce8\u89e3"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'@EnableAutoDataSourceProxy(excludes = {"org.apache.shardingsphere.shardingjdbc.jdbc.core.datasource.MasterSlaveDataSource"})\n')),(0,o.kt)("h1",{id:"\u81ea\u52a8\u4ee3\u7406\u5728\u65b0\u7248\u672c\u4e2d\u7684\u4f18\u5316"},"\u81ea\u52a8\u4ee3\u7406\u5728\u65b0\u7248\u672c\u4e2d\u7684\u4f18\u5316"),(0,o.kt)("p",null,"\u56e0\u4e3a",(0,o.kt)("inlineCode",{parentName:"p"},"Seata 1.4.0"),"\u8fd8\u6ca1\u6709\u6b63\u5f0f\u53d1\u5e03\uff0c\u6211\u76ee\u524d\u770b\u7684\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"1.4.0-SNAPSHOT"),"\u7248\u672c\u7684\u4ee3\u7801\uff0c\u5373\u5f53\u524d\u65f6\u95f4",(0,o.kt)("inlineCode",{parentName:"p"},"ddevelop"),"\u5206\u652f\u6700\u65b0\u7684\u4ee3\u7801"),(0,o.kt)("h2",{id:"\u4ee3\u7801\u6539\u52a8"},"\u4ee3\u7801\u6539\u52a8"),(0,o.kt)("p",null,"\u4e3b\u8981\u6539\u52a8\u5982\u4e0b\uff0c\u4e00\u4e9b\u5c0f\u7684\u7ec6\u8282\u5c31\u4e0d\u8fc7\u591a\u8bf4\u660e\u4e86\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxyHolder"),"\u8c03\u6574"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\u8c03\u6574"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"SeataDataSourceBeanPostProcessor"),"\u65b0\u589e")),(0,o.kt)("h3",{id:"datasourceproxyholder"},"DataSourceProxyHolder"),(0,o.kt)("p",null,"\u5728\u8fd9\u4e2a\u7c7b\u6539\u52a8\u4e2d\uff0c\u6700\u4e3b\u8981\u662f\u5176",(0,o.kt)("inlineCode",{parentName:"p"},"putDataSource"),"\u65b9\u6cd5\u7684\u6539\u52a8"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"public SeataDataSourceProxy putDataSource(DataSource dataSource, BranchType dataSourceProxyMode) {\n    DataSource originalDataSource;\n    if (dataSource instanceof SeataDataSourceProxy) {\n        SeataDataSourceProxy dataSourceProxy = (SeataDataSourceProxy) dataSource;\n        // \u5982\u679c\u662f\u4ee3\u7406\u6570\u636e\u6e90\uff0c\u5e76\u4e14\u548c\u5f53\u524d\u5e94\u7528\u914d\u7f6e\u7684\u6570\u636e\u6e90\u4ee3\u7406\u6a21\u5f0f(AT/XA)\u4e00\u6837, \u5219\u76f4\u63a5\u8fd4\u56de\n        if (dataSourceProxyMode == dataSourceProxy.getBranchType()) {\n            return (SeataDataSourceProxy)dataSource;\n        }\n\n        // \u5982\u679c\u662f\u4ee3\u7406\u6570\u636e\u6e90\uff0c\u548c\u5f53\u524d\u5e94\u7528\u914d\u7f6e\u7684\u6570\u636e\u6e90\u4ee3\u7406\u6a21\u5f0f(AT/XA)\u4e0d\u4e00\u6837\uff0c\u5219\u9700\u8981\u83b7\u53d6\u5176TargetDataSource,\u7136\u540e\u4e3a\u5176\u521b\u5efa\u4e00\u4e2a\u4ee3\u7406\u6570\u636e\u6e90\n        originalDataSource = dataSourceProxy.getTargetDataSource();\n    } else {\n        originalDataSource = dataSource;\n    }\n\n    // \u5982\u679c\u6709\u5fc5\u8981\uff0c\u57fa\u4e8e TargetDataSource \u521b\u5efa \u4ee3\u7406\u6570\u636e\u6e90\n    return this.dataSourceProxyMap.computeIfAbsent(originalDataSource,\n            BranchType.XA == dataSourceProxyMode ? DataSourceProxyXA::new : DataSourceProxy::new);\n}\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceProxyHolder#putDataSource"),"\u65b9\u6cd5\u4e3b\u8981\u5728\u4e24\u4e2a\u5730\u65b9\u88ab\u7528\u5230\uff1a\u4e00\u4e2a\u662f\u5728",(0,o.kt)("inlineCode",{parentName:"p"},"SeataAutoDataSourceProxyAdvice"),"\u5207\u9762\u4e2d\uff1b\u4e00\u4e2a\u662f\u5728",(0,o.kt)("inlineCode",{parentName:"p"},"SeataDataSourceBeanPostProcessor"),"\u4e2d\u3002\n\u8fd9\u6bb5\u5224\u65ad\u4e3a\u6211\u4eec\u89e3\u51b3\u4e86\u4ec0\u4e48\u95ee\u9898\uff1f\u6570\u636e\u6e90\u591a\u5c42\u4ee3\u7406\u95ee\u9898\u3002\u5728\u5f00\u542f\u4e86\u6570\u636e\u6e90\u81ea\u52a8\u4ee3\u7406\u7684\u524d\u63d0\u4e0b\uff0c\u601d\u8003\u4ee5\u4e0b\u573a\u666f\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u5982\u679c\u6211\u4eec\u5728\u9879\u76ee\u4e2d\u624b\u52a8\u6ce8\u5165\u4e86\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\uff0c\u8fd9\u65f6\u5019\u5728\u5207\u9762\u8c03\u7528",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxyHolder#putDataSource"),"\u65b9\u6cd5\u65f6\u4f1a\u76f4\u63a5\u8fd4\u56de\u8be5",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\u672c\u8eab\uff0c\u800c\u4e0d\u4f1a\u4e3a\u5176\u518d\u521b\u5efa\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy")),(0,o.kt)("li",{parentName:"ol"},"\u5982\u679c\u6211\u4eec\u5728\u9879\u76ee\u4e2d\u624b\u52a8\u6ce8\u5165\u4e86\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"DruidSource"),"\uff0c\u8fd9\u65f6\u5019\u5728\u5207\u9762\u8c03\u7528",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxyHolder#putDataSource"),"\u65b9\u6cd5\u65f6\u4f1a\u4e3a\u5176\u518d\u521b\u5efa\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\u5e76\u8fd4\u56de")),(0,o.kt)("p",null,"\u8fd9\u6837\u770b\u597d\u50cf\u95ee\u9898\u5df2\u7ecf\u89e3\u51b3\u4e86\uff0c\u6709\u6ca1\u6709\u53ef\u80fd\u4f1a\u6709\u5176\u5b83\u7684\u95ee\u9898\u5462\uff1f\u770b\u770b\u4e0b\u9762\u7684\u4ee3\u7801"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"@Bean\npublic DataSourceProxy dsA(){\n    return new DataSourceProxy(druidA)\n}\n\n@Bean\npublic DataSourceProxy dsB(DataSourceProxy dsA){\n    return new DataSourceProxy(dsA)\n}\n")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u8fd9\u6837\u5199\u80af\u5b9a\u662f\u4e0d\u5bf9\uff0c\u4f46\u5982\u679c\u4ed6\u5c31\u8981\u8fd9\u6837\u5199\u4f60\u4e5f\u6ca1\u529e\u6cd5"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"dsA"),"\u6ca1\u4ec0\u4e48\u95ee\u9898\uff0c\u4f46",(0,o.kt)("inlineCode",{parentName:"li"},"dsB"),"\u8fd8\u662f\u4f1a\u4ea7\u751f\u53cc\u5c42\u4ee3\u7406\u7684\u95ee\u9898\uff0c\u56e0\u4e3a\u6b64\u65f6",(0,o.kt)("inlineCode",{parentName:"li"},"dsB \u7684 TargetDataSource"),"\u662f",(0,o.kt)("inlineCode",{parentName:"li"},"dsA")),(0,o.kt)("li",{parentName:"ol"},"\u8fd9\u5c31\u6d89\u53ca\u5230",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\u7684\u6539\u52a8")),(0,o.kt)("h3",{id:"datasourceproxy"},"DataSourceProxy"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'public DataSourceProxy(DataSource targetDataSource, String resourceGroupId) {\n    // \u4e0b\u9762\u8fd9\u4e2a\u5224\u65ad\uff0c\u4fdd\u8bc1\u4e86\u5728\u6211\u4eec\u4f20\u5165\u4e00\u4e2aDataSourceProxy\u7684\u65f6\u5019\uff0c\u4e5f\u4e0d\u4f1a\u4ea7\u751f\u53cc\u5c42\u4ee3\u7406\u95ee\u9898\n    if (targetDataSource instanceof SeataDataSourceProxy) {\n        LOGGER.info("Unwrap the target data source, because the type is: {}", targetDataSource.getClass().getName());\n        targetDataSource = ((SeataDataSourceProxy) targetDataSource).getTargetDataSource();\n    }\n    this.targetDataSource = targetDataSource;\n    init(targetDataSource, resourceGroupId);\n}\n')),(0,o.kt)("h3",{id:"seatadatasourcebeanpostprocessor"},"SeataDataSourceBeanPostProcessor"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'public class SeataDataSourceBeanPostProcessor implements BeanPostProcessor {\n    private static final Logger LOGGER = LoggerFactory.getLogger(SeataDataSourceBeanPostProcessor.class);\n\n    ......\n\n    @Override\n    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {\n        if (bean instanceof DataSource) {\n            //When not in the excludes, put and init proxy.\n            if (!excludes.contains(bean.getClass().getName())) {\n                //Only put and init proxy, not return proxy.\n                DataSourceProxyHolder.get().putDataSource((DataSource) bean, dataSourceProxyMode);\n            }\n\n            //If is SeataDataSourceProxy, return the original data source.\n            if (bean instanceof SeataDataSourceProxy) {\n                LOGGER.info("Unwrap the bean of the data source," +\n                    " and return the original data source to replace the data source proxy.");\n                return ((SeataDataSourceProxy) bean).getTargetDataSource();\n            }\n        }\n        return bean;\n    }\n}\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"SeataDataSourceBeanPostProcessor"),"\u5b9e\u73b0\u4e86",(0,o.kt)("inlineCode",{parentName:"li"},"BeanPostProcessor"),"\u63a5\u53e3\uff0c\u5728\u4e00\u4e2abean\u521d\u59cb\u5316\u540e\uff0c\u4f1a\u6267\u884c",(0,o.kt)("inlineCode",{parentName:"li"},"BeanPostProcessor#postProcessAfterInitialization"),"\u65b9\u6cd5\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728",(0,o.kt)("inlineCode",{parentName:"li"},"postProcessAfterInitialization"),"\u65b9\u6cd5\u4e2d\uff0c\u8fd9\u65f6\u5019\u7684bean\u5df2\u7ecf\u662f\u53ef\u7528\u72b6\u6001\u4e86"),(0,o.kt)("li",{parentName:"ol"},"\u4e3a\u4ec0\u4e48\u8981\u63d0\u4f9b\u8fd9\u4e48\u4e00\u4e2a\u7c7b\u5462\uff1f\u4ece\u5b83\u7684\u4ee3\u7801\u4e0a\u6765\u770b\uff0c\u4ec5\u4ec5\u662f\u4e3a\u4e86\u518dbean\u521d\u59cb\u5316\u4e4b\u540e\uff0c\u4e3a\u6570\u636e\u6e90\u521d\u59cb\u5316\u5bf9\u5e94\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\uff0c\u4f46\u4e3a\u4ec0\u4e48\u8981\u8fd9\u6837\u505a\u5462\uff1f",(0,o.kt)("blockquote",{parentName:"li"},(0,o.kt)("p",{parentName:"blockquote"},"\u56e0\u4e3a\u6709\u4e9b\u6570\u636e\u6e90\u5728\u5e94\u7528\u542f\u52a8\u4e4b\u540e\uff0c\u53ef\u80fd\u5e76\u4e0d\u4f1a\u521d\u59cb\u5316(\u5373\u4e0d\u4f1a\u8c03\u7528\u6570\u636e\u6e90\u7684\u76f8\u5173\u65b9\u6cd5)\u3002\u5982\u679c\u6ca1\u6709\u63d0\u4f9b",(0,o.kt)("inlineCode",{parentName:"p"},"SeataDataSourceBeanPostProcessor"),"\u7c7b\uff0c\u90a3\u4e48\u5c31\u53ea\u6709\u5728",(0,o.kt)("inlineCode",{parentName:"p"},"SeataAutoDataSourceProxyAdvice"),"\u5207\u9762\u4e2d\u624d\u4f1a\u89e6\u53d1",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceProxyHolder#putDataSource"),"\u65b9\u6cd5\u3002\u5047\u5982\u6709\u4e00\u4e2a\u5ba2\u6237\u7aef\u5728\u56de\u6eda\u7684\u65f6\u5019\u5b95\u673a\u4e86\uff0c\u5728\u91cd\u542f\u4e4b\u540e\uff0cServer\u7aef\u901a\u8fc7\u5b9a\u65f6\u4efb\u52a1\u5411\u5176\u6d3e\u53d1\u56de\u6eda\u8bf7\u6c42\uff0c\u8fd9\u65f6\u5019\u5ba2\u6237\u7aef\u9700\u8981\u5148\u6839\u636e",(0,o.kt)("inlineCode",{parentName:"p"},"rsourceId"),"(\u8fde\u63a5\u5730\u5740)\u627e\u5230\u5bf9\u5e94\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"DatasourceProxy"),"\u3002\u4f46\u5982\u679c\u5728\u6b64\u4e4b\u524d\u5ba2\u6237\u7aef\u8fd8\u6ca1\u6709\u4e3b\u52a8\u89e6\u53d1\u6570\u636e\u6e90\u7684\u76f8\u5173\u65b9\u6cd5\uff0c\u5c31\u4e0d\u4f1a\u8fdb\u5165",(0,o.kt)("inlineCode",{parentName:"p"},"SeataAutoDataSourceProxyAdvice"),"\u5207\u9762\u903b\u8f91\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u4e3a\u8be5\u6570\u636e\u6e90\u521d\u59cb\u5316\u5bf9\u5e94\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"DataSourceProxy"),"\uff0c\u4ece\u800c\u5bfc\u81f4\u56de\u6eda\u5931\u8d25")))),(0,o.kt)("h2",{id:"\u591a\u5c42\u4ee3\u7406\u603b\u7ed3"},"\u591a\u5c42\u4ee3\u7406\u603b\u7ed3"),(0,o.kt)("p",null,"\u901a\u8fc7\u4e0a\u9762\u7684\u5206\u6790\uff0c\u6211\u4eec\u5927\u6982\u5df2\u7ecf\u77e5\u9053\u4e86seata\u5728\u907f\u514d\u591a\u5c42\u4ee3\u7406\u4e0a\u7684\u4e00\u4e9b\u4f18\u5316\uff0c\u4f46\u5176\u5b9e\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u9700\u8981\u6ce8\u610f\uff1a",(0,o.kt)("strong",{parentName:"p"},"\u903b\u8f91\u6570\u636e\u6e90\u7684\u4ee3\u7406"),"\n",(0,o.kt)("img",{parentName:"p",src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6910095aadab436eaffe03a752e44240~tplv-k3u1fbpfcp-watermark.image",alt:null})),(0,o.kt)("p",null,"\u8fd9\u65f6\u5019\u7684\u8c03\u7528\u5173\u7cfb\u4e3a\uff1a ",(0,o.kt)("inlineCode",{parentName:"p"},"masterSlaveProxy ->\u3000masterSlave ->  masterproxy/slaveProxy ->  master/slave")),(0,o.kt)("p",null,"\u6b64\u65f6\u53ef\u4ee5\u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"p"},"excludes"),"\u5c5e\u6027\u6392\u9664\u903b\u8f91\u6570\u636e\u6e90\uff0c\u4ece\u800c\u4e0d\u4e3a\u5176\u521b\u5efa\u6570\u636e\u6e90\u4ee3\u7406\u3002"),(0,o.kt)("p",null,"\u603b\u7ed3\u4e00\u4e0b\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u5728\u4e3a",(0,o.kt)("inlineCode",{parentName:"li"},"\u6570\u636e\u6e90"),"\u521d\u59cb\u5316\u5bf9\u5e94\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\u65f6\uff0c\u5224\u65ad\u662f\u5426\u6709\u5fc5\u8981\u4e3a\u5176\u521b\u5efa\u5bf9\u5e94\u7684",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\uff0c\u5982\u679c\u672c\u8eab\u5c31\u662f",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\uff0c\u5c31\u76f4\u63a5\u8fd4\u56de"),(0,o.kt)("li",{parentName:"ol"},"\u9488\u5bf9\u4e00\u4e9b",(0,o.kt)("inlineCode",{parentName:"li"},"\u6570\u636e\u6e90"),"\u624b\u52a8\u6ce8\u5165\u7684\u60c5\u51b5\uff0c\u4e3a\u4e86\u907f\u514d\u4e00\u4e9b\u4eba\u4e3a\u8bef\u64cd\u4f5c\u7684\u5bfc\u81f4\u7684\u591a\u5c42\u4ee3\u7406\u95ee\u9898\uff0c\u5728",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"),"\u6784\u9020\u51fd\u6570\u4e2d\u6dfb\u52a0\u4e86\u5224\u65ad\uff0c",(0,o.kt)("inlineCode",{parentName:"li"},"\u5982\u679c\u5165\u53c2TragetDatasource\u672c\u8eab\u5c31\u662f\u4e00\u4e2aDataSourceProxy\uff0c \u5219\u83b7\u53d6\u5176target\u5c5e\u6027\u4f5c\u4e3a\u65b0DataSourceProxy\u7684tragetDatasource")),(0,o.kt)("li",{parentName:"ol"},"\u9488\u5bf9\u4e00\u4e9b\u5176\u5b83\u60c5\u51b5\uff0c\u6bd4\u5982",(0,o.kt)("strong",{parentName:"li"},"\u903b\u8f91\u6570\u636e\u6e90\u4ee3\u7406\u95ee\u9898"),"\uff0c\u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"li"},"excludes"),"\u5c5e\u6027\u6dfb\u52a0\u6392\u9664\u9879\uff0c\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u4e3a\u903b\u8f91\u6570\u636e\u6e90\u521b\u5efa",(0,o.kt)("inlineCode",{parentName:"li"},"DataSourceProxy"))),(0,o.kt)("h1",{id:"\u5168\u5c40\u4e8b\u52a1\u548c\u672c\u5730\u4e8b\u52a1\u4f7f\u7528\u5efa\u8bae"},"\u5168\u5c40\u4e8b\u52a1\u548c\u672c\u5730\u4e8b\u52a1\u4f7f\u7528\u5efa\u8bae"),(0,o.kt)("p",null,"\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5982\u679c\u5728\u4e00\u4e2a\u65b9\u6cd5\u91cc\u6d89\u53ca\u5230\u591a\u4e2aDB\u64cd\u4f5c\uff0c\u6bd4\u5982\u6d89\u53ca\u52303\u6761update\u64cd\u4f5c\uff0c\u6211\u4eec\u9700\u4e0d\u9700\u5728\u8fd9\u4e2a\u65b9\u6cd5\u4f7f\u7528spring\u4e2d\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"@Transactional"),"\u6ce8\u89e3\uff1f\u9488\u5bf9\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u5206\u522b\u4ece\u4e24\u4e2a\u89d2\u5ea6\u8003\u8651\uff1a\u4e0d\u4f7f\u7528",(0,o.kt)("inlineCode",{parentName:"p"},"@Transactional"),"\u6ce8\u89e3 \u548c \u4f7f\u7528",(0,o.kt)("inlineCode",{parentName:"p"},"@Transactional"),"\u6ce8\u89e3"),(0,o.kt)("h2",{id:"\u4e0d\u4f7f\u7528transactional\u6ce8\u89e3"},"\u4e0d\u4f7f\u7528",(0,o.kt)("inlineCode",{parentName:"h2"},"@Transactional"),"\u6ce8\u89e3"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u5728\u63d0\u4ea4\u9636\u6bb5\uff0c\u56e0\u4e3a\u8be5\u5206\u652f\u4e8b\u52a1\u67093\u6761update\u64cd\u4f5c\uff0c\u6bcf\u6b21\u6267\u884cupdate\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u901a\u8fc7\u6570\u636e\u4ee3\u7406\u5411TC\u6ce8\u518c\u4e00\u4e2a\u5206\u652f\u4e8b\u52a1\uff0c\u5e76\u4e3a\u5176\u751f\u6210\u5bf9\u5e94\u7684undo_log\uff0c\u6700\u7ec83\u4e2aupdate\u64cd\u4f5c\u88ab\u5f53\u4f5c3\u4e2a\u5206\u652f\u4e8b\u52a1\u6765\u5904\u7406"),(0,o.kt)("li",{parentName:"ol"},"\u5728\u56de\u6eda\u9636\u6bb5\uff0c\u9700\u8981\u56de\u6eda3\u4e2a\u5206\u652f\u4e8b\u52a1"),(0,o.kt)("li",{parentName:"ol"},"\u6570\u636e\u7684\u4e00\u81f4\u6027\u901a\u8fc7seata\u5168\u5c40\u4e8b\u52a1\u6765\u4fdd\u8bc1")),(0,o.kt)("h2",{id:"\u4f7f\u7528transactional\u6ce8\u89e3"},"\u4f7f\u7528",(0,o.kt)("inlineCode",{parentName:"h2"},"@Transactional"),"\u6ce8\u89e3"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u5728\u63d0\u4ea4\u9636\u6bb5\uff0c3\u4e2aupdate\u64cd\u4f5c\u88ab\u5f53\u4f5c\u4e00\u4e2a\u5206\u652f\u4e8b\u52a1\u6765\u63d0\u4ea4\uff0c\u6240\u4ee5\u6700\u7ec8\u53ea\u4f1a\u6ce8\u518c\u4e00\u4e2a\u5206\u652f\u4e8b\u52a1"),(0,o.kt)("li",{parentName:"ol"},"\u5728\u56de\u6eda\u9636\u6bb5\uff0c\u9700\u8981\u56de\u6eda1\u4e2a\u5206\u652f\u4e8b\u52a1"),(0,o.kt)("li",{parentName:"ol"},"\u6570\u636e\u7684\u4e00\u81f4\u6027\uff1a\u8fd93\u4e2aupdate\u7684\u64cd\u4f5c\u901a\u8fc7\u672c\u5730\u4e8b\u52a1\u7684\u4e00\u81f4\u6027\u4fdd\u8bc1\uff1b\u5168\u5c40\u4e00\u81f4\u6027\u7531seata\u5168\u5c40\u4e8b\u52a1\u6765\u4fdd\u8bc1\u3002\u6b64\u65f63\u4e2aupdate\u4ec5\u4ec5\u662f\u4e00\u4e2a\u5206\u652f\u4e8b\u52a1\u800c\u5df2")),(0,o.kt)("h2",{id:"\u7ed3\u8bba"},"\u7ed3\u8bba"),(0,o.kt)("p",null,"\u901a\u8fc7\u4e0a\u9762\u7684\u5bf9\u6bd4\uff0c\u7b54\u6848\u662f\u663e\u800c\u6613\u89c1\u7684\uff0c\u5408\u7406\u7684\u4f7f\u7528\u672c\u5730\u4e8b\u52a1\uff0c\u53ef\u4ee5\u5927\u5927\u7684\u63d0\u5347\u5168\u5c40\u4e8b\u52a1\u7684\u5904\u7406\u901f\u5ea6\u3002\u4e0a\u9762\u4ec5\u4ec5\u662f3\u4e2aDB\u64cd\u4f5c\uff0c\u5982\u679c\u4e00\u4e2a\u65b9\u6cd5\u91cc\u9762\u6d89\u53ca\u5230\u7684DB\u64cd\u4f5c\u66f4\u591a\u5462\uff0c\u8fd9\u65f6\u5019\u4e24\u79cd\u65b9\u5f0f\u7684\u5dee\u522b\u662f\u4e0d\u662f\u66f4\u5927\u5462\uff1f"),(0,o.kt)("p",null,"\u6700\u540e\uff0c\u611f\u8c22@FUNKYE\u5927\u4f6c\u4e3a\u6211\u89e3\u7b54\u4e86\u5f88\u591a\u95ee\u9898\u5e76\u63d0\u4f9b\u4e86\u5b9d\u8d35\u5efa\u8bae\uff01"))}s.isMDXComponent=!0}}]);