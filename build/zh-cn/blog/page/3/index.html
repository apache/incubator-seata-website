<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | Apache Seata™</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.io/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://seata.io/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://seata.io/zh-cn/blog/page/3"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="keywords" content="Seata,Seata官网,Seata official site,分布式事务,distributed transactions"><meta data-rh="true" property="og:title" content="Blog | Apache Seata™"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/zh-cn/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.io/zh-cn/blog/page/3"><link data-rh="true" rel="alternate" href="https://seata.io/blog/page/3" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.io/zh-cn/blog/page/3" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.io/blog/page/3" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ICHFIJRDZF-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Apache Seata™ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Apache Seata™ Atom Feed">


<link rel="search" type="application/opensearchdescription+xml" title="Apache Seata™" href="/zh-cn/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=seata">
<script src="https://www.googletagmanager.com/gtag/js?id=G-X4LJGF90X2" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.71cf27f8.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.71cb6f6a.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.8918a088.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="https://hm.baidu.com/hm.js?104e73ef0c18b416b27abb23757ed8ee"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/overview/what-is-seata" href="/zh-cn/docs/overview/what-is-seata">v2.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-cn/docs/next/overview/what-is-seata">预览版</a></li><li><a class="dropdown__link" href="/zh-cn/docs/overview/what-is-seata">v2.0</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.8/overview/what-is-seata">v1.8</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.7/overview/what-is-seata">v1.7</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.6/overview/what-is-seata">v1.6</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.5/overview/what-is-seata">v1.5</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.4/overview/what-is-seata">v1.4</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.3/overview/what-is-seata">v1.3</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.2/overview/what-is-seata">v1.2</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.1/overview/what-is-seata">v1.1</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.0/overview/what-is-seata">v1.0</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/contributor-guide/new-contributor-guide_dev">开发者</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/users">用户</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a class="navbar__item navbar__link" href="/zh-cn/unversioned/download/seata-server">下载</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/blog/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/page/3" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/explore-seata-journey">探索 Seata 项目开源开发之旅</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-raft-detailed-explanation">Seata-Raft 存储模式详解及入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-observable-practice">Seata的可观测实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-lock">详解 Seata AT 模式事务隔离级别与全局锁设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-snowflake-explain">关于新版雪花算法的答疑</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-UUID-generator">Seata基于改良版雪花算法的分布式UUID生成器分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-feature-undo-log-compress">Seata新特性支持 -- undo_log压缩</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dsproxy-deadlock">ConcurrentHashMap导致的Seata死锁问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-02">Seata应用侧启动过程剖析——注册中心与配置中心模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-01">Seata应用侧启动过程剖析——RM &amp; TM如何与TC建立连接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-tcc-mode-with-spring-cloud">Spring Cloud集成Seata分布式事务-TCC模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-manager">Seata配置管理原理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-golang-communication-mode">seata-golang 通信模型详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-datasource-proxy">Seata数据源代理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-demo-in-mac">Mac下的Seata Demo环境搭建（AT模式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-quick-start">Seata 极简入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-ha-practice">Seata 高可用部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-center">Seata 配置中心实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/quick-start-use-seata-and-dubbo-services">如何使用Seata保证Dubbo微服务间的一致性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/manual-transaction-mode">MT 模式</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-datasource-proxy">Seata数据源代理解析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-10-16T00:00:00.000Z" itemprop="datePublished">2020年10月16日</time> · <!-- -->阅读需 37 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">罗小勇</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>在Seata1.3.0版本中，数据源自动代理和手动代理一定不能混合使用，否则会导致多层代理，从而导致以下问题：</p><ol><li>单数据源情况下：导致分支事务提交时，undo_log本身也被代理，即<code>为 undo_log 生成了 undo_log， 假设为undo_log2</code>，此时undo_log将被当作分支事务来处理；分支事务回滚时，因为<code>undo_log2</code>生成的有问题，在<code>undo_log对应的事务分支</code>回滚时会将<code>业务表关联的undo_log</code>也一起删除，从而导致<code>业务表对应的事务分支</code>回滚时发现undo_log不存在，从而又多生成一条状态为1的undo_log。这时候整体逻辑已经乱了，很严重的问题</li><li>多数据源和<code>逻辑数据源被代理</code>情况下：除了单数据源情况下会出现的问题，还可能会造成死锁问题。死锁的原因就是针对undo_log的操作，本该在一个事务中执行的<code>select for update</code> 和 <code>delete</code> 操作，被分散在多个事务中执行，导致一个事务在执行完<code>select for update</code>后一直不提交，一个事务在执行<code>delete</code>时一直等待锁，直到超时</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="代理描述">代理描述<a href="#代理描述" class="hash-link" aria-label="代理描述的直接链接" title="代理描述的直接链接">​</a></h2><p>即对DataSource代理一层，重写一些方法。比如<code>getConnection</code>方法，这时不直接返回一个<code>Connection</code>，而是返回<code>ConnectionProxy</code>，其它的以此类推</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// DataSourceProxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DataSourceProxy(DataSource targetDataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this(targetDataSource, DEFAULT_RESOURCE_GROUP_ID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void init(DataSource dataSource, String resourceGroupId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DefaultResourceManager.get().registerResource(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Connection getPlainConnection() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return targetDataSource.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ConnectionProxy getConnection() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Connection targetConnection = targetDataSource.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new ConnectionProxy(this, targetConnection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="手动代理">手动代理<a href="#手动代理" class="hash-link" aria-label="手动代理的直接链接" title="手动代理的直接链接">​</a></h2><p>即手动注入一个<code>DataSourceProxy</code>，如下</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DataSource druidDataSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DruidDataSource()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(&quot;dataSource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DataSourceProxy dataSource(DataSource druidDataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DataSourceProxy(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="自动代理">自动代理<a href="#自动代理" class="hash-link" aria-label="自动代理的直接链接" title="自动代理的直接链接">​</a></h2><p>针对<code>DataSource</code>创建一个代理类，在代理类里面基于<code>DataSource</code>获取<code>DataSourceProxy(如果没有就创建)</code>，然后调用<code>DataSourceProxy</code>的相关方法。核心逻辑在<code>SeataAutoDataSourceProxyCreator</code>中</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class SeataAutoDataSourceProxyCreator extends AbstractAutoProxyCreator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(SeataAutoDataSourceProxyCreator.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String[] excludes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Advisor advisor = new DefaultIntroductionAdvisor(new SeataAutoDataSourceProxyAdvice());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SeataAutoDataSourceProxyCreator(boolean useJdkProxy, String[] excludes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.excludes = excludes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setProxyTargetClass(!useJdkProxy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Object[] getAdvicesAndAdvisorsForBean(Class&lt;?&gt; beanClass, String beanName, TargetSource customTargetSource) throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isInfoEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;Auto proxy of [{}]&quot;, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new Object[]{advisor};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected boolean shouldSkip(Class&lt;?&gt; beanClass, String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return SeataProxy.class.isAssignableFrom(beanClass) ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataSourceProxy.class.isAssignableFrom(beanClass) ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                !DataSource.class.isAssignableFrom(beanClass) ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Arrays.asList(excludes).contains(beanClass.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SeataAutoDataSourceProxyAdvice implements MethodInterceptor, IntroductionInfo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object invoke(MethodInvocation invocation) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataSourceProxy dataSourceProxy = DataSourceProxyHolder.get().putDataSource((DataSource) invocation.getThis());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method method = invocation.getMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object[] args = invocation.getArguments();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method m = BeanUtils.findDeclaredMethod(DataSourceProxy.class, method.getName(), method.getParameterTypes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (m != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return m.invoke(dataSourceProxy, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return invocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Class&lt;?&gt;[] getInterfaces() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new Class[]{SeataProxy.class};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="数据源多层代理">数据源多层代理<a href="#数据源多层代理" class="hash-link" aria-label="数据源多层代理的直接链接" title="数据源多层代理的直接链接">​</a></h2><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@DependsOn(&quot;strangeAdapter&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DataSource druidDataSource(StrangeAdapter strangeAdapter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    doxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DruidDataSource()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(&quot;dataSource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DataSourceProxy dataSource(DataSource druidDataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DataSourceProxy(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>首先我们在配置类里面注入了两个<code>DataSource</code>，分别为： <code>DruidDataSource</code>和<code>DataSourceProxy</code>， 其中<code>DruidDataSource 作为 DataSourceProxy 的 targetDataSource 属性</code>，并且<code>DataSourceProxy</code>为使用了<code>@Primary</code>注解声明</li><li>应用默认开启了数据源自动代理，所以在调用<code>DruidDataSource</code>相关方法时，又会为为<code>DruidDataSource</code>创建一个对应的数据源代理<code>DataSourceProxy2</code></li><li>当我们在程序中想获取一个Connection时会发生什么？<ol><li>先获取一个<code>DataSource</code>，因为<code>DataSourceProxy</code>为<code>Primary</code>，所以此时拿到的是<code>DataSourceProxy</code></li><li>基于<code>DataSource</code>获取一个<code>Connection</code>，即通过<code>DataSourceProxy</code>获取<code>Connection</code>。此时会先调用<code>targetDataSource 即 DruidDataSource 的 getConnection 方法</code>，但因为切面会对<code>DruidDataSource</code>进行拦截，根据步骤2的拦截逻辑可以知道，此时会自动创建一个<code>DataSourceProxy2</code>，然后调用<code>DataSourceProxy2#getConnection</code>，然后再调用<code>DruidDataSource#getConnection</code>。最终形成了双层代理， 返回的<code>Connection</code>也是一个双层的<code>ConnectionProxy</code></li></ol></li></ol><p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ac0b91bd8fc4c48aa68afd5c58a42d5~tplv-k3u1fbpfcp-watermark.image" class="img_ev3q"></p><p>上面其实是改造之后的代理逻辑，Seata默认的自动代理会对<code>DataSourceProxy</code>再次进行代理，后果就是代理多了一层此时对应的图如下</p><p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/837aa0462d994e9a8614707c6a50b5ae~tplv-k3u1fbpfcp-watermark.image" class="img_ev3q"></p><p>数据源多层代理会导致的两个问题在文章开头处已经总结了，下面会有案例介绍。</p><h1>分支事务提交</h1><p>通过<code>ConnectionProxy</code>中执行对应的方法，会发生什么？以update操作涉及到的一个分支事务提交为例：</p><ol><li>执行<code>ConnectionProxy#prepareStatement</code>， 返回一个<code>PreparedStatementProxy</code></li><li>执行<code>PreparedStatementProxy#executeUpdate</code>，<code>PreparedStatementProxy#executeUpdate</code>大概会帮做两件事情: 执行业务SQL和提交undo_log</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="提交业务sql">提交业务SQL<a href="#提交业务sql" class="hash-link" aria-label="提交业务SQL的直接链接" title="提交业务SQL的直接链接">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ExecuteTemplate#execute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (sqlRecognizers.size() == 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SQLRecognizer sqlRecognizer = sqlRecognizers.get(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch (sqlRecognizer.getSQLType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case INSERT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor = EnhancedServiceLoader.load(InsertExecutor.class, dbType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new Class[]{StatementProxy.class, StatementCallback.class, SQLRecognizer.class},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new Object[]{statementProxy, statementCallback, sqlRecognizer});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case UPDATE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor = new UpdateExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case DELETE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor = new DeleteExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case SELECT_FOR_UPDATE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor = new SelectForUpdateExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            executor = new PlainExecutor&lt;&gt;(statementProxy, statementCallback);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    executor = new MultiExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>主要流程就是： 先执行业务SQL，然后执行ConnectionProxy的commit方法，在这个方法中，会先帮我们执行对应的 undo_log SQL，然后提交事务</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PreparedStatementProxy#executeUpdate =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecuteTemplate#execute =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseTransactionalExecutor#execute =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AbstractDMLBaseExecutor#doExecute =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AbstractDMLBaseExecutor#executeAutoCommitTrue =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AbstractDMLBaseExecutor#executeAutoCommitFalse =&gt; 在这一步操中，会触发statementCallback#execute方法，即调用调用原生PreparedStatement#executeUpdate方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConnectionProxy#commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConnectionProxy#processGlobalTransactionCommit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="undo_log插入">UNDO_LOG插入<a href="#undo_log插入" class="hash-link" aria-label="UNDO_LOG插入的直接链接" title="UNDO_LOG插入的直接链接">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ConnectionProxy#processGlobalTransactionCommit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void processGlobalTransactionCommit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 注册分支事务，简单理解向server发一个请求，然后server在branch_table表里插入一条记录，不关注</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        register();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (TransactionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果没有for update 的sql,会直接在commit之前做注册,此时不止插入一条branch记录,而会附带锁信息进行竞争,下方的异常一般就是在注册时没拿到锁抛出,一般就是纯update语句的并发下会触发竞争锁失败的异常 @FUNKYE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recognizeLockKeyConflictException(e, context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // undo_log处理，期望用 targetConnection 处理           @1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UndoLogManagerFactory.getUndoLogManager(this.getDbType()).flushUndoLogs(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 提交本地事务，期望用 targetConnection 处理             @2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.error(&quot;process connectionProxy commit error: {}&quot;, ex.getMessage(), ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        report(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (IS_REPORT_SUCCESS_ENABLE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        report(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>undo_log处理@1，解析当前事务分支涉及到的<code>undo_log</code>，然后使用<code>TargetConnection</code>， 写到数据库</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void flushUndoLogs(ConnectionProxy cp) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConnectionContext connectionContext = cp.getContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!connectionContext.hasUndoLog()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String xid = connectionContext.getXid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long branchId = connectionContext.getBranchId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BranchUndoLog branchUndoLog = new BranchUndoLog();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    branchUndoLog.setXid(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    branchUndoLog.setBranchId(branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    branchUndoLog.setSqlUndoLogs(connectionContext.getUndoItems());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UndoLogParser parser = UndoLogParserFactory.getInstance();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] undoLogContent = parser.encode(branchUndoLog);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.debug(&quot;Flushing UNDO LOG: {}&quot;, new String(undoLogContent, Constants.DEFAULT_CHARSET));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insertUndoLogWithNormal(xid, branchId, buildContext(parser.getName()), undoLogContent,cp.getTargetConnection());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>提交本地事务@2，即通过<code>TargetConnection</code>提交事务。即 <code>务SQL执行</code>、<code>undo_log写入</code>、<code>即事务提交</code> 用的都是同一个<code>TargetConnection</code></li></ol><blockquote><p>lcn的内置数据库方案,lcn是将undolog写到他内嵌的h2(忘了是不是这个来着了)数据库上,此时会变成2个本地事务,一个是h2的undolog插入事务,一个是业务数据库的事务,如果在h2插入后,业务数据库异常,lcn的方案就会出现数据冗余,回滚数据的时候也是一样,删除undolog跟回滚业务数据不是一个本地事务.
但是lcn这样的好处就是入侵小,不需要另外添加undolog表。 感谢@FUNKYE大佬给的建议，对lcn不太了解，有机会好好研究一下</p></blockquote><h1>分支事务回滚</h1><ol><li>Server端向Client端发送回滚请求</li><li>Client端接收到Server发过来的请求，经过一系列处理，最终会到<code>DataSourceManager#branchRollback</code>方法</li><li>先根据resourceId从<code>DataSourceManager.dataSourceCache</code>中获取对应的<code>DataSourceProxy</code>，此时为<code>masterSlaveProxy</code>(回滚阶段我们就不考代理数据源问题，简单直接一些，反正最终拿到的都是<code>TragetConnection</code>)</li><li>根据Server端发过来的xid和branchId查找对应的undo_log并解析其<code>rollback_info</code>属性，每条undo_log可能会解析出多条<code>SQLUndoLog</code>,每个<code>SQLUndoLog</code>可以理解成是一个操作。比如一个分支事务先更新A表，再更新B表，这时候针对该分支事务生成的undo_log就包含两个<code>SQLUndoLog</code>：第一个<code>SQLUndoLog</code>对应的是更新A表的前后快照；第二个<code>SQLUndoLog</code>对应的是更新B表的前后快照</li><li>针对每条<code>SQLUndoLog</code>执行对应的回滚操作，比如一个<code>SQLUndoLog</code>对应的操作是<code>INSERT</code>，则其对应的回滚操作就是<code>DELETE</code></li><li>根据xid和branchId删除该undo_log</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// AbstractUndoLogManager#undo   删除了部分非关键代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void undo(DataSourceProxy dataSourceProxy, String xid, long branchId) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Connection conn = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ResultSet rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PreparedStatement selectPST = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean originalAutoCommit = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (; ; ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取原生数据源的Connection, 回滚阶段我们不管代理数据源问题，最终拿到的都是 TargetConnection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn = dataSourceProxy.getPlainConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 将回滚操作放在一个本地事务中，手动提交，确保最终业务SQL操作和undo_log删除操作一起提交</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (originalAutoCommit = conn.getAutoCommit()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.setAutoCommit(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 根据xid 和 branchId 查询 undo_log，注意此时的SQL语句  SELECT * FROM undo_log WHERE branch_id = ? AND xid = ? FOR UPDATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectPST = conn.prepareStatement(SELECT_UNDO_LOG_SQL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectPST.setLong(1, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectPST.setString(2, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rs = selectPST.executeQuery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean exists = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (rs.next()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                exists = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // status == 1 undo_log不处理，和防悬挂相关</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!canUndo(state)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 解析undo_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                byte[] rollbackInfo = getRollbackInfo(rs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                BranchUndoLog branchUndoLog = UndoLogParserFactory.getInstance(serializer).decode(rollbackInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    setCurrentSerializer(parser.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SQLUndoLog&gt; sqlUndoLogs = branchUndoLog.getSqlUndoLogs();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (sqlUndoLogs.size() &gt; 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Collections.reverse(sqlUndoLogs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for (SQLUndoLog sqlUndoLog : sqlUndoLogs) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        AbstractUndoExecutor undoExecutor = UndoExecutorFactory.getUndoExecutor(dataSourceProxy.getDbType(), sqlUndoLog);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 执行对应的回滚操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        undoExecutor.executeOn(conn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (exists) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;\n delete from undo_log where xid={} AND branchId={} \n&quot;, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                deleteUndoLog(xid, branchId, conn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 和防悬挂相关 如果根据 xid和branchId 没有查到undo_log，说明这个分支事务有异常：例如业务处理超时，导致全局事务回滚，但这时候业务undo_log并没有插入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;\n insert into undo_log xid={},branchId={} \n&quot;, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                insertUndoLogWithGlobalFinished(xid, branchId, UndoLogParserFactory.getInstance(), conn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new BranchTransactionException(BranchRollbackFailed_Retriable, String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .format(&quot;Branch session rollback failed and try again later xid = %s branchId = %s %s&quot;, xid,branchId, e.getMessage()), e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有以下几个注意点：</p><ol><li>回滚时不考虑数据源代理问题，最终都是使用<code>TargetConnection</code></li><li>设置atuoCommit为false，即需要手动提交事务</li><li>根据xid和branchId查询undo_log时加了<code>for update</code>，也就是说，这个事务会持有这条undo_log的锁直到所有回滚操作都完成，因为完成之后才会</li></ol><h1>多层代理问题</h1><p>数据源多层代理会导致的几个问题在文章开头的时候已经提到过了，重点分析一下为什么会造成以上问题：</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="对分支事务提交的影响">对分支事务提交的影响<a href="#对分支事务提交的影响" class="hash-link" aria-label="对分支事务提交的影响的直接链接" title="对分支事务提交的影响的直接链接">​</a></h2><p>先分析一下，如果使用双层代理会发生什么？我们从两个方面来分析：<code>业务SQL</code>和<code>undo_log</code></p><ol><li>业务SQL</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PreparedStatementProxy1.executeUpdate =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statementCallback#executeUpdate(PreparedStatementProxy2#executeUpdate) =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PreparedStatement#executeUpdate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>好像没啥影响，就是多绕了一圈，最终还是通过<code>PreparedStatement</code>执行</p><ol start="2"><li>undo_log</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ConnectionProxy1#getTargetConnection -&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConnectionProxy2#prepareStatement -&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PreparedStatementProxy2#executeUpdate -&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PreparedStatement#executeUpdate(原生的undo_log写入，在此之前会对为该 undo_log 生成 undo_log2(即 undo_log 的 undo_log)) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConnectionProxy2#commit -&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConnectionProxy2#processGlobalTransactionCommit(写入undo_log2) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConnectionProxy2#getTargetConnection -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TargetConnection#prepareStatement -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PreparedStatement#executeUpdate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="对分支事务回滚的影响">对分支事务回滚的影响<a href="#对分支事务回滚的影响" class="hash-link" aria-label="对分支事务回滚的影响的直接链接" title="对分支事务回滚的影响的直接链接">​</a></h2><blockquote><p>在事务回滚之后，为何undo_log没有被删除呢？</p></blockquote><p>其实并不是没有被删除。前面已经说过，双层代理会导致<code>undo_log</code>被当作分支事务来处理，所以也会为该 <code>undo_log</code>生成一个undo_log(假设为<code>undo_log2</code>),而<code>undo_log2</code>生成的有问题(其实也没问题，就应该这样生成)，从而导致回滚时会将<code>业务表关联的undo_log</code>也一起删除，最终导致<code>业务表对应的事务分支</code>回滚时发现undo_log不存在，从而又多生成一条状态为为1的undo_log</p><p><strong>回滚之前</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// undo_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">84  59734070967644161   172.16.120.59:23004:59734061438185472 serializer=jackson 1.1KB  0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">85  59734075254222849   172.16.120.59:23004:59734061438185472 serializer=jackson 4.0KB  0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// branch_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">59734070967644161   172.16.120.59:23004:59734061438185472       jdbc:mysql://172.16.248.10:3306/tuya_middleware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">59734075254222849   172.16.120.59:23004:59734061438185472       jdbc:mysql://172.16.248.10:3306/tuya_middleware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// lock_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc:mysql://xx^^^seata_storage^^^1 59734070967644161   jdbc:mysql://172.16.248.10:3306/tuya_middleware seata_storage     1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc:mysql://xx^^^undo_log^^^84     59734075254222849   jdbc:mysql://172.16.248.10:3306/tuya_middleware undo_log          84</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>回滚之后</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 生成了一条状态为1的undo_log，对应的日志为: undo_log added with GlobalFinished</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">86  59734070967644161   172.16.120.59:23004:59734061438185472 serializer=jackson 1.0Byte  1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="问题分析">问题分析<a href="#问题分析" class="hash-link" aria-label="问题分析的直接链接" title="问题分析的直接链接">​</a></h3><ol><li>根据xid和branchId找到对应的undo_log日志</li><li>对undo_log进行解析，主要就是解析它的<code>rollback_info</code>字段，<code>rollback_info</code>解析出来就是一个<code>SQLUndoLog集合</code>，每条<code>SQLUndoLog</code>对应着一个操作，里面包含了该操作的前后的快照，然后执行对应的回滚</li><li>根据xid和branchId删除undo_log日志</li></ol><p>因为双层代理问题，导致一条undo_log变成了一个分支事务，所以发生回滚时，我们也需要对undo_log分支事务进行回滚：
1、首先根据xid和branchId找到对应的<code>undo_log</code>并解析其<code>rollback_info</code>属性，这里解析出来的rollback_info包含了两条<code>SQLUndoLog</code>。为什么有两条？</p><blockquote><p>仔细想想也可以可以理解，第一层代理针对<code>seata_storage</code>的操作，放到缓存中，本来执行完之后是需要清掉的，但因为这里是双层代理，所以这时候这个流程并没有结束。轮到第二层代理对<code>undo_log</code>操作时，将该操作放到缓存中，此时缓存中有两个操作，分别为<code>seata_storage的UPDATE</code> 和 <code>undo_log的INSERT</code>。所以这也就很好理解为什么针对<code>undo_log操作</code>的那条undo_log格外大(4KB)，因为它的<code>rollback_info</code>包含了两个操作。</p></blockquote><p>有一点需要注意的是，第一条<code>SQLUndoLog</code>对应的after快照，里面的branchId=<code>59734070967644161</code> pk=<code>84</code>， 即 <code>seata_storage分支对应的branchId</code>  和 <code>seata_storage对应的undo_log PK</code>。也就是说，undo_log回滚时候 把<code>seata_storage对应的undo_log</code>删掉了。
那undo_log本身对应的undo_log 如何删除呢？在接下来的逻辑中会根据xid和branchId删除</p><p>2、解析第一条<code>SQLUndoLog</code>，此时对应的是<code>undo_log的INSERT</code>操作，所以其对应的回滚操作是<code>DELETE</code>。因为<code>undo_log</code>此时被当作了业务表。所以这一步会将<code>59734075254222849</code>对应的undo_log删除，<strong>但这个其实是业务表对应的对应的<code>undo_log</code></strong></p><p>3、解析第二条<code>SQLUndoLog</code>，此时对应的是<code>seata_storage的UPDATE</code>操作，这时会通过快照将<code>seata_storage</code>对应的记录恢复</p><p>4、根据xid和branchId删除undo_log日志，这里删除的是<code>undo_log 的 undo_log , 即 undo_log2</code>。所以，执行到这里，两条undo_log就已经被删除了</p><p>5、接下来回滚<code>seata_storage</code>，因为这时候它对应的undo_log已经在步骤2删掉了，所以此时查不到undo_log，然后重新生成一条<code>status == 1 的 undo_log</code></p><h1>案例分析</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>1、配置了三个数据源: 两个物理数据源、一个逻辑数据源，但是两个物理数据源对应的连接地址是一样的。这样做有意思吗？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(&quot;dsMaster&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DynamicDataSource dsMaster() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DynamicDataSource(masterDsRoute);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(&quot;dsSlave&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DynamicDataSource dsSlave() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DynamicDataSource(slaveDsRoute);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(&quot;masterSlave&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DataSource masterSlave(@Qualifier(&quot;dsMaster&quot;) DataSource dataSourceMaster,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        @Qualifier(&quot;dsSlave&quot;) DataSource dataSourceSlave) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, DataSource&gt; dataSourceMap = new HashMap&lt;&gt;(2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //主库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dataSourceMap.put(&quot;dsMaster&quot;, dataSourceMaster);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //从库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dataSourceMap.put(&quot;dsSlave&quot;, dataSourceSlave);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 配置读写分离规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MasterSlaveRuleConfiguration masterSlaveRuleConfig = new MasterSlaveRuleConfiguration(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;masterSlave&quot;, &quot;dsMaster&quot;, Lists.newArrayList(&quot;dsSlave&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties shardingProperties = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shardingProperties.setProperty(&quot;sql.show&quot;, &quot;true&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shardingProperties.setProperty(&quot;sql.simple&quot;, &quot;true&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取数据源对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DataSource dataSource = MasterSlaveDataSourceFactory.createDataSource(dataSourceMap, masterSlaveRuleConfig, shardingProperties);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log.info(&quot;datasource initialized!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return dataSource;˚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3e05c8fc0294a8caf4d0883a4676750~tplv-k3u1fbpfcp-watermark.image" class="img_ev3q"></p><p>2、开启seata的数据源动态代理，根据seata的数据源代理逻辑可以知道，最终会生成三个代理数据源，原生数据源和代理数据源的关系缓存在<code>DataSourceProxyHolder.dataSourceProxyMap</code>中，假如原生数据源和代理数据源对应的关系如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dsMaster(DynamicDataSource)           =&gt;       dsMasterProxy(DataSourceProxy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dsSlave(DynamicDataSource)           =&gt;       dsSlaveProxy(DataSourceProxy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">masterSlave(MasterSlaveDataSource)       =&gt;       masterSlaveProxy(DataSourceProxy)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所以，最终在IOC容器中存在的数据源是这三个： dsMasterProxy 、 dsSlaveProxy 、 masterSlaveProxy 。根据@Primary的特性可以知道，当我们从容器中获取一个DataSource的时候，默认返回的就是代理数据源 masterSlaveProxy</p><blockquote><p>对shardingjdbc没有具体的研究过，只是根据debug时看到的代码猜测它的工作机制，又不对的地方，还请大佬指出来</p></blockquote><p><code>masterSlaveProxy</code>可以看成是<code>被 DataSourceProxy 包装后的 MasterSlaveDataSource</code>。我们可以大胆的猜测<code>MasterSlaveDataSource</code>并不是一个物理数据源，而是一个逻辑数据源，可以简单的认为里面包含了路由的逻辑。当我们获取一个连接时，会通过里面的路由规则选择到具体的物理数据源，然后通过该物理数据源获取一个真实的连接。
路由规则应该可以自己定义，根据debug时观察到的现象，默认的路由规则应该是：</p><ol><li>针对select 读操作，会路由到从库，即我们的 dsSlave</li><li>针对update 写操作，会路由到主库，即我们的 dsMaster</li></ol><p>3、每个DataSourceProxy在初始化的时候，会解析该真实DataSource的连接地址，然后将该<code>连接地址和DataSourceProxy本身</code>维护<code>DataSourceManager.dataSourceCache</code>中。<code>DataSourceManager.dataSourceCache</code>有一个作用是用于回滚：回滚时根据连接地址找到对应的<code>DataSourceProxy</code>,然后基于该<code>DataSourceProxy</code>做回滚操作。
但我们可以发现这个问题，这三个数据源解析出来的连接地址是一样的，也就是key重复了，所以在<code>DataSourceManager.dataSourceCache</code>中中，当连接地相同时，后注册的数据源会覆盖已存在的。即： <code>DataSourceManager.dataSourceCache</code>最终存在的是<code>masterSlaveProxy</code>,也就是说，最终会通过<code>masterSlaveProxy</code>进行回滚，这点很重要。</p><p>4、涉及到的表：很简单，我们期待的就一个业务表<code>seata_account</code>，但因为重复代理问题，导致seata将undo_log也当成了一个业务表</p><ol><li>seata_account</li><li>undo_log</li></ol><p>好了，这里简单介绍一下背景，接下来进入Seata环节</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="需求">需求<a href="#需求" class="hash-link" aria-label="需求的直接链接" title="需求的直接链接">​</a></h2><p>我们的需求很简单，就是在分支事务里面执行一条简单的update操作，更新<code>seata_account</code>的count值。在更新完之后，手动抛出一个异常，触发全局事务的回滚。
为了更便于排查问题，减少干扰，我们全局事务中就使用一个分支事务，没有其它分支事务了。SQL如下:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">update seata_account set count = count - 1 where id = 100;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题现象">问题现象<a href="#问题现象" class="hash-link" aria-label="问题现象的直接链接" title="问题现象的直接链接">​</a></h2><p>Client：在控制台日志中，不断重复打印以下日志</p><ol><li>以上日志打印的间隔为20s，而我查看了数据库的<code>innodb_lock_wait_timeout</code>属性值，刚好就是20，说明每次回滚请求过来的时候，都因为获取锁超时(20)而回滚失败</li><li>为什么会没过20s打印一次？因为Server端会有定时处理回滚请求</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 分支事务开始回滚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Branch rollback start: 172.16.120.59:23004:59991911632711680 59991915571163137 jdbc:mysql://172.16.248.10:3306/tuya_middleware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// undo_log事务分支 原始操作对应是 insert, 所以其回滚为 delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">undoSQL undoSQL=DELETE FROM undo_log WHERE id = ?  ， PK=[[id,139]] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 因为第一层代理对应的操作也在上下文中，undo_log分支事务 提交时候， 对应的undo_log包含两个操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">undoSQL undoSQL=UPDATE seata_account SET money = ? WHERE id = ?  ， PK=[[id,1]] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 该分支事务回滚完成之后，再删除该分支事务的对应的 undo_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delete from undo_log where xid=172.16.120.59:23004:59991911632711680 AND branchId=59991915571163137 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 抛出异常，提示回滚失败，失败原因是`Lock wait timeout exceeded`， 在根据xid和branchId删除undo_log时失败，失败原因是获取锁超时，说明此时有另一个操作持有该记录的锁没有释放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">branchRollback failed. branchType:[AT], xid:[172.16.120.59:23004:59991911632711680], branchId:[59991915571163137], resourceId:[jdbc:mysql://172.16.248.10:3306/tuya_middleware], applicationData:[null]. reason:[Branch session rollback failed and try again later xid = 172.16.120.59:23004:59991911632711680 branchId = 59991915571163137 Lock wait timeout exceeded; try restarting transaction]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Server：每20s打印以下日志，说明server在不断的重试发送回滚请求</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Rollback branch transaction fail and will retry, xid = 172.16.120.59:23004:59991911632711680 branchId = 59991915571163137</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在该过程中，涉及到的SQL大概如下：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">1.</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> undo_log </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> branch_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> xid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain">                            slaveDS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2.</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> undo_log </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">?</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                                                     slaveDS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3.</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> undo_log </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?                                                                          masterDS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4.</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> seata_account </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">?</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                                              masterDS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5.</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> seata_account </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> money </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?                                                      masterDS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6.</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> undo_log </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> branch_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> xid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?                                               masterDS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时查看数据库的 事务情况、锁情况 、锁等待关系
1、查当前正在执行的事务</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> information_schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">INNODB_TRX</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d9852b91a9949f781e1f90bffe95fbf~tplv-k3u1fbpfcp-watermark.image" class="img_ev3q"></p><p>2、查当前锁情况</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> information_schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">INNODB_LOCKs</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1a29748a3af34e7c90e3aa7cb78564bc~tplv-k3u1fbpfcp-watermark.image" class="img_ev3q"></p><p>3、查当前锁等待关系</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> information_schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">INNODB_LOCK_waits</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    block_trx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trx_mysql_thread_id </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> 已经持有锁的sessionID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request_trx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trx_mysql_thread_id </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> 正在申请锁的sessionID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    block_trx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trx_query </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> 已经持有锁的</span><span class="token keyword" style="color:#00009f">SQL</span><span class="token plain">语句</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request_trx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trx_query </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> 正在申请锁的</span><span class="token keyword" style="color:#00009f">SQL</span><span class="token plain">语句</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    waits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blocking_trx_id </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> 已经持有锁的事务ID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    waits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requesting_trx_id </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> 正在申请锁的事务ID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    waits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requested_lock_id </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> 锁对象的ID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    locks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock_table </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> lock_table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                     </span><span class="token comment" style="color:#999988;font-style:italic">-- 锁对象所锁定的表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    locks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock_type </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> lock_type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                       </span><span class="token comment" style="color:#999988;font-style:italic">-- 锁类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    locks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock_mode </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> lock_mode                            </span><span class="token comment" style="color:#999988;font-style:italic">-- 锁模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    information_schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">innodb_lock_waits </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> waits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> information_schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">innodb_trx </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> block_trx </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> waits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blocking_trx_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> block_trx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trx_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> information_schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">innodb_trx </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> request_trx </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> waits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requesting_trx_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request_trx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trx_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> information_schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">innodb_locks </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> locks </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> waits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requested_lock_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> locks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock_id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ca5b50cab534a69a49c3e470518e3b6~tplv-k3u1fbpfcp-watermark.image" class="img_ev3q"></p><ol><li>涉及到到记录为 <code>branch_id = 59991915571163137 AND xid = 172.16.120.59:23004:59991911632711680</code></li><li>事务ID<code>1539483284</code>持有该记录的锁，但是它对应的SQL为空，那应该是在等待commit</li><li>事务ID<code>1539483286</code>在尝试获取该记录的锁，但从日志可以发现，它一直锁等待超时</li></ol><p>大概可以猜测是 <code>select for update</code> 和 <code>delete from undo ...</code> 发生了冲突。根据代码中的逻辑，这两个操作应该是放在一个事务中提交了，为什么被分开到两个事务了？</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题分析-1">问题分析<a href="#问题分析-1" class="hash-link" aria-label="问题分析的直接链接" title="问题分析的直接链接">​</a></h2><p>结合上面的介绍的回滚流程看看我们这个例子在回滚时会发生什么</p><ol><li>先获取数据源，此时dataSourceProxy.getPlainConnection()获取到的是<code>MasterSlaveDataSource</code>数据源</li><li>在<code>select for update</code>操作的时候，通过<code>MasterSlaveDataSource</code>获取一个<code>Connection</code>，前面说到过<code>MasterSlaveDataSource</code>是一个逻辑数据源，里面有路由逻辑，根据上面介绍的，这时候拿到的是<code>dsSlave</code>的<code>Connection</code></li><li>在执行<code>delete from undo ...</code>操作的时候，这时候拿到的是<code>dsMaster</code>的<code>Connection</code></li><li>虽然<code>dsSlave</code>和<code>dsMaster</code>对应的是相同的地址，但此时获取到的肯定是不同的连接，所以此时两个操作肯定是分布在两个事务中</li><li>执行<code>select for update</code>的事务，会一直等待直到删除undo_log完成才会提交</li><li>执行<code>delete from undo ...</code>的事务，会一直等待<code>select for update</code>的事务释放锁</li><li>典型的死锁问题</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="验证猜想">验证猜想<a href="#验证猜想" class="hash-link" aria-label="验证猜想的直接链接" title="验证猜想的直接链接">​</a></h2><p>我尝试用了两个方法验证这个问题：</p><ol><li>修改Seata代码，将<code>select for update</code>改成<code>select</code>，此时在查询undo_log就不需要持有该记录的锁，也就不会造成死锁</li></ol><ol start="2"><li>修改数据源代理逻辑，这才是问题的关键，该问题主要原因不是<code>select for update</code>。在此之前多层代理问题已经产生，然后才会造成死锁问题。从头到尾我们就不应该对<code>masterSlave</code>数据源进行代理。它只是一个逻辑数据源，为什么要对它进行代理呢？如果代理<code>masterSlave</code>，就不会造成多层代理问题，也就不会造成删除undo_log时的死锁问题</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="最终实现">最终实现<a href="#最终实现" class="hash-link" aria-label="最终实现的直接链接" title="最终实现的直接链接">​</a></h2><p><code>masterSlave</code>也是一个<code>DataSource</code>类型，该如何仅仅对<code>dsMaster</code> 和 <code>dsSlave</code> 代理而不对<code>masterSlave</code>代理呢？观察<code>SeataAutoDataSourceProxyCreator#shouldSkip</code>方法，我们可以通过EnableAutoDataSourceProxy注解的<code>excludes</code>属性解决这个问题</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected boolean shouldSkip(Class&lt;?&gt; beanClass, String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return SeataProxy.class.isAssignableFrom(beanClass) ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DataSourceProxy.class.isAssignableFrom(beanClass) ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            !DataSource.class.isAssignableFrom(beanClass) ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Arrays.asList(excludes).contains(beanClass.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>即: 将数据源自动代理关闭，然后在启动类加上这个注解</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@EnableAutoDataSourceProxy(excludes = {&quot;org.apache.shardingsphere.shardingjdbc.jdbc.core.datasource.MasterSlaveDataSource&quot;})</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>自动代理在新版本中的优化</h1><p>因为<code>Seata 1.4.0</code>还没有正式发布，我目前看的是<code>1.4.0-SNAPSHOT</code>版本的代码，即当前时间<code>ddevelop</code>分支最新的代码</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="代码改动">代码改动<a href="#代码改动" class="hash-link" aria-label="代码改动的直接链接" title="代码改动的直接链接">​</a></h2><p>主要改动如下，一些小的细节就不过多说明了：</p><ol><li><code>DataSourceProxyHolder</code>调整</li><li><code>DataSourceProxy</code>调整</li><li><code>SeataDataSourceBeanPostProcessor</code>新增</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="datasourceproxyholder">DataSourceProxyHolder<a href="#datasourceproxyholder" class="hash-link" aria-label="DataSourceProxyHolder的直接链接" title="DataSourceProxyHolder的直接链接">​</a></h3><p>在这个类改动中，最主要是其<code>putDataSource</code>方法的改动</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public SeataDataSourceProxy putDataSource(DataSource dataSource, BranchType dataSourceProxyMode) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DataSource originalDataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dataSource instanceof SeataDataSourceProxy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SeataDataSourceProxy dataSourceProxy = (SeataDataSourceProxy) dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果是代理数据源，并且和当前应用配置的数据源代理模式(AT/XA)一样, 则直接返回</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dataSourceProxyMode == dataSourceProxy.getBranchType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (SeataDataSourceProxy)dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果是代理数据源，和当前应用配置的数据源代理模式(AT/XA)不一样，则需要获取其TargetDataSource,然后为其创建一个代理数据源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        originalDataSource = dataSourceProxy.getTargetDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        originalDataSource = dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果有必要，基于 TargetDataSource 创建 代理数据源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return this.dataSourceProxyMap.computeIfAbsent(originalDataSource,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BranchType.XA == dataSourceProxyMode ? DataSourceProxyXA::new : DataSourceProxy::new);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>DataSourceProxyHolder#putDataSource</code>方法主要在两个地方被用到：一个是在<code>SeataAutoDataSourceProxyAdvice</code>切面中；一个是在<code>SeataDataSourceBeanPostProcessor</code>中。
这段判断为我们解决了什么问题？数据源多层代理问题。在开启了数据源自动代理的前提下，思考以下场景：</p><ol><li>如果我们在项目中手动注入了一个<code>DataSourceProxy</code>，这时候在切面调用<code>DataSourceProxyHolder#putDataSource</code>方法时会直接返回该<code>DataSourceProxy</code>本身，而不会为其再创建一个<code>DataSourceProxy</code></li><li>如果我们在项目中手动注入了一个<code>DruidSource</code>，这时候在切面调用<code>DataSourceProxyHolder#putDataSource</code>方法时会为其再创建一个<code>DataSourceProxy</code>并返回</li></ol><p>这样看好像问题已经解决了，有没有可能会有其它的问题呢？看看下面的代码</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DataSourceProxy dsA(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DataSourceProxy(druidA)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DataSourceProxy dsB(DataSourceProxy dsA){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DataSourceProxy(dsA)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>这样写肯定是不对，但如果他就要这样写你也没办法</li><li><code>dsA</code>没什么问题，但<code>dsB</code>还是会产生双层代理的问题，因为此时<code>dsB 的 TargetDataSource</code>是<code>dsA</code></li><li>这就涉及到<code>DataSourceProxy</code>的改动</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="datasourceproxy">DataSourceProxy<a href="#datasourceproxy" class="hash-link" aria-label="DataSourceProxy的直接链接" title="DataSourceProxy的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public DataSourceProxy(DataSource targetDataSource, String resourceGroupId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 下面这个判断，保证了在我们传入一个DataSourceProxy的时候，也不会产生双层代理问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (targetDataSource instanceof SeataDataSourceProxy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;Unwrap the target data source, because the type is: {}&quot;, targetDataSource.getClass().getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        targetDataSource = ((SeataDataSourceProxy) targetDataSource).getTargetDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.targetDataSource = targetDataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init(targetDataSource, resourceGroupId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seatadatasourcebeanpostprocessor">SeataDataSourceBeanPostProcessor<a href="#seatadatasourcebeanpostprocessor" class="hash-link" aria-label="SeataDataSourceBeanPostProcessor的直接链接" title="SeataDataSourceBeanPostProcessor的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class SeataDataSourceBeanPostProcessor implements BeanPostProcessor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(SeataDataSourceBeanPostProcessor.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bean instanceof DataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //When not in the excludes, put and init proxy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!excludes.contains(bean.getClass().getName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //Only put and init proxy, not return proxy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataSourceProxyHolder.get().putDataSource((DataSource) bean, dataSourceProxyMode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //If is SeataDataSourceProxy, return the original data source.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (bean instanceof SeataDataSourceProxy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.info(&quot;Unwrap the bean of the data source,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot; and return the original data source to replace the data source proxy.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return ((SeataDataSourceProxy) bean).getTargetDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><code>SeataDataSourceBeanPostProcessor</code>实现了<code>BeanPostProcessor</code>接口，在一个bean初始化后，会执行<code>BeanPostProcessor#postProcessAfterInitialization</code>方法。也就是说，在<code>postProcessAfterInitialization</code>方法中，这时候的bean已经是可用状态了</li><li>为什么要提供这么一个类呢？从它的代码上来看，仅仅是为了再bean初始化之后，为数据源初始化对应的<code>DataSourceProxy</code>，但为什么要这样做呢？<blockquote><p>因为有些数据源在应用启动之后，可能并不会初始化(即不会调用数据源的相关方法)。如果没有提供<code>SeataDataSourceBeanPostProcessor</code>类，那么就只有在<code>SeataAutoDataSourceProxyAdvice</code>切面中才会触发<code>DataSourceProxyHolder#putDataSource</code>方法。假如有一个客户端在回滚的时候宕机了，在重启之后，Server端通过定时任务向其派发回滚请求，这时候客户端需要先根据<code>rsourceId</code>(连接地址)找到对应的<code>DatasourceProxy</code>。但如果在此之前客户端还没有主动触发数据源的相关方法，就不会进入<code>SeataAutoDataSourceProxyAdvice</code>切面逻辑，也就不会为该数据源初始化对应的<code>DataSourceProxy</code>，从而导致回滚失败</p></blockquote></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="多层代理总结">多层代理总结<a href="#多层代理总结" class="hash-link" aria-label="多层代理总结的直接链接" title="多层代理总结的直接链接">​</a></h2><p>通过上面的分析，我们大概已经知道了seata在避免多层代理上的一些优化，但其实还有一个问题需要注意：<strong>逻辑数据源的代理</strong>
<img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6910095aadab436eaffe03a752e44240~tplv-k3u1fbpfcp-watermark.image" class="img_ev3q"></p><p>这时候的调用关系为： <code>masterSlaveProxy -&gt;　masterSlave -&gt;  masterproxy/slaveProxy -&gt;  master/slave</code></p><p>此时可以通过<code>excludes</code>属性排除逻辑数据源，从而不为其创建数据源代理。</p><p>总结一下：</p><ol><li>在为<code>数据源</code>初始化对应的<code>DataSourceProxy</code>时，判断是否有必要为其创建对应的<code>DataSourceProxy</code>，如果本身就是<code>DataSourceProxy</code>，就直接返回</li><li>针对一些<code>数据源</code>手动注入的情况，为了避免一些人为误操作的导致的多层代理问题，在<code>DataSourceProxy</code>构造函数中添加了判断，<code>如果入参TragetDatasource本身就是一个DataSourceProxy， 则获取其target属性作为新DataSourceProxy的tragetDatasource</code></li><li>针对一些其它情况，比如<strong>逻辑数据源代理问题</strong>，通过<code>excludes</code>属性添加排除项，这样可以避免为逻辑数据源创建<code>DataSourceProxy</code></li></ol><h1>全局事务和本地事务使用建议</h1><p>有一个问题，如果在一个方法里涉及到多个DB操作，比如涉及到3条update操作，我们需不需在这个方法使用spring中的<code>@Transactional</code>注解？针对这个问题，我们分别从两个角度考虑：不使用<code>@Transactional</code>注解 和 使用<code>@Transactional</code>注解</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="不使用transactional注解">不使用<code>@Transactional</code>注解<a href="#不使用transactional注解" class="hash-link" aria-label="不使用transactional注解的直接链接" title="不使用transactional注解的直接链接">​</a></h2><ol><li>在提交阶段，因为该分支事务有3条update操作，每次执行update操作的时候，都会通过数据代理向TC注册一个分支事务，并为其生成对应的undo_log，最终3个update操作被当作3个分支事务来处理</li><li>在回滚阶段，需要回滚3个分支事务</li><li>数据的一致性通过seata全局事务来保证</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用transactional注解">使用<code>@Transactional</code>注解<a href="#使用transactional注解" class="hash-link" aria-label="使用transactional注解的直接链接" title="使用transactional注解的直接链接">​</a></h2><ol><li>在提交阶段，3个update操作被当作一个分支事务来提交，所以最终只会注册一个分支事务</li><li>在回滚阶段，需要回滚1个分支事务</li><li>数据的一致性：这3个update的操作通过本地事务的一致性保证；全局一致性由seata全局事务来保证。此时3个update仅仅是一个分支事务而已</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="结论">结论<a href="#结论" class="hash-link" aria-label="结论的直接链接" title="结论的直接链接">​</a></h2><p>通过上面的对比，答案是显而易见的，合理的使用本地事务，可以大大的提升全局事务的处理速度。上面仅仅是3个DB操作，如果一个方法里面涉及到的DB操作更多呢，这时候两种方式的差别是不是更大呢？</p><p>最后，感谢@FUNKYE大佬为我解答了很多问题并提供了宝贵建议！</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-08-25T00:00:00.000Z" itemprop="datePublished">2020年8月25日</time> · <!-- -->阅读需 12 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">杨晓兵|中原银行</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分布式事务seata源码解读二client端启动流程">【分布式事务Seata源码解读二】Client端启动流程<a href="#分布式事务seata源码解读二client端启动流程" class="hash-link" aria-label="【分布式事务Seata源码解读二】Client端启动流程的直接链接" title="【分布式事务Seata源码解读二】Client端启动流程的直接链接">​</a></h2><p>本文从源码的角度分析一下AT模式下Client端启动流程，所谓的Client端，即业务应用方。分布式事务分为三个模块：TC、TM、RM。其中TC位于seata-server端，而TM、RM通过SDK的方式运行在client端。</p><p>下图展示了Seata官方Demo的一个分布式事务场景，分为如下几个微服务，共同实现了一个下订单、扣库存、扣余额的分布式事务。</p><ul><li><strong>BusinessService：</strong> 业务服务，下单服务的入口</li><li><strong>StorageService：</strong> 库存微服务，用于扣减商品库存</li><li><strong>OrderService：</strong> 订单微服务，创建订单</li><li><strong>AccountService：</strong> 账户微服务，扣减用户账户的余额</li></ul><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20200820184156758.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTE0NTg0OA==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" class="img_ev3q"></p><p>从上图也可以看出，在AT模式下Seata Client端主要通过如下三个模块来实现分布式事务：</p><ul><li><strong>GlobalTransactionScanner：</strong>  GlobalTransactionScanner负责初始TM、RM模块，并为添加分布式事务注解的方法添加拦截器，拦截器负责全局事务的开启、提交或回滚</li><li><strong>DatasourceProxy：</strong> DatasourceProxy为DataSource添加拦截，拦截器会拦截所有SQL执行，并作为RM事务参与方的角色参与分布式事务执行。</li><li><strong>Rpc Interceptor：</strong> 在上一篇<a href="https://blog.csdn.net/weixin_45145848/article/details/106930538" target="_blank" rel="noopener noreferrer">分布式事务Seata源码解读一</a>中有提到分布式事务的几个核心要点，其中有一个是分布式事务的跨服务实例传播。Rpc Interceptor的职责就是负责在多个微服务之间传播事务。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata-spring-boot-starter">seata-spring-boot-starter<a href="#seata-spring-boot-starter" class="hash-link" aria-label="seata-spring-boot-starter的直接链接" title="seata-spring-boot-starter的直接链接">​</a></h2><p>引用seata分布式事务SDK有两种方式，依赖seata-all或者seata-spring-boot-starter，推荐使用seata-spring-boot-starter，因为该starter已经自动注入了上面提到的三个模块，用户只要添加相应的配置，在业务代码添加全局分布式事务注解即可。下面从seata-spring-boot-starter项目中的代码入手：</p><p>如下图所示是seata-spring-boot-starter的项目结构：
<img loading="lazy" src="https://img-blog.csdnimg.cn/20200810204518853.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTE0NTg0OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" class="img_ev3q">
主要分为以下几个模块：</p><ul><li><strong>properties：</strong> properties目录下都是Springboot 适配seata的相关配置类，即可以通过SpringBoot的配置方式来Seata的相关参数</li><li><strong>provider：</strong> provider目录下的类负责把Springboot、SpringCloud的配置适配到Seata配置中</li><li><strong>resources：</strong> resources目录下主要有两个文件，spring.factories用于注册Springboot的自动装配类，ExtConfigurationProvider用于注册SpringbootConfigurationProvider类，该Provider类负责把SpringBoot的相关配置类适配到Seata中。</li></ul><p>对于springboot-starter项目，我们先查看resources/META-INF/spring.factories文件：</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Auto Configure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.springframework.boot.autoconfigure.EnableAutoConfiguration=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io.seata.spring.boot.autoconfigure.SeataAutoConfiguration</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到在spring.factories中配置了自动装配类：SeataAutoConfiguration，在该装配类中主要注入了GlobalTransactionScanner和seataAutoDataSourceProxyCreator两个实例。代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ComponentScan(basePackages = &quot;io.seata.spring.boot.autoconfigure.properties&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = StarterConstants.SEATA_PREFIX, name = &quot;enabled&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        havingValue = &quot;true&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        matchIfMissing = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties({SeataProperties.class})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SeataAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // GlobalTransactionScanner负责为添加GlobalTransaction注解的方法添加拦截器，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 并且负责初始化RM、TM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @DependsOn({BEAN_NAME_SPRING_APPLICATION_CONTEXT_PROVIDER, BEAN_NAME_FAILURE_HANDLER})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @ConditionalOnMissingBean(GlobalTransactionScanner.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public GlobalTransactionScanner globalTransactionScanner(SeataProperties seataProperties,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                           FailureHandler failureHandler) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (LOGGER.isInfoEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOGGER.info(&quot;Automatically configure Seata&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new GlobalTransactionScanner(seataProperties.getApplicationId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seataProperties.getTxServiceGroup(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            failureHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // SeataAutoDataSourceProxyCreator负责为Spring中的所有DataSource生成代理对象，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 从而实现拦截所有SQL的执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Bean(BEAN_NAME_SEATA_AUTO_DATA_SOURCE_PROXY_CREATOR)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @ConditionalOnProperty(prefix = StarterConstants.SEATA_PREFIX, name = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;enableAutoDataSourceProxy&quot;, &quot;enable-auto&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;-data-source-proxy&quot;}, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @ConditionalOnMissingBean(SeataAutoDataSourceProxyCreator.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public SeataAutoDataSourceProxyCreator seataAutoDataSourceProxyCreator(SeataProperties seataProperties) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new SeataAutoDataSourceProxyCreator(seataProperties.isUseJdkProxy(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seataProperties.getExcludesForAutoProxying());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="globaltransactionscanner">GlobalTransactionScanner<a href="#globaltransactionscanner" class="hash-link" aria-label="GlobalTransactionScanner的直接链接" title="GlobalTransactionScanner的直接链接">​</a></h3><p>GlobalTransactionScanner继承于AutoProxyCreator，AutoProxyCreator是Spring中实现AOP的一种方式，可以拦截Spring中的所有实例，判断是否需要进行代理。下面列出了GlobalTransactionScanner中一些比较重要的字段和拦截代理的核心方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionScanner extends AbstractAutoProxyCreator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        implements InitializingBean, ApplicationContextAware,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DisposableBean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // interceptor字段是对应一个代理对象的拦截器，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 可以认为是一个临时变量，有效期是一个被代理对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private MethodInterceptor interceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // globalTransactionalInterceptor是通用的Interceptor，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 非TCC事务方式的都使用该Interceptor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private MethodInterceptor globalTransactionalInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // PROXYED_SET存储已经代理过的实例，防止重复处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static final Set&lt;String&gt; PROXYED_SET = new HashSet&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // applicationId是一个服务的唯一标识，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 对应springcloud项目中的spring.application.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final String applicationId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 事务的分组标识，参考文章wiki：http://seata.io/zh-cn/docs/user/txgroup/transaction-group.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final String txServiceGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 判断是否需要代理目标对象，如果需要代理，则生成拦截器赋值到类变量interceptor中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 判断是否禁用分布式事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (disableGlobalTransaction) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      synchronized (PROXYED_SET) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (PROXYED_SET.contains(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 每次处理一个被代理对象时先把interceptor置为null，所以interceptor的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 生命周期是一个被代理对象，由于是在另外一个方法getAdvicesAndAdvisorsForBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 中使用interceptor，所以该interceptor要定义为一个类变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interceptor = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断是否是TCC事务模式，判断的主要依据是方法上是否有TwoPhaseBusinessAction注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (TCCBeanParserUtils.isTccAutoProxy(bean, beanName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                applicationContext)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 创建一个TCC事务的拦截器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          interceptor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  new TccActionInterceptor(TCCBeanParserUtils.getRemotingDesc(beanName));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 获取待处理对象的class类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Class&lt;?&gt; serviceInterface = SpringProxyUtils.findTargetClass(bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 获取待处理对象继承的所有接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Class&lt;?&gt;[] interfacesIfJdk = SpringProxyUtils.findInterfaces(bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 如果待处理对象的class或者继承的接口上有GlobalTransactional注解，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 或者待处理对象的class的任一个方法上有GlobalTransactional或者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // GlobalLock注解则返回true，即需要被代理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (!existsAnnotation(new Class[]{serviceInterface})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &amp;&amp; !existsAnnotation(interfacesIfJdk)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 如果interceptor为null，即不是TCC模式，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 则使用globalTransactionalInterceptor作为拦截器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (interceptor == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // globalTransactionalInterceptor只会被创建一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (globalTransactionalInterceptor == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              globalTransactionalInterceptor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      new GlobalTransactionalInterceptor(failureHandlerHook);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ConfigurationCache.addConfigListener(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      (ConfigurationChangeListener) globalTransactionalInterceptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            interceptor = globalTransactionalInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!AopUtils.isAopProxy(bean)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 如果bean本身不是Proxy对象，则直接调用父类的wrapIfNecessary生成代理对象即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 在父类中会调用getAdvicesAndAdvisorsForBean获取到上面定义的interceptor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          bean = super.wrapIfNecessary(bean, beanName, cacheKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 如果该bean已经是代理对象了，则直接在代理对象的拦截调用链AdvisedSupport</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 上直接添加新的interceptor即可。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          AdvisedSupport advised = SpringProxyUtils.getAdvisedSupport(bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Advisor[] advisor = buildAdvisors(beanName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  getAdvicesAndAdvisorsForBean(null, null, null));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          for (Advisor avr : advisor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            advised.addAdvisor(0, avr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 标识该beanName已经处理过了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PROXYED_SET.add(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception exx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new RuntimeException(exx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 返回wrapIfNecessary方法中计算出的interceptor对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected Object[] getAdvicesAndAdvisorsForBean(Class beanClass, String beanName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  TargetSource customTargetSource)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new Object[]{interceptor};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面介绍了GlobalTransactionScanner是如何通过注解拦截全局事务的，具体拦截器实现为TccActionInterceptor和GlobalTransactionalInterceptor，对于AT模式来说我们主要关心GlobalTransactionalInterceptor，在后续的文章中会介绍GlobalTransactionalInterceptor的具体实现。</p><p>另外GloabalTransactionScanner还负责TM、RM的初始化工作，是在initClient方法中实现的：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void initClient() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //初始化TM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //初始化RM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RMClient.init(applicationId, txServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 注册Spring shutdown的回调，用来释放资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registerSpringShutdownHook();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TMClient、RMClient都是Seata基于Netty实现的Rpc框架的客户端类，只是业务逻辑不同，由于TMClient相对来说更简单一些，我们以RMClient为例看一下源码：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class RMClient {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // RMClient的init是一个static方法，创建了一个RmNettyRemotingClient实例，并调用init方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void init(String applicationId, String transactionServiceGroup) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RmNettyRemotingClient rmNettyRemotingClient =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RmNettyRemotingClient.getInstance(applicationId, transactionServiceGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmNettyRemotingClient.setResourceManager(DefaultResourceManager.get());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmNettyRemotingClient.setTransactionMessageHandler(DefaultRMHandler.get());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmNettyRemotingClient.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>RmNettyRemotingClient的实现如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Sharable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class RmNettyRemotingClient extends AbstractNettyRemotingClient {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ResourceManager负责处理事务参与方，支持AT、TCC、Saga三种模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private ResourceManager resourceManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // RmNettyRemotingClient单例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static volatile RmNettyRemotingClient instance;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final AtomicBoolean initialized = new AtomicBoolean(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 微服务的唯一标识</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String applicationId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 分布式事务分组名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String transactionServiceGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // RMClient中init方法会调用该init方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 注册Seata自定义Rpc的Processor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registerProcessor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (initialized.compareAndSet(false, true)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 调用父类的init方法，在父类中负责Netty的初始化，与Seata-Server建立连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      super.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 注册Seata自定义Rpc的Processor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private void registerProcessor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1.注册Seata-Server发起branchCommit的处理Processor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RmBranchCommitProcessor rmBranchCommitProcessor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new RmBranchCommitProcessor(getTransactionMessageHandler(), this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_BRANCH_COMMIT, rmBranchCommitProcessor,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2.注册Seata-Server发起branchRollback的处理Processor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RmBranchRollbackProcessor rmBranchRollbackProcessor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new RmBranchRollbackProcessor(getTransactionMessageHandler(), this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_BRANCH_ROLLBACK, rmBranchRollbackProcessor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            , messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3.注册Seata-Server发起删除undoLog的处理Processor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RmUndoLogProcessor rmUndoLogProcessor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new RmUndoLogProcessor(getTransactionMessageHandler());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_RM_DELETE_UNDOLOG, rmUndoLogProcessor,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 4.注册Seata-Server返回Response的处理Processor，ClientOnResponseProcessor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 用于处理由Client主动发起Request，Seata-Server返回的Response。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ClientOnResponseProcessor负责把Client发送的Request和Seata-Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 返回的Response对应起来，从而实现Rpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientOnResponseProcessor onResponseProcessor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new ClientOnResponseProcessor(mergeMsgMap, super.getFutures(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    getTransactionMessageHandler());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_SEATA_MERGE_RESULT, onResponseProcessor,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_BRANCH_REGISTER_RESULT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            onResponseProcessor, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_BRANCH_STATUS_REPORT_RESULT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            onResponseProcessor, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_GLOBAL_LOCK_QUERY_RESULT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            onResponseProcessor, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_REG_RM_RESULT, onResponseProcessor, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 5. 处理Seata-Server返回的Pong消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientHeartbeatProcessor clientHeartbeatProcessor = new ClientHeartbeatProcessor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_HEARTBEAT_MSG, clientHeartbeatProcessor,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的逻辑看起来比较复杂，相关类也比较多，如：各种Processor、各种MessageType、TransactionMessageHandler、ResourceManager。其实本质上就是Rpc调用，分为Rm主动调用和Seata主动调用。</p><ul><li><strong>Rm主动调用方法：</strong> 如：注册分支、汇报分支状态、申请全局锁等。Rm主动调用的方法都需要在ClientOnResponseProcessor中处理Seata-Server返回的Response</li><li><strong>Seata-Server主动调用方法：</strong> 如：提交分支事务、回滚分支事务、删除undolog日志。Seata-Server主动调用的方法，Client端分别对应不同的Processor来处理，并且处理结束后要返回给Seata-Server处理结果Response。而事务提交、回滚的核心实现逻辑都在TransactionMessageHandler、ResourceManager中。</li></ul><p>关于TransactionMessageHandler、ResourceManager的具体实现也会在后续的章节中详细描述。</p><p>下一篇会介绍一下SeataAutoDataSourceProxyCreator、Rpc Interceptor是如何初始化以及拦截的。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-at-demo-in-mac">Mac下的Seata Demo环境搭建（AT模式）</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-07-20T00:00:00.000Z" itemprop="datePublished">2020年7月20日</time> · <!-- -->阅读需 9 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">portman xu</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>最近因为工作需要，研究学习了Seata分布式事务框架，本文把自己学习的知识记录一下</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata总览">Seata总览<a href="#seata总览" class="hash-link" aria-label="Seata总览的直接链接" title="Seata总览的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cloc代码统计">cloc代码统计<a href="#cloc代码统计" class="hash-link" aria-label="cloc代码统计的直接链接" title="cloc代码统计的直接链接">​</a></h3><p>先看一下seata项目cloc代码统计（截止到2020-07-20）</p><p><img loading="lazy" src="https://github.com/iportman/p/blob/master/blog/seata-at-demo-in-mac/cloc-seata.png?raw=true" alt="cloc-seata" class="img_ev3q"></p><p>Java代码行数大约是 97K</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码质量">代码质量<a href="#代码质量" class="hash-link" aria-label="代码质量的直接链接" title="代码质量的直接链接">​</a></h3><p>单元测试覆盖率50%</p><p><img loading="lazy" src="https://github.com/iportman/p/blob/master/blog/seata-at-demo-in-mac/coverage.png?raw=true" alt="cloc-seata" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="demo代码">Demo代码<a href="#demo代码" class="hash-link" aria-label="Demo代码的直接链接" title="Demo代码的直接链接">​</a></h3><p>本文讲的Demo代码是seata-samples项目下的seata-samples-dubbo模块，地址如下：</p><p><a href="https://github.com/apache/incubator-seata-samples/tree/master/dubbo" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-samples/tree/master/dubbo</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决的核心问题">解决的核心问题<a href="#解决的核心问题" class="hash-link" aria-label="解决的核心问题的直接链接" title="解决的核心问题的直接链接">​</a></h2><p>AT模式的Demo例子给出了一个典型的分布式事务场景：</p><ul><li>在一个采购交易中，需要：</li></ul><ol><li>扣减商品库存</li><li>扣减用户账号余额</li><li>生成采购订单</li></ol><ul><li>很明显，以上3个步骤必须：要么全部成功，要么全部失败，否则系统的数据会错乱</li><li>而现在流行的微服务架构，一般来说，库存，账号余额，订单是3个独立的系统</li><li>每个微服务有自己的数据库，相互独立</li></ul><p>这里就是分布式事务的场景。</p><p><img loading="lazy" src="http://seata.io/img/architecture.png" alt="设计图" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="#解决方案" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h2><p>AT模式解决这个问题的思路其实很简单，一句话概括就是：</p><p>在分布式事务过程中，记录待修改的数据修改前和修改后的值到undo_log表，万一交易中出现异常，通过这个里的数据做回滚</p><p>当然，具体代码实现起来，我相信很多细节远没这么简单。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="demo代码结构">Demo代码结构<a href="#demo代码结构" class="hash-link" aria-label="Demo代码结构的直接链接" title="Demo代码结构的直接链接">​</a></h2><p>从github上clone最新的代码</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone git@github.com:apache/incubator-seata-samples.git</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>阅读Demo代码结构</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd seata-samples/dubbo/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tree -C  -I &#x27;target&#x27; .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pom.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── seata-samples-dubbo.iml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │   └── io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │       └── seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │           └── samples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │               └── dubbo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   ├── ApplicationKeeper.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   ├── Order.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   ├── service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   │   ├── AccountService.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   │   ├── BusinessService.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   │   ├── OrderService.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   │   ├── StorageService.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   │   └── impl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   │       ├── AccountServiceImpl.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   │       ├── BusinessServiceImpl.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   │       ├── OrderServiceImpl.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   │       └── StorageServiceImpl.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                   └── starter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                       ├── DubboAccountServiceStarter.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                       ├── DubboBusinessTester.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                       ├── DubboOrderServiceStarter.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │                       └── DubboStorageServiceStarter.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └── resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ├── file.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ├── jdbc.properties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ├── log4j.properties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ├── registry.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ├── spring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │   ├── dubbo-account-service.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │   ├── dubbo-business.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │   ├── dubbo-order-service.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            │   └── dubbo-storage-service.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            └── sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ├── dubbo_biz.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                └── undo_log.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13 directories, 27 files</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>在io.seata.samples.dubbo.starter包下的4个<!-- -->*<!-- -->Starter类，分别模拟上面所述的4个微服务</p><ul><li>Account</li><li>Business</li><li>Order</li><li>Storage</li></ul></li><li><p>4个服务都是标准的dubbo服务，配置文件在seata-samples/dubbo/src/main/resources/spring目录下</p></li><li><p>运行demo需要把这4个服务都启动起来，Business最后启动</p></li><li><p>主要的逻辑在io.seata.samples.dubbo.service，4个实现类分别对应4个微服务的业务逻辑</p></li><li><p>数据库信息的配置文件：src/main/resources/jdbc.properties</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="时序图">时序图<a href="#时序图" class="hash-link" aria-label="时序图的直接链接" title="时序图的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/iportman/p/blob/master/blog/seata-at-demo-in-mac/timing-diagram.png?raw=true" alt="cloc-seata" class="img_ev3q"></p><p>Ok, 赶紧动手, Make It Happen!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="运行demo">运行Demo<a href="#运行demo" class="hash-link" aria-label="运行Demo的直接链接" title="运行Demo的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mysql">MySQL<a href="#mysql" class="hash-link" aria-label="MySQL的直接链接" title="MySQL的直接链接">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="建表">建表<a href="#建表" class="hash-link" aria-label="建表的直接链接" title="建表的直接链接">​</a></h3><p>执行seata-samples/dubbo/src/main/resources/sql的脚本dubbo_biz.sql和undo_log.sql</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; show tables;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Tables_in_seata |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| account_tbl     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| order_tbl       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| storage_tbl     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| undo_log        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 rows in set (0.01 sec)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行完之后，数据库里应该有4个表</p><p>修改seata-samples/dubbo/src/main/resources/jdbc.properties文件</p><p>根据你MySQL运行的环境修改变量的值</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.account.url=jdbc:mysql://localhost:3306/seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.account.username=your_username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.account.password=your_password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.account.driver=com.mysql.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># storage db config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.storage.url=jdbc:mysql://localhost:3306/seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.storage.username=your_username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.storage.password=your_password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.storage.driver=com.mysql.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># order db config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.order.url=jdbc:mysql://localhost:3306/seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.order.username=your_username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.order.password=your_password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jdbc.order.driver=com.mysql.jdbc.Driver</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="zookeeper">ZooKeeper<a href="#zookeeper" class="hash-link" aria-label="ZooKeeper的直接链接" title="ZooKeeper的直接链接">​</a></h3><p>启动ZooKeeper，我的本地的Mac是使用Homebrew安装启动的</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew services start zookeeper </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==&gt; Successfully started `zookeeper` (label: homebrew.m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ brew services list           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name              Status  User    Plist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-machine    stopped         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch     stopped         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafka             stopped         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kibana            stopped         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql             started portman /Users/portman/Librar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">y/LaunchAgents/homebrew.mxcl.mysql.plist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx             stopped         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgresql        stopped         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis             stopped         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zookeeper         started portman /Users/portman/Librar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">y/LaunchAgents/homebrew.mxcl.zookeeper.plist</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动tc事务协调器">启动TC事务协调器<a href="#启动tc事务协调器" class="hash-link" aria-label="启动TC事务协调器的直接链接" title="启动TC事务协调器的直接链接">​</a></h3><p>在这个<a href="https://github.com/apache/incubator-seata/releases" target="_blank" rel="noopener noreferrer">链接</a>里页面中，下载对应版本的seata-server程序，我本地下载的是1.2.0版本</p><ol><li>进入文件所在目录并解压文件</li><li>进入seata目录</li><li>执行启动脚本</li></ol><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ tar -zxvf seata-server-1.2.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ bin/seata-server.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>观察启动日志是否有报错信息，如果一切正常，并看到了以下的Server started的信息，说明启动成功了。</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-23 13:45:13.810 INFO [main]io.seata.core.rpc.netty.RpcServerBootstrap.start:155 -Server started ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ide中启动模拟的微服务">IDE中启动模拟的微服务<a href="#ide中启动模拟的微服务" class="hash-link" aria-label="IDE中启动模拟的微服务的直接链接" title="IDE中启动模拟的微服务的直接链接">​</a></h3><ol><li>首先要把seata-samples项目导入到本地IDE中，这里我用的是IntelliJ IDEA</li><li>刷新Maven的工程依赖</li><li>先启动Account，Order，Storage这个3个服务，然后Business才能去调用，对应的启动类分别是：</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">io.seata.samples.dubbo.starter.DubboStorageServiceStarter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io.seata.samples.dubbo.starter.DubboOrderServiceStarter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io.seata.samples.dubbo.starter.DubboStorageServiceStarter</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>每个服务启动完之后，看到这句提示信息，说明服务启动成功了</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Application is keep running ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://github.com/iportman/p/blob/master/blog/seata-at-demo-in-mac/service-boot.png?raw=true" alt="cloc-seata" class="img_ev3q"></p><p>启动成功后，account_tbl，storage_tbl表会有两条初始化的数据，分别是账户余额和商品库存</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; SELECT * FROM account_tbl; SELECT * FROM storage_tbl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | user_id | money |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | U100001 |   999 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+----------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | commodity_code | count |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+----------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | C00321         |   100 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+----------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用business验证效果">使用Business验证效果<a href="#使用business验证效果" class="hash-link" aria-label="使用Business验证效果的直接链接" title="使用Business验证效果的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="正常情况">正常情况<a href="#正常情况" class="hash-link" aria-label="正常情况的直接链接" title="正常情况的直接链接">​</a></h4><p>还是在IDE中执行DubboBusinessTester类的主函数，程序跑完会自动退出</p><p>在程序一切正常的情况下，每个微服务的事物都应该是提交了的，数据保持一致</p><p>我们来看一下MySQL中数据的变化</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; SELECT * FROM account_tbl; SELECT * FROM order_tbl; SELECT * FROM storage_tbl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | user_id | money |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | U100001 |   599 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+----------------+-------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | user_id | commodity_code | count | money |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+----------------+-------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | U100001 | C00321         |     2 |   400 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+----------------+-------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+----------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | commodity_code | count |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+----------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | C00321         |    98 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+----------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.00 sec)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从3个表的数据可以看到：账户余额扣减了400块；订单表增加了1条记录；商品库存扣减了2个</p><p>这个结果是程序的逻辑是一致的，说明事务没有问题</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="异常情况">异常情况<a href="#异常情况" class="hash-link" aria-label="异常情况的直接链接" title="异常情况的直接链接">​</a></h4><p>其实即使不加入分布式事务的控制，一切都正常情况下，事务本身就不会有问题的</p><p>所以我们来重点关注，当程序出现异常时的情况</p><p>现在我把BusinessServiceImpl的抛异常的代码注释放开，然后再执行一次DubboBusinessTester，来看看有什么情况发生</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional(timeoutMills = 300000, name = &quot;dubbo-demo-tx&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void purchase(String userId, String commodityCode, int orderCount) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;purchase begin ... xid: &quot; + RootContext.getXID());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageService.deduct(commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderService.create(userId, commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //放开这句抛异常的注释，模拟程序出现异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new RuntimeException(&quot;portman&#x27;s foooooobar error.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接着，我再一次执行DubboBusinessTester，执行过程中在控制台可以看到异常报错信息</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Exception in thread &quot;main&quot; java.lang.RuntimeException: portman&#x27;s foooooobar error.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在我们再看一下MySQL里的数据变化，发现数据没有任何变化，说明分布式事务的控制已经起作用了</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="待思考问题">待思考问题<a href="#待思考问题" class="hash-link" aria-label="待思考问题的直接链接" title="待思考问题的直接链接">​</a></h2><p>上面的步骤只是演示了seata最简单的demo程序，更多更复杂的情况后续大家可以一起讨论和验证</p><p>学习过程中还有一些问题和疑惑，后续进一步学习</p><ul><li>全局锁对性能的影响程度</li><li>undo_log日志可以回滚到原来状态，但是如果数据状态已经发生变化如何处理（比如增加的用户积分已经被别的本地事务花掉了）</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考文献">参考文献<a href="#参考文献" class="hash-link" aria-label="参考文献的直接链接" title="参考文献的直接链接">​</a></h2><ul><li><a href="http://seata.io/zh-cn/docs/overview/what-is-seata.html" target="_blank" rel="noopener noreferrer">Seata 是什么?</a></li><li><a href="http://seata.io/zh-cn/docs/user/quickstart.html" target="_blank" rel="noopener noreferrer">快速开始</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="作者信息">作者信息<a href="#作者信息" class="hash-link" aria-label="作者信息的直接链接" title="作者信息的直接链接">​</a></h2><p>许晓加，金蝶软件架构师</p><p><a href="https://github.com/iportman" target="_blank" rel="noopener noreferrer">Github</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-07-13T00:00:00.000Z" itemprop="datePublished">2020年7月13日</time> · <!-- -->阅读需 12 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>RPC 模块是我最初研究 Seata 源码开始的地方，因此我对 Seata 的 RPC 模块有过一些深刻研究，在我研究了一番后，发现 RPC 模块中的代码需要进行优化，使得代码更加优雅，交互逻辑更加清晰易懂，本着 “<strong>让天下没有难懂的
RPC 通信代码</strong>” 的初衷，我开始了 RPC 模块的重构之路。</p><p>这里建议想要深入了解 Seata 交互细节的，不妨从 RPC 模块的源码入手，RPC 模块相当于 Seata 的中枢，Seata 所有的交互逻辑在 RPC 模块中表现得淋漓尽致。</p><p>这次 RPC 模块的重构将会使得 Seata 的中枢变得更加健壮和易于解读。</p><h1>重构继承关系</h1><p>在 Seata 的旧版本中，RPC 模块的整体结构有点混乱，尤其是在各个类的继承关系上，主要体现在：</p><ol><li>直接在 Remoting 类继承 Netty Handler，使得 Remoting 类与 Netty Handler 处理逻辑耦合在一起；</li><li>客户端和服务端的 Reomting 类继承关系不统一；</li><li>RemotingClient 被 RpcClientBootstrap 实现，而 RemotingServer 却被 RpcServer 实现，没有一个独立的 ServerBootstrap，这个看起来关系非常混乱；</li><li>有些接口没必要抽取出来，比如 ClientMessageSender、ClientMessageListener、ServerMessageSender 等接口，因这些接口会增加整体结构继承关系的复杂性。</li></ol><p>针对上面发现的问题，在重构过程中我大致做了如下事情：</p><ol><li>将 Netty Handler 抽象成一个内部类放在 Remoting 类中；</li><li>将 RemotingClient 为客户端顶级接口，定义客户端与服务端交互的基本方法，抽象一层 AbstractNettyRemotingClient，下面分别有
RmNettyRemotingClient、TmNettyRemotingClient；将 RemotingServer 为服务端顶级接口，定义服务端与客户端交互的基本方法，实现类 NettyRemotingServer；</li><li>同时将 ClientMessageSender、ClientMessageListener、ServerMessageSender 等接口方法归入到 RemotingClient、RemotingServer 中，由 Reomting
类实现 RemotingClient、RemotingServer，统一 Remoting 类继承关系；</li><li>新建 RemotingBootstrap 接口，客户端和服务端分别实现 NettyClientBootstrap、NettyServerBootstrap，将引导类逻辑从 Reomting 类抽离出来。</li></ol><p>在最新的 RPC 模块中的继承关系简单清晰，用如下类关系图表示：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200711111637.png" class="img_ev3q"></p><ol><li>AbstractNettyRemoting：Remoting 类的最顶层抽象，包含了客户端和服务端公用的成员变量与公用方法，拥有通用的请求方法（文章后面会讲到），Processor 处理器调用逻辑（文章后面会讲到）；</li><li>RemotingClient：客户端最顶级接口，定义客户端与服务端交互的基本方法；</li><li>RemotingServer：服务端最顶级接口，定义服务端与客户端交互的基本方法；</li><li>AbstractNettyRemotingClient：客户端抽象类，继承 AbstractNettyRemoting 类并实现了 RemotingClient 接口；</li><li>NettyRemotingServer：服务端实现类，继承 AbstractNettyRemoting 类并实现了 RemotingServer 接口；</li><li>RmNettyRemotingClient：Rm 客户端实现类，继承 AbstractNettyRemotingClient 类；</li><li>TmNettyRemotingClient：Tm 客户端实现类，继承 AbstractNettyRemotingClient 类。</li></ol><p>同时将客户端和服务端的引导类逻辑抽象出来，如下类关系图表示：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200510225359.png" class="img_ev3q"></p><ol><li>RemotingBootstrap：引导类接口，有 start 和 stop 两个抽象方法；</li><li>NettyClientBootstrap：客户端引导实现类；</li><li>NettyServerBootstrap：服务端引导实现类。</li></ol><h1>解耦处理逻辑</h1><p>解耦处理逻辑即是将 RPC 交互的处理逻辑从 Netty Handler 中抽离出来，并将处理逻辑抽象成一个个 Processor，为什么要这么做呢？我大致讲下现在存在的一些问题：</p><ol><li>Netty Handler 与 处理逻辑是糅合在一起的，由于客户端与服务端都共用了一套处理逻辑，因此为了兼容更多的交互，在处理逻辑中你可以看到非常多难以理解的判断逻辑；</li><li>在 Seata 的交互中有些请求是异步处理的，也有一些请求是同步处理的，但是在旧的处理代码逻辑中对同步异步处理的表达非常隐晦，而且难以看明白；</li><li>无法从代码逻辑当中清晰地表达出请求消息类型与对应的处理逻辑关系；</li><li>在 Seata 后面的更新迭代中，如果不将处理处理逻辑抽离出来，这部分代码想要增加新的交互逻辑，将会非常困难。</li></ol><p>在将处理逻辑从 Netty Handler 进行抽离之前，我们先梳理一下 Seata 现有的交互逻辑：</p><ul><li>RM 客户端请求服务端的交互逻辑：</li></ul><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/Xnip2020-05-12_21-41-45.png" class="img_ev3q"></p><ul><li>TM 客户端请求服务端的交互逻辑：</li></ul><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/Xnip2020-05-12_21-44-04.png" class="img_ev3q"></p><ul><li>服务端请求 RM 客户端的交互逻辑：</li></ul><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200513000620.png" class="img_ev3q"></p><p>从以上的交互图中可以清晰地看到了 Seata 的交互逻辑。</p><p>客户端总共接收服务端的消息：</p><p>1）服务端请求消息</p><ol><li>BranchCommitRequest、BranchRollbackRequest、UndoLogDeleteRequest</li></ol><p>2）服务端响应消息</p><ol><li>RegisterRMResponse、BranchRegisterResponse、BranchReportResponse、GlobalLockQueryResponse</li><li>RegisterTMResponse、GlobalBeginResponse、GlobalCommitResponse、GlobalRollbackResponse、GlobalStatusResponse、GlobalReportResponse</li><li>HeartbeatMessage(PONG)</li></ol><p>服务端总共接收客户端的消息：</p><p>1）客户端请求消息：</p><ol><li>RegisterRMRequest、BranchRegisterRequest、BranchReportRequest、GlobalLockQueryRequest</li><li>RegisterTMRequest、GlobalBeginRequest、GlobalCommitRequest、GlobalRollbackRequest、GlobalStatusRequest、GlobalReportRequest</li><li>HeartbeatMessage(PING)</li></ol><p>2）客户端响应消息：</p><ol><li>BranchCommitResponse、BranchRollbackResponse</li></ol><p>基于以上的交互逻辑分析，我们可以将处理消息的逻辑抽象成若干个 Processor，一个 Processor 可以处理一个或者多个消息类型的消息，只需在 Seata 启动时注册将消息类型注册到 ProcessorTable
中即可，形成一个映射关系，这样就可以根据消息类型调用对应的 Processor 对消息进行处理，用如下图表示：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/Xnip2020-05-12_22-09-17.png" class="img_ev3q"></p><p>在抽象 Remoting 类中定一个 processMessage 方法，方法逻辑是根据消息类型从 ProcessorTable 中拿到消息类型对应的 Processor。</p><p>这样就成功将处理逻辑从 Netty Handler 中彻底抽离出来了，Handler#channelRead 方法只需要调用 processMessage 方法即可，且还可以灵活根据消息类型动态注册 Processor 到
ProcessorTable 中，处理逻辑的可扩展性得到了极大的提升。</p><p>以下是 Processor 的调用流程：</p><p>1）客户端</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200510234047.png" class="img_ev3q"></p><ol><li>RmBranchCommitProcessor：处理服务端全局提交请求；</li><li>RmBranchRollbackProcessor：处理服务端全局回滚请求；</li><li>RmUndoLogProcessor：处理服务端 undo log 删除请求；</li><li>ClientOnResponseProcessor：客户端处理服务端响应请求，如：BranchRegisterResponse、GlobalBeginResponse、GlobalCommitResponse 等；</li><li>ClientHeartbeatProcessor：处理服务端心跳响应。</li></ol><p>2）服务端</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200510234016.png" class="img_ev3q"></p><ol><li>RegRmProcessor：处理 RM 客户端注册请求；</li><li>RegTmProcessor：处理 TM 客户端注册请求；</li><li>ServerOnRequestProcessor：处理客户端相关请求，如：BranchRegisterRequest、GlobalBeginRequest、GlobalLockQueryRequest 等；</li><li>ServerOnResponseProcessor：处理客户端相关响应，如：BranchCommitResponse、BranchRollbackResponse 等；</li><li>ServerHeartbeatProcessor：处理客户端心跳响应。</li></ol><p>下面我以 TM 发起全局事务提交请求为例子，让大家感受下 Processor 在整个交互中所处的位置：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200514191842.png" class="img_ev3q"></p><h1>重构请求方法</h1><p>在 Seata 的旧版本当中，RPC 的请求方法也是欠缺优雅，主要体现在：</p><ol><li>请求方法过于杂乱无章，没有层次感；</li><li>sendAsyncRequest 方法耦合的代码太多，逻辑过于混乱，客户端与服务端都共用了一套请求逻辑，方法中决定是否批量发送是根据参数 address 是否为 null 决定，决定是否同步请求是根据 timeout 是否大于 0
决定，显得极为不合理，且批量请求只有客户端有用到，服务端并没有批量请求，共用一套请求逻辑还会导致服务端异步请求也会创建 MessageFuture 放入 futures 中；</li><li>请求方法名称风格不统一，比如客户端 sendMsgWithResponse，服务端却叫 sendSyncRequest；</li></ol><p>针对以上旧版本 RPC 请求方法的各种缺点，我作了以下改动：</p><ol><li>将请求方法统一放入 RemotingClient、RemotingServer 接口当中，并作为顶级接口；</li><li>分离客户端与服务端请求逻辑，将批量请求逻辑单独抽到客户端相关请求方法中，使得是否批量发送不再根据参数 address 是否为 null 决定；</li><li>由于 Seata
自身的逻辑特点，客户端服务端请求方法的参数无法统一，可通过抽取通用的同步/异步请求方法，客户端和服务端根据自身请求逻辑特点实现自身的同步/异步请求逻辑，最后再调用通用的同步/异步请求方法，使得同步/异步请求都有明确的方法，不再根据
timeout 是否大于 0 决定；</li><li>统一请求名称风格。</li></ol><p>最终，Seata RPC 的请求方法终于看起来更加优雅且有层次感了。</p><p>同步请求：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200513103838.png" class="img_ev3q"></p><p>异步请求：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200513103904.png" class="img_ev3q"></p><h1>其它</h1><ol><li>类目录调整：RPC 模块目录中还有一个 netty 目录，也可以从目录结构中发现 Seata 的初衷是兼容多个 RPC 框架，目前只实现了 netty，但发现 netty 模块中有些类并不 ”netty“，且 RPC
跟目录的类也并不通用，因此需要将相关类的位置进行调整；</li><li>某些类重新命名，比如 netty 相关类包含 「netty」；</li></ol><p>最终 RPC 模块看起来是这样的：</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20200711213204.png" class="img_ev3q"></p><h1>作者简介</h1><p>张乘辉，目前就职于蚂蚁集团，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Contributor，GitHub
ID：objcoding。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-07-02T00:00:00.000Z" itemprop="datePublished">2020年7月2日</time> · <!-- -->阅读需 19 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">杨晓兵|中原银行</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分布式事务seata源码解读一server端启动流程">【分布式事务Seata源码解读一】Server端启动流程<a href="#分布式事务seata源码解读一server端启动流程" class="hash-link" aria-label="【分布式事务Seata源码解读一】Server端启动流程的直接链接" title="【分布式事务Seata源码解读一】Server端启动流程的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现分布式事务的核心要点">实现分布式事务的核心要点：<a href="#实现分布式事务的核心要点" class="hash-link" aria-label="实现分布式事务的核心要点：的直接链接" title="实现分布式事务的核心要点：的直接链接">​</a></h3><ol><li>事务的持久化，事务所处的各种状态事务参与方的各种状态都需要持久化，当实例宕机时才能基于持久化的数据对事务回滚或提交，实现最终一致性</li><li>定时对超时未完成事务的处理（继续尝试提交或回滚），即通过重试机制实现事务的最终一致性</li><li>分布式事务的跨服务实例传播，当分布式事务跨多个实例时需要实现事务的传播，一般需要适配不同的rpc框架</li><li>事务的隔离级别：大多数分布式事务为了性能，默认的隔离级别是读未提交</li><li>幂等性：对于XA或者seata的AT这样的分布式事务来说，都已经默认实现了幂等性，而TCC、Saga这种接口级别实现的分布式事务都还需要业务开发者自己实现幂等性。</li></ol><p>本片文章主要从seata-server的启动流程的角度介绍一下seata-server的源码，启动流程图如下：</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20200726213919467.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTE0NTg0OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-启动类server">1. 启动类Server<a href="#1-启动类server" class="hash-link" aria-label="1. 启动类Server的直接链接" title="1. 启动类Server的直接链接">​</a></h4><p>seata-server的入口类在Server类中，源码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void main(String[] args) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 从环境变量或运行时参数中获取监听端口，默认端口8091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int port = PortHelper.getPort(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 把监听端口设置到SystemProperty中，Logback的LoggerContextListener实现类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SystemPropertyLoggerContextListener会把Port写入到Logback的Context中，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在logback.xml文件中会使用Port变量来构建日志文件名称。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.setProperty(ConfigurationKeys.SERVER_PORT, Integer.toString(port));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建Logger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Logger logger = LoggerFactory.getLogger(Server.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ContainerHelper.isRunningInContainer()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.info(&quot;The server is running in container.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 解析启动以及配置文件的各种配置参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ParameterParser parameterParser = new ParameterParser(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // metrics相关，这里是使用SPI机制获取Registry实例对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MetricsManager.get().init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 把从配置文件中读取到的storeMode写入SystemProperty中，方便其他类使用。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.setProperty(ConfigurationKeys.STORE_MODE, parameterParser.getStoreMode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建NettyRemotingServer实例，NettyRemotingServer是一个基于Netty实现的Rpc框架，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 此时并没有初始化，NettyRemotingServer负责与客户端SDK中的TM、RM进行网络通信。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     nettyRemotingServer = new NettyRemotingServer(WORKING_THREADS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置监听端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nettyRemotingServer.setListenPort(parameterParser.getPort());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // UUIDGenerator初始化，UUIDGenerator基于雪花算法实现，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 用于生成全局事务、分支事务的id。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 多个Server实例配置不同的ServerNode，保证id的唯一性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UUIDGenerator.init(parameterParser.getServerNode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // SessionHodler负责事务日志（状态）的持久化存储，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当前支持file、db、redis三种存储模式，集群部署模式要使用db或redis模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SessionHolder.init(parameterParser.getStoreMode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建初始化DefaultCoordinator实例，DefaultCoordinator是TC的核心事务逻辑处理类，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 底层包含了AT、TCC、SAGA等不同事务类型的逻辑处理。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DefaultCoordinator coordinator = new DefaultCoordinator(nettyRemotingServer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    coordinator.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nettyRemotingServer.setHandler(coordinator);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // register ShutdownHook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ShutdownHook.getInstance().addDisposable(coordinator);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ShutdownHook.getInstance().addDisposable(nettyRemotingServer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 127.0.0.1 and 0.0.0.0 are not valid here.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (NetUtil.isValidIp(parameterParser.getHost(), false)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        XID.setIpAddress(parameterParser.getHost());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        XID.setIpAddress(NetUtil.getLocalIp());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    XID.setPort(nettyRemotingServer.getListenPort());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 初始化Netty，开始监听端口并阻塞在这里，等待程序关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nettyRemotingServer.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.error(&quot;nettyServer init error:{}&quot;, e.getMessage(), e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.exit(-1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.exit(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-解析配置">2. 解析配置<a href="#2-解析配置" class="hash-link" aria-label="2. 解析配置的直接链接" title="2. 解析配置的直接链接">​</a></h4><p>参数解析的实现代码在ParameterParser类中，init方法源码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void init(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // 判断是否运行在容器中，如果运行在容器中则配置从环境变量中获取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       if (ContainerHelper.isRunningInContainer()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           this.seataEnv = ContainerHelper.getEnv();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           this.host = ContainerHelper.getHost();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           this.port = ContainerHelper.getPort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           this.serverNode = ContainerHelper.getServerNode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           this.storeMode = ContainerHelper.getStoreMode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // 基于JCommander获取启动应用程序时配置的参数，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // JCommander通过注解、反射的方式把参数赋值到当前类的字段上。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           JCommander jCommander = JCommander.newBuilder().addObject(this).build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           jCommander.parse(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           if (help) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               jCommander.setProgramName(PROGRAM_NAME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               jCommander.usage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               System.exit(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // serverNode用于雪花算中的实例的唯一标识，需要保证唯一。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // 如果没有指定基于当前服务器的I随机生成一个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       if (this.serverNode == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           this.serverNode = IdWorker.initWorkerId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       if (StringUtils.isNotBlank(seataEnv)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           System.setProperty(ENV_PROPERTY_KEY, seataEnv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       if (StringUtils.isBlank(storeMode)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // 这里牵扯到一个重要的Configuration类，ParameterParser只负责获取ip、port、storeMode等核心参数，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // 其他的参数都是从Configuration中获取的。这里如果没有启动参数没有指定storeMode，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // 就从Configuration类中获取。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           storeMode = ConfigurationFactory.getInstance().getConfig(ConfigurationKeys.STORE_MODE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               SERVER_DEFAULT_STORE_MODE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   } catch (ParameterException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       printError(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在ParameterParser的init方法中第一次调用了ConfigurationFactory.getInstance()，初始化了一个单例的Configuration对象，Configuration负责初始化所有的其他配置参数信息。从Seata Server端的源码中我们能看到两个配置文件file.conf、registry.conf。那么这两个配置文件的区别是什么，两个文件都是必须的吗？我们继续看代码。</p><p>ConfigurationFactory.getInstance方法其实就是获取一个单例对象，核心在buildConfiguration方法中，不过在buidlConfiguration方法前，ConfigurationFactory类有一段static代码块会先执行。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 获取Configuration的单例对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static Configuration getInstance() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (instance == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (Configuration.class) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (instance == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                instance = buildConfiguration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return instance;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ConfigurationFactory的static代码块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取配置文件的名称，默认为registry.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String seataConfigName = System.getProperty(SYSTEM_PROPERTY_SEATA_CONFIG_NAME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (seataConfigName == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seataConfigName = System.getenv(ENV_SEATA_CONFIG_NAME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (seataConfigName == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seataConfigName = REGISTRY_CONF_PREFIX;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String envValue = System.getProperty(ENV_PROPERTY_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (envValue == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        envValue = System.getenv(ENV_SYSTEM_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 读取registry.conf文件的配置，构建基础的Configuration对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Configuration configuration = (envValue == null) ? new FileConfiguration(seataConfigName + REGISTRY_CONF_SUFFIX,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        false) : new FileConfiguration(seataConfigName + &quot;-&quot; + envValue + REGISTRY_CONF_SUFFIX, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Configuration extConfiguration = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ExtConfigurationProvider当前只有一个SpringBootConfigurationProvider实现类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 用于支持客户端SDK SpringBoot的配置文件方式，对于Server端来说这段逻辑可以忽略。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        extConfiguration = EnhancedServiceLoader.load(ExtConfigurationProvider.class).provide(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isInfoEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;load Configuration:{}&quot;, extConfiguration == null ? configuration.getClass().getSimpleName()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                : extConfiguration.getClass().getSimpleName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (EnhancedServiceNotFoundException ignore) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.error(&quot;failed to load extConfiguration:{}&quot;, e.getMessage(), e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CURRENT_FILE_INSTANCE = extConfiguration == null ? configuration : extConfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ConfigurationFactory中的static代码块是从registry.conf中读取配置信息。registry.conf中主有两个配置信息，<strong>注册中心</strong>和<strong>配置源</strong>，<strong>配置源</strong>用来指定其他更详细的配置项是file.conf或者是apollo等其他配置源。所以registry.conf配置文件时必须的，registry.conf配置文件中指定其他详细配置的配置源，当前配置源支持file、zk、apollo、nacos、etcd3等。所以file.conf不是必须的，只有当设置配置源为file类型时才会读取file.conf文件中的内容。</p><p>接下来ConfigurationFactory中的buildConfiguration就是根据registry.conf中设置的配置源来加载更多的配置项。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static Configuration buildConfiguration() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConfigType configType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String configTypeName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 从registry.conf配置文件中读取config.type字段值，并解析为枚举ConfigType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configTypeName = CURRENT_FILE_INSTANCE.getConfig(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigurationKeys.FILE_ROOT_CONFIG + ConfigurationKeys.FILE_CONFIG_SPLIT_CHAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + ConfigurationKeys.FILE_ROOT_TYPE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(configTypeName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new NotSupportYetException(&quot;config type can not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configType = ConfigType.getType(configTypeName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Configuration extConfiguration = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Configuration configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ConfigType.File == configType) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果配置文件为file类型，则从registry.conf中读取config.file.name配置项，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 即file类型配置文件的路径，示例中默认为file.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pathDataId = String.join(ConfigurationKeys.FILE_CONFIG_SPLIT_CHAR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigurationKeys.FILE_ROOT_CONFIG, FILE_TYPE, NAME_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String name = CURRENT_FILE_INSTANCE.getConfig(pathDataId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 根据file配置文件的路径构建FileConfuguration对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configuration = new FileConfiguration(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // configuration的额外扩展，也是只对客户端SpringBoot的SDK才生效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            extConfiguration = EnhancedServiceLoader.load(ExtConfigurationProvider.class).provide(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (LOGGER.isInfoEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.info(&quot;load Configuration:{}&quot;, extConfiguration == null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ? configuration.getClass().getSimpleName() : extConfiguration.getClass().getSimpleName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (EnhancedServiceNotFoundException ignore) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(&quot;failed to load extConfiguration:{}&quot;, e.getMessage(), e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果配置文件的类型不是file，如：nacos、zk等，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 则通过SPI的方式生成对应的ConfigurationProvider对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configuration = EnhancedServiceLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .load(ConfigurationProvider.class, Objects.requireNonNull(configType).name()).provide();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ConfigurationCache是对Configuration做了一次层代理内存缓存，提升获取配置的性能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Configuration configurationCache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (null != extConfiguration) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            configurationCache = ConfigurationCache.getInstance().proxy(extConfiguration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            configurationCache = ConfigurationCache.getInstance().proxy(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (null != configurationCache) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            extConfiguration = configurationCache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (EnhancedServiceNotFoundException ignore) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.error(&quot;failed to load configurationCacheProvider:{}&quot;, e.getMessage(), e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null == extConfiguration ? configuration : extConfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-初始化uuidgenerator">3. 初始化UUIDGenerator<a href="#3-初始化uuidgenerator" class="hash-link" aria-label="3. 初始化UUIDGenerator的直接链接" title="3. 初始化UUIDGenerator的直接链接">​</a></h4><p>UUIDGenertor初始化接收一个serverNode参数，UUIDGenertor当前是使用了雪花算法来生成唯一Id，该serverNode用来保证多个seata-server实例生成的唯一id不重复。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class UUIDGenerator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Generate uuid long.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the long</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static long generateUUID() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return IdWorker.getInstance().nextId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Init.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param serverNode the server node id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void init(Long serverNode) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IdWorker.init(serverNode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>UUIDGenerator是对IdWorker做了封装，唯一id的核心实现逻辑在IdWoker类中，IdWorker是一个雪花算法实现的。此处的IdWorker又是一个单例</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class IdWorker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Constructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param workerId就是上面提到的ServerNode, 取值范围在0·1023，也就是在64位的UUID中占10位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IdWorker(long workerId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (workerId &gt; maxWorkerId || workerId &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String.format(&quot;worker Id can&#x27;t be greater than %d or less than 0&quot;, maxWorkerId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.workerId = workerId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Get the next ID (the method is thread-safe)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return SnowflakeId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public long nextId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long timestamp = timeGen();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (timestamp &lt; lastTimestamp) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException(String.format(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;clock moved backwards.  Refusing to generate id for %d milliseconds&quot;, lastTimestamp - timestamp));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (this) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (lastTimestamp == timestamp) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sequence = (sequence + 1) &amp; sequenceMask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (sequence == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    timestamp = tilNextMillis(lastTimestamp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sequence = 0L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lastTimestamp = timestamp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //雪花算法64位唯一id组成：第一位0 + 41位时间戳 + 10位workerId + 12位自增序列化（同一时间戳内自增）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ((timestamp - twepoch) &lt;&lt; timestampLeftShift) | (workerId &lt;&lt; workerIdShift) | sequence;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-sessionholder初始化">4. SessionHolder初始化<a href="#4-sessionholder初始化" class="hash-link" aria-label="4. SessionHolder初始化的直接链接" title="4. SessionHolder初始化的直接链接">​</a></h4><p>SessionHolder负责Session的持久化，一个Session对象对应一个事务，事务分为两种：全局事务（GlobalSession）和分支事务（BranchSession）。
SessionHolder支持file和db两种持久化方式，其中db支持集群模式，推荐使用db。SessionHolder中最主要的四个字段如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ROOT_SESSION_MANAGER用于获取所有的Setssion，以及Session的创建、更新、删除等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static SessionManager ROOT_SESSION_MANAGER;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 用于获取、更新所有的异步commit的Session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static SessionManager ASYNC_COMMITTING_SESSION_MANAGER;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 用于获取、更新所有需要重试commit的Session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static SessionManager RETRY_COMMITTING_SESSION_MANAGER;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 用于获取、更新所有需要重试rollback的Session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static SessionManager RETRY_ROLLBACKING_SESSION_MANAGER;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>SessionHolder的init方法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void init(String mode) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.isBlank(mode)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mode = CONFIG.getConfig(ConfigurationKeys.STORE_MODE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StoreMode storeMode = StoreMode.get(mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StoreMode.DB.equals(storeMode)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这里又用到了SPI的方式加载SessionManager，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 其实下面获取的四个SessionManager实例都是同一个类DataBaseSessionManager的不同实例，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 只是给DataBaseSessionManager的构造函数传参不同。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ROOT_SESSION_MANAGER = EnhancedServiceLoader.load(SessionManager.class, StoreMode.DB.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ASYNC_COMMITTING_SESSION_MANAGER = EnhancedServiceLoader.load(SessionManager.class, StoreMode.DB.getName(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new Object[] {ASYNC_COMMITTING_SESSION_MANAGER_NAME});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RETRY_COMMITTING_SESSION_MANAGER = EnhancedServiceLoader.load(SessionManager.class, StoreMode.DB.getName(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new Object[] {RETRY_COMMITTING_SESSION_MANAGER_NAME});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RETRY_ROLLBACKING_SESSION_MANAGER = EnhancedServiceLoader.load(SessionManager.class, StoreMode.DB.getName(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new Object[] {RETRY_ROLLBACKING_SESSION_MANAGER_NAME});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (StoreMode.FILE.equals(storeMode)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //file模式可以先不关心</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(&quot;unknown store mode:&quot; + mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // reload方法对于db模式可以忽略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reload();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面看到SessionHolder中的四个SessionManager本质都是类DataBaseSessionManager的实例，只是给构造函数传参不同，看下DataBaseSessionManager的定义：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public DataBaseSessionManager(String name) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.taskName = name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 根据实例的taskName来决定allSessions返回的事务列表，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 如taskName等于ASYNC_COMMITTING_SESSION_MANAGER_NAME的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 就返回所有状态为AsyncCommitting的事务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Collection&lt;GlobalSession&gt; allSessions() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // get by taskName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (SessionHolder.ASYNC_COMMITTING_SESSION_MANAGER_NAME.equalsIgnoreCase(taskName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return findGlobalSessions(new SessionCondition(GlobalStatus.AsyncCommitting));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (SessionHolder.RETRY_COMMITTING_SESSION_MANAGER_NAME.equalsIgnoreCase(taskName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return findGlobalSessions(new SessionCondition(new GlobalStatus[] {GlobalStatus.CommitRetrying}));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (SessionHolder.RETRY_ROLLBACKING_SESSION_MANAGER_NAME.equalsIgnoreCase(taskName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return findGlobalSessions(new SessionCondition(new GlobalStatus[] {GlobalStatus.RollbackRetrying,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    GlobalStatus.Rollbacking, GlobalStatus.TimeoutRollbacking, GlobalStatus.TimeoutRollbackRetrying}));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // taskName为null，则对应ROOT_SESSION_MANAGER，即获取所有状态的事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return findGlobalSessions(new SessionCondition(new GlobalStatus[] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalStatus.UnKnown, GlobalStatus.Begin,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalStatus.Committing, GlobalStatus.CommitRetrying, GlobalStatus.Rollbacking,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalStatus.RollbackRetrying,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalStatus.TimeoutRollbacking, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalStatus.TimeoutRollbackRetrying,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalStatus.AsyncCommitting}));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-初始化defaultcoordinator">5. 初始化DefaultCoordinator<a href="#5-初始化defaultcoordinator" class="hash-link" aria-label="5. 初始化DefaultCoordinator的直接链接" title="5. 初始化DefaultCoordinator的直接链接">​</a></h4><p>DefaultCoordinator是事务协调器的核心，如：开启、提交、回滚全局事务，注册、提交、回滚分支事务都是由DefaultCoordinator负责协调处理的。DefaultCoordinato通过RpcServer与远程的TM、RM通信来实现分支事务的提交、回滚等。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public DefaultCoordinator(ServerMessageSender messageSender) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 接口messageSender的实现类就是上文提到的RpcServer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.messageSender = messageSender;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // DefaultCore封装了AT、TCC、Saga等分布式事务模式的具体实现类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.core = new DefaultCore(messageSender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// init方法初始化了5个定时器，主要用于分布式事务的重试机制，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 因为分布式环境的不稳定性会造成事务处于中间状态，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 所以要通过不断的重试机制来实现事务的最终一致性。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 下面的定时器除了undoLogDelete之外，其他的定时任务默认都是1秒执行一次。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理处于回滚状态可重试的事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retryRollbacking.scheduleAtFixedRate(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleRetryRollbacking();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;Exception retry rollbacking ... &quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, 0, ROLLBACKING_RETRY_PERIOD, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理二阶段可以重试提交的状态可重试的事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retryCommitting.scheduleAtFixedRate(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleRetryCommitting();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;Exception retry committing ... &quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, 0, COMMITTING_RETRY_PERIOD, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理异步提交的事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asyncCommitting.scheduleAtFixedRate(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleAsyncCommitting();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;Exception async committing ... &quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, 0, ASYNC_COMMITTING_RETRY_PERIOD, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 检查事务的第一阶段已经超时的事务，设置事务状态为TimeoutRollbacking，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 该事务会由其他定时任务执行回滚操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeoutCheck.scheduleAtFixedRate(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            timeoutCheck();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;Exception timeout checking ... &quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, 0, TIMEOUT_RETRY_PERIOD, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 根据unlog的保存天数调用RM删除unlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    undoLogDelete.scheduleAtFixedRate(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            undoLogDelete();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;Exception undoLog deleting ... &quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, UNDO_LOG_DELAY_DELETE_PERIOD, UNDO_LOG_DELETE_PERIOD, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-初始化nettyremotingserver">6. 初始化NettyRemotingServer<a href="#6-初始化nettyremotingserver" class="hash-link" aria-label="6. 初始化NettyRemotingServer的直接链接" title="6. 初始化NettyRemotingServer的直接链接">​</a></h4><p>NettyRemotingServer是基于Netty实现的简化版的Rpc服务端，NettyRemotingServer初始化时主要做了两件事：</p><ol><li><strong>registerProcessor</strong>：注册与Client通信的Processor。</li><li><strong>super.init()</strong>：super.init()方法中负责初始化Netty，并把当前实例的IP端口注册到注册中心中</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // registry processor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registerProcessor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (initialized.compareAndSet(false, true)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void registerProcessor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. 注册核心的ServerOnRequestProcessor，即与事务处理相关的Processor，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如：全局事务开始、提交，分支事务注册、反馈当前状态等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ServerOnRequestProcessor的构造函数中传入getHandler()返回的示例，这个handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 就是前面提到的DefaultCoordinator，DefaultCoordinator是分布式事务的核心处理类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerOnRequestProcessor onRequestProcessor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new ServerOnRequestProcessor(this, getHandler());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_BRANCH_REGISTER, onRequestProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_BRANCH_STATUS_REPORT, onRequestProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_GLOBAL_BEGIN, onRequestProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_GLOBAL_COMMIT, onRequestProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_GLOBAL_LOCK_QUERY, onRequestProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_GLOBAL_REPORT, onRequestProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_GLOBAL_ROLLBACK, onRequestProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_GLOBAL_STATUS, onRequestProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_SEATA_MERGE, onRequestProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2.注册ResponseProcessor，ResponseProcessor用于处理当Server端主动发起请求时，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Client端回复的消息，即Response。如：Server向Client端发送分支事务提交或者回滚的请求时，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Client返回提交/回滚的结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerOnResponseProcessor onResponseProcessor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new ServerOnResponseProcessor(getHandler(), getFutures());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_BRANCH_COMMIT_RESULT, onResponseProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_BRANCH_ROLLBACK_RESULT, onResponseProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3. Client端发起RM注册请求时对应的Processor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RegRmProcessor regRmProcessor = new RegRmProcessor(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_REG_RM, regRmProcessor, messageExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 4. Client端发起TM注册请求时对应的Processor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RegTmProcessor regTmProcessor = new RegTmProcessor(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_REG_CLT, regTmProcessor, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 5. Client端发送心跳请求时对应的Processor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerHeartbeatProcessor heartbeatMessageProcessor = new ServerHeartbeatProcessor(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerProcessor(MessageType.TYPE_HEARTBEAT_MSG, heartbeatMessageProcessor, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在NettyRemotingServer中有调用基类AbstractNettyRemotingServer的init方法，代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // super.init()方法中启动了一个定时清理超时Rpc请求的定时任务，3S执行一次。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 配置Netty Server端，开始监听端口。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverBootstrap.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// serverBootstrap.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void start() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Netty server端的常规配置，其中添加了两个ChannelHandler：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ProtocolV1Decoder、ProtocolV1Encoder，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 分别对应Seata自定义RPC协议的解码器和编码器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.serverBootstrap.group(this.eventLoopGroupBoss, this.eventLoopGroupWorker)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .channel(NettyServerConfig.SERVER_CHANNEL_CLAZZ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .option(ChannelOption.SO_BACKLOG, nettyServerConfig.getSoBackLogSize())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .option(ChannelOption.SO_REUSEADDR, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .childOption(ChannelOption.SO_KEEPALIVE, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .childOption(ChannelOption.TCP_NODELAY, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .childOption(ChannelOption.SO_SNDBUF, nettyServerConfig.getServerSocketSendBufSize())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .childOption(ChannelOption.SO_RCVBUF, nettyServerConfig.getServerSocketResvBufSize())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .childOption(ChannelOption.WRITE_BUFFER_WATER_MARK,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new WriteBufferWaterMark(nettyServerConfig.getWriteBufferLowWaterMark(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nettyServerConfig.getWriteBufferHighWaterMark()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .localAddress(new InetSocketAddress(listenPort))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void initChannel(SocketChannel ch) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ch.pipeline().addLast(new IdleStateHandler(nettyServerConfig.getChannelMaxReadIdleSeconds(), 0, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .addLast(new ProtocolV1Decoder())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .addLast(new ProtocolV1Encoder());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (channelHandlers != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    addChannelPipelineLast(ch, channelHandlers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 开始监听配置的端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ChannelFuture future = this.serverBootstrap.bind(listenPort).sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;Server started, listen port: {}&quot;, listenPort);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Netty启动成功之后把当前实例注册到registry.conf配置文件配置的注册中心上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegistryFactory.getInstance().register(new InetSocketAddress(XID.getIpAddress(), XID.getPort()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        initialized.set(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future.channel().closeFuture().sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception exx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new RuntimeException(exx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-04-28T00:00:00.000Z" itemprop="datePublished">2020年4月28日</time> · <!-- -->阅读需 21 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">煊檍</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>作者简介：煊檍，GitHub ID：sharajava，阿里巴巴中件间 GTS 研发团队负责人，SEATA 开源项目发起人，曾在 Oracle 北京研发中心多年，从事 WebLogic 核心研发工作。长期专注于中间件，尤其是分布式事务领域的技术实践。</p><p>Seata 1.2.0 版本重磅发布新的事务模式：XA 模式，实现对 XA 协议的支持。</p><p>这里，我们从三个方面来深入解读这个新的特性：</p><ul><li>是什么（What）：XA 模式是什么？</li><li>为什么（Why）：为什么支持 XA？</li><li>怎么做（How）：XA 模式是如何实现的，以及怎样使用？</li></ul><h1>1. XA 模式是什么？</h1><p>这里有两个基本的前置概念：</p><ol><li>什么是 XA？</li><li>什么是 Seata 定义的所谓 事务模式？</li></ol><p>基于这两点，再来理解 XA 模式就很自然了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-什么是-xa">1.1 什么是 XA？<a href="#11-什么是-xa" class="hash-link" aria-label="1.1 什么是 XA？的直接链接" title="1.1 什么是 XA？的直接链接">​</a></h2><p>XA 规范 是 X/Open 组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准。</p><p>XA 规范 描述了全局的事务管理器与局部的资源管理器之间的接口。 XA规范 的目的是允许的多个资源（如数据库，应用服务器，消息队列等）在同一事务中访问，这样可以使 ACID 属性跨越应用程序而保持有效。</p><p>XA 规范 使用两阶段提交（2PC，Two-Phase Commit）来保证所有资源同时提交或回滚任何特定的事务。</p><p>XA 规范 在上世纪 90 年代初就被提出。目前，几乎所有主流的数据库都对 XA 规范 提供了支持。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-什么是-seata-的事务模式">1.2 什么是 Seata 的事务模式？<a href="#12-什么是-seata-的事务模式" class="hash-link" aria-label="1.2 什么是 Seata 的事务模式？的直接链接" title="1.2 什么是 Seata 的事务模式？的直接链接">​</a></h2><p>Seata 定义了全局事务的框架。</p><p>全局事务 定义为若干 分支事务 的整体协调：</p><ol><li>TM 向 TC 请求发起（Begin）、提交（Commit）、回滚（Rollback）全局事务。</li><li>TM 把代表全局事务的 XID 绑定到分支事务上。</li><li>RM 向 TC 注册，把分支事务关联到 XID 代表的全局事务中。</li><li>RM 把分支事务的执行结果上报给 TC。（可选）</li><li>TC 发送分支提交（Branch Commit）或分支回滚（Branch Rollback）命令给 RM。</li></ol><img loading="lazy" src="https://img.alicdn.com/tfs/TB19qmhOrY1gK0jSZTEXXXDQVXa-1330-924.png" alt="seata-mod" style="zoom:50%" class="img_ev3q"><p>Seata 的 全局事务 处理过程，分为两个阶段：</p><ul><li>执行阶段 ：执行 分支事务，并 保证 执行结果满足是 <em>可回滚的（Rollbackable）</em> 和 <em>持久化的（Durable）</em>。</li><li>完成阶段： 根据 执行阶段 结果形成的决议，应用通过 TM 发出的全局提交或回滚的请求给 TC，TC 命令 RM 驱动 分支事务 进行 Commit 或 Rollback。</li></ul><p>Seata 的所谓 事务模式 是指：运行在 Seata 全局事务框架下的 分支事务 的行为模式。准确地讲，应该叫作 分支事务模式。</p><p>不同的 事务模式 区别在于 分支事务 使用不同的方式达到全局事务两个阶段的目标。即，回答以下两个问题：</p><ul><li>执行阶段 ：如何执行并 保证 执行结果满足是 <em>可回滚的（Rollbackable）</em> 和 <em>持久化的（Durable）</em>。</li><li>完成阶段： 收到 TC 的命令后，如何做到分支的提交或回滚？</li></ul><p>以我们 Seata 的 AT 模式和 TCC 模式为例来理解：</p><p>AT 模式</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1NTuzOBr0gK0jSZFnXXbRRXXa-1330-924.png" alt="at-mod" style="zoom:50%" class="img_ev3q"><ul><li><p>执行阶段：</p></li><li><ul><li>可回滚：根据 SQL 解析结果，记录回滚日志</li><li>持久化：回滚日志和业务 SQL 在同一个本地事务中提交到数据库</li></ul></li><li><p>完成阶段：</p></li><li><ul><li>分支提交：异步删除回滚日志记录</li><li>分支回滚：依据回滚日志进行反向补偿更新</li></ul></li></ul><p>TCC 模式</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1m59pOEY1gK0jSZFCXXcwqXXa-1330-924.png" alt="tcc-mod" style="zoom:50%" class="img_ev3q"><ul><li><p>执行阶段：</p></li><li><ul><li>调用业务定义的 Try 方法（完全由业务层面保证 <em>可回滚</em> 和 <em>持久化</em>）</li></ul></li><li><p>完成阶段：</p></li><li><ul><li>分支提交：调用各事务分支定义的 Confirm 方法</li><li>分支回滚：调用各事务分支定义的 Cancel 方法</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="13-什么是-seata-的-xa-模式">1.3 什么是 Seata 的 XA 模式？<a href="#13-什么是-seata-的-xa-模式" class="hash-link" aria-label="1.3 什么是 Seata 的 XA 模式？的直接链接" title="1.3 什么是 Seata 的 XA 模式？的直接链接">​</a></h2><p>XA 模式：</p><p>在 Seata 定义的分布式事务框架内，利用事务资源（数据库、消息服务等）对 XA 协议的支持，以 XA 协议的机制来管理分支事务的一种 事务模式。</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1hSpccIVl614jSZKPXXaGjpXa-1330-924.png" alt="xa-mod" style="zoom:50%" class="img_ev3q"><ul><li><p>执行阶段：</p></li><li><ul><li>可回滚：业务 SQL 操作放在 XA 分支中进行，由资源对 XA 协议的支持来保证 <em>可回滚</em></li><li>持久化：XA 分支完成后，执行 XA prepare，同样，由资源对 XA 协议的支持来保证 <em>持久化</em>（即，之后任何意外都不会造成无法回滚的情况）</li></ul></li><li><p>完成阶段：</p></li><li><ul><li>分支提交：执行 XA 分支的 commit</li><li>分支回滚：执行 XA 分支的 rollback</li></ul></li></ul><h1>2. 为什么支持 XA？</h1><p>为什么要在 Seata 中增加 XA 模式呢？支持 XA 的意义在哪里呢？</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-补偿型事务模式的问题">2.1 补偿型事务模式的问题<a href="#21-补偿型事务模式的问题" class="hash-link" aria-label="2.1 补偿型事务模式的问题的直接链接" title="2.1 补偿型事务模式的问题的直接链接">​</a></h2><p>本质上，Seata 已经支持的 3 大事务模式：AT、TCC、Saga 都是 补偿型 的。</p><p>补偿型 事务处理机制构建在 事务资源 之上（要么在中间件层面，要么在应用层面），事务资源 本身对分布式事务是无感知的。</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1z.qyOET1gK0jSZFrXXcNCXXa-602-460.png" alt="img" style="zoom:50%" class="img_ev3q"><p>事务资源 对分布式事务的无感知存在一个根本性的问题：无法做到真正的 全局一致性 。</p><p>比如，一条库存记录，处在 补偿型 事务处理过程中，由 100 扣减为 50。此时，仓库管理员连接数据库，查询统计库存，就看到当前的 50。之后，事务因为异外回滚，库存会被补偿回滚为 100。显然，仓库管理员查询统计到的 50 就是 脏 数据。</p><p>可以看到，补偿型 分布式事务机制因为不要求 事务资源 本身（如数据库）的机制参与，所以无法保证从事务框架之外的全局视角的数据一致性。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-xa-的价值">2.2 XA 的价值<a href="#22-xa-的价值" class="hash-link" aria-label="2.2 XA 的价值的直接链接" title="2.2 XA 的价值的直接链接">​</a></h2><p>与 补偿型 不同，XA 协议 要求 事务资源 本身提供对规范和协议的支持。</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1vs9kOvb2gK0jSZK9XXaEgFXa-602-486.png" alt="nct" style="zoom:50%" class="img_ev3q"><p>因为 事务资源 感知并参与分布式事务处理过程，所以 事务资源（如数据库）可以保障从任意视角对数据的访问有效隔离，满足全局数据一致性。</p><p>比如，上一节提到的库存更新场景，XA 事务处理过程中，中间态数据库存 50 由数据库本身保证，是不会仓库管理员的查询统计 <em>看</em> 到的。（当然隔离级别需要 读已提交 以上）</p><p>除了 全局一致性 这个根本性的价值外，支持 XA 还有如下几个方面的好处：</p><ol><li>业务无侵入：和 AT 一样，XA 模式将是业务无侵入的，不给应用设计和开发带来额外负担。</li><li>数据库的支持广泛：XA 协议被主流关系型数据库广泛支持，不需要额外的适配即可使用。</li><li>多语言支持容易：因为不涉及 SQL 解析，XA 模式对 Seata 的 RM 的要求比较少，为不同语言开发 SDK 较之 AT 模式将更 <em>薄</em>，更容易。</li><li>传统基于 XA 应用的迁移：传统的，基于 XA 协议的应用，迁移到 Seata 平台，使用 XA 模式将更平滑。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="23-xa-广泛被质疑的问题">2.3 XA 广泛被质疑的问题<a href="#23-xa-广泛被质疑的问题" class="hash-link" aria-label="2.3 XA 广泛被质疑的问题的直接链接" title="2.3 XA 广泛被质疑的问题的直接链接">​</a></h2><p>不存在某一种分布式事务机制可以完美适应所有场景，满足所有需求。</p><p>XA 规范早在上世纪 90 年代初就被提出，用以解决分布式事务处理这个领域的问题。</p><p>现在，无论 AT 模式、TCC 模式还是 Saga 模式，这些模式的提出，本质上都源自 XA 规范对某些场景需求的无法满足。</p><p>XA 规范定义的分布式事务处理机制存在一些被广泛质疑的问题，针对这些问题，我们是如何思考的呢？</p><ol><li><strong>数据锁定</strong>：数据在整个事务处理过程结束前，都被锁定，读写都按隔离级别的定义约束起来。</li></ol><blockquote><p>思考：</p><p>数据锁定是获得更高隔离性和全局一致性所要付出的代价。</p><p>补偿型 的事务处理机制，在 执行阶段 即完成分支（本地）事务的提交，（资源层面）不锁定数据。而这是以牺牲 隔离性 为代价的。</p><p>另外，AT 模式使用 <em>全局锁</em> 保障基本的 <em>写隔离</em>，实际上也是锁定数据的，只不过锁在 TC 侧集中管理，解锁效率高且没有阻塞的问题。</p></blockquote><ol start="2"><li><strong>协议阻塞</strong>：XA prepare 后，分支事务进入阻塞阶段，收到 XA commit 或 XA rollback 前必须阻塞等待。</li></ol><blockquote><p>思考：</p><p>协议的阻塞机制本身并不是问题，关键问题在于 协议阻塞 遇上 数据锁定。</p><p>如果一个参与全局事务的资源 “失联” 了（收不到分支事务结束的命令），那么它锁定的数据，将一直被锁定。进而，甚至可能因此产生死锁。</p><p>这是 XA 协议的核心痛点，也是 Seata 引入 XA 模式要重点解决的问题。</p><p>基本思路是两个方面：避免 “失联” 和 增加 “自解锁” 机制。（这里涉及非常多技术细节，暂时不展开，在后续 XA 模式演进过程中，会专门拿出来讨论）</p></blockquote><ol start="3"><li><strong>性能差</strong>：性能的损耗主要来自两个方面：一方面，事务协调过程，增加单个事务的 RT；另一方面，并发事务数据的锁冲突，降低吞吐。</li></ol><blockquote><p>思考：</p><p>和不使用分布式事务支持的运行场景比较，性能肯定是下降的，这点毫无疑问。</p><p>本质上，事务（无论是本地事务还是分布式事务）机制就是拿部分 性能的牺牲 ，换来 编程模型的简单 。</p><p>与同为 业务无侵入 的 AT 模式比较：</p><p>首先，因为同样运行在 Seata 定义的分布式事务框架下，XA 模式并没有产生更多事务协调的通信开销。</p><p>其次，并发事务间，如果数据存在热点，产生锁冲突，这种情况，在 AT 模式（默认使用全局锁）下同样存在的。</p><p>所以，在影响性能的两个主要方面，XA 模式并不比 AT 模式有非常明显的劣势。</p><p>AT 模式性能优势主要在于：集中管理全局数据锁，锁的释放不需要 RM 参与，释放锁非常快；另外，全局提交的事务，完成阶段 异步化。</p></blockquote><h1>3. XA 模式如何实现以及怎样用？</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-xa-模式的设计">3.1 XA 模式的设计<a href="#31-xa-模式的设计" class="hash-link" aria-label="3.1 XA 模式的设计的直接链接" title="3.1 XA 模式的设计的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="311-设计目标">3.1.1 设计目标<a href="#311-设计目标" class="hash-link" aria-label="3.1.1 设计目标的直接链接" title="3.1.1 设计目标的直接链接">​</a></h3><p>XA 模式的基本设计目标，两个主要方面：</p><ol><li>从 场景 上，满足 全局一致性 的需求。</li><li>从 应用上，保持与 AT 模式一致的无侵入。</li><li>从 机制 上，适应分布式微服务架构的特点。</li></ol><p>整体思路：</p><ol><li>与 AT 模式相同的：以应用程序中 本地事务 的粒度，构建到 XA 模式的 分支事务。</li><li>通过数据源代理，在应用程序本地事务范围外，在框架层面包装 XA 协议的交互机制，把 XA 编程模型 透明化。</li><li>把 XA 的 2PC 拆开，在分支事务 执行阶段 的末尾就进行 XA prepare，把 XA 协议完美融合到 Seata 的事务框架，减少一轮 RPC 交互。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="312-核心设计">3.1.2 核心设计<a href="#312-核心设计" class="hash-link" aria-label="3.1.2 核心设计的直接链接" title="3.1.2 核心设计的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-整体运行机制">1. 整体运行机制<a href="#1-整体运行机制" class="hash-link" aria-label="1. 整体运行机制的直接链接" title="1. 整体运行机制的直接链接">​</a></h4><p>XA 模式 运行在 Seata 定义的事务框架内：</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1uM2OaSslXu8jSZFuXXXg7FXa-1330-958.png" alt="xa-fw" style="zoom:50%" class="img_ev3q"><ul><li><p>执行阶段（E xecute）：</p></li><li><ul><li>XA start/XA end/XA prepare + SQL + 注册分支</li></ul></li><li><p>完成阶段（F inish）：</p></li><li><ul><li>XA commit/XA rollback</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-数据源代理">2. 数据源代理<a href="#2-数据源代理" class="hash-link" aria-label="2. 数据源代理的直接链接" title="2. 数据源代理的直接链接">​</a></h4><p>XA 模式需要 XAConnection。</p><p>获取 XAConnection 两种方式：</p><ul><li>方式一：要求开发者配置 XADataSource</li><li>方式二：根据开发者的普通 DataSource 来创建</li></ul><p>第一种方式，给开发者增加了认知负担，需要为 XA 模式专门去学习和使用 XA 数据源，与 透明化 XA 编程模型的设计目标相违背。</p><p>第二种方式，对开发者比较友好，和 AT 模式使用一样，开发者完全不必关心 XA 层面的任何问题，保持本地编程模型即可。</p><p>我们优先设计实现第二种方式：数据源代理根据普通数据源中获取的普通 JDBC 连接创建出相应的 XAConnection。</p><p>类比 AT 模式的数据源代理机制，如下：</p><img loading="lazy" src="/img/xa/pics/ds1.png" alt="img" style="zoom:50%" class="img_ev3q"><p>但是，第二种方法有局限：无法保证兼容的正确性。</p><p>实际上，这种方法是在做数据库驱动程序要做的事情。不同的厂商、不同版本的数据库驱动实现机制是厂商私有的，我们只能保证在充分测试过的驱动程序上是正确的，开发者使用的驱动程序版本差异很可能造成机制的失效。</p><p>这点在 Oracle 上体现非常明显。参见 Druid issue：<a href="https://github.com/alibaba/druid/issues/3707" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/druid/issues/3707</a></p><p>综合考虑，XA 模式的数据源代理设计需要同时支持第一种方式：基于 XA 数据源进行代理。</p><p>类比 AT 模式的数据源代理机制，如下：</p><img loading="lazy" src="/img/xa/pics/ds2.png" alt="img" style="zoom:50%" class="img_ev3q"><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-分支注册">3. 分支注册<a href="#3-分支注册" class="hash-link" aria-label="3. 分支注册的直接链接" title="3. 分支注册的直接链接">​</a></h4><p>XA start 需要 Xid 参数。</p><p>这个 Xid 需要和 Seata 全局事务的 XID 和 BranchId 关联起来，以便由 TC 驱动 XA 分支的提交或回滚。</p><p>目前 Seata 的 BranchId 是在分支注册过程，由 TC 统一生成的，所以 XA 模式分支注册的时机需要在 XA start 之前。</p><p>将来一个可能的优化方向：</p><p>把分支注册尽量延后。类似 AT 模式在本地事务提交之前才注册分支，避免分支执行失败情况下，没有意义的分支注册。</p><p>这个优化方向需要 BranchId 生成机制的变化来配合。BranchId 不通过分支注册过程生成，而是生成后再带着 BranchId 去注册分支。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-小结">4. 小结<a href="#4-小结" class="hash-link" aria-label="4. 小结的直接链接" title="4. 小结的直接链接">​</a></h4><p>这里只通过几个重要的核心设计，说明 XA 模式的基本工作机制。</p><p>此外，还有包括 <em>连接保持</em>、<em>异常处理</em> 等重要方面，有兴趣可以从项目代码中进一步了解。</p><p>以后会陆续写出来和大家交流。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="313-演进规划">3.1.3 演进规划<a href="#313-演进规划" class="hash-link" aria-label="3.1.3 演进规划的直接链接" title="3.1.3 演进规划的直接链接">​</a></h3><p>XA 模式总体的演进规划如下：</p><ol><li>第 1 步（已经完成）：首个版本（1.2.0），把 XA 模式原型机制跑通。确保只增加，不修改，不给其他模式引入的新问题。</li><li>第 2 步（计划 5 月完成）：与 AT 模式必要的融合、重构。</li><li>第 3 步（计划 7 月完成）：完善异常处理机制，进行上生产所必需的打磨。</li><li>第 4 步（计划 8 月完成）：性能优化。</li><li>第 5 步（计划 2020 年内完成）：结合 Seata 项目正在进行的面向云原生的 Transaction Mesh 设计，打造云原生能力。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-xa-模式的使用">3.2 XA 模式的使用<a href="#32-xa-模式的使用" class="hash-link" aria-label="3.2 XA 模式的使用的直接链接" title="3.2 XA 模式的使用的直接链接">​</a></h2><p>从编程模型上，XA 模式与 AT 模式保持完全一致。</p><p>可以参考 Seata 官网的样例：seata-xa</p><p>样例场景是 Seata 经典的，涉及库存、订单、账户 3 个微服务的商品订购业务。</p><p>在样例中，上层编程模型与 AT 模式完全相同。只需要修改数据源代理，即可实现 XA 模式与 AT 模式之间的切换。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(&quot;dataSource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSource dataSource(DruidDataSource druidDataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // DataSourceProxy for AT mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // return new DataSourceProxy(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // DataSourceProxyXA for XA mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DataSourceProxyXA(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>4. 总结</h1><p>在当前的技术发展阶段，不存一个分布式事务处理机制可以完美满足所有场景的需求。</p><p>一致性、可靠性、易用性、性能等诸多方面的系统设计约束，需要用不同的事务处理机制去满足。</p><p>Seata 项目最核心的价值在于：构建一个全面解决分布式事务问题的 标准化 平台。</p><p>基于 Seata，上层应用架构可以根据实际场景的需求，灵活选择合适的分布式事务解决方案。</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1lTSoOqL7gK0jSZFBXXXZZpXa-1028-528.png" alt="img" style="zoom:50%" class="img_ev3q"><p>XA 模式的加入，补齐了 Seata 在 全局一致性 场景下的缺口，形成 AT、TCC、Saga、XA 四大 事务模式 的版图，基本可以满足所有场景的分布式事务处理诉求。</p><p>当然 XA 模式和 Seata 项目本身都还不尽完美，有很多需要改进和完善的地方。非常欢迎大家参与到项目的建设中，共同打造一个标准化的分布式事务平台。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-quick-start">Seata 极简入门</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-04-19T00:00:00.000Z" itemprop="datePublished">2020年4月19日</time> · <!-- -->阅读需 14 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">芋道源码</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul><li><a href="#">1. 概述</a></li><li><a href="#">2. 部署单机 TC Server</a></li><li><a href="#">3. 部署集群 TC Server</a></li><li><a href="#">4. 接入 Java 应用</a></li></ul><h1>1. 概述</h1><p><a href="https://github.com/apache/incubator-seata" target="_blank" rel="noopener noreferrer">Seata</a> 是<strong>阿里</strong>开源的一款开源的<strong>分布式事务</strong>解决方案，致力于提供高性能和简单易用的分布式事务服务。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-四种事务模式">1.1 四种事务模式<a href="#11-四种事务模式" class="hash-link" aria-label="1.1 四种事务模式的直接链接" title="1.1 四种事务模式的直接链接">​</a></h2><p>Seata 目标打造<strong>一站式</strong>的分布事务的解决方案，最终会提供四种事务模式：</p><ul><li>AT 模式：参见<a href="https://seata.io/zh-cn/docs/dev/mode/at-mode.html" target="_blank" rel="noopener noreferrer">《Seata AT 模式》</a>文档</li><li>TCC 模式：参见<a href="https://seata.io/zh-cn/docs/dev/mode/tcc-mode.html" target="_blank" rel="noopener noreferrer">《Seata TCC 模式》</a>文档</li><li>Saga 模式：参见<a href="https://seata.io/zh-cn/docs/dev/mode/saga-mode.html" target="_blank" rel="noopener noreferrer">《SEATA Saga 模式》</a>文档</li><li>XA 模式：正在开发中...</li></ul><p>目前使用的<strong>流行度</strong>情况是：AT &gt; TCC &gt; Saga。因此，我们在学习 Seata 的时候，可以花更多精力在 <strong>AT 模式</strong>上，最好搞懂背后的实现原理，毕竟分布式事务涉及到数据的正确性，出问题需要快速排查定位并解决。</p><blockquote><p>友情提示：具体的流行度，胖友可以选择看看 <a href="https://github.com/apache/incubator-seata/issues/1246" target="_blank" rel="noopener noreferrer">Wanted: who&#x27;s using Seata</a> 每个公司登记的使用方式。</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-三种角色">1.2 三种角色<a href="#12-三种角色" class="hash-link" aria-label="1.2 三种角色的直接链接" title="1.2 三种角色的直接链接">​</a></h2><p>在 Seata 的架构中，一共有三个角色：</p><p><img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/02.png" alt="三个角色" class="img_ev3q"></p><ul><li><strong>TC</strong> (Transaction Coordinator) - 事务协调者：维护全局和分支事务的状态，驱动<strong>全局事务</strong>提交或回滚。</li><li><strong>TM</strong> (Transaction Manager) - 事务管理器：定义<strong>全局事务</strong>的范围，开始全局事务、提交或回滚全局事务。</li><li><strong>RM</strong> ( Resource Manager ) - 资源管理器：管理<strong>分支事务</strong>处理的资源( Resource )，与 TC 交谈以注册分支事务和报告分支事务的状态，并驱动<strong>分支事务</strong>提交或回滚。</li></ul><p>其中，TC 为单独部署的 <strong>Server</strong> 服务端，TM 和 RM 为嵌入到应用中的 <strong>Client</strong> 客户端。</p><p>在 Seata 中，一个分布式事务的<strong>生命周期</strong>如下：</p><p><img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/01.png" alt="架构图" class="img_ev3q"></p><blockquote><p>友情提示：看下艿艿添加的红色小勾。</p></blockquote><ul><li><p>TM 请求 TC 开启一个全局事务。TC 会生成一个 <strong>XID</strong> 作为该全局事务的编号。</p><blockquote><p><strong>XID</strong>，会在微服务的调用链路中传播，保证将多个微服务的子事务关联在一起。</p></blockquote></li><li><p>RM 请求 TC 将本地事务注册为全局事务的分支事务，通过全局事务的 <strong>XID</strong> 进行关联。</p></li><li><p>TM 请求 TC 告诉 <strong>XID</strong> 对应的全局事务是进行提交还是回滚。</p></li><li><p>TC 驱动 RM 们将 <strong>XID</strong> 对应的自己的本地事务进行提交还是回滚。</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="13-框架支持情况">1.3 框架支持情况<a href="#13-框架支持情况" class="hash-link" aria-label="1.3 框架支持情况的直接链接" title="1.3 框架支持情况的直接链接">​</a></h2><p>Seata 目前提供了对主流的<strong>微服务框架</strong>的支持：</p><ul><li><p>Dubbo</p><blockquote><p>通过 <a href="https://github.com/apache/incubator-seata/blob/develop/integration/dubbo/" target="_blank" rel="noopener noreferrer"><code>seata-dubbo</code></a> 集成</p></blockquote></li><li><p>SOFA-RPC</p><blockquote><p>通过 <a href="https://github.com/apache/incubator-seata/blob/develop/integration/sofa-rpc/" target="_blank" rel="noopener noreferrer"><code>seata-sofa-rpc</code></a> 集成</p></blockquote></li><li><p>Motan</p><blockquote><p>通过 <a href="https://github.com/apache/incubator-seata/blob/develop/integration/motan/" target="_blank" rel="noopener noreferrer"><code>seata-motan</code></a> 集成</p></blockquote></li><li><p>gRPC</p><blockquote><p>通过 <a href="https://github.com/apache/incubator-seata/blob/develop/integration/gprc/" target="_blank" rel="noopener noreferrer"><code>seata-grpc</code></a> 集成</p></blockquote></li><li><p>Apache HttpClient</p><blockquote><p>通过 <a href="https://github.com/apache/incubator-seata/blob/develop/integration/http/" target="_blank" rel="noopener noreferrer"><code>seata-http</code></a> 集成</p></blockquote></li><li><p>Spring Cloud OpenFeign</p><blockquote><p>通过 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-starters/spring-cloud-starter-alibaba-seata/src/main/java/com/alibaba/cloud/seata/" target="_blank" rel="noopener noreferrer"><code>spring-cloud-starter-alibaba-seata</code></a> 的 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-starters/spring-cloud-starter-alibaba-seata/src/main/java/com/alibaba/cloud/seata/feign/" target="_blank" rel="noopener noreferrer"><code>feign</code></a> 模块</p></blockquote></li><li><p>Spring RestTemplate   </p><blockquote><p>通过 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-starters/spring-cloud-starter-alibaba-seata/src/main/java/com/alibaba/cloud/seata/feign/SeataBeanPostProcessor.java" target="_blank" rel="noopener noreferrer"><code>spring-cloud-starter-alibaba-seata</code></a> 的 <a href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-starters/spring-cloud-starter-alibaba-seata/src/main/java/com/alibaba/cloud/seata/rest/" target="_blank" rel="noopener noreferrer"><code>rest</code></a> 模块</p></blockquote></li></ul><p>同时方便我们集成到 Java 项目当中，Seata 也提供了相应的 Starter 库：</p><ul><li><a href="https://mvnrepository.com/artifact/io.seata/seata-spring-boot-starter" target="_blank" rel="noopener noreferrer"><code>seata-spring-boot-starter</code></a></li><li><a href="https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-seata" target="_blank" rel="noopener noreferrer"><code>spring-cloud-starter-alibaba-seata</code></a></li></ul><p>因为 Seata 是基于 <a href="https://docs.oracle.com/javase/7/docs/api/javax/sql/DataSource.html" target="_blank" rel="noopener noreferrer">DataSource</a> 数据源进行<strong>代理</strong>来拓展，所以天然对主流的 ORM 框架提供了非常好的支持：</p><ul><li>MyBatis、MyBatis-Plus</li><li>JPA、Hibernate</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="14-案例情况">1.4 案例情况<a href="#14-案例情况" class="hash-link" aria-label="1.4 案例情况的直接链接" title="1.4 案例情况的直接链接">​</a></h2><p>从 <a href="https://github.com/apache/incubator-seata/issues/1246" target="_blank" rel="noopener noreferrer">Wanted: who&#x27;s using Seata</a> 的登记情况，Seata 已经在国内很多团队开始落地，其中不乏有滴滴、韵达等大型公司。可汇总如下图：</p><p><img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/03.png" alt="汇总图" class="img_ev3q"></p><p>另外，在 <a href="https://github.com/seata/awesome-seata" target="_blank" rel="noopener noreferrer">awesome-seata</a> 仓库中，艿艿看到了滴滴等等公司的落地时的技术分享，还是非常真实可靠的。如下图所示：<img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/04.png" alt="awesome-seata 滴滴" class="img_ev3q"></p><p>从案例的情况来说，Seata 可能给是目前已知最可靠的分布式事务解决方案，至少对它进行技术投入是非常不错的选择。</p><h1>2. 部署单机 TC Server</h1><p>本小节，我们来学习部署<strong>单机</strong> Seata <strong>TC</strong> Server，常用于学习或测试使用，不建议在生产环境中部署单机。</p><p>因为 TC 需要进行全局事务和分支事务的记录，所以需要对应的<strong>存储</strong>。目前，TC 有两种存储模式( <code>store.mode</code> )：</p><ul><li>file 模式：适合<strong>单机</strong>模式，全局事务会话信息在<strong>内存</strong>中读写，并持久化本地文件 <code>root.data</code>，性能较高。</li><li>db 模式：适合<strong>集群</strong>模式，全局事务会话信息通过 <strong>db</strong> 共享，相对性能差点。</li></ul><p>显然，我们将采用 file 模式，最终我们部署单机 TC Server 如下图所示：<img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/11.png" alt="单机 TC Server" class="img_ev3q"></p><p>哔哔完这么多，我们开始正式部署单机 TC Server，这里艿艿使用 macOS 系统，和 Linux、Windows 是差不多的，胖友脑补翻译。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-下载-seata-软件包">2.1 下载 Seata 软件包<a href="#21-下载-seata-软件包" class="hash-link" aria-label="2.1 下载 Seata 软件包的直接链接" title="2.1 下载 Seata 软件包的直接链接">​</a></h2><p>打开 <a href="https://github.com/apache/incubator-seata/releases" target="_blank" rel="noopener noreferrer">Seata 下载页面</a>，选择想要的 Seata 版本。这里，我们选择 <a href="https://github.com/apache/incubator-seata/releases/tag/v1.1.0" target="_blank" rel="noopener noreferrer">v1.1.0</a> 最新版本。</p><div class="language-Bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir -p /Users/yunai/Seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd /Users/yunai/Seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 下载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ wget https://github.com/apache/incubator-seata/releases/download/v1.1.0/seata-server-1.1.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 解压</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tar -zxvf seata-server-1.1.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">24 -rw-r--r--    1 yunai  staff  11365 May 13  2019 LICENSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0 drwxr-xr-x    4 yunai  staff    128 Apr  2 07:46 bin # 执行脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0 drwxr-xr-x    9 yunai  staff    288 Feb 19 23:49 conf # 配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0 drwxr-xr-x  138 yunai  staff   4416 Apr  2 07:46 lib #  seata-*.jar + 依赖库 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-启动-tc-server">2.2 启动 TC Server<a href="#22-启动-tc-server" class="hash-link" aria-label="2.2 启动 TC Server的直接链接" title="2.2 启动 TC Server的直接链接">​</a></h2><p>执行 <code>nohup sh bin/seata-server.sh &amp;</code> 命令，启动 TC Server 在后台。在 <code>nohup.out</code> 文件中，我们看到如下日志，说明启动成功：</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 使用 File 存储器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-02 08:36:01.302 INFO [main]io.seata.common.loader.EnhancedServiceLoader.loadFile:247 -load TransactionStoreManager[FILE] extension by class[io.seata.server.store.file.FileTransactionStoreManager]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-02 08:36:01.302 INFO [main]io.seata.common.loader.EnhancedServiceLoader.loadFile:247 -load SessionManager[FILE] extension by class[io.seata.server.session.file.FileBasedSessionManager]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 启动成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-02 08:36:01.597 INFO [main]io.seata.core.rpc.netty.RpcServerBootstrap.start:155 -Server started ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>默认配置下，Seata TC Server 启动在 <strong>8091</strong> 端点。</li></ul><p>因为我们使用 file 模式，所以可以看到用于持久化的本地文件 <code>root.data</code>。操作命令如下：</p><div class="language-Bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -ls sessionStore/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 -rw-r--r--  1 yunai  staff  0 Apr  2 08:36 root.data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>后续，胖友可以阅读<a href="#">「4. 接入 Java 应用」</a>小节，开始使用 Seata 实现分布式事务。</p><h1>3. 部署集群 TC Server</h1><p>本小节，我们来学习部署<strong>集群</strong> Seata <strong>TC</strong> Server，实现高可用，生产环境下必备。在集群时，多个 Seata TC Server 通过 <strong>db</strong> 数据库，实现全局事务会话信息的共享。</p><p>同时，每个 Seata TC Server 可以注册自己到注册中心上，方便应用从注册中心获得到他们。最终我们部署 集群 TC Server 如下图所示：<img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/21.png" alt="集群 TC Server" class="img_ev3q"></p><p>Seata TC Server 对主流的注册中心都提供了集成，具体可见 <a href="https://github.com/apache/incubator-seata/tree/develop/discovery" target="_blank" rel="noopener noreferrer">discovery</a> 目录。考虑到国内使用 Nacos 作为注册中心越来越流行，这里我们就采用它。</p><blockquote><p>友情提示：如果对 Nacos 不了解的胖友，可以参考<a href="http://www.iocoder.cn/Nacos/install/?self" target="_blank" rel="noopener noreferrer">《Nacos 安装部署》</a>文章。</p></blockquote><p>哔哔完这么多，我们开始正式部署单机 TC Server，这里艿艿使用 macOS 系统，和 Linux、Windows 是差不多的，胖友脑补翻译。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-下载-seata-软件包">3.1 下载 Seata 软件包<a href="#31-下载-seata-软件包" class="hash-link" aria-label="3.1 下载 Seata 软件包的直接链接" title="3.1 下载 Seata 软件包的直接链接">​</a></h2><p>打开 <a href="https://github.com/apache/incubator-seata/releases" target="_blank" rel="noopener noreferrer">Seata 下载页面</a>，选择想要的 Seata 版本。这里，我们选择 <a href="https://github.com/apache/incubator-seata/releases/tag/v1.1.0" target="_blank" rel="noopener noreferrer">v1.1.0</a> 最新版本。</p><div class="language-Bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir -p /Users/yunai/Seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd /Users/yunai/Seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 下载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ wget https://github.com/apache/incubator-seata/releases/download/v1.1.0/seata-server-1.1.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 解压</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tar -zxvf seata-server-1.1.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">24 -rw-r--r--    1 yunai  staff  11365 May 13  2019 LICENSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0 drwxr-xr-x    4 yunai  staff    128 Apr  2 07:46 bin # 执行脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0 drwxr-xr-x    9 yunai  staff    288 Feb 19 23:49 conf # 配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0 drwxr-xr-x  138 yunai  staff   4416 Apr  2 07:46 lib #  seata-*.jar + 依赖库 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-初始化数据库">3.2 初始化数据库<a href="#32-初始化数据库" class="hash-link" aria-label="3.2 初始化数据库的直接链接" title="3.2 初始化数据库的直接链接">​</a></h2><p>① 使用 <a href="https://github.com/apache/incubator-seata/blob/develop/script/server/db/mysql.sql" target="_blank" rel="noopener noreferrer"><code>mysql.sql</code></a> 脚本，初始化 Seata TC Server 的 db 数据库。脚本内容如下：</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- the table to store GlobalSession data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE IF NOT EXISTS `global_table`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `xid`                       VARCHAR(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `transaction_id`            BIGINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `status`                    TINYINT      NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `application_id`            VARCHAR(32),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `transaction_service_group` VARCHAR(32),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `transaction_name`          VARCHAR(128),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `timeout`                   INT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `begin_time`                BIGINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `application_data`          VARCHAR(2000),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_create`                DATETIME,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_modified`              DATETIME,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY (`xid`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_transaction_id` (`transaction_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = InnoDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DEFAULT CHARSET = utf8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- the table to store BranchSession data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE IF NOT EXISTS `branch_table`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `branch_id`         BIGINT       NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `xid`               VARCHAR(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `transaction_id`    BIGINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `resource_group_id` VARCHAR(32),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `resource_id`       VARCHAR(256),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `branch_type`       VARCHAR(8),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `status`            TINYINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `client_id`         VARCHAR(64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `application_data`  VARCHAR(2000),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_create`        DATETIME(6),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_modified`      DATETIME(6),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY (`branch_id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_xid` (`xid`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = InnoDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DEFAULT CHARSET = utf8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- the table to store lock data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE IF NOT EXISTS `lock_table`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `row_key`        VARCHAR(128) NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `xid`            VARCHAR(96),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `transaction_id` BIGINT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `branch_id`      BIGINT       NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `resource_id`    VARCHAR(256),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `table_name`     VARCHAR(32),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `pk`             VARCHAR(36),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_create`     DATETIME,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_modified`   DATETIME,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY (`row_key`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_branch_id` (`branch_id`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = InnoDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DEFAULT CHARSET = utf8;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 MySQL 中，创建 <code>seata</code> 数据库，并在该库下执行该脚本。最终结果如下图：<img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/22.png" alt="`seata` 数据库 - MySQL 5.X" class="img_ev3q"></p><p>② 修改 <code>conf/file</code> 配置文件，修改使用 db 数据库，实现 Seata TC Server 的全局事务会话信息的共享。如下图所示：<img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/23.png" alt="`conf/file` 配置文件" class="img_ev3q"></p><p>③ MySQL8 的支持</p><blockquote><p>如果胖友使用的 MySQL 是 8.X 版本，则需要看该步骤。否则，可以直接跳过。</p></blockquote><p>首先，需要下载 MySQL 8.X JDBC 驱动，命令行操作如下：</p><div class="language-Bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ wget https://repo1.maven.org/maven2/mysql/mysql-connector-java/8.0.19/mysql-connector-java-8.0.19.jar</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后，修改 <code>conf/file</code> 配置文件，使用该 MySQL 8.X JDBC 驱动。如下图所示：<img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/24.png" alt="`seata` 数据库 - MySQL 8.X" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-设置使用-nacos-注册中心">3.3 设置使用 Nacos 注册中心<a href="#33-设置使用-nacos-注册中心" class="hash-link" aria-label="3.3 设置使用 Nacos 注册中心的直接链接" title="3.3 设置使用 Nacos 注册中心的直接链接">​</a></h2><p>修改 <code>conf/registry.conf</code> 配置文件，设置使用 Nacos 注册中心。如下图所示：<img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/25.png" alt="`conf/registry.conf` 配置文件" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="34-启动-tc-server">3.4 启动 TC Server<a href="#34-启动-tc-server" class="hash-link" aria-label="3.4 启动 TC Server的直接链接" title="3.4 启动 TC Server的直接链接">​</a></h2><p>① 执行 <code>nohup sh bin/seata-server.sh -p 18091 -n 1 &amp;</code> 命令，启动<strong>第一个</strong> TC Server 在后台。</p><ul><li><code>-p</code>：Seata TC Server 监听的端口。</li><li><code>-n</code>：Server node。在多个 TC Server 时，需区分各自节点，用于生成不同区间的 transactionId 事务编号，以免冲突。</li></ul><p>在 <code>nohup.out</code> 文件中，我们看到如下日志，说明启动成功：</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 使用 DB 存储器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-05 16:54:12.793 INFO [main]io.seata.common.loader.EnhancedServiceLoader.loadFile:247 -load DataSourceGenerator[dbcp] extension by class[io.seata.server.store.db.DbcpDataSourceGenerator]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loading class `com.mysql.jdbc.Driver&#x27;. This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver&#x27;. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-05 16:54:13.442 INFO [main]io.seata.common.loader.EnhancedServiceLoader.loadFile:247 -load LogStore[DB] extension by class[io.seata.core.store.db.LogStoreDataBaseDAO]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-05 16:54:13.442 INFO [main]io.seata.common.loader.EnhancedServiceLoader.loadFile:247 -load TransactionStoreManager[DB] extension by class[io.seata.server.store.db.DatabaseTransactionStoreManager]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-05 16:54:13.442 INFO [main]io.seata.common.loader.EnhancedServiceLoader.loadFile:247 -load SessionManager[DB] extension by class[io.seata.server.session.db.DataBaseSessionManager]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 启动成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-05 16:54:13.779 INFO [main]io.seata.core.rpc.netty.RpcServerBootstrap.start:155 -Server started ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 使用 Nacos 注册中心</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-05 16:54:13.788 INFO [main]io.seata.common.loader.EnhancedServiceLoader.loadFile:247 -load RegistryProvider[Nacos] extension by class[io.seata.discovery.registry.nacos.NacosRegistryProvider]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>② 执行 <code>nohup sh bin/seata-server.sh -p 28091 -n 2 &amp;</code> 命令，启动<strong>第二个</strong> TC Server 在后台。</p><p>③ 打开 Nacos 注册中心的控制台，我们可以看到有<strong>两个</strong> Seata TC Server 示例。如下图所示：<img loading="lazy" src="http://www.iocoder.cn/images/Seata/2017-01-01/26.png" alt="Nacos 控制台" class="img_ev3q"></p><h1>4. 接入 Java 应用</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="41-at-模式">4.1 AT 模式<a href="#41-at-模式" class="hash-link" aria-label="4.1 AT 模式的直接链接" title="4.1 AT 模式的直接链接">​</a></h2><p><strong>① Spring Boot</strong></p><p>1、<a href="http://www.iocoder.cn/Spring-Boot/Seata/?self" target="_blank" rel="noopener noreferrer">《芋道 Spring Boot 分布式事务 Seata 入门》</a>的<a href="#">「2. AT 模式 + 多数据源」</a>小节，实现单体 Spring Boot 项目在多数据源下的分布式事务。</p><p><img loading="lazy" src="http://www.iocoder.cn/images/Spring-Boot/2020-10-01/01.png" alt="整体图" class="img_ev3q"></p><p>2、<a href="http://www.iocoder.cn/Spring-Boot/Seata/?self" target="_blank" rel="noopener noreferrer">《芋道 Spring Boot 分布式事务 Seata 入门》</a>的<a href="#">「AT 模式 + HttpClient 远程调用」</a>小节，实现多个 Spring Boot 项目的分布事务。</p><p><img loading="lazy" src="http://www.iocoder.cn/images/Spring-Boot/2020-10-01/21.png" alt="整体图" class="img_ev3q"></p><p><strong>② Dubbo</strong></p><p><a href="http://www.iocoder.cn/Dubbo/Seata/?sef" target="_blank" rel="noopener noreferrer">《Dubbo 分布式事务 Seata 入门》</a>的<a href="#">「2. AT 模式」</a>小节，实现多个 Dubbo 服务下的分布式事务。</p><p><img loading="lazy" src="http://www.iocoder.cn/images/Dubbo/2020-04-15/01.png" alt="整体图" class="img_ev3q"></p><p><strong>③ Spring Cloud</strong></p><p><a href="http://www.iocoder.cn/Spring-Cloud-Alibaba/Seata/?self" target="_blank" rel="noopener noreferrer">《芋道 Spring Cloud Alibaba 分布式事务 Seata 入门》</a>的<a href="#">「3. AT 模式 + Feign」</a>小节，实现多个 Spring Cloud 服务下的分布式事务。</p><p><img loading="lazy" src="http://www.iocoder.cn/images/Spring-Cloud/2020-07-15/01.png" alt="整体图" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="42-tcc-模式">4.2 TCC 模式<a href="#42-tcc-模式" class="hash-link" aria-label="4.2 TCC 模式的直接链接" title="4.2 TCC 模式的直接链接">​</a></h2><ul><li>文档：<a href="https://seata.io/zh-cn/docs/dev/mode/tcc-mode.html" target="_blank" rel="noopener noreferrer">《Seata 文档 —— TCC 模式》</a></li><li>示例：<a href="https://github.com/apache/incubator-seata-samples/blob/master/tcc" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-samples/blob/master/tcc</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="43-saga-模式">4.3 Saga 模式<a href="#43-saga-模式" class="hash-link" aria-label="4.3 Saga 模式的直接链接" title="4.3 Saga 模式的直接链接">​</a></h2><ul><li>文档：<a href="https://seata.io/zh-cn/docs/dev/mode/saga-mode.html" target="_blank" rel="noopener noreferrer">《Seata 文档 —— Saga 模式》</a></li><li>示例：<a href="https://github.com/apache/incubator-seata-samples/tree/master/saga" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-samples/tree/master/saga</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="44-xa-模式">4.4 XA 模式<a href="#44-xa-模式" class="hash-link" aria-label="4.4 XA 模式的直接链接" title="4.4 XA 模式的直接链接">​</a></h2><p>Seata 正在开发中...</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-ha-practice">Seata 高可用部署实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-04-10T00:00:00.000Z" itemprop="datePublished">2020年4月10日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">helloworlde</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>使用配置中心和数据库来实现 Seata 的高可用，以 Nacos 和 MySQL 为例，将<a href="https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-nacos/" target="_blank" rel="noopener noreferrer">cloud-seata-nacos</a>应用部署到 Kubernetes 集群中</p><p>该应用使用 Nacos 作为配置和注册中心，总共有三个服务: order-service, pay-service, storage-service, 其中 order-service 对外提供下单接口，当余额和库存充足时，下单成功，会提交事务，当不足时会抛出异常，下单失败，回滚事务</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="准备工作">准备工作<a href="#准备工作" class="hash-link" aria-label="准备工作的直接链接" title="准备工作的直接链接">​</a></h2><p>需要准备可用的注册中心、配置中心 Nacos 和 MySQL，通常情况下，注册中心、配置中心和数据库都是已有的，不需要特别配置，在这个实践中，为了简单，只部署单机的注册中心、配置中心和数据库，假设他们是可靠的</p><ul><li>部署 Nacos </li></ul><p>在服务器部署 Nacos，开放 8848 端口，用于 seata-server 注册，服务器地址为 <code>192.168.199.2</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run --name nacos -p </span><span class="token number" style="color:#36acaa">8848</span><span class="token plain">:8848 -e </span><span class="token assign-left variable" style="color:#36acaa">MODE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">standalone nacos/nacos-server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>部署 MySQL </li></ul><p>部署一台MySQL 数据库，用于保存事务数据，服务器地址为 <code>192.168.199.2</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run --name mysql -p </span><span class="token number" style="color:#36acaa">30060</span><span class="token plain">:3306-e </span><span class="token assign-left variable" style="color:#36acaa">MYSQL_ROOT_PASSWORD</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"> -d mysql:5.7.17</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署-seata-server">部署 seata-server<a href="#部署-seata-server" class="hash-link" aria-label="部署 seata-server的直接链接" title="部署 seata-server的直接链接">​</a></h2><ul><li>创建seata-server需要的表</li></ul><p>具体的 SQL 参考 <a href="https://github.com/apache/incubator-seata/tree/develop/script/server/db" target="_blank" rel="noopener noreferrer">script/server/db</a>，这里使用的是 MySQL 的脚本，数据库名称为 <code>seata</code></p><p>同时，也需要创建 undo_log 表， 可以参考 <a href="https://github.com/apache/incubator-seata/blob/develop/script/client/at/db/" target="_blank" rel="noopener noreferrer">script/client/at/db/</a></p><ul><li>修改seata-server配置</li></ul><p>将以下配置添加到 Nacos 配置中心，具体添加方法可以参考 <a href="https://github.com/apache/incubator-seata/tree/develop/script/config-center" target="_blank" rel="noopener noreferrer">script/config-center</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">service.vgroupMapping.my_test_tx_group=default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.mode=db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.datasource=druid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.dbType=mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.driverClassName=com.mysql.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.url=jdbc:mysql://192.168.199.2:30060/seata?useUnicode=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.user=root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store.db.password=123456</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="部署-seata-server-到-kubernetes">部署 seata-server 到 Kubernetes<a href="#部署-seata-server-到-kubernetes" class="hash-link" aria-label="部署 seata-server 到 Kubernetes的直接链接" title="部署 seata-server 到 Kubernetes的直接链接">​</a></h3><ul><li>seata-server.yaml</li></ul><p>需要将 ConfigMap 的注册中心和配置中心地址改成相应的地址</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8091</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> StatefulSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker.io/seataio/seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SEATA_CONFIG_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/root/seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config/registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8091</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /root/seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">configMap</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">registry.conf</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    registry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          application = &quot;seata-server&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          serverAddr = &quot;192.168.199.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      type = &quot;nacos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      nacos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        serverAddr = &quot;192.168.199.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        group = &quot;SEATA_GROUP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>部署</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f seata-server.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>部署完成后，会有三个 pod</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> seata-ha-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seata-ha-server-645844b8b6-9qh5j    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          3m14s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seata-ha-server-645844b8b6-pzczs    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          3m14s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seata-ha-server-645844b8b6-wkpw8    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          3m14s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>待启动完成后，可以在 Nacos 的服务列表中发现三个 seata-server 的实例，至此，已经完成 seata-server 的高可用部署</p><ul><li>查看服务日志 </li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubelet logs -f seata-ha-server-645844b8b6-9qh5j</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[0.012s][info   ][gc] Using Serial</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-15 00:55:09.880 INFO [main]io.seata.server.ParameterParser.init:90 -The server is running in container.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-15 00:55:10.013 INFO [main]io.seata.config.FileConfiguration.&lt;init&gt;:110 -The configuration file used is file:/root/seata-config/registry.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-15 00:55:12.426 INFO [main]com.alibaba.druid.pool.DruidDataSource.init:947 -{dataSource-1} inited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-04-15 00:55:13.127 INFO [main]io.seata.core.rpc.netty.RpcServerBootstrap.start:155 -Server started </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中<code>{dataSource-1} </code>说明使用了数据库，并正常初始化完成</p><ul><li>查看注册中心，此时seata-serve 这个服务会有三个实例</li></ul><p><img loading="lazy" alt="seata-ha-nacos-list.png" src="/zh-cn/assets/images/seata-ha-nacos-list-ae9a4b1039d45635720aa5e10d3adb22.png" width="3002" height="1488" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署业务服务">部署业务服务<a href="#部署业务服务" class="hash-link" aria-label="部署业务服务的直接链接" title="部署业务服务的直接链接">​</a></h2><ul><li>创建业务表并初始化数据</li></ul><p>具体的业务表可以参考 <a href="https://github.com/helloworlde/spring-cloud-alibaba-component/blob/master/cloud-seata-nacos/README.md" target="_blank" rel="noopener noreferrer">cloud-seata-nacos/README.md</a></p><ul><li>添加 Nacos 配置</li></ul><p>在 public 的命名空间下，分别创建 data-id 为 <code>order-service.properties</code>, <code>pay-service.properties</code>, <code>storage-service.properties</code> 的配置，内容相同，需要修改数据库的地址、用户名和密码</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># MySQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.url=jdbc:mysql://192.168.199.2:30060/seata?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.username=root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.password=123456</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Seata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.cloud.alibaba.seata.tx-service-group=my_test_tx_group</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>部署服务</li></ul><p>通过 application.yaml 配置文件部署服务，需要注意的是修改 ConfigMap 的 <code>NACOS_ADDR</code>为自己的 Nacos 地址</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8081</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30081</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">NACOS_ADDR</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 192.168.199.2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">roleRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subjects</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">order</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-order-service:1.1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NACOS_ADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">configMapKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NACOS_ADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8081</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pay</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-pay-service:1.1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NACOS_ADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">configMapKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NACOS_ADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8082</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;registry.cn-qingdao.aliyuncs.com/hellowoodes/seata-ha-storage-service:1.1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NACOS_ADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">configMapKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NACOS_ADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> seata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ha</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8083</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过以下命令，将应用部署到集群中</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f application.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后查看创建的 pod，seata-ha-service 这个服务下有三个 pod</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> seata-ha-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seata-ha-service-7dbdc6894b-5r8q4      </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">/3     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          12m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>待应用启动后，在 Nacos 的服务列表中，会有相应的服务</p><p><img loading="lazy" alt="seata-ha-service-list.png" src="/zh-cn/assets/images/seata-ha-service-list-4de3a26b9eb022aad4c663b338003ddf.png" width="1928" height="748" class="img_ev3q"></p><p>此时查看服务的日志，会看到服务向每一个 TC 都注册了</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl logs -f seata-ha-service-7dbdc6894b-5r8q4 seata-ha-order-service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="seata-ha-service-register.png" src="/zh-cn/assets/images/seata-ha-service-register-ae840566257c4c3e0c377bc6f0c8e931.png" width="2808" height="480" class="img_ev3q"></p><p>查看任意的 TC 日志，会发现每一个服务都向 TC 注册了</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubelet logs -f seata-ha-server-645844b8b6-9qh5j</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="seata-ha-tc-register.png" src="/zh-cn/assets/images/seata-ha-tc-register-af7ee7fcdb6f59c11d68a4ab73c7d8a8.png" width="3250" height="324" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试">测试<a href="#测试" class="hash-link" aria-label="测试的直接链接" title="测试的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="测试成功场景">测试成功场景<a href="#测试成功场景" class="hash-link" aria-label="测试成功场景的直接链接" title="测试成功场景的直接链接">​</a></h3><p>调用下单接口，将 price 设置为 1，因为初始化的余额为 10，可以下单成功</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X POST </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  http://192.168.199.2:30081/order/placeOrder </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H </span><span class="token string" style="color:#e3116c">&#x27;Content-Type: application/json&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d </span><span class="token string" style="color:#e3116c">&#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;userId&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;productId&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;price&quot;: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时返回结果为：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;success&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;message&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;data&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看TC 的日志，事务成功提交：</p><p><img loading="lazy" alt="seata-ha-commit-tc-success.png" src="/zh-cn/assets/images/seata-ha-commit-tc-success-d5017d503959370afdcda04a1ff5dfb7.png" width="3002" height="866" class="img_ev3q"></p><p>查看 order-service 服务日志
<img loading="lazy" alt="seata-ha-commit-success.png" src="/zh-cn/assets/images/seata-ha-commit-service-success-6e7a84881ebffa04b9a79fe9f784b872.png" width="2374" height="680" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="测试失败场景">测试失败场景<a href="#测试失败场景" class="hash-link" aria-label="测试失败场景的直接链接" title="测试失败场景的直接链接">​</a></h3><p>设置 price 为 100，此时余额不足，会下单失败抛出异常，事务会回滚</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X POST </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  http://192.168.199.2:30081/order/placeOrder </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H </span><span class="token string" style="color:#e3116c">&#x27;Content-Type: application/json&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d </span><span class="token string" style="color:#e3116c">&#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;userId&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;productId&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;price&quot;: 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看 TC 的日志：
<img loading="lazy" alt="seata-ha-commit-tc-rollback.png" src="/zh-cn/assets/images/seata-ha-commit-tc-rollback-fd88073e7ebdb2d2537880257fd5aeaf.png" width="2282" height="666" class="img_ev3q"></p><p>查看服务的日志 ：
<img loading="lazy" alt="seata-ha-commit-service-rollback.png" src="/zh-cn/assets/images/seata-ha-commit-service-rollback-04f600853ea2bb6e6780579d4d092ba5.png" width="2338" height="490" class="img_ev3q"></p><p>多次调用查看服务日志，发现会随机的向其中某台TC发起事务注册，当扩容或缩容后，有相应的 TC 参与或退出，证明高可用部署生效</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-01-11T00:00:00.000Z" itemprop="datePublished">2020年1月11日</time> · <!-- -->阅读需 8 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">赵润泽</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一--导读">一 . 导读<a href="#一--导读" class="hash-link" aria-label="一 . 导读的直接链接" title="一 . 导读的直接链接">​</a></h2><p>根据<a href="https://www.iteye.com/blog/javatar-949527" target="_blank" rel="noopener noreferrer">大佬</a>定义的分类，配置可以有三种：环境配置、描述配置、扩展配置。</p><p>环境配置：像一些组件启动时的参数等，通常是离散的简单值，多是 key-value 型数据。</p><p>描述配置：与业务逻辑相关，比如：事务发起方和参与方，通常会嵌到业务的生命周期管理中。描述配置信息较多，甚至有层次关系。</p><p>扩展配置：产品需要发现第三方实现，对配置的聚合要求比较高，比如：各种配置中心和注册中心，通常做法是在 jar 包的 META-INF/services 下放置接口类全名文件，内容为每行一个实现类类名。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二-环境配置">二. 环境配置<a href="#二-环境配置" class="hash-link" aria-label="二. 环境配置的直接链接" title="二. 环境配置的直接链接">​</a></h2><p>seata server 在加载的时候，会使用 resources/registry.conf 来确定配置中心和注册中心的类型。而 seata client 在 1.0 版本后，不仅能使用 conf 文件进行配置的加载，也可以在 springboot 的 yml 配置文件中，使用 seata.config.{type} 来进行配置中心的选择，注册中心与之类似。通过 yml 加载配置的源码在 io.seata.spring.boot.autoconfigure.properties.registry 包下。</p><p>如果 seata 客户端的使用者既在resources下放了 conf 配置文件又在 yml 文件中配置，那么会优先使用 yml 中配置的。代码：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CURRENT_FILE_INSTANCE = null == extConfiguration ? configuration : extConfiguration;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里 extConfiguration 是外部配置实例，即 ExtConfigurationProvider#provide() 外部配置提供类提供的，而 configuration 是另一个配置提供类提供的 ConfigurationProvider#provide()，这两个配置提供类是在 config 模块 ConfigurationFactory 静态块中，通过 SPI 的方式加载。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EnhancedServiceLoader.load(ExtConfigurationProvider.class).provide(configuration);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面说的是配置中心类型的选择，而配置环境的加载，是在确定了使用什么配置中心类型后，再通过相应的配置中心加载环境配置。File 即文本方式配置也是一种配置中心。</p><p>client 和 server 获取配置参数，是通过 ConfigurationFactory#getInstance() 获取配置类实例，再使用配置类实例获取配置参数，配置的 key 这些常量的定义，主要在 core 模块下 config 文件中。</p><p>一些重要的环境配置属性的意义，<a href="https://seata.io/zh-cn/docs/user/configurations.html" target="_blank" rel="noopener noreferrer">官网都有介绍</a>。</p><p>在实例化的时候通过 ConfigurationFactory 获取后注入构造函数中的，需要重启才能生效，而在使用时通过 ConfigurationFactory 实时获取的，配置改了就可以生效。</p><p>但是 config 模块提供了 ConfigurationChangeListener#onChangeEvent 接口方法来修改实例内部的属性。即在这个方法中，监听动态变化的属性，如果检测到自身使用的属性和刚开始注入时不一样了，就修改实例中保存的属性，和配置中心保持一致，这样就实现了动态配置。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionalInterceptor implements ConfigurationChangeListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private volatile boolean disable = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override public Object invoke(Param param) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   if(disable){//事务业务处理}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override public void onChangeEvent(Param param) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disable = param;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面是 spring 模块下的 GlobalTransactionalInterceptor 与降级属性相关的伪代码。 GlobalTrarnsactionalScanner 在上面的 interceptor 类被实例化时，把 interceptor 注册到了配置变化监听列表中，当配置被改变的时候，会调用监听器：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ConfigurationFactory.getInstance().addConfigListener(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,(ConfigurationChangeListener)interceptor);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>降级的意思是，当服务某一项功能不可用的时候，通过动态配置的属性，把某一项功能给关了，这样就可以避免一直尝试失败的处理。interceptor#invoke() 只有当这个 disable 属性为 true 时，才会执行 seata 事务相关业务。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三-描述配置">三. 描述配置<a href="#三-描述配置" class="hash-link" aria-label="三. 描述配置的直接链接" title="三. 描述配置的直接链接">​</a></h2><p>一般性框架描述性配置通常信息比较多，甚至有层次关系，用 xml 配置比较方便，因为树结构描述性更强。而现在的习惯都在提倡去繁琐的约束性配置，采用约定的方式。</p><p>seata AT 模式是通过代理数据源的方式来进行事务处理，对业务方入侵较小，只需让 seata 在启动时，识别哪些业务方需要开启全局事务，所以用注解就可以实现描述性配置。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@GlobalTransactional(timeoutMills = 300000, name = &quot;busi-doBiz&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public String doBiz(String msg) {}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果是 tcc 模式，事务参与方还需使用注解标识：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@TwoPhaseBusinessAction(name = &quot;tccActionForSpringTest&quot; , commitMethod = &quot;commit&quot;, rollbackMethod = &quot;rollback&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public boolean prepare(BusinessActionContext actionContext, int i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public boolean commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public boolean rollback(BusinessActionContext actionContext);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四-扩展配置">四 .扩展配置<a href="#四-扩展配置" class="hash-link" aria-label="四 .扩展配置的直接链接" title="四 .扩展配置的直接链接">​</a></h2><p>扩展配置，通常对产品的聚合要求比较高，因为产品需要发现第三方实现，将其加入产品内部。</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20200110213751452.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODA0NzM3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" class="img_ev3q">
这是一个自定义配置中心提供类的例子，在 META-INF/services 下放置一个接口同名的文本文件，文件的内容为接口的实现类。这是标准的 spi 方式。然后修改配置文件 registry.conf 中的 config.type=test 。</p><p>但是如果你认为这样就可以被 seata 识别到，并且替换掉配置中心，那你就错了。seata 在加载配置中心的时候，使用 enum ConfigType 包裹了一下配置文件中配置的配置中心的类型的值：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static Configuration buildConfiguration() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   configTypeName = &quot;test&quot;;//registry.conf中配置的config.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   configType = ConfigType.getType(configTypeName);//ConfigType获取不到会抛异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果在 ConfigType 中没有定义 test 这种配置中心类型，那么会抛异常。所以单纯的修改配置文件而不改变源码是无法使用 ConfigType 中定义的配置中心提供类以外的配置中心提供类。</p><p>目前1.0版本在 ConfigType 中定义的配置中心类型有：File,ZK,Nacos,Apollo,Consul,Etcd3,SpringCloudConfig,Custom。如果用户想使用自定义的配置中心类型，可以使用 Custom 这种类型。</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20200110215249152.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODA0NzM3,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" class="img_ev3q">
这里可以使用不优雅的方式，即提供一个指定名称 ZK 但是级别 order=3 更高的实现类（ZK默认order=1），就可以让 ConfigurationFactory 使用 TestConfigurationProvider 作为配置中心提供类。</p><p>通过上面的步骤，就可以让 seata 使用我们自己提供的代码。seata 中 codec、compressor、discovery、integration 等模块，都是使用 spi 机制加载功能类，符合微内核 + 插件化，平等对待第三方的设计思想。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五---seata源码分析系列地址">五  . seata源码分析系列地址<a href="#五---seata源码分析系列地址" class="hash-link" aria-label="五  . seata源码分析系列地址的直接链接" title="五  . seata源码分析系列地址的直接链接">​</a></h2><p>作者：赵润泽，<a href="https://blog.csdn.net/qq_37804737/category_9530078.html" target="_blank" rel="noopener noreferrer">系列地址</a>。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-01-01T00:00:00.000Z" itemprop="datePublished">2020年1月1日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">FUNKYE</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>本文作者：FUNKYE(陈健斌),杭州某互联网公司主程。</p><h1>前言</h1><p>​	1.首先来看下包结构,在seata-dubbo和seata-dubbo-alibaba下有统一由TransactionPropagationFilter这个类,分别对应apache-dubbo跟alibaba-dubbo.</p><p><img loading="lazy" alt="20200101203229" src="/zh-cn/assets/images/20200101203229-b1377d653c52962ea621a450291bcf87.png" width="422" height="410" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析源码">分析源码<a href="#分析源码" class="hash-link" aria-label="分析源码的直接链接" title="分析源码的直接链接">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.integration.dubbo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.core.context.RootContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.common.Constants;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.common.extension.Activate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.Filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.Invocation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.Invoker;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.Result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.RpcContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.RpcException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Activate(group = {Constants.PROVIDER, Constants.CONSUMER}, order = 100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TransactionPropagationFilter implements Filter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(TransactionPropagationFilter.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Result invoke(Invoker&lt;?&gt; invoker, Invocation invocation) throws RpcException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取本地XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xidInterceptorType = RootContext.getXIDInterceptorType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取Dubbo隐式传参中的XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = getRpcXid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug(&quot;xid in RootContext[{}] xid in RpcContext[{}]&quot;, xid, rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean bind = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //传递XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (rpcXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //绑定XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bindInterceptorType(rpcXidInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                bind = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.debug(&quot;bind[{}] interceptorType[{}] to RootContext&quot;, rpcXid, rpcXidInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return invoker.invoke(invocation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (bind) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //进行剔除已完成事务的XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String unbindInterceptorType = RootContext.unbindInterceptorType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String unbindXid = RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.debug(&quot;unbind[{}] interceptorType[{}] from RootContext&quot;, unbindXid, unbindInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //如果发现解绑的XID并不是当前接收到的XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!rpcXid.equalsIgnoreCase(unbindXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.warn(&quot;xid in change during RPC from {} to {}, xidInterceptorType from {} to {} &quot;, rpcXid, unbindXid, rpcXidInterceptorType, unbindInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (unbindXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        //重新绑定XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        RootContext.bind(unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        RootContext.bindInterceptorType(unbindInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOGGER.warn(&quot;bind [{}] interceptorType[{}] back to RootContext&quot;, unbindXid, unbindInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * get rpc xid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String getRpcXid() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = RpcContext.getContext().getAttachment(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (rpcXid == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rpcXid = RpcContext.getContext().getAttachment(RootContext.KEY_XID.toLowerCase());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return rpcXid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	1.根据源码,我们可以推出相应的逻辑处理</p><p><img loading="lazy" alt="20200101213336" src="/zh-cn/assets/images/20200101213336-dec117cebba3464f980a52714f43ff7d.png" width="775" height="743" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="要点知识">要点知识<a href="#要点知识" class="hash-link" aria-label="要点知识的直接链接" title="要点知识的直接链接">​</a></h2><p>​	1.Dubbo @Activate注解:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Activate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Group过滤条件。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * &lt;br /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 包含{@link ExtensionLoader#getActivateExtension}的group参数给的值，则返回扩展。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * &lt;br /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 如没有Group设置，则不过滤。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] group() default {};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Key过滤条件。包含{@link ExtensionLoader#getActivateExtension}的URL的参数Key中有，则返回扩展。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * &lt;p/&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 示例：&lt;br/&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 注解的值 &lt;code&gt;@Activate(&quot;cache,validatioin&quot;)&lt;/code&gt;，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 则{@link ExtensionLoader#getActivateExtension}的URL的参数有&lt;code&gt;cache&lt;/code&gt;Key，或是&lt;code&gt;validatioin&lt;/code&gt;则返回扩展。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * &lt;br/&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 如没有设置，则不过滤。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] value() default {};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 排序信息，可以不提供。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] before() default {};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 排序信息，可以不提供。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] after() default {};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 排序信息，可以不提供。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以分析得知,Seata的dubbo过滤器上的注解@Activate(group = {Constants.PROVIDER, Constants.CONSUMER}, order = 100),表示dubbo的服务提供方跟消费方都会触发到这个过滤器,所以我们的Seata发起者会产生一个XID的传递,上述流程图跟代码已经很清晰的表示了.</p><p>​	2.Dubbo隐式传参可以通过 <code>RpcContext</code> 上的 <code>setAttachment</code> 和 <code>getAttachment</code> 在服务消费方和提供方之间进行参数的隐式传递。</p><p>获取:RpcContext.getContext().getAttachment(RootContext.KEY_XID);</p><p>传递:RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);</p><h1>总结</h1><p>更多源码阅读请访问<a href="http://seata.io/zh-cn/index.html" target="_blank" rel="noopener noreferrer">Seata官网</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/page/2"><div class="pagination-nav__label">较新的博文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/page/4"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">
                  <div class="fs-12">
                    <div class="center-div">
                      <span>Apache Seata (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</span>
                    </div>
                    <br>
                    <div class="center-div">
                      <span>Copyright © 2023-2024, The Apache Software Foundation Apache Seata, Seata, Apache, Apache Incubator, the Apache feather, the Apache Incubator logo and the Apache Seata project logo are either registered trademarks or trademarks of the Apache Software Foundation.</span>
                      <br>
                    </div>
                    <br>
                  </div>
                  </div></div></div></footer></div>
<script src="/zh-cn/assets/js/runtime~main.71cb6f6a.js"></script>
<script src="/zh-cn/assets/js/main.8918a088.js"></script>
</body>
</html>