<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://chai001125.github.io/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="http://chai001125.github.io/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="http://chai001125.github.io/zh-cn/blog/page/6"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="keywords" content="Seata"><meta data-rh="true" property="og:title" content="Blog | Seata"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/zh-cn/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="http://chai001125.github.io/zh-cn/blog/page/6"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/blog/page/6" hreflang="en-US"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/zh-cn/blog/page/6" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/blog/page/6" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Seata Atom Feed">




<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.js"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.c84d55f4.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.71f2148b.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.eaa3efae.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><a class="navbar__item navbar__link" href="/zh-cn/docs/overview/what-is-seata">文档</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">解决方案</a><ul class="dropdown__menu"><li><a href="https://cn.aliyun.com/product/aliware/mse?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Seata企业版<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://cn.aliyun.com/product/aliware/mse?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">微服务解决方案<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/ahas?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">高可用解决方案<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://cn.aliyun.com/product/aliware/sae?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">微服务Serverless解决方案<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/edas?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">PaaS解决方案<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/servicemesh?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">服务网格解决方案<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://help.aliyun.com/document_detail/132903.html?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">SOFA分布式事务<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/developers_dev">开发者</a><a href="https://mp.weixin.qq.com/s/nvDmIJEuDaNEY3RfTA3UyA" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">团队招聘</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a class="navbar__item navbar__link" href="/zh-cn/docs/download">下载</a><a href="http://demo.seata.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/blog/page/6" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/page/6" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-observable-practice">Seata的可观测实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-lock">详解 Seata AT 模式事务隔离级别与全局锁设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/welcome">Welcome</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-snowflake-explain">关于新版雪花算法的答疑</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-UUID-generator">Seata基于改良版雪花算法的分布式UUID生成器分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-feature-undo-log-compress">Seata新特性支持 -- undo_log压缩</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dsproxy-deadlock">ConcurrentHashMap导致的Seata死锁问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-02">Seata应用侧启动过程剖析——注册中心与配置中心模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-01">Seata应用侧启动过程剖析——RM &amp; TM如何与TC建立连接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-tcc-mode-with-spring-cloud">Spring Cloud集成Seata分布式事务-TCC模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-manager">Seata配置管理原理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-golang-communication-mode">seata-golang 通信模型详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-datasource-proxy">Seata数据源代理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-demo-in-mac">Mac下的Seata Demo环境搭建（AT模式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-quick-start">Seata 极简入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-ha-practice">Seata 高可用部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-center">Seata 配置中心实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/quick-start-use-seata-and-dubbo-services">如何使用Seata保证Dubbo微服务间的一致性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/manual-transaction-mode">MT 模式</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-03-27T00:00:00.000Z" itemprop="datePublished">2019年3月27日</time> · <!-- -->阅读需 17 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">zhangthen</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Fescar 0.4.0 版本发布了 TCC 模式，由蚂蚁金服团队贡献，欢迎大家试用，文末也提供了项目后续的 Roadmap，欢迎关注。</p><a name="2143093f"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言基于-tcc-模型的应用场景">前言：基于 TCC 模型的应用场景<a href="#前言基于-tcc-模型的应用场景" class="hash-link" aria-label="前言：基于 TCC 模型的应用场景的直接链接" title="前言：基于 TCC 模型的应用场景的直接链接">​</a></h2><p> <br>
<img loading="lazy" alt="1.png" src="/zh-cn/assets/images/TCC1-1d4e4883f0a4310852d664b2d0336227.png" width="625" height="303" class="img_ev3q"><br></p><p>TCC 分布式事务模型直接作用于服务层。不与具体的服务框架耦合，与底层 RPC 协议无关，与底层存储介质无关，可以灵活选择业务资源的锁定粒度，减少资源锁持有时间，可扩展性好，可以说是为独立部署的 SOA 服务而设计的。</p><a name="d9b462de"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一tcc-模型优势">一、TCC 模型优势<a href="#一tcc-模型优势" class="hash-link" aria-label="一、TCC 模型优势的直接链接" title="一、TCC 模型优势的直接链接">​</a></h2><p>对于 TCC 分布式事务模型，笔者认为其在业务场景应用上，有两方面的意义。</p><a name="95179108"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-跨服务的分布式事务">1.1 跨服务的分布式事务<a href="#11-跨服务的分布式事务" class="hash-link" aria-label="1.1 跨服务的分布式事务的直接链接" title="1.1 跨服务的分布式事务的直接链接">​</a></h3><p>服务的拆分，也可以认为是资源的横向扩展，只不过方向不同而已。</p><p>横向扩展可能沿着两个方向发展：</p><ol><li>功能扩展，根据功能对数据进行分组，并将不同的功能组分布在多个不同的数据库上，这实际上就是 SOA 架构下的服务化。</li><li>数据分片，在功能组内部将数据拆分到多个数据库上，为横向扩展增加一个新的维度。</li></ol><p>下图简要阐释了横向数据扩展策略：</p><p><img loading="lazy" alt="2.png" src="/zh-cn/assets/images/TCC2-a511d666420fec7625e3fba934fcdea6.png" width="559" height="464" class="img_ev3q"></p><p>因此，TCC 的其中一个作用就是在按照功能横向扩展资源时，保证多资源访问的事务属性。</p><a name="240e4d15"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-两阶段拆分">1.2 两阶段拆分<a href="#12-两阶段拆分" class="hash-link" aria-label="1.2 两阶段拆分的直接链接" title="1.2 两阶段拆分的直接链接">​</a></h3><p>TCC 另一个作用就是把两阶段拆分成了两个独立的阶段，通过资源业务锁定的方式进行关联。资源业务锁定方式的好处在于，既不会阻塞其他事务在第一阶段对于相同资源的继续使用，也不会影响本事务第二阶段的正确执行。</p><p><strong>传统模型的并发事务：</strong><br>
<img loading="lazy" alt="3.png" src="/zh-cn/assets/images/TCC3-d1a3451fceeb603af33003ed849ff422.png" width="668" height="619" class="img_ev3q"></p><p><strong>TCC 模型的并发事务：</strong><br>
<img loading="lazy" alt="4.png" src="/zh-cn/assets/images/TCC4-d88fd6484677d822f4924241cf806e26.png" width="676" height="458" class="img_ev3q"></p><p>这对业务有什么好处呢？拿支付宝的担保交易场景来说，简化情况下，只需要涉及两个服务，交易服务和账务服务。交易作为主业务服务，账务作为从业务服务，提供 Try、Commit、Cancel 接口：</p><ol><li>Try 接口扣除用户可用资金，转移到预冻结资金。预冻结资金就是业务锁定方案，每个事务第二阶段只能使用本事务的预冻结资金，在第一阶段执行结束后，其他并发事务也可以继续处理用户的可用资金。</li><li>Commit 接口扣除预冻结资金，增加中间账户可用资金（担保交易不能立即把钱打给商户，需要有一个中间账户来暂存）。</li></ol><p>假设只有一个中间账户的情况下，每次调用支付服务的 Commit 接口，都会锁定中间账户，中间账户存在热点性能问题。 但是，在担保交易场景中，七天以后才需要将资金从中间账户划拨给商户，中间账户并不需要对外展示。因此，在执行完支付服务的第一阶段后，就可以认为本次交易的支付环节已经完成，并向用户和商户返回支付成功的结果，并不需要马上执行支付服务二阶段的 Commit 接口，等到低锋期时，再慢慢消化，异步地执行。<br>
<img loading="lazy" alt="5.png" src="/zh-cn/assets/images/TCC5-bad845fca6acd73c946d159389616705.png" width="730" height="647" class="img_ev3q"></p><p>这就是 TCC 分布式事务模型的二阶段异步化功能，从业务服务的第一阶段执行成功，主业务服务就可以提交完成，然后再由框架异步的执行各从业务服务的第二阶段。</p><a name="ad5fc026"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二通用型-tcc-解决方案">二、通用型 TCC 解决方案<a href="#二通用型-tcc-解决方案" class="hash-link" aria-label="二、通用型 TCC 解决方案的直接链接" title="二、通用型 TCC 解决方案的直接链接">​</a></h2><p>通用型 TCC 解决方案就是最典型的 TCC 分布式事务模型实现，所有从业务服务都需要参与到主业务服务的决策当中。<br>
<img loading="lazy" alt="6.png" src="/zh-cn/assets/images/TCC6-30c79677bf0dd24ab9e6cf9edf68a7ea.png" width="654" height="554" class="img_ev3q"><br> </p><a name="62b37e99"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="适用场景">适用场景<a href="#适用场景" class="hash-link" aria-label="适用场景的直接链接" title="适用场景的直接链接">​</a></h3><p>由于从业务服务是同步调用，其结果会影响到主业务服务的决策，因此通用型 TCC 分布式事务解决方案适用于执行时间确定且较短的业务，比如互联网金融企业最核心的三个服务：交易、支付、账务：<br>
<img loading="lazy" alt="7.png" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA5gAAACqCAYAAAG/ldAQAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAACSkSURBVHhe7Z3LrxzHdcbzf3oTL7zIIogXgQECQZCHswvgFVcOHCgOHAegg9DPGDYBS05EStckE8lybBMxJdGEpStRl5cU75vs1NfdNV3dUzPTM1PTc7r6d6CfONOPme4+dc5X3zzu/FFBZBOzZH7h6+8NzstXr+pnXz+efn4SfcxdsGm8+fbd6OPtAsWek1k/+QZx9HwEyXyLZPYKktlGQTJ7sGmQzJ5BMtsoSGYPNg2S2TNIZhsFyezBpmE6mY/ntntQ/quciPa61QyVzFcPHzW33b7i8f3q2PuwaSxLpo7heuv+WWud8Pf7oOidTP/gPqHXgnVf+Pqj1pO31y1m02Rq31XJXHZBwnXl7aPDuW1CNgnttzyZZ8XBUec46tv+/sGt+rY7vlXXVLFWZTZP1oz0+P33ZgeyjH212VfFcev2TXdRw/VdNo1ebfZWdSzX7jeVKcKq1e0w0TEUaGYPNg0mQD2DZLZRkMwebBoks2eQzDYKktmDTYNk9gyS2UZBMnuwaZDMnkEy2yhmybxz587gbJPM5ycX0cfcBZvGwf13o4+3CxSzZBLjD5KZUZTJVJnG+vAu+cEb98oD2DRij7kLjk+v6mdcP2KPtwtOLl6Wz0cyV/D05LJ+xvUj9ni74MU5yewFyewByUwHyewJyewByUwHyewJyewByUzHVslsf4ZGB/1g9hmV8FNmy9h1MrsfgPKf0NOHo/yx+s/fLGNXydQx6BOC3eO8/rAolzXXc/W5bpjM+Q9uVckLk7n4U3Eh2yQz9ngh4THog2XX7h9Hk6kPUa061k2TGXusEB1PeJw+qbFkrjrGLSvTPYG7KDdv+E/hKZnxT5ktYteV2e0Quni6UDpu/RuuW8auKlPXqfvZXV1LXdswmX1AM3vCBKgHJDMdJLMnJLMHJDMdJLMnJLMHJDMdJLMnJLMHJDMd7WQe3C0TOiS377xVHsCmEXvMXXD0YvNkxh5vF7SSSeQRrWQqy7Eyzo0f/Xy7Fr9NnJyeRo9pzFzptceB4/aAf8puKMI/PzjJwtTca5sP028TQ36rYii2mSNuGkN+82Mo/NRHQWEOHBRmmqAwM4TCTAuFmQYKk8JMCoWZBgqTwkwKhZkGCpPCTAqFmQYKk8JMCoWZBgqTwkwKhZmGnRfm49nftW9/WSz8BqD/G/3Vcn23R9s2f7e/Wedu19+4C5dvw9gLs/vtv+r6NF8mE+F3kaovvB2Xy5u/Ev6o+SvhPb7RuIwxFabGmr47pmuoa+S/FFiti481//0y7dP9y+oH9W3/XS+/fBMGUMz6G5BzX8Vt/4jG7JuS5XZ1YboLE34ZUPu1CC7kpuyjMPW8r//maOvCVJHp37niFDeqdc01qhtdXZgaiOHPH3SvrV++LkMWpp7vxfnVVoWpa6ACKwuzM0Zb1NfR/wyDL0y/vSi/HNrZL1y/DjstzO6B+Y7SXdfdrrr/YO7Xb5btsynjVMxK4cJlsesRXr/rDzXo/CykHoCBIugb0rpdfW28GaDrMi7FbM7Tzyqu3fDXKD7WdN19cR7UotGISnufbo7WAY+Jx0wKHjMNFCaFmRQKMw0UJoWZFAozDRQmhZkUCjMNFCaFmRQKMw0UJoWZFAozDRQmhZkUCjMNFCaFmRQKMw0LC/Ps8mX516d0oXPm+dlV+WbwPuLSdYTYMY0VjZdzN26GDj1nbmNVY8NHqzAJgrARs8JUrcbkNUf2NY1VxI5nzHzlW+8UwR93GyT0fLFjGTOykWHMCvPKjdbYDjnyfIvfGN4mXrkRFTueMaPCHLrR6flixzJmVJgaHz6CwpyOYj7bW2HmqZhq6kNGjiJSFWZ9gi4ozAGDwkwTFGamUJjpoDDTQGE6KMx0UJhpoDAdFGY6KMw0UJgOCjMdFGYaKEwHhZkOCjMNFKaDwkwHhZkGCtNBYaaDwkwDhemgMNNBYaaBwnRQmOmgMNNAYToozHRQmGmgMB0UZjoozDRQmA4KMx0UZhooTAeFmQ4KMw2DFWb4a1MV7R8Dmvsxl/KHb9y/jta+W/4SVYwxF2b4WzCe8EeYwuvlr6d+v6S53exX/cpac38TxlaYs+sQ+VWvRWPN76PfL5ntH6z3vwGzDYMqZvuAFxdmeX/HPxUXMnRhfvP2R+W/uypMXZ8u1fLd/7zhkIX5/qen5b9bKeaNw+oaunNvX8vFY03jWNuqMKtf92rW+zGr2+Evqa3LzgszPOjZic7WLX6OUDHD7apfoqqX1z9Bty1DF6Z/XhVoeBxr4QZUeH1889KA0f3ZdsGgCgvT7zfbrlxflD8t112+DkMWpn/O3x1u8ZcG68L01yM890VjLSzM7j5C9/3P8YXL12EQxSwPsNN1/EHPd6W6m9eKuavfcAzZV2FurZj+9y+Dxwzvl4XYKkzdrhXTLd/F744OXZhfeu3XWymmrkGplOV1atut7jXxyzVmFxVmuH24fF0GKcy5Lu7w9/3vDPp//a/1+sL090O8Cvt9tmXMHjOW/NayoDCrBhdOZZt1IizUTadhY/SYpcWqr1P3miwaa74wddvPVjzN9W8X+jrstDBVVIsPWj9FXl8Ed1F8hx7qx1VDxliYzXWs6Kpf7HZzf3c/CDymwiyVsrz9qHX9hM5g2VjTTE6FGTawavoaz8O6DPrij1XGrJjWGJtiWoXCdFCY6aAw00BhOijMdFCYaaAwHRRmOijMNFCYDgozHRRmGihMB4WZDgozDRSmg8JMB4WZBgrTQWGmg8JMA4XpoDDTQWGmgcJ0UJjpoDDTQGE6KMx0UJhpoDAdFGY6KMw0UJgOCjMdFGYaKEwHhZkOCjMNFKaDwkwHhZkGCtNBYaaDwkzD0sLUyimwz8KMHc/Y2Udhxo5jzNx++268MLXw+PSyeHqSO1fFxdWwA8mHnvXzs6vIMY0XNblwQA0Rej49b+x4xorGRXgZZ4VJEISdWFiYZ2dnxdOnx5AJz58/rzM7vTg+jl8TsMNU4uLiInr+YAdp36KICqasvPxo7MUjGCc/fONecXrx0tmzgf3gHkNn+vzFafR6gB30wv6L8yvXd/Iemzq/N9++G70GYAdp3/nVq9ZLPj6igunfOIk9GIyTHzjB1OuYA7+vsddQ/z16vsWPKcAgSDD1uvTQb7oNHTq/N99CMK0j7XtxLnNRJy4IBHMiIJhgFQQTLIFgAoIJZkEwwRIIJiCYYBYEEyyBYAKCCWZBMMESCCYgmGAWBBMsgWACgglmQTDBEggmIJhgFgQTLIFgAoIJZkEwwRIIJiCYYBYEEyyBYAKCCWZBMMESCCYgmGAWBBMsgWACgglmQTDBEggmIJhgFgQTLIFgAoIJZkEwwRL5COaNw/I3yqLr9sxjo8flQTD3h8bG9cjyeR4Urx4+iizfDVbGLII5LNfunxWP7z+Irusy2BhRbx9w7C9jtIJ588g1PXc8fbh5I9z3UXSbhuNg24pXxVl92+17dOj+dc0r2O76w6I4uNXep0LbVY8bLtegjD3PvkAwh6HKezjWFtPdN7as5NZxtJnkMmYRzN3RjJH3igN3DNd0240nL5haFheq9caIxprvwf551L/DiWL3sTy+z3dFXMv6TTTTMnqHWSbV0V5eJ7RsFOFysUowm0HkWdV8+tA0SztC6ZmCYPpz/ebtj8r7VhzmrFEtwY/N2LpNBbMPFsZsroLpz+/9T0/L+3sTzNq9dQXzZk+X2WeM9BHMPvg62IdQekYtmI/rRqEkhDMQ3Y/PnkUzO1pIR2jn11XNR0mvmp1vSvPP4Y+jHFitbbxw719A/+477xR//d2Hxd9+//3iq5kSO+8fvfNxdPkQKPetZWpcnXEnrt+vloXbt8b3QsHMY8x++Z/fLf5KY/N78byOle55fum1Xxc/e3MPglkLZFcwNR67rm7TMSLB9PuJRjDd49X7zp6/xjtL4Zf5ff197aNlQwro6B2mp5npLJiJd9B24azHDwAltzVQWq+f+yZTNR8t6/uc3feq5p5nj0zFYb7+G1eFdVhwmGoKvlnNBHABC8dYTDAzGrO5OkwJ5Ivzq/rePhymxsNZLVzBci+Y7rbyHwpUjD5jJHyv0wujf15tf/AwPulroTHdmaj1GcOpGb1g+uJvGk4zCxLd7Rvq7TqJ0rJwAOj+bNDMmlPdfHTfDTolfdFzlc8RWdd9nn3Ce5jD4sdL62XT8r5jQePQutjycqIYGcO5jFnew9wdfsKm27q6GjNd41G5uLZQ+e39Nt3l4RjpOlC/jxdM3Zdx0b/RSWM5XiMTtXL5/HHtmmwcJmwOgglWQTDBEggmIJhgFgQTLIFgAoIJZkEwwRIIJiCYYBYEEyyBYAKCCWZBMMESCCYgmGAWBBMsgWACgglmQTDBEggmIJhgFgQTLIFgAoIJZkEwwRIIJiCYYBYEEyyBYAKCCWZBMMESCCYgmGAWBBMsgWACgglmQTDBEggmIJhgFgQTLIFgAoIJZkEwwRIIJiCYYBYEEyyBYAKCCWZBMMESGwjmq+LYDeDHR2fFB5+eFh88cf/CaPnQ8Yen58XnZxLM6SjmK3eupxcvi4+fXRQffha/NrBnXH95fHReTuamIJg6T50vfdUm6hPqF+ob6h/diAqmQtsqwZAPsQGQe+iM3alHrwfYYSpDk75qH/df2TdisVAwCYIgCIJoYqFgHh8fF0+fQi5MNU5OTqLXA+xwdXVVZyv/oK/aZ1lEBVMvG8TeDIXx8tnR08m9JKuzfeP2L6LXA+xwcP/dSbwkq3P8k9fejV4DsINell00HOcEUxteXL2KPhCMlz98cuQGQpXjqYQGPoJpn7fuvVNcqkllLJo6N50jgmkffThSvSMWUcHUJ4RiDwTj5YM/PCnOL+Mflc411KBev30QvR5gh9t33ynOLhfP6nMInZvOEcG0z2cvLsveEYt5wXQd9eQcwcyNUjCvpvNpRIVeKUEw7SPBLD/GX+ctx9C56RwRTPs8+fyy7B2xQDAnAoIJVkEwwRIIJiCYYBYEEyyBYAKCCWZBMMESCCYgmGAWBBMsgWACgglmQTDBEggmIJhgFgQTLIFgAoIJZkEwwRIIJiCYYBYEEyyBYAKCCWZBMMESCCYgmGAWBBMsgWACgglmQTDBEggmIJhgFgQTLIFgAoIJZkEwwRIIJiCYYBYEEyyBYAKCCWZBMMESCCYgmGAWBBMsgWACgglmQTDBEggmIJhgFgQTLIFgAoIJZkEwwRIIJiCYYBYEEyyBYAKCCWZBMMESCCYgmGAWBBMsgWACgglmQTDBEggmIJhgFgQTLIFgAoIJZkEwwRIIJiCYYBYEEyyBYAKCCWZBMMESCCYgmGAWBBMsgWACgglmQTDBEtkI5mMd38NH0XV75cahzeMKQDD3hMZGcRxf1+HmURFdvhMMjVkEc1h0LLHlcww4RtTbY8v3QT4Os2w+qy/sgdvmemS5UFPqrrv+sBrQnmv1duEyEe4TonU3b8TXWQHB3BePildHh5Hl8ywaY7HlOY1ZBHM3dMeIn7jp9my7W8cLx6e26ztGWs9TPt6D9jLH4/sP5vYr0TEUZ/F1e2Ckgjl/wRfTvtgSzPh2FTHB9AND+/rmE26n/fztEN+kuoMh9jz7BMEcBl3ePsw1DzWNBbN5bd9dltOYRTB3QzhGwolbMy7cstntNuuOkaYH++dR/25eWdGxHNxq71PR9Plw+bX7Z639h2T8DtM5y+6ygyUzkk0c5qLmo3VVQueTVwlzM2vzAyK8bYXcBfPpyWVJGGNymH7MVGNqMX77nMZsjoL5zdsf1beq0LntSzCrlzu7grlYLDcZI8sEU/uJ+Z5cHUO5vHSZ9fGEt/fAyAWzuqjdRPkZkBpFuFysajrNrKtiWfMJt1uFf/x19xuC3AXz8NlFeZ5//I1fzYRzLIJZzaaXNaP55pHTmM1RML/87d+W5/a1n3xY3te5WRPM7vaL6DNGVjnMPvg6WHe/1IxWMP0FVKKu3Wi/NHCgi1q/pxlrNOW+KxqVZ1HzqZLXsKyhlbjn02P5+zEx3xdTEUyPhPOT5xd7Eczyw2kL6TaDepbtxk04vsJJndb7256cxmzOgumRcO5fMCvnFiM2Tmbre4yRuGA2+3i6+4lGKKvHnm3fs3+nZrwOc/ZSbNVUmnXd+21ijaNLmPRwMPh11WzdJb1Omm9Ksefwy/y+/r720TILjvMv/u1B8Tffe7/46vfz5C///eHcOf+Za1p7c5iR9yTVuMLx4dEyjcGmabXHd3jbk9OY/cq/vOfG5sNoXsfKF//xV3Pn+a8HH+9FMKt8eyFrxlMlpO19Nh0jfp+SmWAel49X7ds8f0UjqH7cz5ucqg6Gdpzjfw/ToST5N6B1KrGC9jOV2RvVpQOtLrYGT7i/30dUjaa67ZuMX+a37e4juk0rRneffTElh6nZvWLfL8m2BFIC2moGbdqCWe3rHWRsHOU0ZnN3mN+5W70Sti+HWeVU4lP1Qp/jcAyFrD9GKnGsbnthrJe5ca++q9681MUuYg9ffcpCMIW/iN1PbsWokh68TOD28+vC2yKcaXWbT9nIHs67hTkCcfZ0n2efTEEwvVD62Ldg+ll0d/zFKMdZpKGI2L45jdlcBVNC6UPnNrRgajzcvBGKWcUsx8r/kklcSZ8xom1mY60jmPX2c/tE0JgOBVzjuE+vT00mglk1nZIljUDNQ9s0zadqWrOZfnm//Qlbrfe3u83Hr4/NxELmt/HNMly2P3IXzFjsXzD9xK1xi4tYVzDDZWMfszkKZjd0bkMLppCzk+iEPS/M8fwYaDO/fn6MtMfuvGBWNdAW3S7Vq4PtbTSeF9XELhm1YPqGEyZJF9IvWzYD8duFy7qJKe8Hsyy/vW8+uu9f1ogmr/4I9NxxlMuXD5IhQTCHRZfZjx3d9xM50d1WrCOYuY1ZBHNXNOJW9tF6zGhZk//KiMyJ5hpjRNvNDInWl4amFsxy+7NZHw/382h5bJ2WLRPzXTFawawu5LICrpLdbQq+OXUvdvV484nx26nh+AGi2weuMYWPHTrbRsjbblX459lHsheBYA5DNfaWi45S0B2zUcEsXw5zjxd5RSWnMYtg7oJ5Ibxejwstb7Zrs8kYuf7Qj/fQfVaCGb51IPGc3Xb4x+u++lKZGq1bXke7Ipv3MGFzEEywCoIJlkAwAcEEsyCYYAkEExBMMAuCCZZAMAHBBLMgmGAJBBMQTDALggmWQDABwQSzIJhgCQQTEEwwC4IJlkAwAcEEsyCYYAkEExBMMAuCCZZAMAHBBLMgmGAJBBMQTDALggmWQDABwQSzIJhgCQQTEEwwC4IJlkAwAcEEsyCYYAkEExBMMAuCCZZAMAHBBLMgmGAJBBMQTDALggmWQDABwQSzIJhgCQQTEEwwC4IJlkAwAcEEsyCYYAkEExBMMAuCCZZAMAHBBLMgmGAJBBMQTDALggmWQDABwQSzIJhgCQQTEEwwC4IJlkAwAcEEsyCYYAkEExBMMAuCCZZAMAHBBLMgmGAJBBMQTDALggmWQDABwQSzIJhgCQQTEEwwC4IJlkAwAcEEsyCYYAkEExBMMAuCCZbYQDCvijt37kBG/P6TZ8X55fQE885bB9HrAXa498vfTkYwY+cPtnjy+cUagulQYg+fnRcfPjkrPoDR8+izs3rW9LJK8kRCp/v05Kr4vTv/Dz49jV4b2C8fPjktPnl+UU3m6rzlGDo3naPOVeccuxawZ1yPUK9Qz1jUKiMOsygunbq+OH/pdryEDDh2A+DETYKuXubckubjpRvMmvw9O70qjl7Erw3snxfnalB5v/qhc9M56lxj1wD2j3qEeoV6hnpHLOYEU6FN1VuVYBg/7r9yAOTckBZF2agYy2Zx/5VMYWjqHP35xq4FGEBjcclgjAomQRAEQRDtQDAJgiAIgiAIgiCIJLGWwdRLu3fePih+9PN7AGCQN+8cFM+ePZvEW4JEUZxfXBS336InA2zDT//rbvHfv/zfsm9O8aM+OYby+Pa9/yl+/J93ozkHgH7I9+kvDqzbGnsbTBWrPkOkr3XG/jYCAOyfH7pm8MmTp+UXw1y5YjQzDfVj8eLkrHjj9i+iYwEA+vGVb71TvH3/3eL8Ul8oUm3ROcccyp/yePvtu/xtNYAtke/TX5HQXyfwc48+0ctg6rFUrGeu+WIwAezywzfuFb8//Kz8qyOXrmiZJ+UZmkDpBb+nn5/wx5IBtkQG887dd4pnp5elyVRt0TrHGcqb8qc8vonBBNga+T79ZR//18/6vgDXz2CWk5li9gfZYwcAAPvnB85g6ldp9Oe99IqT6wWYzAxDOdULCEfPMZgA2yKDqV9M0t8Q1p9FxGCON5Q35U95fPMtDCbAtsj36QdJ1n3jYk2DyTuYAJZpGUz/MVlmStmFcqpfn8JgAmxPYzAvMZgjD+UNgwmQjspg6jdyXpbzDgwmwATBYE4jMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTADAYE4kMJgA6cBg5hPKGwYTIB0YTLM8KK7diC0HSA8GcxqBwQRIBwYzn1DeMJgA6cBgGuT6w6rZvSqOi+uR9evxqDgoH2tTzoqbK4xuc7wRjg6La+V2D4qbR5H1HR7ffzD3+KsIn//gVnwbWA4GcxqBwQype+OsRyXgxmHxWI/p6NOLrt0/q3rXw0fR9SH0WXtgMPMJ5S1/g9mnPwTzzlvH5bJF/eLarUdr985d9BF6o00wmCapCyHJxMcbzHXNqi/G1ftVxdU1ot3J2/LH8wW6XnFubp5pAm0wmNMIDGZIaoPp+9HqF+Vm1BO4/gaTPmsJDGY+obxN4R3MeB8RkX64yGAGL6S9OnK9ple/210foTfaBIM5KH6Ap2bZhGbzAqgYwmD6dcvOIyS4juXjN+cYLVo/iVu0HjCYE4mpGMzZO4MJWf7KdtOT1uoxgxpM+mxqMJj5hPI2OYPpjWLZf7q9xDFnMJse0KdnVey+j9AbbYLB3DtBwS4c3OE2676F7/ddbRTbLCvGNlVxL2BZcYevgjlWF15Q1LHj6hRxeFxTKupNwGCOPw6fXZS5/ONv/Kr45u2PyklvN6ZiMPvRnYBsSrs/V72mvWxdYj2ePmsPDOZ44svf/m2Zs6/95MPi/U9P66VNKG8YTHc77Iczg/mo6QmbGMsd9xF6o00wmPuiNbD7vmrSfWW+/34VTXGsZ1KX02pYs+XdZhUW5nI2PrZOs6hY9xpNEwzm+MMbzC6h4cRghiQwmLOec1wc1JOJtSYSfkKS/B3M1dBntweDOZ7wBrOLN5zKGwbT3Y4azHTzxRkJ+wi90SYYzIGpCqGmHviNaYy8IlIzv42Kp//A7fMcm7JecbvnbzU1v71fHz+nPh95U1OIfuk8eFUpSthQJ8qffytPMYV5ZDj/4Y3fF//x819E1+dKvE/N43v0KqM46+V1H1u036x3xUzkzgwmfXYI/vSf3i2++I34Ohgnf//jD4rv/uweBlN0DWZ9f1VvHLqP0BttgsE0QjN45w2gn7j0mYS0aA3qzuP6deFjzl59Cbb1yxYWgC/KBcSK292fawix49kAfx1nDRF6wTuY449F72B69Ar+z359NOF3MJtetWiC5HvtWu9C1izbd9bfu320d9+jz1qEdzDHE4vewRRfeu3XxXfuHjr9q/I4mXcw635Q1XEPgxnbZgvS9BF6o1UwmJbwA9xRTlJmhi/+ispSysfqmMrZ8shjzpa391ldLIsazpJXj+bW17djxxvBT+S2geJvg8Ecf3QNpiZUr//GFV0QyunUPyI76x/RF9c26LU1/nHj5rTqfwe3Or9v3HtSQ5+1CAZzPBEaTG8oX5xf1Wur8Tq1j8j6+V3VsyL9oe5PYR2391nN7vsIvdEqGExz+CJINwh9QyiZK8Lg+SKTHF9IC5tJpAFVrCpux2xSJzaf2Hn8sS67ZivPZ6JgMMcfmuR2DWU3MJgeP6Fo2LbXbtRb+hpM+qxJMJjjiZ/+6rOWoeyG8jYFg9nQ7R0Ron2nmTNuU9/J+gi90SwYTBMEJk/4gvCTj+7yPtx44LatHjc6kMPCWvi4fhK2qPD8+tirPquLu2V8Fz7OasLHWVbYzTFs30hyA4M5jcBgNgJf4vrTzfD+hj1IbDRx6GUw6bNWwWDmE8rbZAzmbP6nXuD7i78fbBeat3Ifv97XuGOdeakjbR+hN1oGgzkkXcMYsHpSEhT0HKsHa79CChtNQHTy02wbFlT3eZp1QXEH1yE879a+iyZc0Wu44Pxbr04FrNkQpwAGcxoxDYO5oI+VrJpAbN5n+xrMlsGtWTwpoc9aBoOZTyhv+RvMoL/N1Wezruon3V4Yq/+g18Z6yU77CL3ROhhMGBVlA1hU+LAxGMxpxDQMJmwLfbYfGMx8QnmbhsFc9SJbOnLsI/TG/mAwAQCDOZHAYAKkA4OZTyhv+RtMgOHAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOnAYAIABnMigcEESAcGM59Q3jCYAOkYwGBWBasG/NHxRfHBk9Pid5+cOE6L/zs8AYA9ojp8/9PT4tFnZ8Xhs4vi+ZkzmJcvncHs3wyI8YRyeul68onryU8+vyj+8PS8+MDlX+OAngzQD9XKQ8eHT87cvOYcg5lBhAazmq+el/lVnumNAP3wcwnNKzS/0DxD8w3NO9IaTIcK9vzyVfG5m7gevbgsJ7Efu8KV2dSTA8D+kIh+7Gry0+cXxXE9SVqnERDjirInu//pRQT1ZDX/w2fVOIiNDwCYR/MX1cwnrm/KjLw4vypfoXetE4M50lDelD/lUflUXpVf5Zn5KkB/VDOaV2h+oXmG5huad/Ttjb0MpqIq2uqjsircMzeB1SQWAGxw5opfXLr6LJtADZFnVD25eidTjV+5j40LAFiOXjzXvEYvpJef+qhKjBhpVL2xyqfyqvzG8g4Ay9G8QvMLzTM031inN/Y2mD7KSav+BQCb6H/EZIKeDJAGIr+I5RkA1kT/WzPWNpgEQRAEQRAEQRAEMR9F8f8LOFSWczz3MAAAAABJRU5ErkJggg==" width="920" height="170" class="img_ev3q"><br> <br>当用户发起一笔交易时，首先访问交易服务，创建交易订单；然后交易服务调用支付服务为该交易创建支付订单，执行收款动作，最后支付服务调用账务服务记录账户流水和记账。</p><p>为了保证三个服务一起完成一笔交易，要么同时成功，要么同时失败，可以使用通用型 TCC 解决方案，将这三个服务放在一个分布式事务中，交易作为主业务服务，支付作为从业务服务，账务作为支付服务的嵌套从业务服务，由 TCC 模型保证事务的原子性。<br>
<img loading="lazy" alt="8.png" src="/zh-cn/assets/images/TCC8-29009ae632454b1a2c8048a7ffe74166.png" width="1102" height="348" class="img_ev3q"></p><p>支付服务的 Try 接口创建支付订单，开启嵌套分布式事务，并调用账务服务的 Try 接口；账务服务在 Try 接口中冻结买家资金。一阶段调用完成后，交易完成，提交本地事务，由 TCC 框架完成分布式事务各从业务服务二阶段的调用。</p><p>支付服务二阶段先调用账务服务的 Confirm 接口，扣除买家冻结资金；增加卖家可用资金。调用成功后，支付服务修改支付订单为完成状态，完成支付。</p><p>当支付和账务服务二阶段都调用完成后，整个分布式事务结束。</p><a name="827f0f82"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三异步确保型-tcc-解决方案">三、异步确保型 TCC 解决方案<a href="#三异步确保型-tcc-解决方案" class="hash-link" aria-label="三、异步确保型 TCC 解决方案的直接链接" title="三、异步确保型 TCC 解决方案的直接链接">​</a></h2><p>异步确保型 TCC 解决方案的直接从业务服务是可靠消息服务，而真正的从业务服务则通过消息服务解耦，作为消息服务的消费端，异步地执行。<br>
<img loading="lazy" alt="9.png" src="/zh-cn/assets/images/TCC9-2552443ebc043eeec8c4131709ce880a.png" width="1004" height="555" class="img_ev3q"><br> <br>可靠消息服务需要提供 Try，Confirm，Cancel 三个接口。Try 接口预发送，只负责持久化存储消息数据；Confirm 接口确认发送，这时才开始真正的投递消息；Cancel 接口取消发送，删除消息数据。</p><p>消息服务的消息数据独立存储，独立伸缩，降低从业务服务与消息系统间的耦合，在消息服务可靠的前提下，实现分布式事务的最终一致性。</p><p>此解决方案虽然增加了消息服务的维护成本，但由于消息服务代替从业务服务实现了 TCC 接口，从业务服务不需要任何改造，接入成本非常低。</p><a name="62b37e99-1"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="适用场景-1">适用场景<a href="#适用场景-1" class="hash-link" aria-label="适用场景的直接链接" title="适用场景的直接链接">​</a></h3><p>由于从业务服务消费消息是一个异步的过程，执行时间不确定，可能会导致不一致时间窗口增加。因此，异步确保性 TCC 分布式事务解决方案只适用于对最终一致性时间敏感度较低的一些被动型业务（从业务服务的处理结果不影响主业务服务的决策，只被动的接收主业务服务的决策结果）。比如会员注册服务和邮件发送服务：<br>
<img loading="lazy" alt="10.png" src="data:image/png;base64,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" width="613" height="199" class="img_ev3q"><br> <br>当用户注册会员成功，需要给用户发送一封邮件，告诉用户注册成功，并提示用户激活该会员。但要注意两点：</p><ol><li>如果用户注册成功，一定要给用户发送一封邮件；</li><li>如果用户注册失败，一定不能给用户发送邮件。</li></ol><p>因此，这同样需要会员服务和邮件服务保证原子性，要么都执行，要么都不执行。不一样的是，邮件服务只是一种被动型的业务，并不影响用户是否能够注册成功，它只需要在用户注册成功以后发送邮件给用户即可，邮件服务不需要参与到会员服务的活动决策中。</p><p>对于此种业务场景，可以使用异步确保型TCC分布式事务解决方案，如下：<br>
<img loading="lazy" alt="11.png" src="/zh-cn/assets/images/TCC11-7a885661dbcb087ae8b687c2a12a070f.png" width="1050" height="342" class="img_ev3q"><br> <br> <br>由可靠消息服务来解耦会员和邮件服务，会员服务与消息服务组成 TCC 事务模型，保证事务原子性。然后通过消息服务的可靠特性，确保消息一定能够被邮件服务消费，从而使得会员与邮件服务在同一个分布式事务中。同时，邮件服务也不会影响会员服务的执行过程，只在会员服务执行成功后被动接收发送邮件的请求。</p><a name="69910d05"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四补偿型-tcc-解决方案">四、补偿型 TCC 解决方案<a href="#四补偿型-tcc-解决方案" class="hash-link" aria-label="四、补偿型 TCC 解决方案的直接链接" title="四、补偿型 TCC 解决方案的直接链接">​</a></h2><p>补偿型 TCC 解决方案与通用型 TCC 解决方案的结构相似，其从业务服务也需要参与到主业务服务的活动决策当中。但不一样的是，前者的从业务服务只需要提供 Do 和 Compensate 两个接口，而后者需要提供三个接口。<br>
<img loading="lazy" alt="12.png" src="/zh-cn/assets/images/TCC12-a0d59ce31dd8be48cba507fe17290b93.png" width="654" height="554" class="img_ev3q"><br> <br>Do 接口直接执行真正的完整业务逻辑，完成业务处理，业务执行结果外部可见；Compensate 操作用于业务补偿，抵消或部分抵消正向业务操作的业务结果，Compensate操作需满足幂等性。<br>与通用型解决方案相比，补偿型解决方案的从业务服务不需要改造原有业务逻辑，只需要额外增加一个补偿回滚逻辑即可，业务改造量较小。但要注意的是，业务在一阶段就执行完整个业务逻辑，无法做到有效的事务隔离，当需要回滚时，可能存在补偿失败的情况，还需要额外的异常处理机制，比如人工介入。</p><a name="62b37e99-2"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="适用场景-2">适用场景<a href="#适用场景-2" class="hash-link" aria-label="适用场景的直接链接" title="适用场景的直接链接">​</a></h3><p>由于存在回滚补偿失败的情况，补偿型 TCC 分布式事务解决方案只适用于一些并发冲突较少或者需要与外部交互的业务，这些外部业务不属于被动型业务，其执行结果会影响主业务服务的决策，比如机票代理商的机票预订服务：<br>
<img loading="lazy" alt="13.png" src="/zh-cn/assets/images/TCC13-5ae384dd97cb075f35297395f95c1c5c.png" width="960" height="501" class="img_ev3q"><br> <br>该机票服务提供多程机票预订服务，可以同时预订多趟行程航班机票，比如从北京到圣彼得堡，需要第一程从北京到莫斯科，以及第二程从莫斯科到圣彼得堡。</p><p>当用户预订机票时，肯定希望能同时预订这两趟航班的机票，只预订一趟航班对用户来说没有意义。因此，对于这样的业务服务同样提出了原子性要求，如果其中一趟航班的机票预订失败，另外一趟需要能够取消预订。</p><p>但是，由于航空公司相对于机票代理商来说属于外部业务，只提供订票接口和取消预订接口，想要推动航空公司改造是极其困难的。因此，对于此类业务服务，可以使用补偿型 TCC 分布式事务解决方案，如下：<br>
<img loading="lazy" alt="14.png" src="/zh-cn/assets/images/TCC14-fc2e32a764cde16ce3573ffe65211c7b.png" width="1064" height="587" class="img_ev3q"></p><p>网关服务在原有逻辑基础上增加 Compensate 接口，负责调用对应航空公司的取消预订接口。</p><p>在用户发起机票预订请求时，机票服务先通过网关 Do 接口，调用各航空公司的预订接口，如果所有航班都预订成功，则整个分布式事务直接执行成功；一旦某趟航班机票预订失败，则分布式事务回滚，由 TCC 事务框架调用各网关的 Compensate 补偿接口，其再调用对应航空公司的取消预订接口。通过这种方式，也可以保证多程机票预订服务的原子性。</p><a name="acfe75a0"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五-总结">五. 总结<a href="#五-总结" class="hash-link" aria-label="五. 总结的直接链接" title="五. 总结的直接链接">​</a></h2><p>对于现在的互联网应用来说，资源横向扩展提供了更多的灵活性，是一种比较容易实现的向外扩展方案，但是同时也明显增加了复杂度，引入一些新的挑战，比如资源之间的数据一致性问题。</p><p>横向数据扩展既可以按数据分片扩展，也可以按功能扩展。TCC 模型能在功能横向扩展资源的同时，保证多资源访问的事务属性。</p><p>TCC 模型除了跨服务的分布式事务这一层作用之外，还具有两阶段划分的功能，通过业务资源锁定，允许第二阶段的异步执行，而异步化思想正是解决热点数据并发性能问题的利器之一。<br> </p><a name="Roadmap"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="roadmap">Roadmap<a href="#roadmap" class="hash-link" aria-label="Roadmap的直接链接" title="Roadmap的直接链接">​</a></h2><p>当前已经发布到 0.4.0，后续我们会发布 0.5 ~ 1.0 版本，继续对 AT、TCC 模式进行功能完善和和丰富，并解决服务端高可用问题，在 1.0 版本之后，本开源产品将达到生产环境使用的标准。<br><br><br><img loading="lazy" alt="图片1.png" src="/zh-cn/assets/images/roadmap-30821aa2e9d0cc93e4697af4cd6a2393.png" width="1680" height="652" class="img_ev3q"><br></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-03-26T00:00:00.000Z" itemprop="datePublished">2019年3月26日</time> · <!-- -->阅读需 9 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">zhangthen</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Fescar 0.4.0 版本发布了 TCC 模式，由蚂蚁金服团队贡献，欢迎大家试用，<br>Sample 地址：<a href="https://github.com/fescar-group/fescar-samples/tree/master/tcc" target="_blank" rel="noopener noreferrer">https://github.com/fescar-group/fescar-samples/tree/master/tcc</a>，<br>文末也提供了项目后续的 Roadmap，欢迎关注。</p><a name="f1d2fc6a"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="一tcc-简介">一、TCC 简介<a href="#一tcc-简介" class="hash-link" aria-label="一、TCC 简介的直接链接" title="一、TCC 简介的直接链接">​</a></h3><p>在两阶段提交协议（2PC，Two Phase Commitment Protocol）中，资源管理器（RM, resource manager）需要提供“准备”、“提交”和“回滚” 3 个操作；而事务管理器（TM, transaction manager）分 2 阶段协调所有资源管理器，在第一阶段询问所有资源管理器“准备”是否成功，如果所有资源均“准备”成功则在第二阶段执行所有资源的“提交”操作，否则在第二阶段执行所有资源的“回滚”操作，保证所有资源的最终状态是一致的，要么全部提交要么全部回滚。</p><p>资源管理器有很多实现方式，其中 TCC（Try-Confirm-Cancel）是资源管理器的一种服务化的实现；TCC 是一种比较成熟的分布式事务解决方案，可用于解决跨数据库、跨服务业务操作的数据一致性问题；TCC 其 Try、Confirm、Cancel 3 个方法均由业务编码实现，故 TCC 可以被称为是服务化的资源管理器。</p><p>TCC 的 Try 操作作为一阶段，负责资源的检查和预留；Confirm 操作作为二阶段提交操作，执行真正的业务；Cancel 是二阶段回滚操作，执行预留资源的取消，使资源回到初始状态。</p><p>如下图所示，用户实现 TCC 服务之后，该 TCC 服务将作为分布式事务的其中一个资源，参与到整个分布式事务中；事务管理器分 2 阶段协调 TCC 服务，在第一阶段调用所有 TCC 服务的 Try 方法，在第二阶段执行所有 TCC 服务的 Confirm 或者 Cancel 方法；最终所有 TCC 服务要么全部都是提交的，要么全部都是回滚的。</p><p><img loading="lazy" alt="image.png" src="/zh-cn/assets/images/tcc-2324b37c207fcf8b371402eb4bc5df43.png" width="1110" height="668" class="img_ev3q"></p><a name="48153343"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="二tcc-设计">二、TCC 设计<a href="#二tcc-设计" class="hash-link" aria-label="二、TCC 设计的直接链接" title="二、TCC 设计的直接链接">​</a></h3><p>用户在接入 TCC 时，大部分工作都集中在如何实现 TCC 服务上，经过蚂蚁金服多年的 TCC 应用，总结如下主要的TCC 设计和实现主要事项：</p><a name="4226dc7c"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1业务操作分两阶段完成">1、<strong>业务操作分两阶段完成</strong><a href="#1业务操作分两阶段完成" class="hash-link" aria-label="1业务操作分两阶段完成的直接链接" title="1业务操作分两阶段完成的直接链接">​</a></h4><p>接入 TCC 前，业务操作只需要一步就能完成，但是在接入 TCC 之后，需要考虑如何将其分成 2 阶段完成，把资源的检查和预留放在一阶段的 Try 操作中进行，把真正的业务操作的执行放在二阶段的 Confirm 操作中进行。</p><p>以下举例说明业务模式如何分成两阶段进行设计，举例场景：“账户A的余额中有 100 元，需要扣除其中 30 元”；</p><p>在接入 TCC 之前，用户编写 SQL：“update 账户表 set 余额 = 余额 - 30 where 账户 = A”，便能一步完成扣款操作。</p><p>在接入 TCC 之后，就需要考虑如何将扣款操作分成 2 步完成：</p><ul><li>Try 操作：资源的检查和预留；</li></ul><p>在扣款场景，Try 操作要做的事情就是先检查 A 账户余额是否足够，再冻结要扣款的 30 元（预留资源）；此阶段不会发生真正的扣款。</p><ul><li>Confirm 操作：执行真正业务的提交；</li></ul><p>在扣款场景下，Confirm 阶段走的事情就是发生真正的扣款，把A账户中已经冻结的 30 元钱扣掉。</p><ul><li>Cancel 操作：预留资源的是否释放；</li></ul><p>在扣款场景下，扣款取消，Cancel 操作执行的任务是释放 Try 操作冻结的 30 元钱，是 A 账户回到初始状态。</p><p><img loading="lazy" alt="image.png" src="/zh-cn/assets/images/tow_step-cfda16e094be75a90cd5a366f1f731a9.png" width="744" height="302" class="img_ev3q"></p><a name="bce861f1"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2并发控制">2、<strong>并发控制</strong><a href="#2并发控制" class="hash-link" aria-label="2并发控制的直接链接" title="2并发控制的直接链接">​</a></h4><p>用户在实现 TCC 时，应当考虑并发性问题，将锁的粒度降到最低，以最大限度的提高分布式事务的并发性。</p><p>以下还是以A账户扣款为例，“账户 A 上有 100 元，事务 T1 要扣除其中的 30 元，事务 T2 也要扣除 30 元，出现并发”。</p><p>在一阶段 Try 操作中，分布式事务 T1 和分布式事务 T2 分别冻结资金的那一部分资金，相互之间无干扰；这样在分布式事务的二阶段，无论 T1 是提交还是回滚，都不会对 T2 产生影响，这样 T1 和 T2 在同一笔业务数据上并行执行。</p><p><img loading="lazy" alt="image.png" src="/zh-cn/assets/images/conc-3fbb097a571ca78f9e463786b01dca57.png" width="738" height="302" class="img_ev3q"> <br></p><a name="e945e352"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3允许空回滚">3、<strong>允许空回滚</strong><a href="#3允许空回滚" class="hash-link" aria-label="3允许空回滚的直接链接" title="3允许空回滚的直接链接">​</a></h4><p>如下图所示，事务协调器在调用 TCC 服务的一阶段 Try 操作时，可能会出现因为丢包而导致的网络超时，此时事务管理器会触发二阶段回滚，调用 TCC 服务的 Cancel 操作，而 Cancel 操作调用未出现超时。</p><p>TCC 服务在未收到 Try 请求的情况下收到 Cancel 请求，这种场景被称为空回滚；空回滚在生产环境经常出现，用户在实现TCC服务时，应允许允许空回滚的执行，即收到空回滚时返回成功。</p><p><img loading="lazy" alt="image.png" src="/zh-cn/assets/images/empty_rollback-e06a0b70a6ab6a896c0bb67ace87b751.png" width="1404" height="858" class="img_ev3q"></p><a name="e02f3ee9"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4防悬挂控制">4、防悬挂控制<a href="#4防悬挂控制" class="hash-link" aria-label="4、防悬挂控制的直接链接" title="4、防悬挂控制的直接链接">​</a></h4><p>如下图所示，事务协调器在调用 TCC 服务的一阶段 Try 操作时，可能会出现因网络拥堵而导致的超时，此时事务管理器会触发二阶段回滚，调用 TCC 服务的 Cancel 操作，Cancel 调用未超时；在此之后，拥堵在网络上的一阶段 Try 数据包被 TCC 服务收到，出现了二阶段 Cancel 请求比一阶段 Try 请求先执行的情况，此 TCC 服务在执行晚到的 Try 之后，将永远不会再收到二阶段的 Confirm 或者 Cancel ，造成 TCC 服务悬挂。</p><p>用户在实现  TCC 服务时，要允许空回滚，但是要拒绝执行空回滚之后 Try 请求，要避免出现悬挂。</p><p><img loading="lazy" alt="image.png" src="/zh-cn/assets/images/susp-3a5ed6577950c1034caca1d822a7aa80.png" width="1438" height="842" class="img_ev3q"></p><a name="5322a3d5"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5幂等控制">5、幂等控制<a href="#5幂等控制" class="hash-link" aria-label="5、幂等控制的直接链接" title="5、幂等控制的直接链接">​</a></h4><p>无论是网络数据包重传，还是异常事务的补偿执行，都会导致 TCC 服务的 Try、Confirm 或者 Cancel 操作被重复执行；用户在实现 TCC 服务时，需要考虑幂等控制，即 Try、Confirm、Cancel 执行一次和执行多次的业务结果是一样的。<br><img loading="lazy" alt="image.png" src="/zh-cn/assets/images/miden-c277a00ed0d40b3eed4f6648bcc27a75.png" width="469" height="275" class="img_ev3q"><br><br></p><a name="Roadmap"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="roadmap">Roadmap<a href="#roadmap" class="hash-link" aria-label="Roadmap的直接链接" title="Roadmap的直接链接">​</a></h3><p>当前已经发布到 0.4.0 版本，后续我们会发布 0.5 ~ 1.0 版本，继续对 AT、TCC 模式进行功能完善和和丰富，并解决服务端高可用问题，在 1.0 版本之后，本开源产品将达到生产环境使用的标准。</p><p><img loading="lazy" alt="图片1.png" src="/zh-cn/assets/images/roadmap-30821aa2e9d0cc93e4697af4cd6a2393.png" width="1680" height="652" class="img_ev3q"></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/quick-start-use-seata-and-dubbo-services">如何使用Seata保证Dubbo微服务间的一致性</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-03-07T00:00:00.000Z" itemprop="datePublished">2019年3月7日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">slievrly</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="案例">案例<a href="#案例" class="hash-link" aria-label="案例的直接链接" title="案例的直接链接">​</a></h2><p>用户采购商品业务，整个业务包含3个微服务:</p><ul><li>库存服务: 扣减给定商品的库存数量。</li><li>订单服务: 根据采购请求生成订单。</li><li>账户服务: 用户账户金额扣减。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="业务结构图">业务结构图<a href="#业务结构图" class="hash-link" aria-label="业务结构图的直接链接" title="业务结构图的直接链接">​</a></h3><p><img loading="lazy" alt="Architecture" src="/zh-cn/assets/images/seata-1-921f8d579a15d413c12f3542be7f5ffb.png" width="1468" height="868" class="img_ev3q"> </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="storageservice">StorageService<a href="#storageservice" class="hash-link" aria-label="StorageService的直接链接" title="StorageService的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * deduct storage count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void deduct(String commodityCode, int count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="orderservice">OrderService<a href="#orderservice" class="hash-link" aria-label="OrderService的直接链接" title="OrderService的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface OrderService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * create order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Order create(String userId, String commodityCode, int orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="accountservice">AccountService<a href="#accountservice" class="hash-link" aria-label="AccountService的直接链接" title="AccountService的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface AccountService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * debit balance of user&#x27;s account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void debit(String userId, int money);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要的业务逻辑">主要的业务逻辑：<a href="#主要的业务逻辑" class="hash-link" aria-label="主要的业务逻辑：的直接链接" title="主要的业务逻辑：的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class BusinessServiceImpl implements BusinessService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private StorageService storageService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private OrderService orderService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * purchase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void purchase(String userId, String commodityCode, int orderCount) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageService.deduct(commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderService.create(userId, commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class StorageServiceImpl implements StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private StorageDAO storageDAO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void deduct(String commodityCode, int count) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Storage storage = new Storage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storage.setCount(count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storage.setCommodityCode(commodityCode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageDAO.update(storage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderServiceImpl implements OrderService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private OrderDAO orderDAO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private AccountService accountService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Order create(String userId, String commodityCode, int orderCount) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int orderMoney = calculate(commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        accountService.debit(userId, orderMoney);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Order order = new Order();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order.userId = userId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order.commodityCode = commodityCode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order.count = orderCount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order.money = orderMoney;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return orderDAO.insert(order);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata-分布式事务解决方案">Seata 分布式事务解决方案<a href="#seata-分布式事务解决方案" class="hash-link" aria-label="Seata 分布式事务解决方案的直接链接" title="Seata 分布式事务解决方案的直接链接">​</a></h2><p><img loading="lazy" alt="undefined" src="/zh-cn/assets/images/seata-2-3e4981c059d8c4d72aec440b06c30a65.png" width="1490" height="852" class="img_ev3q"> </p><p>此处仅仅需要一行注解 <code>@GlobalTransactional</code> 写在业务发起方的方法上: </p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void purchase(String userId, String commodityCode, int orderCount) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dubbo-与-seata-结合的例子">Dubbo 与 Seata 结合的例子<a href="#dubbo-与-seata-结合的例子" class="hash-link" aria-label="Dubbo 与 Seata 结合的例子的直接链接" title="Dubbo 与 Seata 结合的例子的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-安装数据库">Step 1: 安装数据库<a href="#step-1-安装数据库" class="hash-link" aria-label="Step 1: 安装数据库的直接链接" title="Step 1: 安装数据库的直接链接">​</a></h3><ul><li>要求: MySQL (InnoDB 存储引擎)。</li></ul><p><strong>提示:</strong> 事实上例子中3个微服务需要3个独立的数据库，但为了方便我们使用同一物理库并配置3个逻辑连接串。 </p><p>更改以下xml文件中的数据库url、username和password</p><p>dubbo-account-service.xml
dubbo-order-service.xml
dubbo-storage-service.xml</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">url</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">jdbc:mysql://x.x.x.x:3306/xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">username</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">password</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-为-seata-创建-undo_log-表">Step 2: 为 Seata 创建 UNDO_LOG 表<a href="#step-2-为-seata-创建-undo_log-表" class="hash-link" aria-label="Step 2: 为 Seata 创建 UNDO_LOG 表的直接链接" title="Step 2: 为 Seata 创建 UNDO_LOG 表的直接链接">​</a></h3><p><code>UNDO_LOG</code> 此表用于 Seata 的AT模式。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">undo_log</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">rollback_info</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">longblob</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_status</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_created</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">datetime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_modified</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">datetime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">ext</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">idx_unionkey</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">159</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-创建相关业务表">Step 3: 创建相关业务表<a href="#step-3-创建相关业务表" class="hash-link" aria-label="Step 3: 创建相关业务表的直接链接" title="Step 3: 创建相关业务表的直接链接">​</a></h3><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">storage_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">storage_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">commodity_code</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">count</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">UNIQUE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">commodity_code</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">order_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">order_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">commodity_code</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">count</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">money</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">account_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">account_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">money</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-启动-seata-server-服务">Step 4: 启动 Seata-Server 服务<a href="#step-4-启动-seata-server-服务" class="hash-link" aria-label="Step 4: 启动 Seata-Server 服务的直接链接" title="Step 4: 启动 Seata-Server 服务的直接链接">​</a></h3><ul><li>下载Server <a href="https://github.com/seata/seata/releases" target="_blank" rel="noopener noreferrer">package</a>, 并解压。</li><li>运行bin目录下的启动脚本。</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> seata-server.sh </span><span class="token variable" style="color:#36acaa">$LISTEN_PORT</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$PATH_FOR_PERSISTENT_DATA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e.g.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> seata-server.sh </span><span class="token number" style="color:#36acaa">8091</span><span class="token plain"> /home/admin/seata/data/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-5-运行例子">Step 5: 运行例子<a href="#step-5-运行例子" class="hash-link" aria-label="Step 5: 运行例子的直接链接" title="Step 5: 运行例子的直接链接">​</a></h3><ul><li>启动账户服务 (<a href="https://github.com/seata/seata-samples/blob/master/dubbo/src/main/java/com/seata/seata/samples/dubbo/starter/DubboAccountServiceStarter.java" target="_blank" rel="noopener noreferrer">DubboAccountServiceStarter</a>)。</li><li>启动库存服务 (<a href="https://github.com/seata/seata-samples/blob/master/dubbo/src/main/java/com/seata/seata/samples/dubbo/starter/DubboStorageServiceStarter.java" target="_blank" rel="noopener noreferrer">DubboStorageServiceStarter</a>)。</li><li>启动订单服务 (<a href="https://github.com/seata/seata-samples/blob/master/dubbo/src/main/java/com/seata/seata/samples/dubbo/starter/DubboOrderServiceStarter.java" target="_blank" rel="noopener noreferrer">DubboOrderServiceStarter</a>)。</li><li>运行BusinessService入口 (<a href="https://github.com/seata/seata-samples/blob/master/dubbo/src/main/java/com/seata/seata/samples/dubbo/starter/DubboBusinessTester.java" target="_blank" rel="noopener noreferrer">DubboBusinessTester</a>)。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="相关项目">相关项目<a href="#相关项目" class="hash-link" aria-label="相关项目的直接链接" title="相关项目的直接链接">​</a></h3><ul><li>seata:          <a href="https://github.com/seata/seata/" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata/</a></li><li>seata-samples : <a href="https://github.com/seata/seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/seata/seata-samples</a></li></ul></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-02-18T00:00:00.000Z" itemprop="datePublished">2019年2月18日</time> · <!-- -->阅读需 23 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">陈凯玲</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>fescar发布已有时日，分布式事务一直是业界备受关注的领域，fescar发布一个月左右便受到了近5000个star足以说明其热度。当然，在fescar出来之前，
已经有比较成熟的分布式事务的解决方案开源了，比较典型的方案如 <a href="https://github.com/codingapi/tx-lcn" target="_blank" rel="noopener noreferrer">LCN</a> 的2pc型无侵入事务，
目前lcn已发展到5.0，已支持和fescar事务模型类似的TCX型事务。还有如TCC型事务实现 <a href="https://github.com/yu199195/hmily" target="_blank" rel="noopener noreferrer">hmily</a> <a href="https://github.com/changmingxie/tcc-transaction" target="_blank" rel="noopener noreferrer">tcc-transaction</a> 等。
在微服务架构流行的当下、阿里这种开源大户背景下，fescar的发布无疑又掀起了研究分布式事务的热潮。fescar脱胎于阿里云商业分布式事务服务GTS，在线上环境提供这种公共服务其模式肯定经受了非常严苛的考验。其分布式事务模型TXC又仿于传统事务模型XA方案，主要区别在于资源管理器的定位一个在应用层一个在数据库层。博主觉得fescar的txc模型实现非常有研究的价值，所以今天我们来好好翻一翻fescar项目的代码。本文篇幅较长，浏览并理解本文大概耗时30~60分钟左右。</p><h1>项目地址</h1><p>fescar：<a href="https://github.com/alibaba/fescar" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/fescar</a></p><p>本博文所述代码为fescar的0.1.2-SNAPSHOT版本，根据fescar后期的迭代计划，其项目结构和模块实现都可能有很大的改变，特此说明。</p><h1>fescar的TXC模型</h1><p><img loading="lazy" src="/zh-cn/assets/images/c45496461bca15ecd522e497d98ba954f95-4483e7e2aab41db92fd1ee606abf0cf5.jpg" width="764" height="416" class="img_ev3q"></p><p>上图为fescar官方针对TXC模型制作的示意图。不得不说大厂的图制作的真的不错，结合示意图我们可以看到TXC实现的全貌。TXC的实现通过三个组件来完成。也就是上图的三个深黄色部分，其作用如下：</p><ol><li>TM：全局事务管理器，在标注开启fescar分布式事务的服务端开启，并将全局事务发送到TC事务控制端管理</li><li>TC：事务控制中心，控制全局事务的提交或者回滚。这个组件需要独立部署维护，目前只支持单机版本，后续迭代计划会有集群版本</li><li>RM：资源管理器，主要负责分支事务的上报，本地事务的管理</li></ol><p>一段话简述其实现过程：服务起始方发起全局事务并注册到TC。在调用协同服务时，协同服务的事务分支事务会先完成阶段一的事务提交或回滚，并生成事务回滚的undo_log日志，同时注册当前协同服务到TC并上报其事务状态，归并到同一个业务的全局事务中。此时若没有问题继续下一个协同服务的调用，期间任何协同服务的分支事务回滚，都会通知到TC，TC在通知全局事务包含的所有已完成一阶段提交的分支事务回滚。如果所有分支事务都正常，最后回到全局事务发起方时，也会通知到TC，TC在通知全局事务包含的所有分支删除回滚日志。在这个过程中为了解决写隔离和度隔离的问题会涉及到TC管理的全局锁。</p><p>本博文的目标是深入代码细节，探究其基本思路是如何实现的。首先会从项目的结构来简述每个模块的作用，继而结合官方自带的examples实例来探究整个分布式事务的实现过程。</p><h1>项目结构解析</h1><p>项目拉下来，用IDE打开后的目录结构如下，下面先大致的看下每个模块的实现</p><p><img loading="lazy" src="/zh-cn/assets/images/a88cf147f489f913886ef1785d94183bf09-675292f77733fca39c09b525924847ad.jpg" width="705" height="363" class="img_ev3q"></p><ul><li>common ：公共组件，提供常用辅助类，静态变量、扩展机制类加载器、以及定义全局的异常等</li><li>config : 配置加载解析模块，提供了配置的基础接口，目前只有文件配置实现，后续会有nacos等配置中心的实现</li><li>core : 核心模块主要封装了TM、RM和TC通讯用RPC相关内容</li><li>dubbo ：dubbo模块主要适配dubbo通讯框架，使用dubbo的filter机制来传统全局事务的信息到分支</li><li>examples ：简单的演示实例模块，等下从这个模块入手探索</li><li>rm-datasource :资源管理模块，比较核心的一个模块，个人认为这个模块命名为core要更合理一点。代理了JDBC的一些类，用来解析sql生成回滚日志、协调管理本地事务</li><li>server : TC组件所在，主要协调管理全局事务，负责全局事务的提交或者回滚，同时管理维护全局锁。</li><li>spring ：和spring集成的模块，主要是aop逻辑，是整个分布式事务的入口，研究fescar的突破口</li><li>tm : 全局事务事务管理模块，管理全局事务的边界，全局事务开启回滚点都在这个模块控制</li></ul><h1>通过【examples】模块的实例看下效果</h1><p>第一步、先启动TC也就是【Server】模块，main方法直接启动就好，默认服务端口8091</p><p>第二步、回到examples模块，将订单，业务，账户、仓库四个服务的配置文件配置好，主要是mysql数据源和zookeeper连接地址，这里要注意下，默认dubbo的zk注册中心依赖没有，启动的时候回抛找不到class的异常，需要添加如下的依赖：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.101tec</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">zkclient</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">0.10</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">exclusions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">exclusion</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">slf4j-log4j12</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.slf4j</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">exclusion</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">exclusions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第三步、在BusinessServiceImpl中的模拟抛异常的地方打个断点，依次启动OrderServiceImpl、StorageServiceImpl、AccountServiceImpl、BusinessServiceImpl四个服务、等进断点后，查看数据库account<!-- -->_<!-- -->tbl表，金额已减去400元，变成了599元。然后放开断点、BusinessServiceImpl模块模拟的异常触发，全局事务回滚，account<!-- -->_<!-- -->tbl表的金额就又回滚到999元了</p><p>如上，我们已经体验到fescar事务的控制能力了，下面我们具体看下它是怎么控制的。</p><h1>fescar事务过程分析</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="首先分析配置文件">首先分析配置文件<a href="#首先分析配置文件" class="hash-link" aria-label="首先分析配置文件的直接链接" title="首先分析配置文件的直接链接">​</a></h2><p>这个是一个铁律，任何一个技术或框架要集成，配置文件肯定是一个突破口。从上面的例子我们了解到，实例模块的配置文件中配置了一个全局事务扫描器实例，如：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">bean</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">com.alibaba.fescar.spring.annotation.GlobalTransactionScanner</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">constructor-arg</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">dubbo-demo-app</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">constructor-arg</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">my\_test\_tx_group</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">bean</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个实例在项目启动时会扫描所有实例，具体实现见【spring】模块。并将标注了@GlobalTransactional注解的方法织入GlobalTransactionalInterceptor的invoke方法逻辑。同时应用启动时，会初始化TM（TmRpcClient）和RM（RmRpcClient）的实例，这个时候，服务已经和TC事务控制中心勾搭上了。在往下看就涉及到TM模块的事务模板类TransactionalTemplate。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tm模块启动全局事务">【TM】模块启动全局事务<a href="#tm模块启动全局事务" class="hash-link" aria-label="【TM】模块启动全局事务的直接链接" title="【TM】模块启动全局事务的直接链接">​</a></h2><p>全局事务的开启，提交、回滚都被封装在TransactionalTemplate中完成了，代码如：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object execute(TransactionalExecutor business) throws TransactionalExecutor.ExecutionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. get or create a transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. begin transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tx.begin(business.timeout(), business.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TransactionalExecutor.Code.BeginFailure);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Do Your Business</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rs = business.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. any business exception, rollback.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3.1 Successfully rolled back</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new TransactionalExecutor.ExecutionException(tx, TransactionalExecutor.Code.RollbackDone, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3.2 Failed to rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TransactionalExecutor.Code.RollbackFailure, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 4. everything is fine, commit.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.1 Failed to commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TransactionalExecutor.Code.CommitFailure);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>更详细的实现在【TM】模块中被分成了两个Class实现，如下：</p><p>DefaultGlobalTransaction ：全局事务具体的开启，提交、回滚动作</p><p>DefaultTransactionManager ：负责使用TmRpcClient向TC控制中心发送指令，如开启全局事务（GlobalBeginRequest）、提交（GlobalCommitRequest）、回滚（GlobalRollbackRequest）、查询状态（GlobalStatusRequest）等。</p><p>以上是TM模块核心内容点，TM模块完成全局事务开启后，接下来就开始看看全局事务iD，xid是如何传递、RM组件是如何介入的</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dubbo全局事务xid的传递">【dubbo】全局事务xid的传递<a href="#dubbo全局事务xid的传递" class="hash-link" aria-label="【dubbo】全局事务xid的传递的直接链接" title="【dubbo】全局事务xid的传递的直接链接">​</a></h2><p>首先是xid的传递，目前已经实现了dubbo框架实现的微服务架构下的传递，其他的像spring cloud和motan等的想要实现也很容易，通过一般RPC通讯框架都有的filter机制，将xid从全局事务的发起节点传递到服务协从节点，从节点接收到后绑定到当前线程上线文环境中，用于在分支事务执行sql时判断是否加入全局事务。fescar的实现见【dubbo】模块如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Activate(group = { Constants.PROVIDER, Constants.CONSUMER }, order = 100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TransactionPropagationFilter implements Filter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(TransactionPropagationFilter.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Result invoke(Invoker&lt;?&gt; invoker, Invocation invocation) throws RpcException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = RpcContext.getContext().getAttachment(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug(&quot;xid in RootContext\[&quot; + xid + &quot;\] xid in RpcContext\[&quot; + rpcXid + &quot;\]&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean bind = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (rpcXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                bind = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.debug(&quot;bind\[&quot; + rpcXid + &quot;\] to RootContext&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return invoker.invoke(invocation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (bind) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String unbindXid = RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.debug(&quot;unbind\[&quot; + unbindXid + &quot;\] from RootContext&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!rpcXid.equalsIgnoreCase(unbindXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.warn(&quot;xid in change during RPC from &quot; + rpcXid + &quot; to &quot; + unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (unbindXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        RootContext.bind(unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOGGER.warn(&quot;bind \[&quot; + unbindXid + &quot;\] back to RootContext&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面代码rpcXid不为空时，就加入到了RootContext的ContextCore中，这里稍微深入讲下。ContextCore是一个可扩展实现的接口，目前默认的实现是ThreadLocalContextCore，基于ThreadLocal来保存维护当前的xid。这里fescar提供了可扩展的机制，实现在【common】模块中，通过一个自定义的类加载器EnhancedServiceLoader加载需要扩展的服务类，这样只需要在扩展类加上@LoadLevel注解。标记order属性声明高优先级别，就可以达到扩展实现的目的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rm模块本地资源管理的介入">【RM】模块本地资源管理的介入<a href="#rm模块本地资源管理的介入" class="hash-link" aria-label="【RM】模块本地资源管理的介入的直接链接" title="【RM】模块本地资源管理的介入的直接链接">​</a></h2><p>fescar针对本地事务相关的接口，通过代理机制都实现了一遍代理类，如数据源（DataSourceProxy）、ConnectionProxy、StatementProxy等。这个在配置文件中也可以看出来，也就是说，我们要使用fescar分布式事务，一定要配置fescar提供的代理数据源。如：</p><p><img loading="lazy" src="/zh-cn/assets/images/af317255c71a5c1bf46f7140387acf365f8-89383a2f18f6ee0c38517552ef7c838b.jpg" width="960" height="382" class="img_ev3q"></p><p>配置好代理数据源后，从DataSourceProxy出发，本地针对数据库的所有操作过程我们就可以随意控制了。从上面xid传递，已经知道了xid被保存在RootContext中了，那么请看下面的代码，就非常清楚了：</p><p>首先看StatementProxy的一段代码</p><p><img loading="lazy" src="/zh-cn/assets/images/17896deea47b9aee518812b039c39101d8f-17aee47c7b0181e494847cd605377176.jpg" width="916" height="512" class="img_ev3q"></p><p>在看ExecuteTemplate中的代码</p><p><img loading="lazy" src="/zh-cn/assets/images/04488a2745a5d564498462ed64c506174d2-f982f1865728c70f4e9dc802a6f70c54.jpg" width="960" height="625" class="img_ev3q"></p><p>和【TM】模块中的事务管理模板类TransactionlTemplate类似，这里非常关键的逻辑代理也被封装在了ExecuteTemplate模板类中。因重写了Statement有了StatementProxy实现，在执行原JDBC的executeUpdate方法时，会调用到ExecuteTemplate的execute逻辑。在sql真正执行前，会判断RootCOntext当前上下文中是否包含xid，也就是判断当前是否是全局分布式事务。如果不是，就直接使用本地事务，如果是，这里RM就会增加一些分布式事务相关的逻辑了。这里根据sql的不同的类型，fescar封装了五个不同的执行器来处理，分别是UpdateExecutor、DeleteExecutor、InsertExecutor、SelectForUpdateExecutor、PlainExecutor，结构如下图：</p><p><img loading="lazy" src="/zh-cn/assets/images/bb9a2f07054f19bc21adc332671de4f7b75-0b10f570ec26e2246b4d02e607fb42f9.jpg" width="945" height="419" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="plainexecutor">PlainExecutor：<a href="#plainexecutor" class="hash-link" aria-label="PlainExecutor：的直接链接" title="PlainExecutor：的直接链接">​</a></h3><p>原生的JDBC接口实现，未做任何处理，提供给全局事务中的普通的select查询使用</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="updateexecutordeleteexecutorinsertexecutor">UpdateExecutor、DeleteExecutor、InsertExecutor：<a href="#updateexecutordeleteexecutorinsertexecutor" class="hash-link" aria-label="UpdateExecutor、DeleteExecutor、InsertExecutor：的直接链接" title="UpdateExecutor、DeleteExecutor、InsertExecutor：的直接链接">​</a></h3><p>三个DML增删改执行器实现，主要在sql执行的前后对sql语句进行了解析，实现了如下两个抽象接口方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected abstract TableRecords beforeImage() throws SQLException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected abstract TableRecords afterImage(TableRecords beforeImage) throws SQLException;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在这个过程中通过解析sql生成了提供回滚操作的undo_log日志，日志目前是保存在msyql中的，和业务sql操作共用同一个事务。表的结构如下：</p><p><img loading="lazy" src="/zh-cn/assets/images/fd5c423815d3b84bdbc70d7efeb9cd16757-8fed493519894148d20b0102af49138a.jpg" width="731" height="332" class="img_ev3q"></p><p>rollback<!-- -->_<!-- -->info保存的undo<!-- -->_<!-- -->log详细信息，是longblob类型的，结构如下：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;branchId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3958194</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;sqlUndoLogs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;afterImage&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;rows&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token property" style="color:#36acaa">&quot;fields&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;keyType&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;PrimaryKey&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;ID&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;keyType&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;NULL&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;COUNT&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">98</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;tableName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;storage_tbl&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;beforeImage&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;rows&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token property" style="color:#36acaa">&quot;fields&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;keyType&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;PrimaryKey&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;ID&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;keyType&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;NULL&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;COUNT&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;tableName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;storage_tbl&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;sqlType&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;UPDATE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;tableName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;storage_tbl&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;xid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;192.168.7.77:8091:3958193&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里贴的是一个update的操作，undo<!-- -->_<!-- -->log记录的非常的详细，通过全局事务xid关联branchid，记录数据操作的表名，操作字段名，以及sql执行前后的记录数，如这个记录，表名=storage<!-- -->_<!-- -->tbl,sql执行前ID=10，count=100，sql执行后id=10，count=98。如果整个全局事务失败，需要回滚的时候就可以生成：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> storage_tbl </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样的回滚sql语句执行了。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="selectforupdateexecutor">SelectForUpdateExecutor：<a href="#selectforupdateexecutor" class="hash-link" aria-label="SelectForUpdateExecutor：的直接链接" title="SelectForUpdateExecutor：的直接链接">​</a></h3><p>fescar的AT模式在本地事务之上默认支持读未提交的隔离级别，但是通过SelectForUpdateExecutor执行器，可以支持读已提交的隔离级别。代码如：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object doExecute(Object... args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SQLSelectRecognizer recognizer = (SQLSelectRecognizer) sqlRecognizer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Connection conn = statementProxy.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ResultSet rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Savepoint sp = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LockRetryController lockRetryController = new LockRetryController();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean originalAutoCommit = conn.getAutoCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StringBuffer selectSQLAppender = new StringBuffer(&quot;SELECT &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectSQLAppender.append(getTableMeta().getPkName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectSQLAppender.append(&quot; FROM &quot; + getTableMeta().getTableName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String whereCondition = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ArrayList&lt;Object&gt; paramAppender = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (statementProxy instanceof ParametersHolder) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        whereCondition = recognizer.getWhereCondition((ParametersHolder) statementProxy, paramAppender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        whereCondition = recognizer.getWhereCondition();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!StringUtils.isEmpty(whereCondition)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectSQLAppender.append(&quot; WHERE &quot; + whereCondition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    selectSQLAppender.append(&quot; FOR UPDATE&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String selectPKSQL = selectSQLAppender.toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (originalAutoCommit) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.setAutoCommit(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sp = conn.setSavepoint();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rs = statementCallback.execute(statementProxy.getTargetStatement(), args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Try to get global lock of those rows selected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Statement stPK = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            PreparedStatement pstPK = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ResultSet rsPK = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (paramAppender.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    stPK = statementProxy.getConnection().createStatement();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rsPK = stPK.executeQuery(selectPKSQL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pstPK = statementProxy.getConnection().prepareStatement(selectPKSQL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for (int i = 0; i &lt; paramAppender.size(); i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pstPK.setObject(i + 1, paramAppender.get(i));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rsPK = pstPK.executeQuery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TableRecords selectPKRows = TableRecords.buildRecords(getTableMeta(), rsPK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                statementProxy.getConnectionProxy().checkLock(selectPKRows);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (LockConflictException lce) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.rollback(sp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                lockRetryController.sleep(lce);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (rsPK != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rsPK.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (stPK != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    stPK.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (pstPK != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pstPK.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (sp != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.releaseSavepoint(sp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (originalAutoCommit) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.setAutoCommit(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>关键代码见：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TableRecords selectPKRows = TableRecords.buildRecords(getTableMeta(), rsPK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statementProxy.getConnectionProxy().checkLock(selectPKRows);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过selectPKRows表操作记录拿到lockKeys，然后到TC控制器端查询是否被全局锁定了，如果被锁定了，就重新尝试，直到锁释放返回查询结果。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分支事务的注册和上报">分支事务的注册和上报<a href="#分支事务的注册和上报" class="hash-link" aria-label="分支事务的注册和上报的直接链接" title="分支事务的注册和上报的直接链接">​</a></h2><p>在本地事务提交前，fescar会注册和上报分支事务相关的信息，见ConnectionProxy类的commit部分代码：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void commit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (context.inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            register();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            recognizeLockKeyConflictException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (context.hasUndoLog()) { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                UndoLogManager.flushUndoLogs(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            report(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ex instanceof SQLException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw (SQLException) ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        report(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从这段代码我们可以看到，首先是判断是了是否是全局事务，如果不是，就直接提交了，如果是，就先向TC控制器注册分支事务，为了写隔离，在TC端会涉及到全局锁的获取。然后保存了用于回滚操作的undo_log日志，继而真正提交本地事务，最后向TC控制器上报事务状态。此时，阶段一的本地事务已完成了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="server模块协调全局">【server】模块协调全局<a href="#server模块协调全局" class="hash-link" aria-label="【server】模块协调全局的直接链接" title="【server】模块协调全局的直接链接">​</a></h2><p>关于server模块，我们可以聚焦在DefaultCoordinator这个类，这个是AbstractTCInboundHandler控制处理器默认实现。主要实现了全局事务开启，提交，回滚，状态查询，分支事务注册，上报，锁检查等接口，如：</p><p><img loading="lazy" src="/zh-cn/assets/images/3da6fd82debb9470eb4a5feb1eecac6d6a2-b042b32322c41b9cbe7563f9ccfdcf87.jpg" width="756" height="426" class="img_ev3q"></p><p>回到一开始的TransactionlTemplate，如果整个分布式事务失败需要回滚了，首先是TM向TC发起回滚的指令，然后TC接收到后，解析请求后会被路由到默认控制器类的doGlobalRollback方法内，最终在TC控制器端执行的代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void doGlobalRollback(GlobalSession globalSession, boolean retrying) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (BranchSession branchSession : globalSession.getReverseSortedBranches()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BranchStatus currentBranchStatus = branchSession.getStatus();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (currentBranchStatus == BranchStatus.PhaseOne_Failed) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BranchStatus branchStatus = resourceManagerInbound.branchRollback(XID.generateXID(branchSession.getTransactionId()), branchSession.getBranchId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    branchSession.getResourceId(), branchSession.getApplicationData());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (branchStatus) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PhaseTwo_Rollbacked:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    globalSession.removeBranch(branchSession);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.error(&quot;Successfully rolled back branch &quot; + branchSession);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PhaseTwo\_RollbackFailed\_Unretryable:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    GlobalStatus currentStatus = globalSession.getStatus();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (currentStatus.name().startsWith(&quot;Timeout&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        globalSession.changeStatus(GlobalStatus.TimeoutRollbackFailed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        globalSession.changeStatus(GlobalStatus.RollbackFailed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    globalSession.end();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.error(&quot;Failed to rollback global\[&quot; + globalSession.getTransactionId() + &quot;\] since branch\[&quot; + branchSession.getBranchId() + &quot;\] rollback failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.info(&quot;Failed to rollback branch &quot; + branchSession);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (!retrying) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        queueToRetryRollback(globalSession);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;Exception rollbacking branch &quot; + branchSession, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!retrying) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                queueToRetryRollback(globalSession);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ex instanceof TransactionException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw (TransactionException) ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new TransactionException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GlobalStatus currentStatus = globalSession.getStatus();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (currentStatus.name().startsWith(&quot;Timeout&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        globalSession.changeStatus(GlobalStatus.TimeoutRollbacked);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        globalSession.changeStatus(GlobalStatus.Rollbacked);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    globalSession.end();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如上代码可以看到，回滚时从全局事务会话中迭代每个分支事务，然后通知每个分支事务回滚。分支服务接收到请求后，首先会被路由到RMHandlerAT中的doBranchRollback方法，继而调用了RM中的branchRollback方法，代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public BranchStatus branchRollback(String xid, long branchId, String resourceId, String applicationData) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DataSourceProxy dataSourceProxy = get(resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dataSourceProxy == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ShouldNeverHappenException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UndoLogManager.undo(dataSourceProxy, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (TransactionException te) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (te.getCode() == TransactionExceptionCode.BranchRollbackFailed_Unretriable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return BranchStatus.PhaseTwo\_RollbackFailed\_Unretryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return BranchStatus.PhaseTwo\_RollbackFailed\_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return BranchStatus.PhaseTwo_Rollbacked;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>RM分支事务端最后执行的是UndoLogManager的undo方法，通过xid和branchid从数据库查询出回滚日志，完成数据回滚操作，整个过程都是同步完成的。如果全局事务是成功的，TC也会有类似的上述协调过程，只不过是异步的将本次全局事务相关的undo_log清除了而已。至此，就完成了2阶段的提交或回滚，也就完成了完整的全局事务事务的控制。</p><h1>结语</h1><p>如果你看到这里，那么非常感谢你，在繁忙工作之余耐心的花时间来学习。同时，我相信花的时间没白费，完整的浏览理解估计对fescar实现的大致流程了解的十之八九了。本文从构思立题到完成大概耗时1人天左右，博主在这个过程中，对fescar的实现也有了更加深入的了解。由于篇幅原因，并没有面面俱到的对每个实现的细节去深究，如sql是如何解析的等，更多的是在fescar的TXC模型的实现过程的关键点做了详细阐述。本文已校对，但由于个人知识水平及精力有限，文中不免出现错误或理解不当的地方，欢迎指正。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="作者简介">作者简介：<a href="#作者简介" class="hash-link" aria-label="作者简介：的直接链接" title="作者简介：的直接链接">​</a></h3><p>陈凯玲，2016年5月加入凯京科技。曾任职高级研发和项目经理，现任凯京科技研发中心架构&amp;运维部负责人。pmp项目管理认证，阿里云MVP。热爱开源，先后开源过多个热门项目。热爱分享技术点滴，独立博客KL博客（<a href="http://www.kailing.pub/" target="_blank" rel="noopener noreferrer">http://www.kailing.pub</a>）博主。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/manual-transaction-mode">MT 模式</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-02-13T00:00:00.000Z" itemprop="datePublished">2019年2月13日</time> · <!-- -->阅读需 2 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">kmmshmily</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>回顾总览中的描述：一个分布式的全局事务，整体是 <strong>两阶段提交</strong> 的模型。全局事务是由若干分支事务组成的，分支事务要满足 <strong>两阶段提交</strong> 的模型要求，即需要每个分支事务都具备自己的：</p><ul><li>一阶段 prepare 行为</li><li>二阶段 commit 或 rollback 行为</li></ul><p><img loading="lazy" src="https://upload-images.jianshu.io/upload_images/4420767-e48f0284a037d1df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Overview of a global transaction" class="img_ev3q"></p><p>根据两阶段行为模式的不同，我们将分支事务划分为 <strong>Automatic (Branch) Transaction Mode</strong> 和 <strong>Manual (Branch) Transaction Mode</strong>.</p><p>AT 模式基于 <strong>支持本地 ACID 事务</strong> 的 <strong>关系型数据库</strong>：</p><ul><li>一阶段 prepare 行为：在本地事务中，一并提交业务数据更新和相应回滚日志记录。</li><li>二阶段 commit 行为：马上成功结束，<strong>自动</strong> 异步批量清理回滚日志。</li><li>二阶段 rollback 行为：通过回滚日志，<strong>自动</strong> 生成补偿操作，完成数据回滚。</li></ul><p>相应的，MT 模式，不依赖于底层数据资源的事务支持：</p><ul><li>一阶段 prepare 行为：调用 <strong>自定义</strong> 的 prepare 逻辑。</li><li>二阶段 commit 行为：调用 <strong>自定义</strong> 的 commit 逻辑。</li><li>二阶段 rollback 行为：调用 <strong>自定义</strong> 的 rollback 逻辑。</li></ul><p>所谓 MT 模式，是指支持把 <strong>自定义</strong> 的分支事务纳入到全局事务的管理中。</p></div></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/page/5"><div class="pagination-nav__label">较新的博文</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">愿景</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/">Seata 是一款阿里巴巴开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。</a></li></ul></div><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/overview/what-is-seata">Seata是什么？</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/user/quickstart">快速开始</a></li><li class="footer__item"><a href="https://github.com/seata/seata.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">报告文档问题<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/seata/seata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">在GitHub上编辑此文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/community">社区</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="//img.alicdn.com/tfs/TB1dGrSwVT7gK0jSZFpXXaTkpXa-4802-1285.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="120" height="36"><img src="//img.alicdn.com/tfs/TB1dGrSwVT7gK0jSZFpXXaTkpXa-4802-1285.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="120" height="36"></div><div class="footer__copyright">Copyright © 2023 Seata</div></div></div></footer></div>
<script src="/zh-cn/assets/js/runtime~main.71f2148b.js"></script>
<script src="/zh-cn/assets/js/main.eaa3efae.js"></script>
</body>
</html>