<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">分布式事务中间件 Seata 的设计原理 | Apache Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.apache.org/zh-cn/img/seata_logo.png"><meta data-rh="true" name="twitter:image" content="https://seata.apache.org/zh-cn/img/seata_logo.png"><meta data-rh="true" property="og:url" content="https://seata.apache.org/zh-cn/blog/seata-at-mode-design"><meta data-rh="true" property="og:locale" content="zh_CN"><meta data-rh="true" property="og:locale:alternate" content="en_US"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="分布式事务中间件 Seata 的设计原理 | Apache Seata"><meta data-rh="true" name="description" content="AT 模式设计原理"><meta data-rh="true" property="og:description" content="AT 模式设计原理"><meta data-rh="true" name="keywords" content="Seata、分布式事务、AT模式"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2019-07-11T00:00:00.000Z"><link data-rh="true" rel="icon" href="/zh-cn/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.apache.org/zh-cn/blog/seata-at-mode-design"><link data-rh="true" rel="alternate" href="https://seata.apache.org/blog/seata-at-mode-design" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.apache.org/zh-cn/blog/seata-at-mode-design" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.apache.org/blog/seata-at-mode-design" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ICHFIJRDZF-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Apache Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Apache Seata Atom Feed">


<link rel="search" type="application/opensearchdescription+xml" title="Apache Seata" href="/zh-cn/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=seata"><link rel="stylesheet" href="/zh-cn/assets/css/styles.1f151b5e.css">
<script src="/zh-cn/assets/js/runtime~main.1a0795e5.js" defer="defer"></script>
<script src="/zh-cn/assets/js/main.a3d50fa2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/overview/what-is-seata" href="/zh-cn/docs/overview/what-is-seata">v2.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-cn/docs/next/overview/what-is-seata">预览版</a></li><li><a class="dropdown__link" href="/zh-cn/docs/overview/what-is-seata">v2.0</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.8/overview/what-is-seata">v1.8</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.7/overview/what-is-seata">v1.7</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.6/overview/what-is-seata">v1.6</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.5/overview/what-is-seata">v1.5</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.4/overview/what-is-seata">v1.4</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.3/overview/what-is-seata">v1.3</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.2/overview/what-is-seata">v1.2</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.1/overview/what-is-seata">v1.1</a></li><li><a class="dropdown__link" href="/zh-cn/docs/v1.0/overview/what-is-seata">v1.0</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/contributor-guide/new-contributor-guide_dev">开发者</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/users">用户</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a class="navbar__item navbar__link" href="/zh-cn/unversioned/download/seata-server">下载</a><a class="navbar__item navbar__link" href="/zh-cn/solution">解决方案</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">设计器</a><ul class="dropdown__menu"><li><a href="/zh-cn/saga-designer" class="dropdown__link" target="_blank">Saga 设计器</a></li><li><a href="/zh-cn/saga-designer-legacy" class="dropdown__link" target="_blank">Saga 设计器（旧版）</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/blog/seata-at-mode-design" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog/seata-at-mode-design" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/how-to-write-unit-tests">如何在seata中编写测试用例</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/explore-seata-journey">探索 Seata 项目开源开发之旅</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-raft-detailed-explanation">Seata-Raft 存储模式详解及入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-connect-data-and-application">Seata：连接数据与应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-observable-practice">Seata的可观测实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-go-1.2.0">生产环境可用的 seata-go 1.2.0 来了！！！</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/iscas2023">6大课题现已开放挑选 | 欢迎报名 Seata 开源之夏</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.6.0">Seata 1.6.0 重磅发布，大幅提升性能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-1.5.2">Seata 1.5.2 重磅发布，支持xid负载均衡</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc-fence">阿里 Seata 新版本终于解决了 TCC 模式的幂等、悬挂和空回滚问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-tcc">深度剖析 Seata TCC 模式（一）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-lock">详解 Seata AT 模式事务隔离级别与全局锁设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-snowflake-explain">关于新版雪花算法的答疑</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-UUID-generator">Seata基于改良版雪花算法的分布式UUID生成器分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-feature-undo-log-compress">Seata新特性支持 -- undo_log压缩</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dsproxy-deadlock">ConcurrentHashMap导致的Seata死锁问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-02">Seata应用侧启动过程剖析——注册中心与配置中心模块</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-client-start-analysis-01">Seata应用侧启动过程剖析——RM &amp; TM如何与TC建立连接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-tcc-mode-with-spring-cloud">Spring Cloud集成Seata分布式事务-TCC模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-manager">Seata配置管理原理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-golang-communication-mode">seata-golang 通信模型详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-datasource-proxy">Seata数据源代理解析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-client-bootstrap">分布式事务Seata源码-Client端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-demo-in-mac">Mac下 的Seata Demo环境搭建（AT模式）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-rpc-refactor">Seata RPC 模块的重构之路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-sourcecode-server-bootstrap">分布式事务Seata源码-Server端启动流程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-xa-introduce">分布式事务如何实现？深入解读 Seata 的 XA 模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-quick-start">Seata 极简入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-ha-practice">Seata 高可用部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-config-modular">Seata config 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-dubbo-transmit-xid">源码分析Seata-XID传递 Dubbo篇</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-tcc-modular">Seata tcc 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-community-meetup-hangzhou-ready">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-core-modular">Seata core 模块源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-spring-boot-aop-aspectj">通过AOP动态创建/关闭Seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-dynamic-config-and-dynamic-disable">Seata 动态配置订阅与降级实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-config-center">Seata 配置中心实现原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-docker">Docker部署Seata与Nacos整合</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-nacos-analysis">Seata分布式事务启用Nacos做配置中心</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-meetup-hangzhou">Seata Community Meetup·杭州站</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-mybatisplus-analysis">透过源码解决SeataAT模式整合Mybatis-Plus失去MP特性的问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/springboot-dubbo-mybatisplus-seata">SpringBoot+Dubbo+MybatisPlus整合seata分布式事务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start-rm-tm">Seata 客户端需要同时启动 RM 和 TM 吗？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-mode-start">Seata AT 模式启动源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/design-more-flexable-application-by-saga">基于 Seata Saga 设计更有弹性的金融应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-at-tcc-saga">分布式事务 Seata 及其三种模式详解</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zh-cn/blog/seata-at-mode-design">分布式事务中间件 Seata 的设计原理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-go-server">Seata分布式Go Server正式开源-TaaS设计简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/how-to-support-spring-cloud">Fescar 与 Spring Cloud 集成源码深度剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/integrate-seata-with-spring-cloud">Seata（Fescar）分布式事务 整合 Spring Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-client">分布式事务之Seata-Client原理及流程详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-java-server">深度剖析一站式分布式事务方案Seata-Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-applicable-scenario-analysis">TCC适用模型与适用场景分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/tcc-mode-design-principle">TCC 理论及设计实现指南介绍</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/quick-start-use-seata-and-dubbo-services">如何使用Seata保证Dubbo微服务间的一致性</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/seata-analysis-simple">Fescar分布式事务原理解析探秘</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/manual-transaction-mode">MT 模式</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="AT 模式设计原理"><meta itemprop="keywords" content="Seata、分布式事务、AT模式"><header><h1 class="title_f1Hy" itemprop="headline">分布式事务中间件 Seata 的设计原理</h1><div class="container_mt6G margin-vert--md"><time datetime="2019-07-11T00:00:00.000Z" itemprop="datePublished">2019年7月11日</time> · <!-- -->阅读需 15 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">张乘辉</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>在微服务架构体系下，我们可以按照业务模块分层设计，单独部署，减轻了服务部署压力，也解耦了业务的耦合，避免了应用逐渐变成一个庞然怪物，从而可以轻松扩展，在某些服务出现故障时也不会影响其它服务的正常运行。总之，微服务在业务的高速发展中带给我们越来越多的优势，但是微服务并不是十全十美，因此不能盲目过度滥用，它有很多不足，而且会给系统带来一定的复杂度，其中伴随而来的分布式事务问题，是微服务架构体系下必然需要处理的一个痛点，也是业界一直关注的一个领域，因此也出现了诸如 CAP 和 BASE 等理论。</p>
<p>在今年年初，阿里开源了一个分布式事务中间件，起初起名为 Fescar，后改名为 Seata，在它开源之初，我就知道它肯定要火，因为这是一个解决痛点的开源项目，Seata 一开始就是冲着对业务无侵入与高性能方向走，这正是我们对解决分布式事务问题迫切的需求。因为待过的几家公司，用的都是微服务架构，但是在解决分布式事务的问题上都不太优雅，所以我也在一直关注 Seata 的发展，今天就简要说说它的一些设计上的原理，后续我将会对它的各个模块进行深入源码分析，感兴趣的可以持续关注我的公众号或者博客，不要跟丢。</p>
<h1>分布式事务解决的方案有哪些？</h1>
<p>目前分布式事务解决的方案主要有对业务无入侵和有入侵的方案，无入侵方案主要有基于数据库 XA 协议的两段式提交（2PC）方案，它的优点是对业务代码无入侵，但是它的缺点也是很明显：必须要求数据库对 XA 协议的支持，且由于 XA 协议自身的特点，它会造成事务资源长时间得不到释放，锁定周期长，而且在应用层上 面无法干预，因此它性能很差，它的存在相当于七伤拳那样“伤人七分，损己三分”，因此在互联网项目中并不是很流行这种解决方案。</p>
<p>为了这个弥补这种方案带来性能低的问题，大佬们又想出了很多种方案来解决，但这无一例外都需要通过在应用层做手脚，即入侵业务的方式，比如很出名的 TCC 方案，基于 TCC 也有很多成熟的框架，如 ByteTCC、tcc-transaction 等。以及基于可靠消息的最终一致性来实现，如 RocketMQ 的事务消息。</p>
<p>入侵代码的方案是基于现有情形“迫不得已”才推出的解决方案，实际上它们实现起来非常不优雅，一个事务的调用通常伴随而来的是对该事务接口增加一系列的反向操作，比如 TCC 三段式提交，提交逻辑必然伴随着回滚的逻辑，这样的代码会使得项目非常臃肿，维护成本高。</p>
<h1>Seata 各模块之间的关系</h1>
<p>针对上面所说的分布式事务解决方案的痛点，那很显然，我们理想的分布式事务解决方案肯定是性能要好而且要对业务无入侵，业务层上无需关心分布式事务机制的约束，Seata 正是往这个方向发展的，因此它非常值得期待，它将给我们的微服务架构带来质的提升。</p>
<p>那 Seata 是怎么做到的呢？下面说说它的各个模块之间的关系。</p>
<p>Seata 的设计思路是将一个分布式事务可以理解成一个全局事务，下面挂了若干个分支事务，而一个分支事务是一个满足 ACID 的本地事务，因此我们可以操作分布式事务像操作本地事务一样。</p>
<p>Seata 内部定义了 3个模块来处理全局事务和分支事务的关系和处理过程，这三个组件分别是：</p>
<ul>
<li>Transaction Coordinator (TC)： 事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚。</li>
<li>Transaction Manager (TM)： 控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议。</li>
<li>Resource Manager (RM)： 控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚。</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata.png" alt="" class="img_ev3q"></p>
<p>简要说说整个全局事务的执行步骤：</p>
<ol>
<li>TM 向 TC 申请开启一个全局事务，TC 创建全局事务后返回全局唯一的 XID，XID 会在全局事务的上下文中传播；</li>
<li>RM 向 TC 注册分支事务，该分支事务归属于拥有相同 XID 的全局事务；</li>
<li>TM 向 TC 发起全局提交或回滚；</li>
<li>TC 调度 XID 下的分支事务完成提交或者回滚。</li>
</ol>
<h1>与 XA 方案有什么不同？</h1>
<p>Seata 的事务提交方式跟 XA 协议的两段式提交在总体上来说基本是一致的，那它们之间有什么不同呢？</p>
<p>我们都知道 XA 协议它依赖的是数据库层面来保障事务的一致性，也即是说 XA 的各个分支事务是在数据库层面上驱动的，由于 XA 的各个分支事务需要有 XA 的驱动程序，一方面会导致数据库与 XA 驱动耦合，另一方面它会导致各个分支的事务资源锁定周期长，这也是它没有在互联网公司流行的重要因素。</p>
<p>基于 XA 协议以上的问题，Seata 另辟蹊径，既然在依赖数据库层会导致这么多问题，那我就从应用层做手脚，这还得从 Seata 的 RM 模块说起，前面也说过 RM 的主要作用了，其实 RM 在内部做了对数据库操作的代理层，如下：</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata5.png" alt="" class="img_ev3q"></p>
<p>Seata 在数据源做了一层代理层，所以我们使用 Seata 时，我们使用的数据源实际上用的是 Seata 自带的数据源代理 DataSourceProxy，Seata  在这层代理中加入了很多逻辑，主要是解析 SQL，把业务数据在更新前后的数据镜像组织成回滚日志，并将 undo log 日志插入 undo_log 表中，保证每条更新数据的业务 sql 都有对应的回滚日志存在。</p>
<p>这样做的好处就是，本地事务执行完可以立即释放本地事务锁定的资源，然后向 TC 上报分支状态。当 TM 决议全局提交时，就不需要同步协调处理了，TC 会异步调度各个 RM 分支事务删除对应的 undo log 日志即可，这个步骤非常快速地可以完成；当 TM 决议全局回滚时，RM 收到 TC 发送的回滚请求，RM 通过 XID 找到对应的 undo log 回滚日志，然后执行回滚日志完成回滚操作。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata6.png" alt="" class="img_ev3q"></p>
<p>如上图所示，XA 方案的 RM 是放在数据库层的，它依赖了数据库的 XA 驱动程序。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/Seata7.png" alt="" class="img_ev3q"></p>
<p>如上图所示，Seata 的 RM 实际上是已中间件的形式放在应用层，不用依赖数据库对协议的支持，完全剥离了分布式事务方案对数据库在协议支持上的要求。</p>
<h1>分支事务如何提交和回滚？</h1>
<p>下面详细说说分支事务是如何提交和回滚的：</p>
<ul>
<li>第一阶段：</li>
</ul>
<p>分支事务利用 RM 模块中对 JDBC 数据源代理，加入了若干流程，对业务 SQL 进行解释，把业务数据在更新前后的数据镜像组织成回滚日志，并生成 undo log 日志，对全局事务锁的检查以及分支事务的注册等，利用本地事务 ACID 特性，将业务 SQL 和 undo log 写入同一个事物中一同提交到数据库中，保证业务 SQL 必定存在相应的回滚日志，最后对分支事务状态向 TC 进行上报。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata2.png" alt="" class="img_ev3q"></p>
<ul>
<li>第二阶段：</li>
</ul>
<p>TM决议全局提交：</p>
<p>当 TM 决议提交时，就不需要同步协调处理了，TC 会异步调度各个 RM 分支事务删除对应的 undo log 日志即可，这个步骤非常快速地可以完成。这个机制对于性能提升非常关键，我们知道正常的业务运行过程中，事务执行的成功率是非常高的，因此可以直接在本地事务中提交，这步对于提升性能非常显著。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata3.png" alt="" class="img_ev3q"></p>
<p>TM决议全局回滚：</p>
<p>当 TM 决议回滚时，RM 收到 TC 发送的回滚请求，RM 通过 XID 找到对应的 undo log 回滚日志，然后利用本地事务 ACID 特性，执行回滚日志完成回滚操作并删除 undo log 日志，最后向 TC 进行回滚结果上报。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata4.png" alt="" class="img_ev3q"></p>
<p>业务对以上所有的流程都无感知，业务完全不关心全局事务的具体提交和回滚，而且最重要的一点是 Seata 将两段式提交的同步协调分解到各个分支事务中了，分支事务与普通的本地事务无任何差异，这意味着我们使用 Seata 后，分布式事务就像使用本地事务一样，完全将数据库层的事务协调机制交给了中间件层 Seata 去做了，这样虽然事务协调搬到应用层了，但是依然可以做到对业务的零侵入，从而剥离了分布式事务方案对数据库在协议支持上的要求，且 Seata 在分支事务完成之后直接释放资源，极大减少了分支事务对资源的锁定时间，完美避免了 XA 协议需要同步协调导致资源锁定时间过长的问题。</p>
<h1>其它方案的补充</h1>
<p>上面说的其实是 Seata 的默认模式，也叫 AT 模式 ，它是类似于 XA 方案的两段式提交方案，并且是对业务无侵入，但是这种机制依然是需要依赖数据库本地事务的 ACID 特性，有没有发现，我在上面的图中都强调了必须是支持 ACID 特性的关系型数据库，那么问题就来了，非关系型或者不支持 ACID 的数据库就无法使用 Seata 了，别慌，Seata 现阶段为我们准备了另外一种模式，叫 MT 模式，它是一种对业务有入侵的方案，提交回滚等操作需要我们自行定义，业务逻辑需要被分解为 Prepare/Commit/Rollback 3 部分，形成一个 MT 分支，加入全局事务，它存在的意义是为 Seata 触达更多的场景。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/seata8.png" alt="" class="img_ev3q"></p>
<p>只不过，它不是 Seata “主打”的模式，它的存在仅仅作为补充的方案，从以上官方的发展远景就可以看出来，Seata 的目标是始终是对业务无入侵的方案。</p>
<p><em>注：本文图片设计参考Seata官方图</em></p>
<h1>作者简介：</h1>
<p>张乘辉，目前就职于中通科技信息中心技术平台部，担任 Java 工程师，主要负责中通消息平台与全链路压测项目的研发，热爱分享技术，微信公众号「后端进阶」作者，技术博客（<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>）博主，Seata Contributor，GitHub ID：objcoding。</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col margin-top--sm"><a href="https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/zh-cn/docusaurus-plugin-content-blog/seata-at-mode-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh-cn/blog/seata-at-tcc-saga"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">分布式事务 Seata 及其三种模式详解</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/seata-analysis-go-server"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Seata分布式Go Server正式开源-TaaS设计简介</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh-cn/img/apache/incubator.svg" alt="Apache Incubator Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">
                  <div class="fs-12">
                    <div class="center-div">
                      <span>Apache Seata (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</span>
                    </div>
                    <br>
                    <div class="center-div">
                      <span>Copyright © 2023-2024, The Apache Software Foundation Apache Seata, Seata, Apache, Apache Incubator, the Apache feather, the Apache Incubator logo and the Apache Seata project logo are either registered trademarks or trademarks of the Apache Software Foundation.</span>
                      <br>
                    </div>
                    <br>
                  </div>
                  </div></div></div></footer></div>
</body>
</html>