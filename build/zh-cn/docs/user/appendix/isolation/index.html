<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-user/appendix/isolation">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Seata事务隔离 | Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://chai001125.github.io/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="http://chai001125.github.io/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="http://chai001125.github.io/zh-cn/docs/user/appendix/isolation"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Seata事务隔离 | Seata"><meta data-rh="true" name="description" content="Seata事务隔离"><meta data-rh="true" property="og:description" content="Seata事务隔离"><meta data-rh="true" name="keywords" content="Seata事务隔离"><link data-rh="true" rel="icon" href="/zh-cn/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="http://chai001125.github.io/zh-cn/docs/user/appendix/isolation"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/docs/user/appendix/isolation" hreflang="en-US"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/zh-cn/docs/user/appendix/isolation" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="http://chai001125.github.io/docs/user/appendix/isolation" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Seata Atom Feed">




<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.js"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.c84d55f4.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.71f2148b.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.eaa3efae.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh-cn/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><a class="navbar__item navbar__link" href="/zh-cn/docs/overview/what-is-seata">文档</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">解决方案</a><ul class="dropdown__menu"><li><a href="https://cn.aliyun.com/product/aliware/mse?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">Seata企业版<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://cn.aliyun.com/product/aliware/mse?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">微服务解决方案<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/ahas?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">高可用解决方案<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://cn.aliyun.com/product/aliware/sae?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">微服务Serverless解决方案<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/edas?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">PaaS解决方案<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.aliyun.com/product/servicemesh?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">服务网格解决方案<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://help.aliyun.com/document_detail/132903.html?spm=seata-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">SOFA分布式事务<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/developers_dev">开发者</a><a href="https://mp.weixin.qq.com/s/nvDmIJEuDaNEY3RfTA3UyA" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">团队招聘</a><a class="navbar__item navbar__link" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a class="navbar__item navbar__link" href="/zh-cn/docs/download">下载</a><a href="http://demo.seata.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/docs/user/appendix/isolation" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/docs/user/appendix/isolation" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>Seata事务隔离</h1><blockquote><p>本文目标：帮助用户明白使用Seata <strong>AT模式</strong>时，该如何正确实现事务隔离，防止脏读脏写。</p><p><strong>希望读者在阅读本文前，已阅读过seata官网中对AT模式的介绍，并且对数据库本地锁有所了解</strong></p><p>（例如，两个事务同时在对同一条记录做update时，只有拿到record lock的事务才能更新成功，另一个事务在record lock未释放前只能等待，直到事务超时）</p></blockquote><p>首先请看这样的一段代码，尽管看着“初级”，但持久层框架实际上帮我们做的主要事情也就这样。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DataSource dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void batchUpdate() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection connection = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement preparedStatement = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection = dataSource.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection.setAutoCommit(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String sql = &quot;update storage_tbl set count = ?&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;    where id = ? and commodity_code = ?&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement = connection.prepareStatement(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setInt(1, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setLong(2, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setString(3, &quot;2001&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.executeUpdate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IOutils.close(preparedStatement);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IOutils.close(connection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="从代理数据源说起">从代理数据源说起<a href="#从代理数据源说起" class="hash-link" aria-label="从代理数据源说起的直接链接" title="从代理数据源说起的直接链接">​</a></h2><p>使用AT模式，最重要的事情便是代理数据源，那么用<code>DataSourceProxy</code>代理数据源有什么作用呢？</p><p>DataSourceProxy能帮助我们获得几个重要的代理对象</p><ul><li><p>通过<code>DataSourceProxy.getConnection()</code>获得<code>ConnectionProxy</code></p></li><li><p>通过<code>ConnectionProxy.prepareStatement(...)</code>获得<code>StatementProxy</code></p></li></ul><p>Seata的如何实现事务隔离，就藏在这2个Proxy中，我先概述下实现逻辑。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="statementproxyexecutexxx的处理逻辑"><strong><code>StatementProxy.executeXXX()</code>的处理逻辑</strong><a href="#statementproxyexecutexxx的处理逻辑" class="hash-link" aria-label="statementproxyexecutexxx的处理逻辑的直接链接" title="statementproxyexecutexxx的处理逻辑的直接链接">​</a></h3><ul><li><p>当调用<code>io.seata.rm.datasource.StatementProxy.executeXXX()</code>会将sql交给<code>io.seata.rm.datasource.exec.ExecuteTemplate.execute(...)</code>处理。</p><ul><li><code>ExecuteTemplate.execute(...)</code>方法中，Seata根据不同dbType和sql语句类型使用不同的Executer，调用<code>io.seata.rm.datasource.exec.Executer</code>类的<code>execute(Object... args)</code>。</li><li>如果选了DML类型Executer，主要做了以下事情：<ul><li>查询前镜像（select for update，因此此时获得本地锁）</li><li>执行业务sql</li><li>查询后镜像</li><li>准备undoLog</li></ul></li><li>如果你的sql是select for update则会使用<code>SelectForUpdateExecutor</code>（Seata代理了select for update），代理后处理的逻辑是这样的：<ul><li>先执行 select for update（获取数据库本地锁）</li><li>如果处于<code>@GlobalTransactional</code> or <code>@GlobalLock</code>，<strong>检查</strong>是否有全局锁</li><li>如果有全局锁，则未开启本地事务下会rollback本地事务,再重新争抢本地锁和全局锁,以此类推,除非拿到全局锁</li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="connectionproxycommit的处理逻辑"><strong><code>ConnectionProxy.commit()</code>的处理逻辑</strong><a href="#connectionproxycommit的处理逻辑" class="hash-link" aria-label="connectionproxycommit的处理逻辑的直接链接" title="connectionproxycommit的处理逻辑的直接链接">​</a></h3><ul><li>处于全局事务中（即，数据持久化方法带有<code>@GlobalTransactional</code>）<ul><li>注册分支事务，获取全局锁</li><li>undoLog数据入库</li><li>让数据库commit本次事务</li></ul></li><li>处于<code>@GlobalLock</code>中（即，数据持久化方法带有<code>@GlobalLock</code>）<ul><li>向tc查询是否有全局锁存在，如存在，则抛出异常</li><li>让数据库commit本次事务</li></ul></li><li>除了以上情况（<code>else</code>分支）<ul><li>让数据库commit本次事务</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="globaltransactional的作用"><strong>@GlobalTransactional的作用</strong><a href="#globaltransactional的作用" class="hash-link" aria-label="globaltransactional的作用的直接链接" title="globaltransactional的作用的直接链接">​</a></h3><p>标识一个全局事务</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="globallock--select-for-update的作用"><strong>@GlobalLock + select for update的作用</strong><a href="#globallock--select-for-update的作用" class="hash-link" aria-label="globallock--select-for-update的作用的直接链接" title="globallock--select-for-update的作用的直接链接">​</a></h3><p>如果像<code>updateA()</code>方法带有<code>@GlobalLock + select for update</code>，Seata在处理时，会先获取数据库本地锁，然后查询该记录是否有全局锁存在，若有，则抛出LockConflictException。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="先举一个脏写的例子再来看seata如何防止脏写">先举一个脏写的例子，再来看Seata如何防止脏写<a href="#先举一个脏写的例子再来看seata如何防止脏写" class="hash-link" aria-label="先举一个脏写的例子，再来看Seata如何防止脏写的直接链接" title="先举一个脏写的例子，再来看Seata如何防止脏写的直接链接">​</a></h2><p>假设你的业务代码是这样的：</p><ul><li><code>updateAll()</code>用来同时更新A和B表记录，<code>updateA()</code> <code>updateB()</code>则分别更新A、B表记录</li><li><code>updateAll()</code>已经加上了<code>@GlobalTransactional</code></li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class YourBussinessService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DbServiceA serviceA;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DbServiceB serviceB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean updateAll(DTO dto) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceA.update(dto.getA());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceB.update(dto.getB());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean updateA(DTO dto) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceA.update(dto.getA());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class DbServiceA {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean update(A a) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="dirty-write" src="/zh-cn/assets/images/dirty-write-e87d2b06d84c820fd786932b58583404.png" width="1964" height="1946" class="img_ev3q">
|</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="怎么用seata防止脏写"><strong>怎么用Seata防止脏写？</strong><a href="#怎么用seata防止脏写" class="hash-link" aria-label="怎么用seata防止脏写的直接链接" title="怎么用seata防止脏写的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="办法一updatea也加上globaltransactional此时seata会如何保证事务隔离">办法一：<code>updateA()</code>也加上<code>@GlobalTransactional</code>，此时Seata会如何保证事务隔离？<a href="#办法一updatea也加上globaltransactional此时seata会如何保证事务隔离" class="hash-link" aria-label="办法一updatea也加上globaltransactional此时seata会如何保证事务隔离的直接链接" title="办法一updatea也加上globaltransactional此时seata会如何保证事务隔离的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class DbServiceA {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean updateA(DTO dto) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceA.update(dto.getA());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>updateAll()</code>先被调用（未完成），<code>updateA()</code>后被调用</li></ul><p><img loading="lazy" alt="dirty-write" src="/zh-cn/assets/images/prevent-dirty-write-by-GlobalTransaction-7a7b3233283a355ca3a609e67841e43c.png" width="2236" height="1932" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="办法二-globallock--select-for-update">办法二： <strong>@GlobalLock + select for update</strong><a href="#办法二-globallock--select-for-update" class="hash-link" aria-label="办法二-globallock--select-for-update的直接链接" title="办法二-globallock--select-for-update的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class DbServiceA {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalLock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean updateA(DTO dto) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceA.selectForUpdate(dto.getA());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceA.update(dto.getA());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>updateAll()</code>先被调用（未完成），<code>updateA()</code>后被调用
<img loading="lazy" alt="dirty-write" src="/zh-cn/assets/images/prevent-dirty-write-by-GlobalLock-2371e8e82186fce823044f836a2e02c2.png" width="2860" height="1830" class="img_ev3q"></li></ul><ul><li>那如果是<code>updateA()</code>先被调用（未完成），<code>updateAll()</code>后被调用呢？<br>由于2个业务都是要先获得本地锁，因此同样不会发生脏写</li><li>一定有人会问，“这里为什么要加上select for update? 只用@GlobalLock能不能防止脏写？”
能。但请再回看下上面的图，select for update能带来这么几个好处：<ul><li>锁冲突更“温柔”些。如果只有@GlobalLock，检查到全局锁，则立刻抛出异常，也许再“坚持”那么一下，全局锁就释放了，抛出异常岂不可惜了。</li><li>在<code>updateA()</code>中可以通过select for update获得最新的A，接着再做更新。</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何防止脏读"><strong>如何防止脏读？</strong><a href="#如何防止脏读" class="hash-link" aria-label="如何防止脏读的直接链接" title="如何防止脏读的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="场景---某业务先调用updateallupdateall未执行完成另一业务后调用querya">场景：   某业务先调用<code>updateAll()</code>，<code>updateAll()</code>未执行完成，另一业务后调用<code>queryA()</code><a href="#场景---某业务先调用updateallupdateall未执行完成另一业务后调用querya" class="hash-link" aria-label="场景---某业务先调用updateallupdateall未执行完成另一业务后调用querya的直接链接" title="场景---某业务先调用updateallupdateall未执行完成另一业务后调用querya的直接链接">​</a></h3><p><img loading="lazy" alt="dirty-write" src="/zh-cn/assets/images/prevent-dirty-read-ce251ac833cb2ea643757c1816ab9903.png" width="2860" height="1830" class="img_ev3q"></p><hr><h1><strong>源码展示</strong></h1><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DataSource dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void update() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection connection = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement preparedStatement = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection = dataSource.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection.setAutoCommit(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String sql = &quot;update storage_tbl set count = ?&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;    where id = ? and commodity_code = ?&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement = connection.prepareStatement(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setInt(1, 100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setLong(2, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.setString(3, &quot;2001&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preparedStatement.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IOutils.close(preparedStatement);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IOutils.close(connection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这段代码虽然看着很初级，没有使用持久层框架，但如果将框架帮我们做的事情抽象出来，其实也就是上面这段代码。</p><p><strong>简单说明接下来源码介绍的脉络（主要关注和事务隔离有关的源码）</strong></p><ul><li>代理数据源的用途<ul><li><code>DataSourceProxy</code>的作用（返回<code>ConnectionProxy</code>）<ul><li>介绍 <code>ConnectionProxy</code>的一个小功能（存放undolog）</li></ul></li><li><code>ConnectionProxy</code>的作用（返回<code>StatementProxy</code>）</li><li><code>StatementProxy.execute()</code>的处理逻辑<ul><li><code>io.seata.rm.datasource.exec.UpdateExecutor</code>的执行逻辑（查前镜像、执行sql、查后镜像、准备undoLog）</li><li><code>SelectForUpdateExecutor</code>的执行逻辑（挣本地锁，查全局锁。有全局锁，回滚，再争...）</li></ul></li><li><code>ConnectionProxy.commit()</code>的处理逻辑（注册分支事务（争全局锁），写入undoLog，数据库提交）</li></ul></li><li>介绍RootContext</li><li><code>GlobalTransactionalInterceptor</code>的不同代理逻辑<ul><li>带有<code>@GlobalTransactional</code>如何处理</li><li>带有<code>@GlobalLock</code>如何处理</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="datasourceproxy的作用"><strong>DataSourceProxy的作用</strong><a href="#datasourceproxy的作用" class="hash-link" aria-label="datasourceproxy的作用的直接链接" title="datasourceproxy的作用的直接链接">​</a></h2><p>DataSourceProxy帮助我们获得几个重要的代理对象</p><ul><li><p>通过<code>DataSourceProxy.getConnection()</code>获得<code>ConnectionProxy</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSourceProxy extends AbstractDataSourceProxy implements Resource {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConnectionProxy getConnection() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection targetConnection = targetDataSource.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ConnectionProxy(this, targetConnection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>现在先介绍下<code>ConnectionProxy</code>中的<code>ConnectionContext</code>，它的有一个功能是<strong>存放undoLog</strong>。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.rm.datasource.undo.SQLUndoLog;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void appendUndoLog(SQLUndoLog sqlUndoLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.appendUndoItem(sqlUndoLog);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Savepoint DEFAULT_SAVEPOINT = new Savepoint() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public int getSavepointId() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getSavepointName() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;DEFAULT_SEATA_SAVEPOINT&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;Savepoint, List&lt;SQLUndoLog&gt;&gt; sqlUndoItemsBuffer = new LinkedHashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Savepoint currentSavepoint = DEFAULT_SAVEPOINT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void appendUndoItem(SQLUndoLog sqlUndoLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sqlUndoItemsBuffer.computeIfAbsent(currentSavepoint, k -&gt; new ArrayList&lt;&gt;()).add(sqlUndoLog);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="通过connectionproxypreparestatement获得statementproxy"><strong>通过<code>ConnectionProxy.prepareStatement(...)</code>获得<code>StatementProxy</code></strong><a href="#通过connectionproxypreparestatement获得statementproxy" class="hash-link" aria-label="通过connectionproxypreparestatement获得statementproxy的直接链接" title="通过connectionproxypreparestatement获得statementproxy的直接链接">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConnectionProxy(DataSourceProxy dataSourceProxy, Connection targetConnection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(dataSourceProxy, targetConnection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractConnectionProxy implements Connection {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Connection targetConnection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AbstractConnectionProxy(DataSourceProxy dataSourceProxy, Connection targetConnection) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.dataSourceProxy = dataSourceProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.targetConnection = targetConnection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PreparedStatement prepareStatement(String sql) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String dbType = getDbType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // support oracle 10.2+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement targetPreparedStatement = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (BranchType.AT == RootContext.getBranchType()) { //为什么这里会返回AT？</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SQLRecognizer&gt; sqlRecognizers = SQLVisitorFactory.get(sql, dbType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (sqlRecognizers != null &amp;&amp; sqlRecognizers.size() == 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SQLRecognizer sqlRecognizer = sqlRecognizers.get(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (sqlRecognizer != null &amp;&amp; sqlRecognizer.getSQLType() == SQLType.INSERT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TableMeta tableMeta = TableMetaCacheFactory.getTableMetaCache(dbType).getTableMeta(getTargetConnection(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            sqlRecognizer.getTableName(), getDataSourceProxy().getResourceId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] pkNameArray = new String[tableMeta.getPrimaryKeyOnlyName().size()];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tableMeta.getPrimaryKeyOnlyName().toArray(pkNameArray);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 如果是insert语句，这里创建的PreparedStatement需要可以返回自动生成的主键，因此使用这个prepareStatement()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    targetPreparedStatement = getTargetConnection().prepareStatement(sql,pkNameArray);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (targetPreparedStatement == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            targetPreparedStatement = getTargetConnection().prepareStatement(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new PreparedStatementProxy(this, targetPreparedStatement, sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Connection getTargetConnection() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return targetConnection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>先在这打下个疑问，后边解释。<br>
<strong><code>RootContext.getBranchType()</code>的返回值怎么会是AT？</strong></p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="statementproxyexecute的处理逻辑"><strong><code>StatementProxy.execute()</code>的处理逻辑</strong><a href="#statementproxyexecute的处理逻辑" class="hash-link" aria-label="statementproxyexecute的处理逻辑的直接链接" title="statementproxyexecute的处理逻辑的直接链接">​</a></h2><ul><li><p>当调用<code>io.seata.rm.datasource.StatementProxy.execute()</code>会将sql交给<code>io.seata.rm.datasource.exec.ExecuteTemplate.execute(...)</code>处理。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PreparedStatementProxy extends AbstractPreparedStatementProxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implements PreparedStatement, ParametersHolder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean execute() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExecuteTemplate.execute(this, (statement, args) -&gt; statement.execute());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>ExecuteTemplate.execute(...)</code>方法中，Seata根据不同dbType和sql语句类型使用不同的Executer，调用<code>io.seata.rm.datasource.exec.Executer</code>类的<code>execute(Object... args)</code>。<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource.exec;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public class ExecuteTemplate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public static &lt;T, S extends Statement&gt; T execute(StatementProxy&lt;S&gt; statementProxy,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 StatementCallback&lt;T, S&gt; statementCallback,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 Object... args) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return execute(null, statementProxy, statementCallback, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public static &lt;T, S extends Statement&gt; T execute(List&lt;SQLRecognizer&gt; sqlRecognizers,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             StatementProxy&lt;S&gt; statementProxy,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             StatementCallback&lt;T, S&gt; statementCallback,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             Object... args) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!RootContext.requireGlobalLock() &amp;&amp; BranchType.AT != RootContext.getBranchType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Just work as original statement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return statementCallback.execute(statementProxy.getTargetStatement(), args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String dbType = statementProxy.getConnectionProxy().getDbType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(sqlRecognizers)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sqlRecognizers = SQLVisitorFactory.get(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        statementProxy.getTargetSQL(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        dbType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Executor&lt;T&gt; executor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(sqlRecognizers)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                executor = new PlainExecutor&lt;&gt;(statementProxy, statementCallback);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (sqlRecognizers.size() == 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SQLRecognizer sqlRecognizer = sqlRecognizers.get(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    switch (sqlRecognizer.getSQLType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        case INSERT:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            executor = EnhancedServiceLoader.load(InsertExecutor.class, dbType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    new Class[]{StatementProxy.class, StatementCallback.class, SQLRecognizer.class},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    new Object[]{statementProxy, statementCallback, sqlRecognizer});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        case UPDATE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            executor = new UpdateExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        case DELETE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            executor = new DeleteExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        case SELECT_FOR_UPDATE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            executor = new SelectForUpdateExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            executor = new PlainExecutor&lt;&gt;(statementProxy, statementCallback);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    executor = new MultiExecutor&lt;&gt;(statementProxy, statementCallback, sqlRecognizers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            T rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rs = executor.execute(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!(ex instanceof SQLException)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Turn other exception into SQLException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ex = new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw (SQLException) ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &gt; 也在这打下个疑问，后边解释。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &gt; **`RootContext.requireGlobalLock()`怎么判断当前是否需要全局锁？**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    先以`io.seata.rm.datasource.exec.UpdateExecutor`举例，`UpdateExecutor` extends `AbstractDMLBaseExecutor` extends `BaseTransactionalExecutor`。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    观察`execute()`方法的做了什么</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract class BaseTransactionalExecutor&lt;T, S extends Statement&gt; implements Executor&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected StatementProxy&lt;S&gt; statementProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected StatementCallback&lt;T, S&gt; statementCallback;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected SQLRecognizer sqlRecognizer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public BaseTransactionalExecutor(StatementProxy&lt;S&gt; statementProxy, StatementCallback&lt;T, S&gt; statementCallback,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SQLRecognizer sqlRecognizer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.statementProxy = statementProxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.statementCallback = statementCallback;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.sqlRecognizer = sqlRecognizer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public T execute(Object... args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (xid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                statementProxy.getConnectionProxy().bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            statementProxy.getConnectionProxy().setGlobalLockRequire(RootContext.requireGlobalLock());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return doExecute(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract class AbstractDMLBaseExecutor&lt;T, S extends Statement&gt; extends BaseTransactionalExecutor&lt;T, S&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public AbstractDMLBaseExecutor(StatementProxy&lt;S&gt; statementProxy, StatementCallback&lt;T, S&gt; statementCallback,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               SQLRecognizer sqlRecognizer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            super(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public T doExecute(Object... args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AbstractConnectionProxy connectionProxy = statementProxy.getConnectionProxy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (connectionProxy.getAutoCommit()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return executeAutoCommitTrue(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return executeAutoCommitFalse(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected T executeAutoCommitTrue(Object[] args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConnectionProxy connectionProxy = statementProxy.getConnectionProxy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                connectionProxy.changeAutoCommit(); // 注意，你如果没开启事务，seata帮你开启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new LockRetryPolicy(connectionProxy).execute(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    T result = executeAutoCommitFalse(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    connectionProxy.commit(); // 帮你开启事务后，通过connectionProxy来提交</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // when exception occur in finally,this exception will lost, so just print it here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;execute executeAutoCommitTrue error:{}&quot;, e.getMessage(), e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!LockRetryPolicy.isLockRetryPolicyBranchRollbackOnConflict()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    connectionProxy.getTargetConnection().rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                connectionProxy.getContext().reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                connectionProxy.setAutoCommit(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected T executeAutoCommitFalse(Object[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!JdbcConstants.MYSQL.equalsIgnoreCase(getDbType()) &amp;&amp; isMultiPk()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new NotSupportYetException(&quot;multi pk only support mysql!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TableRecords beforeImage = beforeImage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            T result = statementCallback.execute(statementProxy.getTargetStatement(), args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TableRecords afterImage = afterImage(beforeImage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            prepareUndoLog(beforeImage, afterImage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public class UpdateExecutor&lt;T, S extends Statement&gt; extends AbstractDMLBaseExecutor&lt;T, S&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public UpdateExecutor(StatementProxy&lt;S&gt; statementProxy, StatementCallback&lt;T, S&gt; statementCallback,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            SQLRecognizer sqlRecognizer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            super(statementProxy, statementCallback, sqlRecognizer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 如果选了DML类型Executer，可以在上面的executeAutoCommitFalse()中看到，主要做了以下事情：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - 查询前镜像（select for update，因此此时获得本地锁）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public class UpdateExecutor&lt;T, S extends Statement&gt; extends AbstractDMLBaseExecutor&lt;T, S&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            private static final boolean ONLY_CARE_UPDATE_COLUMNS = CONFIG.getBoolean(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ConfigurationKeys.TRANSACTION_UNDO_ONLY_CARE_UPDATE_COLUMNS, DefaultValues.DEFAULT_ONLY_CARE_UPDATE_COLUMNS); // 默认为true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            protected TableRecords beforeImage() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ArrayList&lt;List&lt;Object&gt;&gt; paramAppenderList = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TableMeta tmeta = getTableMeta();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String selectSQL = buildBeforeImageSQL(tmeta, paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // SELECT id, count FROM storage_tbl WHERE id = ? FOR UPDATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return buildTableRecords(tmeta, selectSQL, paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            private String buildBeforeImageSQL(TableMeta tableMeta, ArrayList&lt;List&lt;Object&gt;&gt; paramAppenderList) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SQLUpdateRecognizer recognizer = (SQLUpdateRecognizer) sqlRecognizer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;String&gt; updateColumns = recognizer.getUpdateColumns();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                StringBuilder prefix = new StringBuilder(&quot;SELECT &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                StringBuilder suffix = new StringBuilder(&quot; FROM &quot;).append(getFromTableInSQL());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String whereCondition = buildWhereCondition(recognizer, paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNotBlank(whereCondition)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    suffix.append(WHERE).append(whereCondition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String orderBy = recognizer.getOrderBy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNotBlank(orderBy)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    suffix.append(orderBy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ParametersHolder parametersHolder = statementProxy instanceof ParametersHolder ? (ParametersHolder)statementProxy : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String limit = recognizer.getLimit(parametersHolder, paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (StringUtils.isNotBlank(limit)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    suffix.append(limit);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                suffix.append(&quot; FOR UPDATE&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                StringJoiner selectSQLJoin = new StringJoiner(&quot;, &quot;, prefix.toString(), suffix.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ONLY_CARE_UPDATE_COLUMNS) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (!containsPK(updateColumns)) {// 如果本次更新的行不包含主键，那select for update的时候加上主键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        selectSQLJoin.add(getColumnNamesInSQL(tableMeta.getEscapePkNameList(getDbType())));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for (String columnName : updateColumns) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        selectSQLJoin.add(columnName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for (String columnName : tableMeta.getAllColumns().keySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        selectSQLJoin.add(ColumnUtils.addEscape(columnName, getDbType()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return selectSQLJoin.toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            protected TableRecords buildTableRecords(TableMeta tableMeta, String selectSQL, ArrayList&lt;List&lt;Object&gt;&gt; paramAppenderList) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ResultSet rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try (PreparedStatement ps = statementProxy.getConnection().prepareStatement(selectSQL)) { // 执行select for update，然后就拿到了本地锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (CollectionUtils.isNotEmpty(paramAppenderList)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        for (int i = 0, ts = paramAppenderList.size(); i &lt; ts; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            List&lt;Object&gt; paramAppender = paramAppenderList.get(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            for (int j = 0, ds = paramAppender.size(); j &lt; ds; j++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                ps.setObject(i * ds + j + 1, paramAppender.get(j));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rs = ps.executeQuery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return TableRecords.buildRecords(tableMeta, rs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    IOUtil.close(rs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - 执行业务sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - 查询后镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public class UpdateExecutor&lt;T, S extends Statement&gt; extends AbstractDMLBaseExecutor&lt;T, S&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            protected TableRecords afterImage(TableRecords beforeImage) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TableMeta tmeta = getTableMeta();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (beforeImage == null || beforeImage.size() == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return TableRecords.empty(getTableMeta());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String selectSQL = buildAfterImageSQL(tmeta, beforeImage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //SELECT id, count FROM storage_tbl WHERE (id) in ( (?) )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ResultSet rs = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try (PreparedStatement pst = statementProxy.getConnection().prepareStatement(selectSQL)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SqlGenerateUtils.setParamForPk(beforeImage.pkRows(), getTableMeta().getPrimaryKeyOnlyName(), pst);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rs = pst.executeQuery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return TableRecords.buildRecords(tmeta, rs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    IOUtil.close(rs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - 准备undoLog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public abstract class BaseTransactionalExecutor&lt;T, S extends Statement&gt; implements Executor&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            protected void prepareUndoLog(TableRecords beforeImage, TableRecords afterImage) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (beforeImage.getRows().isEmpty() &amp;&amp; afterImage.getRows().isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (SQLType.UPDATE == sqlRecognizer.getSQLType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (beforeImage.getRows().size() != afterImage.getRows().size()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new ShouldNeverHappenException(&quot;Before image size is not equaled to after image size, probably because you updated the primary keys.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ConnectionProxy connectionProxy = statementProxy.getConnectionProxy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TableRecords lockKeyRecords = sqlRecognizer.getSQLType() == SQLType.DELETE ? beforeImage : afterImage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String lockKeys = buildLockKey(lockKeyRecords);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (null != lockKeys) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    connectionProxy.appendLockKey(lockKeys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SQLUndoLog sqlUndoLog = buildUndoItem(beforeImage, afterImage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    connectionProxy.appendUndoLog(sqlUndoLog); // 把undoLog存到connectionProxy中，具体怎么回事上面有提过</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 如果你的sql是select for update则会使用`SelectForUpdateExecutor`（Seata代理了select for update），代理后处理的逻辑是这样的：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -  先执行 select for update（获取数据库本地锁）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -  如果处于`@GlobalTransactional` or `@GlobalLock`，**检查**是否有全局锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -  如果有全局锁，则未开启本地事务下会rollback本地事务，再重新争抢本地锁和查询全局锁，直到全局锁释放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       public class SelectForUpdateExecutor&lt;T, S extends Statement&gt; extends BaseTransactionalExecutor&lt;T, S&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public T doExecute(Object... args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Connection conn = statementProxy.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    DatabaseMetaData dbmd = conn.getMetaData();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    T rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Savepoint sp = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boolean originalAutoCommit = conn.getAutoCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (originalAutoCommit) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             * In order to hold the local db lock during global lock checking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             * set auto commit value to false first if original auto commit was true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            conn.setAutoCommit(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else if (dbmd.supportsSavepoints()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             * In order to release the local db lock when global lock conflict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             * create a save point if original auto commit was false, then use the save point here to release db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             * lock during global lock checking if necessary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            sp = conn.setSavepoint();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            throw new SQLException(&quot;not support savepoint. please check your db version&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LockRetryController lockRetryController = new LockRetryController();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ArrayList&lt;List&lt;Object&gt;&gt; paramAppenderList = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String selectPKSQL = buildSelectSQL(paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // #870</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // execute return Boolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // executeQuery return ResultSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                rs = statementCallback.execute(statementProxy.getTargetStatement(), args); //执行 select for update（获取数据库本地锁）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // Try to get global lock of those rows selected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                TableRecords selectPKRows = buildTableRecords(getTableMeta(), selectPKSQL, paramAppenderList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                String lockKeys = buildLockKey(selectPKRows);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (StringUtils.isNullOrEmpty(lockKeys)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (RootContext.inGlobalTransaction() || RootContext.requireGlobalLock()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    // Do the same thing under either @GlobalTransactional or @GlobalLock, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    // that only check the global lock  here.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    statementProxy.getConnectionProxy().checkLock(lockKeys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    throw new RuntimeException(&quot;Unknown situation!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } catch (LockConflictException lce) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (sp != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    conn.rollback(sp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    conn.rollback();// 回滚，释放本地锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                // trigger retry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                lockRetryController.sleep(lce);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (sp != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (!JdbcConstants.ORACLE.equalsIgnoreCase(getDbType())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    conn.releaseSavepoint(sp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } catch (SQLException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                LOGGER.error(&quot;{} release save point error.&quot;, getDbType(), e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (originalAutoCommit) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            conn.setAutoCommit(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="connectionproxycommit的处理逻辑-1"><strong><code>ConnectionProxy.commit()</code>的处理逻辑</strong><a href="#connectionproxycommit的处理逻辑-1" class="hash-link" aria-label="connectionproxycommit的处理逻辑-1的直接链接" title="connectionproxycommit的处理逻辑-1的直接链接">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final static LockRetryPolicy LOCK_RETRY_POLICY = new LockRetryPolicy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void commit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOCK_RETRY_POLICY.execute(() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                doCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (targetConnection != null &amp;&amp; !getAutoCommit() &amp;&amp; !getContext().isAutoCommitChanged()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SQLException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void doCommit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (context.inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            processGlobalTransactionCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (context.isGlobalLockRequire()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            processLocalCommitWithGlobalLocks();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>也在这打下个疑问，后边解释。<br>
<strong><code>ConnectionProxy</code>里的<code>ConnectionContext</code>是如何判断<code>inGlobalTransaction()</code> or <code>isGlobalLockRequire()</code>的呢？</strong></p></blockquote><ul><li><p>处于全局事务中（即，数据持久化方法带有<code>@GlobalTransactional</code>）</p><ul><li><p>注册分支事务，获取全局锁</p></li><li><p>undoLog数据入库</p></li><li><p>让数据库commit本次事务</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final static LockRetryPolicy LOCK_RETRY_POLICY = new LockRetryPolicy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void processGlobalTransactionCommit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                register(); // 注册分支，争全局锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (TransactionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                recognizeLockKeyConflictException(e, context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                UndoLogManagerFactory.getUndoLogManager(this.getDbType()).flushUndoLogs(this); // undolog入库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                targetConnection.commit(); // 分支事务提交</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;process connectionProxy commit error: {}&quot;, ex.getMessage(), ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                report(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (IS_REPORT_SUCCESS_ENABLE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                report(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void register() throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!context.hasUndoLog() || !context.hasLockKey()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Long branchId = DefaultResourceManager.get().branchRegister(BranchType.AT, getDataSourceProxy().getResourceId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                null, context.getXid(), null, context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.setBranchId(branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>处于<code>@GlobalLock</code>中（即，数据持久化方法带有<code>@GlobalLock</code>）</p><ul><li><p>向tc查询是否有全局锁存在</p></li><li><p>让数据库commit本次事务</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       private final static LockRetryPolicy LOCK_RETRY_POLICY = new LockRetryPolicy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       private void processLocalCommitWithGlobalLocks() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           checkLock(context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               throw new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           context.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       public void checkLock(String lockKeys) throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           if (StringUtils.isBlank(lockKeys)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // Just check lock without requiring lock by now.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               boolean lockable = DefaultResourceManager.get().lockQuery(BranchType.AT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   getDataSourceProxy().getResourceId(), context.getXid(), lockKeys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               if (!lockable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   throw new LockConflictException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           } catch (TransactionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               recognizeLockKeyConflictException(e, lockKeys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>除了以上情况（<code>else</code>分支）<ul><li>让数据库commit本次事务</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="介绍rootcontext">介绍<code>RootContext</code><a href="#介绍rootcontext" class="hash-link" aria-label="介绍rootcontext的直接链接" title="介绍rootcontext的直接链接">​</a></h2><p>我们在上面留下了3个“扣儿”，现在到了结合<code>RootContext</code>源码来解答的时候。</p><ol><li><p><strong><code>RootContext.getBranchType()</code>的返回值怎么会是AT？</strong><br>
<!-- -->该方法的判断逻辑是：只要判断出<strong>当前处于全局事务中</strong>（即，只要有地方调用过<code>RootContext.bind(xid)</code>）, 就会返回默认<code>BranchType.AT</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class RootContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String KEY_XID = &quot;TX_XID&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static ContextCore CONTEXT_HOLDER = ContextCoreLoader.load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static BranchType DEFAULT_BRANCH_TYPE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BranchType getBranchType() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BranchType branchType = (BranchType) CONTEXT_HOLDER.get(KEY_BRANCH_TYPE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (branchType != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return branchType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Returns the default branch type.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return DEFAULT_BRANCH_TYPE != null ? DEFAULT_BRANCH_TYPE : BranchType.AT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static boolean inGlobalTransaction() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return CONTEXT_HOLDER.get(KEY_XID) != null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void bind(@Nonnull String xid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isBlank(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.debug(&quot;xid is blank, switch to unbind operation!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MDC.put(MDC_KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.debug(&quot;bind {}&quot;, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CONTEXT_HOLDER.put(KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong><code>RootContext.requireGlobalLock()</code>怎么判断当前是否需要全局锁？</strong><br>
<!-- -->需要有地方调用<code>RootContext.bindGlobalLockFlag()</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class RootContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String KEY_GLOBAL_LOCK_FLAG = &quot;TX_LOCK&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final Boolean VALUE_GLOBAL_LOCK_FLAG = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static ContextCore CONTEXT_HOLDER = ContextCoreLoader.load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static boolean requireGlobalLock() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return CONTEXT_HOLDER.get(KEY_GLOBAL_LOCK_FLAG) != null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void bindGlobalLockFlag() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug(&quot;Local Transaction Global Lock support enabled&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //just put something not null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CONTEXT_HOLDER.put(KEY_GLOBAL_LOCK_FLAG, VALUE_GLOBAL_LOCK_FLAG);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong><code>ConnectionProxy.commit()</code>会根据context的不同状态区分处理，那<code>ConnectionContext</code>是如何判断<code>inGlobalTransaction()</code> or <code>isGlobalLockRequire()</code>的呢？</strong></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void doCommit() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (context.inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            processGlobalTransactionCommit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (context.isGlobalLockRequire()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            processLocalCommitWithGlobalLocks();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>如何判断<code>inGlobalTransaction()</code>？（注意下，这里和上面提到的<code>RootContext</code>不是一个东西）</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String xid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setXid(String xid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.xid = xid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean inGlobalTransaction() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return xid != null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void bind(String xid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException(&quot;xid should not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!inGlobalTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            setXid(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!this.xid.equals(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new ShouldNeverHappenException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪里调用的<code>ConnectionContext.bind(xid)</code>?</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.rm.datasource.exec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class BaseTransactionalExecutor&lt;T, S extends Statement&gt; implements Executor&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public T execute(Object... args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 那么，这里的XID哪来的呢？往后看就知道，是来自开启全局事务的时候获得的，和@GlobalTransactional有关</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID(); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            statementProxy.getConnectionProxy().bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这里就是设置 isGlobalLockRequire的位置，和 @GlobalLock有关</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        statementProxy.getConnectionProxy().setGlobalLockRequire(RootContext.requireGlobalLock());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return doExecute(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionProxy extends AbstractConnectionProxy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   private ConnectionContext context = new ConnectionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void bind(String xid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setGlobalLockRequire(boolean isLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setGlobalLockRequire(isLock);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>如何判断<code>isGlobalLockRequire()</code>？</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConnectionContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isGlobalLockRequire;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isGlobalLockRequire() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       return isGlobalLockRequire;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setGlobalLockRequire(boolean isGlobalLockRequire) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.isGlobalLockRequire = isGlobalLockRequire;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在看过代码后，我们知道，只要有地方在<code>RootContext</code>中设置了xid，或<code>bindGlobalLockFlag()</code>,就会识别成不同的状态。
那么哪儿调用的呢？答案就在下方的<code>GlobalTransactionalInterceptor</code>中。</p></li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="globaltransactionalinterceptor处理带有globaltransactional或globallock的方法"><strong><code>GlobalTransactionalInterceptor</code>处理带有<code>@GlobalTransactional</code>或<code>@GlobalLock</code>的方法</strong><a href="#globaltransactionalinterceptor处理带有globaltransactional或globallock的方法" class="hash-link" aria-label="globaltransactionalinterceptor处理带有globaltransactional或globallock的方法的直接链接" title="globaltransactionalinterceptor处理带有globaltransactional或globallock的方法的直接链接">​</a></h2><p>带有<code>@GlobalTransactional</code>和<code>@GlobalLock</code>的方法会被代理，交给<code>GlobalTransactionalInterceptor</code>处理</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionalInterceptor implements ConfigurationChangeListener, MethodInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object invoke(final MethodInvocation methodInvocation) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; targetClass =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis()) : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (specificMethod != null &amp;&amp; !specificMethod.getDeclaringClass().equals(Object.class)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final GlobalTransactional globalTransactionalAnnotation =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                getAnnotation(method, targetClass, GlobalTransactional.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final GlobalLock globalLockAnnotation = getAnnotation(method, targetClass, GlobalLock.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean localDisable = disable || (degradeCheck &amp;&amp; degradeNum &gt;= degradeCheckAllowTimes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!localDisable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (globalTransactionalAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);// 处理 @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (globalLockAnnotation != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return handleGlobalLock(methodInvocation, globalLockAnnotation); // 处理 @GlobalLock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return methodInvocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="先看处理globaltransactional"><strong>先看处理<code>@GlobalTransactional</code></strong><a href="#先看处理globaltransactional" class="hash-link" aria-label="先看处理globaltransactional的直接链接" title="先看处理globaltransactional的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionalInterceptor implements ConfigurationChangeListener, MethodInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final TransactionalTemplate transactionalTemplate = new TransactionalTemplate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object handleGlobalTransaction(final MethodInvocation methodInvocation,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final GlobalTransactional globalTrxAnno) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return transactionalTemplate.execute(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionalExecutor.ExecutionException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>来到了经典的seata事务模板方法，我们要关注开启事务的部分</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class TransactionalTemplate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object execute(TransactionalExecutor business) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Get transactionInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.1 Get current transaction, if not null, the tx role is &#x27;GlobalTransactionRole.Participant&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GlobalTransaction tx = GlobalTransactionContext.getCurrent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.2 Handle the transaction propagation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1.3 If null, create new transaction with role &#x27;GlobalTransactionRole.Launcher&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tx == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tx = GlobalTransactionContext.createNew();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 2. If the tx role is &#x27;GlobalTransactionRole.Launcher&#x27;, send the request of beginTransaction to TC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //    else do nothing. Of course, the hooks will still be triggered.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                beginTransaction(txInfo, tx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Do Your Business</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    rs = business.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 3. The needed business exception to rollback.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    completeTransactionAfterThrowing(txInfo, tx, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 4. everything is fine, commit.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                commitTransaction(tx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return rs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //5. clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // If the transaction is suspended, resume it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void beginTransaction(TransactionInfo txInfo, GlobalTransaction tx) throws TransactionalExecutor.ExecutionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerBeforeBegin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.begin(txInfo.getTimeOut(), txInfo.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggerAfterBegin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionException txe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new TransactionalExecutor.ExecutionException(tx, txe,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TransactionalExecutor.Code.BeginFailure);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class DefaultGlobalTransaction implements GlobalTransaction {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void begin(int timeout, String name) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (role != GlobalTransactionRole.Launcher) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            assertXIDNotNull();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.debug(&quot;Ignore Begin(): just involved in global transaction [{}]&quot;, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assertXIDNull();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String currentXid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (currentXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(&quot;Global transaction already exists,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot; can&#x27;t begin a new global transaction, currentXid = &quot; + currentXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xid = transactionManager.begin(null, null, name, timeout);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        status = GlobalStatus.Begin;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RootContext.bind(xid); // 绑定xid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isInfoEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;Begin new global transaction [{}]&quot;, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>看到了吗？<code>RootContext.bind(xid);</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="接着看处理globallock"><strong>接着看处理<code>@GlobalLock</code></strong><a href="#接着看处理globallock" class="hash-link" aria-label="接着看处理globallock的直接链接" title="接着看处理globallock的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionalInterceptor implements ConfigurationChangeListener, MethodInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final GlobalLockTemplate globalLockTemplate = new GlobalLockTemplate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object handleGlobalLock(final MethodInvocation methodInvocation,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final GlobalLock globalLockAnno) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return globalLockTemplate.execute(new GlobalLockExecutor() {...});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>也使用了模板方法来处理GlobalLock</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalLockTemplate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object execute(GlobalLockExecutor executor) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean alreadyInGlobalLock = RootContext.requireGlobalLock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!alreadyInGlobalLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RootContext.bindGlobalLockFlag();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set my config to config holder so that it can be access in further execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // for example, LockRetryController can access it with config holder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GlobalLockConfig myConfig = executor.getGlobalLockConfig();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GlobalLockConfig previousConfig = GlobalLockConfigHolder.setAndReturnPrevious(myConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return executor.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // only unbind when this is the root caller.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // otherwise, the outer caller would lose global lock flag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!alreadyInGlobalLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.unbindGlobalLockFlag();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // if previous config is not null, we need to set it back</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // so that the outer logic can still use their config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (previousConfig != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalLockConfigHolder.setAndReturnPrevious(previousConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GlobalLockConfigHolder.remove();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>看到吗，一进模板方法就<code>RootContext.bindGlobalLockFlag();</code></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#从代理数据源说起" class="table-of-contents__link toc-highlight">从代理数据源说起</a><ul><li><a href="#statementproxyexecutexxx的处理逻辑" class="table-of-contents__link toc-highlight"><strong><code>StatementProxy.executeXXX()</code>的处理逻辑</strong></a></li><li><a href="#connectionproxycommit的处理逻辑" class="table-of-contents__link toc-highlight"><strong><code>ConnectionProxy.commit()</code>的处理逻辑</strong></a></li><li><a href="#globaltransactional的作用" class="table-of-contents__link toc-highlight"><strong>@GlobalTransactional的作用</strong></a></li><li><a href="#globallock--select-for-update的作用" class="table-of-contents__link toc-highlight"><strong>@GlobalLock + select for update的作用</strong></a></li></ul></li><li><a href="#先举一个脏写的例子再来看seata如何防止脏写" class="table-of-contents__link toc-highlight">先举一个脏写的例子，再来看Seata如何防止脏写</a></li><li><a href="#怎么用seata防止脏写" class="table-of-contents__link toc-highlight"><strong>怎么用Seata防止脏写？</strong></a><ul><li><a href="#办法一updatea也加上globaltransactional此时seata会如何保证事务隔离" class="table-of-contents__link toc-highlight">办法一：<code>updateA()</code>也加上<code>@GlobalTransactional</code>，此时Seata会如何保证事务隔离？</a></li><li><a href="#办法二-globallock--select-for-update" class="table-of-contents__link toc-highlight">办法二： <strong>@GlobalLock + select for update</strong></a></li></ul></li><li><a href="#如何防止脏读" class="table-of-contents__link toc-highlight"><strong>如何防止脏读？</strong></a><ul><li><a href="#场景---某业务先调用updateallupdateall未执行完成另一业务后调用querya" class="table-of-contents__link toc-highlight">场景：   某业务先调用<code>updateAll()</code>，<code>updateAll()</code>未执行完成，另一业务后调用<code>queryA()</code></a></li></ul></li><li><a href="#datasourceproxy的作用" class="table-of-contents__link toc-highlight"><strong>DataSourceProxy的作用</strong></a></li><li><a href="#通过connectionproxypreparestatement获得statementproxy" class="table-of-contents__link toc-highlight"><strong>通过<code>ConnectionProxy.prepareStatement(...)</code>获得<code>StatementProxy</code></strong></a></li><li><a href="#statementproxyexecute的处理逻辑" class="table-of-contents__link toc-highlight"><strong><code>StatementProxy.execute()</code>的处理逻辑</strong></a></li><li><a href="#connectionproxycommit的处理逻辑-1" class="table-of-contents__link toc-highlight"><strong><code>ConnectionProxy.commit()</code>的处理逻辑</strong></a></li><li><a href="#介绍rootcontext" class="table-of-contents__link toc-highlight">介绍<code>RootContext</code></a></li><li><a href="#globaltransactionalinterceptor处理带有globaltransactional或globallock的方法" class="table-of-contents__link toc-highlight"><strong><code>GlobalTransactionalInterceptor</code>处理带有<code>@GlobalTransactional</code>或<code>@GlobalLock</code>的方法</strong></a><ul><li><a href="#先看处理globaltransactional" class="table-of-contents__link toc-highlight"><strong>先看处理<code>@GlobalTransactional</code></strong></a></li><li><a href="#接着看处理globallock" class="table-of-contents__link toc-highlight"><strong>接着看处理<code>@GlobalLock</code></strong></a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">愿景</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/">Seata 是一款阿里巴巴开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。</a></li></ul></div><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/overview/what-is-seata">Seata是什么？</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/user/quickstart">快速开始</a></li><li class="footer__item"><a href="https://github.com/seata/seata.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">报告文档问题<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/seata/seata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">在GitHub上编辑此文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/community">社区</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="//img.alicdn.com/tfs/TB1dGrSwVT7gK0jSZFpXXaTkpXa-4802-1285.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="120" height="36"><img src="//img.alicdn.com/tfs/TB1dGrSwVT7gK0jSZFpXXaTkpXa-4802-1285.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="120" height="36"></div><div class="footer__copyright">Copyright © 2023 Seata</div></div></div></footer></div>
<script src="/zh-cn/assets/js/runtime~main.71f2148b.js"></script>
<script src="/zh-cn/assets/js/main.eaa3efae.js"></script>
</body>
</html>