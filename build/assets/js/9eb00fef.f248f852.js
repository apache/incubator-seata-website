"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[6342],{3905:(e,a,t)=>{t.d(a,{Zo:()=>p,kt:()=>g});var n=t(67294);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function o(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function c(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?o(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function i(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)t=o[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)t=o[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=n.createContext({}),s=function(e){var a=n.useContext(l),t=a;return e&&(t="function"==typeof e?e(a):c(c({},a),e)),t},p=function(e){var a=s(e.components);return n.createElement(l.Provider,{value:a},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},m=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=s(t),m=r,g=u["".concat(l,".").concat(m)]||u[m]||d[m]||o;return t?n.createElement(g,c(c({ref:a},p),{},{components:t})):n.createElement(g,c({ref:a},p))}));function g(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var o=t.length,c=new Array(o);c[0]=m;var i={};for(var l in a)hasOwnProperty.call(a,l)&&(i[l]=a[l]);i.originalType=e,i[u]="string"==typeof e?e:r,c[1]=i;for(var s=2;s<o;s++)c[s]=t[s];return n.createElement.apply(null,c)}return n.createElement.apply(null,t)}m.displayName="MDXCreateElement"},91811:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>l,contentTitle:()=>c,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>s});var n=t(87462),r=(t(67294),t(3905));const o={title:"\u5206\u5e03\u5f0f\u4e8b\u52a1\u4e4bSeata-Client\u539f\u7406\u53ca\u6d41\u7a0b\u8be6\u89e3",author:"fangliangsheng",date:"2019/04/15",keywords:["fescar\u3001seata\u3001\u5206\u5e03\u5f0f\u4e8b\u52a1"]},c=void 0,i={permalink:"/blog/seata-analysis-java-client",source:"@site/blog/seata-analysis-java-client.md",title:"\u5206\u5e03\u5f0f\u4e8b\u52a1\u4e4bSeata-Client\u539f\u7406\u53ca\u6d41\u7a0b\u8be6\u89e3",description:"\u524d\u8a00",date:"2019-04-15T00:00:00.000Z",formattedDate:"April 15, 2019",tags:[],readingTime:25.585,hasTruncateMarker:!1,authors:[{name:"fangliangsheng"}],frontMatter:{title:"\u5206\u5e03\u5f0f\u4e8b\u52a1\u4e4bSeata-Client\u539f\u7406\u53ca\u6d41\u7a0b\u8be6\u89e3",author:"fangliangsheng",date:"2019/04/15",keywords:["fescar\u3001seata\u3001\u5206\u5e03\u5f0f\u4e8b\u52a1"]},prevItem:{title:"Seata\uff08Fescar\uff09\u5206\u5e03\u5f0f\u4e8b\u52a1 \u6574\u5408 Spring Cloud",permalink:"/blog/integrate-seata-with-spring-cloud"},nextItem:{title:"\u6df1\u5ea6\u5256\u6790\u4e00\u7ad9\u5f0f\u5206\u5e03\u5f0f\u4e8b\u52a1\u65b9\u6848Seata-Server",permalink:"/blog/seata-analysis-java-server"}},l={authorsImageUrls:[void 0]},s=[{value:"\u524d\u8a00",id:"\u524d\u8a00",level:2},{value:"\u76f8\u5173\u6982\u5ff5",id:"\u76f8\u5173\u6982\u5ff5",level:2},{value:"\u5206\u5e03\u5f0f\u6846\u67b6\u652f\u6301",id:"\u5206\u5e03\u5f0f\u6846\u67b6\u652f\u6301",level:2},{value:"\u4e1a\u52a1\u903b\u8f91",id:"\u4e1a\u52a1\u903b\u8f91",level:2},{value:"\u914d\u7f6e\u6587\u4ef6",id:"\u914d\u7f6e\u6587\u4ef6",level:2},{value:"\u6570\u636e\u6e90Proxy",id:"\u6570\u636e\u6e90proxy",level:2},{value:"\u542f\u52a8Server",id:"\u542f\u52a8server",level:2},{value:"\u542f\u52a8Client",id:"\u542f\u52a8client",level:2},{value:"TM\u5904\u7406\u6d41\u7a0b",id:"tm\u5904\u7406\u6d41\u7a0b",level:2},{value:"RM\u5904\u7406\u6d41\u7a0b",id:"rm\u5904\u7406\u6d41\u7a0b",level:2},{value:"\u4e8b\u52a1\u63d0\u4ea4",id:"\u4e8b\u52a1\u63d0\u4ea4",level:2},{value:"\u4e8b\u52a1\u56de\u6eda",id:"\u4e8b\u52a1\u56de\u6eda",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}],p={toc:s},u="wrapper";function d(e){let{components:a,...o}=e;return(0,r.kt)(u,(0,n.Z)({},p,o,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"\u524d\u8a00"},"\u524d\u8a00"),(0,r.kt)("p",null,"\u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\uff0c\u5206\u5e03\u5f0f\u4e8b\u52a1\u662f\u4e00\u4e2a\u5fc5\u987b\u8981\u89e3\u51b3\u7684\u95ee\u9898\uff0c\u76ee\u524d\u4f7f\u7528\u8f83\u591a\u7684\u662f\u6700\u7ec8\u4e00\u81f4\u6027\u65b9\u6848\u3002\u81ea\u5e74\u521d\u963f\u91cc\u5f00\u6e90\u4e86Fescar\uff08\u56db\u6708\u521d\u66f4\u540d\u4e3aSeata\uff09\u540e\uff0c\u8be5\u9879\u76ee\u53d7\u5230\u4e86\u6781\u5927\u7684\u5173\u6ce8\u5ea6\uff0c\u76ee\u524d\u5df2\u63a5\u8fd18000Star\u3002",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata"},"Seata"),"\u4ee5\u9ad8\u6027\u80fd\u548c\u96f6\u4fb5\u5165\u7684\u65b9\u5f0f\u4e3a\u76ee\u6807\u89e3\u51b3\u5fae\u670d\u52a1\u9886\u57df\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\u96be\u9898\uff0c\u76ee\u524d\u6b63\u5904\u4e8e\u5feb\u901f\u8fed\u4ee3\u4e2d\uff0c\u8fd1\u671f\u5c0f\u76ee\u6807\u662f\u751f\u4ea7\u53ef\u7528\u7684Mysql\u7248\u672c\u3002\u5173\u4e8eSeata\u7684\u603b\u4f53\u4ecb\u7ecd\uff0c\u53ef\u4ee5\u67e5\u770b",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/wiki/%E6%A6%82%E8%A7%88"},"\u5b98\u65b9WIKI"),"\u83b7\u5f97\u66f4\u591a\u66f4\u5168\u9762\u7684\u5185\u5bb9\u4ecb\u7ecd\u3002"),(0,r.kt)("p",null,"\u672c\u6587\u4e3b\u8981\u57fa\u4e8espring cloud+spring jpa+spring cloud alibaba fescar+mysql+seata\u7684\u7ed3\u6784\uff0c\u642d\u5efa\u4e00\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684demo\uff0c\u901a\u8fc7seata\u7684debug\u65e5\u5fd7\u548c\u6e90\u4ee3\u7801\uff0c\u4ececlient\u7aef\uff08RM\u3001TM\uff09\u7684\u89d2\u5ea6\u5206\u6790\u8bf4\u660e\u5176\u5de5\u4f5c\u6d41\u7a0b\u53ca\u539f\u7406\u3002"),(0,r.kt)("p",null,"\u6587\u4e2d\u4ee3\u7801\u57fa\u4e8efescar-0.4.1\uff0c\u7531\u4e8e\u9879\u76ee\u521a\u66f4\u540d\u4e3aseata\u4e0d\u4e45\uff0c\u4f8b\u5982\u4e00\u4e9b\u5305\u540d\u3001\u7c7b\u540d\u3001jar\u5305\u540d\u79f0\u8fd8\u90fd\u662ffescar\u7684\u547d\u540d\uff0c\u6545\u4e0b\u6587\u4e2d\u4ecd\u4f7f\u7528fescar\u8fdb\u884c\u8868\u8ff0\u3002"),(0,r.kt)("p",null,"\u793a\u4f8b\u9879\u76ee\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fescar-group/fescar-samples/tree/master/springcloud-jpa-seata"},"https://github.com/fescar-group/fescar-samples/tree/master/springcloud-jpa-seata")),(0,r.kt)("h2",{id:"\u76f8\u5173\u6982\u5ff5"},"\u76f8\u5173\u6982\u5ff5"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"XID\uff1a\u5168\u5c40\u4e8b\u52a1\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u7531ip:port:sequence\u7ec4\u6210"),(0,r.kt)("li",{parentName:"ul"},"Transaction Coordinator (TC)\uff1a\u4e8b\u52a1\u534f\u8c03\u5668\uff0c\u7ef4\u62a4\u5168\u5c40\u4e8b\u52a1\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u8d1f\u8d23\u534f\u8c03\u5e76\u9a71\u52a8\u5168\u5c40\u4e8b\u52a1\u7684\u63d0\u4ea4\u6216\u56de\u6eda"),(0,r.kt)("li",{parentName:"ul"},"Transaction Manager (TM )\uff1a\u63a7\u5236\u5168\u5c40\u4e8b\u52a1\u7684\u8fb9\u754c\uff0c\u8d1f\u8d23\u5f00\u542f\u4e00\u4e2a\u5168\u5c40\u4e8b\u52a1\uff0c\u5e76\u6700\u7ec8\u53d1\u8d77\u5168\u5c40\u63d0\u4ea4\u6216\u5168\u5c40\u56de\u6eda\u7684\u51b3\u8bae"),(0,r.kt)("li",{parentName:"ul"},"Resource Manager (RM)\uff1a\u63a7\u5236\u5206\u652f\u4e8b\u52a1\uff0c\u8d1f\u8d23\u5206\u652f\u6ce8\u518c\u3001\u72b6\u6001\u6c47\u62a5\uff0c\u5e76\u63a5\u6536\u4e8b\u52a1\u534f\u8c03\u5668\u7684\u6307\u4ee4\uff0c\u9a71\u52a8\u5206\u652f\uff08\u672c\u5730\uff09\u4e8b\u52a1\u7684\u63d0\u4ea4\u548c\u56de\u6eda")),(0,r.kt)("h2",{id:"\u5206\u5e03\u5f0f\u6846\u67b6\u652f\u6301"},"\u5206\u5e03\u5f0f\u6846\u67b6\u652f\u6301"),(0,r.kt)("p",null,"Fescar\u4f7f\u7528XID\u8868\u793a\u4e00\u4e2a\u5206\u5e03\u5f0f\u4e8b\u52a1\uff0cXID\u9700\u8981\u5728\u4e00\u6b21\u5206\u5e03\u5f0f\u4e8b\u52a1\u8bf7\u6c42\u6240\u6d89\u7684\u7cfb\u7edf\u4e2d\u8fdb\u884c\u4f20\u9012\uff0c\u4ece\u800c\u5411feacar-server\u53d1\u9001\u5206\u652f\u4e8b\u52a1\u7684\u5904\u7406\u60c5\u51b5\uff0c\u4ee5\u53ca\u63a5\u6536feacar-server\u7684commit\u3001rollback\u6307\u4ee4\u3002\nFescar\u5b98\u65b9\u5df2\u652f\u6301\u5168\u7248\u672c\u7684dubbo\u534f\u8bae\uff0c\u800c\u5bf9\u4e8espring cloud\uff08spring-boot\uff09\u7684\u5206\u5e03\u5f0f\u9879\u76ee\u793e\u533a\u4e5f\u63d0\u4f9b\u4e86\u76f8\u5e94\u7684\u5b9e\u73b0"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-alibaba-fescar</artifactId>\n    <version>2.1.0.BUILD-SNAPSHOT</version>\n</dependency>\n")),(0,r.kt)("p",null,"\u8be5\u7ec4\u4ef6\u5b9e\u73b0\u4e86\u57fa\u4e8eRestTemplate\u3001Feign\u901a\u4fe1\u65f6\u7684XID\u4f20\u9012\u529f\u80fd\u3002"),(0,r.kt)("h2",{id:"\u4e1a\u52a1\u903b\u8f91"},"\u4e1a\u52a1\u903b\u8f91"),(0,r.kt)("p",null,"\u4e1a\u52a1\u903b\u8f91\u662f\u7ecf\u5178\u7684\u4e0b\u8ba2\u5355\u3001\u6263\u4f59\u989d\u3001\u51cf\u5e93\u5b58\u6d41\u7a0b\u3002\n\u6839\u636e\u6a21\u5757\u5212\u5206\u4e3a\u4e09\u4e2a\u72ec\u7acb\u7684\u670d\u52a1\uff0c\u4e14\u5206\u522b\u8fde\u63a5\u5bf9\u5e94\u7684\u6570\u636e\u5e93"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u8ba2\u5355\uff1aorder-server"),(0,r.kt)("li",{parentName:"ul"},"\u8d26\u6237\uff1aaccount-server"),(0,r.kt)("li",{parentName:"ul"},"\u5e93\u5b58\uff1astorage-server")),(0,r.kt)("p",null,"\u53e6\u5916\u8fd8\u6709\u53d1\u8d77\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u4e1a\u52a1\u7cfb\u7edf"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4e1a\u52a1\uff1abusiness-server")),(0,r.kt)("p",null,"\u9879\u76ee\u7ed3\u6784\u5982\u4e0b\u56fe\n",(0,r.kt)("img",{alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0",src:t(73930).Z,width:"1034",height:"658"})),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u6b63\u5e38\u4e1a\u52a1")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"business\u53d1\u8d77\u8d2d\u4e70\u8bf7\u6c42"),(0,r.kt)("li",{parentName:"ol"},"storage\u6263\u51cf\u5e93\u5b58"),(0,r.kt)("li",{parentName:"ol"},"order\u521b\u5efa\u8ba2\u5355"),(0,r.kt)("li",{parentName:"ol"},"account\u6263\u51cf\u4f59\u989d")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u5f02\u5e38\u4e1a\u52a1")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"business\u53d1\u8d77\u8d2d\u4e70\u8bf7\u6c42"),(0,r.kt)("li",{parentName:"ol"},"storage\u6263\u51cf\u5e93\u5b58"),(0,r.kt)("li",{parentName:"ol"},"order\u521b\u5efa\u8ba2\u5355"),(0,r.kt)("li",{parentName:"ol"},"account",(0,r.kt)("inlineCode",{parentName:"li"},"\u6263\u51cf\u4f59\u989d\u5f02\u5e38"))),(0,r.kt)("p",null,"\u6b63\u5e38\u6d41\u7a0b\u4e0b2\u30013\u30014\u6b65\u7684\u6570\u636e\u6b63\u5e38\u66f4\u65b0\u5168\u5c40commit\uff0c\u5f02\u5e38\u6d41\u7a0b\u4e0b\u7684\u6570\u636e\u5219\u7531\u4e8e\u7b2c4\u6b65\u7684\u5f02\u5e38\u62a5\u9519\u5168\u5c40\u56de\u6eda\u3002"),(0,r.kt)("h2",{id:"\u914d\u7f6e\u6587\u4ef6"},"\u914d\u7f6e\u6587\u4ef6"),(0,r.kt)("p",null,"fescar\u7684\u914d\u7f6e\u5165\u53e3\u6587\u4ef6\u662f",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/config/src/main/resources/registry.conf"},"registry.conf"),",\u67e5\u770b\u4ee3\u7801",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/config/src/main/java/com/alibaba/fescar/config/ConfigurationFactory.java"},"ConfigurationFactory"),"\u5f97\u77e5\u76ee\u524d\u8fd8\u4e0d\u80fd\u6307\u5b9a\u8be5\u914d\u7f6e\u6587\u4ef6\uff0c\u6240\u4ee5\u914d\u7f6e\u6587\u4ef6\u540d\u79f0\u53ea\u80fd\u4e3aregistry.conf"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'private static final String REGISTRY_CONF = "registry.conf";\npublic static final Configuration FILE_INSTANCE = new FileConfiguration(REGISTRY_CONF);\n')),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"registry"),"\u4e2d\u53ef\u4ee5\u6307\u5b9a\u5177\u4f53\u914d\u7f6e\u7684\u5f62\u5f0f\uff0c\u9ed8\u8ba4\u4f7f\u7528file\u7c7b\u578b\uff0c\u5728file.conf\u4e2d\u67093\u90e8\u5206\u914d\u7f6e\u5185\u5bb9"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"transport\ntransport\u90e8\u5206\u7684\u914d\u7f6e\u5bf9\u5e94",(0,r.kt)("a",{parentName:"li",href:"https://github.com/seata/seata/blob/develop/core/src/main/java/com/alibaba/fescar/core/rpc/netty/NettyServerConfig.java"},"NettyServerConfig"),"\u7c7b\uff0c\u7528\u4e8e\u5b9a\u4e49Netty\u76f8\u5173\u7684\u53c2\u6570\uff0cTM\u3001RM\u4e0efescar-server\u4e4b\u95f4\u4f7f\u7528Netty\u8fdb\u884c\u901a\u4fe1"),(0,r.kt)("li",{parentName:"ol"},"service")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'     service {\n      #vgroup->rgroup\n      vgroup_mapping.my_test_tx_group = "default"\n      #\u914d\u7f6eClient\u8fde\u63a5TC\u7684\u5730\u5740\n      default.grouplist = "127.0.0.1:8091"\n      #degrade current not support\n      enableDegrade = false\n      #disable\n      \u662f\u5426\u542f\u7528seata\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\n      disableGlobalTransaction = false\n    }\n')),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"client")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"    client {\n      #RM\u63a5\u6536TC\u7684commit\u901a\u77e5\u540e\u7f13\u51b2\u4e0a\u9650\n      async.commit.buffer.limit = 10000\n      lock {\n        retry.internal = 10\n        retry.times = 30\n      }\n    }\n")),(0,r.kt)("h2",{id:"\u6570\u636e\u6e90proxy"},"\u6570\u636e\u6e90Proxy"),(0,r.kt)("p",null,"\u9664\u4e86\u524d\u9762\u7684\u914d\u7f6e\u6587\u4ef6\uff0cfescar\u5728AT\u6a21\u5f0f\u4e0b\u7a0d\u5fae\u6709\u70b9\u4ee3\u7801\u91cf\u7684\u5730\u65b9\u5c31\u662f\u5bf9\u6570\u636e\u6e90\u7684\u4ee3\u7406\u6307\u5b9a\uff0c\u4e14\u76ee\u524d\u53ea\u80fd\u57fa\u4e8e",(0,r.kt)("inlineCode",{parentName:"p"},"DruidDataSource"),"\u7684\u4ee3\u7406\u3002\n\u6ce8\uff1a\u5728\u6700\u65b0\u53d1\u5e03\u76840.4.2\u7248\u672c\u4e2d\u5df2\u652f\u6301\u4efb\u610f\u6570\u636e\u6e90\u7c7b\u578b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@Bean\n@ConfigurationProperties(prefix = "spring.datasource")\npublic DruidDataSource druidDataSource() {\n    DruidDataSource druidDataSource = new DruidDataSource();\n    return druidDataSource;\n}\n\n@Primary\n@Bean("dataSource")\npublic DataSourceProxy dataSource(DruidDataSource druidDataSource) {\n    return new DataSourceProxy(druidDataSource);\n}\n')),(0,r.kt)("p",null,"\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"DataSourceProxy"),"\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u5f15\u5165",(0,r.kt)("inlineCode",{parentName:"p"},"ConnectionProxy"),",fescar\u65e0\u4fb5\u5165\u7684\u4e00\u65b9\u9762\u5c31\u4f53\u73b0\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"ConnectionProxy"),"\u7684\u5b9e\u73b0\u4e0a\uff0c\u5373\u5206\u652f\u4e8b\u52a1\u52a0\u5165\u5168\u5c40\u4e8b\u52a1\u7684\u5207\u5165\u70b9\u662f\u5728\u672c\u5730\u4e8b\u52a1\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"commit"),"\u9636\u6bb5\uff0c\u8fd9\u6837\u8bbe\u8ba1\u53ef\u4ee5\u4fdd\u8bc1\u4e1a\u52a1\u6570\u636e\u4e0e",(0,r.kt)("inlineCode",{parentName:"p"},"undo_log"),"\u662f\u5728\u4e00\u4e2a\u672c\u5730\u4e8b\u52a1\u4e2d\u3002"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"undo_log"),"\u662f\u9700\u8981\u5728\u4e1a\u52a1\u5e93\u4e0a\u521b\u5efa\u7684\u4e00\u4e2a\u8868\uff0cfescar\u4f9d\u8d56\u8be5\u8868\u8bb0\u5f55\u6bcf\u7b14\u5206\u652f\u4e8b\u52a1\u7684\u72b6\u6001\u53ca\u4e8c\u9636\u6bb5",(0,r.kt)("inlineCode",{parentName:"p"},"rollback"),"\u7684\u56de\u653e\u6570\u636e\u3002\u4e0d\u7528\u62c5\u5fc3\u8be5\u8868\u7684\u6570\u636e\u91cf\u8fc7\u5927\u5f62\u6210\u5355\u70b9\u95ee\u9898\uff0c\u5728\u5168\u5c40\u4e8b\u52a1",(0,r.kt)("inlineCode",{parentName:"p"},"commit"),"\u7684\u573a\u666f\u4e0b\u4e8b\u52a1\u5bf9\u5e94\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"undo_log"),"\u4f1a\u5f02\u6b65\u5220\u9664\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE `undo_log` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `branch_id` bigint(20) NOT NULL,\n  `xid` varchar(100) NOT NULL,\n  `rollback_info` longblob NOT NULL,\n  `log_status` int(11) NOT NULL,\n  `log_created` datetime NOT NULL,\n  `log_modified` datetime NOT NULL,\n  `ext` varchar(100) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)\n) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;\n")),(0,r.kt)("h2",{id:"\u542f\u52a8server"},"\u542f\u52a8Server"),(0,r.kt)("p",null,"\u524d\u5f80",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/releases"},"https://github.com/seata/seata/releases")," \u4e0b\u8f7d\u4e0eClient\u7248\u672c\u5bf9\u5e94\u7684fescar-server,\u907f\u514d\u7531\u4e8e\u7248\u672c\u7684\u4e0d\u540c\u5bfc\u81f4\u7684\u534f\u8bae\u4e0d\u4e00\u81f4\u95ee\u9898\n\u8fdb\u5165\u89e3\u538b\u4e4b\u540e\u7684 bin \u76ee\u5f55\uff0c\u6267\u884c"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"./fescar-server.sh 8091 ../data\n")),(0,r.kt)("p",null,"\u542f\u52a8\u6210\u529f\u8f93\u51fa"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"2019-04-09 20:27:24.637 INFO [main]c.a.fescar.core.rpc.netty.AbstractRpcRemotingServer.start:152 -Server started ... \n")),(0,r.kt)("h2",{id:"\u542f\u52a8client"},"\u542f\u52a8Client"),(0,r.kt)("p",null,"fescar\u7684\u52a0\u8f7d\u5165\u53e3\u7c7b\u4f4d\u4e8e",(0,r.kt)("a",{parentName:"p",href:"https://github.com/spring-cloud-incubator/spring-cloud-alibaba/blob/finchley/spring-cloud-alibaba-fescar/src/main/java/org/springframework/cloud/alibaba/fescar/GlobalTransactionAutoConfiguration.java"},"GlobalTransactionAutoConfiguration"),"\uff0c\u5bf9\u57fa\u4e8espring boot\u7684\u9879\u76ee\u80fd\u591f\u81ea\u52a8\u52a0\u8f7d\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u65b9\u5f0f\u793a\u4f8b\u5316",(0,r.kt)("inlineCode",{parentName:"p"},"GlobalTransactionScanner")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@Configuration\n@EnableConfigurationProperties({FescarProperties.class})\npublic class GlobalTransactionAutoConfiguration {\n    private final ApplicationContext applicationContext;\n    private final FescarProperties fescarProperties;\n\n    public GlobalTransactionAutoConfiguration(ApplicationContext applicationContext, FescarProperties fescarProperties) {\n        this.applicationContext = applicationContext;\n        this.fescarProperties = fescarProperties;\n    }\n\n    /**\n    * \u793a\u4f8b\u5316GlobalTransactionScanner\n    * scanner\u4e3aclient\u521d\u59cb\u5316\u7684\u53d1\u8d77\u7c7b\n    */\n    @Bean\n    public GlobalTransactionScanner globalTransactionScanner() {\n        String applicationName = this.applicationContext.getEnvironment().getProperty("spring.application.name");\n        String txServiceGroup = this.fescarProperties.getTxServiceGroup();\n        if (StringUtils.isEmpty(txServiceGroup)) {\n            txServiceGroup = applicationName + "-fescar-service-group";\n            this.fescarProperties.setTxServiceGroup(txServiceGroup);\n        }\n        \n        return new GlobalTransactionScanner(applicationName, txServiceGroup);\n    }\n}\n')),(0,r.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\u652f\u6301\u4e00\u4e2a\u914d\u7f6e\u9879FescarProperties\uff0c\u7528\u4e8e\u914d\u7f6e\u4e8b\u52a1\u5206\u7ec4\u540d\u79f0"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},"spring.cloud.alibaba.fescar.tx-service-group=my_test_tx_group\n")),(0,r.kt)("p",null,"\u5982\u679c\u4e0d\u6307\u5b9a\u670d\u52a1\u7ec4\uff0c\u5219\u9ed8\u8ba4\u4f7f\u7528spring.application.name+ -fescar-service-group\u751f\u6210\u540d\u79f0\uff0c\u6240\u4ee5\u4e0d\u6307\u5b9aspring.application.name\u542f\u52a8\u4f1a\u62a5\u9519"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@ConfigurationProperties("spring.cloud.alibaba.fescar")\npublic class FescarProperties {\n    private String txServiceGroup;\n\n    public FescarProperties() {\n    }\n\n    public String getTxServiceGroup() {\n        return this.txServiceGroup;\n    }\n\n    public void setTxServiceGroup(String txServiceGroup) {\n        this.txServiceGroup = txServiceGroup;\n    }\n}\n')),(0,r.kt)("p",null,"\u83b7\u53d6applicationId\u548ctxServiceGroup\u540e\uff0c\u521b\u5efa",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/spring/src/main/java/com/alibaba/fescar/spring/annotation/GlobalTransactionScanner.java"},"GlobalTransactionScanner"),"\u5bf9\u8c61\uff0c\u4e3b\u8981\u770b\u7c7b\u4e2dinitClient\u65b9\u6cd5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'private void initClient() {\n    if (StringUtils.isNullOrEmpty(applicationId) || StringUtils.isNullOrEmpty(txServiceGroup)) {\n        throw new IllegalArgumentException(\n            "applicationId: " + applicationId + ", txServiceGroup: " + txServiceGroup);\n    }\n    //init TM\n    TMClient.init(applicationId, txServiceGroup);\n\n    //init RM\n    RMClient.init(applicationId, txServiceGroup);\n  \n}\n')),(0,r.kt)("p",null,"\u65b9\u6cd5\u4e2d\u53ef\u4ee5\u770b\u5230\u521d\u59cb\u5316\u4e86",(0,r.kt)("inlineCode",{parentName:"p"},"TMClient"),"\u548c",(0,r.kt)("inlineCode",{parentName:"p"},"RMClient"),"\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u670d\u52a1\u65e2\u53ef\u4ee5\u662fTM\u89d2\u8272\u4e5f\u53ef\u4ee5\u662fRM\u89d2\u8272\uff0c\u81f3\u4e8e\u4ec0\u4e48\u65f6\u5019\u662fTM\u6216\u8005RM\u5219\u8981\u770b\u5728\u4e00\u6b21\u5168\u5c40\u4e8b\u52a1\u4e2d",(0,r.kt)("inlineCode",{parentName:"p"},"@GlobalTransactional"),"\u6ce8\u89e3\u6807\u6ce8\u5728\u54ea\u3002\nClient\u521b\u5efa\u7684\u7ed3\u679c\u662f\u4e0eTC\u7684\u4e00\u4e2aNetty\u8fde\u63a5\uff0c\u6240\u4ee5\u5728\u542f\u52a8\u65e5\u5fd7\u4e2d\u53ef\u4ee5\u770b\u5230\u4e24\u4e2aNetty Channel\uff0c\u5176\u4e2d\u6807\u660e\u4e86transactionRole\u5206\u522b\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"TMROLE"),"\u548c",(0,r.kt)("inlineCode",{parentName:"p"},"RMROLE")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'2019-04-09 13:42:57.417  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : NettyPool create channel to {"address":"127.0.0.1:8091","message":{"applicationId":"business-service","byteBuffer":{"char":"\\u0000","direct":false,"double":0.0,"float":0.0,"int":0,"long":0,"readOnly":false,"short":0},"transactionServiceGroup":"my_test_tx_group","typeCode":101,"version":"0.4.1"},"transactionRole":"TMROLE"}\n2019-04-09 13:42:57.505  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : NettyPool create channel to {"address":"127.0.0.1:8091","message":{"applicationId":"business-service","byteBuffer":{"char":"\\u0000","direct":false,"double":0.0,"float":0.0,"int":0,"long":0,"readOnly":false,"short":0},"transactionServiceGroup":"my_test_tx_group","typeCode":103,"version":"0.4.1"},"transactionRole":"RMROLE"}\n2019-04-09 13:42:57.629 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:RegisterTMRequest{applicationId=\'business-service\', transactionServiceGroup=\'my_test_tx_group\'}\n2019-04-09 13:42:57.629 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:RegisterRMRequest{resourceIds=\'null\', applicationId=\'business-service\', transactionServiceGroup=\'my_test_tx_group\'}\n2019-04-09 13:42:57.699 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:1\n2019-04-09 13:42:57.699 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:2\n2019-04-09 13:42:57.701 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.RmRpcClient@3b06d101 msgId:1, future :com.alibaba.fescar.core.protocol.MessageFuture@28bb1abd, body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null\n2019-04-09 13:42:57.701 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.TmRpcClient@65fc3fb7 msgId:2, future :com.alibaba.fescar.core.protocol.MessageFuture@9a1e3df, body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null\n2019-04-09 13:42:57.710  INFO 93715 --- [imeoutChecker_1] c.a.fescar.core.rpc.netty.RmRpcClient    : register RM success. server version:0.4.1,channel:[id: 0xe6468995, L:/127.0.0.1:57397 - R:/127.0.0.1:8091]\n2019-04-09 13:42:57.710  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : register success, cost 114 ms, version:0.4.1,role:TMROLE,channel:[id: 0xd22fe0c5, L:/127.0.0.1:57398 - R:/127.0.0.1:8091]\n2019-04-09 13:42:57.711  INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory   : register success, cost 125 ms, version:0.4.1,role:RMROLE,channel:[id: 0xe6468995, L:/127.0.0.1:57397 - R:/127.0.0.1:8091]\n\n')),(0,r.kt)("p",null,"\u65e5\u5fd7\u4e2d\u53ef\u4ee5\u770b\u5230"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u521b\u5efaNetty\u8fde\u63a5"),(0,r.kt)("li",{parentName:"ol"},"\u53d1\u9001\u6ce8\u518c\u8bf7\u6c42"),(0,r.kt)("li",{parentName:"ol"},"\u5f97\u5230\u54cd\u5e94\u7ed3\u679c"),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"RmRpcClient"),"\u3001",(0,r.kt)("inlineCode",{parentName:"li"},"TmRpcClient"),"\u6210\u529f\u5b9e\u4f8b\u5316")),(0,r.kt)("h2",{id:"tm\u5904\u7406\u6d41\u7a0b"},"TM\u5904\u7406\u6d41\u7a0b"),(0,r.kt)("p",null,"\u5728\u672c\u4f8b\u4e2d\uff0cTM\u7684\u89d2\u8272\u662fbusiness-service,BusinessService\u7684purchase\u65b9\u6cd5\u6807\u6ce8\u4e86",(0,r.kt)("inlineCode",{parentName:"p"},"@GlobalTransactional"),"\u6ce8\u89e3"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@Service\npublic class BusinessService {\n\n    @Autowired\n    private StorageFeignClient storageFeignClient;\n    @Autowired\n    private OrderFeignClient orderFeignClient;\n\n    @GlobalTransactional\n    public void purchase(String userId, String commodityCode, int orderCount){\n        storageFeignClient.deduct(commodityCode, orderCount);\n\n        orderFeignClient.create(userId, commodityCode, orderCount);\n    }\n}\n")),(0,r.kt)("p",null,"\u65b9\u6cd5\u8c03\u7528\u540e\u5c06\u4f1a\u521b\u5efa\u4e00\u4e2a\u5168\u5c40\u4e8b\u52a1\uff0c\u9996\u5148\u5173\u6ce8",(0,r.kt)("inlineCode",{parentName:"p"},"@GlobalTransactional"),"\u6ce8\u89e3\u7684\u4f5c\u7528\uff0c\u5728",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/spring/src/main/java/com/alibaba/fescar/spring/annotation/GlobalTransactionalInterceptor.java"},"GlobalTransactionalInterceptor"),"\u4e2d\u88ab\u62e6\u622a\u5904\u7406"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * AOP\u62e6\u622a\u65b9\u6cd5\u8c03\u7528\n */\n@Override\npublic Object invoke(final MethodInvocation methodInvocation) throws Throwable {\n    Class<?> targetClass = (methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis()) : null);\n    Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);\n    final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);\n\n    //\u83b7\u53d6\u65b9\u6cd5GlobalTransactional\u6ce8\u89e3\n    final GlobalTransactional globalTransactionalAnnotation = getAnnotation(method, GlobalTransactional.class);\n    final GlobalLock globalLockAnnotation = getAnnotation(method, GlobalLock.class);\n    \n    //\u5982\u679c\u65b9\u6cd5\u6709GlobalTransactional\u6ce8\u89e3\uff0c\u5219\u62e6\u622a\u5230\u76f8\u5e94\u65b9\u6cd5\u5904\u7406\n    if (globalTransactionalAnnotation != null) {\n        return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);\n    } else if (globalLockAnnotation != null) {\n        return handleGlobalLock(methodInvocation);\n    } else {\n        return methodInvocation.proceed();\n    }\n}\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"handleGlobalTransaction"),"\u65b9\u6cd5\u4e2d\u5bf9",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/TransactionalTemplate.java"},"TransactionalTemplate"),"\u7684execute\u8fdb\u884c\u4e86\u8c03\u7528\uff0c\u4ece\u7c7b\u540d\u53ef\u4ee5\u770b\u5230\u8fd9\u662f\u4e00\u4e2a\u6807\u51c6\u7684\u6a21\u7248\u65b9\u6cd5\uff0c\u5b83\u5b9a\u4e49\u4e86TM\u5bf9\u5168\u5c40\u4e8b\u52a1\u5904\u7406\u7684\u6807\u51c6\u6b65\u9aa4\uff0c\u6ce8\u91ca\u5df2\u7ecf\u6bd4\u8f83\u6e05\u695a\u4e86"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public Object execute(TransactionalExecutor business) throws TransactionalExecutor.ExecutionException {\n    // 1. get or create a transaction\n    GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();\n\n    try {\n        // 2. begin transaction\n        try {\n            triggerBeforeBegin();\n            tx.begin(business.timeout(), business.name());\n            triggerAfterBegin();\n        } catch (TransactionException txe) {\n            throw new TransactionalExecutor.ExecutionException(tx, txe,\n                TransactionalExecutor.Code.BeginFailure);\n        }\n        Object rs = null;\n        try {\n            // Do Your Business\n            rs = business.execute();\n        } catch (Throwable ex) {\n            // 3. any business exception, rollback.\n            try {\n                triggerBeforeRollback();\n                tx.rollback();\n                triggerAfterRollback();\n                // 3.1 Successfully rolled back\n                throw new TransactionalExecutor.ExecutionException(tx, TransactionalExecutor.Code.RollbackDone, ex);\n            } catch (TransactionException txe) {\n                // 3.2 Failed to rollback\n                throw new TransactionalExecutor.ExecutionException(tx, txe,\n                    TransactionalExecutor.Code.RollbackFailure, ex);\n            }\n        }\n        // 4. everything is fine, commit.\n        try {\n            triggerBeforeCommit();\n            tx.commit();\n            triggerAfterCommit();\n        } catch (TransactionException txe) {\n            // 4.1 Failed to commit\n            throw new TransactionalExecutor.ExecutionException(tx, txe,\n                TransactionalExecutor.Code.CommitFailure);\n        }\n        return rs;\n    } finally {\n        //5. clear\n        triggerAfterCompletion();\n        cleanUp();\n    }\n}\n")),(0,r.kt)("p",null,"\u901a\u8fc7",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/DefaultGlobalTransaction.java"},"DefaultGlobalTransaction"),"\u7684begin\u65b9\u6cd5\u5f00\u542f\u5168\u5c40\u4e8b\u52a1"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'public void begin(int timeout, String name) throws TransactionException {\n    if (role != GlobalTransactionRole.Launcher) {\n        check();\n        if (LOGGER.isDebugEnabled()) {\n            LOGGER.debug("Ignore Begin(): just involved in global transaction [" + xid + "]");\n        }\n        return;\n    }\n    if (xid != null) {\n        throw new IllegalStateException();\n    }\n    if (RootContext.getXID() != null) {\n        throw new IllegalStateException();\n    }\n    //\u5177\u4f53\u5f00\u542f\u4e8b\u52a1\u7684\u65b9\u6cd5\uff0c\u83b7\u53d6TC\u8fd4\u56de\u7684XID\n    xid = transactionManager.begin(null, null, name, timeout);\n    status = GlobalStatus.Begin;\n    RootContext.bind(xid);\n    if (LOGGER.isDebugEnabled()) {\n        LOGGER.debug("Begin a NEW global transaction [" + xid + "]");\n    }\n}\n')),(0,r.kt)("p",null,"\u65b9\u6cd5\u5f00\u5934\u5904",(0,r.kt)("inlineCode",{parentName:"p"},"if (role != GlobalTransactionRole.Launcher)"),"\u5bf9role\u7684\u5224\u65ad\u6709\u5173\u952e\u7684\u4f5c\u7528\uff0c\u8868\u660e\u5f53\u524d\u662f\u5168\u5c40\u4e8b\u52a1\u7684\u53d1\u8d77\u8005\uff08Launcher\uff09\u8fd8\u662f\u53c2\u4e0e\u8005\uff08Participant\uff09\u3002\u5982\u679c\u5728\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u4e0b\u6e38\u7cfb\u7edf\u65b9\u6cd5\u4e2d\u4e5f\u52a0\u4e0a",(0,r.kt)("inlineCode",{parentName:"p"},"@GlobalTransactional"),"\u6ce8\u89e3\uff0c\u90a3\u4e48\u5b83\u7684\u89d2\u8272\u5c31\u662fParticipant\uff0c\u4f1a\u5ffd\u7565\u540e\u9762\u7684begin\u76f4\u63a5return\uff0c\u800c\u5224\u65ad\u662fLauncher\u8fd8\u662fParticipant\u662f\u6839\u636e\u5f53\u524d\u4e0a\u4e0b\u6587\u662f\u5426\u5df2\u5b58\u5728XID\u6765\u5224\u65ad\uff0c\u6ca1\u6709XID\u7684\u5c31\u662fLauncher\uff0c\u5df2\u7ecf\u5b58\u5728XID\u7684\u5c31\u662fParticipant.\n\u7531\u6b64\u53ef\u89c1\uff0c\u5168\u5c40\u4e8b\u52a1\u7684\u521b\u5efa\u53ea\u80fd\u7531Launcher\u6267\u884c\uff0c\u800c\u4e00\u6b21\u5206\u5e03\u5f0f\u4e8b\u52a1\u4e2d\u4e5f\u53ea\u6709\u4e00\u4e2aLauncher\u5b58\u5728\u3002"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/DefaultTransactionManager.java"},"DefaultTransactionManager"),"\u8d1f\u8d23TM\u4e0eTC\u901a\u8baf\uff0c\u53d1\u9001begin\u3001commit\u3001rollback\u6307\u4ee4"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@Override\npublic String begin(String applicationId, String transactionServiceGroup, String name, int timeout)\n    throws TransactionException {\n    GlobalBeginRequest request = new GlobalBeginRequest();\n    request.setTransactionName(name);\n    request.setTimeout(timeout);\n    GlobalBeginResponse response = (GlobalBeginResponse)syncCall(request);\n    return response.getXid();\n}\n")),(0,r.kt)("p",null,"\u81f3\u6b64\u62ff\u5230fescar-server\u8fd4\u56de\u7684XID\u8868\u793a\u4e00\u4e2a\u5168\u5c40\u4e8b\u52a1\u521b\u5efa\u6210\u529f\uff0c\u65e5\u5fd7\u4e2d\u4e5f\u53cd\u5e94\u4e86\u4e0a\u8ff0\u6d41\u7a0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"2019-04-09 13:46:57.417 DEBUG 31326 --- [nio-8084-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : offer message: timeout=60000,transactionName=purchase(java.lang.String,java.lang.String,int)\n2019-04-09 13:46:57.417 DEBUG 31326 --- [geSend_TMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : write message:FescarMergeMessage timeout=60000,transactionName=purchase(java.lang.String,java.lang.String,int), channel:[id: 0xa148545e, L:/127.0.0.1:56120 - R:/127.0.0.1:8091],active?true,writable?true,isopen?true\n2019-04-09 13:46:57.418 DEBUG 31326 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:FescarMergeMessage timeout=60000,transactionName=purchase(java.lang.String,java.lang.String,int)\n2019-04-09 13:46:57.421 DEBUG 31326 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:MergeResultMessage com.alibaba.fescar.core.protocol.transaction.GlobalBeginResponse@2dc480dc,messageId:1196\n2019-04-09 13:46:57.421 DEBUG 31326 --- [nio-8084-exec-1] c.a.fescar.core.context.RootContext      : bind 192.168.224.93:8091:2008502699\n2019-04-09 13:46:57.421 DEBUG 31326 --- [nio-8084-exec-1] c.a.f.tm.api.DefaultGlobalTransaction    : Begin a NEW global transaction [192.168.224.93:8091:2008502699]\n")),(0,r.kt)("p",null,"\u5168\u5c40\u4e8b\u52a1\u521b\u5efa\u540e\uff0c\u5c31\u5f00\u59cb\u6267\u884cbusiness.execute()\uff0c\u5373\u4e1a\u52a1\u4ee3\u7801",(0,r.kt)("inlineCode",{parentName:"p"},"storageFeignClient.deduct(commodityCode, orderCount)"),"\u8fdb\u5165RM\u5904\u7406\u6d41\u7a0b\uff0c\u6b64\u5904\u7684\u4e1a\u52a1\u903b\u8f91\u4e3a\u8c03\u7528storage-service\u7684\u6263\u51cf\u5e93\u5b58\u63a5\u53e3\u3002"),(0,r.kt)("h2",{id:"rm\u5904\u7406\u6d41\u7a0b"},"RM\u5904\u7406\u6d41\u7a0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@GetMapping(path = "/deduct")\npublic Boolean deduct(String commodityCode, Integer count){\n    storageService.deduct(commodityCode,count);\n    return true;\n}\n\n@Transactional\npublic void deduct(String commodityCode, int count){\n    Storage storage = storageDAO.findByCommodityCode(commodityCode);\n    storage.setCount(storage.getCount()-count);\n\n    storageDAO.save(storage);\n}\n')),(0,r.kt)("p",null,"storage\u7684\u63a5\u53e3\u548cservice\u65b9\u6cd5\u5e76\u672a\u51fa\u73b0fescar\u76f8\u5173\u7684\u4ee3\u7801\u548c\u6ce8\u89e3\uff0c\u4f53\u73b0\u4e86fescar\u7684\u65e0\u4fb5\u5165\u3002\u90a3\u5b83\u662f\u5982\u4f55\u52a0\u5165\u5230\u8fd9\u6b21\u5168\u5c40\u4e8b\u52a1\u4e2d\u7684\u5462\uff1f\u7b54\u6848\u5728",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/ConnectionProxy.java"},"ConnectionProxy"),"\u4e2d\uff0c\u8fd9\u4e5f\u662f\u524d\u9762\u8bf4\u4e3a\u4ec0\u4e48\u5fc5\u987b\u8981\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"DataSourceProxy"),"\u7684\u539f\u56e0\uff0c\u901a\u8fc7DataSourceProxy\u624d\u80fd\u5728\u4e1a\u52a1\u4ee3\u7801\u7684\u672c\u5730\u4e8b\u52a1\u63d0\u4ea4\u65f6\uff0cfescar\u901a\u8fc7\u8be5\u5207\u5165\u70b9\uff0c\u5411TC\u6ce8\u518c\u5206\u652f\u4e8b\u52a1\u5e76\u53d1\u9001RM\u7684\u5904\u7406\u7ed3\u679c\u3002"),(0,r.kt)("p",null,"\u7531\u4e8e\u4e1a\u52a1\u4ee3\u7801\u672c\u8eab\u7684\u4e8b\u52a1\u63d0\u4ea4\u88ab",(0,r.kt)("inlineCode",{parentName:"p"},"ConnectionProxy"),"\u4ee3\u7406\u5b9e\u73b0\uff0c\u6240\u4ee5\u5728\u63d0\u4ea4\u672c\u5730\u4e8b\u52a1\u65f6\uff0c\u5b9e\u9645\u6267\u884c\u7684\u662fConnectionProxy\u7684commit\u65b9\u6cd5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public void commit() throws SQLException {\n    //\u5982\u679c\u5f53\u524d\u662f\u5168\u5c40\u4e8b\u52a1\uff0c\u5219\u6267\u884c\u5168\u5c40\u4e8b\u52a1\u7684\u63d0\u4ea4\n    //\u5224\u65ad\u662f\u4e0d\u662f\u5168\u5c40\u4e8b\u52a1\uff0c\u5c31\u662f\u770b\u5f53\u524d\u4e0a\u4e0b\u6587\u662f\u5426\u5b58\u5728XID\n    if (context.inGlobalTransaction()) {\n        processGlobalTransactionCommit();\n    } else if (context.isGlobalLockRequire()) {\n        processLocalCommitWithGlobalLocks();\n    } else {\n        targetConnection.commit();\n    }\n}\n    \nprivate void processGlobalTransactionCommit() throws SQLException {\n    try {\n        //\u9996\u5148\u662f\u5411TC\u6ce8\u518cRM\uff0c\u62ff\u5230TC\u5206\u914d\u7684branchId\n        register();\n    } catch (TransactionException e) {\n        recognizeLockKeyConflictException(e);\n    }\n\n    try {\n        if (context.hasUndoLog()) {\n            //\u5199\u5165undolog\n            UndoLogManager.flushUndoLogs(this);\n        }\n\n        //\u63d0\u4ea4\u672c\u5730\u4e8b\u52a1\uff0c\u5199\u5165undo_log\u548c\u4e1a\u52a1\u6570\u636e\u5728\u540c\u4e00\u4e2a\u672c\u5730\u4e8b\u52a1\u4e2d\n        targetConnection.commit();\n    } catch (Throwable ex) {\n        //\u5411TC\u53d1\u9001RM\u7684\u4e8b\u52a1\u5904\u7406\u5931\u8d25\u7684\u901a\u77e5\n        report(false);\n        if (ex instanceof SQLException) {\n            throw new SQLException(ex);\n        }\n    }\n    //\u5411TC\u53d1\u9001RM\u7684\u4e8b\u52a1\u5904\u7406\u6210\u529f\u7684\u901a\u77e5\n    report(true);\n    context.reset();\n}\n    \nprivate void register() throws TransactionException {\n    //\u6ce8\u518cRM\uff0c\u6784\u5efarequest\u901a\u8fc7netty\u5411TC\u53d1\u9001\u6ce8\u518c\u6307\u4ee4\n    Long branchId = DefaultResourceManager.get().branchRegister(BranchType.AT, getDataSourceProxy().getResourceId(),\n            null, context.getXid(), null, context.buildLockKeys());\n    //\u5c06\u8fd4\u56de\u7684branchId\u5b58\u5728\u4e0a\u4e0b\u6587\u4e2d\n    context.setBranchId(branchId);\n}\n")),(0,r.kt)("p",null,"\u901a\u8fc7\u65e5\u5fd7\u5370\u8bc1\u4e00\u4e0b\u4e0a\u9762\u7684\u6d41\u7a0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor   : xid in RootContext null xid in RpcContext 192.168.0.2:8091:2008546211\n2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] c.a.fescar.core.context.RootContext      : bind 192.168.0.2:8091:2008546211\n2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor   : bind 192.168.0.2:8091:2008546211 to RootContext\n2019-04-09 21:57:48.386  INFO 38933 --- [nio-8081-exec-1] o.h.h.i.QueryTranslatorFactoryInitiator  : HHH000397: Using ASTQueryTranslatorFactory\nHibernate: select storage0_.id as id1_0_, storage0_.commodity_code as commodit2_0_, storage0_.count as count3_0_ from storage_tbl storage0_ where storage0_.commodity_code=?\nHibernate: update storage_tbl set count=? where id=?\n2019-04-09 21:57:48.673  INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient    : will connect to 192.168.0.2:8091\n2019-04-09 21:57:48.673  INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient    : RM will register :jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false\n2019-04-09 21:57:48.673  INFO 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.NettyPoolableFactory   : NettyPool create channel to {"address":"192.168.0.2:8091","message":{"applicationId":"storage-service","byteBuffer":{"char":"\\u0000","direct":false,"double":0.0,"float":0.0,"int":0,"long":0,"readOnly":false,"short":0},"resourceIds":"jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false","transactionServiceGroup":"hello-service-fescar-service-group","typeCode":103,"version":"0.4.0"},"transactionRole":"RMROLE"}\n2019-04-09 21:57:48.677 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:RegisterRMRequest{resourceIds=\'jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false\', applicationId=\'storage-service\', transactionServiceGroup=\'hello-service-fescar-service-group\'}\n2019-04-09 21:57:48.680 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:9\n2019-04-09 21:57:48.680 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.RmRpcClient@7d61f5d4 msgId:9, future :com.alibaba.fescar.core.protocol.MessageFuture@186cd3e0, body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null\n2019-04-09 21:57:48.680  INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient    : register RM success. server version:0.4.1,channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091]\n2019-04-09 21:57:48.680  INFO 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.NettyPoolableFactory   : register success, cost 3 ms, version:0.4.1,role:RMROLE,channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091]\n2019-04-09 21:57:48.680 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : offer message: transactionId=2008546211,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,lockKey=storage_tbl:1\n2019-04-09 21:57:48.681 DEBUG 38933 --- [geSend_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : write message:FescarMergeMessage transactionId=2008546211,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,lockKey=storage_tbl:1, channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091],active?true,writable?true,isopen?true\n2019-04-09 21:57:48.681 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:FescarMergeMessage transactionId=2008546211,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,lockKey=storage_tbl:1\n2019-04-09 21:57:48.687 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:MergeResultMessage BranchRegisterResponse: transactionId=2008546211,branchId=2008546212,result code =Success,getMsg =null,messageId:11\n2019-04-09 21:57:48.702 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.rm.datasource.undo.UndoLogManager  : Flushing UNDO LOG: {"branchId":2008546212,"sqlUndoLogs":[{"afterImage":{"rows":[{"fields":[{"keyType":"PrimaryKey","name":"id","type":4,"value":1},{"keyType":"NULL","name":"count","type":4,"value":993}]}],"tableName":"storage_tbl"},"beforeImage":{"rows":[{"fields":[{"keyType":"PrimaryKey","name":"id","type":4,"value":1},{"keyType":"NULL","name":"count","type":4,"value":994}]}],"tableName":"storage_tbl"},"sqlType":"UPDATE","tableName":"storage_tbl"}],"xid":"192.168.0.2:8091:2008546211"}\n2019-04-09 21:57:48.755 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : offer message: transactionId=2008546211,branchId=2008546212,resourceId=null,status=PhaseOne_Done,applicationData=null\n2019-04-09 21:57:48.755 DEBUG 38933 --- [geSend_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : write message:FescarMergeMessage transactionId=2008546211,branchId=2008546212,resourceId=null,status=PhaseOne_Done,applicationData=null, channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091],active?true,writable?true,isopen?true\n2019-04-09 21:57:48.756 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:FescarMergeMessage transactionId=2008546211,branchId=2008546212,resourceId=null,status=PhaseOne_Done,applicationData=null\n2019-04-09 21:57:48.758 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:MergeResultMessage com.alibaba.fescar.core.protocol.transaction.BranchReportResponse@582a08cf,messageId:13\n2019-04-09 21:57:48.799 DEBUG 38933 --- [nio-8081-exec-1] c.a.fescar.core.context.RootContext      : unbind 192.168.0.2:8091:2008546211\n2019-04-09 21:57:48.799 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor   : unbind 192.168.0.2:8091:2008546211 from RootContext\n')),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u83b7\u53d6business-service\u4f20\u6765\u7684XID"),(0,r.kt)("li",{parentName:"ol"},"\u7ed1\u5b9aXID\u5230\u5f53\u524d\u4e0a\u4e0b\u6587\u4e2d"),(0,r.kt)("li",{parentName:"ol"},"\u6267\u884c\u4e1a\u52a1\u903b\u8f91sql"),(0,r.kt)("li",{parentName:"ol"},"\u5411TC\u521b\u5efa\u672c\u6b21RM\u7684Netty\u8fde\u63a5"),(0,r.kt)("li",{parentName:"ol"},"\u5411TC\u53d1\u9001\u5206\u652f\u4e8b\u52a1\u7684\u76f8\u5173\u4fe1\u606f"),(0,r.kt)("li",{parentName:"ol"},"\u83b7\u5f97TC\u8fd4\u56de\u7684branchId"),(0,r.kt)("li",{parentName:"ol"},"\u8bb0\u5f55Undo Log\u6570\u636e"),(0,r.kt)("li",{parentName:"ol"},"\u5411TC\u53d1\u9001\u672c\u6b21\u4e8b\u52a1PhaseOne\u9636\u6bb5\u7684\u5904\u7406\u7ed3\u679c"),(0,r.kt)("li",{parentName:"ol"},"\u4ece\u5f53\u524d\u4e0a\u4e0b\u6587\u4e2d\u89e3\u7ed1XID")),(0,r.kt)("p",null,"\u5176\u4e2d\u7b2c1\u6b65\u548c\u7b2c9\u6b65\uff0c\u662f\u5728",(0,r.kt)("a",{parentName:"p",href:"https://github.com/dongsheep/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-fescar/src/main/java/org/springframework/cloud/alibaba/fescar/web/FescarHandlerInterceptor.java"},"FescarHandlerInterceptor"),"\u4e2d\u5b8c\u6210\u7684\uff0c\u8be5\u7c7b\u5e76\u4e0d\u5c5e\u4e8efescar\uff0c\u662f\u524d\u9762\u63d0\u5230\u7684spring-cloud-alibaba-fescar,\u5b83\u5b9e\u73b0\u4e86\u57fa\u4e8efeign\u3001rest\u901a\u4fe1\u65f6\u5c06xid bind\u548cunbind\u5230\u5f53\u524d\u8bf7\u6c42\u4e0a\u4e0b\u6587\u4e2d\u3002\u5230\u8fd9\u91ccRM\u5b8c\u6210\u4e86PhaseOne\u9636\u6bb5\u7684\u5de5\u4f5c\uff0c\u63a5\u7740\u770bPhaseTwo\u9636\u6bb5\u7684\u5904\u7406\u903b\u8f91\u3002"),(0,r.kt)("h2",{id:"\u4e8b\u52a1\u63d0\u4ea4"},"\u4e8b\u52a1\u63d0\u4ea4"),(0,r.kt)("p",null,"\u5404\u5206\u652f\u4e8b\u52a1\u6267\u884c\u5b8c\u6210\u540e\uff0cTC\u5bf9\u5404RM\u7684\u6c47\u62a5\u7ed3\u679c\u8fdb\u884c\u6c47\u603b\uff0c\u7ed9\u5404RM\u53d1\u9001commit\u6216rollback\u7684\u6307\u4ee4"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"2019-04-09 21:57:49.813 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Receive:xid=192.168.0.2:8091:2008546211,branchId=2008546212,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,applicationData=null,messageId:1\n2019-04-09 21:57:49.813 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting    : com.alibaba.fescar.core.rpc.netty.RmRpcClient@7d61f5d4 msgId:1, body:xid=192.168.0.2:8091:2008546211,branchId=2008546212,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,applicationData=null\n2019-04-09 21:57:49.814  INFO 38933 --- [atch_RMROLE_1_8] c.a.f.core.rpc.netty.RmMessageListener   : onMessage:xid=192.168.0.2:8091:2008546211,branchId=2008546212,branchType=AT,resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false,applicationData=null\n2019-04-09 21:57:49.816  INFO 38933 --- [atch_RMROLE_1_8] com.alibaba.fescar.rm.AbstractRMHandler  : Branch committing: 192.168.0.2:8091:2008546211 2008546212 jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false null\n2019-04-09 21:57:49.816  INFO 38933 --- [atch_RMROLE_1_8] com.alibaba.fescar.rm.AbstractRMHandler  : Branch commit result: PhaseTwo_Committed\n2019-04-09 21:57:49.817  INFO 38933 --- [atch_RMROLE_1_8] c.a.fescar.core.rpc.netty.RmRpcClient    : RmRpcClient sendResponse branchStatus=PhaseTwo_Committed,result code =Success,getMsg =null\n2019-04-09 21:57:49.817 DEBUG 38933 --- [atch_RMROLE_1_8] c.a.f.c.rpc.netty.AbstractRpcRemoting    : send response:branchStatus=PhaseTwo_Committed,result code =Success,getMsg =null,channel:[id: 0xd40718e3, L:/192.168.0.2:62607 - R:/192.168.0.2:8091]\n2019-04-09 21:57:49.817 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler    : Send:branchStatus=PhaseTwo_Committed,result code =Success,getMsg =null\n")),(0,r.kt)("p",null,"\u4ece\u65e5\u5fd7\u4e2d\u53ef\u4ee5\u770b\u5230"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"RM\u6536\u5230XID=192.168.0.2:8091:2008546211,branchId=2008546212\u7684commit\u901a\u77e5"),(0,r.kt)("li",{parentName:"ol"},"\u6267\u884ccommit\u52a8\u4f5c"),(0,r.kt)("li",{parentName:"ol"},"\u5c06commit\u7ed3\u679c\u53d1\u9001\u7ed9TC\uff0cbranchStatus\u4e3aPhaseTwo_Committed")),(0,r.kt)("p",null,"\u5177\u4f53\u770b\u4e0b\u4e8c\u9636\u6bb5commit\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u5728",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/rm/src/main/java/com/alibaba/fescar/rm/AbstractRMHandler.java"},"AbstractRMHandler"),"\u7c7b\u7684doBranchCommit\u65b9\u6cd5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * \u62ff\u5230\u901a\u77e5\u7684xid\u3001branchId\u7b49\u5173\u952e\u53c2\u6570\n * \u7136\u540e\u8c03\u7528RM\u7684branchCommit\n */\nprotected void doBranchCommit(BranchCommitRequest request, BranchCommitResponse response) throws TransactionException {\n    String xid = request.getXid();\n    long branchId = request.getBranchId();\n    String resourceId = request.getResourceId();\n    String applicationData = request.getApplicationData();\n    LOGGER.info("Branch committing: " + xid + " " + branchId + " " + resourceId + " " + applicationData);\n    BranchStatus status = getResourceManager().branchCommit(request.getBranchType(), xid, branchId, resourceId, applicationData);\n    response.setBranchStatus(status);\n    LOGGER.info("Branch commit result: " + status);\n}\n')),(0,r.kt)("p",null,"\u6700\u7ec8\u4f1a\u5c06branchCommit\u7684\u8bf7\u6c42\u8c03\u7528\u5230",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/AsyncWorker.java"},"AsyncWorker"),"\u7684branchCommit\u65b9\u6cd5\u3002AsyncWorker\u7684\u5904\u7406\u65b9\u5f0f\u662ffescar\u67b6\u6784\u7684\u4e00\u4e2a\u5173\u952e\u90e8\u5206\uff0c\u56e0\u4e3a\u5927\u90e8\u5206\u4e8b\u52a1\u90fd\u662f\u4f1a\u6b63\u5e38\u63d0\u4ea4\u7684\uff0c\u6240\u4ee5\u5728PhaseOne\u9636\u6bb5\u5c31\u5df2\u7ecf\u7ed3\u675f\u4e86\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5c06\u9501\u6700\u5feb\u7684\u91ca\u653e\u3002PhaseTwo\u9636\u6bb5\u63a5\u6536commit\u7684\u6307\u4ee4\u540e\uff0c\u5f02\u6b65\u5904\u7406\u5373\u53ef\u3002\u5c06PhaseTwo\u7684\u65f6\u95f4\u6d88\u8017\u6392\u9664\u5728\u4e00\u6b21\u5206\u5e03\u5f0f\u4e8b\u52a1\u4e4b\u5916\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'private static final List<Phase2Context> ASYNC_COMMIT_BUFFER = Collections.synchronizedList( new ArrayList<Phase2Context>());\n        \n/**\n * \u5c06\u9700\u8981\u63d0\u4ea4\u7684XID\u52a0\u5165list\n */\n@Override\npublic BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId, String applicationData) throws TransactionException {\n    if (ASYNC_COMMIT_BUFFER.size() < ASYNC_COMMIT_BUFFER_LIMIT) {\n        ASYNC_COMMIT_BUFFER.add(new Phase2Context(branchType, xid, branchId, resourceId, applicationData));\n    } else {\n        LOGGER.warn("Async commit buffer is FULL. Rejected branch [" + branchId + "/" + xid + "] will be handled by housekeeping later.");\n    }\n    return BranchStatus.PhaseTwo_Committed;\n}\n    \n/**\n * \u901a\u8fc7\u5b9a\u65f6\u4efb\u52a1\u6d88\u8d39list\u4e2d\u7684XID\n */\npublic synchronized void init() {\n    LOGGER.info("Async Commit Buffer Limit: " + ASYNC_COMMIT_BUFFER_LIMIT);\n    timerExecutor = new ScheduledThreadPoolExecutor(1,\n        new NamedThreadFactory("AsyncWorker", 1, true));\n    timerExecutor.scheduleAtFixedRate(new Runnable() {\n        @Override\n        public void run() {\n            try {\n                doBranchCommits();\n            } catch (Throwable e) {\n                LOGGER.info("Failed at async committing ... " + e.getMessage());\n            }\n        }\n    }, 10, 1000 * 1, TimeUnit.MILLISECONDS);\n}\n    \nprivate void doBranchCommits() {\n    if (ASYNC_COMMIT_BUFFER.size() == 0) {\n        return;\n    }\n    Map<String, List<Phase2Context>> mappedContexts = new HashMap<>();\n    Iterator<Phase2Context> iterator = ASYNC_COMMIT_BUFFER.iterator();\n    \n    //\u4e00\u6b21\u5b9a\u65f6\u5faa\u73af\u53d6\u51faASYNC_COMMIT_BUFFER\u4e2d\u7684\u6240\u6709\u5f85\u529e\u6570\u636e\n    //\u4ee5resourceId\u4f5c\u4e3akey\u5206\u7ec4\u5f85commit\u6570\u636e\uff0cresourceId\u662f\u4e00\u4e2a\u6570\u636e\u5e93\u7684\u8fde\u63a5url\n    //\u5728\u524d\u9762\u7684\u65e5\u5fd7\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u76ee\u7684\u662f\u4e3a\u4e86\u8986\u76d6\u5e94\u7528\u7684\u591a\u6570\u636e\u6e90\u521b\u5efa\n    while (iterator.hasNext()) {\n        Phase2Context commitContext = iterator.next();\n        List<Phase2Context> contextsGroupedByResourceId = mappedContexts.get(commitContext.resourceId);\n        if (contextsGroupedByResourceId == null) {\n            contextsGroupedByResourceId = new ArrayList<>();\n            mappedContexts.put(commitContext.resourceId, contextsGroupedByResourceId);\n        }\n        contextsGroupedByResourceId.add(commitContext);\n\n        iterator.remove();\n\n    }\n\n    for (Map.Entry<String, List<Phase2Context>> entry : mappedContexts.entrySet()) {\n        Connection conn = null;\n        try {\n            try {\n                //\u6839\u636eresourceId\u83b7\u53d6\u6570\u636e\u6e90\u4ee5\u53ca\u8fde\u63a5\n                DataSourceProxy dataSourceProxy = DataSourceManager.get().get(entry.getKey());\n                conn = dataSourceProxy.getPlainConnection();\n            } catch (SQLException sqle) {\n                LOGGER.warn("Failed to get connection for async committing on " + entry.getKey(), sqle);\n                continue;\n            }\n            List<Phase2Context> contextsGroupedByResourceId = entry.getValue();\n            for (Phase2Context commitContext : contextsGroupedByResourceId) {\n                try {\n                    //\u6267\u884cundolog\u7684\u5904\u7406\uff0c\u5373\u5220\u9664xid\u3001branchId\u5bf9\u5e94\u7684\u8bb0\u5f55\n                    UndoLogManager.deleteUndoLog(commitContext.xid, commitContext.branchId, conn);\n                } catch (Exception ex) {\n                    LOGGER.warn(\n                        "Failed to delete undo log [" + commitContext.branchId + "/" + commitContext.xid + "]", ex);\n                }\n            }\n\n        } finally {\n            if (conn != null) {\n                try {\n                    conn.close();\n                } catch (SQLException closeEx) {\n                    LOGGER.warn("Failed to close JDBC resource while deleting undo_log ", closeEx);\n                }\n            }\n        }\n    }\n}\n')),(0,r.kt)("p",null,"\u6240\u4ee5\u5bf9\u4e8ecommit\u52a8\u4f5c\u7684\u5904\u7406\uff0cRM\u53ea\u9700\u5220\u9664xid\u3001branchId\u5bf9\u5e94\u7684undo_log\u5373\u53ef\u3002"),(0,r.kt)("h2",{id:"\u4e8b\u52a1\u56de\u6eda"},"\u4e8b\u52a1\u56de\u6eda"),(0,r.kt)("p",null,"\u5bf9\u4e8erollback\u573a\u666f\u7684\u89e6\u53d1\u6709\u4e24\u79cd\u60c5\u51b5"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u5206\u652f\u4e8b\u52a1\u5904\u7406\u5f02\u5e38\uff0c\u5373",(0,r.kt)("a",{parentName:"li",href:"https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/ConnectionProxy.java"},"ConnectionProxy"),"\u4e2d",(0,r.kt)("inlineCode",{parentName:"li"},"report(false)"),"\u7684\u60c5\u51b5"),(0,r.kt)("li",{parentName:"ol"},"TM\u6355\u83b7\u5230\u4e0b\u6e38\u7cfb\u7edf\u4e0a\u629b\u7684\u5f02\u5e38\uff0c\u5373\u53d1\u8d77\u5168\u5c40\u4e8b\u52a1\u6807\u6709",(0,r.kt)("inlineCode",{parentName:"li"},"@GlobalTransactional"),"\u6ce8\u89e3\u7684\u65b9\u6cd5\u6355\u83b7\u5230\u7684\u5f02\u5e38\u3002\u5728\u524d\u9762",(0,r.kt)("a",{parentName:"li",href:"https://github.com/seata/seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/TransactionalTemplate.java"},"TransactionalTemplate"),"\u7c7b\u7684execute\u6a21\u7248\u65b9\u6cd5\u4e2d\uff0c\u5bf9business.execute()\u7684\u8c03\u7528\u8fdb\u884c\u4e86catch\uff0ccatch\u540e\u4f1a\u8c03\u7528rollback\uff0c\u7531TM\u901a\u77e5TC\u5bf9\u5e94XID\u9700\u8981\u56de\u6eda\u4e8b\u52a1")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},' public void rollback() throws TransactionException {\n    //\u53ea\u6709Launcher\u80fd\u53d1\u8d77\u8fd9\u4e2arollback\n    if (role == GlobalTransactionRole.Participant) {\n        // Participant has no responsibility of committing\n        if (LOGGER.isDebugEnabled()) {\n            LOGGER.debug("Ignore Rollback(): just involved in global transaction [" + xid + "]");\n        }\n        return;\n    }\n    if (xid == null) {\n        throw new IllegalStateException();\n    }\n\n    status = transactionManager.rollback(xid);\n    if (RootContext.getXID() != null) {\n        if (xid.equals(RootContext.getXID())) {\n            RootContext.unbind();\n        }\n    }\n}\n')),(0,r.kt)("p",null,"TC\u6c47\u603b\u540e\u5411\u53c2\u4e0e\u8005\u53d1\u9001rollback\u6307\u4ee4\uff0cRM\u5728",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/rm/src/main/java/com/alibaba/fescar/rm/AbstractRMHandler.java"},"AbstractRMHandler"),"\u7c7b\u7684doBranchRollback\u65b9\u6cd5\u4e2d\u63a5\u6536\u8fd9\u4e2arollback\u7684\u901a\u77e5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'protected void doBranchRollback(BranchRollbackRequest request, BranchRollbackResponse response) throws TransactionException {\n    String xid = request.getXid();\n    long branchId = request.getBranchId();\n    String resourceId = request.getResourceId();\n    String applicationData = request.getApplicationData();\n    LOGGER.info("Branch rolling back: " + xid + " " + branchId + " " + resourceId);\n    BranchStatus status = getResourceManager().branchRollback(request.getBranchType(), xid, branchId, resourceId, applicationData);\n    response.setBranchStatus(status);\n    LOGGER.info("Branch rollback result: " + status);\n}\n')),(0,r.kt)("p",null,"\u7136\u540e\u5c06rollback\u8bf7\u6c42\u4f20\u9012\u5230",(0,r.kt)("inlineCode",{parentName:"p"},"DataSourceManager"),"\u7c7b\u7684branchRollback\u65b9\u6cd5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"public BranchStatus branchRollback(BranchType branchType, String xid, long branchId, String resourceId, String applicationData) throws TransactionException {\n    //\u6839\u636eresourceId\u83b7\u53d6\u5bf9\u5e94\u7684\u6570\u636e\u6e90\n    DataSourceProxy dataSourceProxy = get(resourceId);\n    if (dataSourceProxy == null) {\n        throw new ShouldNeverHappenException();\n    }\n    try {\n        UndoLogManager.undo(dataSourceProxy, xid, branchId);\n    } catch (TransactionException te) {\n        if (te.getCode() == TransactionExceptionCode.BranchRollbackFailed_Unretriable) {\n            return BranchStatus.PhaseTwo_RollbackFailed_Unretryable;\n        } else {\n            return BranchStatus.PhaseTwo_RollbackFailed_Retryable;\n        }\n    }\n    return BranchStatus.PhaseTwo_Rollbacked;\n}\n")),(0,r.kt)("p",null,"\u6700\u7ec8\u4f1a\u6267\u884c",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seata/seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/undo/UndoLogManager.java"},"UndoLogManager"),"\u7c7b\u7684undo\u65b9\u6cd5\uff0c\u56e0\u4e3a\u662f\u7eafjdbc\u64cd\u4f5c\u4ee3\u7801\u6bd4\u8f83\u957f\u5c31\u4e0d\u8d34\u51fa\u6765\u4e86\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fde\u63a5\u5230github\u67e5\u770b\u6e90\u7801\uff0c\u8bf4\u4e00\u4e0bundo\u7684\u5177\u4f53\u6d41\u7a0b"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u6839\u636exid\u548cbranchId\u67e5\u627ePhaseOne\u9636\u6bb5\u63d0\u4ea4\u7684undo_log"),(0,r.kt)("li",{parentName:"ol"},"\u5982\u679c\u627e\u5230\u4e86\u5c31\u6839\u636eundo_log\u4e2d\u8bb0\u5f55\u7684\u6570\u636e\u751f\u6210\u56de\u653esql\u5e76\u6267\u884c\uff0c\u5373\u8fd8\u539fPhaseOne\u9636\u6bb5\u4fee\u6539\u7684\u6570\u636e"),(0,r.kt)("li",{parentName:"ol"},"\u7b2c2\u6b65\u5904\u7406\u5b8c\u540e\uff0c\u5220\u9664\u8be5\u6761undo_log\u6570\u636e"),(0,r.kt)("li",{parentName:"ol"},"\u5982\u679c\u7b2c1\u6b65\u6ca1\u6709\u627e\u5230\u5bf9\u5e94\u7684undo_log\uff0c\u5c31\u63d2\u5165\u4e00\u6761\u72b6\u6001\u4e3a",(0,r.kt)("inlineCode",{parentName:"li"},"GlobalFinished"),"\u7684undo_log.\n\u51fa\u73b0\u6ca1\u627e\u5230\u7684\u539f\u56e0\u53ef\u80fd\u662fPhaseOne\u9636\u6bb5\u7684\u672c\u5730\u4e8b\u52a1\u5f02\u5e38\u4e86\uff0c\u5bfc\u81f4\u6ca1\u6709\u6b63\u5e38\u5199\u5165\u3002\n\u56e0\u4e3axid\u548cbranchId\u662f\u552f\u4e00\u7d22\u5f15\uff0c\u6240\u4ee5\u7b2c4\u6b65\u7684\u63d2\u5165\uff0c\u53ef\u4ee5\u9632\u6b62PhaseOne\u9636\u6bb5\u6062\u590d\u540e\u7684\u6210\u529f\u5199\u5165\uff0c\u90a3\u4e48PhaseOne\u9636\u6bb5\u5c31\u4f1a\u5f02\u5e38\uff0c\u8fd9\u6837\u4e00\u6765\u4e1a\u52a1\u6570\u636e\u4e5f\u5c31\u4e0d\u4f1a\u63d0\u4ea4\u6210\u529f\uff0c\u6570\u636e\u8fbe\u5230\u4e86\u6700\u7ec8\u56de\u6eda\u4e86\u7684\u6548\u679c")),(0,r.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,r.kt)("p",null,"\u672c\u5730\u7ed3\u5408\u5206\u5e03\u5f0f\u4e1a\u52a1\u573a\u666f\uff0c\u5206\u6790\u4e86fescar client\u4fa7\u7684\u4e3b\u8981\u5904\u7406\u6d41\u7a0b\uff0c\u5bf9TM\u548cRM\u89d2\u8272\u7684\u4e3b\u8981\u6e90\u7801\u8fdb\u884c\u4e86\u89e3\u6790\uff0c\u5e0c\u671b\u80fd\u5bf9\u5927\u5bb6\u7406\u89e3fescar\u7684\u5de5\u4f5c\u539f\u7406\u6709\u6240\u5e2e\u52a9\u3002"),(0,r.kt)("p",null,"\u968f\u7740fescar\u7684\u5feb\u901f\u8fed\u4ee3\u4ee5\u53ca\u540e\u671f\u7684Roadmap\u89c4\u5212\uff0c\u5047\u4ee5\u65f6\u65e5\u76f8\u4fe1fescar\u80fd\u591f\u6210\u4e3a\u5f00\u6e90\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u6807\u6746\u89e3\u51b3\u65b9\u6848\u3002"))}d.isMDXComponent=!0},73930:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/20190410114411366-32c3a0b5d1265bbd65911d6d46d284ef.png"}}]);